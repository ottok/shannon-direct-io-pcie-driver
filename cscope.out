cscope 15 /home/spike/valinor/lm/linux/drivers/block/shannon -q 0000010549 0001899291
	@shannon.h

9 #iâdeà
__SHANNON_H


10 
	#__SHANNON_H


	)

12 
	~"shªnÚ_pÜt.h
"

15 
	~"shªnÚ_cÚfig.h
"

16 
	~"shªnÚ_mbr.h
"

17 
	~"shªnÚ_memblock.h
"

18 
	~"shªnÚ_´eãtch.h
"

19 
	~"shªnÚ_ioùl.h
"

21 
	#SHANNON_USE_WRITE_BUFFER
 1

	)

24 
	#QUEUE_SIZE
 (4096ULè

	)

25 
	#MAGICBEAN
 0x10AC7A

	)

27 
	#SHN_OVERPROVISION_THRESHOLD
 300

	)

29 
	#SHN_ERR_NO_SPACE
 -1

	)

30 
	#SHN_ERR_LOW_SPACE
 -2

	)

31 
	#SHN_WRITE_EPILOG
 -3

	)

33 
	#SHANNON_VERSION_MAJOR
(
a
è(×)>>16è& 0xFF

	)

34 
	#SHANNON_VERSION_MINOR
(
a
è(×)>>8è& 0xFF

	)

35 
	#SHANNON_VERSION_RELEASE
(
a
è×è& 0xFF

	)

36 
	#SHANNON_MAKE_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

39 
	#SHANNON_VERSION_CODE
 
	`SHANNON_MAKE_VERSION
(3, 2, 2)

	)

40 
	#SHANNON_FIX_VERSION_CODE
 4

	)

43 
	#TEMP_AUX1_THRESHOLD
 90UL

	)

44 
	#TEMP_AUX1_CRITICAL_THRESHOLD
 100UL

	)

45 
	#TEMP_AUX2_THRESHOLD
 90UL

	)

46 
	#TEMP_AUX2_CRITICAL_THRESHOLD
 100UL

	)

47 
	#TEMP_BOARD_THRESHOLD
 90UL

	)

48 
	#TEMP_BOARD_CRITICAL_THRESHOLD
 100UL

	)

49 
	#TEMP_INNER_THRESHOLD
 93UL

	)

50 
	#TEMP_INNER_CRITICAL_THRESHOLD
 100UL

	)

52 
	#SHN_PAGE_SHIFT
 12

	)

53 
	#SHN_PAGE_SIZE
 (1UL << 
SHN_PAGE_SHIFT
)

	)

54 
	#SHN_PAGE_ALIGN
(
addr
è
	`_ALIGN_UP
×ddr, 
SHN_PAGE_SIZE
)

	)

56 
	#g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
·ge
) \

57 ((
·ge
è/ (
sdev
)->
·ges_š_siblšg_eblock
 * (sdev)->·ges_š_siblšg_eblock + (Õageè% (sdev)->
·ges_š_eblock
))

	)

61 
	#INVALID_LBA
 0xffffffff

	)

63 
	#INVALID_LBA2
 0xffffffã

	)

64 
	#lba_is_šv®id
(
x
è((xè=ğ
INVALID_LBA
 || (xè=ğ
INVALID_LBA2
)

	)

66 
	#LONG_INVALID_LBA
 0xfffffffff

	)

67 
	#lÚg_lba_is_šv®id
(
x
è((xè=ğ
LONG_INVALID_LBA
)

	)

68 
	#»q_has_šv®id_lba
(
»q
è(((Ôeq)->
d©©y³
 !ğ
SHORT_LBA
è&& (Ôeq)->d©©y³ !ğ
LONG_LBA
)) || \

69 (((
»q
)->
d©©y³
 =ğ
LONG_LBA
è&& 
	`lÚg_lba_is_šv®id
(Ôeq)->
lba
)) || \

70 (((
»q
)->
d©©y³
 =ğ
SHORT_LBA
è&& 
	`lba_is_šv®id
(Ôeq)->
lba
)))

	)

72 
	#is_aùive_blk
(
sb
è(((sb)->
¡©e
 =ğ
HOT_ACTIVE_BLOCK
è|| ((sb)->¡©=ğ
COLD_ACTIVE_BLOCK
))

	)

73 
	#is_Ï¡_blk
(
sb
è(((sb)->
¡©e
 =ğ
LAST_HOT_BLOCK
è|| ((sb)->¡©=ğ
LAST_COLD_BLOCK
))

	)

76 
	#ECC_CORRECTION_BITS_IN_SECTOR
 120

	)

78 #ifdeà
SHANNON_RELEASE


79 
	#debug_´št
 
debugs1


	)

81 
	#debug_´št
 
debugs0


	)

84 
	#NO_COMPLETION_WRITE_BIT
 (0x5)

	)

85 
	#NO_COMPLETION_WRITE_MASK
 (0x1 << 
NO_COMPLETION_WRITE_BIT
)

	)

87 
shªnÚ_scsi_mode
;

89 
	#MAX_LUN_COUNT
 512

	)

90 
	slun_pba
 {

91 
u32
 
	mlun_pba
;

92 
u32
 
	mlun
;

95 
	sshªnÚ_b¬
 {

96 
__u32
 
	mÿp
;

97 
__u32
 
	m¿id
;

98 
__u32
 
	mecc
;

99 
__u32
 
	mwr™e_buf_šfo
;

100 
__u32
 
	m»£rved4
;

101 
__u32
 
	m»£rved5
;

102 
__u32
 
	mfœmw¬e_v”siÚ
;

103 
__u32
 
	mfœmw¬e_g
;

104 
__u32
 
	m»£rved_¬¿y1
[30];

105 
__u32
 
	msy¡em_mÚ™Ü
;

106 
__u32
 
	m»£rved39
;

107 
__u32
 
	m»£rved40
;

108 
__u32
 
	m»£rved41
;

109 
__u32
 
	mdÇ_low
;

110 
__u32
 
	mdÇ_high
;

111 
__u32
 
	m»£rved_¬¿y2
[6];

112 
__u32
 
	m»£t_šfo
;

113 
__u32
 
	m»£rved_¬¿y3
[9];

114 
__u32
 
	m’coded_dÇ
;

117 
	sglob®_b¬
 {

118 
__u32
 
	mæash
;

119 
__u32
 
	mlogicb
;

120 
__u32
 
	m·ge
;

121 
__u32
 
	m¿id_šfo
;

123 
__u32
 
	mecc
;

124 
__u32
 
	mmisc
;

125 
__u32
 
	msüambËr_£ed
;

126 
__u32
 
	msüambËr_mask
;

129 
	sshªnÚ_lun_b¬
 {

130 
__u32
 
	msq_dma_addr0
;

131 
__u32
 
	msq_dma_addr1
;

132 
__u32
 
	mcq_dma_addr0
;

133 
__u32
 
	mcq_dma_addr1
;

135 
__u32
 
	msq_h—d
;

136 
__u32
 
	mack_cq_
;

138 
__u32
 
	mcq_h—d
;

139 
__u32
 
	msq_
;

140 
__u32
 
	mlun_¡©us
;

143 
	gshªnÚ_»que¡
;

145 
	eshn_blk_deçuÉ_lim™s
 {

146 
	mSHN_BLK_MAX_SEGMENTS
 = 128,

147 
	mSHN_BLK_SAFE_MAX_SECTORS
 = 255,

148 
	mSHN_BLK_DEF_MAX_SECTORS
 = 1024,

149 
	mSHN_BLK_MAX_SEGMENT_SIZE
 = 65536,

150 
	mSHN_BLK_SEG_BOUNDARY_MASK
 = 0xFFFFFFFFUL,

153 
	#SHN_SLAB_HWCACHE_ALIGN
 0x00002000UL

	)

154 
	#SHN_SLAB_CACHE_DMA
 0x00004000UL

	)

156 
	eshªnÚ_İcode
 {

157 
	msh_cmd_´e_»ad
 = 0x00,

158 
	msh_cmd_»ad
 = 0x01,

159 
	msh_cmd_»ad_’d
 = 0x02,

160 
	msh_cmd_advªûd_»ad
 = 0x08,

161 
	msh_cmd_”a£
 = 0x10,

162 
	msh_cmd_wr™e
 = 0x20,

163 
	msh_cmd_buf_wr™e
 = 0x30,

164 
	msh_cmd_buf_wr™e_no_comm™
 = 0x31,

165 
	msh_cmd_buf_»ad
 = 0x32,

166 
	msh_cmd_»g_»ad
 = 0x40,

167 
	msh_cmd_»g_wr™e
 = 0x50,

168 
	msh_cmd_·r™y
 = 0x80,

169 
	msh_cmd_·r™y_š™
 = 0x90,

170 
	msh_cmd_»£t
 = 0xF0,

171 
	msh_cmd_no_İ
 = 0xFF,

174 
	#SH_FAKE_ERR
 240

	)

175 
	#SH_SOFT_ERR_1
 241

	)

176 
	#SH_SOFT_ERR_2
 242

	)

177 
	#SH_FRESH_ERASED
 251

	)

178 
	#SH_CRC_ERR
 252

	)

179 
	#SH_ECC_UNCORRECTABLE
 253

	)

181 
	#SH_STATUS_SUCCESS
 0x04

	)

182 
	#SH_BIT_FAIL
 0

	)

183 
	#SH_BIT_READY
 6

	)

185 
	#cmd_·¹
(
v®
, 
width
, 
shiá
è(((v®è& ((1UL<<(width)è- 1)è<< (shiá))

	)

187 
	sshªnÚ_cmd
 {

188 
__u8
 
	mİcode
;

190 
__u8
 
	mlogicbs
;

191 
__u8
 
	md©a_luns
;

194 
__u8
 
	m¿id_¡re
;

195 
__u8
 
	mfœ¡_logicb
;

197 
__u8
 
	mh—d
;

200 
	#g‘_cmd_phy_lun
(
sdev
, 
lun£t
, 
dwÜd1
) \

201 ((
lun£t
è* (
sdev
)->
max_lun_š_lun£t
 + (((
	`shªnÚ_mem_»adl
(
dwÜd1
è>> 24è& ((1UL << 8è- 1)è% (sdev)->max_lun_š_lun£t))

	)

202 
__u32
 
	mdwÜd1
;

205 
	sshªnÚ_ÿched_»ad_cmd
 {

206 
__u8
 
	mİcode
;

209 
	#make_»ad_cmd_by‹1
(
logicbs
, 
exŒa_±e
è(
	`cmd_·¹
Öogicbs, 4, 0è| cmd_·¹ÓxŒa_±e, 4, 4))

	)

210 
	#g‘_»ad_cmd_logicbs
(
by‹1
è((by‹1è& ((1UL << 4è-1))

	)

211 
__u8
 
	mby‹1
;

212 
__u8
 
	mfœ¡_logicb
;

213 
__u8
 
	mh—d
;

216 
__u32
 
	mdwÜd1
;

219 
	sshªnÚ_wr™e_cmd
 {

220 
__u8
 
	mİcode
;

221 
__u8
 
	mexŒa_±e
;

222 
__u8
 
	m¿id_¡re
;

223 
__u8
 
	mh—d
;

226 
__u32
 
	mdwÜd1
;

229 
	sshªnÚ_buf_cmd
 {

230 
__u8
 
	mİcode
;

231 
__u8
 
	mphy_lun
;

232 
__u8
 
	mlogicb_šdex
;

235 
	#make_buf_cmd_by‹3
(
h—d
, 
¿id_¡re
è(
	`cmd_·¹
(h—d, 4, 0è| cmd_·¹Ôaid_¡re, 4, 4))

	)

236 
__u8
 
	mby‹3
;

240 
	#g‘_buf_cmd_phy_lun
(
phy_lun
, 
dwÜd1
è((((
	`shªnÚ_mem_»adl
(dwÜd1è>> 24è& ((1UL << 4è- 1)è<< 8è| (phy_lun))

	)

241 
	#g‘_buf_cmd_logicbs
(
dwÜd1
è((
	`shªnÚ_mem_»adl
(dwÜd1è>> 24è& ((1UL << 4è- 1))

	)

242 
	#g‘_buf_cmd_±es
(
dwÜd1
è((
	`shªnÚ_mem_»adl
(dwÜd1è>> 28è& ((1UL << 4è- 1))

	)

243 
__u32
 
	mdwÜd1
;

246 
	sshªnÚ_bufq_ack_cmd
 {

247 
__u8
 
	mtok’
;

248 
__u8
 
	mphy_lun
;

249 
__u8
 
	mbuf_cook›
;

250 
__u8
 
	m¡©us
;

252 
__u32
 
	mdwÜd1
;

255 
	sshªnÚ_»gi¡”_cmd
 {

256 
__u8
 
	mİcode
;

257 
__u8
 
	m£cÚd¬y_cmd
;

258 
__u8
 
	md©a_by‹
;

259 
	#PREFIX_CMD_MASK
 (1 << 1)

	)

260 
	#FORCE_ADDR_CYCLE_MASK
 (1 << 2)

	)

261 
	#FIRT_CMD_DISABLE_MASK
 (1 << 3)

	)

262 
	#VENDOR_MODE_MASK
 (1 << 5)

	)

263 
	#SECONDARY_CMD_ENABLE_MASK
 (1 << 6)

	)

264 
__u8
 
	mh—d
;

266 
__u8
 
	mæash_addr
;

267 
__u8
 
	mby‹s
;

268 
__u8
 
	mæash_cmd
;

269 
__u8
 
	mphy_lun
;

270 } 
	mæash_»g
;

273 
	gshªnÚ_lun
;

275 
	sshªnÚ_cmd_šfo
 {

276 
shªnÚ_li¡_h—d
 
	m»q_li¡
;

277 
	mcmd_Ën
;

279 
	mlogicbs
;

280 
	mlun_pba
;

282 
	mÏ¡_aùive_time
;

285 
	sshªnÚ_”rÜ_hªdËr
 {

286 
shªnÚ_wÜk_¡ruù
 
	mwÜk
;

289 
shªnÚ_dev
 *
	mdev
;

290 
shªnÚ_sb
 *
	msb
;

291 
shªnÚ_»que¡
 *
	m»q
;

292 
shªnÚ_lun
 *
	mlun
;

293 
	meblk
;

296 
	slba_li¡
 {

297 
shªnÚ_li¡_h—d
 
	mli¡
;

298 
shªnÚ_disk
 *
	msdisk
;

299 
u16
 
	mns_id
;

300 
u16
 
	mns_£q_num
;

301 
logicb64_t
 
	mlba
;

303 
shªnÚ_¥šlock_t
 
	mlba_lock
;

304 
	#LBA_READING
 1

	)

305 
	#LBA_LOCKED
 2

	)

306 
	m¡©us
;

307 
	m‹mp
;

308 
u8
 
	mh—d
;

309 
shªnÚ_li¡_h—d
 
	m»q_li¡
;

311 
shªnÚ_li¡_h—d
 
	mwa™_li¡
;

312 
lun_pba
 
	mpba
;

317 
	#REQ_WAIT_PICK_SHIFT
 (31)

	)

318 
	#REQ_WAIT_PICK_MASK
 (1U << 
REQ_WAIT_PICK_SHIFT
)

	)

319 
	#REQ_INDEX_MASK
 (
REQ_WAIT_PICK_MASK
 - 1)

	)

320 
	#is_wa™_pick_»q
(
_»q
è(!!((_»q)->
šdex
 & 
REQ_WAIT_PICK_MASK
))

	)

321 
	#£t_»q_wa™_pick
(
_»q
è((_»q)->
šdex
 |ğ
REQ_WAIT_PICK_MASK
)

	)

322 
	#ş—r_wa™_pick_b™
(
_»q
è((_»q)->
šdex
 &ğ~
REQ_WAIT_PICK_MASK
)

	)

323 
	#£t_»q_šdex
(
_»q
, 
_šdex
è((_»q)->
šdex
 |ğ((_šdexè& 
REQ_INDEX_MASK
))

	)

324 
	#g‘_»q_šdex
(
_»q
è((_»q)->
šdex
 & 
REQ_INDEX_MASK
)

	)

325 
	sshªnÚ_»que¡
 {

326 
shªnÚ_li¡_h—d
 
	mli¡
;

327 
u32
 
	mšdex
;

328 
logicb64_t
 
	mlba
;

329 
lun_pba
 
	mpba
;

330 
lun_pba
 
	mŞd_pba
;

331 
	mdma_dœ
;

332 
	mËngth
;

333 *
	mvœt_addr
;

335 
shªnÚ_dma_addr_t
 
	mdma_add»ss
;

336 
u64
 
	m¡¬t_off£t
;

338 
shªnÚ_sg_li¡_t
 *
	msg
;

339 *
	mvœt_addr_2
;

340 
shªnÚ_dma_addr_t
 
	mdma_add»ss_2
;

341 
shªnÚ_sg_li¡_t
 *
	msg2
;

342 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

343 
u64
 
	memu_m‘ad©a
;

345 
	#FROM_GC
 1

	)

346 
	#FROM_HOST
 2

	)

347 
	#FROM_PERIOD_READ
 3

	)

348 
	#FROM_OVERLAP
 4

	)

349 
	#FROM_PREFETCH
 5

	)

350 
	m£nd”
;

353 
	#SHORT_LBA_MASK
 0x00000000FFFFFFFFUL

	)

354 
	#LONG_LBA_MASK
 0x0000000FFFFFFFFFUL

	)

355 
	#NS_SEQ_NUM_SHIFT
 40

	)

356 
	#NS_SEQ_NUM_MASK
 0x00000000000003FFUL

	)

357 
	#NS_ID_SHIFT
 50

	)

358 
	#NS_ID_MASK
 0x00000000000003FFUL

	)

359 
	#DATATYPE_SHIFT
 60

	)

360 
	#DATATYPE_MASK
 0x000000000000000FUL

	)

362 
	#SHORT_LBA
 0UL

	)

363 
	#LONG_LBA
 0xFUL

	)

364 
	#NEED_RESCAN
 2UL

	)

365 
	#EPILOG
 0x3UL

	)

366 
u64
 
	m_m‘ad©a
;

367 
u8
 
	m_ecc
;

368 
u8
 
	md©©y³
;

369 
u16
 
	mns_id
;

370 
u16
 
	mns_£q_num
;

372 
	#PHANTOM_WRITE_SHIFT
 7

	)

373 
	#NO_POLL_SHIFT
 6

	)

374 
	#NO_POLL_MASK
 (1 << 
NO_POLL_SHIFT
)

	)

375 
	#DUMMY_WRITE_SHIFT
 5

	)

376 
	#DUMMY_WRITE_MASK
 (1 << 
DUMMY_WRITE_SHIFT
)

	)

377 
	#MULTI_PLANES_SHIFT
 4

	)

378 
	#MULTI_PLANES_MASK
 (1 << 
MULTI_PLANES_SHIFT
)

	)

379 
	#DUMMY_READ_SHIFT
 5

	)

380 
	#DUMMY_READ_MASK
 (1 << 
DUMMY_READ_SHIFT
)

	)

381 
	#HOT_INDEX
 0

	)

382 
	#COLD_INDEX
 1

	)

383 
	#MBR_INDEX
 2

	)

384 
	#OVERLAP_INDEX
 2

	)

385 
	#HEAD_INDEX_MASK
 0x0f

	)

386 
	#HOT_HEAD
 (
HOT_INDEX
 | 
MULTI_PLANES_MASK
 | 
NO_POLL_MASK
)

	)

387 
	#COLD_HEAD
 (
COLD_INDEX
 | 
MULTI_PLANES_MASK
 | 
NO_POLL_MASK
)

	)

388 
	#MBR_HEAD
 
MBR_INDEX


	)

389 
	#OVERLAP_HEAD
 (
OVERLAP_INDEX
 | 
MULTI_PLANES_MASK
 | 
NO_POLL_MASK
)

	)

390 
u8
 
	mh—d
;

391 
u8
 
	mÜig_h—d
;

392 
	mµa
;

393 
	mwr_off£t
;

394 
shªnÚ_İcode
 
	mİcode
;

395 
shªnÚ_li¡_h—d
 
	mchunk_li¡
;

396 
shªnÚ_li¡_h—d
 
	mbio_li¡
;

397 
shªnÚ_bio
 *
	msbio
;

399 #ifdeà
CONFIG_SHANNON_DEBUG


400 
	mg
;

401 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


402 
shªnÚ_li¡_h—d
 
	mdebug_li¡
;

405 
	#FILL_READ_MASK
 0x200UL

	)

406 
	#RAID_READ_MASK
 0x100UL

	)

407 
	#REREAD_NUM_MASK
 0x0ffUL

	)

408 
	#REREAD_TIMES_ON_ERROR
 5

	)

410 
	m»»ad
;

412 
	#SNAPREAD_REQ_MASK
 (0x100UL)

	)

413 
	#DUMMYREAD_REQ_MASK
 (0x200UL)

	)

414 
	#is_¢­»ad_»q
(
_»q
è((_»q)->
»ad_æags
 & 
SNAPREAD_REQ_MASK
)

	)

415 
	#£t_¢­»ad_»q
(
_»q
è((_»q)->
»ad_æags
 |ğ
SNAPREAD_REQ_MASK
)

	)

416 
	#ş—n_¢­»ad_»q
(
_»q
è((_»q)->
»ad_æags
 &ğ~
SNAPREAD_REQ_MASK
)

	)

417 
	#is_dummy»ad_»q
(
_»q
è((_»q)->
»ad_æags
 & 
DUMMYREAD_REQ_MASK
)

	)

418 
	#£t_dummy»ad_»q
(
_»q
è((_»q)->
»ad_æags
 |ğ
DUMMYREAD_REQ_MASK
)

	)

419 
	#ş—n_dummy»ad_»q
(
_»q
è((_»q)->
»ad_æags
 &ğ~
DUMMYREAD_REQ_MASK
)

	)

420 
	m»ad_æags
;

421 
u64
 
	m£q_num
;

422 *
	m»cov”_buf
;

424 
u8
 
	m»ad_luns_fÜ_»cov”
;

425 
u8
 
	md©a_luns
;

427 
	#REQ_NEW
 0

	)

428 
	#REQ_IN_QUEUE
 2

	)

429 
	#REQ_PICKED
 4

	)

430 
	#REQ_CMD_QUEUE
 6

	)

431 
	#REQ_BUF_QUEUE
 8

	)

432 
	#REQ_IN_RC_LIST
 10

	)

433 
	#REQ_IN_RMW_LIST
 12

	)

434 
	#REQ_IN_RMW_WAIT_LIST
 14

	)

435 
	#REQ_IN_ADV_READ_LIST
 16

	)

436 
	#REQ_ERROR
 20

	)

437 
	#REQ_IN_RAID5
 22

	)

438 
	#REQ_WAIT_RAID5
 22

	)

439 
	#REQ_IN_PREFETCH_REQ_LIST
 40

	)

440 
	#REQ_PICKED_FROM_PREFETCH
 42

	)

441 
	#REQ_WAIT_CACHE
 44

	)

442 
	#REQ_DONE
 88

	)

443 
	#REQ_CALLBACK
 99

	)

444 
	m¡©e
;

445 
	mov”Ïp_»adtimes
;

449 
	sshªnÚ_ov”Ïp
 {

450 
	mwr_chunk
;

451 
	mwr_·ge
;

452 
	mwr_logicb
;

453 
	mwr_¶ªe
;

454 
	mwr_lun
;

455 
	mov”Ïp_wr™eback
;

456 
	mh—d
;

457 
	mcİy_”r
;

458 
lun_pba
 
	mpba
;

459 
shªnÚ_wa™_queue_h—d_t
 
	mwa™_ov”Ïp_ev’t
;

460 
logicb64_t
 
	m_m‘ad©a
;

461 
logicb64_t
 
	mbufãd_m‘ad©a
;

462 
	mh™_couÁ
;

466 
	#STATE_RMW_SHIFT
 0

	)

468 
	#LBA_STATUS_ENTRY_LEN
 1

	)

475 
	#COLD_STATE
 0x0UL

	)

476 
	#HIGHEST_COLD_STATE
 0x3UL

	)

477 
	#INIT_HOT_STATE
 0x4UL

	)

478 
	#HOT_STATE
 0xfUL

	)

479 
	#TEMP_MASK
 0xfUL

	)

480 
	#TEMP_ENTRY_LEN
 4UL

	)

482 
	#ALL_HOT
 ((
HOT_STATE
 << 
TEMP_ENTRY_LEN
è| HOT_STATE)

	)

483 
	#ALL_COLD
 ((
COLD_STATE
 << 
TEMP_ENTRY_LEN
è| COLD_STATE)

	)

485 
	#INIT_STATE
 
INIT_HOT_STATE


	)

487 
	#CONVERT_SEQ_NUM_TO_TEMP
(
dev
, 
sb
) \

488 (((
dev
)->
£qu’û_numb”
 - (
sb
)->
£q_num
)/((dev)->
sb_couÁ
 * 9/10))

	)

495 
	#NEXT_HEAD_SHIFT
 1UL

	)

496 
	#STATE_STALE_SHIFT
 2UL

	)

497 
	#STATE_HOST_WRITE
 3UL

	)

498 
	#STATE_GC_READ
 4UL

	)

499 
	#STATE_GC_WRITE
 5UL

	)

500 
	#STATE_IN_HOT_BUFQ
 6UL

	)

501 
	#STATE_IN_COLD_BUFQ
 7UL

	)

503 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


506 
	#STATE_HOST_INVALID_WR
 8UL

	)

507 
	#STATE_GC_INVALID_WR
 9UL

	)

509 
	#PBA_ENTRY_LEN
 16

	)

510 
	#ALL_STALE
 0x0004UL

	)

514 
	#PBA_ENTRY_LEN
 8

	)

515 
	#ALL_STALE
 0x04UL

	)

518 
	sshªnÚ_lun£t
 {

519 
	mšdex
;

520 
shªnÚ_dev
 *
	msdev
;

522 
shªnÚ_©omic_t
 
	mš_wq
;

523 
shªnÚ_li¡_h—d
 
	m»q_queue
;

524 
shªnÚ_¥šlock_t
 
	m»q_queue_lock
;

525 
shªnÚ_mu‹x_t
 
	mlun_pick_£m
;

527 
shªnÚ_mu‹x_t
 
	msq_£m
;

528 
shªnÚ_cmd
 *
	msq_addr
;

529 vŞ©
shªnÚ_cmd
 *
	mcq_addr
;

530 
shªnÚ_dma_addr_t
 
	msq_dma_addr
;

531 
shªnÚ_dma_addr_t
 
	mcq_dma_addr
;

532 
shªnÚ_wa™_queue_h—d_t
 
	mwa™_cmd_pos
;

534 
shªnÚ_wÜk_¡ruù
 
	msubm™_wÜk
;

535 
shªnÚ_wÜk_¡ruù
 
	mcomp_wÜk
;

537 
__u64
 
	mho¡_»ad_£ùÜs
;

538 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

539 
shªnÚ_wa™_queue_h—d_t
 
	memu_wa™
;

540 
shªnÚ_sk_¡ruù_t
 *
	memu_th»ad
;

542 
shªnÚ_¥šlock_t
 
	mlun_b¬_lock
;

543 
shªnÚ_lun_b¬
 
__iomem
 *
	mlun_b¬
;

545 
__u32
 
	msq_hw_h—d
;

546 
__u32
 
	msq_hw_
;

547 
__u32
 
	mcq_hw_h—d
;

549 
__u32
 
	msq_h—d_tmp
;

550 
__u32
 
	msq_h—d
;

551 
__u32
 
	mcq_h—d
;

552 
__u32
 
	mcq_
;

553 
__u32
 
	mcq__tmp
;

554 
__u8
 
	mhªg
;

556 #ifdeà
CONFIG_SHANNON_DEBUG


557 
	mqueue_d•th
[17];

558 
	mcmd_queue_d•th
[17];

559 
	mcomp_queue_d•th
[17];

561 
	mpick_sq_d•th
[11];

562 
	mpick_scq_d•th
[11];

565 
shªnÚ_cmd_šfo
 
	mcmd_šfo
[512];

566 
shªnÚ_û
 *
	mlun£t_ûs
;

569 
	sshªnÚ_û
 {

570 
	mšdex_š_lun£t
;

571 
	#SNAPREAD_ENABLE_SHIFT
 (0)

	)

572 
	#SNAPREAD_ENABLE_MASK
 (1 << 
SNAPREAD_ENABLE_SHIFT
)

	)

573 
	mã©u»_æags
;

575 
shªnÚ_lun£t
 *
	mlun£t
;

576 
shªnÚ_lun
 **
	mluns
;

579 
	gshªnÚ_dev
;

580 
	sshªnÚ_lun
 {

581 
u64
 *
	mpba_bË
;

582 
shªnÚ_dev
 *
	msdev
;

583 
	mlun_num
;

584 
	mphy_lun_num
;

585 
shªnÚ_lun£t
 *
	mlun£t
;

586 
shªnÚ_û
 *
	mû
;

588 
	#LUN_BBT_SIZE
 8192

	)

589 
shªnÚ_¥šlock_t
 
	mbbt_lock
;

590 
shªnÚ_mu‹x_t
 
	m»äesh_£m
;

591 
u16
 *
	mbbt
;

592 
	mbad_blk_couÁ
;

593 
shªnÚ_©omic_t
 
	mÃxt_em±y_·ge
;

594 
	mbad
;

595 
shªnÚ_©omic_t
 
	mava_d©a_sbs
;

598 
__u64
 
	mecc_¡©i¡ics
[
ECC_CORRECTION_BITS_IN_SECTOR
 + 1];

599 
shªnÚ_©omic_t
 
	mecc_çu»_times
;

601 
__u64
 
	madv_»ad_ecc_¡©i¡ics
[
ECC_CORRECTION_BITS_IN_SECTOR
 + 1];

602 
shªnÚ_©omic_t
 
	madv_»ad_çu»_times
;

604 
shªnÚ_©omic_t
 
	mdyÇmic_bad_blkút
;

606 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

607 
shªnÚ_emu_lun
 *
	memu_lun
;

609 
	m»äesh_Úe_mbr_eblk_dÚe
;

610 
shªnÚ_wa™_queue_h—d_t
 
	m»äesh_Úe_mbr_eblk_dÚe_ev’t
;

611 
	mupd©e_poŞ_šfo_dÚe
;

612 
shªnÚ_wa™_queue_h—d_t
 
	mupd©e_poŞ_šfo_dÚe_ev’t
;

615 
shªnÚ_¥šlock_t
 
	mcheck_lock
;

616 
u8
 
	m”r_checkšg
;

617 
u8
 
	msu¥icious_bad_lun
;

618 
shªnÚ_©omic_t
 
	m”r_blocks
;

619 
u32
 
	mcommªd_timeout_út
;

620 
shªnÚ_wÜk_¡ruù
 
	m”r_checkšg_wÜk
;

621 
	m¡¬t_sb
;

622 
shªnÚ_wÜk_¡ruù
 
	m»ad_su¥icious_bad_lun_wÜk
;

625 
	#shªnÚ_dev_is_g5
(
sdev
è((sdev)->
h¬dw¬e_v”siÚ
 =ğ0x10)

	)

626 
	#shªnÚ_dev_is_g5_ff§
(
sdev
è(
	`shªnÚ_dev_is_g5
(sdevè&& 
	`dev_is_g5_ff§
((sdev)->
pci_dev
))

	)

627 
	#shªnÚ_dev_is_g5_åga
(
sdev
è(
	`shªnÚ_dev_is_g5
(sdevè&& 
	`dev_is_g5_åga
((sdev)->
pci_dev
))

	)

629 
	#BBT_BITMAP_WATERMARK
 0xFEFEFEFEFEFEFEFE

	)

630 
	#bbt_usšg_b™m­
(
bbt
, 
sdev
) \

631 ((*(
u64
 *)(
bbt
è=ğ
BBT_BITMAP_WATERMARK
è|| 
	`shªnÚ_dev_is_g5
(
sdev
))

	)

633 
	#EPILOG_WATERMARK
 0xb“fb“fb“fb“f

	)

634 
	sshªnÚ_•og_h—d
 {

635 
u64
 
	m£q_num
;

636 
u32
 
	m”a£_couÁ”
;

637 
u16
 
	mÃxt_sb
;

638 
u16
 
	mh—d_šdex
;

639 
u64
 
	mho¡_wr™e_£ùÜs
;

640 
u64
 
	mtÙ®_wr™e_£ùÜs
;

641 
u64
 
	mpow”_Ú_£cÚds
;

642 
u64
 
	mpow”_cyşe_couÁ
;

643 
u64
 
	mho¡_»ad_£ùÜs
;

644 
u32
 
	m‹m³¿tu»_št_max
;

645 
u32
 
	m‹m³¿tu»_bßrd_max
;

646 
u32
 
	m‹m³¿tu»_æash_max
;

647 
u32
 
	mvŞge_št_max
;

648 
u32
 
	mvŞge_aux_max
;

649 
u32
 
	m£u_üc_”rÜ_hi¡Üy
;

650 
u32
 
	m£u_ecc_”rÜ_hi¡Üy
;

651 
u32
 
	m»£rved1
;

652 
u64
 
	m•og_w©”m¬k
;

653 
u8
 
	m»£rved
[160];

656 
	sshªnÚ_•og_h—d_4k
 {

657 
shªnÚ_•og_h—d
 
	mh—d
;

658 
u8
 
	m»£rved
[3840];

661 
	sshªnÚ_•og
 {

662 
	mšdex
;

663 
	mlogicbs_š_u£
;

664 
shªnÚ_•og_h—d_4k
 *
	m•og_h—d
;

665 
u8
 **
	m·ges_poš‹rs
;

668 #ifdeà
CONFIG_SHANNON_DEBUG


669 
	sgc_block_¡©e
 {

670 
shªnÚ_li¡_h—d
 
	mli¡
;

671 
	msb_šdex
;

672 
	mv®id_·ges
;

673 
	mbad_lun
[8];

674 
	m”rÜ_lun
[24];

675 
	mpba_bË_Ën
;

676 
u8
 *
	mpba_bË
;

680 
	#VENDOR_MODE_CMD_SEQ_TABLE1_LEN
 7

	)

681 
	#VENDOR_MODE_CMD_SEQ_TABLE2_LEN
 11

	)

682 
	sv’dÜ_mode_bË
 {

683 
	maddr
;

684 
	md©a
;

687 
	sã©u»_cfg
 {

688 
	#FEATURE_INVALID
 (0)

	)

689 
	#FEATURE_VALID_SHIFT
 (0)

	)

690 
	#FEATURE_VALID_MASK
 (1 << 
FEATURE_VALID_SHIFT
)

	)

691 
	#FEATURE_PRIO_0_SHIFT
 (1)

	)

692 
	#FEATURE_PRIO_0_MASK
 (1 << 
FEATURE_PRIO_0_SHIFT
)

	)

693 
	#FEATURE_PRIO_1_SHIFT
 (2)

	)

694 
	#FEATURE_PRIO_1_MASK
 (1 << 
FEATURE_PRIO_1_SHIFT
)

	)

695 
	#FEATURE_PRIORITY_MASK
 (
FEATURE_PRIO_0_MASK
 | 
FEATURE_PRIO_1_MASK
)

	)

696 
u8
 
	mv®id
;

697 
u8
 
	maddr
;

698 
u8
 
	mcmd
;

699 
u8
 
	m£cÚd¬y_cmd
;

700 
	#VENDOR_MODE
 5

	)

701 
	#SECOND_ENABLE
 6

	)

702 
u8
 
	mmisc
;

703 
	#FEATURE_CFG_MAX_DATA
 8

	)

704 
u8
 
	mnby‹
;

705 
u8
 
	md©a
[
FEATURE_CFG_MAX_DATA
 + 2];

708 
	ssub_group
 {

709 
shªnÚ_©omic_t
 
	mavaabË_luns
;

710 
	md©a_luns
;

711 
	m¡¬t_lun
;

712 
	m·r™y_lun_off£t
;

713 
	mfœ¡_lun_off£t
;

714 
	mÏ¡_d©a_lun_off£t
;

715 
	mphy_šdex
;

718 
	#NOR_MBR_ADDR
 0x1FE0000

	)

719 
	sshªnÚ_nÜ_mbr
 {

720 
	#NOR_MBR_MAGIC
 0xF1A581DF1A581DF1

	)

721 
u64
 
	mw©”m¬k
;

722 
u64
 
	mv”siÚ
;

723 
u64
 
	mæashid
;

724 
	#ONFI_ASYNC_MODE
 0

	)

725 
	#TOGGLE_MODE
 1

	)

726 
	#ONFI_SYNC_MODE
 3

	)

727 
u8
 
	mifmode
;

728 
	#FREQ_NORMAL
 0

	)

729 
	#FREQ_TURBO
 1

	)

730 
u8
 
	mifşock
;

731 
u8
 
	mäeq_mode
;

732 
u8
 
	mpow”_budg‘
;

733 
u16
 
	msh¬ed_·ges
;

734 
u16
 
	mmbr_logicb_shiá
;

735 
u16
 
	mecc_codewÜds_š_logicb
;

736 
u16
 
	m®ign_·d1
[3];

737 
u32
 
	mşo£_block_»ad_couÁ
;

738 
u32
 
	mİ’_block_»ad_couÁ
;

739 
u32
 
	mmiüocode_addr
;

740 
u32
 
	mmiüocode_Ëngth
;

741 
u32
 
	mmiüocode_checksum
;

742 
u32
 
	m®ign_·d2
[1];

743 
u64
 
	m»£rved
[88];

745 
	#FEATURE_CFG_LIST_SIZE
 16

	)

746 
ã©u»_cfg
 
	mã©u»_¬¿y
[
FEATURE_CFG_LIST_SIZE
];

748 
u32
 
	mmiüocode
[0];

749 }
__©Œibu‹__
((
·cked
));

751 
g‘_·r™y_lun
(
sub_group
 *
group
);

752 
fœ¡_lun
(
sub_group
 *
group
);

753 
Ï¡_d©a_lun
(
sub_group
 *
group
);

755 
	sshªnÚ_sb
 {

756 
shªnÚ_li¡_h—d
 
	mli¡
;

760 
shªnÚ_¥šlock_t
 
	mlock
;

761 
shªnÚ_©omic_t
 
	mv®id_·ges
;

762 
	mwr_off£t
;

763 
shªnÚ_©omic_t
 
	mš_wr™e_logicbs
;

764 
shªnÚ_©omic_t
 
	m³riod_»ad_dÚe
;

765 
shªnÚ_©omic_t
 
	mš_³riod_»ad
;

766 
shªnÚ_©omic_t
 
	munfšished_wr™es
;

768 
	mbad_lun
[8];

769 
	m”rÜ_lun
[24];

770 
	m”r_msg_lun
[24];

771 
shªnÚ_©omic_t
 
	mavaabË_luns
;

772 
shªnÚ_©omic_t
 
	mavaabË_groups
;

773 
	mmš_d©a_luns
;

774 
	mmš_avaabË_luns
;

775 
sub_group
 *
	msub_group
;

776 
u32
 *
	m»ad_couÁ
;

777 
u32
 
	mmax_»ad_couÁ
;

778 
	m•og_size
;

779 
	mlogicbs_š_•og
;

781 
shªnÚ_dev
 *
	msdev
;

782 
	msb_šdex
;

783 
u32
 
	m”a£_couÁ”
;

785 
	#MAX_SEQ_NUM
 ~0UL

	)

786 
u64
 
	m£q_num
;

787 
	#INVALID_SB_INDEX
 0xffff

	)

788 
u16
 
	mÃxt_sb
;

789 
u16
 
	mh—d_šdex
;

791 
	#NEED_FILL_BIT
 (0)

	)

792 
	#SKIP_PARITY_BIT
 (1)

	)

793 
	#NEED_RECLAIM_BIT
 (2)

	)

794 
	#NEXT_GROUP_HAS_DATA_BIT
 (3)

	)

795 
	#RECOVERED_EPILOG_HEAD_BIT
 (4)

	)

796 
	#NEED_FILL
 (1 << 
NEED_FILL_BIT
)

	)

797 
	#SKIP_PARITY
 (1 << 
SKIP_PARITY_BIT
)

	)

798 
	#NEED_RECLAIM
 (1 << 
NEED_RECLAIM_BIT
)

	)

799 
	#NEXT_GROUP_HAS_DATA
 (1 << 
NEXT_GROUP_HAS_DATA_BIT
)

	)

800 
	#RECOVERED_EPILOG_HEAD
 (1 << 
RECOVERED_EPILOG_HEAD_BIT
)

	)

801 
	#g‘_»cov”ed_•og_h—d
(
sb
è((sb)->
»cov”_¡©us
 & 
RECOVERED_EPILOG_HEAD
)

	)

802 
	#£t_»cov”ed_•og_h—d
(
sb
è((sb)->
»cov”_¡©us
 |ğ
RECOVERED_EPILOG_HEAD
)

	)

803 
u8
 
	m»cov”_¡©us
;

805 
	#HOT_ACTIVE_BLOCK
 1

	)

806 
	#LAST_HOT_BLOCK
 2

	)

807 
	#HOT_BLOCK_LIST
 3

	)

808 
	#COLD_ACTIVE_BLOCK
 4

	)

809 
	#LAST_COLD_BLOCK
 5

	)

810 
	#COLD_BLOCK_LIST
 6

	)

811 
	#WAIT_COPY_BLOCK
 7

	)

812 
	#IN_GC_BLOCK
 8

	)

813 
	#WAIT_ERASE_BLOCK
 9

	)

814 
	#FREE_BLOCK
 10

	)

815 
	#DISCARDED_BLOCK
 11

	)

816 
	#MBR_BLOCK
 12

	)

817 
	#COPY_ERR_BLOCK
 13

	)

818 
	#ERROR_BLOCK
 14

	)

819 
	#IN_RECOVER_BLOCK
 15

	)

820 
	#WAIT_WL_BLOCK
 16

	)

821 
	#IN_WL_BLOCK
 17

	)

822 
	#NEXT_HOT_BLOCK
 18

	)

823 
	#NEXT_COLD_BLOCK
 19

	)

824 
	#IN_ERASING_BLOCK
 20

	)

825 
	#OVERLAP_BLOCK
 21

	)

826 
	#RECOVER_ERR_BLOCK
 0xe4

	)

827 
	m¡©e
;

828 
	mŞd_¡©e
;

830 
shªnÚ_•og
 *
	m•og
;

831 
shªnÚ_dma_addr_t
 
	m•og_dma
;

832 
	mgc_š_æight
;

833 #ifdeà
CONFIG_SHANNON_DEBUG


834 
gc_block_¡©e
 *
	mgc_¡©e
;

836 
	m·r™y_š™_dÚe
;

837 
	#GC_SB_SHIFT
 1

	)

838 
	#WL_SB_SHIFT
 2

	)

839 
	#ERROR_SB_SHIFT
 3

	)

840 
	m»şaim_kšd
;

841 
	mfl_sb
;

842 
	mmax_ecc
;

843 
	mÏ¡_”a£d_time¡amp
;

844 
	mÏ¡_şo£d_time¡amp
;

845 
	mecc_çu»_times
[
MAX_LUN_COUNT
];

846 
	mmax_lun_ecc_çu»_times
;

849 
shªnÚ_li¡_h—d
 
	m”a£_couÁ_li¡
;

852 
aùive_blk_¡©e
[];

853 
Ï¡_blk_¡©e
[];

854 
Ãxt_blk_¡©e
[];

855 
u£d_blk_¡©e
[];

856 
wr™e_h—d
[];

857 
u8
 
lba_ty³
[];

858 
u64
 
šv®id_lba
[];

859 
u64
 
šv®id_m‘ad©a
[];

860 (*
phy_lun_to_logiÿl_lun
[])(
shªnÚ_dev
 *, );

862 
	sÃw_bad_lun
 {

863 
bad_lun_æag
;

865 
group_bad_lun
[0];

868 
	snÜæash_šdex_node
 {

869 
u32
 
mbr_·ge
;

870 
u32
 
mbr_backup_·ge
;

871 
u32
 
bbt_¡¬t_·ge
;

872 
u32
 
bbt_’d_·ge
;

873 
u32
 
ã©u»_·ge
;

874 
u32
 
miüo_code_·ge
;

875 
u32
 
»£rved
[1017];

876 
u32
 
üc
;

879 
	smiüocode_bË_šfo
 {

880 
³_cyşe
;

881 
off£t
;

882 
¡¬t_»g
;

883 
Ëngth
;

884 
»£rved
[12];

887 
	smiüocode_šfo
 {

888 
bË_út
;

890 
»£rved
[1022];

892 
u32
 
üc
;

895 
	sshªnÚ_nÜæash
 {

896 
u32
 
blk_couÁ
;

897 
u32
 
size_šby‹s
;

898 
u32
 
£gm’ts
;

899 
u32
 
buf_addr
;

900 
u32
 
buf_size
;

901 
u32
 
´og»ss
;

902 
u32
 
´iv©e_št
;

905 
u32
 
pc›_phy_addr
;

906 
u32
 
šdex_node_addr
;

907 
u32
 
ú_·¿m_addr
;

908 
u32
 
mbr_addr
;

909 
u32
 
mbr_backup_addr
;

910 
u32
 
bbt_addr
;

911 
u32
 
bbt_size
;

912 
u32
 
ã©u»_addr
;

913 
u32
 
miüo_code_addr
;

914 
u32
 
poŞ_šfo_addr
;

915 
u32
 
poŞ_šfo_backup_addr
;

921 
	snÜæash_£g
 {

922 
u32
 
¡¬t_phyaddr
;

923 
u32
 
’d_phyaddr
;

924 
u32
 
blk_size
;

925 } 
£gm’t
[4];

929 
	sbad_block
 {

930 
__u8
 
lun
;

931 
__u16
 
block
;

932 } 
	`__©Œibu‹__
 ((
·cked
));

934 
	snÜ_·ge_medŸ
 {

935 
__u16
 
fÜm©_v”siÚ
;

936 
__u16
 
šdex
;

937 
	#MAX_BBT_SEQ_NUM
 (0xFFFFFFFF)

	)

938 
__u32
 
£q_num
;

939 
	#BAD_BLOCKS_PER_PAGE
 1361

	)

940 
bad_block
 
bbt
[
BAD_BLOCKS_PER_PAGE
];

941 
__u8
 
»£rved
;

942 
__u32
 
üc
;

943 } 
	`__©Œibu‹__
 ((
·cked
));

946 
	snÜ_block
 {

947 
šdex
;

948 
	#NOR_BLOCK_FULL
 1

	)

949 
	#NOR_BLOCK_FREE
 2

	)

950 
	#NOR_BLOCK_USED
 3

	)

951 
	#NOR_BLOCK_ACTIVE
 4

	)

952 
	#NOR_BLOCK_WAIT_ERASE
 5

	)

953 
	#NOR_BLOCK_ERASE_ERR
 6

	)

954 
	#NOR_BLOCK_WRITE_ERR
 7

	)

955 
¡©e
;

957 
shªnÚ_li¡_h—d
 
li¡
;

959 
shªnÚ_li¡_h—d
 
·ge_li¡
;

960 
v®id_·ges
;

963 
	snÜ_·ge
 {

964 
	#INVALID_NOR_PAGE_INDEX
 (0xFFFF)

	)

965 
	#INVALID_NOR_BLOCK_INDEX
 (0xFFFF)

	)

966 
šdex
;

967 
nÜ_block
;

969 
shªnÚ_li¡_h—d
 
li¡
;

970 
nÜ_·ge_medŸ
 *
d©a
;

973 
	sm­_bË_¡ruù
 {

974 
	#MAP_TABLE_VALID_BIT
 (0)

	)

975 
	#MAP_TABLE_VALID_MASK
 (1 << 
MAP_TABLE_VALID_BIT
)

	)

976 
u8
 
¡©e
;

978 
sÿ‰”_memblock
 
m­_bË
;

979 
u64
 
m­_bË_size
;

980 
sÿ‰”_memblock
 
‹mp_bË
;

981 
u64
 
‹mp_bË_size
;

983 
	#LOCK_COUNT
 71

	)

984 
shªnÚ_¥šlock_t
 
m­_bË_lock
[
LOCK_COUNT
];

985 
u64
 
v®id_logicbs_¬¿y
[
LOCK_COUNT
];

988 
	sshªnÚ_disk
 {

989 
u32
 
sdev_couÁ
;

990 
u32
 
¡r_size
;

991 
u32
 
¡r_size_shiá
;

993 
m­_bË_¡ruù
 *
Ímt_¬¿y
;

994 
u64
 
tÙ®_m­_bË_size
;

995 
u64
 
tÙ®_‹mp_bË_size
;

997 
shªnÚ_´eãtch
 
´eãtch
;

998 
shªnÚ_©omic_t
 
³ndšg_bios
;

1001 
u64
 
Üig_m­_bË_size
;

1003 
shªnÚ_¥šlock_t
 
queue_lock
;

1004 
shªnÚ_»que¡_queue_t
 *
queue
;

1005 
shªnÚ_g’disk_t
 *
gd
;

1006 
u16
 
´iÜ™y
;

1008 
´št_Ï‹ncy_š‹rv®
;

1009 
shªnÚ_tim”_li¡
 
´št_Ï‹ncy_tim”
;

1010 
max_bio_»ad_Ï‹ncy
;

1011 
max_bio_wr™e_Ï‹ncy
;

1012 
shªnÚ_¥šlock_t
 
»cÜd_Ï‹ncy_lock
;

1018 
u64
 
®igÃd_»qs
;

1019 
u64
 
nÚ®igÃd_»qs
;

1020 
nÚ®igÃd_bios
;

1021 
	#RMW_READ
 0

	)

1022 
	#RMW_WRITE
 1

	)

1023 
	#RMW_LIST_COUNT
 10

	)

1024 
shªnÚ_¥šlock_t
 
rmw_li¡_lock
[2][
RMW_LIST_COUNT
];

1025 
shªnÚ_li¡_h—d
 
rmw_li¡
[2][
RMW_LIST_COUNT
];

1026 
shªnÚ_d’Œy_t
 *
debugfs_rmw_li¡
;

1029 #ifdeà
CONFIG_SHANNON_DEBUG_CDEV


1030 
shªnÚ_dev_t
 
Ímt_dev_num
;

1031 
Ímt_majÜ
;

1032 
shªnÚ_şass_t
 *
Ímt_şass
;

1033 
debug_cdev
 *
Ímt_cdev
;

1035 
shªnÚ_dev_t
 
‹mp_bË_dev_num
;

1036 
‹mp_bË_majÜ
;

1037 
shªnÚ_şass_t
 *
‹mp_bË_şass
;

1038 
debug_cdev
 *
‹mp_bË_cdev
;

1041 
	#SHN_DISK_INATTACH
 0

	)

1042 
	#SHN_DISK_ATTACHED
 1

	)

1043 
	#SHN_DISK_DETACHED
 2

	)

1044 
©ched
;

1046 
ex™
;

1047 
š_»cÚfig
;

1048 
disk_Çme
[16];

1049 
__u64
 
£ùÜs
;

1050 *
ho¡d©a
;

1053 
	#SYSFS_INIT_DONE
 1

	)

1054 
	#SYSFS_LINK_DONE
 2

	)

1056 
	sshªnÚ_š‹¼u±_¬g
 {

1057 
dwÜd_šdex
;

1058 
shªnÚ_wÜk_¡ruù
 
»pŞl_wÜk
;

1059 
shªnÚ_¹_wÜk_¡ruù
 
¹_»pŞl_wÜk
;

1060 
shªnÚ_dev
 *
sdev
;

1063 
	sshªnÚ_dev
 {

1064 
u16
 
sdev_id
;

1066 
ho¡_wr™es
;

1067 
gc_wr™es
;

1069 
shªnÚ_li¡_h—d
 
»q_queue
[
PRIORITY_LEVELS
];

1070 
shªnÚ_¥šlock_t
 
»q_queue_lock
[
PRIORITY_LEVELS
];

1071 
shªnÚ_©omic_t
 
wr™e_»qs
[
PRIORITY_LEVELS
];

1073 
shªnÚ_¥šlock_t
 
gc_wr™e_queue_lock
;

1074 
shªnÚ_©omic_t
 
gc_wr™e_»qs
;

1075 
shªnÚ_li¡_h—d
 
gc_wr™e_queue
;

1076 #ifdeà
CONFIG_SHANNON_STATISTICS


1077 
shªnÚ_©omic_t
 
äom_ho¡
;

1078 
shªnÚ_©omic_t
 
äom_gc
;

1080 
	#MAX_MSIX_INTERRUPTS
 8

	)

1082 
š‹¼u±_veù
[
MAX_MSIX_INTERRUPTS
/2];

1083 
u32
 
u32_veùÜs
[
MAX_MSIX_INTERRUPTS
];

1085 
u64
 
pÙ’tŸl_š‹¼u±_veùÜs
[
MAX_MSIX_INTERRUPTS
/2];

1086 
shªnÚ_š‹¼u±_¬g
 
š‹¼u±_¬g
[
MAX_MSIX_INTERRUPTS
];

1087 
shªnÚ_msix_’Œy_t
 *
msix_d©a
;

1088 
shªnÚ_poŞ
 *
¥oŞ
;

1090 
max_œq_šdex
;

1092 
	#CRC32_TABLE_SIZE
 256

	)

1093 
u32
 *
üc_bË
;

1094 
u32
 
ıs_üc
;

1096 
	#REQ_QUEUE_THRESHOLD_H
 (
sdev
->
logicbs_š_chunk
 * sdev->
lun_couÁ
 * 5)

	)

1097 
	#REQ_QUEUE_THRESHOLD_L
 (
sdev
->
logicbs_š_chunk
 * sdev->
lun_couÁ
 * 4)

	)

1098 
š_block_¡©e
;

1099 
h¬d_queue_lim™
;

1100 
	#DEFAULT_CMD_QUEUE_WRITES_THRESHOLD_H
(
sdev
è((sdev)->
max_luns_š_group
 * (sdev)->
logicbs_š_chunk
 * 3)

	)

1101 
	#GET_CMD_QUEUE_WRITES_THRESHOLD_L
(
sdev
è((sdev)->
cmd_queue_wr™es_lim™
 - (((sdev)->
max_luns_š_group
 * (sdev)->
logicbs_š_chunk
è>> 1))

	)

1102 
cmd_queue_wr™es_lim™
;

1103 
shªnÚ_©omic_t
 
wr™e_»qs_fÜ_gc
;

1104 
shªnÚ_©omic_t
 
š_æight_wr™es
;

1105 
shªnÚ_©omic_t
 
š_cmd_queue_wr™es
;

1106 
shªnÚ_©omic_t
 
gc_š_æight
;

1107 
shªnÚ_©omic_t
 
š_cmd_queue_adv_»ads
;

1109 
shªnÚ_li¡_h—d
 
adv_»ad_li¡
;

1110 
shªnÚ_¥šlock_t
 
adv_»ad_li¡_lock
;

1111 
	#MAX_IN_GC_LOGICBS
 25000

	)

1112 
shªnÚ_©omic_t
 
š_gc_logicbs
;

1113 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


1114 
shªnÚ_©omic_t
 
»ad_bios
;

1115 
shªnÚ_©omic_t
 
wr™e_bios
;

1117 
shªnÚ_wa™_queue_h—d_t
 
lim™_»q_queue
[2];

1119 
shªnÚ_¥šlock_t
 
»gs_İ_lock
;

1120 
shªnÚ_¥šlock_t
 
this_sb_lock
;

1121 
shªnÚ_sb
 *
this_sb
;

1122 
this_·ge_¡re
;

1123 
this_lun
;

1125 
u64
 
max_wr™e_bw
;

1126 
shªnÚ_©omic64_t
 
wr™e_bw
;

1127 
shªnÚ_mu‹x_t
 
thrÙe_wr™e_bw_£m
;

1128 
thrÙe_wr™e_bw_time_¡amp
;

1131 
	#DO_DATA_RETENTION_THRESHOLD
 (3600UL * 72è

	)

1132 
	#DEFAULT_DATA_RETENTION_INTERVAL
 1800

	)

1133 
d©a_»‹ÁiÚ_š‹rv®
;

1134 
shªnÚ_tim”_li¡
 
d©a_»‹ÁiÚ_tim”
;

1135 
	#WL_TIMER_INTERVAL
 120

	)

1136 
wl_tim”_š‹rv®
;

1137 
shªnÚ_tim”_li¡
 
wl_tim”
;

1138 
	sœq_d–ay_desc
 {

1139 
œq_d–ay
;

1141 
	#DEFAULT_UPDATE_IRQ_DELAY_TIMEOUT
 (10è

	)

1142 
	#DEFAULT_ENABLE_DYNAMIC_IRQ_DELAY
 (1)

	)

1143 
	#DEFAULT_IRQ_DELAY_FACTOR
 (2)

	)

1144 
	#DEFAULT_MIN_IRQ_DELAY
 (0x01)

	)

1145 
	#DEFAULT_MAX_IRQ_DELAY
 (0xFF)

	)

1146 
	#DEFAULT_HOST_READ_LAT_DIVIDE
 (5)

	)

1147 
	#DEFAULT_HOST_WRITE_LAT_DIVIDE
 (5)

	)

1148 
	#DEFAULT_HOST_READ_THRESHOLD_FACTOR
 (2)

	)

1149 
	#DEFAULT_HOST_WRITE_THRESHOLD_FACTOR
 (2)

	)

1150 
upd©e_œq_d–ay_š‹rv®
;

1151 
shªnÚ_tim”_li¡
 
upd©e_œq_d–ay_tim”
;

1152 
shªnÚ_wÜk_¡ruù
 
upd©e_œq_d–ay_wÜk
;

1153 
u32
 
dyÇmic_œq_d–ay
;

1154 
u32
 
»ad_Ï‹ncy_divide
;

1155 
u32
 
wr™e_Ï‹ncy_divide
;

1156 
u32
 
wr™e_th»shŞd_çùÜ
;

1157 
u32
 
»ad_th»shŞd_çùÜ
;

1158 
u32
 
çùÜ
;

1159 
u64
 
ho¡_wr™e_ios_Ï¡
;

1160 
u64
 
ho¡_wr™e_m£cs_Ï¡
;

1161 
u64
 
ho¡_»ad_ios_Ï¡
;

1162 
u64
 
ho¡_»ad_m£cs_Ï¡
;

1163 
mš_œq_d–ay
;

1164 
max_œq_d–ay
;

1165 } 
œq_d–ay
;

1166 
	#DATA_RETENTION
 0

	)

1167 
	#ERASE_BALANCE
 1

	)

1168 
	#READ_DISTURB
 2

	)

1169 
	#ECC_FAILURE
 3

	)

1170 
	#TOTAL_REASON
 4

	)

1171 
wl_»asÚ
;

1172 
Ãxt_wl_»asÚ
;

1173 
shªnÚ_wÜk_¡ruù
 
wl_fšd_sb_wÜk
;

1174 
shªnÚ_wÜk_¡ruù
 
wl_»ad_wÜk
;

1175 
shªnÚ_wÜkqueue_¡ruù_t
 *
wl_wq
;

1176 
shªnÚ_sb
 *
wl_this_sb
;

1177 
shªnÚ_©omic_t
 
š_wl_logicbs
;

1178 
shªnÚ_li¡_h—d
 
wa™_wl_li¡
;

1179 
	#WAIT_WL_BLKCNT_MAX
 2

	)

1180 
wa™_wl_blkút
;

1181 
shªnÚ_©omic_t
 
š_wl_blkút
;

1182 
shªnÚ_¥šlock_t
 
wa™_wl_lock
;

1183 
max_š_wl_logicbs
;

1184 
cu¼’t_max_š_wl_logicbs
;

1185 
wl_max_”a£_couÁ
;

1186 
wl_”a£_couÁ_d–
[2];

1188 
¢­_»ad_’abË
;

1189 
shªnÚ_©omic64_t
 
¢­_»ad_couÁ”
;

1190 
shªnÚ_©omic_t
 
¢­_»ad_mism©ch
;

1192 
ç¡_»ad_’abË
;

1194 
	s³riod_»ad_¡ruù
 {

1195 
	#PERIOD_READ_DISABLE
 (0)

	)

1196 
	#PERIOD_READ_ENABLE
 (1)

	)

1197 
u8
 
¡©e
;

1198 
u8
 
aùive_dÚe
[2];

1199 
u8
 
Ï¡_blk_dÚe
[2];

1200 
³riod
;

1201 
u32
 
µa
;

1202 
	#PERIOD_READ_THRESHOLD
 (100)

	)

1203 
u32
 
_š‹rv®
;

1204 
u64
 
mš_£q_num
;

1205 
u64
 
max_£q_num
;

1206 
u64
 
blkút
;

1207 } 
³riod_»ad
;

1209 
¡İ_®l
;

1210 
shªnÚ_tim”_li¡
 
³riod_»ad_tim”
;

1211 
shªnÚ_wÜk_¡ruù
 
³riod_»ad_wÜk
;

1212 
shªnÚ_tim”_li¡
 
gc_tim”
;

1213 
shªnÚ_wÜk_¡ruù
 
gc_tim”_wÜk
;

1214 
	#BALANCE_GC_TIMEOUT
 (30è

	)

1215 
shªnÚ_tim”_li¡
 
b®ªû_gc_tim”
;

1216 
gc_sk_lim™
;

1217 
shªnÚ_pm_qos_»que¡_t
 
pm_qos_l
;

1218 
shªnÚ_wÜk_¡ruù
 
pm_qos_wÜk
;

1219 
shªnÚ_wÜk_¡ruù
 
wÜk
;

1220 
pŞl
[
MAX_MSIX_INTERRUPTS
];

1221 
shªnÚ_mu‹x_t
 
pick_£m
;

1222 
shªnÚ_skËt_¡ruù
 
comp_skËt
[
MAX_MSIX_INTERRUPTS
];

1223 
š_œq
[
MAX_MSIX_INTERRUPTS
];

1225 
	#ADV_READ_SUPPORT_SHIFT
 (0)

	)

1226 
	#ADV_READ_SUPPORT_MASK
 (1 << 
ADV_READ_SUPPORT_SHIFT
)

	)

1227 
	#UPDATING_MICROCODE_SHIFT
 (1)

	)

1228 
	#UPDATING_MICROCODE_MASK
 (1 << 
UPDATING_MICROCODE_SHIFT
)

	)

1229 
advªûd_»ad_¡©e
;

1230 
©omic_wr™e
;

1231 
´iÜ™ize_wr™e
;

1232 
h—d_couÁ
;

1233 
u£_du®_h—d
;

1234 
	#SHORT_LBA_FORMAT
 (0)

	)

1235 
	#LONG_LBA_FORMAT
 (1)

	)

1236 
lba_fÜm©
;

1238 
wr_sb
[2];

1239 
wr_group
[2];

1240 
lun_š_group
[2];

1241 
wr_lun_off£t
[2];

1242 
wr_chunk
[2];

1243 
wr_¶ªe
[2];

1244 
wr_·ge
[2];

1245 
wr_logicb
[2];

1246 
aùive_blk_¡¬t_jiff›s
[2];

1247 
shªnÚ_sb
 *
aùive_blk
[2];

1248 
shªnÚ_sb
 *
Ï¡_blk
[2];

1249 
com·ù_•og
;

1251 
u64
 
chunk_¡¬t_jiff›s
[2];

1252 
shªnÚ_¥šlock_t
 
chunk_»q_lock
[2];

1253 
shªnÚ_»que¡
 *
chunk_»q
[2];

1254 
chunk_»qút
[2];

1256 
·r™y_š™_dÚe
[2];

1257 
shªnÚ_wa™_queue_h—d_t
 
·r™y_š™_dÚe_ev’t
[2];

1258 
	#FILL_SB_TIME_EXPIRE
 (25200ULè

	)

1259 
	#FILL_FIRST_SB_TIME_EXPIRE
 (7200ULè

	)

1260 
shªnÚ_tim”_li¡
 
fl_sb_tim”
[2];

1261 #ifdeà
SHANNON_USE_WRITE_BUFFER


1262 
shªnÚ_tim”_li¡
 
fl_chunk_tim”
[2];

1263 
fl_chunk_tim”_expœe
;

1265 
shªnÚ_d–ayed_wÜk
 
hÙ_d–ayed_·d
;

1266 
shªnÚ_d–ayed_wÜk
 
cŞd_d–ayed_·d
;

1269 
	#INIT_EPILOG_COUNT
 64

	)

1270 
	#RUN_EPILOG_COUNT
 4

	)

1271 
shªnÚ_¥šlock_t
 
•og_lock
;

1272 
•og_couÁ
;

1273 
shªnÚ_•og
 *
•ogs
[
INIT_EPILOG_COUNT
];

1274 
•og_b™m­
;

1276 
shªnÚ_¥šlock_t
 
u£d_blocks_lock
[2];

1277 
shªnÚ_li¡_h—d
 
u£d_blocks
[2];

1278 
u£d_blkút
[2];

1280 
shªnÚ_©omic_t
 
disÿrded_blkút
;

1281 
shªnÚ_li¡_h—d
 
ä“_blocks
;

1282 
shªnÚ_¥šlock_t
 
ä“_blocks_lock
;

1283 
ä“_blkút
;

1284 
shªnÚ_wa™_queue_h—d_t
 
block_ho¡_wr
;

1285 
shªnÚ_wa™_queue_h—d_t
 
wa™_ä“_blk
;

1286 
shªnÚ_li¡_h—d
 
wa™_cİy
;

1287 
	#WAIT_COPY_BLKCNT_MAX
 4

	)

1288 
wa™_cİy_blkút
;

1289 
shªnÚ_¥šlock_t
 
wa™_cİy_lock
;

1290 
shªnÚ_¥šlock_t
 
wa™_”a£d_lock
;

1291 
shªnÚ_li¡_h—d
 
wa™_”a£d
;

1292 
wa™_”a£d_blkút
;

1293 
shªnÚ_©omic_t
 
š_”a£_blkút
;

1294 
shªnÚ_¥šlock_t
 
cİy_”r_lock
;

1295 
shªnÚ_li¡_h—d
 
cİy_”r_blocks
;

1296 
cİy_”r_blkút
;

1297 
shªnÚ_¥šlock_t
 
»cov”_”r_lock
;

1298 
shªnÚ_li¡_h—d
 
»cov”_”r_blocks
;

1299 
»cov”_”r_blkút
;

1300 
shªnÚ_©omic_t
 
š_gc_blkút
;

1301 
	#IN_GC_STATE
 1

	)

1302 
	#NO_RECLAIM
 0

	)

1303 
gc_th»ad_¡©e
;

1304 
shªnÚ_¥šlock_t
 
gc_¡©e_lock
;

1305 
gc_çùÜ
;

1307 
hÙ_block_»şaim_´iÜ™y
;

1308 
gc_»ad_»qs
;

1309 
shªnÚ_¥šlock_t
 
gc_»qs_lock
;

1310 
shªnÚ_©omic_t
 
gc_th»ads
;

1311 
shªnÚ_wa™_queue_h—d_t
 
wa™_pick_ev’t
;

1312 
exŒa_»qs
;

1313 
shªnÚ_¥šlock_t
 
exŒa_»qs_lock
;

1314 
	#MAX_LOGICB_BUF_COUNT
 50000

	)

1315 
shªnÚ_©omic_t
 
logicb_buf_couÁ
;

1316 
shªnÚ_mempoŞ_t
 *
logicb_buf_poŞ
;

1317 
shªnÚ_mempoŞ_t
 *
•og_·ge_poŞ
;

1319 
shªnÚ_pci_dev_t
 *
pci_dev
;

1320 
node
;

1321 
shªnÚ_b¬
 
__iomem
 *
b¬
;

1322 vŞ©
u32
 *
š‹¼u±_b¬
;

1323 
glob®_b¬
 
__iomem
 *global_bar;

1325 
shªnÚ_lun
 **
lun
;

1326 
lun_couÁ
;

1327 
max_avaabË_luns
;

1328 
max_avaabË_groups
;

1329 
shªnÚ_lun£t
 *
lun£ts
;

1330 
lun£t_couÁ
;

1331 
__u64
 
max_£ùÜs
;

1332 
ov”´ovisiÚ_¿‹
;

1334 
shªnÚ_sb
 *
sbs
;

1335 
sb_couÁ
;

1336 
sub_group
 *
sub_groups
;

1337 
·r™y_groups
;

1338 
max_luns_š_group
;

1339 *
»ad_couÁ
;

1340 
u32
 
»ad_di¡urb_th»shŞd
;

1341 
u32
 
İ’_block_»ad_di¡urb_th»shŞd
;

1343 
shªnÚ_mbr
 
mbr
;

1344 
shªnÚ_mu‹x_t
 
modify_mbr_£m
;

1346 
big_lock
;

1347 
ho¡_acûss_blocked
;

1348 
drive_no
;

1349 
majÜ
;

1350 
shªnÚ_miscdeviû_t
 
misc
;

1351 
shªnÚ_li¡_h—d
 
li¡
;

1352 
cdev_Çme
[16];

1353 
shªnÚ_©omic_t
 
u£rs
;

1355 
shªnÚ_mu‹x_t
 
¡©e_£m
;

1361 
¡©e
;

1362 
acûss_mode
;

1369 
»adÚly_»asÚ
;

1370 
»duûd_wr™e_»asÚ
;

1371 
shªnÚ_wÜk_¡ruù
 
acûss_mode_wÜk
;

1373 
	#MAX_RECONFIG_TIMES
 5

	)

1374 
»cÚfig_suµÜt
;

1375 
»cÚfig_times
;

1376 
tÙ®_»cÚfig_times
;

1377 
fœ¡_jiff›
;

1379 
	#MAX_RESET_TIMES
 1

	)

1380 
»£t_times
;

1381 
tÙ®_»£t_times
;

1382 
fœ¡_»£t_jiff›
;

1386 
	#FLASH_PE_COUNT_SPEC
 5000

	)

1387 
mš_”a£_couÁ
;

1388 
max_”a£_couÁ
;

1389 
av”age_”a£_couÁ
;

1390 
v¬Ÿnû_of_”a£_couÁ
;

1391 
tÙ®_”a£_couÁ
;

1392 
æash_³_th»shŞd
;

1394 
shªnÚ_¥šlock_t
 
io_¡©i¡ics_lock
;

1396 
__u64
 
pow”_Ú_£cÚds
;

1397 
__u32
 
pow”_cyşe_couÁ
;

1399 
__u64
 
ho¡_wr™e_£ùÜs
;

1400 
__u64
 
ho¡_wr™e_£ùÜs_Ï¡
;

1402 
__u64
 
ho¡_wr™e_ios
;

1403 
__u64
 
ho¡_wr™e_m£cs
;

1405 
__u64
 
ho¡_wr™e_bªdwidth
;

1406 
__u64
 
ho¡_wr™e_iİs
;

1407 
__u64
 
ho¡_wr™e_Ï‹ncy
;

1409 
__u64
 
tÙ®_wr™e_£ùÜs
;

1410 
__u64
 
tÙ®_wr™e_£ùÜs_Ï¡
;

1411 
__u64
 
tÙ®_wr™e_bªdwidth
;

1413 
__u64
 
tÙ®_»ad_£ùÜs
;

1414 
__u64
 
tÙ®_»ad_£ùÜs_Ï¡
;

1415 
__u64
 
tÙ®_»ad_bªdwidth
;

1417 
__u64
 
ho¡_»ad_£ùÜs
;

1418 
__u64
 
ho¡_»ad_£ùÜs_Ï¡
;

1419 
__u64
 
ho¡_»ad_£ùÜs_hi¡Üy
;

1421 
__u64
 
ho¡_»ad_ios
;

1422 
__u64
 
ho¡_»ad_m£cs
;

1424 
__u64
 
ho¡_»ad_bªdwidth
;

1425 
__u64
 
ho¡_»ad_iİs
;

1426 
__u64
 
ho¡_»ad_Ï‹ncy
;

1428 
__u64
 
wr™e_am¶if›r
;

1429 
__u64
 
wr™e_am¶if›r_liãtime
;

1432 
__u64
 
tÙ®_gc_logicbs
;

1433 
__u64
 
tÙ®_wl_logicbs
;

1434 
__u64
 
tÙ®_”r_»cov”_logicbs
;

1436 
__u64
 
tÙ®_gc_£ùÜs_Ï¡
;

1437 
__u64
 
tÙ®_wl_£ùÜs_Ï¡
;

1438 
__u64
 
tÙ®_”r_»cov”_£ùÜs_Ï¡
;

1440 
__u32
 
gc_bªdwidth
;

1441 
__u32
 
wl_bªdwidth
;

1442 
__u32
 
”r_»cov”_bªdwidth
;

1444 
shªnÚ_©omic_t
 
¡©ic_bad_blkút
;

1445 
shªnÚ_©omic_t
 
dyÇmic_bad_blkút
;

1448 
gc_sbs
;

1449 
”r_»cov”ed_sbs
;

1450 
wl_sbs
;

1451 
d©a_»‹ÁiÚ_sbs
;

1452 
»ad_di¡urb_sbs
;

1453 
”a£_b®ªû_sbs
;

1454 
ecc_çu»_sbs
;

1456 
__u64
 
ecc_¡©i¡ics
[
ECC_CORRECTION_BITS_IN_SECTOR
 + 1];

1457 
shªnÚ_©omic_t
 
ecc_çu»_times
;

1458 
shªnÚ_©omic_t
 
ecc_fc_¡©i¡ics
;

1459 
	#ECC_FAILURE_RATE_THRESHOLD
 3

	)

1460 
ecc_çu»_¿‹_th»shŞd
;

1462 
pow”_Ú_jiff›s
;

1463 
Ï¡_jiff›s
;

1464 
__u64
 
pow”_Ú_£cÚds_hi¡Üy
;

1466 
	#NO_READ_ERR_MSG
 0

	)

1467 
	#ONE_MSG_PER_BLK
 1

	)

1468 
	#MSG_ON_RETRY_FAIL
 2

	)

1469 
	#MSG_ON_EACH_READ_FAIL
 3

	)

1470 
»ad_”r_msg_Ëv–
;

1473 
shªnÚ_li¡_h—d
 
»£nd_li¡
;

1474 
»£nd_logicbs
;

1475 
shªnÚ_¥šlock_t
 
»£nd_li¡_lock
;

1478 *
dummy_·ge
;

1479 
shªnÚ_dma_addr_t
 
dummy_dma_·ge
;

1481 
šŒ_big_shiá
[2];

1482 
bufq_ack_šŒ_shiá
;

1483 
£u_šŒ_shiá
;

1484 #ifdeà
SHANNON_USE_WRITE_BUFFER


1485 
bufq_¶ugged
;

1486 
bufãr_wr™e_lim™
;

1487 
shªnÚ_wÜk_¡ruù
 
hªdË_bufq_wÜk
;

1488 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

1489 
shªnÚ_wa™_queue_h—d_t
 
bufq_emu_wa™
[2];

1490 
shªnÚ_sk_¡ruù_t
 *
bufq_emu_th»ad
[2];

1492 
shªnÚ_mu‹x_t
 
bufq_sq_£m
[2];

1493 
shªnÚ_cmd
 *
bufq_sq_addr
[2];

1494 vŞ©
shªnÚ_cmd
 *
bufq_cq_addr
[2];

1495 
shªnÚ_dma_addr_t
 
bufq_sq_dma_addr
[2];

1496 
shªnÚ_dma_addr_t
 
bufq_cq_dma_addr
[2];

1497 
shªnÚ_wa™_queue_h—d_t
 
bufq_wa™_cmd_pos
[2];

1499 
shªnÚ_¥šlock_t
 
bufq_b¬_lock
[2];

1500 
shªnÚ_lun_b¬
 
__iomem
 *
bufq_b¬
[2];

1502 
__u32
 
bufq_sq_hw_h—d
[2];

1503 
__u32
 
bufq_sq_hw_
[2];

1504 
__u32
 
bufq_cq_hw_h—d
[2];

1506 
__u32
 
bufq_sq_h—d_tmp
[2];

1507 
__u32
 
bufq_sq_h—d
[2];

1508 
__u32
 
bufq_cq_h—d
[2];

1509 
__u32
 
bufq_cq_
[2];

1511 
__u8
 
bufq_hªg
[2];

1513 
shªnÚ_lun_b¬
 
__iomem
 *
bufq_ack_b¬
;

1514 
shªnÚ_cmd
 *
bufq_ack_cq_addr
;

1515 
shªnÚ_dma_addr_t
 
bufq_ack_cq_dma_addr
;

1516 
__u32
 
bufq_ack_cq_hw_h—d
;

1518 
__u32
 
bufq_ack_cq_
;

1519 
__u32
 
bufq_ack_cq_h—d
;

1521 
shªnÚ_cmd_šfo
 
cmd_šfo
[2][512];

1525 #ifdeà
CONFIG_SHANNON_DEBUG


1526 
shªnÚ_d’Œy_t
 *
shªnÚ_debug_roÙ
;

1527 
shªnÚ_d’Œy_t
 *
debugfs_®l_blocks
;

1528 
shªnÚ_d’Œy_t
 *
debugfs_hÙ_blocks
;

1529 
shªnÚ_d’Œy_t
 *
debugfs_cŞd_blocks
;

1530 
shªnÚ_d’Œy_t
 *
debugfs_wa™_”a£d
;

1531 
shªnÚ_d’Œy_t
 *
debugfs_wa™_cİy
;

1532 
shªnÚ_d’Œy_t
 *
debugfs_ä“_blocks
;

1533 
shªnÚ_d’Œy_t
 *
debugfs_”r_blks
;

1534 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


1535 
shªnÚ_d’Œy_t
 *
debugfs_out¡ªdšg_»qs
;

1536 
shªnÚ_d’Œy_t
 *
debugfs_out¡ªdšg_sbios
;

1538 
shªnÚ_d’Œy_t
 *
debugfs_»q_queue0
;

1539 
shªnÚ_d’Œy_t
 *
debugfs_»q_queue1
;

1540 
shªnÚ_d’Œy_t
 *
debugfs_cmd_queue
;

1541 
shªnÚ_d’Œy_t
 *
debugfs_gc_¡©e
;

1542 
shªnÚ_d’Œy_t
 *
debugfs_¡©i¡ics
;

1543 
shªnÚ_d’Œy_t
 *
debugfs_bßrd_·¿m‘”s
;

1544 
shªnÚ_d’Œy_t
 *
debugfs_»ad_couÁ
;

1545 
shªnÚ_d’Œy_t
 *
debugfs_ecc_çu»_times
;

1546 
shªnÚ_d’Œy_t
 *
debugfs_bad_blocks
;

1547 
shªnÚ_d’Œy_t
 *
debugfs_queue_d•th
;

1548 
shªnÚ_d’Œy_t
 *
debugfs_mbr
;

1549 
shªnÚ_d’Œy_t
 *
debugfs_l2p_lunm­
;

1551 
shªnÚ_d’Œy_t
 *
debugfs_wa™queue
;

1552 
shªnÚ_d’Œy_t
 *
debugfs_lock_¡©
;

1554 
shªnÚ_d’Œy_t
 *
debugfs_lun_¡©i¡ics
;

1556 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

1557 
shªnÚ_d’Œy_t
 *
debugfs_»gi¡”s
;

1559 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


1560 
shªnÚ_d’Œy_t
 *
debugfs_sq_d•th
;

1563 
shªnÚ_li¡_h—d
 
gc_¡©e_li¡
;

1564 
shªnÚ_¥šlock_t
 
gc_¡©e_li¡_lock
;

1565 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


1566 
d’Œy
 *
debugfs_çke_wr_bad_luÅ·
;

1567 
d’Œy
 *
debugfs_çke_rd_bad_luÅba
;

1568 
d’Œy
 *
debugfs_çke_”_bad_block
;

1569 
d’Œy
 *
debugfs_çke_bad_lun
;

1570 
d’Œy
 *
debugfs_çke_cmd_timeout_lun
;

1571 
d’Œy
 *
debugfs_çke_rd_bad_lun
;

1573 *
çke_wr_bad_luÅ·
;

1574 *
çke_rd_bad_luÅba
;

1575 *
çke_”_bad_block
;

1576 *
çke_bad_lun
;

1577 *
çke_cmd_timeout_lun
;

1578 *
çke_rd_bad_lun
;

1579 *
çke_twš_rd_bad_luÅba
;

1580 
d’Œy
 *
debugfs_twš_»ad_”r
;

1581 
twš_»ad_”r
;

1583 
çke_bad_lun_skmbr
;

1584 
çke_cmd_timeout_lun_skmbr
;

1585 
shªnÚ_©omic_t
 
rwe_”r_buf_dÚe
;

1586 
mªu®_»ad_”r
;

1587 
mªu®_wr™e_”r
;

1588 
d’Œy
 *
debugfs_mªu®_»ad_”r
;

1589 
d’Œy
 *
debugfs_mªu®_wr™e_”r
;

1591 #ifdeà
CONFIG_SHANNON_PLVERIFY


1592 
d’Œy
 *
debugfs_¶ù¾
;

1593 
¶ù¾
;

1594 
boÙšg_wa™_”a£d
[128];

1596 #ifdeà
CONFIG_SHANNON_DEBUG_DUMP


1597 
shªnÚ_d’Œy_t
 *
debugfs_dump
;

1599 
shªnÚ_d’Œy_t
 *
debugfs_badlun
;

1600 
shªnÚ_d’Œy_t
 *
debugfs_vŞge
;

1603 
shªnÚ_d’Œy_t
 *
debugfs_cmd_queue_¿w_d©a_dœ
;

1604 
shªnÚ_d’Œy_t
 **
debugfs_cmd_queue_¿w_d©a
;

1607 
	#DMA_REORDER_RETRY_COUNT
 5000

	)

1608 
u64
 
¡©us_pŞl_couÁ
;

1609 
u64
 
¡©us_pŞl_»Œy
;

1610 
u64
 
»ad_pŞl_couÁ
;

1611 
u64
 
»ad_pŞl_»Œy
;

1612 
u64
 
bufq_pŞl_couÁ
;

1613 
u64
 
bufq_pŞl_»Œy
;

1615 #ifdeà
CONFIG_SHANNON_DEBUG_CDEV


1616 
shªnÚ_dev_t
 
bufq_commªd_dev_num
;

1617 
bufq_commªd_majÜ
;

1618 
shªnÚ_şass_t
 *
bufq_commªd_şass
;

1619 
debug_cdev
 *
bufq_commªd_cdevs
;

1621 
shªnÚ_dev_t
 
commªd_dev_num
;

1622 
commªd_majÜ
;

1623 
shªnÚ_şass_t
 *
commªd_şass
;

1624 
debug_cdev
 *
commªd_cdevs
;

1626 
shªnÚ_dev_t
 
com¶‘iÚ_dev_num
;

1627 
com¶‘iÚ_majÜ
;

1628 
shªnÚ_şass_t
 *
com¶‘iÚ_şass
;

1629 
debug_cdev
 *
com¶‘iÚ_cdevs
;

1631 
shªnÚ_dev_t
 
pba_bË_dev_num
;

1632 
pba_bË_majÜ
;

1633 
shªnÚ_şass_t
 *
pba_bË_şass
;

1634 
debug_cdev
 *
pba_bË_cdevs
;

1636 
shªnÚ_dev_t
 
•og_dev_num
;

1637 
•og_majÜ
;

1638 
shªnÚ_şass_t
 *
•og_şass
;

1639 
debug_cdev
 *
•og_cdev
;

1642 
shªnÚ_disk
 
sdisk
;

1643 
shªnÚ_sk_¡ruù_t
 *
´eãtch_th»ad
;

1651 
¿id5_suµÜ‹d
;

1652 
rÙ©e_·r™y
;

1654 
shªnÚ_¥šlock_t
 
£qu’û_numb”_lock
;

1655 
u64
 
£qu’û_numb”
;

1656 
u64
 
pow”_Ú_£q_num
;

1657 
ecc_by·ss
;

1658 
»Œy_times_Ú_”rÜ
;

1660 
	#STAGE_INIT_HARDWARE_DONE
 1

	)

1661 
	#STAGE_BBT_DONE
 2

	)

1662 
	#STAGE_RECOVER_USED_DONE
 3

	)

1663 
	#STAGE_RECOVER_ACTIVE_DONE
 4

	)

1664 
	#STAGE_RECOVER_DONE
 5

	)

1665 
	#STAGE9_DONE
 9

	)

1666 
š™_dÚe
;

1667 
	#RECOVER_WARNING
 -1

	)

1668 
	#RECOVER_PROBLEMATIC
 -2

	)

1669 
	#RECOVER_ERROR
 -3

	)

1670 
	#RECOVER_DEAD
 -4

	)

1671 
»cov”_¡©e
;

1672 
shªnÚ_©omic_t
 
»cov”_dÚe
;

1673 
shªnÚ_wa™_queue_h—d_t
 
»cov”_dÚe_ev’t
;

1675 
	#IDLE
 (0)

	)

1676 
	#WAIT_NEXT_GROUP_STATUS
 (1)

	)

1677 
	#GET_NEXT_GROUP_STATUS_FINISH
 (2)

	)

1678 
shªnÚ_©omic_t
 
aùive_wa™_¡©us
;

1679 
shªnÚ_wa™_queue_h—d_t
 
aùive_wa™_ev’t
;

1680 
shªnÚ_©omic_t
 
wa™_blk
;

1681 
shªnÚ_wa™_queue_h—d_t
 
wa™_blk_dÚe_ev’t
;

1682 
shªnÚ_wa™_queue_h—d_t
 
big_lock_ev’t
;

1684 *
šv®id_æashids
;

1685 
Ãw_bad_lun
 *new_bad_lun;

1686 
u64
 
¡©ic_bad_lun_m­
[
BAD_LUN_MAP_ARRAY_SIZE
];

1688 
shªnÚ_sk_¡ruù_t
 *
gc_th»ad
;

1690 
shªnÚ_¥šlock_t
 
”r_blks_lock
;

1691 
shªnÚ_li¡_h—d
 
”r_blks
;

1692 
”r_blkút
;

1693 
shªnÚ_©omic_t
 
³ndšg_”r_blks
;

1694 
shªnÚ_sk_¡ruù_t
 *
»cov”_th»ad
;

1695 
»cov”_¿‹
;

1696 
shªnÚ_sb
 *
this_”r_sb
;

1697 
this_”r_sb_šdex
;

1698 
this_”r_¡re
;

1699 
”r_gc_çùÜ
;

1701 
	#LUN_BITMAP_LEN
 64

	)

1702 
u8
 
”r_check_b™m­
[
LUN_BITMAP_LEN
];

1703 
”r_check_debug
;

1704 
su¥icious_bad_lun_šdiÿtÜ
;

1706 
logicb_shiá
;

1707 
logicb_size
;

1708 
£ùÜs_š_logicb
;

1710 
u£r_logicb_shiá
;

1711 
u£r_logicb_size
;

1713 
Çnd_·ge_size
;

1714 
Çnd_·ge_shiá
;

1715 
Çnd_·ge_ÿ·c™y
;

1716 
oob_size
;

1717 
logicbs_š_·ge
;

1718 
¶ªes
;

1719 
p£udo_¶ªe
;

1720 
¶ªe_Üd”
;

1721 
logicbs_š_chunk
;

1722 
logicbs_š_·ge_¡re
;

1723 
·ges_š_eblock
;

1724 
eblocks_š_lun
;

1725 
mbr_eblocks
;

1726 
logicbs_š_eblock
;

1727 
logicbs_š_siblšg_eblock
;

1728 
·ges_š_siblšg_eblock
;

1729 
cfg_chªÃls
;

1730 
cfg_lun£t_š_chªÃl
;

1731 
cfg_lun_š_lun£t
;

1732 
max_chªÃls
;

1733 
max_lun_š_chªÃl
;

1734 
max_lun£t_š_chªÃl
;

1735 
max_lun_š_lun£t
;

1736 
max_lun_š_û
;

1737 
max_û_š_lun£t
;

1738 
max_•og_size
;

1739 
max_logicbs_š_•og
;

1740 
•og_h—d_size
;

1741 
•og_’Œy_size
;

1742 
´efix_no_İ_cmd
;

1744 
µa_block_width
;

1745 
µa_¶ªe_width
;

1746 
µa_·ge_width
;

1747 
µa_block_shiá
;

1748 
µa_¶ªe_shiá
;

1749 
µa_·ge_shiá
;

1752 
š‹¼u±_d–ay
;

1753 
ecc_codewÜds_š_logicb
;

1754 
ecc_cÜ»ùiÚ_pow”
;

1755 
ecc_codewÜd_size
;

1756 
fœ¡_codewÜd_off£t
;

1757 
	#MODE_8BIT
 (1)

	)

1758 
	#MODE_16BIT
 (2)

	)

1759 
b™_mode
;

1760 *
£ùÜs_codewÜd_addr
;

1761 
fuÎ_£ùÜ_size
;

1762 
fuÎ_·ge_size
;

1763 
v”y_š™Ÿl_sblk
[2];

1765 
pba_bË_size
;

1767 
´og»ss_b¬_v®id
;

1768 
shªnÚ_©omic_t
 
”a£_dÚe
;

1769 
shªnÚ_wa™_queue_h—d_t
 
”a£_dÚe_ev’t
;

1770 
shªnÚ_©omic_t
 
»äesh_mbr_dÚe
;

1771 
shªnÚ_©omic_t
 
»äesh_mbr_couÁ
;

1774 
vŞge_aux
;

1775 
vŞge_aux_max
;

1776 
vŞge_št
;

1777 
vŞge_št_max
;

1778 
‹m³¿tu»_št
;

1779 
‹m³¿tu»_št_max
;

1780 
‹m³¿tu»_aux1
;

1781 
‹m³¿tu»_aux2
;

1782 
‹m³¿tu»_bßrd
;

1783 
‹m³¿tu»_bßrd_max
;

1784 
‹m³¿tu»_æash
;

1785 
‹m³¿tu»_æash_max
;

1786 
‹m³¿tu»_w¬nšg_th»shŞd
;

1789 
u32
 
£u_üc_”rÜ
;

1790 
u32
 
£u_üc_”rÜ_hi¡Üy
;

1791 
u32
 
£u_ecc_”rÜ
;

1792 
u32
 
£u_ecc_”rÜ_hi¡Üy
;

1795 
shªnÚ_wÜkqueue_¡ruù_t
 *
shªnÚ_wq
;

1796 
shªnÚ_wÜkqueue_¡ruù_t
 *
shªnÚ_»ad_wq
;

1797 
shªnÚ_wÜkqueue_¡ruù_t
 *
shªnÚ_³riod_»ad_wq
;

1798 
shªnÚ_wÜkqueue_¡ruù_t
 *
gc_tim”_wq
;

1799 
shªnÚ_wÜkqueue_¡ruù_t
 *
»ad_”r_wq
;

1800 
shªnÚ_wÜkqueue_¡ruù_t
 *
shªnÚ_comp_wq
;

1801 
shªnÚ_wÜkqueue_¡ruù_t
 *
´eãtch_wq
;

1802 
shªnÚ_¹_wÜkqueue_¡ruù
 *
shªnÚ_¹_comp_wq
;

1803 
ÿÎback_Ä_wq
;

1804 
shªnÚ_wÜkqueue_¡ruù_t
 **
shªnÚ_ÿÎback_wq
;

1805 
shªnÚ_wÜkqueue_¡ruù_t
 **
hªdË_lun_wq
;

1806 **
wÜkqueue_Çme
;

1807 
wÜkqueue_couÁ
;

1808 
shªnÚ_Ä_wq
;

1811 
u64
 
buf_»ad_çed
;

1812 
hÙ_¶uggabË
;

1813 
¶ug_out
;

1814 
shªnÚ_d–ayed_wÜk
 
ejeù_wÜk
;

1815 
shªnÚ_wÜk_¡ruù
 
¶ugout_wÜk
;

1816 
shªnÚ_mu‹x_t
 
¶ug_out_£m
;

1818 
shªnÚ_wÜk_¡ruù
 
»cÚfig_wÜk
;

1819 
shªnÚ_wÜk_¡ruù
 
»£t_wÜk
;

1820 
shªnÚ_wÜk_¡ruù
 
upd©e_miüocode_wÜk
;

1822 
u64
 
dÇ
;

1823 
u32
 
has_£rviû_g
;

1824 
£rviû_g
[32];

1825 
mod–_id
[40];

1827 
udid
[36];

1829 
u32
 
fœmw¬e_v”siÚ
;

1830 
u32
 
fœmw¬e_g
;

1831 
u8
 
h¬dw¬e_v”siÚ
;

1834 
shªnÚ_kobjeù_t
 
sysfs_kobj
;

1835 
shªnÚ_kobjeù_t
 
sysfs_pci_šfo_kobj
;

1836 
sysfs_š™_dÚe
;

1839 
shªnÚ_deviû_t
 *
hwmÚ_dev
;

1842 
shªnÚ_tim”_li¡
 
w©chdog_tim”
;

1843 
shªnÚ_wÜk_¡ruù
 
w©chdog_wÜk
;

1845 
shªnÚ_wÜkqueue_¡ruù_t
 *
misc_wq
;

1846 
w©chdog_¡İ
;

1848 
	#MBR_REFRESH_INTERVAL
 15552000

	)

1851 
shªnÚ_wÜk_¡ruù
 
»äesh_wÜk
;

1852 
shªnÚ_wÜkqueue_¡ruù_t
 *
»äesh_wq
;

1853 
»äesh_£qu’û
;

1856 
	#READ_FROM_NORFLASH
 1

	)

1857 
	#MICROCODE_FROM_NORFLASH
 (1 << 1)

	)

1858 
u8
 
nÜ_mbr_¡©us
;

1859 
u64
 
æashid
;

1860 
ifmode
;

1861 
ov”drive
;

1862 
äeq_mode
;

1864 
cu¼’t_miüocode_šdex
;

1865 
	#MICROCODE_ARRAY_SIZE
 (8)

	)

1867 
	#MICROCODE_INVALID
 (0)

	)

1868 
	#MICROCODE_VALID_SHIFT
 (0)

	)

1869 
	#MICROCODE_VALID_MASK
 (1 << 
MICROCODE_VALID_SHIFT
)

	)

1870 
	#MICROCODE_FROM_NOR_SHIFT
 (1)

	)

1871 
	#MICROCODE_FROM_NOR_MASK
 (1 << 
MICROCODE_FROM_NOR_SHIFT
)

	)

1872 
	#MICROCODE_IN_USE_SHIFT
 (2)

	)

1873 
	#MICROCODE_IN_USE_MASK
 (1 << 
MICROCODE_IN_USE_SHIFT
)

	)

1874 
¡©e
;

1875 
³_cyşe
;

1876 
¡¬t_»g
;

1877 
miüocode_Ëngth
;

1878 
u32
 *
bË
;

1879 } 
miüocode_¬¿y
[
MICROCODE_ARRAY_SIZE
];

1881 
sh¬ed_·ges
;

1882 
dummy_wÜdlše
;

1883 
ã©u»_cfg
 
ã©u»_cfg_li¡
[
FEATURE_CFG_LIST_SIZE
];

1885 
u64
 
fl_İ’_chunk_logicbs
;

1887 
u64
 
bufãr_wr™e_couÁ”
;

1888 
u64
 
bufãr_wr™e_couÁ”_Ï¡
;

1889 
u64
 
dœeù_wr™e_couÁ”
;

1890 
u64
 
dœeù_wr™e_couÁ”_Ï¡
;

1892 
u64
 
bufãr_wr™e_³rûÁ
;

1894 
u32
 
nÜæash_id
;

1895 
shªnÚ_nÜæash
 
nÜæash
;

1896 
shªnÚ_mu‹x_t
 
nÜæash_İs_£m
;

1898 
nÜ_block
 *
nÜ_blocks
;

1899 
nÜ_·ge
 **
nÜ_·ge_¬¿y
;

1900 
cu¼_·ge
;

1901 
Ãxt_¦Ù
;

1902 
pos_block
;

1903 
pos_·ge
;

1904 
u16
 
bbt_fÜm©_v”siÚ
;

1905 
u32
 
bbt_£q_num
;

1906 
shªnÚ_li¡_h—d
 
fuÎ_nÜ_block_li¡
;

1907 
shªnÚ_li¡_h—d
 
u£d_nÜ_block_li¡
;

1908 
shªnÚ_li¡_h—d
 
ä“_nÜ_block_li¡
;

1909 
shªnÚ_li¡_h—d
 
wa™_”a£_nÜ_block_li¡
;

1910 
shªnÚ_li¡_h—d
 
”a£_”r_nÜ_block_li¡
;

1911 
shªnÚ_li¡_h—d
 
wr™e_”r_nÜ_block_li¡
;

1912 
ä“_nÜ_block_couÁ
;

1913 
shªnÚ_mu‹x_t
 
wr™e_bbt_£m
;

1914 
	#BBT_SLOT_IS_FULL
 (1 << 0)

	)

1915 
	#BBT_NOR_BLOCK_NO_SPACE
 (1 << 1)

	)

1916 
nÜ_bbt_¡©e
;

1917 
shªnÚ_d’Œy_t
 *
debugfs_bbt_¡©e
;

1919 
ov”Ïp_wr™e
;

1920 
shªnÚ_ov”Ïp
 *
ov”Ïp
;

1921 
shªnÚ_wa™_queue_h—d_t
 
”a£_dummy_dÚe_ev’t
;

1922 
shªnÚ_©omic_t
 
”a£_dummy_dÚe
;

1925 
shªnÚ_pci_šfo
 
pci_šfo
;

1929 
	#NS_LOGICB_SHIFT
 12

	)

1930 
	#NS_STRIP_SIZE_SHIFT
 (3è

	)

1931 
	sshªnÚ_Çme¥aû
 {

1932 
shªnÚ_disk
 
sdisk
;

1933 
u£r_logicb_size
;

1934 
u£r_logicb_shiá
;

1935 
logicb_size
;

1936 
logicb_shiá
;

1937 
¡r_size
;

1938 
¡r_size_shiá
;

1939 
shªnÚ_¥šlock_t
 
d©a_lock
;

1940 
lun_pba
 
d©a_pba
;

1941 
shªnÚ_ns_d©a
 *
d©a
;

1942 
upd©e_ns_d©a_dÚe
;

1943 
shªnÚ_wa™_queue_h—d_t
 
upd©e_ns_d©a_dÚe_ev’t
;

1944 
shªnÚ_©omic_t
 
ios
;

1945 
u32
 
max_iİs
;

1946 
shªnÚ_mu‹x_t
 
thrÙe_ios_£m
;

1947 
u32
 
thrÙe_ios_time_¡amp
;

1948 
u16
 
£q_num
;

1950 
shªnÚ_©omic_t
 
u£rs
;

1952 
shªnÚ_©omic_t
 
»fcouÁ
;

1953 
u32
 
£ùÜs_š_logicb
;

1954 
u32
 
idx
;

1955 
shªnÚ_poŞ
 *
poŞ
;

1956 
shªnÚ_kobjeù_t
 
sysfs_kobj
;

1957 
majÜ
;

1958 
sysfs_š™_dÚe
;

1959 
u64
 
ho¡_wr™e_£ùÜs_hi¡Üy
;

1960 
u64
 
ho¡_»ad_£ùÜs_hi¡Üy
;

1962 
Ï¡_jiff›s
;

1963 
shªnÚ_¥šlock_t
 
io_¡©i¡ics_lock
;

1965 
__u64
 
ho¡_wr™e_£ùÜs
;

1966 
__u64
 
ho¡_wr™e_£ùÜs_Ï¡
;

1968 
__u64
 
ho¡_wr™e_ios
;

1969 
__u64
 
ho¡_wr™e_m£cs
;

1971 
__u64
 
ho¡_wr™e_bªdwidth
;

1972 
__u64
 
ho¡_wr™e_iİs
;

1973 
__u64
 
ho¡_wr™e_Ï‹ncy
;

1975 
__u64
 
ho¡_»ad_£ùÜs
;

1976 
__u64
 
ho¡_»ad_£ùÜs_Ï¡
;

1978 
__u64
 
ho¡_»ad_ios
;

1979 
__u64
 
ho¡_»ad_m£cs
;

1981 
__u64
 
ho¡_»ad_bªdwidth
;

1982 
__u64
 
ho¡_»ad_iİs
;

1983 
__u64
 
ho¡_»ad_Ï‹ncy
;

1987 
	#POOL_DEFAULT_OVERPROVISION
 20

	)

1989 
	sshªnÚ_poŞ
 {

1990 
u64
 
w©”m¬k
;

1991 
u16
 
id
;

1992 
u16
 
sdev_couÁ
;

1993 
u16
 
Úlše_sdev_couÁ
;

1994 
shªnÚ_©omic_t
 
»fcouÁ
;

1995 
ov”´ovisiÚ
;

1996 
»adÚly_»asÚ
;

1997 
shªnÚ_©omic_t
 
ns_couÁ
, 
high_´iÜ™y_ns_couÁ
;

1998 
shªnÚ_©omic64_t
 
u£d_logicbs
;

1999 
u64
 
avaabË_ÿ·c™y
;

2000 
u64
 
physiÿl_ÿ·c™y
;

2001 
majÜ
;

2002 
ex™
;

2003 
¡©e
;

2004 
acûss_mode
;

2005 
shªnÚ_li¡_h—d
 
li¡
;

2006 
cdev_Çme
[16];

2007 
nod’ame
[32];

2008 
shªnÚ_miscdeviû_t
 
misc
;

2009 
shªnÚ_mu‹x_t
 
¡©e_£m
;

2010 
shªnÚ_kobjeù_t
 
sysfs_kobj
;

2011 
sysfs_š™_dÚe
;

2012 
h¬d_queue_lim™
;

2013 
shªnÚ_©omic_t
 
»cov”_ns_d©a_dÚe
;

2014 
shªnÚ_wa™_queue_h—d_t
 
»cov”_ns_d©a_dÚe_ev’t
;

2020 
shªnÚ_Çme¥aû
 **
ns
;

2021 
shªnÚ_ns_d©a
 *
ns_d©a
;

2022 
shªnÚ_mu‹x_t
 
poŞ_šfo_£m
;

2023 
shªnÚ_poŞ_šfo
 *
poŞ_šfo
;

2025 
shªnÚ_mbr
 *
fœ¡_mbr
;

2026 
shªnÚ_dev
 *
sdevs
[0];

2029 
	#OVERPROVISION_THRESHOLD
 10

	)

2030 
	#INT_DEALY
 1

	)

2031 
	#META_LEN
 8

	)

2032 
	#RAID5_SUPPORTED
 1

	)

2033 
	#ROTATE_PARITY
 1

	)

2034 
	#ECC_BYPASS
 0

	)

2036 
	#GC_DIVIDE_FACTOR
 50

	)

2037 
	#GC_THROTTLE_FACTOR
 6

	)

2039 
	#GC_THRESHOLD_N1H
 24

	)

2040 
	#GC_THRESHOLD_N1L
 23

	)

2041 
	#GC_WL_BAR
 17

	)

2042 
	#GC_THROTTLE_BAR
 17

	)

2043 
	#GC_THRESHOLD_N3
 6

	)

2045 
	#READ_THE_REST_TAG
 0x0101010101010000

	)

2046 
	#READ_LAST_EPILOG_CALLBACK_TAG
 0x1212121212120000

	)

2047 
	#READ_LAST_EPILOG_TAG
 0x2323232323230000

	)

2048 
	#RECOVER_ACTIVE_BLK_TAG
 0x3434343434340000

	)

2049 
	#PARITY_INIT_TAG
 0x4545454545450000

	)

2050 
	#WRITE_PARITY_TAG
 0x5656565656560000

	)

2051 
	#WRITE_EPILOG_TAG
 0x6767676767670000

	)

2053 
	#HOT_TIMER_FN_TAG
 0x8989898989890000

	)

2054 
	#COLD_TIMER_FN_TAG
 0x9a9a9a9a9a9a0000

	)

2055 
	#ERASE_BLOCK_TAG
 0xabababababab0000

	)

2056 
	#GC_TAG
 0xbcbcbcbcbcbc0000

	)

2057 
	#WL_TAG
 0xcdcdcdcdcdcd0000

	)

2058 
	#WR_ERR_HANDLER_TAG
 0xdededededede0000

	)

2059 
	#READ_BBT_TAG
 0xeãããããf0000

	)

2060 
	#ADD_BBT_TO_MBR_TAG
 0x1231231231230000

	)

2061 
	#WRITE_MBR_TAG
 0x2342342342340000

	)

2062 
	#WRITE_STATIC_BBT_TAG
 0x3453453453450000

	)

2063 
	#READ_PPA_TAG
 0x4564564564560000

	)

2064 
	#RAID5_RECOVERY_TAG
 0x5675675675670000

	)

2065 
	#DUMMY_CHUNK_TAG
 0x6786786786780000

	)

2066 
	#READ_CHECK_TAG
 0x7897897897890000

	)

2067 
	#RECOVER_BBT_TAG
 0x89a89a89a89a0000

	)

2068 
	#FILL_BLANK_EPILOG_TAG
 0x9ab9ab9ab9ab0000

	)

2069 
	#FILL_BUFFER_WRITE_CHUNK_TAG
 0xabÿbÿbÿbc0000

	)

2070 
	#ASSEMBLE_READ_TAG
 0xbcdbcdbcdbcd0000

	)

2071 
	#ASSEMBLE_RMW_READ_TAG
 0xcdecdecdecde0000

	)

2072 
	#REFRESH_MBR_EBLKS_TAG
 0xdefdefdefdef0000

	)

2073 
	#BAD_LUN_CHECKING_TAG
 0xãdãdãdãd0000

	)

2074 
	#READ_BBT_POOL_INFO_TAG
 0x1234123412340000

	)

2075 
	#WRITE_BBT_POOL_INFO_TAG
 0x2345234523450000

	)

2076 
	#ADD_BBT_POOL_INFO_TAG
 0x3456345634560000

	)

2077 
	#CHECK_NEXT_GROUP_TAG
 0x4567456745670000

	)

2078 
	#FILL_ACTIVE_BLK_TAG
 0x5678567856780000

	)

2079 
	#RESEND_RMW_READ_TAG
 0x6789678967890000

	)

2080 
	#PERIOD_READ_TAG
 0x789a789a789a0000

	)

2081 
	#UPDATE_NS_DATA_TAG
 0x89ab89ab89ab0000

	)

2082 
	#RECOVER_NS_DATA_TAG
 0x9abc9abc9abc0000

	)

2083 
	#RECOVER_OVERLAP_BLK_TAG
 0xabcdabcdabcd0000

	)

2084 
	#OVERLAP_WRITE_BACK_TAG
 0xbcdebcdebcde0000

	)

2085 
	#PREFETCH_TAG
 0xcba9cba9cba90000

	)

2087 
šlše
 
	$pba_is_equ®
(
lun_pba
 *
pba1
, lun_pb¨*
pba2
)

2089  ((
pba1
->
lun
 =ğ
pba2
->lunè&& (pba1->
lun_pba
 ==…ba2->lun_pba));

2090 
	}
}

2092 
šlše
 
	$lun_pba_is_šv®id
(
lun_pba
 *
pba
)

2094  (
pba
->
lun_pba
 == 0x03ffffff);

2095 
	}
}

2097 
šlše
 
	$£t_lun_pba_šv®id
(
lun_pba
 *
pba
)

2099 
pba
->
lun_pba
 = 0x03ffffff;

2100 
	}
}

2102 
šlše
 
u64
 
	$g‘_Ímt_v®id_logicbs
(
m­_bË_¡ruù
 *
Ímt
)

2104 
i
;

2105 
u64
 
v®id_logicbs
 = 0;

2107 ià(
	`uÆik–y
(
Ímt
 =ğ
NULL
))

2110 ià(!(
Ímt
->
¡©e
 & 
MAP_TABLE_VALID_MASK
))

2113 
i
 = 0; i < 
LOCK_COUNT
; i++)

2114 
v®id_logicbs
 +ğ
Ímt
->
v®id_logicbs_¬¿y
[
i
];

2116  
v®id_logicbs
;

2117 
	}
}

2119 
šlše
 
u64
 
	$g‘_sdisk_v®id_logicbs
(
shªnÚ_disk
 *
sdisk
)

2121 
i
;

2122 
u64
 
v®id_logicbs
 = 0;

2124 ià(
sdisk
->
Ímt_¬¿y
 =ğ
NULL
)

2127 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++)

2128 
v®id_logicbs
 +ğ
	`g‘_Ímt_v®id_logicbs
(&
sdisk
->
Ímt_¬¿y
[
i
]);

2130  
v®id_logicbs
;

2131 
	}
}

2133 
šlše
 
	$Ímt_v®id_logicbs_ş—r
(
m­_bË_¡ruù
 *
Ímt
)

2135 
i
;

2137 ià(
	`uÆik–y
(
Ímt
 =ğ
NULL
))

2140 
i
 = 0; i < 
LOCK_COUNT
; i++)

2141 
Ímt
->
v®id_logicbs_¬¿y
[
i
] = 0;

2142 
	}
}

2144 
šlše
 
	$sdisk_v®id_logicbs_ş—r
(
shªnÚ_disk
 *
sdisk
)

2146 
i
;

2148 ià(
sdisk
->
Ímt_¬¿y
 =ğ
NULL
)

2151 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++)

2152 
	`Ímt_v®id_logicbs_ş—r
(&
sdisk
->
Ímt_¬¿y
[
i
]);

2153 
	}
}

2155 
šlše
 
u32
 
	$g‘_m­_bË_¡ruù_šdex_äom_lba
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
)

2157 ià(
sdisk
->
sdev_couÁ
 == 1)

2159 ià((
sdisk
->
sdev_couÁ
 & (sdisk->sdev_count - 1)) == 0)

2160  ((
lba
 >> 
sdisk
->
¡r_size_shiá
è& (sdisk->
sdev_couÁ
 - 1));

2162  ((
lba
 >> 
sdisk
->
¡r_size_shiá
è% sdisk->
sdev_couÁ
);

2163 
	}
}

2164 
	#g‘_m­_bË_¡ruù_äom_sdev
(
sdev
, 
sdisk
è(&((sdisk)->
Ímt_¬¿y
[sdev->
sdev_id
]))

	)

2165 
	#g‘_Ímt_lock_šdex
(
¦Ù
è((¦Ùè% 
LOCK_COUNT
)

	)

2166 
	#Ímt_lock
(
sdev
, 
sdisk
, 
lba
) \

2167 
	`shªnÚ_¥š_lock_bh
(&(
sdisk
)->
Ímt_¬¿y
[(
sdev
)->
sdev_id
].
m­_bË_lock
[
	`g‘_Ímt_lock_šdex
(
	`g‘_¦Ù_äom_Ímt
((sdisk), (
lba
)))])

	)

2169 
	#Ímt_uÆock
(
sdev
, 
sdisk
, 
lba
) \

2170 
	`shªnÚ_¥š_uÆock_bh
(&(
sdisk
)->
Ímt_¬¿y
[(
sdev
)->
sdev_id
].
m­_bË_lock
[
	`g‘_Ímt_lock_šdex
(
	`g‘_¦Ù_äom_Ímt
((sdisk), (
lba
)))])

	)

2172 
	#Ímt_lock_š_»cov”_Ímt
(
sdev
, 
sdisk
, 
¦Ù
) \

2173 
	`shªnÚ_¥š_lock
(&(
sdisk
)->
Ímt_¬¿y
[(
sdev
)->
sdev_id
].
m­_bË_lock
[
	`g‘_Ímt_lock_šdex
((
¦Ù
))])

	)

2175 
	#Ímt_uÆock_š_»cov”_Ímt
(
sdev
, 
sdisk
, 
¦Ù
) \

2176 
	`shªnÚ_¥š_uÆock
(&(
sdisk
)->
Ímt_¬¿y
[(
sdev
)->
sdev_id
].
m­_bË_lock
[
	`g‘_Ímt_lock_šdex
((
¦Ù
))])

	)

2178 
	#MBR_MAX_TRY
 32

	)

2180 
	#£t_»cov”_¡©e_w¬nšg
(
sdev
) \

2182 ià((
sdev
)->
»cov”_¡©e
 > 
RECOVER_WARNING
) \

2183 (
sdev
)->
»cov”_¡©e
 = 
RECOVER_WARNING
; \

2184 
	`shªnÚ_w¬n
("Lš%d„ecov” w¬nšg.\n", 
__LINE__
); \

2185 } 0)

	)

2187 
	#£t_»cov”_¡©e_´obËm©ic
(
sdev
) \

2189 ià((
sdev
)->
»cov”_¡©e
 > 
RECOVER_PROBLEMATIC
) \

2190 (
sdev
)->
»cov”_¡©e
 = 
RECOVER_PROBLEMATIC
; \

2191 
	`shªnÚ_£t_b™
(
SHN_REASON_EPILOG_FAILURE
, &(
sdev
)->
»adÚly_»asÚ
); \

2192 
	`shªnÚ_”r
("Lš%d: ProbËm©iø»cov”! N“dØb»fÜm©‡ˆÚû.\n", 
__LINE__
); \

2193 } 0)

	)

2195 
	#£t_»cov”_¡©e_”rÜ
(
sdev
) \

2197 ià((
sdev
)->
»cov”_¡©e
 > 
RECOVER_ERROR
) \

2198 (
sdev
)->
»cov”_¡©e
 = 
RECOVER_ERROR
; \

2199 
	`shªnÚ_£t_b™
(
SHN_REASON_EPILOG_FAILURE
, &(
sdev
)->
»adÚly_»asÚ
); \

2200 
	`shªnÚ_”r
("Lš%d: Recov” E¼Ü! N“dØb»fÜm©‡ˆÚû.\n", 
__LINE__
); \

2201 } 0)

	)

2203 
	#£t_»cov”_¡©e_d—d
(
sdev
) \

2205 ià((
sdev
)->
»cov”_¡©e
 > 
RECOVER_DEAD
) \

2206 (
sdev
)->
»cov”_¡©e
 = 
RECOVER_DEAD
; \

2207 
	`shªnÚ_”r
("Lš%d: Recov” faed! Insmod moduË faed. Ex™.\n", 
__LINE__
); \

2208 } 0)

	)

2210 
	#fœ¡_•og_pba
(
sdev
, 
sb
è((sb)->
mš_d©a_luns
 * (sdev)->
max_avaabË_groups
 * (sdev)->
logicbs_š_siblšg_eblock
 - (sb)->
logicbs_š_•og
)

	)

2212 
shªnÚ_wÜkqueue_¡ruù_t
 *
shªnÚ_³rıu_wq
;

2214 
Ímt_lock_š™
(
m­_bË_¡ruù
 *
Ímt
);

2215 
sdisk_m­_bË_lock_š™
(
shªnÚ_disk
 *
sdisk
);

2216 
gc_th»ad_â
(*
d©a
);

2217 
»cov”_th»ad_â
(*
d©a
);

2218 
£t_pba_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
, 
h—d_šdex
);

2219 
ş—r_pba_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun
, 
lun_pba
, 
h—d_šdex
);

2220 
‹¡_pba_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun
, 
lun_pba
);

2221 
g‘_h—d_šdex_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
);

2222 
‹¡_gc_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
);

2223 
‹¡_gc_»ad_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
);

2224 
g‘_‹m³¿tu»
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *lun_pba);

2225 
£t_‹m³¿tu»
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
, 
‹mp
);

2226 
£t_pba_Ãxt_h—d
(
shªnÚ_dev
 *
sdev
, 
lun
, 
logicb_t
 
lun_pba
, 
h—d
);

2227 
g‘_pba_Ãxt_h—d
(
shªnÚ_dev
 *
sdev
, 
lun
, 
logicb_t
 
lun_pba
);

2228 
£t_ho¡_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
Şd
);

2229 
ş—r_ho¡_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
Şd
);

2230 
‹¡_wr™e_š_´oûss
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
);

2231 
£t_v®id
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
);

2232 
£t_Şd_pba_¡®e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
);

2233 
is_¡®e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
);

2234 
pba_is_šv®id
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
);

2235 
g‘_Ãxt_sb
(
shªnÚ_dev
 *
dev
, 
h—d
);

2236 
®loc_lun_pba
(
shªnÚ_dev
 *
dev
, 
logicb64_t
 
lba
, 
h—d
, 
lun_pba
 *
pba
);

2237 
bud_d©a_¡ruù
(
shªnÚ_dev
 *
dev
);

2238 
·r™y_š™
(
shªnÚ_sb
 *
sb
, 
group_šdex
, 
µa
, 
u8
 
h—d
);

2239 
£t_ho¡_wr™e_šv®id
(
shªnÚ_dev
 *, 
lun_pba
 *);

2240 
£t_gc_wr™e_šv®id
(
shªnÚ_dev
 *, 
lun_pba
 *);

2241 
»š™Ÿlize_sb
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
);

2242 
upd©e_”a£_couÁ
(
shªnÚ_dev
 *
dev
);

2243 
subm™_gc_»ad
(
shªnÚ_dev
 *
sdev
, 
couÁ
);

2244 
b®ªû_gc
(
shªnÚ_dev
 *
sdev
, 
logicbs
);

2245 
gc_wr™e_ÿnûl
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

2246 
shªnÚ_lun_”r_checkšg_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2247 
»ad_su¥icious_bad_lun_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2248 
d©a_»‹ÁiÚ_tim”_sk
(
shªnÚ_tim”_li¡
 *
tim”
);

2249 
wl_tim”_sk
(
shªnÚ_tim”_li¡
 *
tim”
);

2250 
shªnÚ_wl_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2251 
shªnÚ_wl_»ad_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2252 
add_sb_to_ä“_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
Ãw_sb
);

2253 
»move_sb_äom_ä“_blk_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
);

2254 
put_što_wa™_cİy_li¡
(
shªnÚ_sb
 *
sb
);

2255 
shªnÚ_sb
 *
g‘_³riod_»ad_sb
(
shªnÚ_dev
 *
sdev
);

2256 
ÿn_³riod_»ad
(
shªnÚ_dev
 *
sdev
);

2257 
»š™_³riod_»ad
(
shªnÚ_dev
 *
sdev
);

2258 
³riod_»ad_’abË
(
shªnÚ_dev
 *
sdev
);

2259 
³riod_»ad_di§bË
(
shªnÚ_dev
 *
sdev
);

2260 
³riod_»ad_sb
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
);

2261 
do_Ãxt_³riod_»ad
(
shªnÚ_dev
 *
sdev
);

2262 
sbs_ş—n_³riod_»ad_dÚe
(
shªnÚ_dev
 *
sdev
);

2263 
check_”a£d_¡©e
(
shªnÚ_sb
 *
sb
);

2264 *
¡©e_Çme
(
¡©e
);

2265 
should_upd©e_miüocode
(
shªnÚ_dev
 *
sdev
);

2266 
g‘_upd©e_miüocode
(
shªnÚ_dev
 *
sdev
);

2267 
add_sb_”a£_couÁ”
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
);

2268 
shªnÚ_m­_bË_de¡roy
(
m­_bË_¡ruù
 *
Ímt
, 
to_ä“li¡
);

2269 
shªnÚ_m­_bË_»£t
(
m­_bË_¡ruù
 *
Ímt
, 
to_ä“li¡
);

2270 
upd©e_œq_d–ay_timeout
(
shªnÚ_tim”_li¡
 *
tim”
);

2271 
upd©e_œq_d–ay_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2274 
sb_m¬k_”rÜ_lun
(
shªnÚ_dev
 *, 
shªnÚ_sb
 *, , );

2275 
sb_ş—r_”rÜ_lun
(
shªnÚ_dev
 *, 
shªnÚ_sb
 *, , );

2276 
is_”rÜ_lun
(
shªnÚ_dev
 *, 
shªnÚ_sb
 *
sb
, 
lun
, 
¶ªe
);

2277 
sb_m¬k_”rÜ_lun_bad
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
);

2278 
sb_m¬k_bad_lun
(
shªnÚ_sb
 *
sb
, 
lun
);

2279 
is_bad_lun
(
shªnÚ_sb
 *
sb
, 
lun
);

2280 
is_¡©ic_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2281 
m¬k_su³r_block_bad
(
shªnÚ_sb
 *
sb
);

2282 
m¬k_sb_”r_fÜ_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
);

2283 
move_blks_to_”r_blks_li¡
(
shªnÚ_dev
 *
sdev
);

2284 
»cÜd_bad_block
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
, 
bad_eblk
);

2285 
add_bad_eblk_to_lun_bbt
(
shªnÚ_lun
 *
lun
, 
bad_eblk
);

2286 
eblk_is_bad_block
(
shªnÚ_lun
 *
lun
, 
eblk
);

2287 
is_bad_block_dev
(
shªnÚ_dev
 *
dev
, 
lun
, 
sb_šdex
);

2288 
£t_Ãw_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
);

2289 
£t_fuÎ_dyÇmic_bad_blocks
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
);

2290 
m¬k_bad_block_dev
(
shªnÚ_dev
 *
dev
, 
lun
, 
sb_šdex
);

2291 
»cov”_bad_lun_bbt
(
shªnÚ_dev
 *
sdev
, 
group_šdex
);

2292 
check_”r_blkút_šc
(
shªnÚ_dev
 *
sdev
);

2293 
check_”r_blkút_dec
(
shªnÚ_dev
 *
sdev
);

2294 
»q_is_š_aùive_chunks_¿nge
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, *
ph—d
);

2295 
£t_»ad_”rÜ_block
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

2297 
lun_»äesh_mbr_eblks_sync
(
shªnÚ_lun
 *
lun
);

2300 
£t_•og_size
(
shªnÚ_dev
 *
sdev
);

2301 
shªnÚ_»Ëa£_»bud_•ogs
(
shªnÚ_dev
 *
sdev
);

2302 
shªnÚ_»Ëa£_•ogs
(
shªnÚ_dev
 *
sdev
);

2303 
shªnÚ_®loc_•ogs
(
shªnÚ_dev
 *
sdev
);

2304 
upd©e_•og_h—d
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
);

2305 
shªnÚ_•og
 *
•og_®loc
(
size
, 
shªnÚ_dev
 *
sdev
);

2306 
sb_ä“_•og
(
shªnÚ_sb
 *
sb
);

2307 
»Ëa£_aùive_blocks_•og
(
shªnÚ_dev
 *
sdev
);

2308 
•og_£t_m‘ad©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og
 *
•og
, 
pba
, 
u64
 
m‘ad©a
);

2309 
u64
 
•og_g‘_m‘ad©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og
 *
•og
, 
pba
);

2310 *
•og_g‘_addr
(
shªnÚ_•og
 *
•og
, 
logicb_idx
, 
shªnÚ_dev
 *
sdev
);

2311 
wr™e_•og
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
h—d
);

2312 
is_fœ¡_•og_pba
(
shªnÚ_sb
 *
sb
, 
logicb_t
 
wr_off£t
);

2313 
is_•og_pba
(
shªnÚ_sb
 *
sb
, 
logicb_t
 
wr_off£t
);

2314 
is_•og_·ge_¡re
(
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
group_šdex
);

2315 
»Œ›ve_sm¬t_äom_•og_h—d
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og_h—d
 *
•og_h—d
);

2316 
»ad_•og
(
shªnÚ_sb
 *
sb
);

2317 
»cov”_ns_d©a_äom_»q
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_»que¡
 *
»q
, 
shªnÚ_dev
 *
sdev
);

2321 
__shªnÚ_wr™e_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
);

2322 
__shªnÚ_”a£_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
, 
muÉi_¶ªe
);

2323 
shªnÚ_wr™e_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
);

2324 
shªnÚ_·r™y_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
);

2325 
shªnÚ_»que¡
 *
make_·r™y_»q
(
shªnÚ_sb
 *
sb
, 
·r™y_lun
, shªnÚ_»que¡ *
wr™e
);

2326 
upd©e_lun£t_sq_h—d
(
shªnÚ_lun£t
 *
lun£t
);

2327 *
®loc_logicb_buf
(
shªnÚ_dev
 *
sdev
, 
gå_t
 
gå_mask
);

2328 
ä“_logicb_buf
(
shªnÚ_dev
 *
sdev
, *
addr
);

2329 
shªnÚ_»que¡
 *
®loc_»q
(
gå_t
);

2330 
ä“_»q
(
shªnÚ_»que¡
 *
»q
);

2331 *
İcode_Çme
(
shªnÚ_İcode
 
İcode
);

2332 
sbio_»Ëa£
(
shªnÚ_dev
 *
dev
, 
shªnÚ_bio
 *
sbio
);

2333 
®l_»q_queue_is_em±y
(
shªnÚ_dev
 *
sdev
);

2334 
gc_wr™e_queue_is_em±y
(
shªnÚ_dev
 *
sdev
);

2335 
ho¡_»q_queue_is_em±y
(
shªnÚ_dev
 *
sdev
);

2336 
shªnÚ_pick_»que¡
(
shªnÚ_dev
 *
dev
, 
lim™
);

2337 
show_pick_£m_š_debugfs
(
shªnÚ_dev
 *
sdev
);

2338 
lun£t_pick_»que¡
(
shªnÚ_lun£t
 *
lun£t
, 
lim™
);

2339 
gc_”rÜ_sb_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2340 
ho¡_»q_queue_Ëngth
(
shªnÚ_dev
 *
sdev
);

2341 
lun£t_»q_queue_is_em±y
(
shªnÚ_lun£t
 *
lun£t
);

2342 
add_»que¡_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
, 
´iÜ™y
);

2343 
add_»que¡_queue__w™hout_lock
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
, 
´iÜ™y
);

2344 
add_»q_to_gc_wr™e_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
);

2345 
add_wr™e_»q_to_»que¡_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
, 
´iÜ™y
);

2346 
add_wr™e_li¡_to_»que¡_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_li¡_h—d
 *
wr™e_li¡
, 
u32
 
»qs
, 
´iÜ™y
);

2347 
add_lun_»que¡_queue_
(
shªnÚ_lun
 *
lun
, 
shªnÚ_»que¡
 *
»q
);

2348 
add_adv_»ad_»que¡_li¡_
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

2349 
put_adv_»ad_li¡_to_lun_queue
(
shªnÚ_dev
 *
sdev
);

2350 
š™_glob®_cÚfig_»gs_fÜ_æashid
(
shªnÚ_dev
 *
dev
);

2351 
£t_avaabË_¿id_¡res
(
shªnÚ_dev
 *
sdev
);

2352 
dump_b¬_¥aû
(
shªnÚ_dev
 *
dev
);

2353 
š™_glob®_cÚfig_»gs
(
shªnÚ_dev
 *
dev
);

2354 
”a£_su³r_block
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
äom_gc
, 
Ãed_»š™
);

2355 
ÿlcuÏ‹_glob®_v¬ŸbË
(
shªnÚ_dev
 *
dev
);

2356 
£nd_dummy_»q
(
shªnÚ_dev
 *
sdev
, 
h—d
);

2357 
£nd_dummy_ov”Ïp_»q
(
shªnÚ_dev
 *
sdev
, 
ov”wr™e
);

2358 
»cov”_d©a_äom_dummy_·ge
(
shªnÚ_dev
 *
sdev
, *
addr
);

2359 
mod_gc_tim”
(
shªnÚ_dev
 *
sdev
, 
expœes
);

2360 
mod_fl_chunk_tim”
(
shªnÚ_dev
 *
sdev
, 
fl_h—d
);

2361 
mod_fl_sb_tim”
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
shªnÚ_sb
 *
sb
);

2362 
sb_fl_g¬bage_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

2363 
cİy_mbr_to_memÜy
(
shªnÚ_mbr
 *
to
, shªnÚ_mb¸*
äom
);

2364 
Œigg”_»şaim_wa™_cİy_li¡
(
shªnÚ_dev
 *
sdev
);

2365 
shªnÚ_deãr_tim”
(
shªnÚ_dev
 *
sdev
, 
expœes
);

2366 
fs_bio_»ad_ÿÎback
(
shªnÚ_bio
 *
sbio
);

2367 
fs_bio_wr™e_ÿÎback
(
shªnÚ_bio
 *
sbio
);

2368 
ÿlcuÏ‹_nÚ®igÃd_bio_u£r_couÁ
(
shªnÚ_bio
 *
sbio
, 
logicb_size
, 
fœ¡_size
);

2369 
is_cou¶e_sg
(
shªnÚ_sg_li¡_t
 *
sg
, shªnÚ_sg_li¡_ˆ*
Ãxt_sg
);

2370 
£nd_®igÃd_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
);

2371 
£nd_uÇligÃd_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
);

2372 
wr™e_»que¡_dÚe
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
);

2373 
ho¡_g‘_h—d_ªd_£t_pba_bË
(
shªnÚ_dev
 *
dev
,

2374 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio_t
 *
bio
, 
shªnÚ_»que¡
 *
»q
);

2375 
decom´ess_m‘ad©a
(
shªnÚ_»que¡
 *
»q
);

2376 
upd©e_d©a_š_dummy_·ge
(
shªnÚ_dev
 *
sdev
);

2377 
ş—r_©omic_´iÜ™ize_wr™e
(
shªnÚ_dev
 *
sdev
);

2379 
»cÜd_Ï‹ncy
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
);

2380 
shªnÚ_have_wr™‹n_ios
(
shªnÚ_dev
 *
sdev
);

2381 
shªnÚ_have_wr™‹n_m£cs
(
shªnÚ_dev
 *
sdev
);

2382 
shªnÚ_have_»ad_ios
(
shªnÚ_dev
 *
sdev
);

2383 
shªnÚ_have_»ad_m£cs
(
shªnÚ_dev
 *
sdev
);

2384 
ns_´št_Ï‹ncy_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
);

2385 
´št_Ï‹ncy_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
);

2386 
¡¬t_´št_Ï‹ncy_tim”
(
shªnÚ_disk
 *
sdisk
);

2387 
¡İ_´št_Ï‹ncy_tim”
(
shªnÚ_disk
 *
sdisk
);

2389 
upd©e_acûss_mode
(
shªnÚ_dev
 *
dev
);

2390 
shªnÚ_©ch
(
shªnÚ_dev
 *
dev
);

2391 
shªnÚ_d‘ach
(
shªnÚ_dev
 *
dev
);

2392 
upd©e_vŞge_‹m³¿tu»
(
shªnÚ_dev
 *
dev
);

2393 
u32
 
»ad_£u_šfo
(
shªnÚ_dev
 *
dev
);

2394 
sh_šü—£_u£rs
(
shªnÚ_dev
 *
dev
);

2395 
sh_deü—£_u£rs
(
shªnÚ_dev
 *
dev
);

2396 
mem£t_m­_bË
(
sÿ‰”_memblock
 *
m­_bË
);

2397 
g‘_lun_pba_äom_lba
(
logicb64_t
 
lba
, 
lun_pba
 *, *
š_ÿche
, 
shªnÚ_disk
 *);

2398 
upd©e_m­pšg_bË
(
shªnÚ_disk
 *, 
logicb64_t
 
lba
, 
u32
 
lun
, u32 
lun_pba
);

2399 
£t_lba_d©a_š_ÿche
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
);

2400 
ş—r_lba_d©a_š_ÿche
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
);

2401 
u8
 *
‹mp_bË_g‘_pos™iÚ
(
m­_bË_¡ruù
 *
Ímt
, 
logicb64_t
 
lba
);

2402 
u32
 *
m­_bË_g‘_pos™iÚ
(
m­_bË_¡ruù
 *
Ímt
, 
logicb64_t
 
lba
);

2403 
ÿlcuÏ‹_physiÿl_ÿ·c™y
(
shªnÚ_dev
 *
dev
);

2404 
check_ªd_®loc_m­bË
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
);

2405 
check_ªd_®loc_Ímt
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
logicb_shiá
);

2406 
ÿlcuÏ‹_ov”´ovisiÚ_¿‹
(
shªnÚ_dev
 *
sdev
);

2407 
lun£t_queue_d•th
(
shªnÚ_lun£t
 *
lun£t
);

2409 
	#m­_bË_d©a
(
_lun
, 
_lun_pba
è((((
u32
)(_lunè& 0x3fè<< 26è| ((_lun_pbaè& 0x3ffffff))

	)

2410 
	#‹mp_bË_d©a
(
_‹mp
, 
_lun
è((((_‹mpè& 0xfè<< 4è| (((_lunè>> 6è& 0xf))

	)

2412 
shªnÚ_bio_š_æight
(
shªnÚ_dev
 *
sdev
);

2413 
shªnÚ_have_»ad_£ùÜs
(
shªnÚ_dev
 *
sdev
);

2414 
upd©e_pow”_Ú_£cÚds
(
shªnÚ_dev
 *
sdev
);

2415 
d¿š_commªd_queue
(
shªnÚ_dev
 *
dev
, );

2416 
shªnÚ_»cÚfig
(
shªnÚ_dev
 *
sdev
);

2417 
shªnÚ_»£t
(
shªnÚ_dev
 *
sdev
);

2418 
upd©e_io_¡©i¡ics
(
shªnÚ_dev
 *
sdev
);

2419 
com¶‘e_³ndšg_»que¡
(
shªnÚ_dev
 *
sdev
);

2420 
shªnÚ_m­_bË_»size
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
logicb_shiá
);

2421 
shªnÚ_»size_m­_bË
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
logicb_shiá
);

2422 
shªnÚ_®loc_m­_bË
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
);

2423 
shªnÚ_®loc_m­_bË_ns
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
, u32 
sdev_couÁ
, u32 
¡r_size_shiá
);

2424 
shªnÚ_m­_bË_ä“
(
shªnÚ_disk
 *
sdisk
);

2425 
shªnÚ_m­_bË_ä“_ns
(
shªnÚ_disk
 *
sdisk
);

2426 
shªnÚ_memblock_poŞ_add
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
);

2427 
shªnÚ_memblock_poŞ_ş—r
(
shªnÚ_memblock_poŞ
 *
mpoŞ
);

2428 
add_to_memblock_ä“li¡
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u8
 *
addr
);

2429 
shªnÚ_memblock_poŞ_šc_maxt
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
);

2430 
shªnÚ_memblock_poŞ_dec_maxt
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
);

2431 
shªnÚ_memblock_poŞ_dec_maxt_by_út
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
couÁ
);

2432 
shªnÚ_š™_blk_queue
(
shªnÚ_dev
 *
sdev
);

2433 
shªnÚ_m­_bË_ş—r
(
m­_bË_¡ruù
 *
Ímt
);

2434 
shªnÚ_m­_bË_di§bË
(
m­_bË_¡ruù
 *
Ímt
);

2435 
shªnÚ_m­_bË_’abË
(
m­_bË_¡ruù
 *
Ímt
);

2436 
sdev_m­_bË_’abË
(
shªnÚ_dev
 *
sdev
);

2437 
»Ëa£_sdev_m­_bË
(
shªnÚ_dev
 *
sdev
);

2439 
shªnÚ_nÜæash_”a£
(
shªnÚ_dev
 *
sdev
, 
u32
 
¡¬t
, u32 
Ëngth
);

2440 
shªnÚ_nÜæash_wr™e
(
shªnÚ_dev
 *
sdev
, 
u32
 
¡¬t
, u32 
Ëngth
, *
d©a
);

2441 
shªnÚ_nÜæash_»ad
(
shªnÚ_dev
 *
sdev
, 
u32
 
¡¬t
, u32 
Ëngth
, *
d©a
);

2442 
»ad_nÜæash_šfo
(
shªnÚ_dev
 *
sdev
);

2443 
hªdË_wa™_pick_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

2444 
shªnÚ_pci_»£t_´•¬e
(
shªnÚ_pci_dev_t
 *
pdev
);

2445 
shªnÚ_pci_»£t_fšished
(
shªnÚ_pci_dev_t
 *
pdev
);

2447 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

2448 
šlše
 
u32
 
	$»ad_»g_§ã
(
shªnÚ_dev
 *
sdev
, 
u32
 *
addr
)

2450  *
addr
;

2451 
	}
}

2453 
šlše
 
	$wr™e_»g_§ã
(
shªnÚ_dev
 *
sdev
, 
u32
 
v®ue
, u32 *
addr
)

2455 *
addr
 = 
v®ue
;

2456 
	}
}

2458 
šlše
 
u32
 
	$»ad_»g_§ã
(
shªnÚ_dev
 *
sdev
, cÚ¡ vŞ©
__iomem
 *
addr
)

2460 
u32
 
v®ue
;

2462 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

2463 
v®ue
 = 
	`shªnÚ_»adl
(
addr
);

2464 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

2466  
v®ue
;

2467 
	}
}

2469 
šlše
 
	$wr™e_»g_§ã
(
shªnÚ_dev
 *
sdev
, 
u32
 
v®ue
, vŞ©
__iomem
 *
addr
)

2471 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

2472 
	`shªnÚ_wr™–
(
v®ue
, 
addr
);

2473 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

2474 
	}
}

2477 
šlše
 
u32
 
	$»ad_¿w_»g_§ã
(
shªnÚ_dev
 *
sdev
, cÚ¡ vŞ©
__iomem
 *
addr
)

2479 
u32
 
v®ue
;

2481 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

2482 
v®ue
 = 
	`shªnÚ_¿w_»adl
(
addr
);

2483 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

2485  
v®ue
;

2486 
	}
}

2488 
šlše
 
	$wr™e_¿w_»g_§ã
(
shªnÚ_dev
 *
sdev
, 
u32
 
v®ue
, vŞ©
__iomem
 *
addr
)

2490 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

2491 
	`shªnÚ_¿w_wr™–
(
v®ue
, 
addr
);

2492 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

2493 
	}
}

2496 
cİy_poŞ_šfo
(
shªnÚ_poŞ_šfo
 *
to
, shªnÚ_poŞ_šfØ*
äom
);

2497 
sh_šü—£_u£rs_ns
(
shªnÚ_Çme¥aû
 *);

2498 
sh_deü—£_u£rs_ns
(
shªnÚ_Çme¥aû
 *);

2499 
š™_sdev_š_poŞ
(
shªnÚ_dev
 *
sdev
);

2500 
»Ëa£_poŞ_¡ruù
(
shªnÚ_poŞ
 *
¥oŞ
);

2501 
ü—‹_poŞ
(
¬g
);

2502 
»cov”_poŞ_šfo
(
shªnÚ_poŞ
 *
¥oŞ
, *
±r
);

2503 
shªnÚ_©ch_ns
(
shªnÚ_Çme¥aû
 *
ns
);

2504 
shªnÚ_d‘ach_ns
(
shªnÚ_Çme¥aû
 *
ns
);

2505 
shªnÚ_poŞ_©ch
(
shªnÚ_poŞ
 *
¥oŞ
);

2506 
shªnÚ_poŞ_d‘ach
(
shªnÚ_poŞ
 *
¥oŞ
);

2507 
š™_Çme¥aûs
(
shªnÚ_poŞ
 *
¥oŞ
);

2508 
shªnÚ_bio_š_æight_ns
(
shªnÚ_Çme¥aû
 *
ns
);

2509 
check_¥aû_u§ge
(
shªnÚ_dev
 *
sdev
);

2510 
£t_poŞ_h¬d_queue_lim™
(
shªnÚ_poŞ
 *
¥
, );

2511 
¥oŞ_upd©e_acûss_mode
(
shªnÚ_poŞ
 *
¥oŞ
);

2512 
ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
shªnÚ_poŞ
 *
¥oŞ
);

2513 
__£t_poŞ_ov”´ovisiÚ
(
shªnÚ_poŞ
 *
¥oŞ
, 
İ
);

2514 
£t_poŞ_ov”´ovisiÚ
(
shªnÚ_poŞ
 *
¥oŞ
, 
İ
);

2515 
check_sbio_is_ov”wr™ed
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_Çme¥aû
 *
ns
);

2516 
shªnÚ_Çme¥aû
 *
ns_g‘_»ã»nû
(shannon_namespace *);

2517 
ns_put_»ã»nû
(
shªnÚ_Çme¥aû
 *
ns
);

2518 
shªnÚ_poŞ
 *
¥oŞ_g‘_»ã»nû
(shannon_pool *);

2519 
¥oŞ_put_»ã»nû
(
shªnÚ_poŞ
 *);

2520 
upd©e_poŞ_šfo
(
shªnÚ_poŞ
 *
¥oŞ
);

2521 
ns_upd©e_io_¡©i¡ics
(
shªnÚ_Çme¥aû
 *
ns
);

2522 
upd©e_ns_d©a
(
shªnÚ_Çme¥aû
 *
ns
);

2523 
cİy_ns_d©a
(
shªnÚ_ns_d©a
 *
to
, shªnÚ_ns_d©¨*
äom
);

2525 
šlše
 
	$put_¥oŞ_ªd_ns
(
shªnÚ_poŞ
 *
¥oŞ
, 
shªnÚ_Çme¥aû
 *
ns
)

2527 ià(
¥oŞ
) {

2528 ià(
ns
)

2529 
	`ns_put_»ã»nû
(
ns
);

2530 
	`¥oŞ_put_»ã»nû
(
¥oŞ
);

2532 
	}
}

2535 
šlše
 
	$check_¡©us
(
¡©us
)

2537  (
¡©us
 & 0x41) != 0x40;

2538 
	}
}

2540 
šlše
 
	$check_cmd_timeout
(
¡©us
)

2542  (
¡©us
 == 0xFE);

2543 
	}
}

2546 
shªnÚ_š™_h¬dw¬e_g4
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_pci_dev_t
 *
pdev
);

2547 
chªge_š‹¼u±_što_msi_mode
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
);

2548 
shªnÚ_di§bË_msi
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
);

2549 
lun_£t_ã©u»_g’”®_g4
(
shªnÚ_dev
 *
sdev
, 
ã©u»_cfg
 *
cfg
);

2550 
shªnÚ_nÜæash_”a£_g4
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
);

2551 
shªnÚ_nÜæash_wr™e_g4
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
);

2552 
shªnÚ_nÜæash_»ad_g4
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
, u32 
xãr_size
);

2553 
»ad_bbt_šfo_g4
(
shªnÚ_dev
 *
sdev
);

2554 
ª®yze_bbt_šfo_g4
(
shªnÚ_dev
 *
sdev
);

2555 
upd©e_poŞ_šfo_g4
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_poŞ
 *
¥oŞ
);

2558 
	#NOR_PAGE_SIZE
 4096

	)

2559 
nÜæash_»ad_š_4k_mode
(
shªnÚ_dev
 *
sdev
, 
u32
 
addr
, u32 
Ëngth
, *
d©a
);

2560 
nÜæash_wr™e_š_4k_mode
(
shªnÚ_dev
 *
sdev
, 
u32
 
addr
, u32 
Ëngth
, *
d©a
);

2561 
g‘_nÜ_·ge_šdex
(
shªnÚ_dev
 *
sdev
);

2562 
shªnÚ_š™_h¬dw¬e_g5
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_pci_dev_t
 *
pdev
);

2563 
g‘_mbr_äom_nÜ
(
shªnÚ_dev
 *
sdev
);

2564 
com¶‘iÚ_pŞl_g5
(
shªnÚ_dev
 *
dev
, 
dwÜd_šdex
);

2565 
hªdË_com¶‘iÚ_skËt_g5
(
shªnÚ_š‹¼u±_¬g
 *
š‹r_¬g
);

2566 
chªge_š‹¼u±_što_msix_mode
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
);

2567 
shªnÚ_di§bË_msix
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
);

2568 
shªnÚ_nÜæash_”a£_g5
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
);

2569 
shªnÚ_nÜæash_wr™e_g5
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
);

2570 
shªnÚ_nÜæash_»ad_g5
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
);

2571 
£t_ecc_Ügªiz©iÚ
(
shªnÚ_dev
 *
sdev
);

2572 
»ad_bbt_šfo_g5
(
shªnÚ_dev
 *
sdev
);

2573 
ª®yze_bbt_šfo_g5
(
shªnÚ_dev
 *
sdev
);

2574 
»äesh_mbr_g5
(
shªnÚ_dev
 *
sdev
, 
ş—n_poŞ
);

2575 
shªnÚ_£t_ù¾_·¿m
(
shªnÚ_dev
 *
sdev
);

2576 
»ad_poŞ_šfo_g5
(
shªnÚ_dev
 *
sdev
);

2577 
upd©e_nÜ_šdex_node
(
shªnÚ_dev
 *
sdev
);

2578 
upd©e_poŞ_šfo_g5
(
shªnÚ_dev
 *
sdev
, 
ş—n_poŞ
);

2579 
ş—n_poŞ_šfo_g5
(
shªnÚ_dev
 *
sdev
);

2580 
shªnÚ_pŞlšg_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
, 
logicb_t
 
lun_pba
, 
u8
 
©Œ
, u8 
h—d
);

2581 
do_¢­_»ad
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
fœ¡_»q
, 
¶ªes
);

2582 
¢­_»ad_di§bË
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_lun
 *
lun
, 
fÜû
, 
has_lock
);

2583 
g‘_codewÜd_addr
(
shªnÚ_dev
 *
sdev
, 
£ùÜ_šdex
);

2584 
g‘_£ùÜs_couÁ
(
shªnÚ_dev
 *
sdev
, 
£ùÜ_šdex
);

2585 
®loc_bbt_nÜ_¡ruùu»
(
shªnÚ_dev
 *
sdev
);

2586 
»Ëa£_bbt_nÜ_¡ruùu»
(
shªnÚ_dev
 *
sdev
);

2587 
v’dÜ_mode_cmd_£qu’û
(
shªnÚ_dev
 *
sdev
);

2588 
Ãed_v’dÜ_mode_cmd
(
shªnÚ_dev
 *
sdev
);

2591 
shªnÚ_´eãtch_š™
(
shªnÚ_´eãtch
 *
´eãtch
, 
u32
 
logicb_size
);

2592 
shªnÚ_´eãtch_de¡roy
(
shªnÚ_´eãtch
 *
´eãtch
);

2593 
g‘_lba_d©a_äom_ÿche
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
);

2594 
´eãtch_check
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
);

2595 
šü—£_ÿche_miss
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
);

2596 
drİ_®l_ÿche_lše
(
shªnÚ_dev
 *
sdev
);

2597 
add_»q_to_´eãtch_li¡
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
);

2598 
´eãtch_th»ad_â
(*
d©a
);

2601 
bufq_queue_d•th
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
);

2602 
bufq_Œaffic_jam
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
);

2605 #ifdeà
CONFIG_SHANNON_DEBUG


2606 
add_to_gc_¡©e_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
);

2607 
»cÜd_pba_bË
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
lun
);

2608 
»move_äom_gc_¡©e_li¡
(
shªnÚ_sb
 *
sb
);

2609 
»Ëa£_blocks_gc_¡©e
(
shªnÚ_dev
 *
sdev
);

2610 
wr™e_chunk_is_v®id
(
shªnÚ_»que¡
 *
»q
, 
shªnÚ_dev
 *
sdev
);

2611 
£t_»q_debug_g
(
shªnÚ_»que¡
 *, , );

2612 
dump_®l_blocks
(
shªnÚ_dev
 *
dev
);

2613 
shªnÚ_debugfs_š™
(
shªnÚ_dev
 *
dev
);

2614 
shªnÚ_debugfs_ş—nup
(
shªnÚ_dev
 *);

2615 
check_v®id_·ges
(
shªnÚ_dev
 *
dev
, 
sb_šdex
);

2616 
add_to_gc_¡©e_li¡
(
shªnÚ_dev
 *, 
shªnÚ_sb
 *);

2618 
šlše
 
	$add_to_gc_¡©e_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
){
	}
}

2619 
šlše
 
	$»cÜd_pba_bË
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
lun
){
	}
}

2620 
šlše
 
	$»move_äom_gc_¡©e_li¡
(
shªnÚ_sb
 *
sb
){
	}
}

2621 
šlše
 
	$»Ëa£_blocks_gc_¡©e
(
shªnÚ_dev
 *
sdev
){
	}
}

2622 
šlše
 
	$wr™e_chunk_is_v®id
(
shªnÚ_»que¡
 *
»q
, 
shªnÚ_dev
 *
sdev
){ 1;
	}
}

2623 
šlše
 
	$£t_»q_debug_g
(
shªnÚ_»que¡
 *
»q
, 
g
, 
i
){
	}
}

2624 
šlše
 
	$dump_®l_blocks
(
shªnÚ_dev
 *
dev
){
	}
}

2625 
šlše
 
	$shªnÚ_debugfs_š™
(
shªnÚ_dev
 *
dev
){ 0;
	}
}

2626 
šlše
 
	$shªnÚ_debugfs_ş—nup
(){
	}
}

2627 
šlše
 
	$check_v®id_·ges
(
shªnÚ_dev
 *
dev
, 
sb_šdex
è{
	}
}

2630 #ifdeà
CONFIG_SHANNON_DEBUG_CDEV


2631 
bufq_commªd_cdev_š™
(
shªnÚ_dev
 *
dev
);

2632 
bufq_commªd_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
);

2633 
commªd_cdev_š™
(
shªnÚ_dev
 *
dev
);

2634 
commªd_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
);

2635 
com¶‘iÚ_cdev_š™
(
shªnÚ_dev
 *
dev
);

2636 
com¶‘iÚ_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
);

2637 
pba_bË_cdev_š™
(
shªnÚ_dev
 *
dev
, 
pba_bË_size
);

2638 
pba_bË_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
);

2639 
Ímt_cdev_š™
(
shªnÚ_disk
 *
sdisk
);

2640 
Ímt_cdev_ex™
(
shªnÚ_disk
 *
sdisk
);

2641 
‹mp_bË_cdev_š™
(
shªnÚ_disk
 *
sdisk
);

2642 
‹mp_bË_cdev_ex™
(
shªnÚ_disk
 *
sdisk
);

2643 
•og_cdev_š™
(
shªnÚ_dev
 *
dev
);

2644 
•og_cdev_ex™
(
shªnÚ_dev
 *
dev
);

2645 
cİy_•og_buf
(
shªnÚ_dev
 *
dev
, 
sb_šdex
, 
shªnÚ_•og
 *
•og
);

2647 
šlše
 
	$bufq_commªd_cdev_š™
(
shªnÚ_dev
 *
dev
){ 0;
	}
}

2648 
šlše
 
	$bufq_commªd_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
){
	}
}

2649 
šlše
 
	$commªd_cdev_š™
(
shªnÚ_dev
 *
dev
){ 0;
	}
}

2650 
šlše
 
	$commªd_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
){
	}
}

2651 
šlše
 
	$com¶‘iÚ_cdev_š™
(
shªnÚ_dev
 *
dev
){ 0;
	}
}

2652 
šlše
 
	$com¶‘iÚ_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
){
	}
}

2653 
šlše
 
	$pba_bË_cdev_š™
(
shªnÚ_dev
 *
dev
, 
pba_bË_size
){ 0;
	}
}

2654 
šlše
 
	$pba_bË_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
){
	}
}

2655 
šlše
 
	$Ímt_cdev_š™
(
shªnÚ_disk
 *
sdisk
){ 0;
	}
}

2656 
šlše
 
	$Ímt_cdev_ex™
(
shªnÚ_disk
 *
sdisk
){
	}
}

2657 
šlše
 
	$‹mp_bË_cdev_š™
(
shªnÚ_disk
 *
sdisk
){ 0;
	}
}

2658 
šlše
 
	$‹mp_bË_cdev_ex™
(
shªnÚ_disk
 *
sdisk
){
	}
}

2659 
šlše
 
	$•og_cdev_š™
(
shªnÚ_dev
 *
dev
){ 0;
	}
}

2660 
šlše
 
	$•og_cdev_ex™
(
shªnÚ_dev
 *
dev
){
	}
}

2661 
šlše
 
	$cİy_•og_buf
(
shªnÚ_dev
 *
dev
, 
sb_šdex
, 
shªnÚ_•og
 *
•og
è{
	}
}

2664 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


2665 
m¬k_çke_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2666 
is_çke_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2667 
m¬k_çke_cmd_timeout_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2668 
is_çke_cmd_timeout_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2669 
m¬k_çke_rd_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2670 
is_çke_rd_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
);

2671 
m¬k_çke_wr_bad_luÅ·
(
shªnÚ_dev
 *
sdev
, 
lun
, 
µa
);

2672 
is_çke_wr_bad_luÅ·
(
shªnÚ_dev
 *
sdev
, 
lun
, 
µa
);

2673 
m¬k_çke_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
);

2674 
is_çke_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
);

2675 
m¬k_çke_rd_bad_luÅba_¿idmu‹x
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
);

2676 
m¬k_çke_”_bad_block
(
shªnÚ_dev
 *
sdev
, 
lun
, 
blk
);

2677 
is_çke_”_bad_block
(
shªnÚ_dev
 *
sdev
, 
lun
, 
blk
);

2678 
m¬k_çke_twš_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
, 
h—d_šdex
);

2679 
is_çke_twš_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
, 
h—d_šdex
);

2680 
upd©e_çke_·‰”n
(
shªnÚ_dev
 *
sdev
, 
Ãxt_sb
, 
h—d_šdex
);

2683 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

2684 
	~"shªnÚ_emu.h
"

2686 
	#MAX_LOGICBS_IN_PAGE
 16

	)

2688 
emu_lun_amouÁ
;

2689 
emu_eblocks_š_lun
;

2690 
emu_·ges_š_eblock
;

2691 
emu_Çnd_·ge_shiá
;

2692 
emu_oob_size
;

2693 
emu_¶ªe_Üd”
;

2694 
emu_logicb_shiá
;

2695 
emu_logicbs_š_·ge
;

2696 
emu_chªÃls
;

2698 
shªnÚ_emu_lun
 *
emu_luns
;

2702 
	#__echo_š
 
	`debugs0
("’‹r.\n")

	)

2703 
	#__echo_out
 
	`debugs0
("ex™.\n")

	)

2705 
	#__echo_š


	)

2706 
	#__echo_out


	)

	@shannon.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/comp”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
ş—nup_moduË
,

16 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

17 
__©Œibu‹_u£d__


18 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

197 cÚ¡ 
	g__moduË_d•’ds
[]

198 
__©Œibu‹_u£d__


199 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

202 
MODULE_ALIAS
("pci:v000010EEd00006024sv*sd*bc*sc*i*");

203 
MODULE_ALIAS
("pci:v00001CB0d00000265sv*sd*bc*sc*i*");

204 
MODULE_ALIAS
("pci:v00001CB0d00000275sv*sd*bc*sc*i*");

205 
MODULE_ALIAS
("pci:v00001CB0d00001275sv*sd*bc*sc*i*");

206 
MODULE_ALIAS
("pci:v00001CB0d00002275sv*sd*bc*sc*i*");

207 
MODULE_ALIAS
("pci:v00001CB0d00001285sv*sd*bc*sc*i*");

208 
MODULE_ALIAS
("pci:v00001CB0d00003275sv*sd*bc*sc*i*");

209 
MODULE_ALIAS
("pci:v00001CB0d000025A5sv*sd*bc*sc*i*");

210 
MODULE_ALIAS
("pci:v00001CB0d000035A5sv*sd*bc*sc*i*");

212 
MODULE_INFO
(
¤cv”siÚ
, "D4A115C74483EA220837F66");

	@shannon_512.c

2 
lba_li¡
 *
	$®loc_lba_li¡
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
)

4 
lba_li¡
 *lba_list;

5 
»Œy
:

6 
lba_li¡
 = 
	`shªnÚ_kz®loc
((*lba_li¡), 
GFP_ATOMIC
);

7 ià(
lba_li¡
 =ğ
NULL
) {

8 
	`shªnÚ_w¬n
("allocate‚ew†ba_list failed.\n");

9 
»Œy
;

11 
	`SHANNON_INIT_LIST_HEAD
(&
lba_li¡
->
li¡
);

12 
	`SHANNON_INIT_LIST_HEAD
(&
lba_li¡
->
»q_li¡
);

13 
	`SHANNON_INIT_LIST_HEAD
(&
lba_li¡
->
wa™_li¡
);

14 
lba_li¡
->
sdisk
 = sdisk;

15 
lba_li¡
->
lba
 =†ba;

16 
lba_li¡
->
¡©us
 = 
LBA_READING
;

17 
	`shªnÚ_¥š_lock_š™
(&
lba_li¡
->
lba_lock
);

18  
lba_li¡
;

19 
	}
}

21 
	$ä“_lba_li¡
(
lba_li¡
 *lba_list)

23 
	`BUG_ON
(
lba_li¡
 =ğ
NULL
);

24 
	`shªnÚ_kä“
(
lba_li¡
);

25 
	}
}

27 
	$as£mbË_rc_»ad_»q_ÿÎback
(
shªnÚ_bio
 *
sbio
)

29 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

30 
lba_li¡
 *lba_li¡ = (lba_li¡ *)
sbio
->
d©a2
;

31 
shªnÚ_disk
 *
sdisk
 = 
lba_li¡
->sdisk;

32 
shªnÚ_»que¡
 *
»q
, *
p
, *
tmp
;

33 
off£t
, 
šdex
 = 
lba_li¡
->
lba
 % 
RMW_LIST_COUNT
;

35 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
rmw_li¡_lock
[
RMW_READ
][
šdex
]);

36 
	`shªnÚ_li¡_d–_š™
(&
lba_li¡
->
li¡
);

37 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
rmw_li¡_lock
[
RMW_READ
][
šdex
]);

39 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

40 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

41 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

42 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

43 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

44 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

45 
»q
->
»cov”_buf
 = 
NULL
;

47 ià(
	`uÆik–y
(
sbio
->
¡©us
))

48 
	`shªnÚ_šfo
("%s():†ba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n",

49 
__func__
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

51 
	`shªnÚ_¥š_lock_bh
(&
lba_li¡
->
lba_lock
);

52 
lba_li¡
->
¡©us
 = 
LBA_LOCKED
;

53 
	`shªnÚ_¥š_uÆock_bh
(&
lba_li¡
->
lba_lock
);

54 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, &
lba_li¡
->
»q_li¡
, 
li¡
) {

55 
	`shªnÚ_li¡_d–_š™
(&
p
->
li¡
);

56 
p
->
_ecc
 = 
»q
->_ecc;

57 
p
->
sbio
->
¡©us
 |= sbio->status;

58 
off£t
 = 
p
->
¡¬t_off£t
 % 
sdev
->
logicb_size
;

59 
	`shªnÚ_memıy
(
p
->
vœt_addr
, 
»q
->vœt_add¸+ 
off£t
,…->
Ëngth
);

60 
	`sbio_»Ëa£
(
sdev
, 
p
->
sbio
);

62 
	`ä“_lba_li¡
(
lba_li¡
);

63 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

64 
	`ä“_»q
(
»q
);

65 
	`ä“_sbio
(
sbio
);

66 
	}
}

68 
	$as£mbË_rc_»ad_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
lba_li¡
 *lba_list)

70 
shªnÚ_bio
 *
sbio
;

71 
shªnÚ_»que¡
 *
»q
;

72 
shªnÚ_sb
 *
sb
;

73 
lun
, 
»t
, 
š_ÿche
;

75 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

76 
sbio
->
d©a
 = 
sdev
;

77 
sbio
->
d©a2
 = 
lba_li¡
;

78 
	`£t_sbio_debug_g
(
sbio
, 
ASSEMBLE_READ_TAG
);

79 
sbio
->
ÿÎback
 = 
as£mbË_rc_»ad_»q_ÿÎback
;

80 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

82 
sbio
->
logicbs
 = 1;

83 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

84 
sbio
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

85 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

87 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

88 
	`£t_»q_debug_g
(
»q
, 
ASSEMBLE_READ_TAG
, 0);

89 
»q
->
sbio
 = sbio;

90 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

91 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

92 
»q
->
£nd”
 = 
FROM_HOST
;

93 
»q
->
İcode
 = 
sh_cmd_»ad
;

94 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

95 
»q
->
ns_id
 = 
lba_li¡
->ns_id;

96 
»q
->
ns_£q_num
 = 
lba_li¡
->ns_seq_num;

97 
»q
->
lba
 = 
lba_li¡
->lba;

98 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

99 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

100 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

101 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

102 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, &
š_ÿche
, 
sdisk
);

103 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

104 
lba_li¡
->
pba
.
lun
 = 
»q
->pba.lun;

105 
lba_li¡
->
pba
.
lun_pba
 = 
»q
->pba.lun_pba;

106 ià(
»t
 < 0) {

107 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0,„eq->
Ëngth
);

108 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

110 } ià(
š_ÿche
) {

111 ià(
	`add_»q_to_´eãtch_li¡
(
sdisk
, 
»q
)) {

112 
	`shªnÚ_wake_up_´oûss
(
sdev
->
´eãtch_th»ad
);

116 
	`šü—£_ÿche_miss
(
sdisk
, 
»q
);

117 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

118 
»q
->
£q_num
 = 
sb
->seq_num;

119 
lun
 = 
»q
->
pba
.lun;

120 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

121 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, 1);

124 
	}
}

126 
as£mbË_rmw_»ad_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
lba_li¡
 *lba_list);

127 
»£nd_as£mbË_rmw_»ad_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
);

128 
	$as£mbË_rmw_wr™e_»q_ÿÎback
(
shªnÚ_bio
 *
sbio
)

130 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

131 
lba_li¡
 *lba_li¡ = (lba_li¡ *)
sbio
->
d©a2
;

132 
shªnÚ_disk
 *
sdisk
 = 
lba_li¡
->sdisk;

133 
shªnÚ_sb
 *
sb
;

134 
shªnÚ_»que¡
 *
»q
, *
p
, *
tmp
;

135 
lun_pba
 
pba
;

136 
šdex
 = 
lba_li¡
->
lba
 % 
RMW_LIST_COUNT
;

138 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

139 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

140 
»q
->
¡©e
 = 
REQ_CALLBACK
;

141 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

142 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

143 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

144 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

145 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
pba
, 
NULL
, 
sdisk
);

146 ià((
»q
->
Şd_pba
.
lun
 !ğ
pba
.lunè|| (»q->Şd_pba.
lun_pba
 !=…ba.lun_pba)) {

148 
	`debugs1
("lba=%ld is overlapped, old:lun=%d,†un_pba=%d,‚ew:lun=%d,lun_pba=%d.\n",

149 
»q
->
lba
,„eq->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
, 
pba
.lun,…ba.lun_pba);

151 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

152 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

154 
	`shªnÚ_”r
("assemble_rmw_write_req: sbio->status=0x%x,†ba=%d,†un=%d,†un_pba=%d.\n", \

155 
sbio
->
¡©us
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

156 
	`shªnÚ_©omic_sub
(1, &
sb
->
š_wr™e_logicbs
);

159 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, &
lba_li¡
->
»q_li¡
, 
li¡
) {

160 
	`shªnÚ_li¡_d–_š™
(&
p
->
li¡
);

161 
p
->
sbio
->
¡©us
 |= sbio->status;

162 
p
->
¡©e
 = 
REQ_DONE
;

163 ià(
	`is_wa™_pick_»q
(
p
))

164 
	`hªdË_wa™_pick_»q
(
sdev
, 
p
);

165 
	`sbio_»Ëa£
(
sdev
, 
p
->
sbio
);

167 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

168 
	`ä“_»q
(
»q
);

169 
	`ä“_sbio
(
sbio
);

171 ià(
	`shªnÚ_li¡_em±y
(&
lba_li¡
->
wa™_li¡
)) {

172 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
rmw_li¡_lock
[
RMW_WRITE
][
šdex
]);

173 
	`shªnÚ_¥š_lock_bh
(&
lba_li¡
->
lba_lock
);

174 ià(
	`shªnÚ_li¡_em±y
(&
lba_li¡
->
wa™_li¡
))

175 
	`shªnÚ_li¡_d–_š™
(&
lba_li¡
->
li¡
);

176 
	`shªnÚ_¥š_uÆock_bh
(&
lba_li¡
->
lba_lock
);

177 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
rmw_li¡_lock
[
RMW_WRITE
][
šdex
]);

179 ià(!
	`shªnÚ_li¡_em±y
(&
lba_li¡
->
wa™_li¡
)) {

180 
	`shªnÚ_¥š_lock_bh
(&
lba_li¡
->
lba_lock
);

181 
	`shªnÚ_li¡_add_
(&
lba_li¡
->
»q_li¡
, &lba_li¡->
wa™_li¡
);

182 
	`shªnÚ_li¡_d–_š™
(&
lba_li¡
->
wa™_li¡
);

183 
lba_li¡
->
¡©us
 = 
LBA_READING
;

184 
	`shªnÚ_¥š_uÆock_bh
(&
lba_li¡
->
lba_lock
);

185 
	`as£mbË_rmw_»ad_»q
(
sdev
, 
sdisk
, 
lba_li¡
);

187 
	`ä“_lba_li¡
(
lba_li¡
);

188 
	}
}

190 
	$as£mbË_rmw_modify_»q_ÿÎback
(
shªnÚ_bio
 *
sbio
)

192 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

193 
lba_li¡
 *lba_li¡ = (lba_li¡ *)
sbio
->
d©a2
;

194 
shªnÚ_disk
 *
sdisk
 = 
lba_li¡
->sdisk;

195 
shªnÚ_»que¡
 *
»q
, *
p
, *
tmp
;

196 
off£t
, 
fl_h—d
 = 0, 
»t
;

198 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
)

199 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 10);

201 
	`shªnÚ_¥š_lock_bh
(&
lba_li¡
->
lba_lock
);

202 
lba_li¡
->
¡©us
 = 
LBA_LOCKED
;

203 
	`shªnÚ_¥š_uÆock_bh
(&
lba_li¡
->
lba_lock
);

205 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

206 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

207 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

208 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

209 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

210 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

211 
»q
->
»cov”_buf
 = 
NULL
;

213 ià(
	`uÆik–y
(
sbio
->
¡©us
))

214 
	`shªnÚ_šfo
("%s():†ba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n",

215 
__func__
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

217 
»q
->
¡©e
 = 
REQ_CALLBACK
;

219 ià(
	`uÆik–y
(
sdev
->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
))) {

221 
»q
->
¡©e
 = 
REQ_DONE
;

222 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

223 
ä“
;

226 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
lba_li¡
->
»q_li¡
, 
li¡
) {

227 
off£t
 = 
p
->
¡¬t_off£t
 % 
sdev
->
logicb_size
;

228 
	`shªnÚ_memıy
(
»q
->
vœt_addr
 + 
off£t
, 
p
->vœt_addr,…->
Ëngth
);

231 
sbio
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

232 
sbio
->
ÿÎback
 = 
as£mbË_rmw_wr™e_»q_ÿÎback
;

233 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

234 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

235 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
 * sbio->
logicbs
, 
SHANNON_DMA_TODEVICE
);

236 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

237 
	`shªnÚ_w¬n
("shannon_dma_map_singleƒrror.\n");

238 
	`»£nd_as£mbË_rmw_»ad_»q
(
sdev
, 
sdisk
, 
sbio
);

242 
»q
->
İcode
 = 
sh_cmd_wr™e
;

243 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

244 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

245 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

246 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

247 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

248 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
Şd_pba
, 
NULL
, 
sdisk
);

249 ià((
»q
->
Şd_pba
.
lun
 !ğ»q->
pba
.lunè|| (»q->Şd_pba.
lun_pba
 !=„eq->pba.lun_pba)) {

250 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

251 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sbio->
logicbs
 * sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

252 
	`shªnÚ_šfo
("%s():‚s_id=%d,†ba=0x%lx,†un=%d,†un_pba=0x%x.†pmt:lun=%d,†un_pba=0x%x.\n",

253 
__func__
, 
lba_li¡
->
ns_id
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,

254 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
);

255 ià(
»t
 == 0) {

256 
shªnÚ_sb
 *
sb
;

257 
sb
 = 
sdev
->
sbs
 + 
»q
->
Şd_pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

258 
	`shªnÚ_šfo
("%s():‚s_id=%d,†ba=0x%lx,„eq->seq_num=%ld,†pmt: sb->seq_num=%ld.\n",

259 
__func__
, 
lba_li¡
->
ns_id
, 
»q
->
lba
,„eq->
£q_num
, 
sb
->seq_num);

261 
	`»£nd_as£mbË_rmw_»ad_»q
(
sdev
, 
sdisk
, 
sbio
);

264 
	`ho¡_g‘_h—d_ªd_£t_pba_bË
(
sdev
, 
sdisk
, 
sbio
->
bio
, 
»q
);

265 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

267 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

269 #ifdeà
CONFIG_SHANNON_STATISTICS


270 
	`shªnÚ_©omic_add
(
sbio
->
logicbs
, &
sdev
->
äom_ho¡
);

272 ià((
»q
->
h—d
 & 
HEAD_INDEX_MASK
è=ğ
HOT_INDEX
)

273 
fl_h—d
 |ğ1 << 
HOT_INDEX
;

275 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


276 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

278 
fl_h—d
 |ğ1 << 
COLD_INDEX
;

280 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 
sdisk
->
´iÜ™y
);

281 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

282 
	`mod_fl_chunk_tim”
(
sdev
, 
fl_h—d
);

283 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
) {

284 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 4);

288 
ä“
:

289 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
p
, 
tmp
, &
lba_li¡
->
»q_li¡
, 
li¡
) {

290 
	`shªnÚ_li¡_d–_š™
(&
p
->
li¡
);

291 
p
->
sbio
->
¡©us
 |= sbio->status;

292 
p
->
¡©e
 = 
REQ_DONE
;

293 
	`sbio_»Ëa£
(
sdev
, 
p
->
sbio
);

295 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

296 
	`ä“_»q
(
»q
);

297 
	`ä“_sbio
(
sbio
);

299 ià(
	`shªnÚ_li¡_em±y
(&
lba_li¡
->
wa™_li¡
)) {

300 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
rmw_li¡_lock
[
RMW_WRITE
][
lba_li¡
->
lba
 % 
RMW_LIST_COUNT
]);

301 
	`shªnÚ_¥š_lock_bh
(&
lba_li¡
->
lba_lock
);

302 ià(
	`shªnÚ_li¡_em±y
(&
lba_li¡
->
wa™_li¡
))

303 
	`shªnÚ_li¡_d–_š™
(&
lba_li¡
->
li¡
);

304 
	`shªnÚ_¥š_uÆock_bh
(&
lba_li¡
->
lba_lock
);

305 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
rmw_li¡_lock
[
RMW_WRITE
][
lba_li¡
->
lba
 % 
RMW_LIST_COUNT
]);

307 ià(!
	`shªnÚ_li¡_em±y
(&
lba_li¡
->
wa™_li¡
)) {

308 
	`shªnÚ_¥š_lock_bh
(&
lba_li¡
->
lba_lock
);

309 
	`shªnÚ_li¡_add_
(&
lba_li¡
->
»q_li¡
, &lba_li¡->
wa™_li¡
);

310 
	`shªnÚ_li¡_d–_š™
(&
lba_li¡
->
wa™_li¡
);

311 
lba_li¡
->
¡©us
 = 
LBA_READING
;

312 
	`shªnÚ_¥š_uÆock_bh
(&
lba_li¡
->
lba_lock
);

313 
	`as£mbË_rmw_»ad_»q
(
sdev
, 
sdisk
, 
lba_li¡
);

315 
	`ä“_lba_li¡
(
lba_li¡
);

316 
	}
}

318 
	$»£nd_as£mbË_rmw_»ad_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
)

320 
shªnÚ_»que¡
 *
»q
;

321 
shªnÚ_sb
 *
sb
;

322 
lun
, 
»t
, 
š_ÿche
;

324 
»m­
:

325 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
 * sbio->
logicbs
, 
SHANNON_DMA_FROMDEVICE
);

326 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

327 
	`shªnÚ_w¬n
("shannon_dma_map_singleƒrror.\n");

328 
	`shªnÚ_m¦“p
(1);

329 
»m­
;

332 
sbio
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

333 
	`£t_sbio_debug_g
(
sbio
, 
RESEND_RMW_READ_TAG
);

334 
sbio
->
ÿÎback
 = 
as£mbË_rmw_modify_»q_ÿÎback
;

335 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

336 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

338 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

339 
»q
->
»»ad
 = 0;

340 
»q
->
»cov”_buf
 = 
NULL
;

341 
»q
->
_ecc
 = 0;

342 
»q
->
_m‘ad©a
 = 0;

343 
»q
->
İcode
 = 
sh_cmd_»ad
;

344 
	`£t_»q_debug_g
(
»q
, 
RESEND_RMW_READ_TAG
, 0);

345 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

346 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

347 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

348 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

349 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, &
š_ÿche
, 
sdisk
);

350 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

351 ià(
»t
 < 0) {

352 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0,„eq->
Ëngth
);

353 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

355 } ià(
š_ÿche
) {

356 ià(
	`add_»q_to_´eãtch_li¡
(
sdisk
, 
»q
)) {

357 
	`shªnÚ_wake_up_´oûss
(
sdev
->
´eãtch_th»ad
);

361 
	`šü—£_ÿche_miss
(
sdisk
, 
»q
);

362 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

363 
»q
->
£q_num
 = 
sb
->seq_num;

364 
lun
 = 
»q
->
pba
.lun;

365 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

366 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, 1);

369 
	}
}

372 
	$as£mbË_rmw_»ad_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
lba_li¡
 *lba_list)

374 
shªnÚ_bio
 *
sbio
;

375 
shªnÚ_»que¡
 *
»q
;

376 
shªnÚ_sb
 *
sb
;

377 
lun
, 
»t
, 
š_ÿche
;

379 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

380 
sbio
->
d©a
 = 
sdev
;

381 
sbio
->
d©a2
 = 
lba_li¡
;

382 
	`£t_sbio_debug_g
(
sbio
, 
ASSEMBLE_RMW_READ_TAG
);

383 
sbio
->
ÿÎback
 = 
as£mbË_rmw_modify_»q_ÿÎback
;

384 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

385 
sbio
->
ns_id
 = 
lba_li¡
->ns_id;

386 
sbio
->
ns_£q_num
 = 
lba_li¡
->
ns_id
;

387 
sbio
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

389 
sbio
->
logicbs
 = 1;

390 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

391 
sbio
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

392 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

394 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

395 
	`£t_»q_debug_g
(
»q
, 
ASSEMBLE_RMW_READ_TAG
, 0);

396 
»q
->
sbio
 = sbio;

397 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

398 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

399 
»q
->
£nd”
 = 
FROM_HOST
;

400 
»q
->
İcode
 = 
sh_cmd_»ad
;

401 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

402 
»q
->
ns_id
 = 
lba_li¡
->ns_id;

403 
»q
->
ns_£q_num
 = 
lba_li¡
->ns_seq_num;

404 
»q
->
lba
 = 
lba_li¡
->lba;

405 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

406 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

407 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

408 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

409 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, &
š_ÿche
, 
sdisk
);

410 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

411 ià(
»t
 < 0) {

412 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0,„eq->
Ëngth
);

413 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

415 } ià(
š_ÿche
) {

416 ià(
	`add_»q_to_´eãtch_li¡
(
sdisk
, 
»q
)) {

417 
	`shªnÚ_wake_up_´oûss
(
sdev
->
´eãtch_th»ad
);

421 
	`šü—£_ÿche_miss
(
sdisk
, 
»q
);

422 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

423 
»q
->
£q_num
 = 
sb
->seq_num;

424 
lun
 = 
»q
->
pba
.lun;

425 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

426 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, 1);

429 
	}
}

431 
	$nÚ®igÃd_»ad_bio_ÿÎback
(
shªnÚ_bio
 *
sbio
)

433 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

434 
shªnÚ_»que¡
 *
»q
, *
tmp
;

436 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


437 
	`shªnÚ_©omic_dec
(&
sdev
->
»ad_bios
);

439 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

440 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

441 ià(
»q
->
Ëngth
 =ğ
sdev
->
logicb_size
) {

442 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg
,„eq->
dma_dœ
);

443 ià(
»q
->
vœt_addr_2
)

444 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg2
,„eq->
dma_dœ
);

446 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

447 
fœ¡_size
 = 
sdev
->
logicb_size
 - (()
»q
->
vœt_addr
 & (sdev->logicb_size - 1));

448 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
fœ¡_size
);

449 ià(
fœ¡_size
 < 
sdev
->
logicb_size
)

450 
	`shªnÚ_memıy
(
»q
->
vœt_addr_2
,„eq->
»cov”_buf
 + 
fœ¡_size
, 
sdev
->
logicb_size
 - first_size);

451 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

453 ià(
	`uÆik–y
(
sbio
->
¡©us
))

454 
	`shªnÚ_šfo
("%s():†ba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n",

455 
__func__
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

457 
	`ä“_»q
(
»q
);

460 
	`shªnÚ_com¶‘e_fs_io
(
sdev
->
sdisk
.
ho¡d©a
, sdev->sdisk.
gd
, 
sbio
);

461 ià(
sbio
->
sg_couÁ
)

462 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

463 
	`ä“_sbio
(
sbio
);

464 
	}
}

466 
	$add_»q_to_rc_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
)

468 
lba_li¡
 *
p
, *
Ãw
 = 
NULL
;

469 
šdex
 = 
»q
->
lba
 % 
RMW_LIST_COUNT
;

470 
lun_pba
 
pba
;

472 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

473 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
pba
, 
NULL
, 
sdisk
);

474 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

475 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
rmw_li¡_lock
[0][
šdex
]);

476 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
sdisk
->
rmw_li¡
[0][
šdex
], 
li¡
) {

477 ià(
p
->
lba
 =ğ
»q
->lba) {

478 ià((
p
->
pba
.
lun
 =ğpba.lunè&& (p->pba.
lun_pba
 ==…ba.lun_pba))

479 
found0
;

482 } ià(
p
->
lba
 > 
»q
->lba)

485 
Ãw
 = 
	`®loc_lba_li¡
(
sdisk
, 
»q
->
lba
);

486 
Ãw
->
pba
.
lun
 =…ba.lun;

487 
Ãw
->
pba
.
lun_pba
 =…ba.lun_pba;

488 
Ãw
->
ns_id
 = 
»q
->ns_id;

489 
Ãw
->
ns_£q_num
 = 
»q
->ns_seq_num;

490 
	`shªnÚ_li¡_add_
(&
Ãw
->
li¡
, &
p
->list);

491 
p
 = 
Ãw
;

492 
found0
:

493 
	`shªnÚ_¥š_lock_bh
(&
p
->
lba_lock
);

494 
»q
->
¡©e
 = 
REQ_IN_RC_LIST
;

495 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
p
->
»q_li¡
);

496 
	`shªnÚ_¥š_uÆock_bh
(&
p
->
lba_lock
);

497 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
rmw_li¡_lock
[0][
šdex
]);

498 ià(
Ãw
)

499 
	`as£mbË_rc_»ad_»q
(
sdev
, 
sdisk
, 
Ãw
);

500 
	}
}

502 
	$add_»q_to_rmw_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
)

504 
lba_li¡
 *
p
, *
Ãw
 = 
NULL
;

505 
šdex
 = 
»q
->
lba
 % 
RMW_LIST_COUNT
;

507 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
rmw_li¡_lock
[1][
šdex
]);

508 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
sdisk
->
rmw_li¡
[1][
šdex
], 
li¡
) {

509 ià(
p
->
lba
 =ğ
»q
->lba)

510 
found1
;

511 ià(
p
->
lba
 > 
»q
->lba)

514 
Ãw
 = 
	`®loc_lba_li¡
(
sdisk
, 
»q
->
lba
);

515 
Ãw
->
h—d
 = 
»q
->head;

516 
Ãw
->
ns_id
 = 
»q
->ns_id;

517 
Ãw
->
ns_£q_num
 = 
»q
->ns_seq_num;

518 
	`shªnÚ_li¡_add_
(&
Ãw
->
li¡
, &
p
->list);

519 
p
 = 
Ãw
;

520 
found1
:

521 
	`shªnÚ_¥š_lock_bh
(&
p
->
lba_lock
);

522 ià(
p
->
¡©us
 =ğ
LBA_LOCKED
) {

523 
»q
->
¡©e
 = 
REQ_IN_RMW_WAIT_LIST
;

524 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
p
->
wa™_li¡
);

526 
»q
->
¡©e
 = 
REQ_IN_RMW_LIST
;

527 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
p
->
»q_li¡
);

529 
	`shªnÚ_¥š_uÆock_bh
(&
p
->
lba_lock
);

530 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
rmw_li¡_lock
[1][
šdex
]);

531 ià(
Ãw
)

532 
	`as£mbË_rmw_»ad_»q
(
sdev
, 
sdisk
, 
Ãw
);

533 
	}
}

535 
	$nÚ®igÃd_wr™e_bio_ÿÎback
(
shªnÚ_bio
 *
sbio
)

537 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

538 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

539 
shªnÚ_»que¡
 *
»q
, *
tmp
;

540 
shªnÚ_sb
 *
sb
 = 
NULL
, *
Ï¡_sb
 = NULL;

541 
logicbs
 = 0;

543 
__echo_š
;

544 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


545 
	`shªnÚ_©omic_dec
(&
sdev
->
wr™e_bios
);

547 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

548 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

549 ià(
»q
->
Ëngth
 =ğ
sdev
->
logicb_size
) {

550 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg
,„eq->
dma_dœ
);

551 ià(
»q
->
vœt_addr_2
)

552 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg2
,„eq->
dma_dœ
);

554 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

555 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

556 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

557 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

558 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

559 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

561 
	`shªnÚ_šfo
("%s: sbio->¡¬t_£ùÜ=0x%lx, sbio->¡©us=0x%x.\n", 
__func__
, 
sbio
->
¡¬t_£ùÜ
, sbio->
¡©us
);

562 ià((
Ï¡_sb
 =ğ
NULL
è|| (Ï¡_sb =ğ
sb
))

563 
logicbs
++;

565 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

566 
logicbs
 = 1;

568 
Ï¡_sb
 = 
sb
;

571 
	`ä“_»q
(
»q
);

574 ià(
logicbs
)

575 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

576 
	`shªnÚ_©omic_sub
(
sbio
->
logicbs
, &
sdev
->
š_æight_wr™es
);

578 
	`shªnÚ_com¶‘e_fs_io
(
sdev
->
sdisk
.
ho¡d©a
, sdev->sdisk.
gd
, 
sbio
);

579 ià(
sbio
->
sg_couÁ
)

580 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

582 
	`ä“_sbio
(
sbio
);

583 
	}
}

585 
	$£nd_uÇligÃd_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
)

587 
sdisk
->
nÚ®igÃd_»qs
++;

588 ià(
»q
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

589 
»q
->
İcode
 = 
sh_cmd_wr™e
;

590 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

591 
	`add_»q_to_rmw_li¡
(
sdev
, 
sdisk
, 
»q
);

593 
»q
->
İcode
 = 
sh_cmd_»ad
;

594 
	`add_»q_to_rc_li¡
(
sdev
, 
sdisk
, 
»q
);

596 
	}
}

598 
	$£nd_®igÃd_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
)

600 
»t
, 
lun
, 
fl_h—d
 = 0;

601 
shªnÚ_sb
 *
sb
 = 
NULL
;

603 
sdisk
->
®igÃd_»qs
++;

604 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_Úe_sg_·ge
(
sdev
->
pci_dev
,„eq->
sg
,„eq->
dma_dœ
);

605 ià(
»q
->
vœt_addr_2
)

606 
»q
->
dma_add»ss_2
 = 
	`shªnÚ_dma_m­_Úe_sg_·ge
(
sdev
->
pci_dev
,„eq->
sg2
,„eq->
dma_dœ
);

608 ià(
»q
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

609 
»q
->
İcode
 = 
sh_cmd_wr™e
;

610 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

612 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

613 
	`ho¡_g‘_h—d_ªd_£t_pba_bË
(
sdev
, 
sdisk
, 
sbio
->
bio
, 
»q
);

614 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

615 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

616 ià((
»q
->
h—d
 & 
HEAD_INDEX_MASK
è=ğ
HOT_INDEX
)

617 
fl_h—d
 |ğ1 << 
HOT_INDEX
;

619 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


620 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

622 
fl_h—d
 |ğ1 << 
COLD_INDEX
;

624 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 
sdisk
->
´iÜ™y
);

625 
	`mod_fl_chunk_tim”
(
sdev
, 
fl_h—d
);

626 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

628 
»q
->
İcode
 = 
sh_cmd_»ad
;

630 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

631 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, 
NULL
, 
sdisk
);

632 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

633 ià(
»t
 < 0) {

634 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

636 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

637 
»q
->
£q_num
 = 
sb
->seq_num;

638 
lun
 = 
»q
->
pba
.lun;

639 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

640 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, 1);

643 
	}
}

645 
	$check_befÜe_wr™e
(
shªnÚ_dev
 *
sdev
)

647 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
)

648 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 10);

650 ià(
sdev
->
ä“_blkút
 < 
GC_THRESHOLD_N3
) {

651 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
block_ho¡_wr
, (sdev->
sdisk
.
ex™
 || (sdev->
ä“_blkút
 >ğ
GC_THRESHOLD_N3
)));

654 ià((
sdev
->
š_block_¡©e
 < 2è&& (
	`shªnÚ_©omic_»ad
(&sdev->
wr™e_»qs
[1]è>ğ
REQ_QUEUE_THRESHOLD_H
))

655 
sdev
->
š_block_¡©e
 = 2;

656 ià(
sdev
->
š_block_¡©e
 == 2) {

657 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
lim™_»q_queue
[1], \

658 (
sdev
->
sdisk
.
ex™
 || (sdev->
š_block_¡©e
 < 2è|| (
	`shªnÚ_©omic_»ad
(&sdev->
wr™e_»qs
[1]è< 
REQ_QUEUE_THRESHOLD_L
)));

661 
	}
}

663 
	$is_cou¶e_sg
(
shªnÚ_sg_li¡_t
 *
sg
, shªnÚ_sg_li¡_ˆ*
Ãxt_sg
)

665 ià((
Ãxt_sg
 =ğ
NULL
è|| (
	`shªnÚ_sg_Ëngth
(next_sg) == 0))

667 ià((
	`shªnÚ_sg_off£t
(
sg
è+ 
	`shªnÚ_sg_Ëngth
(sg)) != 4096)

669 ià(
	`shªnÚ_sg_off£t
(
Ãxt_sg
) != 0)

671 ià((
	`shªnÚ_sg_Ëngth
(
sg
è+ shªnÚ_sg_Ëngth(
Ãxt_sg
)) != 4096)

675 
	}
}

677 
	$ÿlcuÏ‹_nÚ®igÃd_bio_u£r_couÁ
(
shªnÚ_bio
 *
sbio
, 
logicb_size
, 
fœ¡_size
)

679 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
, *
Ãxt_sg
 = NULL;

681 
»mašed_size
, 
undÚe
 = 0;

682 
Ëngth
 = 0;

684 
u£r_couÁ
 = 0;

686 ià(
fœ¡_size
) {

687 
»mašed_size
 = 
fœ¡_size
;

688 
undÚe
 = 1;

690 
»mašed_size
 = 
logicb_size
;

691 
undÚe
 = 0;

694 
sg
 = 
sbio
->sg;

696 
sg
 && 
	`shªnÚ_sg_·ge
(sg)) {

697 
Ëngth
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

698 
u£r_couÁ
++;

700 ià(
undÚe
) {

701 
»mašed_size
 -ğ
Ëngth
;

702 ià(
»mašed_size
 == 0) {

703 
»mašed_size
 = 
logicb_size
;

704 
undÚe
 = 0;

707 ià((
	`shªnÚ_sg_off£t
(
sg
è& 0x7è|| (
	`shªnÚ_sg_Ëngth
(sg) & 0x7)) {

708 
undÚe
 = 1;

709 
»mašed_size
 -ğ
Ëngth
;

711 ià(
Ëngth
 !ğ
logicb_size
) {

712 
Ãxt_sg
 = 
	`shªnÚ_sg_Ãxt
(
sg
);

713 ià(
	`is_cou¶e_sg
(
sg
, 
Ãxt_sg
)) {

714 
sg
 = 
Ãxt_sg
;

716 
undÚe
 = 1;

717 
»mašed_size
 -ğ
Ëngth
;

723 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

726  
u£r_couÁ
;

727 
	}
}

729 
	$shªnÚ_subm™_nÚ®igÃd_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
, 
fœ¡_size
)

731 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

732 
shªnÚ_»que¡
 *
»q
;

733 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
, *
Ãxt_sg
 = NULL;

734 
i
, 
»mašed_size
, 
undÚe
 = 0;

735 
u64
 
¡¬t_off£t
;

738 
sdev
->
sdisk
.
nÚ®igÃd_bios
++;

739 
sbio
->
d©a
 = 
sdev
;

740 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

741 
sbio
->
ÿÎback
 = 
nÚ®igÃd_wr™e_bio_ÿÎback
;

742 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

744 
	`check_befÜe_wr™e
(
sdev
);

745 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
)) {

746 
	`shªnÚ_w¬n
("the disk is‡bsent!\n");

747  -
EIO
;

750 
sbio
->
ÿÎback
 = 
nÚ®igÃd_»ad_bio_ÿÎback
;

751 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

754 
sbio
->
logicbs
 = 
	`ÿlcuÏ‹_nÚ®igÃd_bio_u£r_couÁ
(sbio, 
sdev
->
logicb_size
, 
fœ¡_size
);

755 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
 + 1);

758 ià(
fœ¡_size
) {

759 
»mašed_size
 = 
fœ¡_size
;

760 
undÚe
 = 1;

762 
»mašed_size
 = 
sdev
->
logicb_size
;

763 
undÚe
 = 0;

766 
¡¬t_off£t
 = 
sbio
->
¡¬t_£ùÜ
 << 9;

767 
sg
 = 
sbio
->sg;

768 
i
 = 0;

769 
sg
 && 
	`shªnÚ_sg_·ge
(sg)) {

770 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

771 #ifdeà
CONFIG_SHANNON_DEBUG


772 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 
i
);

774 
»q
->
£nd”
 = 
FROM_HOST
;

775 
»q
->
sbio
 = sbio;

776 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

777 
	`£t_»q_šdex
(
»q
, 
i
);

778 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

779 
»q
->
dma_dœ
 = 
sbio
->dma_dir;

780 
»q
->
sg
 = sg;

781 
»q
->
vœt_addr
 = 
	`shªnÚ_sg_vœt
(
sg
);

782 
»q
->
Ëngth
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

783 
»q
->
¡¬t_off£t
 = start_offset;

784 
»q
->
lba
 = 
¡¬t_off£t
 >> 
sdev
->
logicb_shiá
;

786 
¡¬t_off£t
 +ğ
	`shªnÚ_sg_Ëngth
(
sg
);

788 ià(
undÚe
) {

789 
»mašed_size
 -ğ
»q
->
Ëngth
;

790 ià(
»mašed_size
 == 0) {

791 
»mašed_size
 = 
sdev
->
logicb_size
;

792 
undÚe
 = 0;

794 
	`£nd_uÇligÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

796 ià((
	`shªnÚ_sg_off£t
(
sg
è& 0x7è|| (
	`shªnÚ_sg_Ëngth
(sg) & 0x7)) {

797 
undÚe
 = 1;

798 
»mašed_size
 -ğ
»q
->
Ëngth
;

799 
	`£nd_uÇligÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

801 ià(
»q
->
Ëngth
 =ğ
sdev
->
logicb_size
) {

802 
	`£nd_®igÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

804 
Ãxt_sg
 = 
	`shªnÚ_sg_Ãxt
(
sg
);

805 ià(
	`is_cou¶e_sg
(
sg
, 
Ãxt_sg
)) {

806 
»q
->
sg2
 = 
Ãxt_sg
;

807 
»q
->
vœt_addr_2
 = 
	`shªnÚ_sg_vœt
(
Ãxt_sg
);

808 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

809 
¡¬t_off£t
 +ğ
	`shªnÚ_sg_Ëngth
(
Ãxt_sg
);

810 
	`£nd_®igÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

812 
sg
 = 
Ãxt_sg
;

814 
undÚe
 = 1;

815 
»mašed_size
 -ğ
»q
->
Ëngth
;

816 
	`£nd_uÇligÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

822 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

823 
i
++;

826 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

827 
	`shªnÚ_©omic_add
(
sbio
->
logicbs
, &
sdev
->
š_æight_wr™es
);

829 
	`b®ªû_gc
(
sdev
, 
sbio
->
logicbs
);

830 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
) {

831 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 4);

835 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

838 
	}
}

	@shannon_block.c

1 
	~<lšux/fs.h
>

2 
	~<lšux/deviû.h
>

3 
	~<lšux/š‹¼u±.h
>

4 
	~<lšux/blkdev.h
>

5 
	~<lšux/g’hd.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/moduË.h
>

8 
	~<lšux/v”siÚ.h
>

9 
	~<lšux/pci.h
>

10 
	~<lšux/¥šlock.h
>

12 
	~"shªnÚ_block.h
"

13 
	~"shªnÚ_deviû.h
"

14 
	~"shªnÚ_time.h
"

15 
	~"shªnÚ_pÜt.h
"

17 
šü—£_ns_³ndšg_bios
(
shªnÚ_Çme¥aû
 *
ns
);

18 
deü—£_ns_³ndšg_bios
(
shªnÚ_Çme¥aû
 *
ns
);

19 
check_ªd_®loc_Ímt
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
logicb_shiá
);

21 
	gshªnÚ_u£_iosched
 = 0;

24 
shªnÚ_g’disk_t
 *
	$shªnÚ_®loc_disk
(
mšÜs
)

26  
	`®loc_disk
(
mšÜs
);

27 
	}
}

29 
block_deviû_İ”©iÚs
 
shªnÚ_İs
;

30 
block_deviû_İ”©iÚs
 
shªnÚ_İs_ns
;

31 
	$shªnÚ_š™_g’disk
(
shªnÚ_g’disk_t
 *
disk
, *
Çme
, 
majÜ
, 
mšÜ_¥ª
, 
fœ¡_mšÜ
, 
shªnÚ_»que¡_queue_t
 *
rq
, *
´i
)

33 
g’disk
 *
gd
 = (g’disk *)
disk
;

35 
	`¢´štf
(
gd
->
disk_Çme
, 32, 
Çme
);

36 
gd
->
majÜ
 = major;

37 
gd
->
mšÜs
 = 
mšÜ_¥ª
;

38 
gd
->
fœ¡_mšÜ
 = first_minor;

39 
	`debugs0
("disk_name=%s, major=%d, minors=%d, first_minor=%d.\n",

40 
gd
->
disk_Çme
, gd->
majÜ
, gd->
mšÜs
, gd->
fœ¡_mšÜ
);

41 
gd
->
queue
 = (
»que¡_queue
 *)
rq
;

42 
gd
->
´iv©e_d©a
 = 
´i
;

43 
gd
->
fİs
 = &
shªnÚ_İs
;

45 ià(*
Çme
 != 'd')

46 
gd
->
fİs
 = &
shªnÚ_İs_ns
;

49 
	}
}

51 
	$shªnÚ_£t_ÿ·c™y
(
shªnÚ_g’disk_t
 *
disk
, 
shªnÚ_£ùÜ_t
 
size
)

53 
	`£t_ÿ·c™y
((
g’disk
 *)
disk
, 
size
);

54 
	}
}

56 
	$shªnÚ_£t_disk_ro
(
shªnÚ_g’disk_t
 *
disk
, 
æag
)

58 
	`£t_disk_ro
((
g’disk
 *)
disk
, 
æag
);

59 
	}
}

61 
	$shªnÚ_put_disk
(
shªnÚ_g’disk_t
 *
disk
)

63 
	`put_disk
((
g’disk
 *)
disk
);

64 
	}
}

66 
	$shªnÚ_add_disk
(
shªnÚ_g’disk_t
 *
disk
)

68 
	`add_disk
((
g’disk
 *)
disk
);

69 
	}
}

71 
	$shªnÚ_d–_g’disk
(
shªnÚ_g’disk_t
 *
gp
)

73 
	`d–_g’disk
((
g’disk
 *)
gp
);

74 
	}
}

77 
	$shªnÚ_»gi¡”_blkdev
(
majÜ
, cÚ¡ *
Çme
)

79  
	`»gi¡”_blkdev
(
majÜ
, 
Çme
);

80 
	}
}

82 
	$shªnÚ_uÄegi¡”_blkdev
(
majÜ
, cÚ¡ *
Çme
)

84 
	`uÄegi¡”_blkdev
(
majÜ
, 
Çme
);

85 
	}
}

88 
	$shªnÚ_blk_queue_block_size
(
shªnÚ_»que¡_queue_t
 *
queue
, 
logiÿl_size
, 
physiÿl_size
)

90 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

92 
	`blk_queue_logiÿl_block_size
((
»que¡_queue
 *)
queue
, 
logiÿl_size
);

93 
	`blk_queue_physiÿl_block_size
((
»que¡_queue
 *)
queue
, 
physiÿl_size
);

97 
	`blk_queue_h¬d£ù_size
((
»que¡_queue
 *)
queue
, 
logiÿl_size
);

100 
	}
}

102 
	$shªnÚ_blk_queue_max_hw_£ùÜs
(
shªnÚ_»que¡_queue_t
 *
q
, 
max_hw_£ùÜs
)

104 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

105 
	`blk_queue_max_hw_£ùÜs
((
»que¡_queue
 *)
q
, 
max_hw_£ùÜs
);

107 
	`blk_queue_max_£ùÜs
((
»que¡_queue
 *)
q
, 
max_hw_£ùÜs
);

109 
	}
}

111 
	$shªnÚ_blk_queue_io_mš
(
shªnÚ_»que¡_queue_t
 *
queue
, 
mš
)

113 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 29)

114 
	`blk_queue_io_mš
((
»que¡_queue
 *)
queue
, 
mš
);

116 
	}
}

118 
	$shªnÚ_blk_queue_io_İt
(
shªnÚ_»que¡_queue_t
 *
queue
, 
İt
)

120 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 29)

121 
	`blk_queue_io_İt
((
»que¡_queue
 *)
queue
, 
İt
);

123 
	}
}

125 
	$shªnÚ_should_Œim_bio
(
shªnÚ_bio_t
 *
bio
)

127 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4, 8, 0)

128  ((
bio
 *)bio)->
bi_İf
 && (
	`bio_İ
((biØ*)bioè=ğ
REQ_OP_DISCARD
);

130 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

131 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 36)

132  ((
bio
 *)bio)->
bi_rw
 & 
REQ_DISCARD
;

134 #ià
LINUX_VERSION_CODE
 =ğ
	`KERNEL_VERSION
(2, 6, 28)

135  
	`bio_disÿrd
((
bio
 *)bio);

137  
	`bio_rw_æagged
((
bio
 *)bio, 
BIO_RW_DISCARD
);

146 
	}
}

149 
	$shªnÚ_queue_æag_£t
(
æag
, 
shªnÚ_»que¡_queue_t
 *
queue
)

151 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

152 
	`£t_b™
(
æag
, &(((
»que¡_queue
 *)
queue
)->
queue_æags
));

153 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 17, 0)

154 
	`queue_æag_£t_uÆocked
(
æag
, (
»que¡_queue
 *)
queue
);

156 
	`blk_queue_æag_£t
(
æag
, (
»que¡_queue
 *)
queue
);

158 
	}
}

161 
	$shªnÚ_queue_æag_ş—r
(
æag
, 
shªnÚ_»que¡_queue_t
 *
queue
)

163 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 26)

164 
	`ş—r_b™
(
æag
, &(((
»que¡_queue
 *)
queue
)->
queue_æags
));

165 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 17, 0)

166 
	`queue_æag_ş—r_uÆocked
(
æag
, (
»que¡_queue
 *)
queue
);

168 
	`blk_queue_æag_ş—r
(
æag
, (
»que¡_queue
 *)
queue
);

170 
	}
}

172 
	$shªnÚ_Œim_£‰šg
(
shªnÚ_»que¡_queue_t
 *
queue
)

174 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 32)

177 #ifdeà
RHEL_RELEASE_CODE


178 #ià
RHEL_RELEASE_CODE
 >ğ
	`RHEL_RELEASE_VERSION
(6, 0)

179 ((
»que¡_queue
 *)
queue
)->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
PAGE_SIZE
;

183 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 33)

184 ((
»que¡_queue
 *)
queue
)->
lim™s
.
disÿrd_g¿nuÏr™y
 = 
PAGE_SIZE
;

187 ((
»que¡_queue
 *)
queue
)->
lim™s
.
max_disÿrd_£ùÜs
 = (
UINT_MAX
 >> 9) & ~7;

189 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 37) && LINUX_VERSION_CODE < KERNEL_VERSION(4, 12, 0)

190 ((
»que¡_queue
 *)
queue
)->
lim™s
.
disÿrd_z”Ûs_d©a
 = 1;

193 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 17, 0)

194 
	`queue_æag_£t_uÆocked
(
QUEUE_FLAG_DISCARD
, (
»que¡_queue
 *)
queue
);

196 
	`blk_queue_æag_£t
(
QUEUE_FLAG_DISCARD
, (
»que¡_queue
 *)
queue
);

199 
	}
}

201 
	$shªnÚ_rÙ©iÚ®_£‰šg
(
shªnÚ_»que¡_queue_t
 *
queue
)

203 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

204 
	`shªnÚ_queue_æag_£t
(
QUEUE_FLAG_NONROT
, 
queue
);

206 
	}
}

208 
	$shªnÚ_blk_ş—nup_queue
(
shªnÚ_»que¡_queue_t
 *
q
)

210 
	`blk_ş—nup_queue
((
»que¡_queue
 *)
q
);

211 
	}
}

214 
	$shªnÚ_bio_’dio
(
shªnÚ_bio_t
 *
bio
, 
”rÜ
)

216 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 24)

218 ià(
”rÜ
)

219 
	`bio_’dio
((
bio
 *)bio, 0, 
”rÜ
);

221 
	`bio_’dio
((
bio
 *)bio, ((biØ*)bio)->
bi_size
, 0);

223 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

225 
	`bio_’dio
((
bio
 *)bio, 
”rÜ
);

227 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 13, 0)

228 ((
bio
 *)bio)->
bi_”rÜ
 = 
”rÜ
;

229 
	`bio_’dio
((
bio
 *)bio);

231 ((
bio
 *)bio)->
bi_¡©us
 = 
”rÜ
;

232 
	`bio_’dio
((
bio
 *)bio);

234 
	}
}

236 
	$shªnÚ_bio_æagged
(
shªnÚ_bio_t
 *
bio
, 
æag
)

238  
	`bio_æagged
((
bio
 *)bio, 
æag
);

239 
	}
}

241 
	$shªnÚ_bio_d©a_dœ
(
shªnÚ_bio_t
 *
bio
)

243  
	`bio_d©a_dœ
((
bio
 *)bio);

244 
	}
}

246 
	$shªnÚ_bio_£gm’ts
(
shªnÚ_bio_t
 *
bio
)

248  
	`bio_£gm’ts
((
bio
 *)bio);

249 
	}
}

251 
	$g‘_bi_size
(
shªnÚ_bio_t
 *
bio
)

253 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3, 14, 0)

254  ((
bio
 *)bio)->
bi_™”
.
bi_size
;

256  ((
bio
 *)bio)->
bi_size
;

258 
	}
}

260 
shªnÚ_£ùÜ_t
 
	$g‘_bi_£ùÜ
(
shªnÚ_bio_t
 *
bio
)

262 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3, 14, 0)

263  ((
bio
 *)bio)->
bi_™”
.
bi_£ùÜ
;

265  ((
bio
 *)bio)->
bi_£ùÜ
;

267 
	}
}

269 
shªnÚ_g’disk_t
 *
g‘_g’disk_äom_ns
(
shªnÚ_Çme¥aû
 *
ns
);

270 
ns_g‘_logicb_size
(
shªnÚ_Çme¥aû
 *
ns
);

271 
ns_g‘_logicb_shiá
(
shªnÚ_Çme¥aû
 *
ns
);

272 
shªnÚ_poŞ
 *
ns_g‘_poŞ
(
shªnÚ_Çme¥aû
 *
ns
);

273 
shªnÚ_disk
 *
g‘_shªnÚ_disk_äom_ns
(
shªnÚ_Çme¥aû
 *
ns
);

274 
u64
 
poŞ_u£d_logicbs
(
shªnÚ_poŞ
 *
¥
);

275 
u64
 
poŞ_avaabË_ÿp
(
shªnÚ_poŞ
 *
¥
);

277 
shªnÚ_g’disk_t
 *
g‘_g’disk_äom_sdev
(
shªnÚ_dev
 *
sdev
);

278 
g‘_logicb_size
(
shªnÚ_dev
 *
sdev
);

279 
g‘_logicb_shiá
(
shªnÚ_dev
 *
sdev
);

280 
shªnÚ_disk
 *
g‘_shªnÚ_disk_äom_sdev
(
shªnÚ_dev
 *
sdev
);

282 
shªnÚ_check_avaab™y
(
shªnÚ_dev
 *
sdev
);

283 
shªnÚ_check_avaab™y_ns
(
shªnÚ_Çme¥aû
 *);

284 
shªnÚ_disk_»adÚly
(
shªnÚ_dev
 *
sdev
);

285 
shªnÚ_disk_»adÚly_ns
(
shªnÚ_Çme¥aû
 *);

286 
shªnÚ_subm™_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
);

287 
shªnÚ_subm™_bio_thrÙšg_ns
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
);

288 
shªnÚ_disÿrd
(
shªnÚ_dev
 *
sdev
, 
logicb64_t
 
¡¬t_lba
,†ogicb64_ˆ
’d_lba
);

289 
shªnÚ_disÿrd_ns
(
shªnÚ_Çme¥aû
 *
ns
, 
logicb64_t
 
¡¬t_lba
,†ogicb64_ˆ
’d_lba
, 
d–_ns
);

291 #ifdeà
CONFIG_SHANNON_DEBUG


292 
	$£t_sbio_debug_g
(
shªnÚ_bio
 *
sbio
, 
g
)

294 
sbio
->
g
 =ag;

295 
	}
}

298 
	$shªnÚ_®loc_bounû_·ges
(
shªnÚ_sg_li¡_t
 *
sgbË
, 
fœ¡_size
, 
tÙ®_size
)

300 
·ge_út
 = 0, 
i
 = 0, 
j
 = 0;

301 
fœ¡_·ge_ofã¡
 = 0, 
Ï¡_·ge_Ën
 = 0;

303 
·ge
 *·gğ
NULL
;

304 
shªnÚ_sg_li¡_t
 *
sge
 = 
sgbË
;

306 ià(
fœ¡_size
) {

307 
·ge_út
++;

308 
fœ¡_·ge_ofã¡
 = 
PAGE_SIZE
 - 
fœ¡_size
;

311 
·ge_út
 +ğ(
tÙ®_size
 - 
fœ¡_size
è/ 
PAGE_SIZE
;

312 
Ï¡_·ge_Ën
 = (
tÙ®_size
 - 
fœ¡_size
è% 
PAGE_SIZE
;

314 ià(
Ï¡_·ge_Ën
)

315 
·ge_út
++;

317 
i
 = 0; i < 
·ge_út
; i++) {

318 
·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

320 ià(!
·ge
)

321 
ç_out
;

323 ià((
i
 =ğ0è&& 
fœ¡_·ge_ofã¡
)

324 
	`shªnÚ_sg_£t_·ge
(
sge
, 
·ge
, 
fœ¡_size
, 
fœ¡_·ge_ofã¡
);

325 ià((
i
 =ğ
·ge_út
 - 1è&& 
Ï¡_·ge_Ën
)

326 
	`shªnÚ_sg_£t_·ge
(
sge
, 
·ge
, 
Ï¡_·ge_Ën
, 0);

328 
	`shªnÚ_sg_£t_·ge
(
sge
, 
·ge
, 
PAGE_SIZE
, 0);

330 
sge
 = 
	`shªnÚ_sg_Ãxt
(sge);

333 
	`shªnÚ_sg_m¬k_’d
(
sge
);

335  
·ge_út
;

337 
ç_out
:

338 
	`shªnÚ_fÜ_—ch_sg
(
sgbË
, 
sge
, 
i
, 
j
)

339 
	`__ä“_·ge
(
	`shªnÚ_sg_·ge
(
sge
));

341  -
ENOMEM
;

342 
	}
}

346 
	$shªnÚ_cİy_bounû_·ges
(
shªnÚ_bio_t
 *
lbio
, 
shªnÚ_sg_li¡_t
 *
sgbË
, 
to_sg
)

348 
bio
 *biØğ(biØ*)
lbio
;

349 
shªnÚ_sg_li¡_t
 *
sge
 = 
sgbË
;

351 
sge_off£t
, 
sge_Ën
;

352 
bvec_off£t
, 
bvec_Ën
;

354 
cİy_Ën
;

356 *
sge_addr
, *
bvec_addr
;

358 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3, 14, 0)

359 
bio_vec
 
bvec
;

360 
bvec_™”
 
™”
;

362 
sge_Ën
 = 
	`shªnÚ_sg_Ëngth
(
sge
);

363 
sge_off£t
 = 
	`shªnÚ_sg_off£t
(
sge
);

365 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

366 
bvec_Ën
 = 
bvec
.
bv_Ën
;

367 
bvec_off£t
 = 
bvec
.
bv_off£t
;

370 ià(
sge_Ën
 > 
bvec_Ën
)

371 
cİy_Ën
 = 
bvec_Ën
;

373 
cİy_Ën
 = 
sge_Ën
;

375 
bvec_addr
 = 
	`·ge_add»ss
(
bvec
.
bv_·ge
è+ 
bvec_off£t
;

376 
sge_addr
 = 
	`·ge_add»ss
(
	`shªnÚ_sg_·ge
(
sge
)è+ 
sge_off£t
;

378 ià(
to_sg
)

379 
	`memıy
(
sge_addr
, 
bvec_addr
, 
cİy_Ën
);

381 
	`memıy
(
bvec_addr
, 
sge_addr
, 
cİy_Ën
);

383 
bvec_off£t
 +ğ
cİy_Ën
;

384 
bvec_Ën
 -ğ
cİy_Ën
;

386 
sge_off£t
 +ğ
cİy_Ën
;

387 
sge_Ën
 -ğ
cİy_Ën
;

389 ià(
sge_Ën
 <= 0) {

390 
sge
 = 
	`shªnÚ_sg_Ãxt
(sge);

391 
sge_Ën
 = 
	`shªnÚ_sg_Ëngth
(
sge
);

392 
sge_off£t
 = 
	`shªnÚ_sg_off£t
(
sge
);

394 } 
bvec_Ën
 > 0);

398 
bio_vec
 *
bvec
;

399 
i
;

401 
sge_Ën
 = 
	`shªnÚ_sg_Ëngth
(
sge
);

402 
sge_off£t
 = 
	`shªnÚ_sg_off£t
(
sge
);

404 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
i
) {

405 
bvec_Ën
 = 
bvec
->
bv_Ën
;

406 
bvec_off£t
 = 
bvec
->
bv_off£t
;

409 ià(
sge_Ën
 > 
bvec_Ën
)

410 
cİy_Ën
 = 
bvec_Ën
;

412 
cİy_Ën
 = 
sge_Ën
;

414 
bvec_addr
 = 
	`·ge_add»ss
(
bvec
->
bv_·ge
è+ 
bvec_off£t
;

415 
sge_addr
 = 
	`·ge_add»ss
(
	`shªnÚ_sg_·ge
(
sge
)è+ 
sge_off£t
;

417 ià(
to_sg
)

418 
	`memıy
(
sge_addr
, 
bvec_addr
, 
cİy_Ën
);

420 
	`memıy
(
bvec_addr
, 
sge_addr
, 
cİy_Ën
);

422 
bvec_off£t
 +ğ
cİy_Ën
;

423 
bvec_Ën
 -ğ
cİy_Ën
;

425 
sge_off£t
 +ğ
cİy_Ën
;

426 
sge_Ën
 -ğ
cİy_Ën
;

428 ià(
sge_Ën
 <= 0) {

429 
sge
 = 
	`shªnÚ_sg_Ãxt
(sge);

430 
sge_Ën
 = 
	`shªnÚ_sg_Ëngth
(
sge
);

431 
sge_off£t
 = 
	`shªnÚ_sg_off£t
(
sge
);

433 } 
bvec_Ën
 > 0);

436 
	}
}

438 
	$shªnÚ_ä“_bounû_·ges
(
shªnÚ_sg_li¡_t
 *
sgbË
, 
sg_couÁ
)

440 
shªnÚ_sg_li¡_t
 *
sge
;

441 
i
;

443 
	`shªnÚ_fÜ_—ch_sg
(
sgbË
, 
sge
, 
sg_couÁ
, 
i
)

444 
	`__ä“_·ge
(
	`shªnÚ_sg_·ge
(
sge
));

445 
	}
}

447 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 14, 0)

448 
	$shªnÚ_cÚv”t_bio
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_bio_t
 *
lbio
, 
logicb_size
)

450 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
;

451 
bio
 *biØğ(biØ*)
lbio
;

452 
bio_vec
 
bvec
;

453 
off£t
, 
»mašed_size
, 
m­_size
 = 0, 
undÚe
 = 0;

454 
bvec_™”
 
™”
;

456 
»t
 = 0;

458 
·ge_off£t
, 
m­·bË_size
;

460 
sbio
->
bio_size
 = 
	`g‘_bi_size
(
lbio
);

462 
sbio
->
£gm’ts
 = 
	`shªnÚ_bio_£gm’ts
(
lbio
);

463 
sbio
->
sg_couÁ
 = 2 * (((sbio->
bio_size
 + 
logicb_size
 - 1)/logicb_sizeè+ sbio->
£gm’ts
);

465 
sbio
->
sg
 = 
	`shªnÚ_sg_®loc
(sbio->
sg_couÁ
, 
GFP_SHANNON
);

466 ià(
sbio
->
sg
 =ğ
NULL
) {

467 
	`shªnÚ_”r
("alloc sg failed.\n");

468  -
ENOMEM
;

470 
	`shªnÚ_sg_š™_bË
(
sbio
->
sg
, sbio->
sg_couÁ
);

472 
sbio
->
¡¬t_£ùÜ
 = 
	`g‘_bi_£ùÜ
(
lbio
);

474 
sbio
->
fœ¡_size
 = 
logicb_size
 - ((sbio->
¡¬t_£ùÜ
 << 9) & (logicb_size - 1));

475 
sbio
->
fœ¡_size
 = sbio->fœ¡_siz% 
logicb_size
;

476 
sbio
->
fœ¡_size
 = 
	`mš
(sbio->
bio_size
, sbio->first_size);

478 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

479 ià(
bvec
.
bv_off£t
 & 0x7) {

480 
sbio
->
Ãed_bounû
 = 1;

482 ià(
bvec
.
bv_Ën
 & 0x7) {

483 
sbio
->
Ãed_bounû
 = 1;

487 ià(
sbio
->
Ãed_bounû
) {

488 
sbio
->
has_hŞe
 = 0;

490 
»t
 = 
	`shªnÚ_®loc_bounû_·ges
(
sbio
->
sg
, sbio->
fœ¡_size
, sbio->
bio_size
);

492 ià(
»t
 <= 0) {

493 
Şd_çshiÚ
;

495 
sbio
->
u£d_sg_couÁ
 = 
»t
;

497 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
)

498 
	`shªnÚ_cİy_bounû_·ges
(
bio
, 
sbio
->
sg
, 1);

504 
Şd_çshiÚ
:

505 
»mašed_size
 = 
sbio
->
fœ¡_size
 ? sbio->fœ¡_siz: 
logicb_size
;

507 
sbio
->
has_hŞe
 = 0;

508 ià(
sbio
->
Ãed_bounû
) {

509 
sbio
->
has_hŞe
 = 1;

510 
sbio
->
Ãed_bounû
 = 0;

513 
sbio
->
u£d_sg_couÁ
 = 0;

514 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

517 ià((
™”
.
bi_idx
 !ğ
bio
->
bi_™”
.bi_idxè&& (
bvec
.
bv_off£t
 != 0)) {

518 
sbio
->
has_hŞe
 = 1;

521 ià((
™”
.
bi_idx
 !ğ(
sbio
->
£gm’ts
 - 1)è&& ((
bvec
.
bv_off£t
 + bvec.
bv_Ën
) != 4096)) {

522 
sbio
->
has_hŞe
 = 1;

525 
off£t
 = 0;

527 
·ge_off£t
 = 
bvec
.
bv_off£t
 + 
off£t
;

529 
off£t
 < 
bvec
.
bv_Ën
) {

530 
m­·bË_size
 = 
PAGE_SIZE
 - (
·ge_off£t
 & (PAGE_SIZE -1));

531 ià(
m­·bË_size
 > (
bvec
.
bv_Ën
 - 
off£t
))

532 
m­·bË_size
 = 
bvec
.
bv_Ën
 - 
off£t
;

534 ià(
m­·bË_size
 < 
»mašed_size
) {

535 
m­_size
 = 
m­·bË_size
;

536 
undÚe
 = 1;

538 
m­_size
 = 
»mašed_size
;

539 
undÚe
 = 0;

541 
»mašed_size
 -ğ
m­_size
;

542 ià(
»mašed_size
 == 0)

543 
»mašed_size
 = 
logicb_size
;

544 
sg
 = sg ? 
	`shªnÚ_sg_Ãxt
(sgè: 
sbio
->sg;

545 
	`shªnÚ_sg_£t_·ge
(
sg
, 
bvec
.
bv_·ge
 + (
·ge_off£t
 / 
PAGE_SIZE
), 
m­_size
,…age_offset % PAGE_SIZE);

546 
sbio
->
u£d_sg_couÁ
++;

548 
off£t
 +ğ
m­_size
;

549 
·ge_off£t
 = 
bvec
.
bv_off£t
 + 
off£t
;

552 
	`shªnÚ_sg_m¬k_’d
(
sg
);

555 
	}
}

557 
	$shªnÚ_cÚv”t_bio
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_bio_t
 *
lbio
, 
logicb_size
)

559 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
;

560 
bio
 *biØğ(biØ*)
lbio
;

561 
bio_vec
 *
bvec
;

562 
i
, 
off£t
, 
»mašed_size
, 
m­_size
 = 0, 
undÚe
 = 0;

564 
·ge_off£t
, 
m­·bË_size
;

566 
»t
 = 0;

568 
sbio
->
bio_size
 = 
	`g‘_bi_size
(
lbio
);

570 
sbio
->
£gm’ts
 = 
	`shªnÚ_bio_£gm’ts
(
lbio
);

571 
sbio
->
sg_couÁ
 = 2 * (((sbio->
bio_size
 + 
logicb_size
 - 1)/logicb_sizeè+ sbio->
£gm’ts
);

573 
sbio
->
sg
 = 
	`shªnÚ_sg_®loc
(sbio->
sg_couÁ
, 
GFP_SHANNON
);

574 ià(
sbio
->
sg
 =ğ
NULL
) {

575 
	`shªnÚ_”r
("alloc sg failed.\n");

576  -
ENOMEM
;

578 
	`shªnÚ_sg_š™_bË
(
sbio
->
sg
, sbio->
sg_couÁ
);

580 
sbio
->
¡¬t_£ùÜ
 = 
	`g‘_bi_£ùÜ
(
lbio
);

582 
sbio
->
fœ¡_size
 = 
logicb_size
 - ((sbio->
¡¬t_£ùÜ
 << 9) & (logicb_size - 1));

583 
sbio
->
fœ¡_size
 = sbio->fœ¡_siz% 
logicb_size
;

584 
sbio
->
fœ¡_size
 = 
	`mš
(sbio->
bio_size
, sbio->first_size);

586 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
i
) {

587 ià(
bvec
->
bv_off£t
 & 0x7) {

588 
sbio
->
Ãed_bounû
 = 1;

590 ià(
bvec
->
bv_Ën
 & 0x7) {

591 
sbio
->
Ãed_bounû
 = 1;

595 ià(
sbio
->
Ãed_bounû
) {

596 
sbio
->
has_hŞe
 = 0;

598 
»t
 = 
	`shªnÚ_®loc_bounû_·ges
(
sbio
->
sg
, sbio->
fœ¡_size
, sbio->
bio_size
);

600 ià(
»t
 <= 0) {

601 
Şd_çshiÚ
;

603 
sbio
->
u£d_sg_couÁ
 = 
»t
;

605 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
)

606 
	`shªnÚ_cİy_bounû_·ges
(
bio
, 
sbio
->
sg
, 1);

612 
Şd_çshiÚ
:

613 
»mašed_size
 = 
sbio
->
fœ¡_size
 ? sbio->fœ¡_siz: 
logicb_size
;

615 
sbio
->
has_hŞe
 = 0;

616 ià(
sbio
->
Ãed_bounû
) {

617 
sbio
->
has_hŞe
 = 1;

618 
sbio
->
Ãed_bounû
 = 0;

621 
sbio
->
u£d_sg_couÁ
 = 0;

622 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
i
) {

625 ià((
i
 !ğ
bio
->
bi_idx
è&& (
bvec
->
bv_off£t
 != 0)) {

626 
sbio
->
has_hŞe
 = 1;

629 ià((
i
 !ğ(
sbio
->
£gm’ts
 - 1)è&& ((
bvec
->
bv_off£t
 + bvec->
bv_Ën
) != 4096)) {

630 
sbio
->
has_hŞe
 = 1;

633 
off£t
 = 0;

635 
·ge_off£t
 = 
bvec
->
bv_off£t
 + 
off£t
;

637 
off£t
 < 
bvec
->
bv_Ën
) {

638 
m­·bË_size
 = 
PAGE_SIZE
 - (
·ge_off£t
 & (PAGE_SIZE -1));

639 ià(
m­·bË_size
 > (
bvec
->
bv_Ën
 - 
off£t
))

640 
m­·bË_size
 = 
bvec
->
bv_Ën
 - 
off£t
;

642 ià(
m­·bË_size
 < 
»mašed_size
) {

643 
m­_size
 = 
m­·bË_size
;

644 
undÚe
 = 1;

646 
m­_size
 = 
»mašed_size
;

647 
undÚe
 = 0;

649 
»mašed_size
 -ğ
m­_size
;

650 ià(
»mašed_size
 == 0)

651 
»mašed_size
 = 
logicb_size
;

652 
sg
 = sg ? 
	`shªnÚ_sg_Ãxt
(sgè: 
sbio
->sg;

653 
	`shªnÚ_sg_£t_·ge
(
sg
, 
bvec
->
bv_·ge
 + (
·ge_off£t
 / 
PAGE_SIZE
), 
m­_size
,…age_offset % PAGE_SIZE);

654 
sbio
->
u£d_sg_couÁ
++;

656 
off£t
 +ğ
m­_size
;

657 
·ge_off£t
 = 
bvec
->
bv_off£t
 + 
off£t
;

660 
	`shªnÚ_sg_m¬k_’d
(
sg
);

663 
	}
}

666 
	$subm™_sbio_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

668 
shªnÚ_bio
 *
sbio
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_bio, 
make_»q_wÜk
);

669 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

670 
»t
;

672 
»t
 = 
	`shªnÚ_subm™_bio
(
sdev
, 
sbio
);

673 ià(
»t
) {

674 
	`shªnÚ_’d_io_acù
(
	`g‘_g’disk_äom_sdev
(
sdev
), 
sbio
->
bio
, 0);

675 ià(
sbio
->
sg
)

676 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

677 
	`shªnÚ_bio_’dio
(
sbio
->
bio
, 
»t
);

678 
	`ä“_sbio
(
sbio
);

680 
	}
}

682 
	$subm™_sbio_sk_ns
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

684 
shªnÚ_bio
 *
sbio
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_bio, 
make_»q_wÜk
);

685 
shªnÚ_Çme¥aû
 *
ns
 = (shªnÚ_Çme¥aû *)
sbio
->
d©a
;

686 
»t
;

688 
»t
 = 
	`shªnÚ_subm™_bio_thrÙšg_ns
(
ns
, 
sbio
);

689 ià(
»t
) {

690 
	`shªnÚ_’d_io_acù
(
	`g‘_g’disk_äom_ns
(
ns
), 
sbio
->
bio
, 0);

691 ià(
sbio
->
sg
)

692 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

693 
	`shªnÚ_bio_’dio
(
sbio
->
bio
, 
»t
);

694 
	`ä“_sbio
(
sbio
);

695 
	`deü—£_ns_³ndšg_bios
(
ns
);

697 
	}
}

699 
shªnÚ_wÜkqueue_¡ruù_t
 *
shªnÚ_³rıu_wq
;

700 
	$shªnÚ_make_»que¡
(
shªnÚ_»que¡_queue_t
 *
q
, 
shªnÚ_bio_t
 *
bio
)

702 
shªnÚ_dev
 *
sdev
 = ((
»que¡_queue
 *)
q
)->
queued©a
;

703 
shªnÚ_bio
 *
sbio
;

704 
»t
;

705 
logicb_size
 = 
	`g‘_logicb_size
(
sdev
);

706 
logicb_shiá
 = 
	`g‘_logicb_shiá
(
sdev
);

708 ià(
	`shªnÚ_check_avaab™y
(
sdev
))

710 
	`shªnÚ_bio_’dio
(
bio
, -
EIO
);

714 ià(
	`uÆik–y
(
	`shªnÚ_should_Œim_bio
(
bio
))) {

716 
u64
 
Œim_¡¬t
 = 
	`g‘_bi_£ùÜ
(
bio
);

717 
u64
 
Œim_’d
 = 
Œim_¡¬t
 + (
	`g‘_bi_size
(
bio
) >> 9);

718 
Œim_¡¬t
 = 
	`_ALIGN_UP
Ñrim_¡¬t, 
logicb_size
/512);

719 
Œim_’d
 = 
	`_ALIGN_DOWN
Ñrim_’d, 
logicb_size
/512);

721 
Œim_¡¬t
 =rim_¡¬ˆ>> (
logicb_shiá
 - 9);

722 
Œim_’d
 =rim_’d >> (
logicb_shiá
 - 9);

723 
	`shªnÚ_disÿrd
(
sdev
, 
Œim_¡¬t
, 
Œim_’d
);

724 
	`shªnÚ_bio_’dio
(
bio
, 0);

728 ià(
	`uÆik–y
(
	`g‘_bi_size
(
bio
) == 0)) {

729 
	`shªnÚ_bio_’dio
(
bio
, 0);

733 ià(
	`uÆik–y
(
	`shªnÚ_disk_»adÚly
(
sdev
)è&& (
	`shªnÚ_bio_d©a_dœ
(
bio
è=ğ
LINUX_BIO_WRITE
)) {

734 
	`shªnÚ_bio_’dio
(
bio
, -
EIO
);

738 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

739 
sbio
->
bio
 = bio;

740 
sbio
->
Ìeq
 = 
NULL
;

741 ià(
	`shªnÚ_bio_d©a_dœ
(
bio
))

742 
sbio
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

744 
sbio
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

745 
	`SHANNON_INIT_LIST_HEAD
(&
sbio
->
glob®_li¡
);

746 
	`£t_sbio_debug_g
(
sbio
, 
MAKE_REQUEST_TAG
);

748 
»t
 = 
	`shªnÚ_cÚv”t_bio
(
sbio
, 
bio
, 
logicb_size
);

749 ià(
»t
)

750 
ä“_sbio
;

752 ià(
	`uÆik–y
(
	`check_ªd_®loc_Ímt
(
	`g‘_shªnÚ_disk_äom_sdev
(
sdev
), 
sbio
, 
logicb_shiá
))) {

753 
»t
 = -
EIO
;

754 
ä“_sg_li¡
;

758 
sbio
->
¡¬t_time
 = 
	`g‘_jiff›s
();

759 
	`shªnÚ_¡¬t_io_acù
(
	`g‘_g’disk_äom_sdev
(
sdev
), 
sbio
->
bio
);

761 ià(
	`lik–y
(
shªnÚ_³rıu_wq
)) {

762 
sbio
->
d©a
 = 
sdev
;

763 
	`shªnÚ_š™_wÜk
(&
sbio
->
make_»q_wÜk
, 
subm™_sbio_sk
);

764 
	`shªnÚ_queue_wÜk
(
shªnÚ_³rıu_wq
, &
sbio
->
make_»q_wÜk
);

766 
»t
 = 
	`shªnÚ_subm™_bio
(
sdev
, 
sbio
);

767 ià(
»t
)

768 
’d_io_acù
;

773 
’d_io_acù
:

774 
	`shªnÚ_’d_io_acù
(
	`g‘_g’disk_äom_sdev
(
sdev
), 
sbio
->
bio
, 0);

775 
ä“_sg_li¡
:

776 ià(
sbio
->
Ãed_bounû
)

777 
	`shªnÚ_ä“_bounû_·ges
(
sbio
->
sg
, sbio->
u£d_sg_couÁ
);

778 ià(
sbio
->
sg
)

779 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

780 
ä“_sbio
:

781 
	`ä“_sbio
(
sbio
);

782 
	`shªnÚ_bio_’dio
(
bio
, 
»t
);

784 
	}
}

786 
shªnÚ_dev
 *
g‘_shªnÚ_dev_äom_ns
(
shªnÚ_Çme¥aû
 *
ns
);

787 
check_sbio_is_ov”wr™ed
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_Çme¥aû
 *
ns
);

788 
	$shªnÚ_make_»que¡_ns
(
shªnÚ_»que¡_queue_t
 *
q
, 
shªnÚ_bio_t
 *
bio
)

790 
shªnÚ_Çme¥aû
 *
ns
 = ((
»que¡_queue
 *)
q
)->
queued©a
;

791 
shªnÚ_bio
 *
sbio
;

792 
»t
;

793 
logicb_size
 = 
	`ns_g‘_logicb_size
(
ns
);

794 
logicb_shiá
 = 
	`ns_g‘_logicb_shiá
(
ns
);

796 
	`šü—£_ns_³ndšg_bios
(
ns
);

797 ià(
	`shªnÚ_check_avaab™y_ns
(
ns
)) {

798 
	`shªnÚ_bio_’dio
(
bio
, -
EIO
);

799 
	`deü—£_ns_³ndšg_bios
(
ns
);

803 ià(
	`uÆik–y
(
	`shªnÚ_should_Œim_bio
(
bio
))) {

805 
u64
 
Œim_¡¬t
 = 
	`g‘_bi_£ùÜ
(
bio
);

806 
u64
 
Œim_’d
 = 
Œim_¡¬t
 + (
	`g‘_bi_size
(
bio
) >> 9);

807 
Œim_¡¬t
 = 
	`_ALIGN_UP
Ñrim_¡¬t, 
logicb_size
/512);

808 
Œim_’d
 = 
	`_ALIGN_DOWN
Ñrim_’d, 
logicb_size
/512);

810 
Œim_¡¬t
 =rim_¡¬ˆ>> (
logicb_shiá
 - 9);

811 
Œim_’d
 =rim_’d >> (
logicb_shiá
 - 9);

812 
	`shªnÚ_disÿrd_ns
(
ns
, 
Œim_¡¬t
, 
Œim_’d
, 0);

813 
	`shªnÚ_bio_’dio
(
bio
, 0);

814 
	`deü—£_ns_³ndšg_bios
(
ns
);

818 ià(
	`uÆik–y
(
	`g‘_bi_size
(
bio
) == 0)) {

819 
	`shªnÚ_bio_’dio
(
bio
, 0);

820 
	`deü—£_ns_³ndšg_bios
(
ns
);

824 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

825 
sbio
->
bio
 = bio;

826 
sbio
->
Ìeq
 = 
NULL
;

827 ià(
	`shªnÚ_bio_d©a_dœ
(
bio
))

828 
sbio
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

830 
sbio
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

831 
	`SHANNON_INIT_LIST_HEAD
(&
sbio
->
glob®_li¡
);

832 
	`£t_sbio_debug_g
(
sbio
, 
MAKE_REQUEST_TAG
);

834 
»t
 = 
	`shªnÚ_cÚv”t_bio
(
sbio
, 
bio
, 
logicb_size
);

835 ià(
»t
)

836 
ä“_sbio
;

838 ià(
	`uÆik–y
(
	`check_ªd_®loc_Ímt
(
	`g‘_shªnÚ_disk_äom_ns
(
ns
), 
sbio
, 
logicb_shiá
))) {

839 
»t
 = -
EIO
;

840 
ä“_sg_li¡
;

843 ià((
	`shªnÚ_bio_d©a_dœ
(
bio
è=ğ
LINUX_BIO_WRITE
)

844 && (
	`uÆik–y
(
	`shªnÚ_disk_»adÚly_ns
(
ns
))

845 || (
	`poŞ_u£d_logicbs
(
	`ns_g‘_poŞ
(
ns
)è> 
	`poŞ_avaabË_ÿp
(ns_get_pool(ns))/8

846 && !
	`check_sbio_is_ov”wr™ed
(
sbio
, 
ns
)))) {

847 
»t
 = -
EIO
;

848 
ä“_sg_li¡
;

852 
sbio
->
¡¬t_time
 = 
	`g‘_jiff›s
();

853 
	`shªnÚ_¡¬t_io_acù
(
	`g‘_g’disk_äom_ns
(
ns
), 
sbio
->
bio
);

855 ià(
	`lik–y
(
shªnÚ_³rıu_wq
)) {

856 
sbio
->
d©a
 = 
ns
;

857 
	`shªnÚ_š™_wÜk
(&
sbio
->
make_»q_wÜk
, 
subm™_sbio_sk_ns
);

858 
	`shªnÚ_queue_wÜk
(
shªnÚ_³rıu_wq
, &
sbio
->
make_»q_wÜk
);

860 
»t
 = 
	`shªnÚ_subm™_bio_thrÙšg_ns
(
ns
, 
sbio
);

861 ià(
»t
)

862 
’d_io_acù
;

867 
’d_io_acù
:

868 
	`shªnÚ_’d_io_acù
(
	`g‘_g’disk_äom_ns
(
ns
), 
sbio
->
bio
, 0);

869 
ä“_sg_li¡
:

870 ià(
sbio
->
sg
)

871 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

872 
ä“_sbio
:

873 
	`ä“_sbio
(
sbio
);

874 
	`shªnÚ_bio_’dio
(
bio
, 
»t
);

875 
	`deü—£_ns_³ndšg_bios
(
ns
);

877 
	}
}

880 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4,4,0)

881 
blk_qc_t
 
	$shªnÚ_make_»que¡_w¿µ”
(
»que¡_queue
 *
q
, 
bio
 *bio)

883 
	`shªnÚ_make_»que¡
(
q
, 
bio
);

884  
BLK_QC_T_NONE
;

885 
	}
}

887 
blk_qc_t
 
	$shªnÚ_make_»que¡_w¿µ”_ns
(
»que¡_queue
 *
q
, 
bio
 *bio)

889 
	`shªnÚ_make_»que¡_ns
(
q
, 
bio
);

890  
BLK_QC_T_NONE
;

891 
	}
}

892 #–ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3,2,0)

893 
	$shªnÚ_make_»que¡_w¿µ”
(
»que¡_queue
 *
q
, 
bio
 *bio)

895 
	`shªnÚ_make_»que¡
(
q
, 
bio
);

896 
	}
}

898 
	$shªnÚ_make_»que¡_w¿µ”_ns
(
»que¡_queue
 *
q
, 
bio
 *bio)

900 
	`shªnÚ_make_»que¡_ns
(
q
, 
bio
);

901 
	}
}

903 
	$shªnÚ_make_»que¡_w¿µ”
(
»que¡_queue
 *
q
, 
bio
 *bio)

905  
	`shªnÚ_make_»que¡
(
q
, 
bio
);

906 
	}
}

908 
	$shªnÚ_make_»que¡_w¿µ”_ns
(
»que¡_queue
 *
q
, 
bio
 *bio)

910  
	`shªnÚ_make_»que¡_ns
(
q
, 
bio
);

911 
	}
}

914 
	#LREQ_IO_GOOD
 1

	)

915 
	#LREQ_IO_ERROR
 0

	)

917 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 25)

919 
šlše
 
	$com¶‘e_bufãrs
(
bio
 *bio, 
¡©us
)

921 
bio
) {

922 
bio
 *
xbh
 = bio->
bi_Ãxt
;

924 
bio
->
bi_Ãxt
 = 
NULL
;

925 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 19)

926 
	`blk_fšished_io
(
	`bio_£ùÜs
(
bio
));

928 
	`shªnÚ_bio_’dio
(
bio
, 
¡©us
 ? 0 : -
EIO
);

929 
bio
 = 
xbh
;

931 
	}
}

933 
	$shªnÚ_’d_»que¡
(
shªnÚ_Ìeq_t
 *
Ìeq
)

935 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

936 
»que¡_queue
 *
q
 = 
rq
->q;

937 
æags
;

939 
	`com¶‘e_bufãrs
(
rq
->
bio
,„q->
”rÜs
);

941 ià(
	`blk_fs_»que¡
(
rq
)) {

942 cÚ¡ 
rw
 = 
	`rq_d©a_dœ
(
rq
);

943 
	`disk_¡©_add
(
rq
->
rq_disk
, 
£ùÜs
[
rw
],„q->
Ä_£ùÜs
);

946 
	`add_disk_¿ndomÃss
(
rq
->
rq_disk
);

947 
	`¥š_lock_œq§ve
(
q
->
queue_lock
, 
æags
);

948 
	`’d_th©_»que¡_Ï¡
(
rq
,„q->
”rÜs
);

949 
	`¥š_uÆock_œq»¡Üe
(
q
->
queue_lock
, 
æags
);

950 
	}
}

952 #–ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 12, 0)

955 
	$shªnÚ_’d_»que¡
(
shªnÚ_Ìeq_t
 *
Ìeq
)

957 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

958 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

959 
	`blk_’d_»que¡_®l
(
rq
,„q->
”rÜs
 ? 0 : -
EIO
);

961 
	`blk_’d_»que¡
(
rq
,„q->
”rÜs
 ? 0 : -
EIO
, 
	`blk_rq_by‹s
(rq));

963 
	}
}

967 
	$shªnÚ_’d_»que¡
(
shªnÚ_Ìeq_t
 *
Ìeq
, 
”rÜ
)

969 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

971 
	`blk_’d_»que¡
(
rq
, 
”rÜ
 ? 0 : -
EIO
, 
	`blk_rq_by‹s
(rq));

972 
	}
}

976 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 12, 0)

977 
	$shªnÚ_£t_Ìeq_”rÜs
(
shªnÚ_Ìeq_t
 *
Ìeq
, 
”rÜs
)

979 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

981 
rq
->
”rÜs
 =ƒrrors;

982 
	}
}

985 
shªnÚ_scsi_’d_io_acù
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
shªnÚ_bio
 *
sbio
, 
du¿tiÚ
);

986 
	$shªnÚ_com¶‘e_fs_io
(*
ho¡d©a
, 
shªnÚ_g’disk_t
 *
gd
, 
shªnÚ_bio
 *
sbio
)

989 ià(
sbio
->
bio
) {

990 ià(
sbio
->
Ãed_bounû
) {

991 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

992 
	`shªnÚ_cİy_bounû_·ges
(
sbio
->
bio
, sbio->
sg
, 0);

993 
	`shªnÚ_ä“_bounû_·ges
(
sbio
->
sg
, sbio->
u£d_sg_couÁ
);

996 
	`shªnÚ_’d_io_acù
(
gd
, 
sbio
->
bio
, 
	`g‘_jiff›s
(è- sbio->
¡¬t_time
);

997 ià(
	`lik–y
(
sbio
->
¡©us
 == 0))

998 
	`shªnÚ_bio_’dio
(
sbio
->
bio
, 0);

1000 
	`shªnÚ_”r
("E¼Ü seùÜs!, stus=0x%x, dma_dœ=%d.\n", 
sbio
->
¡©us
, sbio->
dma_dœ
);

1001 
	`shªnÚ_bio_’dio
(
sbio
->
bio
, -
EIO
);

1003 } ià(
sbio
->
Ìeq
) {

1004 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1005 ià(
	`lik–y
(
sbio
->
¡©us
 == 0))

1006 
	`shªnÚ_£t_Ìeq_”rÜs
(
sbio
->
Ìeq
, 
LREQ_IO_GOOD
);

1008 
	`shªnÚ_£t_Ìeq_”rÜs
(
sbio
->
Ìeq
, 
LREQ_IO_ERROR
);

1009 
	`shªnÚ_”r
("E¼Ü seùÜs!, stus=0x%x.\n", 
sbio
->
¡©us
);

1011 
	`shªnÚ_’d_»que¡
(
sbio
->
Ìeq
);

1013 
	`shªnÚ_’d_»que¡
(
sbio
->
Ìeq
, sbio->
¡©us
 ? 
LREQ_IO_ERROR
 : 
LREQ_IO_GOOD
);

1015 } ià(
sbio
->
scsi_cmnd
) {

1016 
	`shªnÚ_scsi_’d_io_acù
((
shªnÚ_scsi_´iv©e
 *)
ho¡d©a
, 
sbio
, 
	`g‘_jiff›s
(è- sbio->
¡¬t_time
);

1017 ià(
	`lik–y
(
sbio
->
¡©us
 == 0))

1018 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
NULL
);

1020 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_CHECK_CONDITION
, 
NULL
);

1022 
	`shªnÚ_”r
("BUG! A fs sbio isn't„elatedo‡ bio or‡„equest!");

1023 
	`BUG
();

1025 
	}
}

1028 
šlše
 
£ùÜ_t
 
	$shªnÚ_blk_rq_pos
(
»que¡
 *
rq
)

1030 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

1031  
	`blk_rq_pos
(
rq
);

1033  
rq
->
h¬d_£ùÜ
;

1035 
	}
}

1039 
šlše
 
	$shªnÚ_blk_rq_by‹s
(
»que¡
 *
rq
)

1041 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

1042  
	`blk_rq_by‹s
(
rq
);

1044 ià(
	`blk_fs_»que¡
(
rq
))

1045  
rq
->
h¬d_Ä_£ùÜs
 << 9;

1046  
rq
->
d©a_Ën
;

1048 
	}
}

1050 
	$shªnÚ_Ìeq_£gm’ts
(
shªnÚ_Ìeq_t
 *
Ìeq
)

1052 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

1053 
bio
 *biØğ
NULL
;

1054 
£gm’ts
 = 0;

1056 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

1057 
	`__rq_fÜ_—ch_bio
(
bio
, 
rq
)

1058 
£gm’ts
 +ğ
	`shªnÚ_bio_£gm’ts
(
bio
);

1060 
	`rq_fÜ_—ch_bio
(
bio
, 
rq
)

1061 
£gm’ts
 +ğ
	`shªnÚ_bio_£gm’ts
(
bio
);

1064  
£gm’ts
;

1065 
	}
}

1067 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 14, 0)

1068 
	$shªnÚ_cÚv”t_Ìeq
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_Ìeq_t
 *
Ìeq
)

1070 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
;

1071 
bio_vec
 
bvec
;

1072 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

1073 
i
, 
off£t
, 
»mašed_size
, 
m­_size
 = 0, 
undÚe
 = 0;

1074 
logicb_size
 = 
	`g‘_logicb_size
(
sdev
);

1075 
»q_™”©Ü
 
™”
;

1077 
sbio
->
£gm’ts
 = 
	`shªnÚ_Ìeq_£gm’ts
(
Ìeq
);

1078 
sbio
->
sg_couÁ
 = 2 * sbio->
£gm’ts
 + 1;

1079 
sbio
->
sg
 = 
	`shªnÚ_sg_®loc
(sbio->
sg_couÁ
, 
GFP_SHANNON
);

1080 ià(
sbio
->
sg
 =ğ
NULL
) {

1081 
	`shªnÚ_”r
("alloc sg failed.\n");

1082  -
ENOMEM
;

1084 
	`shªnÚ_sg_š™_bË
(
sbio
->
sg
, sbio->
sg_couÁ
);

1086 
sbio
->
bio_size
 = 
	`shªnÚ_blk_rq_by‹s
(
rq
);

1087 
sbio
->
¡¬t_£ùÜ
 = 
	`shªnÚ_blk_rq_pos
(
rq
);

1089 
sbio
->
fœ¡_size
 = 
logicb_size
 - ((sbio->
¡¬t_£ùÜ
 << 9) & (logicb_size - 1));

1090 
sbio
->
fœ¡_size
 = sbio->fœ¡_siz% 
logicb_size
;

1091 
sbio
->
fœ¡_size
 = 
	`mš
(sbio->
bio_size
, sbio->first_size);

1094 
»mašed_size
 = 
sbio
->
fœ¡_size
 ? sbio->fœ¡_siz: 
logicb_size
;

1096 
sbio
->
has_hŞe
 = 0;

1097 
sbio
->
u£d_sg_couÁ
 = 0;

1099 
i
 = 0;

1100 
	`rq_fÜ_—ch_£gm’t
(
bvec
, 
rq
, 
™”
)

1103 ià((
i
 !ğ0è&& (
bvec
.
bv_off£t
 != 0))

1104 
sbio
->
has_hŞe
 = 1;

1106 ià((
i
 !ğ(
sbio
->
£gm’ts
 - 1)è&& ((
bvec
.
bv_off£t
 + bvec.
bv_Ën
) != 4096))

1107 
sbio
->
has_hŞe
 = 1;

1109 
off£t
 = 0;

1110 
off£t
 < 
bvec
.
bv_Ën
) {

1111 ià((
bvec
.
bv_Ën
 - 
off£t
è< 
»mašed_size
) {

1112 
m­_size
 = 
bvec
.
bv_Ën
 - 
off£t
;

1113 
undÚe
 = 1;

1115 
m­_size
 = 
»mašed_size
;

1116 
undÚe
 = 0;

1118 
»mašed_size
 -ğ
m­_size
;

1119 ià(
»mašed_size
 == 0)

1120 
»mašed_size
 = 
logicb_size
;

1121 
sg
 = sg ? 
	`shªnÚ_sg_Ãxt
(sgè: 
sbio
->sg;

1122 
	`shªnÚ_sg_£t_·ge
(
sg
, 
bvec
.
bv_·ge
, 
m­_size
, bvec.
bv_off£t
 + 
off£t
);

1123 
sbio
->
u£d_sg_couÁ
++;

1125 
off£t
 +ğ
m­_size
;

1127 
i
++;

1130 
	`shªnÚ_sg_m¬k_’d
(
sg
);

1133 
	}
}

1135 
	$shªnÚ_cÚv”t_Ìeq
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_Ìeq_t
 *
Ìeq
)

1137 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
;

1138 
bio_vec
 *
bvec
;

1139 
»que¡
 *
rq
 = (»que¡ *)
Ìeq
;

1140 
i
, 
off£t
, 
»mašed_size
, 
m­_size
 = 0, 
undÚe
 = 0;

1141 
logicb_size
 = 
	`g‘_logicb_size
(
sdev
);

1142 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

1143 
»q_™”©Ü
 
™”
;

1145 
bio
 *bio;

1146 
j
;

1149 
sbio
->
£gm’ts
 = 
	`shªnÚ_Ìeq_£gm’ts
(
Ìeq
);

1150 
sbio
->
sg_couÁ
 = 2 * sbio->
£gm’ts
 + 1;

1151 
sbio
->
sg
 = 
	`shªnÚ_sg_®loc
(sbio->
sg_couÁ
, 
GFP_SHANNON
);

1152 ià(
sbio
->
sg
 =ğ
NULL
) {

1153 
	`shªnÚ_”r
("alloc sg failed.\n");

1154  -
ENOMEM
;

1156 
	`shªnÚ_sg_š™_bË
(
sbio
->
sg
, sbio->
sg_couÁ
);

1158 
sbio
->
bio_size
 = 
	`shªnÚ_blk_rq_by‹s
(
rq
);

1159 
sbio
->
¡¬t_£ùÜ
 = 
	`shªnÚ_blk_rq_pos
(
rq
);

1161 
sbio
->
fœ¡_size
 = 
logicb_size
 - ((sbio->
¡¬t_£ùÜ
 << 9) & (logicb_size - 1));

1162 
sbio
->
fœ¡_size
 = sbio->fœ¡_siz% 
logicb_size
;

1163 
sbio
->
fœ¡_size
 = 
	`mš
(sbio->
bio_size
, sbio->first_size);

1166 
»mašed_size
 = 
sbio
->
fœ¡_size
 ? sbio->fœ¡_siz: 
logicb_size
;

1168 
sbio
->
has_hŞe
 = 0;

1169 
sbio
->
u£d_sg_couÁ
 = 0;

1171 
i
 = 0;

1172 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

1173 
	`rq_fÜ_—ch_£gm’t
(
bvec
, 
rq
, 
™”
)

1175 
	`rq_fÜ_—ch_bio
(
bio
, 
rq
)

1176 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
j
)

1180 ià((
i
 !ğ0è&& (
bvec
->
bv_off£t
 != 0))

1181 
sbio
->
has_hŞe
 = 1;

1183 ià((
i
 !ğ(
sbio
->
£gm’ts
 - 1)è&& ((
bvec
->
bv_off£t
 + bvec->
bv_Ën
) != 4096))

1184 
sbio
->
has_hŞe
 = 1;

1186 
off£t
 = 0;

1187 
off£t
 < 
bvec
->
bv_Ën
) {

1188 ià((
bvec
->
bv_Ën
 - 
off£t
è< 
»mašed_size
) {

1189 
m­_size
 = 
bvec
->
bv_Ën
 - 
off£t
;

1190 
undÚe
 = 1;

1192 
m­_size
 = 
»mašed_size
;

1193 
undÚe
 = 0;

1195 
»mašed_size
 -ğ
m­_size
;

1196 ià(
»mašed_size
 == 0)

1197 
»mašed_size
 = 
logicb_size
;

1198 
sg
 = sg ? 
	`shªnÚ_sg_Ãxt
(sgè: 
sbio
->sg;

1199 
	`shªnÚ_sg_£t_·ge
(
sg
, 
bvec
->
bv_·ge
, 
m­_size
, bvec->
bv_off£t
 + 
off£t
);

1200 
sbio
->
u£d_sg_couÁ
++;

1202 
off£t
 +ğ
m­_size
;

1204 
i
++;

1207 
	`shªnÚ_sg_m¬k_’d
(
sg
);

1210 
	}
}

1213 
	$shªnÚ_disk_xãr_»que¡
(
shªnÚ_dev
 *
sdev
, 
»que¡
 *
rq
)

1215 
»t
;

1216 
shªnÚ_bio
 *
sbio
 = 
NULL
;

1217 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

1218 
logicb_size
 = 
	`g‘_logicb_size
(
sdev
);

1219 
logicb_shiá
 = 
	`g‘_logicb_shiá
(
sdev
);

1223 ià(
	`shªnÚ_check_avaab™y
(
sdev
))

1225 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1226 
rq
->
”rÜs
 = 
LREQ_IO_ERROR
;

1227 
	`shªnÚ_’d_»que¡
(
rq
);

1229 
	`shªnÚ_’d_»que¡
(
rq
, 
LREQ_IO_ERROR
);

1234 #ià
LINUX_VERSION_CODE
 <ğ
	`KERNEL_VERSION
(2, 6, 19)

1235 ià(!
	`blk_fs_»que¡
(
rq
))

1236 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 11, 0)

1237 ià(
rq
->
cmd_ty³
 !ğ
REQ_TYPE_FS
)

1239 ià(
	`blk_rq_is_·s¡hrough
(
rq
))

1242 
	`debugs1
("skip‚on-fs„equest.\n");

1243 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1244 
rq
->
”rÜs
 = 
LREQ_IO_ERROR
;

1245 
	`shªnÚ_’d_»que¡
(
rq
);

1247 
	`shªnÚ_’d_»que¡
(
rq
, 
LREQ_IO_ERROR
);

1252 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

1253 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4, 8, 0)

1254 ià(
	`uÆik–y
(
	`»q_İ
(
rq
è=ğ
REQ_OP_DISCARD
)) {

1256 ià(
	`uÆik–y
(
rq
->
cmd_æags
 & 
REQ_DISCARD
)) {

1259 
u64
 
Œim_¡¬t
 = 
	`shªnÚ_blk_rq_pos
(
rq
);

1260 
u64
 
Œim_’d
 = 
Œim_¡¬t
 + (
	`shªnÚ_blk_rq_by‹s
(
rq
) >> 9);

1261 
Œim_¡¬t
 = 
	`_ALIGN_UP
Ñrim_¡¬t, 
logicb_size
/512);

1262 
Œim_’d
 = 
	`_ALIGN_DOWN
Ñrim_’d, 
logicb_size
/512);

1264 
Œim_¡¬t
 =rim_¡¬ˆ>> (
logicb_shiá
 - 9);

1265 
Œim_’d
 =rim_’d >> (
logicb_shiá
 - 9);

1266 
	`shªnÚ_disÿrd
(
sdev
, 
Œim_¡¬t
, 
Œim_’d
);

1267 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1268 
rq
->
”rÜs
 = 
LREQ_IO_GOOD
;

1269 
	`shªnÚ_’d_»que¡
(
rq
);

1271 
	`shªnÚ_’d_»que¡
(
rq
, 
LREQ_IO_GOOD
);

1277 ià(
	`uÆik–y
(
	`shªnÚ_blk_rq_by‹s
(
rq
) == 0)) {

1278 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1279 
rq
->
”rÜs
 = 
LREQ_IO_GOOD
;

1280 
	`shªnÚ_’d_»que¡
(
rq
);

1282 
	`shªnÚ_’d_»que¡
(
rq
, 
LREQ_IO_GOOD
);

1287 ià(
	`uÆik–y
(
	`shªnÚ_disk_»adÚly
(
sdev
)è&& (
	`rq_d©a_dœ
(
rq
è=ğ
LREQ_WRITE
)) {

1288 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1289 
rq
->
”rÜs
 = 
LREQ_IO_ERROR
;

1290 
	`shªnÚ_’d_»que¡
(
rq
);

1292 
	`shªnÚ_’d_»que¡
(
rq
, 
LREQ_IO_ERROR
);

1297 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

1298 
sbio
->
bio
 = 
NULL
;

1299 
sbio
->
Ìeq
 = 
rq
;

1300 ià(
	`rq_d©a_dœ
(
rq
))

1301 
sbio
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

1303 
sbio
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1304 
	`£t_sbio_debug_g
(
sbio
, 
LINUX_REQ_TAG
);

1306 
»t
 = 
	`shªnÚ_cÚv”t_Ìeq
(
sdev
, 
sbio
, 
rq
);

1307 ià(
»t
)

1308 
ä“_sbio
;

1310 
»t
 = 
	`shªnÚ_subm™_bio
(
sdev
, 
sbio
);

1311 ià(
»t
)

1312 
ä“_sg_li¡
;

1316 
ä“_sg_li¡
:

1317 ià(
sbio
->
sg
)

1318 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

1319 
ä“_sbio
:

1320 
	`ä“_sbio
(
sbio
);

1321 ià(
»t
 =ğ-
ENOMEM
) {

1323  -
ENOMEM
;

1325 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1326 
rq
->
”rÜs
 = 
LREQ_IO_ERROR
;

1327 
	`shªnÚ_’d_»que¡
(
rq
);

1329 
	`shªnÚ_’d_»que¡
(
rq
, 
LREQ_IO_ERROR
);

1334 
	}
}

1336 
	$shªnÚ_disk_»que¡
(
»que¡_queue
 *
q
)

1338 
shªnÚ_dev
 *
sdev
 = 
q
->
queued©a
;

1339 
»que¡
 *
rq
;

1340 
»t
;

1342 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

1343 (
rq
 = 
	`blk_³ek_»que¡
(
q
))) {

1344 
	`blk_¡¬t_»que¡
(
rq
);

1346 (
rq
 = 
	`–v_Ãxt_»que¡
(
q
))) {

1347 
	`blkdev_dequeue_»que¡
(
rq
);

1349 
	`¥š_uÆock_œq
(
q
->
queue_lock
);

1351 
»t
 = 
	`shªnÚ_disk_xãr_»que¡
(
sdev
, 
rq
);

1352 ià(
»t
 =ğ-
ENOMEM
) {

1353 
	`¥š_lock_œq
(
q
->
queue_lock
);

1354 
	`blk_»queue_»que¡
(
q
, 
rq
);

1355 
	`¥š_uÆock_œq
(
q
->
queue_lock
);

1357 
	`¥š_lock_œq
(
q
->
queue_lock
);

1359 
	}
}

1361 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(4, 18, 0)

1362 
	$shªnÚ_–ev©Ü_chªge
(
»que¡_queue
 *
q
, *
Çme
)

1364 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 36)

1365 
	`–ev©Ü_ex™
(
q
->
–ev©Ü
);

1366 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

1367  
	`–ev©Ü_chªge
(
q
, 
Çme
);

1369 
	`–ev©Ü_ex™
(
q
, q->
–ev©Ü
);

1372 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 32)

1373 
q
->
–ev©Ü
 = 
NULL
;

1375  
	`–ev©Ü_š™
(
q
, 
Çme
);

1376 
	}
}

1379 
shªnÚ_»que¡_queue_t
 *
	$shªnÚ_š™_queue
(*
d©a
, 
shªnÚ_¥šlock_t
 *
lock
)

1381 
»que¡_queue
 *
queue
 = 
NULL
;

1383 
	`shªnÚ_¥š_lock_š™
(
lock
);

1384 
queue
 = 
	`blk_š™_queue
((
»que¡_â_´oc
 *)
shªnÚ_disk_»que¡
,

1385 (
¥šlock_t
 *)
lock
);

1387 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 18, 0)

1388 ià(
queue
) {

1389 
–ev©Ü_Çme
[] = "noop";

1390 ià(
	`shªnÚ_–ev©Ü_chªge
(
queue
, 
–ev©Ü_Çme
)) {

1391 
	`shªnÚ_”r
("Failedo initialize‚oop io scheduler.\n");

1392 
	`blk_ş—nup_queue
(
queue
);

1393 
queue
 = 
NULL
;

1395 
	`shªnÚ_šfo
("using‚oop io scheduler.\n");

1396 
queue
->
queued©a
 = 
d©a
;

1401  
queue
;

1402 
	}
}

1404 
shªnÚ_»que¡_queue_t
 *
	$shªnÚ_®loc_queue
(*
d©a
, 
ns
)

1406 
»que¡_queue
 *
queue
 = 
NULL
;

1408 
queue
 = 
	`blk_®loc_queue
(
GFP_SHANNON
);

1409 ià(
queue
) {

1410 ià(
ns
)

1411 
	`blk_queue_make_»que¡
(
queue
, 
shªnÚ_make_»que¡_w¿µ”_ns
);

1413 
	`blk_queue_make_»que¡
(
queue
, 
shªnÚ_make_»que¡_w¿µ”
);

1414 
queue
->
queued©a
 = 
d©a
;

1417  
queue
;

1418 
	}
}

1420 
shªnÚ_»que¡_queue_t
 *
	$shªnÚ_ü—‹_blkqueue
(*
d©a
, 
shªnÚ_¥šlock_t
 *
lock
, 
ns
)

1422 ià(
shªnÚ_u£_iosched
)

1423  
	`shªnÚ_š™_queue
(
d©a
, 
lock
);

1425  
	`shªnÚ_®loc_queue
(
d©a
, 
ns
);

1426 
	}
}

	@shannon_block.h

1 #iâdeà
__SHANNON_BLOCK_H


2 
	#__SHANNON_BLOCK_H


	)

4 
	~"shªnÚ_li¡.h
"

5 
	~"shªnÚ_cÚfig.h
"

6 
	~"shªnÚ_kcÜe.h
"

7 
	~"shªnÚ_sÿ‰”.h
"

8 
	~"shªnÚ_dma.h
"

9 
	~"shªnÚ_wÜkqueue.h
"

10 
	~"shªnÚ_scsi.h
"

13 
	tshªnÚ_g’disk_t
;

14 
	tshªnÚ_»que¡_queue_t
;

15 
	tshªnÚ_bio_t
;

16 
	tshªnÚ_Ìeq_t
;

17 
	tshªnÚ_£ùÜ_t
;

18 
u32
 
	tlogicb_t
;

19 
u64
 
	tlogicb64_t
;

21 
	#_ALIGN_UP
(
addr
,
size
è((×ddr)+((
	`ty³of
×ddr))(size)-1))&(~(Ñy³of×ddr))(size)-1)))

	)

22 
	#_ALIGN_DOWN
(
addr
,
size
è(×ddr)&(~((
	`ty³of
×ddr))(size)-1)))

	)

24 
	#MAKE_REQUEST_TAG
 0x7878787878780000

	)

25 
	#LINUX_REQ_TAG
 0xdefdefdefdef0000

	)

27 
	#LINUX_BIO_READ
 0

	)

28 
	#LINUX_BIO_WRITE
 1

	)

30 
	#LREQ_READ
 0

	)

31 
	#LREQ_WRITE
 1

	)

34 
	gshªnÚ_Çme¥aû
;

35 
	sshªnÚ_bio
 {

36 #ifdeà
CONFIG_SHANNON_DEBUG


37 
	mg
;

38 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


39 
shªnÚ_li¡_h—d
 
	mdebug_li¡
;

42 
	m¡¬t_time
;

43 
shªnÚ_©omic_t
 
	mu£r_couÁ
;

44 
	mdma_dœ
;

45 
	mcÜ»ùed_b™s
;

46 
	#HAVE_BLANK_SECTOR
 1

	)

47 
	#HAVE_ERROR_SECTOR
 2

	)

48 
	m¡©us
;

49 
	#BUFFER_WRITE
 1

	)

50 
	#DIRECT_WRITE
 2

	)

51 
	mwr™e_m‘hod
;

53 
shªnÚ_£ùÜ_t
 
	m¡¬t_£ùÜ
;

54 
	mbio_size
;

55 
	mfœ¡_size
;

56 
	mhas_hŞe
;

57 
logicb_t
 
	mlogicbs
;

58 
	m£gm’ts
;

60 
u16
 
	mns_id
;

61 
u16
 
	mns_£q_num
;

62 
	mwa™_dev_pick_mask
;

64 
shªnÚ_wÜk_¡ruù
 
	mmake_»q_wÜk
;

65 
shªnÚ_wÜk_¡ruù
 
	mcb_wÜk
;

66 (*
	mÿÎback
)(
shªnÚ_bio
 *
	msbio
);

67 *
	md©a
;

68 *
	md©a2
;

69 
	mmay_¦“p_š_ÿÎback
;

72 *
	mvœt_addr
;

73 
shªnÚ_dma_addr_t
 
	mdma_add»ss
;

75 
	mÏ‹ncy
;

76 
shªnÚ_li¡_h—d
 
	m»q_li¡
;

77 
shªnÚ_li¡_h—d
 
	mglob®_li¡
;

79 
shªnÚ_bio_t
 *
	mbio
;

80 
shªnÚ_Ìeq_t
 *
	mÌeq
;

81 
	msg_couÁ
;

82 
	mu£d_sg_couÁ
;

83 
shªnÚ_sg_li¡_t
 *
	msg
;

85 
	mov”Ïp
;

86 
	mÃed_bounû
;

89 
shªnÚ_scsi_´iv©e
 *
	mho¡d©a
;

90 *
	mscsi_cmnd
;

91 *
	mcmd
;

92 
shªnÚ_wÜk_¡ruù
 
	mscsi_wÜk
;

96 
shªnÚ_bio
 *
®loc_sbio
(
gå_t
 
gå_mask
);

97 
ä“_sbio
(
shªnÚ_bio
 *
sbio
);

99 #ifdeà
CONFIG_SHANNON_DEBUG


100 
£t_sbio_debug_g
(
shªnÚ_bio
 *, );

102 
šlše
 
	$£t_sbio_debug_g
(
shªnÚ_bio
 *
sbio
, 
g
){
	}
}

106 
shªnÚ_g’disk_t
 *
shªnÚ_®loc_disk
(
mšÜs
);

107 
shªnÚ_š™_g’disk
(
shªnÚ_g’disk_t
 *
disk
, *
Çme
, 
majÜ
, 
mšÜ_¥ª
, 
fœ¡_mšÜ
, 
shªnÚ_»que¡_queue_t
 *
rq
, *
´i
);

108 
shªnÚ_£t_ÿ·c™y
(
shªnÚ_g’disk_t
 *
disk
, 
shªnÚ_£ùÜ_t
 
size
);

109 
shªnÚ_£t_disk_ro
(
shªnÚ_g’disk_t
 *
disk
, 
æag
);

110 
shªnÚ_put_disk
(
shªnÚ_g’disk_t
 *
disk
);

111 
shªnÚ_add_disk
(
shªnÚ_g’disk_t
 *
disk
);

112 
shªnÚ_d–_g’disk
(
shªnÚ_g’disk_t
 *
gp
);

115 
shªnÚ_»gi¡”_blkdev
(
majÜ
, cÚ¡ *
Çme
);

116 
shªnÚ_uÄegi¡”_blkdev
(
majÜ
, cÚ¡ *
Çme
);

118 
	gshªnÚ_Çme¥aû
;

121 
	gshªnÚ_dev
;

122 
	gshªnÚ_disk
;

123 
shªnÚ_»que¡_queue_t
 *
shªnÚ_ü—‹_blkqueue
(*, 
shªnÚ_¥šlock_t
 *
lock
, );

124 
shªnÚ_blk_queue_block_size
(
shªnÚ_»que¡_queue_t
 *
queue
, , );

125 
shªnÚ_blk_queue_max_hw_£ùÜs
(
shªnÚ_»que¡_queue_t
 *, );

126 
shªnÚ_blk_queue_io_mš
(
shªnÚ_»que¡_queue_t
 *
queue
, 
mš
);

127 
shªnÚ_blk_queue_io_İt
(
shªnÚ_»que¡_queue_t
 *
queue
, 
İt
);

128 
shªnÚ_blk_ş—nup_queue
(
shªnÚ_»que¡_queue_t
 *
q
);

129 
shªnÚ_Œim_£‰šg
(
shªnÚ_»que¡_queue_t
 *
queue
);

130 
shªnÚ_rÙ©iÚ®_£‰šg
(
shªnÚ_»que¡_queue_t
 *
queue
);

133 
	#BIO_RW_PRIO
 16

	)

134 
shªnÚ_£ùÜ_t
 
g‘_bi_£ùÜ
(
shªnÚ_bio_t
 *
bio
);

135 
shªnÚ_bio_æagged
(
shªnÚ_bio_t
 *
bio
, 
æag
);

136 
shªnÚ_bio_d©a_dœ
(
shªnÚ_bio_t
 *
bio
);

137 
shªnÚ_com¶‘e_fs_io
(*
ho¡d©a
, 
shªnÚ_g’disk_t
 *
gd
, 
shªnÚ_bio
 *
sbio
);

140 
’d_scsi_cmnd
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_scsi_cmd_¡©us
 
¡©us
, *
buf
);

	@shannon_buffer.c

13 #ifdeà
SHANNON_USE_WRITE_BUFFER


15 
	$¶ug_bufq
(
shªnÚ_dev
 *
sdev
)

17 
sdev
->
bufq_¶ugged
 = 1;

18 
	}
}

20 
	$uÅlug_bufq
(
shªnÚ_dev
 *
sdev
)

22 
sdev
->
bufq_¶ugged
 = 0;

23 
	}
}

25 
	$bufq_queue_d•th
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

27  (
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
] + 
QUEUE_SIZE
 - sdev->
bufq_cq_
[head_index]) % QUEUE_SIZE;

28 
	}
}

30 
	$down_bufq_lim™
(
shªnÚ_dev
 *
sdev
, 
low_bound
, 
¡•
)

32 
sdev
->
bufãr_wr™e_lim™
 -ğ
¡•
;

33 ià(
sdev
->
bufãr_wr™e_lim™
 <ğ
low_bound
)

34 
sdev
->
bufãr_wr™e_lim™
 = 
low_bound
;

35 
	}
}

37 
	$up_bufq_lim™
(
shªnÚ_dev
 *
sdev
, 
high_bound
, 
¡•
)

39 
sdev
->
bufãr_wr™e_lim™
 +ğ
¡•
;

40 ià(
sdev
->
bufãr_wr™e_lim™
 >ğ
high_bound
)

41 
sdev
->
bufãr_wr™e_lim™
 = 
high_bound
;

42 
	}
}

44 
	tA¼ay
[2];

45 
	gbufq_lim™_bound_512
[3][2] = {

51 
	gbufq_lim™_bound_4k
[3][2] = {

57 
	#ALL_DIRECT_WRITE_512
 1100

	)

58 
	#ALL_DIRECT_WRITE_4K
 780

	)

59 
	$upd©e_bufq_lim™
(
shªnÚ_dev
 *
sdev
)

61 
³ndšg_wr™es
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_æight_wr™es
è+ shªnÚ_©omic_»ad(&sdev->
gc_š_æight
);

62 
cu¼’t_d•th
, 
šdex
;

63 
A¼ay
 *
bound
;

65 ià(
sdev
->
logicb_size
 == 512)

66 
šdex
 = 
³ndšg_wr™es
 / (
ALL_DIRECT_WRITE_512
 / 3);

68 
šdex
 = 
³ndšg_wr™es
 / (
ALL_DIRECT_WRITE_4K
 / 3);

69 ià(
šdex
 >= 3) {

70 
sdev
->
bufãr_wr™e_lim™
 = 0;

74 ià(
sdev
->
logicb_size
 == 512)

75 
bound
 = &
bufq_lim™_bound_512
[0];

77 
bound
 = &
bufq_lim™_bound_4k
[0];

79 
cu¼’t_d•th
 = 
	`bufq_queue_d•th
(
sdev
, 0) + bufq_queue_depth(sdev, 1);

80 ià(
cu¼’t_d•th
 == 0)

81 
	`up_bufq_lim™
(
sdev
, 
bound
[
šdex
][1], (3 - index) * 24);

82 ià(
cu¼’t_d•th
 > 
sdev
->
logicbs_š_chunk
 * 24)

83 
	`down_bufq_lim™
(
sdev
, 
bound
[
šdex
][0], 1);

84 
	}
}

87 
	$bufq_Œaffic_jam
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

89 ià(
	`uÆik–y
(
sdev
->
bufq_¶ugged
 == 1))

92 ià(
	`bufq_queue_d•th
(
sdev
, 
h—d_šdex
è> sdev->
bufãr_wr™e_lim™
)

96 
	}
}

99 
	$bufq_Œaffic_low”
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

102 ià(
sdev
->
bufq_sq_h—d
[
h—d_šdex
] =ğsdev->
bufq_cq_
[head_index])

106 
	}
}

108 
	$upd©e_bufq_sq_h—d
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

110 ià(
sdev
->
bufq_sq_hw_h—d
[
h—d_šdex
] !ğsdev->
bufq_sq_h—d
[head_index]) {

111 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
bufq_b¬_lock
[
h—d_šdex
]);

112 
	`shªnÚ_£t_b™
(
sdev
->
šŒ_big_shiá
[
h—d_šdex
], sdev->
pÙ’tŸl_š‹¼u±_veùÜs
);

113 
	`shªnÚ_£t_b™
(
sdev
->
bufq_ack_šŒ_shiá
, sdev->
pÙ’tŸl_š‹¼u±_veùÜs
);

114 
sdev
->
bufq_sq_hw_h—d
[
h—d_šdex
] = sdev->
bufq_sq_h—d
[head_index];

115 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

116 
	`shªnÚ_wake_up
(&
sdev
->
bufq_emu_wa™
[
h—d_šdex
]);

118 
	`wr™e_»g_§ã
(
sdev
, sdev->
bufq_sq_hw_h—d
[
h—d_šdex
], &sdev->
bufq_b¬
[h—d_šdex]->
sq_h—d
);

120 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
bufq_b¬_lock
[
h—d_šdex
]);

122 
	}
}

128 
	$bufq_®loc_cmd
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
couÁ
)

130 
»t
 = -
EBUSY
;

131 
bufq_cq_
 = 
sdev
->bufq_cq_[
h—d_šdex
];

135 ià(
bufq_cq_
 =ğ
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
]) {

136 
»t
 = 
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
];

137 
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
] = (sdev->bufq_sq_h—d_tmp[h—d_šdex] + (
couÁ
 << 3)è% 
QUEUE_SIZE
;

138 
out
;

141 ià(((
bufq_cq_
 + 
QUEUE_SIZE
è- 
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
]è% QUEUE_SIZE <ğ(
couÁ
 << 3)) {

142 
out
;

144 
»t
 = 
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
];

145 
sdev
->
bufq_sq_h—d_tmp
[
h—d_šdex
] = (sdev->bufq_sq_h—d_tmp[h—d_šdex] + (
couÁ
 << 3)è% 
QUEUE_SIZE
;

146 
out
;

148 
out
:

149  
»t
;

150 
	}
}

157 
	$bufq_®loc_cmd_¦“·bË
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
couÁ
)

159 
cmd_off£t
;

161 
	`shªnÚ_wa™_ev’t
(
sdev
->
bufq_wa™_cmd_pos
[
h—d_šdex
], (
cmd_off£t
 = 
	`bufq_®loc_cmd
(sdev, h—d_šdex, 
couÁ
)) >= 0);

162 ià(
	`uÆik–y
(
cmd_off£t
 < 0))

163  -
EINTR
;

165 
	`ş—r_commªd_queue
((
u64
 *)
sdev
->
bufq_sq_addr
[
h—d_šdex
], 
cmd_off£t
, 
couÁ
, 0);

166 ià(
has_dma_d–ay
)

167 
	`ş—r_commªd_queue
((
u64
 *)
sdev
->
bufq_cq_addr
[
h—d_šdex
], 
cmd_off£t
, 
couÁ
, 
COMP_QUEUE_FILL
);

169  
cmd_off£t
;

170 
	}
}

172 
	$shªnÚ_»ad_buf_cmd
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

174 
shªnÚ_buf_cmd
 *
»ad
;

175 
cmd_off£t
, 
cmdid
, 
couÁ
;

176 
u64
 *
±e
;

177 
h—d_šdex
 = 
	`g‘_h—d_šdex_š_bufq
(
sdev
, &
»q
->
pba
);

178 
eblk
 = 
»q
->
pba
.
lun_pba
/(
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

179 
»t
;

180 
is_ov”Ïp
 = 0;

182 ià(
sdev
->
ov”Ïp_wr™e
 && 
	`pba_is_equ®
(&
»q
->
pba
, &sdev->
ov”Ïp
->pba)) {

183 
h—d_šdex
 = 
HOT_INDEX
;

184 
is_ov”Ïp
 = 1;

187 ià(
h—d_šdex
 < 0)

189 
couÁ
 = (
»q
->
dma_add»ss_2
)? 3 : 2;

190 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[
h—d_šdex
]);

191 ià(
is_ov”Ïp
) {

192 
u64
 
_m‘ad©a
 = (((u64)
lba_ty³
[
sdev
->
lba_fÜm©
]è<< 
DATATYPE_SHIFT
) | \

193 (((
u64
)
»q
->
ns_id
 & 
NS_ID_MASK
è<< 
NS_ID_SHIFT
) | \

194 (((
u64
)
»q
->
ns_£q_num
 & 
NS_SEQ_NUM_MASK
è<< 
NS_SEQ_NUM_SHIFT
) | \

195 (
»q
->
lba
 & 
LONG_LBA_MASK
);

196 
	`BUG_ON
(
_m‘ad©a
 =ğ
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
]);

197 ià(
»q
->
£nd”
 =ğ
FROM_OVERLAP
)

198 
	`BUG_ON
(
_m‘ad©a
 !ğ
sdev
->
ov”Ïp
->
bufãd_m‘ad©a
);

199 ià(
_m‘ad©a
 !ğ
sdev
->
ov”Ïp
->
bufãd_m‘ad©a
) {

200 
shªnÚ_poŞ
 *
¥oŞ
 = 
NULL
;

201 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

202 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

204 ià(
	`uÆik–y
(
»q
->
ov”Ïp_»adtimes
 - 99) % 100 == 99) {

205 
	`shªnÚ_w¬n
("req->lba=%lu, metadata=0x%16llx,„eadtimes=%d, buffed_metadata=%lu, _metadata=%lu.\n", \

206 
»q
->
lba
, 
_m‘ad©a
,„eq->
ov”Ïp_»adtimes
, 
sdev
->
ov”Ïp
->
bufãd_m‘ad©a
, \

207 
sdev
->
ov”Ïp
->
_m‘ad©a
);

208 
	`shªnÚ_m¦“p
(1);

210 
»q
->
ov”Ïp_»adtimes
++;

211 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

212 ià(
¥oŞ
) {

213 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

214 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

215 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

216 
	`BUG
();

218 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

219 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

220 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

221 
	`BUG
();

223 
sdisk
 = &
ns
->sdisk;

226 
	`Ímt_lock
(
sdev
, &sdev->
sdisk
, 
»q
->
lba
);

227 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, 
NULL
, 
sdisk
);

228 
	`Ímt_uÆock
(
sdev
, &sdev->
sdisk
, 
»q
->
lba
);

229 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

230 ià(
»t
 < 0) {

231 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[
h—d_šdex
]);

232 
	`shªnÚ_log
("%s:†b¨%x may bdisÿrded. Ju¡ ignÜ™.\n", 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
lba
);

233 
»q
->
¡©e
 = 
REQ_DONE
;

234 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

237 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
 / sdev->
logicbs_š_siblšg_eblock
;

239 
»q
->
£q_num
 = 
sb
->seq_num;

240 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[
»q
->
pba
.lun],„eq);

241 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[
h—d_šdex
]);

247 
	`BUG_ON
(
h—d_šdex
 < 0);

248 
cmd_off£t
 = 
	`bufq_®loc_cmd_¦“·bË
(
sdev
, 
h—d_šdex
, 
couÁ
);

249 ià(
cmd_off£t
 < 0) {

250 
	`shªnÚ_”r
("we‡re killed.\n");

251 
	`BUG
();

252  -
EIO
;

254 
»q
->
¡©e
 = 
REQ_BUF_QUEUE
;

255 
cmdid
 = 
cmd_off£t
 >> 3;

256 
»ad
 = (
shªnÚ_buf_cmd
 *)(
sdev
->
bufq_sq_addr
[
h—d_šdex
] + 
cmdid
);

258 
»ad
->
İcode
 = 
sh_cmd_buf_»ad
;

259 
»ad
->
phy_lun
 = 
sdev
->
lun
[
»q
->
pba
.lun]->
phy_lun_num
 % 0x100;

260 
»ad
->
logicb_šdex
 = 
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
 + (
eblk
 % sdev->
¶ªes
) * sdev->logicbs_in_page;

261 
	`shªnÚ_mem_wr™–
(
	`make_buf_cmd_dwÜd1
(
sdev
, 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
,

262 
sdev
->
lun
[
»q
->
pba
.lun]->
phy_lun_num
 >> 8, (»q->
dma_add»ss_2
 ? 1 : 0)), &
»ad
->
dwÜd1
);

263 
±e
 = 
	`cmd_queue_šc
(
»ad
, 1);

264 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss
, 
±e
);

265 ià(
»q
->
dma_add»ss_2
) {

266 
±e
 = 
	`cmd_queue_šc
(pte, 1);

267 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss_2
, 
±e
);

269 
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

270 
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

271 
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
logicbs
 = 1;

272 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
»q_li¡
);

273 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
»q_li¡
);

274 
sdev
->
bufq_sq_h—d
[
h—d_šdex
] = sdev->
bufq_sq_h—d_tmp
[head_index];

275 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[
h—d_šdex
]);

276 
	`upd©e_bufq_sq_h—d
(
sdev
, 
h—d_šdex
);

279 
	}
}

281 
	$shªnÚ_wr™e_buf_cmd
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

283 
shªnÚ_buf_cmd
 *
wr™e
;

284 
cmd_off£t
, 
cmdid
, 
couÁ
;

285 
u64
 *
±e
;

286 
h—d_šdex
 = 
»q
->
h—d
 & 
HEAD_INDEX_MASK
;

287 
eblk
 = 
»q
->
pba
.
lun_pba
/(
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

288 
shªnÚ_sb
 *
sb
 = &
sdev
->
sbs
[
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
];

289 
sub_group
 *
group
 = &
sb
->sub_group[
»q
->
pba
.
lun
/
sdev
->
max_luns_š_group
];

290 
is_ov”Ïp
 = 0;

292 ià(
»q
->
h—d
 =ğ
OVERLAP_HEAD
) {

293 
h—d_šdex
 = 
HOT_INDEX
;

294 
is_ov”Ïp
 = 1;

296 
	`shªnÚ_©omic_šc
(&
sdev
->
š_cmd_queue_wr™es
);

297 
	`shªnÚ_©omic_šc
(&
sb
->
unfšished_wr™es
);

298 
couÁ
 = (
»q
->
dma_add»ss_2
)? 4 : 3;

299 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[
h—d_šdex
]);

300 ià(
is_ov”Ïp
) {

301 
	`BUG_ON
(!
sdev
->
ov”Ïp_wr™e
);

302 
sdev
->
ov”Ïp
->
bufãd_m‘ad©a
 = 
»q
->
_m‘ad©a
;

304 
cmd_off£t
 = 
	`bufq_®loc_cmd_¦“·bË
(
sdev
, 
h—d_šdex
, 
couÁ
);

305 ià(
cmd_off£t
 < 0) {

306 
	`shªnÚ_”r
("we‡re killed.\n");

307 
	`BUG
();

308  -
EIO
;

310 
cmdid
 = 
cmd_off£t
 >> 3;

311 
wr™e
 = (
shªnÚ_buf_cmd
 *)(
sdev
->
bufq_sq_addr
[
h—d_šdex
] + 
cmdid
);

313 ià(
sdev
->
©omic_wr™e
 && (
»q
->
£nd”
 =ğ
FROM_HOST
è&& (
	`g‘_»q_šdex
Ôeqè< (»q->
sbio
->
logicbs
 - 1)))

314 
wr™e
->
İcode
 = 
sh_cmd_buf_wr™e_no_comm™
;

316 
wr™e
->
İcode
 = 
sh_cmd_buf_wr™e
;

317 
wr™e
->
phy_lun
 = 
sdev
->
lun
[
»q
->
pba
.lun]->
phy_lun_num
 % 0x100;

318 
wr™e
->
logicb_šdex
 = 
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
 + (
eblk
 % sdev->
¶ªes
) * sdev->logicbs_in_page;

319 
wr™e
->
by‹3
 = 
	`make_buf_cmd_by‹3
(
»q
->
h—d
 & 
HEAD_INDEX_MASK
, 
is_ov”Ïp
 ? 0 : 
group
->
phy_šdex
);

320 
	`shªnÚ_mem_wr™–
(
	`make_buf_cmd_dwÜd1
(
sdev
, 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
,

321 
sdev
->
lun
[
»q
->
pba
.lun]->
phy_lun_num
 >> 8, (»q->
dma_add»ss_2
 ? 1 : 0)), &
wr™e
->
dwÜd1
);

322 
±e
 = 
	`cmd_queue_šc
(
wr™e
, 1);

323 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss
, 
±e
);

324 
±e
 = 
	`cmd_queue_šc
(pte, 1);

325 ià(
»q
->
dma_add»ss_2
) {

326 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss_2
, 
±e
);

327 
±e
 = 
	`cmd_queue_šc
(pte, 1);

329 
	`shªnÚ_mem_wr™eq
(
»q
->
_m‘ad©a
, 
±e
);

330 
»q
->
¡©e
 = 
REQ_BUF_QUEUE
;

331 
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

332 
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

333 
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
logicbs
 = 1;

334 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
»q_li¡
);

335 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
].
»q_li¡
);

336 
sdev
->
bufq_sq_h—d
[
h—d_šdex
] = sdev->
bufq_sq_h—d_tmp
[head_index];

337 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[
h—d_šdex
]);

338 
	`upd©e_bufq_sq_h—d
(
sdev
, 
h—d_šdex
);

341 
	}
}

343 
	$m¬k_»q_”rÜ
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

345 
shªnÚ_sb
 *
sb
;

347 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

348 ià(
»q
->
sbio
) {

349 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

350 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

352 
	`ä“_»q
(
»q
);

353 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

355 
	}
}

357 
	$shªnÚ_pick_¿w_wr™e_buf_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

359 
h—d_šdex
 = 
»q
->
h—d
 & 
HEAD_INDEX_MASK
;

361 ià(
sdev
->
ov”Ïp_wr™e
)

362 
h—d_šdex
 = 
HOT_INDEX
;

364 
	`£t_pba_š_bufq
(
sdev
, &
»q
->
pba
, 
h—d_šdex
);

366 ià(
	`shªnÚ_wr™e_buf_cmd
(
sdev
, 
»q
) < 0) {

367 
	`m¬k_»q_”rÜ
(
sdev
, 
»q
);

371 
sdev
->
bufãr_wr™e_couÁ”
++;

372 
	}
}

374 
	$shªnÚ_pick_wr™e_buf_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

376 
shªnÚ_»que¡
 *
·r™y
 = 
NULL
;

377 
shªnÚ_sb
 *
sb
;

378 
h—d
 = 
»q
->head;

379 
h—d_šdex
 = 
»q
->
h—d
 & 
HEAD_INDEX_MASK
;

380 
·r™y_lun
 = 0;

382 
	`£t_pba_š_bufq
(
sdev
, &
»q
->
pba
, 
h—d_šdex
);

384 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

385 ià(
sdev
->
¿id5_suµÜ‹d
 && (
sb
->
wr_off£t
 % (sb->
mš_d©a_luns
 * sdev->
logicbs_š_chunk
) == 0)) {

386 
·r™y_lun
 = 
	`g‘_·r™y_lun
(&
sb
->
sub_group
[
»q
->
pba
.
lun
/
sdev
->
max_luns_š_group
]);

387 
·r™y
 = 
	`make_·r™y_»q
(
sb
, 
·r™y_lun
, 
»q
);

390 ià(
	`shªnÚ_wr™e_buf_cmd
(
sdev
, 
»q
) < 0) {

391 
	`m¬k_»q_”rÜ
(
sdev
, 
»q
);

395 
sdev
->
bufãr_wr™e_couÁ”
++;

397 ià(
·r™y
) {

398 
	`shªnÚ_·r™y_cmd
(
sdev
->
lun
[
·r™y_lun
]->
lun£t
, 
·r™y
);

399 
·r™y
 = 
NULL
;

401 ià(
	`uÆik–y
(
	`is_fœ¡_•og_pba
(
sb
, sb->
wr_off£t
))) {

402 
	`sw™ch_to_Ãxt_sb
(
sdev
, 
sb
, 
h—d
);

404 
	}
}

406 
	$ş—r_chunk_š_bufq
(
shªnÚ_dev
 *
sdev
, 
lun
, 
Ï¡_lun_pba
, 
h—d_šdex
)

408 
¶ªe
;

409 
logicb
, 
lun_pba
;

410 
µa
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
Ï¡_lun_pba
 / sdev->
logicbs_š_·ge
);

412 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

413 
logicb
 = 0;†ogicb < 
sdev
->
logicbs_š_·ge
;†ogicb++) {

414 
lun_pba
 = ((
µa
 + 
¶ªe
 * 
sdev
->
·ges_š_eblock
è* sdev->
logicbs_š_·ge
è+ 
logicb
;

415 
	`BUG_ON
(!
	`‹¡_pba_š_bufq
(
sdev
, 
lun
, 
lun_pba
));

416 
	`ş—r_pba_š_bufq
(
sdev
, 
lun
, 
lun_pba
, 
h—d_šdex
);

417 
	`BUG_ON
(
	`‹¡_pba_š_bufq
(
sdev
, 
lun
, 
lun_pba
));

420 
	}
}

422 
šlše
 
	$»ad_äom_æash
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

424 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

425 
sdev
->
buf_»ad_çed
++;

426 
	`add_lun_»que¡_queue_
(
lun
, 
»q
);

427 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &
lun
->
lun£t
->
subm™_wÜk
);

428 
	}
}

430 
	$put_chunk_»q_to_buf
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
, 
h—d_šdex
)

432 
shªnÚ_»que¡
 *
»q
, *
tmp
;

434 
tmp
 = 
´eq
;

436 
»q
 = 
tmp
;

437 
tmp
 = 
	`shªnÚ_li¡_’Œy
(
»q
->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

438 
	`shªnÚ_li¡_d–_š™
(&
»q
->
chunk_li¡
);

439 
	`shªnÚ_pick_wr™e_buf_»que¡
(
sdev
, 
»q
);

440 } 
»q
 !ğ
tmp
);

441 
	}
}

443 
	$»ad_check_ÿÎback
(
shªnÚ_bio
 *
sbio
)

445 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

446 
shªnÚ_»que¡
 *
»q
, *
tmp
;

447 
shªnÚ_sb
 *
sb
 = 
NULL
;

448 
lun
 = -1, 
¶ªe
, 
ç
 = 0;

450 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
 * sdev->
logicbs_š_chunk
, 
SHANNON_DMA_FROMDEVICE
);

451 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

452 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

453 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

454 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

455 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

457 ià(
sbio
->
¡©us
 || (
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

458 
ç
 = 1;

459 
	`shªnÚ_šfo
("lun=%d,†un_pba=%d,ƒcc=0x%x,„”—d=0x%x.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

460 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

461 
lun
 = 
»q
->
pba
.lun;

463 
	`ä“_»q
(
»q
);

466 ià(
ç
) {

467 
	`shªnÚ_log
("%s: m¬k bufã¸wr™block! sbio->¡©us=0x%x.\n", 
sdev
->
sdisk
.
disk_Çme
, 
sbio
->
¡©us
);

468 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

469 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
))

470 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
);

472 
	`hªdË_wr™e_”rÜ
(
sdev
, 
sb
, 
NULL
);

475 
	`shªnÚ_kä“
(
sbio
->
vœt_addr
);

476 
	`ä“_sbio
(
sbio
);

477 
	}
}

479 #ifdeà
CONFIG_SHANNON_BUFFER_WRITE_VERIFY


480 
	$£nd_»ad_check_cmd
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
w»q
)

482 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

483 
shªnÚ_bio
 *
sbio
;

484 
¡re_·ge
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
w»q
->
pba
.
lun_pba
 / sdev->
logicbs_š_·ge
);

485 
i
;

488 
sbio
 = 
	`®loc_sbio
(
GFP_NOWAIT
);

489 
	`£t_sbio_debug_g
(
sbio
, 
READ_CHECK_TAG
);

490 
sbio
->
vœt_addr
 = 
	`shªnÚ_km®loc
(
sdev
->
logicb_size
 * sdev->
logicbs_š_chunk
, 
GFP_ATOMIC
);

491 ià(
sbio
->
vœt_addr
 =ğ
NULL
) {

492 
	`ä“_sbio
(
sbio
);

493  -
ENOMEM
;

495 
sbio
->
logicbs
 = 
sdev
->
logicbs_š_chunk
;

496 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

497 
sbio
->
ÿÎback
 = 
»ad_check_ÿÎback
;

498 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

499 
sbio
->
d©a
 = 
sdev
;

500 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
 * sdev->
logicbs_š_chunk
, 
SHANNON_DMA_FROMDEVICE
);

501 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

502 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

503 
	`BUG
();

504 
	`shªnÚ_kä“
(
sbio
->
vœt_addr
);

505 
	`ä“_sbio
(
sbio
);

506  -
ENOMEM
;

509 
i
 = 0; i < 
sdev
->
logicbs_š_chunk
; i++) {

510 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

511 
	`£t_»q_debug_g
(
»q
, 
READ_CHECK_TAG
, 0);

512 
»q
->
İcode
 = 
sh_cmd_»ad
;

513 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

514 
»q
->
lba
 = 
LONG_INVALID_LBA
;

515 
»q
->
vœt_addr
 = 
sbio
->vœt_add¸+ 
i
 * 
sdev
->
logicb_size
;

516 
»q
->
dma_add»ss
 = 
sbio
->dma_add»s + 
i
 * 
sdev
->
logicb_size
;

517 
»q
->
pba
.
lun
 = 
w»q
->pba.lun;

518 
»q
->
pba
.
lun_pba
 = 
¡re_·ge
 * 
sdev
->
logicbs_š_·ge
 + (
i
 / sdev->logicbs_š_·geè* sdev->
·ges_š_eblock
 * sdev->logicbs_in_page + (i % sdev->logicbs_in_page);

520 
»q
->
sbio
 = sbio;

522 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

523 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

524 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

525 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[
w»q
->
pba
.lun], 
»q
);

527 
	`BUG_ON
(
»q
->
pba
.
lun_pba
 !ğ
w»q
->pba.lun_pba);

528 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[
w»q
->
pba
.lun]->
lun£t
->
subm™_wÜk
);

530 
	}
}

533 
	$__hªdË_bufq
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
»ad_cq_h—d
)

535 
shªnÚ_buf_cmd
 *
cmd
;

536 
shªnÚ_cmd_šfo
 *
šfo
;

537 
shªnÚ_sb
 *
sb
;

538 
shªnÚ_»que¡
 *
»q
;

539 
cmdid
, 
cmd_Ën
, 
»Œy
;

540 
u64
 *
m‘ad©a
;

541 
u64
 
¿w_cm¶
;

542 
u32
 *
¡©us
, 
¡©us_v®ue
;

543 
»t
 = 0, 
has_´og»ss
 = 0;

545 ià(
	`uÆik–y
(
sdev
->
¶ug_out
))

547 ià(
	`uÆik–y
(
»ad_cq_h—d
)) {

548 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

549 
sdev
->
bufq_cq_hw_h—d
[
h—d_šdex
] = 
	`»ad_»g_§ã
(sdev, &sdev->
bufq_b¬
[h—d_šdex]->
cq_h—d
);

551 ià(
	`uÆik–y
(
sdev
->
bufq_cq_hw_h—d
[
h—d_šdex
] > 
QUEUE_SIZE
)) {

552 
sdev
->
¶ug_out
 = 
	`check_¶ugout
(sdev);

553 ià(
sdev
->
¶ug_out
)

555 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

556 
sdev
->
bufq_cq_hw_h—d
[
h—d_šdex
] = 
	`»ad_»g_§ã
(sdev, &sdev->
bufq_b¬
[h—d_šdex]->
cq_h—d
);

558 ià(
sdev
->
bufq_cq_hw_h—d
[
h—d_šdex
] > 
QUEUE_SIZE
) {

559 
	`shªnÚ_”r
("head_index=%d, bufq_cq_hw_head=0x%x.\n",

560 
h—d_šdex
, 
sdev
->
bufq_cq_hw_h—d
[head_index]);

561 
sdev
->
¡©e
 |ğ
SHN_STATE_ERROR_BIT
;

562 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
w©chdog_wÜk
);

567 
sdev
->
bufq_cq_h—d
[
h—d_šdex
] = sdev->
bufq_cq_hw_h—d
[head_index];

571 
cmdid
 = 
sdev
->
bufq_cq_
[
h—d_šdex
] >> 3;

572 
cmd
 = (
shªnÚ_buf_cmd
 *)
sdev
->
bufq_sq_addr
[
h—d_šdex
] + 
cmdid
;

573 ià(
	`lik–y
(
»ad_cq_h—d
 == 0)) {

574 ià(
sdev
->
bufq_cq_
[
h—d_šdex
] =ğsdev->
bufq_sq_h—d
[head_index])

576 ià(
cmd
->
İcode
 =ğ
sh_cmd_buf_»ad
) {

578 
»t
 = 1;

581 
¿w_cm¶
 = *((
u64
 *)
sdev
->
bufq_cq_addr
[
h—d_šdex
] + 
cmdid
);

583 ià(
¿w_cm¶
 =ğ
COMP_QUEUE_FILL
)

587 ià(
sdev
->
bufq_cq_
[
h—d_šdex
] =ğsdev->
bufq_cq_h—d
[head_index])

589 
¿w_cm¶
 = *((
u64
 *)
sdev
->
bufq_cq_addr
[
h—d_šdex
] + 
cmdid
);

590 ià(
¿w_cm¶
 =ğ
COMP_QUEUE_FILL
)

591 
	`shªnÚ_®¬m
("%s: bufq head_index=%d, cqƒrror: opcode=0x%x, sq_head=0x%x, cq_tail=0x%x, cq_head=0x%x.\n",

592 
sdev
->
sdisk
.
disk_Çme
, 
h—d_šdex
, 
cmd
->
İcode
, sdev->
bufq_sq_h—d
[head_index],

593 
sdev
->
bufq_cq_
[
h—d_šdex
], sdev->
bufq_cq_h—d
[head_index]);

596 
šfo
 = &
sdev
->
cmd_šfo
[
h—d_šdex
][
cmdid
];

597 
¡©us
 = (
u32
 *)(
sdev
->
bufq_cq_addr
[
h—d_šdex
] + 
cmdid
);

598 
¡©us_v®ue
 = 
	`shªnÚ_mem_»adl
(
¡©us
);

599 ià(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

600 
	`shªnÚ_”r
("info->req_list isƒmpty!!! sq_head=%x, cq_tail=%x.\n",

601 
sdev
->
bufq_sq_h—d
[
h—d_šdex
], sdev->
bufq_cq_
[head_index]);

602 
	`BUG
();

604 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

605 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

606 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

607 
	`BUG_ON
(
	`g‘_buf_cmd_phy_lun
(
cmd
->
phy_lun
, &cmd->
dwÜd1
è!ğ
sdev
->
lun
[
»q
->
pba
.lun]->
phy_lun_num
);

608 
cmd
->
İcode
) {

609 
sh_cmd_buf_wr™e_no_comm™
:

610 
sh_cmd_buf_wr™e
:

611 ià(
¡©us_v®ue
 > 0xf)

612 
	`shªnÚ_®¬m
("%s: bufq h—d_šdex=%d, opcode=0x%x, stus=0x%x, cq_=0x%x.\n", 
sdev
->
sdisk
.
disk_Çme
, \

613 
h—d_šdex
, 
cmd
->
İcode
, 
¡©us_v®ue
, 
sdev
->
bufq_cq_
[head_index]);

615 
	`shªnÚ_©omic_dec
(&
sdev
->
š_cmd_queue_wr™es
);

616 ià(
sdev
->
cmd_queue_wr™es_lim™
 && 
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
è< 
	`GET_CMD_QUEUE_WRITES_THRESHOLD_L
(sdev)) {

617 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

618 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

620 ià(
sdev
->
h¬d_queue_lim™
 && (
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
) < sdev->hard_queue_limit)) {

621 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

622 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

624 ià(
cmd
->
logicb_šdex
 =ğ
sdev
->
logicbs_š_chunk
 - 1) {

625 
	`ş—r_chunk_š_bufq
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
, 
h—d_šdex
);

626 #ifdeà
CONFIG_SHANNON_BUFFER_WRITE_VERIFY


627 
	`£nd_»ad_check_cmd
(
sdev
, 
»q
);

630 ià(
»q
->
sbio
) {

631 
»q
->
¡©e
 = 
REQ_DONE
;

632 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

634 
	`ä“_»q
(
»q
);

635 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

638 
sh_cmd_buf_»ad
:

639 ià(
¡©us_v®ue
 == 0xfffffffe) {

641 
	`»ad_äom_æash
(
sdev
, 
»q
);

646 ià((
¡©us_v®ue
 != 0xff) && (status_value > 0xf)) {

647 
	`shªnÚ_®¬m
("%s: bufq h—d_šdex=%d, opcode=0x%x, stus=0x%x, cq_=0x%x.\n", 
sdev
->
sdisk
.
disk_Çme
, \

648 
h—d_šdex
, 
cmd
->
İcode
, 
¡©us_v®ue
, 
sdev
->
bufq_cq_
[head_index]);

649 
	`»ad_äom_æash
(
sdev
, 
»q
);

653 
m‘ad©a
 = 
	`cmd_queue_šc
(
¡©us
, 1);

654 
»Œy
 = 0;

655 
	`shªnÚ_mem_»adq
(
m‘ad©a
è=ğ
COMP_QUEUE_FILL
) {

656 
»Œy
++;

657 
sdev
->
»ad_pŞl_»Œy
++;

658 ià(
»Œy
 > 
DMA_REORDER_RETRY_COUNT
) {

659 
	`shªnÚ_®¬m
("bufq head_index=%d, DMA metadata opcode=0x%X, metadata=%llX.\n",

660 
h—d_šdex
, 
cmd
->
İcode
, 
»q
->
_m‘ad©a
);

663 
	`shªnÚ_b¬r›r
();

664 
	`shªnÚ_ud–ay
(2);

666 
»q
->
_m‘ad©a
 = 
	`shªnÚ_mem_»adq
(
m‘ad©a
);

667 
»q
->
_ecc
 = 0;

668 ià(
	`decom´ess_m‘ad©a
(
»q
)) {

669 
	`shªnÚ_w¬n
("%s:†ba‡nd metadata don't match.†un=%d,†un_pba=%d,†ba=0x%lx, metadata=0x%lx. *status=0x%x.\n",

670 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
lba
, (ìeq->
_m‘ad©a
, 
	`shªnÚ_mem_»adl
(
¡©us
));

671 
	`»ad_äom_æash
(
sdev
, 
»q
);

674 
»q
->
¡©e
 = 
REQ_DONE
;

675 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

678 
	`shªnÚ_w¬n
("unknowÀİcode=0x%x.\n", 
cmd
->
İcode
);

680 
šfo
->
Ï¡_aùive_time
 = 0;

681 
cmd_Ën
 = 
šfo
->cmd_len;

682 
sdev
->
bufq_cq_
[
h—d_šdex
] = (sdev->bufq_cq_[h—d_šdex] + 
cmd_Ën
è% 
QUEUE_SIZE
;

684 
	`shªnÚ_b¬r›r
();

685 ià(
	`shªnÚ_wa™queue_aùive
(&
sdev
->
bufq_wa™_cmd_pos
[
h—d_šdex
]))

686 
	`shªnÚ_wake_up
(&
sdev
->
bufq_wa™_cmd_pos
[
h—d_šdex
]);

687 ià(!
has_´og»ss
)

688 
has_´og»ss
 = 1;

690 ià(
	`lik–y
(!
»ad_cq_h—d
))

691 
sdev
->
bufq_cq_h—d
[
h—d_šdex
] = sdev->
bufq_cq_
[head_index];

692 ià(
sdev
->
bufq_cq_
[
h—d_šdex
] =ğsdev->
bufq_sq_h—d
[head_index]) {

693 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
bufq_b¬_lock
[
h—d_šdex
]);

694 ià(
sdev
->
bufq_cq_
[
h—d_šdex
] =ğsdev->
bufq_sq_h—d
[head_index])

695 
	`shªnÚ_ş—r_b™
(
sdev
->
šŒ_big_shiá
[
h—d_šdex
], sdev->
pÙ’tŸl_š‹¼u±_veùÜs
);

696 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
bufq_b¬_lock
[
h—d_šdex
]);

699 ià(
sdev
->
chunk_»qút
[
h—d_šdex
] && 
	`bufq_Œaffic_low”
(sdev, head_index))

700 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

702 ià(
has_´og»ss
)

703 
sdev
->
bufq_hªg
[
h—d_šdex
] = 0;

705  
»t
;

706 
	}
}

708 
	$hªdË_bufq
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

710 ià(
	`uÆik–y
(
	`__hªdË_bufq
(
sdev
, 
h—d_šdex
, 0)))

711 
	`__hªdË_bufq
(
sdev
, 
h—d_šdex
, 1);

712 
	}
}

714 
	$hªdË_bufq_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

716 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
hªdË_bufq_wÜk
);

717 
i
;

719 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++)

720 
	`hªdË_bufq
(
sdev
, 
i
);

721 
	`shªnÚ_cÚd_»sched
();

722 
	}
}

724 
	$__hªdË_bufq_ack_š‹¼u±
(
shªnÚ_dev
 *
sdev
, 
»ad_cq_h—d
)

726 
shªnÚ_bufq_ack_cmd
 *
cmd
;

727 
shªnÚ_sb
 *
sb
;

728 
cmdid
, 
¶ªe
, 
logiÿl_lun
;

730 ià(
	`uÆik–y
(
sdev
->
¶ug_out
))

733 ià(
	`uÆik–y
(
»ad_cq_h—d
)) {

734 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

735 
sdev
->
bufq_ack_cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->
bufq_ack_b¬
->
cq_h—d
);

737 
sdev
->
bufq_ack_cq_h—d
 = sdev->
bufq_ack_cq_hw_h—d
;

738 ià(
	`uÆik–y
(
sdev
->
¶ug_out
 || (sdev->
bufq_ack_cq_h—d
 > 
QUEUE_SIZE
)))

743 
cmdid
 = 
sdev
->
bufq_ack_cq_
 >> 3;

744 
cmd
 = (
shªnÚ_bufq_ack_cmd
 *)
sdev
->
bufq_ack_cq_addr
 + 
cmdid
;

745 ià(
	`lik–y
(!
»ad_cq_h—d
)) {

747 ià(*((vŞ©
u64
 *)
cmd
è=ğ
COMP_QUEUE_FILL
)

750 ià(
sdev
->
bufq_ack_cq_
 =ğsdev->
bufq_ack_cq_h—d
)

753 ià(
cmd
->
tok’
 != 0x38)

754 
	`shªnÚ_”r
("bufq_ack_cq_tail=0x%x,oken=0x%x.\n",

755 
sdev
->
bufq_ack_cq_
, 
cmd
->
tok’
);

756 
	`BUG_ON
(
cmd
->
tok’
 != 0x38);

757 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


758 ià(
sdev
->
mªu®_wr™e_”r
) {

759 
	`m¬k_çke_wr_bad_luÅ·
(
sdev
, 
phy_lun_to_logiÿl_lun
[sdev->
mbr
.
lun_m­_mode
](sdev,

760 
	`g‘_buf_cmd_phy_lun
(
cmd
->
phy_lun
, &cmd->
dwÜd1
)), 
	`g‘_cmd_µa
(
sdev
, &cmd->dword1));

761 
sdev
->
mªu®_wr™e_”r
 = 0;

763 ià(
	`is_çke_wr_bad_luÅ·
(
sdev
, 
phy_lun_to_logiÿl_lun
[sdev->
mbr
.
lun_m­_mode
](sdev,

764 
	`g‘_buf_cmd_phy_lun
(
cmd
->
phy_lun
, &cmd->
dwÜd1
)), 
	`g‘_cmd_µa
(
sdev
, &cmd->dword1))) {

765 
	`debugs1
("### Trap in fake buffer write bad†unppa:†un=%d blk=%d…age=%d\n",

766 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_buf_cmd_phy_lun
(
cmd
->
phy_lun
, &cmd->
dwÜd1
)),

767 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
è/ sdev->
·ges_š_eblock
, get_cmd_ppa(sdev, &cmd->dword1) % sdev->pages_in_eblock);

768 
cmd
->
¡©us
 = 0xEF;

771 
sb
 = 
sdev
->
sbs
 + 
	`g‘_cmd_µa
(sdev, &
cmd
->
dwÜd1
)/(sdev->
·ges_š_eblock
 * sdev->
¶ªes
);

772 
	`shªnÚ_©omic_sub
(
sdev
->
logicbs_š_chunk
, &
sb
->
unfšished_wr™es
);

773 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& 
	`check_¡©us
(
cmd
->
¡©us
)) {

774 
logiÿl_lun
 = 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_buf_cmd_phy_lun
(
cmd
->
phy_lun
, &cmd->
dwÜd1
));

775 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

776 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
logiÿl_lun
, 
¶ªe
)) {

777 
	`shªnÚ_log
("%s: mark buffer write block! sb=%d,†un=%d, cmd->status=0x%x.\n",

778 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
logiÿl_lun
, 
cmd
->
¡©us
);

779 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
logiÿl_lun
, 
¶ªe
);

782 
	`hªdË_wr™e_”rÜ
(
sdev
, 
sb
, 
NULL
);

785 ià(
	`lik–y
(!
»ad_cq_h—d
)) {

787 *((vŞ©
u64
 *)
cmd
èğ
COMP_QUEUE_FILL
;

789 
sdev
->
bufq_ack_cq_
 = (sdev->bufq_ack_cq_ + 8è% 
QUEUE_SIZE
;

792 ià(
	`lik–y
(!
»ad_cq_h—d
))

793 
sdev
->
bufq_ack_cq_h—d
 = sdev->
bufq_ack_cq_
;

794 
	`wr™e_»g_§ã
(
sdev
, sdev->
bufq_ack_cq_
, &sdev->
bufq_ack_b¬
->
ack_cq_
);

798 ià(
sdev
->
u£_du®_h—d
) {

799 ià((
sdev
->
bufq_cq_
[
HOT_INDEX
] =ğsdev->
bufq_sq_h—d_tmp
[HOT_INDEX]) && \

800 (
sdev
->
bufq_cq_
[
COLD_INDEX
] =ğsdev->
bufq_sq_h—d_tmp
[COLD_INDEX])) {

801 
³ndšg_wr™es
;

802 
³ndšg_wr™es
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_æight_wr™es
è+ shªnÚ_©omic_»ad(&sdev->
gc_š_æight
);

803 ià(
³ndšg_wr™es
 == 0) {

804 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
bufq_b¬_lock
[
HOT_INDEX
]);

805 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
bufq_b¬_lock
[
COLD_INDEX
]);

806 
³ndšg_wr™es
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_æight_wr™es
è+ shªnÚ_©omic_»ad(&sdev->
gc_š_æight
);

807 ià(
³ndšg_wr™es
 == 0)

808 
	`shªnÚ_ş—r_b™
(
sdev
->
bufq_ack_šŒ_shiá
, sdev->
pÙ’tŸl_š‹¼u±_veùÜs
);

809 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
bufq_b¬_lock
[
COLD_INDEX
]);

810 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
bufq_b¬_lock
[
HOT_INDEX
]);

814 ià(
sdev
->
bufq_cq_
[
HOT_INDEX
] =ğsdev->
bufq_sq_h—d_tmp
[HOT_INDEX]) {

815 
³ndšg_wr™es
;

816 
³ndšg_wr™es
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_æight_wr™es
è+ shªnÚ_©omic_»ad(&sdev->
gc_š_æight
);

817 ià(
³ndšg_wr™es
 == 0) {

818 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
bufq_b¬_lock
[
HOT_INDEX
]);

819 
³ndšg_wr™es
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_æight_wr™es
è+ shªnÚ_©omic_»ad(&sdev->
gc_š_æight
);

820 ià(
³ndšg_wr™es
 == 0)

821 
	`shªnÚ_ş—r_b™
(
sdev
->
bufq_ack_šŒ_shiá
, sdev->
pÙ’tŸl_š‹¼u±_veùÜs
);

822 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
bufq_b¬_lock
[
HOT_INDEX
]);

827 
	}
}

829 
	$hªdË_bufq_ack_š‹¼u±
(
shªnÚ_dev
 *
sdev
)

831 
	`__hªdË_bufq_ack_š‹¼u±
(
sdev
, 0);

832 
	}
}

834 
	$®loc_bufãr_queue
(
shªnÚ_dev
 *
sdev
)

836 
	`shªnÚ_š™_wÜk
(&
sdev
->
hªdË_bufq_wÜk
, 
hªdË_bufq_sk
);

837 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
bufq_b¬_lock
[0]);

838 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
bufq_b¬_lock
[1]);

839 
	`shªnÚ_mu‹x_š™
(&
sdev
->
bufq_sq_£m
[0]);

840 
	`shªnÚ_mu‹x_š™
(&
sdev
->
bufq_sq_£m
[1]);

841 
sdev
->
bufq_sq_addr
[0] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_sq_dma_addr
[0], 
GFP_SHANNON
);

842 
sdev
->
bufq_cq_addr
[0] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_cq_dma_addr
[0], 
GFP_SHANNON
);

843 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
bufq_wa™_cmd_pos
[0]);

844 
sdev
->
bufq_sq_addr
[1] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_sq_dma_addr
[1], 
GFP_SHANNON
);

845 
sdev
->
bufq_cq_addr
[1] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_cq_dma_addr
[1], 
GFP_SHANNON
);

846 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
bufq_wa™_cmd_pos
[1]);

848 
sdev
->
bufãr_wr™e_lim™
 = 
QUEUE_SIZE
 - 1 - (sdev->
logicbs_š_chunk
 * 24);

849 
sdev
->
bufq_ack_cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_ack_cq_dma_addr
, 
GFP_SHANNON
);

851 ià(
has_dma_d–ay
)

852 
	`ş—r_commªd_queue
((
u64
 *)
sdev
->
bufq_ack_cq_addr
, 0, 
QUEUE_SIZE
>>3, 
COMP_QUEUE_FILL
);

854 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

855 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

857 
sdev
->
bufq_b¬
[0] = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
šŒ_big_shiá
[0]));

858 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[0], &sdev->
bufq_b¬
[0]->
sq_dma_addr0
);

859 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[0] >> 32è: 0, &sdev->
bufq_b¬
[0]->
sq_dma_addr1
);

860 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[0], &sdev->
bufq_b¬
[0]->
cq_dma_addr0
);

861 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[0] >> 32è: 0, &sdev->
bufq_b¬
[0]->
cq_dma_addr1
);

863 
sdev
->
bufq_b¬
[1] = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
šŒ_big_shiá
[1]));

864 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[1], &sdev->
bufq_b¬
[1]->
sq_dma_addr0
);

865 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[1] >> 32è: 0, &sdev->
bufq_b¬
[1]->
sq_dma_addr1
);

866 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[1], &sdev->
bufq_b¬
[1]->
cq_dma_addr0
);

867 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[1] >> 32è: 0, &sdev->
bufq_b¬
[1]->
cq_dma_addr1
);

869 
sdev
->
bufq_ack_b¬
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
bufq_ack_šŒ_shiá
));

870 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_ack_cq_dma_addr
, &sdev->
bufq_ack_b¬
->
cq_dma_addr0
);

871 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_ack_cq_dma_addr
 >> 32è: 0, &sdev->
bufq_ack_b¬
->
cq_dma_addr1
);

873 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

876 
	`bufq_commªd_cdev_š™
(
sdev
);

877 
	}
}

879 
	$»Ëa£_bufãr_queue
(
shªnÚ_dev
 *
sdev
)

881 
	`bufq_commªd_cdev_»Ëa£
(
sdev
);

882 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_sq_addr
[0], sdev->
bufq_sq_dma_addr
[0]);

883 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_cq_addr
[0], sdev->
bufq_cq_dma_addr
[0]);

884 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_sq_addr
[1], sdev->
bufq_sq_dma_addr
[1]);

885 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_cq_addr
[1], sdev->
bufq_cq_dma_addr
[1]);

886 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_ack_cq_addr
, sdev->
bufq_ack_cq_dma_addr
);

887 
	}
}

891 
	$¶ug_bufq
(
shªnÚ_dev
 *
sdev
)

893 
	}
}

895 
	$uÅlug_bufq
(
shªnÚ_dev
 *
sdev
)

897 
	}
}

899 
	$upd©e_bufq_lim™
(
shªnÚ_dev
 *
sdev
)

901 
	}
}

903 
	$bufq_Œaffic_jam
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

906 
	}
}

908 
	$shªnÚ_pick_wr™e_buf_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

911 
	}
}

913 
	$hªdË_bufq_š‹¼u±
(
shªnÚ_dev
 *
sdev
)

916 
	}
}

918 
	$®loc_bufãr_queue
(
shªnÚ_dev
 *
sdev
)

921 
	}
}

923 
	$»Ëa£_bufãr_queue
(
shªnÚ_dev
 *
sdev
)

926 
	}
}

	@shannon_cdev.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/fs.h
>

3 
	~<lšux/moduË.h
>

4 
	~<lšux/mm.h
>

5 
	~<lšux/¦ab.h
>

6 
	~<lšux/sched.h
>

7 
	~<asm/uacûss.h
>

8 
	~<lšux/cdev.h
>

10 
	~"shªnÚ_deviû.h
"

11 
	~"shªnÚ_memblock.h
"

13 
	$debug_cdev_İ’
(
šode
 *šode, 
fe
 *file)

15 
debug_cdev
 *
dev
;

17 
dev
 = 
	`cÚš”_of
((
shªnÚ_cdev_t
 *)
šode
->
i_cdev
, 
debug_cdev
, 
cdev
);

18 
fe
->
´iv©e_d©a
 = 
dev
;

21 
	}
}

23 
	$debug_cdev_»Ëa£
(
šode
 *šode, 
fe
 *file)

26 
	}
}

28 
ssize_t
 
	$debug_cdev_»ad
(
fe
 *fe, 
__u£r
 *
buf
, 
size_t
 
couÁ
, 
loff_t
 *
f_pos
)

30 
debug_cdev
 *
dev
 = 
fe
->
´iv©e_d©a
;

31 
sÿ‰”_memblock
 *
smb
;

32 
size_t
 
»maš
;

33 
size_t
 
d©a_Ën
;

34 
size_t
 
buf_off£t
 = 0;

35 
ssize_t
 
»t
 = 0;

37 ià(*
f_pos
 >ğ
dev
->
size
)

38 
out
;

39 ià(*
f_pos
 + 
couÁ
 > 
dev
->
size
)

40 
couÁ
 = 
dev
->
size
 - *
f_pos
;

42 ià(
dev
->
ty³
 =ğ
NORMAL_TYPE
) {

43 if(
	`cİy_to_u£r
(
buf
, 
dev
->buà+ *
f_pos
, 
couÁ
)) {

44 
»t
 = -
EFAULT
;

45 
out
;

47 *
f_pos
 +ğ
couÁ
;

48 } ià(
dev
->
ty³
 =ğ
SCATTER_MEMBLOCK_TYPE
) {

49 
smb
 = (
sÿ‰”_memblock
 *)
dev
->
buf
;

50 
»maš
 = 
couÁ
;

51 
»maš
 > 0) {

52 
d©a_Ën
 = (
»maš
 < (
smb
->
memblock_size
 - ((*
f_pos
) % smb->memblock_size)) ?„emain : (smb->memblock_size - ((*f_pos) % smb->memblock_size)));

53 ià(((*
f_pos
è% 
smb
->
memblock_size
è+ 
d©a_Ën
 > smb->memblock_size)

54 
	`shªnÚ_”r
("f_po + d©a_ËÀ> memblock_size, off£t=%ld, f_pos%mb->memblock_size=%ld, d©a_Ën=%ld\n", *
f_pos
, (*f_posè% 
smb
->
memblock_size
, 
d©a_Ën
);

55 ià(
	`uÆik–y
(
	`check_ªd_®loc_memblock
(
smb
, *
f_pos
))) {

56 
»t
 = -
EFAULT
;

57 
out
;

59 ià(
	`cİy_to_u£r
(
buf
 + 
buf_off£t
, 
smb
->
memblock_li¡
[(*
f_pos
è/ smb->
memblock_size
] + ((*f_posè% smb->memblock_size), 
d©a_Ën
)) {

60 
»t
 = -
EFAULT
;

61 
out
;

63 *
f_pos
 +ğ
d©a_Ën
;

64 
»maš
 -ğ
d©a_Ën
;

65 
buf_off£t
 +ğ
d©a_Ën
;

69 
»t
 = 
couÁ
;

70 
out
:

71  
»t
;

72 
	}
}

74 
ssize_t
 
	$debug_cdev_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
buf
, 
size_t
 
couÁ
, 
loff_t
 *
f_pos
)

76 
debug_cdev
 *
dev
 = 
fe
->
´iv©e_d©a
;

77 
sÿ‰”_memblock
 *
smb
;

78 
size_t
 
»maš
;

79 
size_t
 
d©a_Ën
;

80 
size_t
 
buf_off£t
 = 0;

81 
ssize_t
 
»t
 = 0;

83 ià(*
f_pos
 >ğ
dev
->
size
)

84 
out
;

85 ià(*
f_pos
 + 
couÁ
 > 
dev
->
size
)

86 
couÁ
 = 
dev
->
size
 - *
f_pos
;

88 ià(
dev
->
ty³
 =ğ
NORMAL_TYPE
) {

89 ià(
	`cİy_äom_u£r
(
dev
->
buf
 + *
f_pos
, buf, 
couÁ
)) {

90 
	`shªnÚ_”r
("copy_from_user failed.\n");

91 
»t
 = -
EFAULT
;

92 
out
;

95 *
f_pos
 +ğ
couÁ
;

96 } ià(
dev
->
ty³
 =ğ
SCATTER_MEMBLOCK_TYPE
) {

97 
smb
 = (
sÿ‰”_memblock
 *)
dev
->
buf
;

98 
»maš
 = 
couÁ
;

99 
»maš
 > 0) {

100 
d©a_Ën
 = (
»maš
 < (
smb
->
memblock_size
 - ((*
f_pos
) % smb->memblock_size)) ?„emain : (smb->memblock_size - ((*f_pos) % smb->memblock_size)));

101 ià(((*
f_pos
è% 
smb
->
memblock_size
è+ 
d©a_Ën
 > smb->memblock_size)

102 
	`shªnÚ_”r
("f_po + d©a_ËÀ> memblock_size, off£t=%ld, f_pos%mb->memblock_size=%ld, d©a_Ën=%ld\n", *
f_pos
, (*f_posè% 
smb
->
memblock_size
, 
d©a_Ën
);

103 ià(
	`uÆik–y
(
	`check_ªd_®loc_memblock
(
smb
, *
f_pos
))) {

104 
»t
 = -
EFAULT
;

105 
out
;

107 ià(
	`cİy_äom_u£r
(
smb
->
memblock_li¡
[(*
f_pos
è/ smb->
memblock_size
] + ((*f_posè% smb->memblock_size), 
buf
 + 
buf_off£t
, 
d©a_Ën
)) {

108 
»t
 = -
EFAULT
;

109 
out
;

111 *
f_pos
 +ğ
d©a_Ën
;

112 
»maš
 -ğ
d©a_Ën
;

113 
buf_off£t
 +ğ
d©a_Ën
;

117 
»t
 = 
couÁ
;

118 
out
:

119  
»t
;

120 
	}
}

122 
loff_t
 
	$debug_cdev_Î£ek
(
fe
 *
fp
, 
loff_t
 
off
, 
wh’û
)

124 
debug_cdev
 *
dev
 = 
fp
->
´iv©e_d©a
;

125 
loff_t
 
Ãwpos
;

127 
wh’û
) {

128 
SEEK_SET
:

129 
Ãwpos
 = 
off
;

131 
SEEK_CUR
:

132 
Ãwpos
 = 
fp
->
f_pos
 + 
off
;

134 
SEEK_END
:

135 
Ãwpos
 = 
dev
->
size
 + 
off
;

138  -
EINVAL
;

141 ià(
Ãwpos
 < 0è -
EINVAL
;

142 
fp
->
f_pos
 = 
Ãwpos
;

143  
Ãwpos
;

144 
	}
}

146 
fe_İ”©iÚs
 
	gdebug_cdev_fİs
 = {

147 .
owÃr
 = 
THIS_MODULE
,

148 .
	gİ’
 = 
debug_cdev_İ’
,

149 .
	g»Ëa£
 = 
debug_cdev_»Ëa£
,

150 .
	g»ad
 = 
debug_cdev_»ad
,

151 .
	gwr™e
 = 
debug_cdev_wr™e
,

152 .
	gÎ£ek
 = 
debug_cdev_Î£ek
,

154 
EXPORT_SYMBOL
(
debug_cdev_fİs
);

	@shannon_config.h

6 #iâdeà
__SHANNON_CONFIG_H


7 
	#__SHANNON_CONFIG_H


	)

10 
	#CONFIG_SHANNON_DEBUG


	)

15 #ià
defšed
(
CONFIG_SHANNON_DEBUG
)

21 
	#CONFIG_SHANNON_DMA_REORDER


	)

29 #iâdeà
SHANNON_RELEASE


30 
	#CONFIG_SHANNON_DEBUG_CDEV


	)

31 
	#CONFIG_SHANNON_DEBUG_DUMP


	)

34 
	#CONFIG_SHANNON_DEBUG_REQS


	)

36 
	#CONFIG_SINGLE_HEAD_VERIFY


	)

58 
	#CONFIG_READ_SKIP_BAD_BLOCKS


	)

63 #ià
defšed
(
CONFIG_SHANNON_DEBUG_CDEV
)

82 
	#CONFIG_SHANNON_GC_BALANCE


	)

	@shannon_debug.c

1 
	$add_to_gc_¡©e_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

3 
gc_block_¡©e
 *
gc_¡©e
;

5 
gc_¡©e
 = 
	`shªnÚ_km®loc
((*gc_¡©e), 
GFP_ATOMIC
);

6 ià(
gc_¡©e
 =ğ
NULL
) {

7 
	`shªnÚ_w¬n
("®loÿ‹ gc_¡©çed. sb_šdex=%d.\n", 
sb
->
sb_šdex
);

10 
gc_¡©e
->
sb_šdex
 = 
sb
->sb_index;

11 
gc_¡©e
->
v®id_·ges
 = 
	`shªnÚ_©omic_»ad
(&
sb
->valid_pages);

12 
gc_¡©e
->
bad_lun
[0] = 
sb
->bad_lun[0];

13 
gc_¡©e
->
”rÜ_lun
[0] = 
sb
->error_lun[0];

14 
gc_¡©e
->
pba_bË_Ën
 = (
sdev
->
logicbs_š_siblšg_eblock
 * sdev->
lun_couÁ
 * 
PBA_ENTRY_LEN
 + 7)/8;

15 #ifdeà
CONFIG_RECORD_PBA_TABLE_IN_GC


16 
gc_¡©e
->
pba_bË
 = 
	`shªnÚ_kz®loc
(gc_¡©e->
pba_bË_Ën
, 
GFP_NOWAIT
);

18 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
gc_¡©e_li¡_lock
);

19 
	`shªnÚ_li¡_add_
(&
gc_¡©e
->
li¡
, &
sdev
->
gc_¡©e_li¡
);

20 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_¡©e_li¡_lock
);

21 
sb
->
gc_¡©e
 = gc_state;

22 
	}
}

24 
	$»cÜd_pba_bË
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
lun
)

26 #ifdeà
CONFIG_RECORD_PBA_TABLE_IN_GC


27 
gc_block_¡©e
 *
gc_¡©e
 = 
sb
->gc_state;

31 ià(
sb
->
gc_¡©e
 && sb->gc_¡©e->
pba_bË
) {

32 
u8
 *
to
 = (u8 *)
gc_¡©e
->
pba_bË
 + 
lun
 * 
sdev
->
logicbs_š_siblšg_eblock
 * 
PBA_ENTRY_LEN
 / 8;

33 
u8
 *
äom
 = (u8 *)
sdev
->
lun
[lun]->
pba_bË
 + 
sb
->
sb_šdex
 * sdev->
logicbs_š_siblšg_eblock
 * 
PBA_ENTRY_LEN
 / 8;

34 
	`shªnÚ_memıy
(
to
, 
äom
, 
sdev
->
logicbs_š_siblšg_eblock
 * 
PBA_ENTRY_LEN
 / 8);

37 
	}
}

39 
	$»move_äom_gc_¡©e_li¡
(
shªnÚ_sb
 *
sb
)

41 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

42 ià(
sb
->
gc_¡©e
 =ğ
NULL
) {

43 
	`shªnÚ_w¬n
("gc_¡©i NULL. sb_šdex=%d.\n", 
sb
->
sb_šdex
);

46 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
gc_¡©e_li¡_lock
);

47 
	`shªnÚ_li¡_d–_š™
(&
sb
->
gc_¡©e
->
li¡
);

48 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_¡©e_li¡_lock
);

49 #ifdeà
CONFIG_RECORD_PBA_TABLE_IN_GC


50 ià(
sb
->
gc_¡©e
->
pba_bË
)

51 
	`shªnÚ_kä“
(
sb
->
gc_¡©e
->
pba_bË
);

53 
	`shªnÚ_kä“
(
sb
->
gc_¡©e
);

54 
sb
->
gc_¡©e
 = 
NULL
;

55 
	}
}

57 
	$»Ëa£_blocks_gc_¡©e
(
shªnÚ_dev
 *
sdev
)

59 
i
;

60 
shªnÚ_sb
 *
sb
;

62 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

63 
sb
 = &
sdev
->
sbs
[
i
];

64 ià(
sb
->
gc_¡©e
 !ğ
NULL
)

65 
	`»move_äom_gc_¡©e_li¡
(
sb
);

67 
	}
}

69 *
	$shªnÚ_km®loc_wa™
(
size_t
 
size
)

71 *
addr
 = 
NULL
;

72 
»Œy
:

73 
addr
 = 
	`shªnÚ_km®loc
(
size
, 
GFP_SHANNON
);

74 ià(
addr
 =ğ
NULL
)

75 
»Œy
;

76  
addr
;

77 
	}
}

79 #ifdeà
CONFIG_SHANNON_DEBUG_CDEV


80 #ifdeà
SHANNON_USE_WRITE_BUFFER


81 
	$bufq_commªd_cdev_š™
(
shªnÚ_dev
 *
dev
)

83 
i
, 
»t
 = 0;

84 
dev_t
 
devno
;

85 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

87 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "bufq_commªd_df%c", 'a' + 
dev
->
drive_no
);

89 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
dev
->
bufq_commªd_dev_num
, 0, 2, 
Çmebuf
) < 0) {

90 
	`shªnÚ_”r
("Can't„egister device commanddata.\n");

91 
»t
 = -1;

92 
out
;

94 
dev
->
bufq_commªd_majÜ
 = 
	`SHANNON_MAJOR
(dev->
bufq_commªd_dev_num
);

95 
dev
->
bufq_commªd_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

96 ià(
	`SHANNON_IS_ERR
(
dev
->
bufq_commªd_şass
)) {

97 
dev
->
bufq_commªd_cdevs
 = 
NULL
;

98 
»t
 = 
	`SHANNON_PTR_ERR
(
dev
->
bufq_commªd_şass
);

99 
out
;

101 
dev
->
bufq_commªd_cdevs
 = 
	`shªnÚ_km®loc
((*dev->bufq_commªd_cdevsè* 2, 
GFP_SHANNON
);

102 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

103 
dev
->
bufq_commªd_cdevs
[
i
].
ty³
 = 
NORMAL_TYPE
;

104 
dev
->
bufq_commªd_cdevs
[
i
].
mšÜ
 = i;

105 
dev
->
bufq_commªd_cdevs
[
i
].
buf
 = (*)dev->
bufq_sq_addr
[i];

106 
dev
->
bufq_commªd_cdevs
[
i
].
size
 = 
QUEUE_SIZE
;

108 
	`shªnÚ_š™_debug_cdev
(&
dev
->
bufq_commªd_cdevs
[
i
].
cdev
);

109 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
dev
->
bufq_commªd_cdevs
[
i
].
cdev
);

111 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
bufq_commªd_majÜ
, 
i
);

112 ià(
	`shªnÚ_cdev_add
(&
dev
->
bufq_commªd_cdevs
[
i
].
cdev
, 
devno
, 1)) {

113 
	`shªnÚ_”r
("cdev_add Error.\n");

114 
	`BUG
();

116 
	`shªnÚ_deviû_ü—‹
(
dev
->
bufq_commªd_şass
, 
	`g‘_deviû_äom_pci_dev
(dev->
pci_dev
), 
devno
, 
NULL
, "%s%d", 
Çmebuf
, 
i
);

118 
out
:

119 
	`shªnÚ_kä“
(
Çmebuf
);

120  
»t
;

121 
	}
}

123 
	$bufq_commªd_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
)

125 
i
;

126 
dev_t
 
devno
;

128 ià(
dev
->
bufq_commªd_cdevs
 !ğ
NULL
) {

129 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

130 
	`shªnÚ_cdev_d–
(&
dev
->
bufq_commªd_cdevs
[
i
].
cdev
);

131 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
bufq_commªd_majÜ
, 
i
);

132 
	`shªnÚ_deviû_de¡roy
(
dev
->
bufq_commªd_şass
, 
devno
);

134 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
dev
->
bufq_commªd_dev_num
, 2);

135 
	`shªnÚ_şass_de¡roy
(
dev
->
bufq_commªd_şass
);

136 
	`shªnÚ_kä“
(
dev
->
bufq_commªd_cdevs
);

137 
dev
->
bufq_commªd_cdevs
 = 
NULL
;

139 
	}
}

142 
	$commªd_cdev_š™
(
shªnÚ_dev
 *
dev
)

144 
i
, 
»t
 = 0;

145 
dev_t
 
devno
;

146 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

148 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "commªd_df%c", 'a' + 
dev
->
drive_no
);

150 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
dev
->
commªd_dev_num
, 0, dev->
lun£t_couÁ
, 
Çmebuf
) < 0) {

151 
	`shªnÚ_”r
("Can't„egister device commanddata.\n");

152 
»t
 = -1;

153 
out
;

155 
dev
->
commªd_majÜ
 = 
	`SHANNON_MAJOR
(dev->
commªd_dev_num
);

156 
dev
->
commªd_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

157 ià(
	`SHANNON_IS_ERR
(
dev
->
commªd_şass
)) {

158 
dev
->
commªd_cdevs
 = 
NULL
;

159 
»t
 = 
	`SHANNON_PTR_ERR
(
dev
->
commªd_şass
);

160 
out
;

162 
dev
->
commªd_cdevs
 = 
	`shªnÚ_km®loc
((*dev->commªd_cdevsè* dev->
lun£t_couÁ
, 
GFP_SHANNON
);

163 ià(!
dev
->
commªd_cdevs
) {

164 
	`shªnÚ_”r
("Can`t‡llocate memory for command_cdevs.\n");

165 
»t
 = -1;

166 
out
;

168 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

169 
dev
->
commªd_cdevs
[
i
].
ty³
 = 
NORMAL_TYPE
;

170 
dev
->
commªd_cdevs
[
i
].
mšÜ
 = i;

171 
dev
->
commªd_cdevs
[
i
].
buf
 = (*)dev->
lun£ts
[i].
sq_addr
;

172 
dev
->
commªd_cdevs
[
i
].
size
 = 
QUEUE_SIZE
;

174 
	`shªnÚ_š™_debug_cdev
(&
dev
->
commªd_cdevs
[
i
].
cdev
);

175 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
dev
->
commªd_cdevs
[
i
].
cdev
);

177 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
commªd_majÜ
, 
i
);

178 ià(
	`shªnÚ_cdev_add
(&
dev
->
commªd_cdevs
[
i
].
cdev
, 
devno
, 1)) {

179 
	`shªnÚ_”r
("cdev_add Error.\n");

180 
	`BUG
();

182 
	`shªnÚ_deviû_ü—‹
(
dev
->
commªd_şass
, 
	`g‘_deviû_äom_pci_dev
(dev->
pci_dev
), 
devno
, 
NULL
, "%s%d", 
Çmebuf
, 
i
);

184 
out
:

185 
	`shªnÚ_kä“
(
Çmebuf
);

186  
»t
;

187 
	}
}

189 
	$commªd_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
)

191 
i
;

192 
dev_t
 
devno
;

194 ià(
dev
->
commªd_cdevs
 !ğ
NULL
) {

195 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

196 
	`shªnÚ_cdev_d–
(&
dev
->
commªd_cdevs
[
i
].
cdev
);

197 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
commªd_majÜ
, 
i
);

198 
	`shªnÚ_deviû_de¡roy
(
dev
->
commªd_şass
, 
devno
);

200 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
dev
->
commªd_dev_num
, dev->
lun£t_couÁ
);

201 
	`shªnÚ_şass_de¡roy
(
dev
->
commªd_şass
);

202 
	`shªnÚ_kä“
(
dev
->
commªd_cdevs
);

203 
dev
->
commªd_cdevs
 = 
NULL
;

205 
	}
}

207 
	$com¶‘iÚ_cdev_š™
(
shªnÚ_dev
 *
dev
)

209 
i
, 
»t
 = 0;

210 
dev_t
 
devno
;

211 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

213 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "com¶‘iÚ_df%c", 'a' + 
dev
->
drive_no
);

215 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
dev
->
com¶‘iÚ_dev_num
, 0, dev->
lun£t_couÁ
, 
Çmebuf
) < 0) {

216 
	`shªnÚ_”r
("Can't„egister device completiondata.\n");

217 
»t
 = -1;

218 
out
;

220 
dev
->
com¶‘iÚ_majÜ
 = 
	`SHANNON_MAJOR
(dev->
com¶‘iÚ_dev_num
);

221 
dev
->
com¶‘iÚ_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

222 ià(
	`SHANNON_IS_ERR
(
dev
->
com¶‘iÚ_şass
)) {

223 
dev
->
com¶‘iÚ_cdevs
 = 
NULL
;

224 
»t
 = 
	`SHANNON_PTR_ERR
(
dev
->
com¶‘iÚ_şass
);

225 
out
;

228 
dev
->
com¶‘iÚ_cdevs
 = 
	`shªnÚ_km®loc
((*dev->com¶‘iÚ_cdevsè* dev->
lun£t_couÁ
, 
GFP_SHANNON
);

229 ià(!
dev
->
com¶‘iÚ_cdevs
) {

230 
	`shªnÚ_”r
("Can`t‡llocate memory for completion_cdevs.\n");

231 
»t
 = -1;

232 
out
;

234 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

235 
dev
->
com¶‘iÚ_cdevs
[
i
].
ty³
 = 
NORMAL_TYPE
;

236 
dev
->
com¶‘iÚ_cdevs
[
i
].
mšÜ
 = i;

237 
dev
->
com¶‘iÚ_cdevs
[
i
].
buf
 = (*)dev->
lun£ts
[i].
cq_addr
;

238 
dev
->
com¶‘iÚ_cdevs
[
i
].
size
 = 
QUEUE_SIZE
;

240 
	`shªnÚ_š™_debug_cdev
(&
dev
->
com¶‘iÚ_cdevs
[
i
].
cdev
);

241 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
dev
->
com¶‘iÚ_cdevs
[
i
].
cdev
);

243 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
com¶‘iÚ_majÜ
, 
i
);

244 ià(
	`shªnÚ_cdev_add
(&
dev
->
com¶‘iÚ_cdevs
[
i
].
cdev
, 
devno
, 1)) {

245 
	`shªnÚ_”r
("cdev_add Error.\n");

246 
	`BUG
();

248 
	`shªnÚ_deviû_ü—‹
(
dev
->
com¶‘iÚ_şass
, 
	`g‘_deviû_äom_pci_dev
(dev->
pci_dev
), 
devno
, 
NULL
, "%s%d", 
Çmebuf
, 
i
);

250 
out
:

251 
	`shªnÚ_kä“
(
Çmebuf
);

252  
»t
;

253 
	}
}

255 
	$com¶‘iÚ_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
)

257 
i
;

258 
dev_t
 
devno
;

260 ià(
dev
->
com¶‘iÚ_cdevs
 !ğ
NULL
) {

261 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

262 
	`shªnÚ_cdev_d–
(&
dev
->
com¶‘iÚ_cdevs
[
i
].
cdev
);

263 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
com¶‘iÚ_majÜ
, 
i
);

264 
	`shªnÚ_deviû_de¡roy
(
dev
->
com¶‘iÚ_şass
, 
devno
);

266 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
dev
->
com¶‘iÚ_dev_num
, dev->
lun£t_couÁ
);

267 
	`shªnÚ_şass_de¡roy
(
dev
->
com¶‘iÚ_şass
);

268 
	`shªnÚ_kä“
(
dev
->
com¶‘iÚ_cdevs
);

269 
dev
->
com¶‘iÚ_cdevs
 = 
NULL
;

271 
	}
}

274 
	$pba_bË_cdev_š™
(
shªnÚ_dev
 *
dev
, 
pba_bË_size
)

276 
i
, 
»t
 = 0;

277 
dev_t
 
devno
;

278 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

280 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "pba_bË_df%c", 'a' + 
dev
->
drive_no
);

282 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
dev
->
pba_bË_dev_num
, 0, dev->
lun_couÁ
, 
Çmebuf
) < 0) {

283 
	`shªnÚ_”r
("Can't„egister device…ba_tabledata.\n");

284 
»t
 = -1;

285 
out
;

287 
dev
->
pba_bË_majÜ
 = 
	`SHANNON_MAJOR
(dev->
pba_bË_dev_num
);

288 
dev
->
pba_bË_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

289 ià(
	`SHANNON_IS_ERR
(
dev
->
pba_bË_şass
)) {

290 
dev
->
pba_bË_cdevs
 = 
NULL
;

291 
»t
 = 
	`SHANNON_PTR_ERR
(
dev
->
pba_bË_şass
);

292 
out
;

294 
dev
->
pba_bË_cdevs
 = 
	`shªnÚ_km®loc
((*dev->pba_bË_cdevsè* dev->
lun_couÁ
, 
GFP_SHANNON
);

295 ià(!
dev
->
pba_bË_cdevs
) {

296 
	`shªnÚ_”r
("Can`t‡llocate memory for…ba_table_cdevs.\n");

297 
»t
 = -1;

298 
out
;

300 
i
 = 0; i < 
dev
->
lun_couÁ
; i++) {

301 ià(!
dev
->
lun
[
i
]->
pba_bË
)

303 
dev
->
pba_bË_cdevs
[
i
].
ty³
 = 
NORMAL_TYPE
;

304 
dev
->
pba_bË_cdevs
[
i
].
mšÜ
 = i;

305 
dev
->
pba_bË_cdevs
[
i
].
buf
 = (*)dev->
lun
[i]->
pba_bË
;

306 
dev
->
pba_bË_cdevs
[
i
].
size
 = 
pba_bË_size
;

308 
	`shªnÚ_š™_debug_cdev
(&
dev
->
pba_bË_cdevs
[
i
].
cdev
);

309 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
dev
->
pba_bË_cdevs
[
i
].
cdev
);

311 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
pba_bË_majÜ
, 
i
);

312 ià(
	`shªnÚ_cdev_add
(&
dev
->
pba_bË_cdevs
[
i
].
cdev
, 
devno
, 1)) {

313 
	`shªnÚ_”r
("cdev_add Error.\n");

314 
	`BUG
();

316 
	`shªnÚ_deviû_ü—‹
(
dev
->
pba_bË_şass
, 
	`g‘_deviû_äom_pci_dev
(dev->
pci_dev
), 
devno
, 
NULL
, "%s%d", 
Çmebuf
, 
i
);

318 
out
:

319 
	`shªnÚ_kä“
(
Çmebuf
);

320  
»t
;

321 
	}
}

323 
	$pba_bË_cdev_»Ëa£
(
shªnÚ_dev
 *
dev
)

325 
i
;

326 
dev_t
 
devno
;

328 ià(
dev
->
pba_bË_cdevs
 !ğ
NULL
) {

329 
i
 = 0; i < 
dev
->
lun_couÁ
; i++) {

330 ià(!
dev
->
lun
[
i
]->
pba_bË
)

332 
	`shªnÚ_cdev_d–
(&
dev
->
pba_bË_cdevs
[
i
].
cdev
);

333 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
pba_bË_majÜ
, 
i
);

334 
	`shªnÚ_deviû_de¡roy
(
dev
->
pba_bË_şass
, 
devno
);

336 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
dev
->
pba_bË_dev_num
, dev->
lun_couÁ
);

337 
	`shªnÚ_şass_de¡roy
(
dev
->
pba_bË_şass
);

338 
	`shªnÚ_kä“
(
dev
->
pba_bË_cdevs
);

339 
dev
->
pba_bË_cdevs
 = 
NULL
;

341 
	}
}

343 
	$Ímt_cdev_š™
(
shªnÚ_disk
 *
sdisk
)

345 
dev_t
 
devno
;

346 
»t
 = 0;

347 
i
;

348 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

350 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "shªnÚ_Ímt_%s", 
sdisk
->
disk_Çme
);

352 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
sdisk
->
Ímt_dev_num
, 0, sdisk->
sdev_couÁ
, 
Çmebuf
) < 0) {

353 
	`shªnÚ_”r
("Can't„egister device†pmt.\n");

354 
»t
 = -1;

355 
out
;

357 
sdisk
->
Ímt_majÜ
 = 
	`SHANNON_MAJOR
(sdisk->
Ímt_dev_num
);

358 
sdisk
->
Ímt_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

359 ià(
	`SHANNON_IS_ERR
(
sdisk
->
Ímt_şass
)) {

360 
sdisk
->
Ímt_cdev
 = 
NULL
;

361 
»t
 = 
	`SHANNON_PTR_ERR
(
sdisk
->
Ímt_şass
);

362 
out
;

364 
sdisk
->
Ímt_cdev
 = 
	`shªnÚ_km®loc
((*sdisk->Ímt_cdevè* sdisk->
sdev_couÁ
, 
GFP_SHANNON
);

365 ià(!
sdisk
->
Ímt_cdev
) {

366 
	`shªnÚ_”r
("Can`t‡lloc†pmt_cdev.\n");

367 
	`shªnÚ_şass_de¡roy
(
sdisk
->
Ímt_şass
);

368 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
sdisk
->
Ímt_dev_num
, sdisk->
sdev_couÁ
);

369 
»t
 = -
ENOMEM
;

370 
out
;

373 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

374 
sdisk
->
Ímt_cdev
[
i
].
ty³
 = 
SCATTER_MEMBLOCK_TYPE
;

375 
sdisk
->
Ímt_cdev
[
i
].
mšÜ
 = i;

376 
sdisk
->
Ímt_cdev
[
i
].
size
 = sdisk->
Ímt_¬¿y
[i].
m­_bË_size
;

377 
sdisk
->
Ímt_cdev
[
i
].
buf
 = (*)(&sdisk->
Ímt_¬¿y
[i].
m­_bË
);

379 
	`shªnÚ_š™_debug_cdev
(&
sdisk
->
Ímt_cdev
[
i
].
cdev
);

380 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
sdisk
->
Ímt_cdev
[
i
].
cdev
);

382 
devno
 = 
	`SHANNON_MKDEV
(
sdisk
->
Ímt_majÜ
, 
i
);

383 ià(
	`shªnÚ_cdev_add
(&
sdisk
->
Ímt_cdev
[
i
].
cdev
, 
devno
, 1)) {

384 
	`shªnÚ_”r
("cdev_add Error.\n");

385 
	`BUG
();

387 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "shªnÚ_Ímt_%s_no_%d", 
sdisk
->
disk_Çme
, 
i
);

388 
	`shªnÚ_deviû_ü—‹
(
sdisk
->
Ímt_şass
, 
NULL
, 
devno
, NULL, "%s", 
Çmebuf
);

391 
out
:

392 
	`shªnÚ_kä“
(
Çmebuf
);

393  
»t
;

394 
	}
}

396 
	$Ímt_cdev_ex™
(
shªnÚ_disk
 *
sdisk
)

398 
i
;

400 ià(
sdisk
->
Ímt_cdev
 !ğ
NULL
) {

401 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

402 
	`shªnÚ_cdev_d–
(&
sdisk
->
Ímt_cdev
[
i
].
cdev
);

403 
	`shªnÚ_deviû_de¡roy
(
sdisk
->
Ímt_şass
, 
	`SHANNON_MKDEV
(sdisk->
Ímt_majÜ
, 
i
));

405 
	`shªnÚ_şass_de¡roy
(
sdisk
->
Ímt_şass
);

406 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
sdisk
->
Ímt_dev_num
, sdisk->
sdev_couÁ
);

407 
	`shªnÚ_kä“
(
sdisk
->
Ímt_cdev
);

408 
sdisk
->
Ímt_cdev
 = 
NULL
;

410 
	}
}

412 
	$‹mp_bË_cdev_š™
(
shªnÚ_disk
 *
sdisk
)

414 
dev_t
 
devno
;

415 
»t
 = 0;

416 
i
;

417 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

419 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "shªnÚ_‹mp_bË_%s", 
sdisk
->
disk_Çme
);

421 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
sdisk
->
‹mp_bË_dev_num
, 0, sdisk->
sdev_couÁ
, 
Çmebuf
) < 0) {

422 
	`shªnÚ_”r
("Can't„egister deviceemp_table.\n");

423 
»t
 = -1;

424 
out
;

426 
sdisk
->
‹mp_bË_majÜ
 = 
	`SHANNON_MAJOR
(sdisk->
‹mp_bË_dev_num
);

427 
sdisk
->
‹mp_bË_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

428 ià(
	`SHANNON_IS_ERR
(
sdisk
->
‹mp_bË_şass
)) {

429 
sdisk
->
‹mp_bË_cdev
 = 
NULL
;

430 
»t
 = 
	`SHANNON_PTR_ERR
(
sdisk
->
‹mp_bË_şass
);

431 
out
;

434 
sdisk
->
‹mp_bË_cdev
 = 
	`shªnÚ_km®loc
((*sdisk->‹mp_bË_cdevè* sdisk->
sdev_couÁ
, 
GFP_SHANNON
);

435 ià(!
sdisk
->
‹mp_bË_cdev
) {

436 
	`shªnÚ_”r
("Can`t‡llocemp_table_cdev.\n");

437 
	`shªnÚ_şass_de¡roy
(
sdisk
->
‹mp_bË_şass
);

438 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
sdisk
->
‹mp_bË_dev_num
, sdisk->
sdev_couÁ
);

439 
»t
 = -
ENOMEM
;

440 
out
;

442 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

443 
sdisk
->
‹mp_bË_cdev
[
i
].
ty³
 = 
SCATTER_MEMBLOCK_TYPE
;

444 
sdisk
->
‹mp_bË_cdev
[
i
].
mšÜ
 = i;

445 
sdisk
->
‹mp_bË_cdev
[
i
].
size
 = sdisk->
Ímt_¬¿y
[i].
‹mp_bË_size
;

446 
sdisk
->
‹mp_bË_cdev
[
i
].
buf
 = (*)(&sdisk->
Ímt_¬¿y
[i].
‹mp_bË
);

448 
	`shªnÚ_š™_debug_cdev
(&
sdisk
->
‹mp_bË_cdev
[
i
].
cdev
);

449 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
sdisk
->
‹mp_bË_cdev
[
i
].
cdev
);

451 
devno
 = 
	`SHANNON_MKDEV
(
sdisk
->
‹mp_bË_majÜ
, 
i
);

452 ià(
	`shªnÚ_cdev_add
(&
sdisk
->
‹mp_bË_cdev
[
i
].
cdev
, 
devno
, 1)) {

453 
	`shªnÚ_”r
("cdev_add Error.\n");

454 
	`BUG
();

456 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "shªnÚ_‹mp_bË_%s_no_%d", 
sdisk
->
disk_Çme
, 
i
);

457 
	`shªnÚ_deviû_ü—‹
(
sdisk
->
‹mp_bË_şass
, 
NULL
, 
devno
, NULL, "%s", 
Çmebuf
, 0);

460 
out
:

461 
	`shªnÚ_kä“
(
Çmebuf
);

462  
»t
;

463 
	}
}

465 
	$‹mp_bË_cdev_ex™
(
shªnÚ_disk
 *
sdisk
)

467 
i
;

469 ià(
sdisk
->
‹mp_bË_cdev
 !ğ
NULL
) {

470 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

471 
	`shªnÚ_cdev_d–
(&
sdisk
->
‹mp_bË_cdev
[
i
].
cdev
);

472 
	`shªnÚ_deviû_de¡roy
(
sdisk
->
‹mp_bË_şass
, 
	`SHANNON_MKDEV
(sdisk->
‹mp_bË_majÜ
, 
i
));

474 
	`shªnÚ_kä“
(
sdisk
->
‹mp_bË_cdev
);

475 
	`shªnÚ_şass_de¡roy
(
sdisk
->
‹mp_bË_şass
);

476 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
sdisk
->
‹mp_bË_dev_num
, sdisk->
sdev_couÁ
);

477 
sdisk
->
‹mp_bË_cdev
 = 
NULL
;

479 
	}
}

480 
	$•og_cdev_š™
(
shªnÚ_dev
 *
dev
)

482 
dev_t
 
devno
;

483 
»t
 = 0;

484 *
Çmebuf
 = 
	`shªnÚ_km®loc_wa™
(32);

486 
	`shªnÚ_¢´štf
(
Çmebuf
, 32, "•og_df%c", 'a' + 
dev
->
drive_no
);

488 ià(
	`shªnÚ_®loc_chrdev_»giÚ
(&
dev
->
•og_dev_num
, 0, 1, 
Çmebuf
) < 0) {

489 
	`shªnÚ_”r
("Can't„egister deviceƒpilog.\n");

490 
»t
 = -1;

491 
out
;

493 
dev
->
•og_majÜ
 = 
	`SHANNON_MAJOR
(dev->
•og_dev_num
);

494 
dev
->
•og_şass
 = 
	`shªnÚ_şass_ü—‹
(
	`shªnÚ_g‘_this_moduË
(), 
Çmebuf
);

495 ià(
	`SHANNON_IS_ERR
(
dev
->
•og_şass
)) {

496 
dev
->
•og_cdev
 = 
NULL
;

497 
»t
 = 
	`SHANNON_PTR_ERR
(
dev
->
•og_şass
);

498 
out
;

500 
dev
->
•og_cdev
 = 
	`shªnÚ_km®loc
((*dev->•og_cdev), 
GFP_SHANNON
);

501 ià(!
dev
->
•og_cdev
) {

502 
	`shªnÚ_”r
("Can`t‡llocate memory forƒpilog_cdev.\n");

503 
»t
 = -1;

504 
out
;

506 
dev
->
•og_cdev
->
ty³
 = 
NORMAL_TYPE
;

507 
dev
->
•og_cdev
->
mšÜ
 = 0;

508 
dev
->
•og_cdev
->
size
 = dev->
max_•og_size
 * dev->
eblocks_š_lun
/dev->
¶ªes
;

509 
dev
->
•og_cdev
->
buf
 = 
	`shªnÚ_vm®loc
(dev->•og_cdev->
size
);

510 ià(
dev
->
•og_cdev
->
buf
 =ğ
NULL
) {

511 
	`shªnÚ_”r
("ÿÀnÙ‡Îoÿ‹ memÜy fÜƒpog_cdev, size=%ld.\n", 
dev
->
•og_cdev
->
size
);

512 
»t
 = -1;

513 
out
;

515 
	`shªnÚ_mem£t
(
dev
->
•og_cdev
->
buf
, 0, dev->•og_cdev->
size
);

517 
	`shªnÚ_š™_debug_cdev
(&
dev
->
•og_cdev
->
cdev
);

518 
	`shªnÚ_£t_cdev_owÃr_this_moduË
(&
dev
->
•og_cdev
->
cdev
);

520 
devno
 = 
	`SHANNON_MKDEV
(
dev
->
•og_majÜ
, 0);

521 ià(
	`shªnÚ_cdev_add
(&
dev
->
•og_cdev
->
cdev
, 
devno
, 1)) {

522 
	`shªnÚ_”r
("cdev_add Error.\n");

523 
	`BUG
();

525 
	`shªnÚ_deviû_ü—‹
(
dev
->
•og_şass
, 
	`g‘_deviû_äom_pci_dev
(dev->
pci_dev
), 
devno
, 
NULL
, "%s%d", 
Çmebuf
, 0);

526 
out
:

527 
	`shªnÚ_kä“
(
Çmebuf
);

528  
»t
;

529 
	}
}

531 
	$•og_cdev_ex™
(
shªnÚ_dev
 *
dev
)

533 ià(
dev
->
•og_cdev
 !ğ
NULL
) {

534 
	`shªnÚ_vä“
(
dev
->
•og_cdev
->
buf
);

535 
	`shªnÚ_cdev_d–
(&
dev
->
•og_cdev
->
cdev
);

536 
	`shªnÚ_deviû_de¡roy
(
dev
->
•og_şass
, 
	`SHANNON_MKDEV
(dev->
•og_majÜ
, 0));

537 
	`shªnÚ_uÄegi¡”_chrdev_»giÚ
(
dev
->
•og_dev_num
, 1);

538 
	`shªnÚ_şass_de¡roy
(
dev
->
•og_şass
);

539 
	`shªnÚ_kä“
(
dev
->
•og_cdev
);

540 
dev
->
•og_cdev
 = 
NULL
;

542 
	}
}

544 
	$cİy_•og_buf
(
shªnÚ_dev
 *
dev
, 
sb_šdex
, 
shªnÚ_•og
 *
•og
)

546 
i
;

548 
i
 = 0; i < 
•og
->
logicbs_š_u£
; i++)

549 
	`shªnÚ_memıy
(
dev
->
•og_cdev
->
buf
 + 
sb_šdex
 * dev->
max_•og_size
 + 
i
 * dev->
logicb_size
,

550 
	`•og_g‘_addr
(
•og
, 
i
, 
dev
), dev->
logicb_size
);

551 
	}
}

554 
	$wr™e_chunk_is_v®id
(
shªnÚ_»que¡
 *
»q
, 
shªnÚ_dev
 *
sdev
)

556 
shªnÚ_»que¡
 *
p
;

557 
couÁ
;

558 
·ge
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
);

560 ià((
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
) != 0)

563 
couÁ
 = 1;

564 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
»q
->
chunk_li¡
, chunk_list) {

565 ià(
»q
->
pba
.
lun
 !ğ
p
->pba.lun)

567 ià(
·ge
 !ğ
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
p
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
))

569 
couÁ
++;

571 ià(
couÁ
 !ğ
sdev
->
logicbs_š_chunk
)

574 
	}
}

576 
	$£t_»q_debug_g
(
shªnÚ_»que¡
 *
»q
, 
g
, 
i
)

578 
»q
->
g
 =ag + 
i
;

579 
	}
}

581 
	$dump_®l_blocks
(
shªnÚ_dev
 *
dev
)

583 
i
, 
š_gc
 = 0;

584 
shªnÚ_sb
 *
sb
;

586 
	`shªnÚ_šfo
("¡¬t-----------ä“_blkút=%d.----------------.\n", 
dev
->
ä“_blkút
);

587 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

588 
sb
 = 
dev
->
sbs
 + 
i
;

589 ià(
sb
->
¡©e
 =ğ
IN_GC_BLOCK
)

590 
š_gc
++;

591 ià((
sb
->
¡©e
 !ğ
HOT_BLOCK_LIST
))

592 
	`shªnÚ_šfo
("%s(): sb_šdex=%d, s‹=%d, v®id_·ges=%d.\n", 
__func__
, 
sb
->
sb_šdex
, sb->
¡©e
, 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
));

594 
	`shªnÚ_šfo
("------------š_gc=%d ---------------’d.\n", 
š_gc
);

595 
	}
}

598 *
	$£q_®l_blocks_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

600 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

601 ià(*
pos
 >ğ
sdev
->
sb_couÁ
)

602  
NULL
;

603  
sdev
->
sbs
 + *
pos
;

604 
	}
}

606 *
	$£q_®l_blocks_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

608 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

609 (*
pos
)++;

610 ià(*
pos
 >ğ
sdev
->
sb_couÁ
)

611  
NULL
;

612  
sdev
->
sbs
 + *
pos
;

613 
	}
}

615 
	$£q_®l_blocks_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

617 
	}
}

619 *
	$¡©e_Çme
(
¡©e
)

621 
¡©e
) {

622 
HOT_ACTIVE_BLOCK
:

624 
LAST_HOT_BLOCK
:

626 
HOT_BLOCK_LIST
:

628 
COLD_ACTIVE_BLOCK
:

630 
LAST_COLD_BLOCK
:

632 
COLD_BLOCK_LIST
:

634 
WAIT_COPY_BLOCK
:

636 
IN_GC_BLOCK
:

638 
WAIT_ERASE_BLOCK
:

640 
FREE_BLOCK
:

642 
DISCARDED_BLOCK
:

644 
MBR_BLOCK
:

646 
ERROR_BLOCK
:

648 
IN_RECOVER_BLOCK
:

650 
NEXT_HOT_BLOCK
:

652 
NEXT_COLD_BLOCK
:

654 
IN_ERASING_BLOCK
:

656 
OVERLAP_BLOCK
:

661 
	}
}

663 
	$£q_®l_blocks_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

665 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
v
;

666 
sub_group
 *
group
;

667 
i
, 
Ï¡_”a£
, 
Ï¡_şo£
;

668 
now
;

670 
now
 = 
	`g‘_jiff›s
();

671 
Ï¡_”a£
 = (
now
 - 
sb
->
Ï¡_”a£d_time¡amp
è/ 
	`g‘_HZ
() / 3600;

672 
Ï¡_şo£
 = (
now
 - 
sb
->
Ï¡_şo£d_time¡amp
è/ 
	`g‘_HZ
() / 3600;

674 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

675 
	`shªnÚ_£q_´štf
(
s
, "sb_index=%3d, state=%15s(%3d), valid_pages=%7d, in_write=%d, unfinished_writes=%d,‡vail_luns=%d, seq_num=%7ld,ƒrase_count=%d, wr_offset=%d, min_available_luns=%d, flag=0x%x,†ogicbs_in_epilog=%d, max_ecc=%d,†ast_erase=%d,†ast_close=%d.\n",

676 
sb
->
sb_šdex
, 
	`¡©e_Çme
(sb->
¡©e
), sb->¡©e, 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
),

677 
	`shªnÚ_©omic_»ad
(&
sb
->
š_wr™e_logicbs
), shªnÚ_©omic_»ad(&sb->
unfšished_wr™es
), shªnÚ_©omic_»ad(&sb->
avaabË_luns
), (
ulÚg
)sb->
£q_num
,

678 
sb
->
”a£_couÁ”
, sb->
wr_off£t
, sb->
mš_avaabË_luns
, sb->
»şaim_kšd
, sb->
logicbs_š_•og
, sb->
max_ecc
,

679 
Ï¡_”a£
, 
Ï¡_şo£
);

680 
i
 = 0; i < 
sb
->
sdev
->
·r™y_groups
; i++) {

681 
group
 = &
sb
->
sub_group
[
i
];

682 
	`shªnÚ_£q_´štf
(
s
, "…hy_index=%d, start_lun=%d,‡vailable_luns=%d, data_luns=%d, first_lun=%d,†ast_data_lun=%d,…arity_lun=%d.\n",

683 
group
->
phy_šdex
, group->
¡¬t_lun
, 
	`shªnÚ_©omic_»ad
(&group->
avaabË_luns
), group->
d©a_luns
, 
	`fœ¡_lun
(group), 
	`Ï¡_d©a_lun
(group), 
	`g‘_·r™y_lun
(group));

685 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

687 
	}
}

689 
shªnÚ_£q_İ”©iÚs_t
 
	g®l_blocks_£q_İs
;

691 
	$debugfs_®l_blocks_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

693 
»t
;

695 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
®l_blocks_£q_İs
, 
£q_®l_blocks_¡¬t
);

696 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
®l_blocks_£q_İs
, 
£q_®l_blocks_Ãxt
);

697 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
®l_blocks_£q_İs
, 
£q_®l_blocks_¡İ
);

698 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
®l_blocks_£q_İs
, 
£q_®l_blocks_show
);

699 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
®l_blocks_£q_İs
);

700 ià(0 =ğ
»t
)

701 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

702  
»t
;

703 
	}
}

705 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_®l_blocks_fİs
;

708 #ifdeà
CONFIG_SHANNON_DEBUG_DUMP


709 *
	$£q_dump_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

711 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

712 ià(*
pos
 >ğ
sdev
->
sb_couÁ
)

713  
NULL
;

714  
sdev
->
sbs
 + *
pos
;

715 
	}
}

717 *
	$£q_dump_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

719 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

720 (*
pos
)++;

721 ià(*
pos
 >ğ
sdev
->
sb_couÁ
)

722  
NULL
;

723  
sdev
->
sbs
 + *
pos
;

724 
	}
}

726 
	$£q_dump_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

728 
	}
}

730 
	$£q_dump_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

732 
i
, 
j
, 
k
, 
lun_off£t
;

733 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

734 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
v
;

735 
sub_group
 *
group
;

737 ià(0 =ğ
sb
->
sb_šdex
) {

739 
	`shªnÚ_£q_´štf
(
s
, "[section-tag:variables]\n");

740 
	`shªnÚ_£q_´štf
(
s
, "sb_couÁ=%d\n", 
sdev
->
sb_couÁ
);

741 
	`shªnÚ_£q_´štf
(
s
, "¶ªe_couÁ=%d\n", 
sdev
->
¶ªes
);

742 
	`shªnÚ_£q_´štf
(
s
, "·ge_couÁ=%d\n", 
sdev
->
·ges_š_eblock
);

743 
	`shªnÚ_£q_´štf
(
s
, "·ge_size=%d\n", 
sdev
->
Çnd_·ge_size
);

744 
	`shªnÚ_£q_´štf
(
s
, "oob_size=%d\n", 
sdev
->
oob_size
);

745 
	`shªnÚ_£q_´štf
(
s
, "lun_couÁ=%d\n", 
sdev
->
lun_couÁ
);

746 
	`shªnÚ_£q_´štf
(
s
, "rg_couÁ=%d\n", 
sdev
->
·r™y_groups
);

747 
	`shªnÚ_£q_´štf
(
s
, "rg_max_luns=%d\n", 
sdev
->
max_luns_š_group
);

748 
	`shªnÚ_£q_´štf
(
s
, "ÿ·c™y=%ÎuGB\n", 
sdev
->
sdisk
.
£ùÜs
*512/(1000*1000*1000));

749 
	`shªnÚ_£q_´štf
(
s
, "pow”_budg‘=%d\n", 
sdev
->
mbr
.
pow”_budg‘
);

750 
	`shªnÚ_£q_´štf
(
s
, "ifşock=%d\n", 
sdev
->
mbr
.
şk
);

751 
	`shªnÚ_£q_´štf
(
s
, "flashid=");

752 
i
 = 0; i < (
sdev
->
æashid
); i++)

753 
	`shªnÚ_£q_´štf
(
s
, "%02X%s", (
sdev
->
æashid
 >> 
i
*8)&0xFF, i != (sdev->flashid)-1 ? " " : "\n");

754 
	`shªnÚ_£q_´štf
(
s
, "bad_phy_lun_map=");

755 
i
 = 0; i < 
BAD_LUN_MAP_ARRAY_SIZE
; i++)

756 
	`shªnÚ_£q_´štf
(
s
, "%016ÎX%s", 
sdev
->
mbr
.
bad_phy_lun_m­
[
i
], i !ğ
BAD_LUN_MAP_ARRAY_SIZE
-1 ? " " : "\n");

757 
	`shªnÚ_£q_´štf
(
s
, "max_chªÃls=%d\n", 
sdev
->
max_chªÃls
);

758 
	`shªnÚ_£q_´štf
(
s
, "max_lun£t_š_chªÃl=%d\n", 
sdev
->
max_lun£t_š_chªÃl
);

759 
	`shªnÚ_£q_´štf
(
s
, "max_lun_š_lun£t=%d\n", 
sdev
->
max_lun_š_lun£t
);

760 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

761 
	`shªnÚ_£q_´štf
(
s
, "io_width=%d\n", 
	`shªnÚ_»ad_»g
(&
sdev
->
glob®_b¬
->
¿id_šfo
, 
PER_BYTE_DISABLE
) == 0 ? 16 : 8);

762 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

763 
	`shªnÚ_£q_´štf
(
s
, "ecc_cÜ»ùiÚ_pow”=%d\n", 
sdev
->
ecc_cÜ»ùiÚ_pow”
);

764 
	`shªnÚ_£q_´štf
(
s
, "ecc_codewÜds_š_logicb=%d\n", 
sdev
->
ecc_codewÜds_š_logicb
);

765 
	`shªnÚ_£q_´štf
(
s
, "subsy¡em_deviû_id=%04X\n", 
sdev
->
pci_šfo
.
subsy¡em_deviû_id
);

766 
	`shªnÚ_£q_´štf
(
s
, "¢=%s\n", 
sdev
->
£rviû_g
);

769 
	`shªnÚ_£q_´štf
(
s
, "[section-tag:log2phy]\n");

770 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++)

771 
	`shªnÚ_£q_´štf
(
s
, "%d=%d\n", 
i
, 
sdev
->
lun
[i]->
phy_lun_num
);

774 
	`shªnÚ_£q_´štf
(
s
, "[section-tag:sbs]\n");

778 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

779 
	`shªnÚ_£q_´štf
(
s
, "sb_index=%d,state=%s,valid_pages=%d,in_write=%d,"

781 
sb
->
sb_šdex
, 
	`¡©e_Çme
(sb->
¡©e
), 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
), shªnÚ_©omic_»ad(&sb->
š_wr™e_logicbs
),

782 
sb
->
avaabË_luns
, (
ulÚg
)sb->
£q_num
, sb->
”a£_couÁ”
, sb->
wr_off£t
, sb->
mš_avaabË_luns
, sb->
»şaim_kšd
);

784 
	`shªnÚ_£q_´štf
(
s
, " badlun_bitmap=");

785 
i
 = 0; i < 
	`ARRAY_SIZE
(
sb
->
bad_lun
); i++)

786 
	`shªnÚ_£q_´štf
(
s
, "%016lX%s", 
sb
->
bad_lun
[
i
], i !ğ
	`ARRAY_SIZE
(sb->bad_lun)-1 ? "-" : "\n");

788 
i
 = 0; i < 
sb
->
sdev
->
·r™y_groups
; i++) {

789 
group
 = &
sb
->
sub_group
[
i
];

790 
	`shªnÚ_£q_´štf
(
s
, "…hy_index=%d,start_lun=%d,available_luns=%d,data_luns=%d,first_lun=%d,last_data_lun=%d,parity_lun=%d,used_data_luns=",

791 
group
->
phy_šdex
, group->
¡¬t_lun
, group->
avaabË_luns
, group->
d©a_luns
, 
	`fœ¡_lun
(group), 
	`Ï¡_d©a_lun
(group), 
	`g‘_·r™y_lun
(group));

792 ià(
sb
->
mš_avaabË_luns
 > 1 && 
group
->
phy_šdex
 >= 0) {

793 
k
 = 
sb
->
mš_avaabË_luns
 - 1;

794 
j
 = 0; j < 
sdev
->
max_luns_š_group
; j++) {

795 
lun_off£t
 = (
	`fœ¡_lun
(
group
)-group->
¡¬t_lun
+
j
)%
sdev
->
max_luns_š_group
 + group->start_lun;

796 ià(!
	`is_bad_lun
(
sb
, 
lun_off£t
)) {

797 
k
--;

798 
	`shªnÚ_£q_´štf
(
s
, "%d%s", 
lun_off£t
, 
k
 ? "-" : "\n");

799 ià(!
k
)

803 ià(
k
)

804 
	`shªnÚ_£q_´štf
(
s
, "XXX: used_data_luns…arsingƒrror!\n");

806 
	`shªnÚ_£q_´štf
(
s
, "\n");

808 
	`shªnÚ_£q_´štf
(
s
, "----------------------------------------------------------------\n");

809 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

811 
	}
}

813 
shªnÚ_£q_İ”©iÚs_t
 
	gsbs_£q_İs
;

815 
	$debugfs_dump_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

817 
»t
;

819 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
sbs_£q_İs
, 
£q_dump_¡¬t
);

820 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
sbs_£q_İs
, 
£q_dump_Ãxt
);

821 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
sbs_£q_İs
, 
£q_dump_¡İ
);

822 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
sbs_£q_İs
, 
£q_dump_show
);

823 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
sbs_£q_İs
);

824 ià(0 =ğ
»t
)

825 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

826  
»t
;

827 
	}
}

829 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_dump_fİs
;

832 *
	$hÙ_blocks_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

834 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

835 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

836  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
u£d_blocks
[
HOT_INDEX
], *
pos
);

837 
	}
}

839 *
	$hÙ_blocks_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

841  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
u£d_blocks
[
HOT_INDEX
], 
pos
);

842 
	}
}

844 
	$hÙ_blocks_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

846 
	`shªnÚ_¥š_uÆock_bh
(&((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
u£d_blocks_lock
[
HOT_INDEX
]);

847 
	}
}

849 
	$blocks_li¡_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

851 
shªnÚ_sb
 *
sb
 = 
	`cÚš”_of
(
v
, shªnÚ_sb, 
li¡
);

853 
	`shªnÚ_£q_´štf
(
s
, "sb_index=%3d, state=%18s(%3d), valid_pages=%7d, in_write=%d,‡vail_luns=%d, seq_num=%7ld,ƒrase_count=%d, flag=0x%x.\n",

854 
sb
->
sb_šdex
, 
	`¡©e_Çme
(sb->
¡©e
), sb->¡©e, 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
),

855 
	`shªnÚ_©omic_»ad
(&
sb
->
š_wr™e_logicbs
), shªnÚ_©omic_»ad(&sb->
avaabË_luns
), (
ulÚg
)sb->
£q_num
,

856 
sb
->
”a£_couÁ”
, sb->
»şaim_kšd
);

858 
	}
}

860 
shªnÚ_£q_İ”©iÚs_t
 
	ghÙ_blocks_£q_İs
;

862 
	$debugfs_hÙ_blocks_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

864 
»t
;

865 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
hÙ_blocks_£q_İs
, 
hÙ_blocks_£q_¡¬t
);

866 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
hÙ_blocks_£q_İs
, 
hÙ_blocks_£q_Ãxt
);

867 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
hÙ_blocks_£q_İs
, 
hÙ_blocks_£q_¡İ
);

868 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
hÙ_blocks_£q_İs
, 
blocks_li¡_£q_show
);

869 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
hÙ_blocks_£q_İs
);

870 ià(0 =ğ
»t
)

871 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

872  
»t
;

873 
	}
}

875 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_hÙ_blocks_fİs
;

877 *
	$cŞd_blocks_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

879 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

880 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

881  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
u£d_blocks
[
COLD_INDEX
], *
pos
);

882 
	}
}

884 *
	$cŞd_blocks_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

886  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
u£d_blocks
[
COLD_INDEX
], 
pos
);

887 
	}
}

889 
	$cŞd_blocks_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

891 
	`shªnÚ_¥š_uÆock_bh
(&((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
u£d_blocks_lock
[
COLD_INDEX
]);

892 
	}
}

894 
shªnÚ_£q_İ”©iÚs_t
 
	gcŞd_blocks_£q_İs
;

896 
	$debugfs_cŞd_blocks_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

898 
»t
;

899 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
cŞd_blocks_£q_İs
, 
cŞd_blocks_£q_¡¬t
);

900 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
cŞd_blocks_£q_İs
, 
cŞd_blocks_£q_Ãxt
);

901 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
cŞd_blocks_£q_İs
, 
cŞd_blocks_£q_¡İ
);

902 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
cŞd_blocks_£q_İs
, 
blocks_li¡_£q_show
);

903 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
cŞd_blocks_£q_İs
);

904 ià(0 =ğ
»t
)

905 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

906  
»t
;

907 
	}
}

909 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_cŞd_blocks_fİs
;

911 *
	$wa™_”a£d_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

913 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

914 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_”a£d_lock
);

915  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
wa™_”a£d
, *
pos
);

916 
	}
}

918 *
	$wa™_”a£d_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

920  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
wa™_”a£d
, 
pos
);

921 
	}
}

923 
	$wa™_”a£d_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

925 
	`shªnÚ_¥š_uÆock_bh
(&((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
wa™_”a£d_lock
);

926 
	}
}

928 
shªnÚ_£q_İ”©iÚs_t
 
	gwa™_”a£d_£q_İs
;

930 
	$debugfs_wa™_”a£d_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

932 
»t
;

933 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
wa™_”a£d_£q_İs
, 
wa™_”a£d_£q_¡¬t
);

934 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
wa™_”a£d_£q_İs
, 
wa™_”a£d_£q_Ãxt
);

935 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
wa™_”a£d_£q_İs
, 
wa™_”a£d_£q_¡İ
);

936 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
wa™_”a£d_£q_İs
, 
blocks_li¡_£q_show
);

937 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
wa™_”a£d_£q_İs
);

938 ià(0 =ğ
»t
)

939 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

940  
»t
;

941 
	}
}

943 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_wa™_”a£d_fİs
;

945 *
	$wa™_cİy_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

947 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

948 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_cİy_lock
);

949  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
wa™_cİy
, *
pos
);

950 
	}
}

952 *
	$wa™_cİy_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

954  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
wa™_cİy
, 
pos
);

955 
	}
}

957 
	$wa™_cİy_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

959 
	`shªnÚ_¥š_uÆock_bh
(&((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
wa™_cİy_lock
);

960 
	}
}

962 
shªnÚ_£q_İ”©iÚs_t
 
	gwa™_cİy_£q_İs
;

964 
	$debugfs_wa™_cİy_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

966 
»t
;

967 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
wa™_cİy_£q_İs
, 
wa™_cİy_£q_¡¬t
);

968 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
wa™_cİy_£q_İs
, 
wa™_cİy_£q_Ãxt
);

969 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
wa™_cİy_£q_İs
, 
wa™_cİy_£q_¡İ
);

970 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
wa™_cİy_£q_İs
, 
blocks_li¡_£q_show
);

971 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
wa™_cİy_£q_İs
);

972 ià(0 =ğ
»t
)

973 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

974  
»t
;

975 
	}
}

977 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_wa™_cİy_fİs
;

979 *
	$ä“_blocks_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

981 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

982 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

983  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
ä“_blocks
, *
pos
);

984 
	}
}

986 *
	$ä“_blocks_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

988  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
ä“_blocks
, 
pos
);

989 
	}
}

991 
	$ä“_blocks_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

993 
	`shªnÚ_¥š_uÆock_bh
(&((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
ä“_blocks_lock
);

994 
	}
}

996 
shªnÚ_£q_İ”©iÚs_t
 
	gä“_blocks_£q_İs
;

998 
	$debugfs_ä“_blocks_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1000 
»t
;

1001 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
ä“_blocks_£q_İs
, 
ä“_blocks_£q_¡¬t
);

1002 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
ä“_blocks_£q_İs
, 
ä“_blocks_£q_Ãxt
);

1003 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
ä“_blocks_£q_İs
, 
ä“_blocks_£q_¡İ
);

1004 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
ä“_blocks_£q_İs
, 
blocks_li¡_£q_show
);

1005 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
ä“_blocks_£q_İs
);

1006 ià(0 =ğ
»t
)

1007 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1008  
»t
;

1009 
	}
}

1011 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_ä“_blocks_fİs
;

1013 *
	$”r_blks_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

1015 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1016 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
”r_blks_lock
);

1017  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
”r_blks
, *
pos
);

1018 
	}
}

1020 *
	$”r_blks_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

1022  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
”r_blks
, 
pos
);

1023 
	}
}

1025 
	$”r_blks_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1027 
	`shªnÚ_¥š_uÆock_bh
(&((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
”r_blks_lock
);

1028 
	}
}

1030 
shªnÚ_£q_İ”©iÚs_t
 
	g”r_blks_£q_İs
;

1032 
	$debugfs_”r_blks_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1034 
»t
;

1035 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
”r_blks_£q_İs
, 
”r_blks_£q_¡¬t
);

1036 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
”r_blks_£q_İs
, 
”r_blks_£q_Ãxt
);

1037 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
”r_blks_£q_İs
, 
”r_blks_£q_¡İ
);

1038 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
”r_blks_£q_İs
, 
blocks_li¡_£q_show
);

1039 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
”r_blks_£q_İs
);

1040 ià(0 =ğ
»t
)

1041 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1042  
»t
;

1043 
	}
}

1045 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_”r_blks_fİs
;

1047 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


1048 
shªnÚ_li¡_h—d
 
out¡ªdšg_sbios_li¡
;

1049 
shªnÚ_¥šlock_t
 
out¡ªdšg_sbios_li¡_lock
;

1051 
	$out¡ªdšg_sbios_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1053 
shªnÚ_bio
 *
sbio
 = 
	`cÚš”_of
(
v
, shªnÚ_bio, 
debug_li¡
);

1055 
	`shªnÚ_£q_´štf
(
s
, "ns_id=%3u,‚s_seq_num=%3u, dma_dir=%d, start_sector=%13lu, bio_size=%7u, status=%d, user_count=%d, wait_dev_pick_mask=0x%lx, sbio->tag=0x%lx.\n",

1056 
sbio
->
ns_id
, sbio->
ns_£q_num
, sbio->
dma_dœ
, sbio->
¡¬t_£ùÜ
, sbio->
bio_size
, sbio->
¡©us
, 
	`shªnÚ_©omic_»ad
(&sbio->
u£r_couÁ
), sbio->
wa™_dev_pick_mask
, sbio->
g
);

1058 
	}
}

1060 *
	$out¡ªdšg_sbios_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

1062 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

1063  
	`shªnÚ_£q_li¡_¡¬t
(&
out¡ªdšg_sbios_li¡
, *
pos
);

1064 
	}
}

1066 *
	$out¡ªdšg_sbios_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

1068  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &
out¡ªdšg_sbios_li¡
, 
pos
);

1069 
	}
}

1071 
	$out¡ªdšg_sbios_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1073 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

1074 
	}
}

1076 
shªnÚ_£q_İ”©iÚs_t
 
	gout¡ªdšg_sbios_£q_İs
;

1078 
	$debugfs_out¡ªdšg_sbios_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1080 
»t
;

1081 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
out¡ªdšg_sbios_£q_İs
, 
out¡ªdšg_sbios_£q_¡¬t
);

1082 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
out¡ªdšg_sbios_£q_İs
, 
out¡ªdšg_sbios_£q_Ãxt
);

1083 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
out¡ªdšg_sbios_£q_İs
, 
out¡ªdšg_sbios_£q_¡İ
);

1084 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
out¡ªdšg_sbios_£q_İs
, 
out¡ªdšg_sbios_£q_show
);

1085 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
out¡ªdšg_sbios_£q_İs
);

1086  
»t
;

1087 
	}
}

1089 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_out¡ªdšg_sbios_fİs
;

1091 
shªnÚ_li¡_h—d
 
out¡ªdšg_»qs_li¡
;

1092 
shªnÚ_¥šlock_t
 
out¡ªdšg_»qs_li¡_lock
;

1094 
	$out¡ªdšg_»qs_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1096 
shªnÚ_»que¡
 *
»q
 = 
	`cÚš”_of
(
v
, shªnÚ_»que¡, 
debug_li¡
);

1098 
	`shªnÚ_£q_´štf
(
s
, "lun=%3d,†un_pba=%8d,‚s_id=%2u,‚s_seq_num=%3u, state=%2d,„eread=0x%x,†ba=%9ld, opcode=0x%x,ƒcc=0x%x,„eq->index=0x%x,ag=0x%lx.\n",

1099 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
ns_id
,„eq->
ns_£q_num
,„eq->
¡©e
,„eq->
»»ad
,

1100 
»q
->
lba
,„eq->
İcode
,„eq->
_ecc
,„eq->
šdex
,„eq->
g
);

1102 
	}
}

1104 *
	$out¡ªdšg_»qs_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

1106 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

1107  
	`shªnÚ_£q_li¡_¡¬t
(&
out¡ªdšg_»qs_li¡
, *
pos
);

1108 
	}
}

1110 *
	$out¡ªdšg_»qs_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

1112  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &
out¡ªdšg_»qs_li¡
, 
pos
);

1113 
	}
}

1115 
	$out¡ªdšg_»qs_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1117 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

1118 
	}
}

1120 
shªnÚ_£q_İ”©iÚs_t
 
	gout¡ªdšg_»qs_£q_İs
;

1122 
	$debugfs_out¡ªdšg_»qs_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1124 
»t
;

1125 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
out¡ªdšg_»qs_£q_İs
, 
out¡ªdšg_»qs_£q_¡¬t
);

1126 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
out¡ªdšg_»qs_£q_İs
, 
out¡ªdšg_»qs_£q_Ãxt
);

1127 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
out¡ªdšg_»qs_£q_İs
, 
out¡ªdšg_»qs_£q_¡İ
);

1128 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
out¡ªdšg_»qs_£q_İs
, 
out¡ªdšg_»qs_£q_show
);

1129 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
out¡ªdšg_»qs_£q_İs
);

1130  
»t
;

1131 
	}
}

1133 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_out¡ªdšg_»qs_fİs
;

1136 
	$»q_queue_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1138 
shªnÚ_»que¡
 *
»q
 = 
	`cÚš”_of
(
v
, shªnÚ_»que¡, 
li¡
);

1140 
	`shªnÚ_£q_´štf
(
s
, "%13s(0x%4x),‚s_id=%u,‚s_seq_num=%u,†ba=0x%lx,†un=%2d,†un_pba=0x%x, head=%d,ag=0x%lx.\n",

1141 
	`İcode_Çme
(
»q
->
İcode
),„eq->İcode,„eq->
ns_id
,„eq->
ns_£q_num
,

1142 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
h—d
,„eq->
g
);

1144 
	}
}

1146 *
	$»q_queue0_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

1148 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1149 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»q_queue_lock
[0]);

1150  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
»q_queue
[0], *
pos
);

1151 
	}
}

1153 *
	$»q_queue0_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

1155  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
»q_queue
[0], 
pos
);

1156 
	}
}

1158 
	$»q_queue0_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1160 
	`shªnÚ_¥š_uÆock_bh
(&(((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
»q_queue_lock
[0]));

1161 
	}
}

1163 
shªnÚ_£q_İ”©iÚs_t
 
	g»q_queue0_£q_İs
;

1165 
	$debugfs_»q_queue0_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1167 
»t
;

1168 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
»q_queue0_£q_İs
, 
»q_queue0_£q_¡¬t
);

1169 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
»q_queue0_£q_İs
, 
»q_queue0_£q_Ãxt
);

1170 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
»q_queue0_£q_İs
, 
»q_queue0_£q_¡İ
);

1171 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
»q_queue0_£q_İs
, 
»q_queue_£q_show
);

1172 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
»q_queue0_£q_İs
);

1173 ià(0 =ğ
»t
)

1174 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1175  
»t
;

1176 
	}
}

1178 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_»q_queue0_fİs
;

1180 *
	$»q_queue1_£q_¡¬t
(
shªnÚ_£q_fe_t
 *
s
, 
shªnÚ_loff_t
 *
pos
)

1182 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1183 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»q_queue_lock
[1]);

1184  
	`shªnÚ_£q_li¡_¡¬t
(&
sdev
->
»q_queue
[1], *
pos
);

1185 
	}
}

1187 *
	$»q_queue1_£q_Ãxt
(
shªnÚ_£q_fe_t
 *
s
, *
v
, 
shªnÚ_loff_t
 *
pos
)

1189  
	`shªnÚ_£q_li¡_Ãxt
(
v
, &((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
»q_queue
[1], 
pos
);

1190 
	}
}

1192 
	$»q_queue1_£q_¡İ
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1194 
	`shªnÚ_¥š_uÆock_bh
(&(((
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
s
))->
»q_queue_lock
[1]));

1195 
	}
}

1197 
shªnÚ_£q_İ”©iÚs_t
 
	g»q_queue1_£q_İs
;

1199 
	$debugfs_»q_queue1_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1201 
»t
;

1202 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
»q_queue1_£q_İs
, 
»q_queue1_£q_¡¬t
);

1203 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
»q_queue1_£q_İs
, 
»q_queue1_£q_Ãxt
);

1204 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
»q_queue1_£q_İs
, 
»q_queue1_£q_¡İ
);

1205 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
»q_queue1_£q_İs
, 
»q_queue_£q_show
);

1206 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
»q_queue1_£q_İs
);

1207 ià(0 =ğ
»t
)

1208 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1209  
»t
;

1210 
	}
}

1212 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_»q_queue1_fİs
;

1214 
	$cmd_queue_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1216 
i
;

1217 
shªnÚ_lun£t
 *
lun£t
;

1218 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1220 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

1221 
lun£t
 = &
sdev
->
lun£ts
[
i
];

1222 
	`shªnÚ_£q_´štf
(
s
, "lun£t=%2d.\n", 
i
);

1223 
	`shªnÚ_£q_´štf
(
s
, " sq_hw_head=0x%x, sq_hw_tail=0x%x, cq_hw_head=0x%x.\n",

1224 
lun£t
->
sq_hw_h—d
,†un£t->
sq_hw_
,†un£t->
cq_hw_h—d
);

1225 
	`shªnÚ_£q_´štf
(
s
, " sq_head=0x%x, sq_head_tmp=0x%x, cq_head=0x%x, cq_tail=0x%x, cq_tail_tmp=0x%x.\n",

1226 
lun£t
->
sq_h—d
,†un£t->
sq_h—d_tmp
,†un£t->
cq_h—d
,†un£t->
cq_
,†un£t->
cq__tmp
);

1227 
	`shªnÚ_£q_puts
(
s
, "-----------------------------------------------------------------\n");

1229 #ifdeà
SHANNON_USE_WRITE_BUFFER


1230 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

1231 
	`shªnÚ_£q_´štf
(
s
, " bufq_sq_hw_head=0x%x, bufq_sq_hw_tail=0x%x, bufq_cq_hw_head=0x%x.\n",

1232 
sdev
->
bufq_sq_hw_h—d
[
i
], sdev->
bufq_sq_hw_
[i], sdev->
bufq_cq_hw_h—d
[i]);

1233 
	`shªnÚ_£q_´štf
(
s
, " bufq_sq_head=0x%x, bufq_sq_head_tmp=0x%x, bufq_cq_head=0x%x, bufq_cq_tail=0x%x.\n",

1234 
sdev
->
bufq_sq_h—d
[
i
], sdev->
bufq_sq_h—d_tmp
[i], sdev->
bufq_cq_h—d
[i], sdev->
bufq_cq_
[i]);

1235 
	`shªnÚ_£q_puts
(
s
, "-----------------------------------------------------------------\n");

1239 
	}
}

1241 
	$debugfs_cmd_queue_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1243  
	`shªnÚ_sšgË_İ’
(
fe
, 
cmd_queue_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1244 
	}
}

1246 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_cmd_queue_fİs
;

1248 
	$cmd_queue_¿w_d©a_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1250 
k
 = 0;

1251 
__u32
 *
d©a
;

1252 
shªnÚ_lun£t
 *
lun£t
 = (shªnÚ_lun£ˆ*)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1254 
	`shªnÚ_£q_´štf
(
s
, "command_queue:\n");

1255 
k
 = 0; k < 
QUEUE_SIZE
 / 32; k++) {

1256 
d©a
 = (
__u32
 *)((*)
lun£t
->
sq_addr
 + 
k
 * 32);

1257 
	`shªnÚ_£q_´štf
(
s
, "%04.4x: %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x\n", \

1258 
k
 * 32, *
d©a
, *(data + 1), *(data + 2), *(data + 3), *(data + 4), *(data + 5), *(data + 6), *(data + 7));

1260 
	`shªnÚ_£q_´štf
(
s
, "completion_queue:\n");

1261 
k
 = 0; k < 
QUEUE_SIZE
 / 32; k++) {

1262 
d©a
 = (
__u32
 *)((*)
lun£t
->
cq_addr
 + 
k
 * 32);

1263 
	`shªnÚ_£q_´štf
(
s
, "%04.4x: %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x\n", \

1264 
k
 * 32, *
d©a
, *(data + 1), *(data + 2), *(data + 3), *(data + 4), *(data + 5), *(data + 6), *(data + 7));

1267 
	}
}

1269 
	$debugfs_cmd_queue_¿w_d©a_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1271  
	`shªnÚ_sšgË_İ’
(
fe
, 
cmd_queue_¿w_d©a_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1272 
	}
}

1274 
	$cmd_queue_¿w_d©a_bufq0_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1276 #ifdeà
SHANNON_USE_WRITE_BUFFER


1277 
k
 = 0;

1278 
__u32
 *
d©a
;

1279 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1281 
	`shªnÚ_£q_´štf
(
s
, "command_queue:\n");

1282 
k
 = 0; k < 
QUEUE_SIZE
 / 32; k++) {

1283 
d©a
 = (
__u32
 *)((*)
sdev
->
bufq_sq_addr
[0] + 
k
 * 32);

1284 
	`shªnÚ_£q_´štf
(
s
, "%04.4x: %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x\n", \

1285 
k
 * 32, *
d©a
, *(data + 1), *(data + 2), *(data + 3), *(data + 4), *(data + 5), *(data + 6), *(data + 7));

1287 
	`shªnÚ_£q_´štf
(
s
, "completion_queue:\n");

1288 
k
 = 0; k < 
QUEUE_SIZE
 / 32; k++) {

1289 
d©a
 = (
__u32
 *)((*)
sdev
->
bufq_cq_addr
[0] + 
k
 * 32);

1290 
	`shªnÚ_£q_´štf
(
s
, "%04.4x: %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x\n", \

1291 
k
 * 32, *
d©a
, *(data + 1), *(data + 2), *(data + 3), *(data + 4), *(data + 5), *(data + 6), *(data + 7));

1295 
	}
}

1297 
	$debugfs_cmd_queue_¿w_d©a_bufq0_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1299  
	`shªnÚ_sšgË_İ’
(
fe
, 
cmd_queue_¿w_d©a_bufq0_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1300 
	}
}

1302 
	$cmd_queue_¿w_d©a_bufq1_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1304 #ifdeà
SHANNON_USE_WRITE_BUFFER


1305 
k
 = 0;

1306 
__u32
 *
d©a
;

1307 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1309 
	`shªnÚ_£q_´štf
(
s
, "command_queue:\n");

1310 
k
 = 0; k < 
QUEUE_SIZE
 / 32; k++) {

1311 
d©a
 = (
__u32
 *)((*)
sdev
->
bufq_sq_addr
[1] + 
k
 * 32);

1312 
	`shªnÚ_£q_´štf
(
s
, "%04.4x: %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x\n", \

1313 
k
 * 32, *
d©a
, *(data + 1), *(data + 2), *(data + 3), *(data + 4), *(data + 5), *(data + 6), *(data + 7));

1315 
	`shªnÚ_£q_´štf
(
s
, "completion_queue:\n");

1316 
k
 = 0; k < 
QUEUE_SIZE
 / 32; k++) {

1317 
d©a
 = (
__u32
 *)((*)
sdev
->
bufq_cq_addr
[1] + 
k
 * 32);

1318 
	`shªnÚ_£q_´štf
(
s
, "%04.4x: %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x %08.8x\n", \

1319 
k
 * 32, *
d©a
, *(data + 1), *(data + 2), *(data + 3), *(data + 4), *(data + 5), *(data + 6), *(data + 7));

1323 
	}
}

1325 
	$debugfs_cmd_queue_¿w_d©a_bufq1_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1327  
	`shªnÚ_sšgË_İ’
(
fe
, 
cmd_queue_¿w_d©a_bufq1_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1328 
	}
}

1330 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_cmd_queue_¿w_d©a_fİs
;

1331 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_cmd_queue_¿w_d©a_bufq0_fİs
;

1332 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_cmd_queue_¿w_d©a_bufq1_fİs
;

1334 
	$gc_¡©e_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1336 
gc_block_¡©e
 *
gc_¡©e
;

1337 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1338 
shªnÚ_ov”Ïp
 *
Ş
;

1339 #ifdeà
CONFIG_RECORD_PBA_TABLE_IN_GC


1340 
i
;

1343 
	`shªnÚ_£q_´štf
(
s
, "h—d_couÁ=%d.\n", 
sdev
->
h—d_couÁ
);

1344 
	`shªnÚ_£q_´štf
(
s
, "HOT_PC: sb=%d, group=%d,†un_in_group=%d,†un_offset=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

1345 
sdev
->
wr_sb
[
HOT_INDEX
], sdev->
wr_group
[HOT_INDEX], sdev->
lun_š_group
[HOT_INDEX], sdev->
wr_lun_off£t
[HOT_INDEX],

1346 
sdev
->
wr_chunk
[
HOT_INDEX
], sdev->
wr_¶ªe
[HOT_INDEX], sdev->
wr_·ge
[HOT_INDEX], sdev->
wr_logicb
[HOT_INDEX]);

1347 
	`shªnÚ_£q_´štf
(
s
, "hÙ_»qút=%d.\n", 
sdev
->
chunk_»qút
[
HOT_INDEX
]);

1348 
	`shªnÚ_£q_´štf
(
s
, "hÙ_»q=%p.\n", 
sdev
->
chunk_»q
[
HOT_INDEX
]);

1349 
	`shªnÚ_£q_´štf
(
s
, "COLD_PC: sb=%d, group=%d,†un_in_group=%d,†un_offset=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

1350 
sdev
->
wr_sb
[
COLD_INDEX
], sdev->
wr_group
[COLD_INDEX], sdev->
lun_š_group
[COLD_INDEX], sdev->
wr_lun_off£t
[COLD_INDEX],

1351 
sdev
->
wr_chunk
[
COLD_INDEX
], sdev->
wr_¶ªe
[COLD_INDEX], sdev->
wr_·ge
[COLD_INDEX], sdev->
wr_logicb
[COLD_INDEX]);

1352 
	`shªnÚ_£q_´štf
(
s
, "cŞd_»qút=%d.\n", 
sdev
->
chunk_»qút
[
COLD_INDEX
]);

1353 
	`shªnÚ_£q_´štf
(
s
, "cŞd_»q=%p.\n\n", 
sdev
->
chunk_»q
[
COLD_INDEX
]);

1354 
	`shªnÚ_£q_´štf
(
s
, "³riod_»ad_¡©e=%d.\n", 
sdev
->
³riod_»ad
.
¡©e
);

1355 
	`shªnÚ_£q_´štf
(
s
, "gc_th»ad_¡©e=%d.\n", 
sdev
->
gc_th»ad_¡©e
);

1356 
	`shªnÚ_£q_´štf
(
s
, "š_gc_blkút=%d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_blkút
));

1358 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
gc_¡©e_li¡_lock
);

1359 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
gc_¡©e_li¡
)) {

1360 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
gc_¡©e
, &
sdev
->
gc_¡©e_li¡
, 
li¡
) {

1361 
	`shªnÚ_£q_´štf
(
s
, "sb_šdex=%d.\n", 
gc_¡©e
->
sb_šdex
);

1362 
	`shªnÚ_£q_´štf
(
s
, "v®id_·ges=%d.\n", 
gc_¡©e
->
v®id_·ges
);

1363 
	`shªnÚ_£q_´štf
(
s
, "gc_š_æight=%d.\n", 
sdev
->
sbs
[
gc_¡©e
->
sb_šdex
].
gc_š_æight
);

1364 
	`shªnÚ_£q_´štf
(
s
, "bad_lun[0]=0x%lx.\n", 
gc_¡©e
->
bad_lun
[0]);

1365 
	`shªnÚ_£q_´štf
(
s
, "”rÜ_lun[0]=0x%lx.\n", 
gc_¡©e
->
”rÜ_lun
[0]);

1366 #ifdeà
CONFIG_RECORD_PBA_TABLE_IN_GC


1367 ià(
gc_¡©e
->
pba_bË
) {

1368 
i
 = 0; i < 
gc_¡©e
->
pba_bË_Ën
; i++) {

1369 ià(
i
%32 == 0)

1370 
	`shªnÚ_£q_´štf
(
s
, "\n");

1371 ià(
i
%(
sdev
->
logicbs_š_siblšg_eblock
 * 
PBA_ENTRY_LEN
 / 8) == 0)

1372 
	`shªnÚ_£q_´štf
(
s
, "\n");

1373 
	`shªnÚ_£q_´štf
(
s
, "%2x ", 
gc_¡©e
->
pba_bË
[
i
]);

1377 
	`shªnÚ_£q_´štf
(
s
, "\n");

1380 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_¡©e_li¡_lock
);

1382 ià(!
sdev
->
ov”Ïp_wr™e
 || !sdev->
ov”Ïp
)

1385 
Ş
 = 
sdev
->
ov”Ïp
;

1386 
	`shªnÚ_£q_´štf
(
s
, "overlap_info:\n");

1387 
	`shªnÚ_£q_´štf
(
s
, "wr_logicb=%d.\n", 
Ş
->
wr_logicb
);

1388 
	`shªnÚ_£q_´štf
(
s
, "wr_·ge=%d.\n", 
Ş
->
wr_·ge
);

1389 
	`shªnÚ_£q_´štf
(
s
, "wr_chunk=%d.\n", 
Ş
->
wr_chunk
);

1390 
	`shªnÚ_£q_´štf
(
s
, "wr_¶ªe=%d.\n", 
Ş
->
wr_¶ªe
);

1391 
	`shªnÚ_£q_´štf
(
s
, "wr_sb=%d.\n", 
sdev
->
mbr
.
ov”Ïp_sblk
);

1392 
	`shªnÚ_£q_´štf
(
s
, "wr_lun=%d.\n", 
Ş
->
pba
.
lun
);

1393 
	`shªnÚ_£q_´štf
(
s
, "wr_lun_pba=%d.\n", 
Ş
->
pba
.
lun_pba
);

1394 
	`shªnÚ_£q_´štf
(
s
, "lba=0x%16llx, buf_lba=0x%16llx, head=0x%x, hit_count=%lu.\n", \

1395 
Ş
->
_m‘ad©a
, ol->
bufãd_m‘ad©a
, ol->
h—d
, ol->
h™_couÁ
);

1398 
	}
}

1400 
	$debugfs_gc_¡©e_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1402  
	`shªnÚ_sšgË_İ’
(
fe
, 
gc_¡©e_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1403 
	}
}

1405 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_gc_¡©e_fİs
;

1407 #ià!
defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

1408 
	$»gi¡”s_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1410 
i
;

1411 
u32
 
æash_Üg
, 
£ùÜ_Üg
, 
·ge_Üg
, 
¿id_šfo
, 
ecc_Üg
, 
misc
, 
süm_£ed
, 
süm_mask
, 
fw_v”siÚ
;

1412 
u32
 
sq_addr0
, 
sq_addr1
, 
cq_addr0
, 
cq_addr1
, 
sq_h—d
, 
cq_h—d
, 
sq_
, 
lun_¡©us
;

1413 #ifdeà
SHANNON_USE_WRITE_BUFFER


1414 
u32
 
ack_h—d
, 
ack_
;

1416 
shªnÚ_lun£t
 *
lun£t
;

1417 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1419 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1420 
æash_Üg
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->
æash
);

1421 
£ùÜ_Üg
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->
logicb
);

1422 
·ge_Üg
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->
·ge
);

1423 
¿id_šfo
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->raid_info);

1424 
ecc_Üg
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->
ecc
);

1425 
misc
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->misc);

1426 
süm_£ed
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->
süambËr_£ed
);

1427 
süm_mask
 = 
	`shªnÚ_»adl
(&
sdev
->
glob®_b¬
->
süambËr_mask
);

1428 
fw_v”siÚ
 = 
	`shªnÚ_»adl
(&
sdev
->
b¬
->
fœmw¬e_v”siÚ
);

1429 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1431 
	`shªnÚ_£q_´štf
(
s
, "Global configuration(DWORD 192):\n");

1432 
	`shªnÚ_£q_´štf
(
s
, "æash orgªiz©iÚ: 0x%x.\n", 
æash_Üg
);

1433 
	`shªnÚ_£q_´štf
(
s
, "£ùÜ orgªiz©iÚ: 0x%x.\n", 
£ùÜ_Üg
);

1434 
	`shªnÚ_£q_´štf
(
s
, "·ge/chunk orgªiz©iÚ: 0x%x.\n", 
·ge_Üg
);

1435 
	`shªnÚ_£q_´štf
(
s
, "RAID info: 0x%x.\n", 
¿id_šfo
);

1436 
	`shªnÚ_£q_´štf
(
s
, "ECC orgªiz©iÚ: 0x%x.\n", 
ecc_Üg
);

1437 
	`shªnÚ_£q_´štf
(
s
, "Misc: 0x%x.\n", 
misc
);

1438 
	`shªnÚ_£q_´štf
(
s
, "SüambË¸£ed: 0x%x.\n", 
süm_£ed
);

1439 
	`shªnÚ_£q_´štf
(
s
, "SüambË¸mask: 0x%x.\n", 
süm_mask
);

1440 
	`shªnÚ_£q_´štf
(
s
, "Fœmw¬v”siÚ: %8.8x.\n", 
fw_v”siÚ
);

1442 
	`shªnÚ_£q_´štf
(
s
, "\nper LUN section:");

1443 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

1444 
lun£t
 = &
sdev
->
lun£ts
[
i
];

1446 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1447 
sq_addr0
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->
sq_dma_addr0
);

1448 
sq_addr1
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->
sq_dma_addr1
);

1449 
cq_addr0
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->
cq_dma_addr0
);

1450 
cq_addr1
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->
cq_dma_addr1
);

1451 
sq_h—d
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->sq_head);

1452 
cq_h—d
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->cq_head);

1453 
sq_
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->sq_tail);

1454 
lun_¡©us
 = 
	`shªnÚ_»adl
(&
lun£t
->
lun_b¬
->lun_status);

1455 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1457 
	`shªnÚ_£q_´štf
(
s
, "\Æun£t=%d.\n", 
lun£t
->
šdex
);

1458 
	`shªnÚ_£q_´štf
(
s
, "sq_dma_addr0=0x%x.\n", 
sq_addr0
);

1459 
	`shªnÚ_£q_´štf
(
s
, "sq_dma_addr1=0x%x.\n", 
sq_addr1
);

1460 
	`shªnÚ_£q_´štf
(
s
, "cq_dma_addr0=0x%x.\n", 
cq_addr0
);

1461 
	`shªnÚ_£q_´štf
(
s
, "cq_dma_addr1=0x%x.\n", 
cq_addr1
);

1462 
	`shªnÚ_£q_´štf
(
s
, "sq_h—d = 0x%x.\n", 
sq_h—d
);

1463 
	`shªnÚ_£q_´štf
(
s
, "cq_h—d = 0x%x.\n", 
cq_h—d
);

1464 
	`shªnÚ_£q_´štf
(
s
, "sq_ = 0x%x.\n", 
sq_
);

1465 
	`shªnÚ_£q_´štf
(
s
, "lun_¡©u ğ0x%x.\n", 
lun_¡©us
);

1467 #ifdeà
SHANNON_USE_WRITE_BUFFER


1468 
	`shªnÚ_£q_´štf
(
s
, "\nBuffer Queue section:");

1469 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

1470 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1471 
sq_addr0
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->
sq_dma_addr0
);

1472 
sq_addr1
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->
sq_dma_addr1
);

1473 
cq_addr0
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->
cq_dma_addr0
);

1474 
cq_addr1
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->
cq_dma_addr1
);

1475 
sq_h—d
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->sq_head);

1476 
cq_h—d
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->cq_head);

1477 
sq_
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->sq_tail);

1478 
lun_¡©us
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_b¬
[
i
]->lun_status);

1479 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1481 
	`shªnÚ_£q_´štf
(
s
, "\ni=%d.\n", 
i
);

1482 
	`shªnÚ_£q_´štf
(
s
, "sq_dma_addr0=0x%x.\n", 
sq_addr0
);

1483 
	`shªnÚ_£q_´štf
(
s
, "sq_dma_addr1=0x%x.\n", 
sq_addr1
);

1484 
	`shªnÚ_£q_´štf
(
s
, "cq_dma_addr0=0x%x.\n", 
cq_addr0
);

1485 
	`shªnÚ_£q_´štf
(
s
, "cq_dma_addr1=0x%x.\n", 
cq_addr1
);

1486 
	`shªnÚ_£q_´štf
(
s
, "sq_h—d = 0x%x.\n", 
sq_h—d
);

1487 
	`shªnÚ_£q_´štf
(
s
, "cq_h—d = 0x%x.\n", 
cq_h—d
);

1488 
	`shªnÚ_£q_´štf
(
s
, "sq_ = 0x%x.\n", 
sq_
);

1489 
	`shªnÚ_£q_´štf
(
s
, "lun_¡©u ğ0x%x.\n", 
lun_¡©us
);

1493 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1494 
cq_addr0
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_ack_b¬
->
cq_dma_addr0
);

1495 
cq_addr1
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_ack_b¬
->
cq_dma_addr1
);

1496 
ack_h—d
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_ack_b¬
->
cq_h—d
);

1497 
ack_
 = 
	`shªnÚ_»adl
(&
sdev
->
bufq_ack_b¬
->
ack_cq_
);

1498 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1500 
	`shªnÚ_£q_´štf
(
s
, "\nBuffer Ack Queue section:");

1501 
	`shªnÚ_£q_´štf
(
s
, "cq_dma_addr0=0x%x.\n", 
cq_addr0
);

1502 
	`shªnÚ_£q_´štf
(
s
, "cq_dma_addr1=0x%x.\n", 
cq_addr1
);

1503 
	`shªnÚ_£q_´štf
(
s
, "ack_cq_h—d =0x%x.\n", 
ack_h—d
);

1504 
	`shªnÚ_£q_´štf
(
s
, "ack_cq_ =0x%x.\n", 
ack_
);

1507 
	}
}

1509 
	$debugfs_»gi¡”s_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1511  
	`shªnÚ_sšgË_İ’
(
fe
, 
»gi¡”s_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1512 
	}
}

1514 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_»gi¡”s_fİs
;

1517 
	$queue_d•th_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1519 
i
, 
j
;

1520 
shªnÚ_lun£t
 *
lun£t
;

1521 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1523 
	`shªnÚ_£q_´štf
(
s
, "\nper LUN section:");

1524 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

1525 
lun£t
 = &
sdev
->
lun£ts
[
i
];

1526 
	`shªnÚ_£q_´štf
(
s
, "\Æun£t=%d.\n", 
lun£t
->
šdex
);

1527 
	`shªnÚ_£q_´štf
(
s
, "depth | both | command_queue | completion_queue\n");

1528 
j
 = 0; j < 17; j++) {

1529 
	`shªnÚ_£q_´štf
(
s
, " %2d: %6d, %6d, %6d.\n", 
j
, 
lun£t
->
queue_d•th
[j],†un£t->
cmd_queue_d•th
[j],†un£t->
comp_queue_d•th
[j]);

1533 
	}
}

1535 
	$debugfs_queue_d•th_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1537  
	`shªnÚ_sšgË_İ’
(
fe
, 
queue_d•th_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1538 
	}
}

1540 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_queue_d•th_fİs
;

1542 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


1543 
	$sq_d•th_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1545 
i
, 
j
;

1546 
shªnÚ_lun£t
 *
lun£t
;

1547 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1549 
	`shªnÚ_£q_´štf
(
s
, "Queue depth in shannon_pick_request:\n:");

1550 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

1551 
lun£t
 = &
sdev
->
lun£ts
[
i
];

1552 
	`shªnÚ_£q_´štf
(
s
, "\Æun=%d.\n", 
lun£t
->
šdex
);

1553 
	`shªnÚ_£q_´štf
(
s
, "depth | command_queue | sq‡nd cq\n");

1554 
j
 = 0; j < 11; j++) {

1555 
	`shªnÚ_£q_´štf
(
s
, " %2d: %8d, %20d.\n", 
j
, 
lun£t
->
pick_sq_d•th
[j],†un£t->
pick_scq_d•th
[j]);

1559 
	}
}

1561 
	$debugfs_sq_d•th_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1563  
	`shªnÚ_sšgË_İ’
(
fe
, 
sq_d•th_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1564 
	}
}

1566 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_sq_d•th_fİs
;

1570 
shªnÚ_mempoŞ_t
 *
shªnÚ_»q_poŞ
;

1571 
shªnÚ_mempoŞ_t
 *
shªnÚ_bio_poŞ
;

1572 
shªnÚ_pm_qos_v®ue
;

1573 
shªnÚ_pm_qos_di§bË
;

1574 
shªnÚ_u£_iosched
;

1575 
	#SH_DCM_DEBUG_OFFSET
 0x18

	)

1577 
	$lun_¡©i¡ics_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1579 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1580 
shªnÚ_lun
 *
lun
 = 
NULL
;

1582 
i
 = 0, 
j
 = 0;

1584 
max_ecc
 = 0, 
max_adv_ecc
 = 0;

1586 
	`shªnÚ_£q_´štf
(
s
, "======lun statistics:======\n");

1588 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

1589 
max_ecc
 = 0;

1590 
max_adv_ecc
 = 0;

1591 
lun
 = 
sdev
->lun[
i
];

1593 
j
 = 0; j <ğ
sdev
->
ecc_cÜ»ùiÚ_pow”
; j++) {

1594 ià((
lun
->
ecc_¡©i¡ics
[
j
] !ğ0è&& (j > 
max_ecc
))

1595 
max_ecc
 = 
j
;

1596 ià((
lun
->
adv_»ad_ecc_¡©i¡ics
[
j
] !ğ0è&& (j > 
max_adv_ecc
))

1597 
max_adv_ecc
 = 
j
;

1600 
	`shªnÚ_£q_´štf
(
s
, "luÀ%4d:ƒcc_çu»_times=%d, max_ecc=%d,‡dv_»ad_çu»_times=%d, max_adv_ecc=%d, bad_blk_couÁ=%d, dyÇmic_bad_blkút=%d,‚ext_em±y_·ge=%d\n", 
i
, \

1601 
	`shªnÚ_©omic_»ad
(&
lun
->
ecc_çu»_times
), 
max_ecc
, shªnÚ_©omic_»ad(&lun->
adv_»ad_çu»_times
), 
max_adv_ecc
,\

1602 
lun
->
bad_blk_couÁ
, 
	`shªnÚ_©omic_»ad
(&lun->
dyÇmic_bad_blkút
), shªnÚ_©omic_»ad(&lun->
Ãxt_em±y_·ge
));

1605 
	`shªnÚ_£q_´štf
(
s
, "\n======detailed†unƒcc statistics:======\n");

1607 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

1608 
lun
 = 
sdev
->lun[
i
];

1610 
	`shªnÚ_£q_´štf
(
s
, "-----------------------------------------------------------------\n");

1611 
	`shªnÚ_£q_´štf
(
s
, "luÀ%d:\n", 
i
);

1613 
	`shªnÚ_£q_´štf
(
s
, "\Ãcc_çu»_times %d.\n", 
	`shªnÚ_©omic_»ad
(&
lun
->
ecc_çu»_times
));

1614 
j
 = 0; j <ğ
sdev
->
ecc_cÜ»ùiÚ_pow”
; j++)

1615 
	`shªnÚ_£q_´štf
(
s
, "%db™s_cÜ»ùed_by_ecc %Îu.\n", 
j
, 
lun
->
ecc_¡©i¡ics
[j]);

1617 
	`shªnÚ_£q_´štf
(
s
, "\Çdv_»ad_çu»_times %d.\n", 
	`shªnÚ_©omic_»ad
(&
lun
->
adv_»ad_çu»_times
));

1618 
j
 = 0; j <ğ
sdev
->
ecc_cÜ»ùiÚ_pow”
; j++)

1619 
	`shªnÚ_£q_´štf
(
s
, "%db™s_cÜ»ùed_by_ecc %Îu.\n", 
j
, 
lun
->
adv_»ad_ecc_¡©i¡ics
[j]);

1620 
	`shªnÚ_£q_´štf
(
s
, "-----------------------------------------------------------------\n");

1624 
	}
}

1626 
	$debugfs_lun_¡©i¡ics_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1628  
	`shªnÚ_sšgË_İ’
(
fe
, 
lun_¡©i¡ics_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1629 
	}
}

1631 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_lun_¡©i¡ics_fİs
;

1634 
has_dma_d–ay
;

1635 
	$¡©i¡ics_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1637 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1638 
shªnÚ_´eãtch
 *
´eãtch
 = &
sdev
->
sdisk
.prefetch;

1639 
i
 = 0;

1641 
	`shªnÚ_£q_´štf
(
s
, "======general configuration======\n");

1642 
	`shªnÚ_£q_´štf
(
s
, "pm_qos_di§bË %d.\n", 
shªnÚ_pm_qos_di§bË
);

1643 
	`shªnÚ_£q_´štf
(
s
, "pm_qos_v®ue %d.\n", 
shªnÚ_pm_qos_v®ue
);

1644 
	`shªnÚ_£q_´štf
(
s
, "u£_iosched %d.\n", 
shªnÚ_u£_iosched
);

1645 
	`shªnÚ_£q_´štf
(
s
, "dcm_debug %08X\n", 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 
SH_DCM_DEBUG_OFFSET
));

1646 
	`shªnÚ_£q_´štf
(
s
, "\n======prefetch statistics=======\n");

1647 
	`shªnÚ_£q_´štf
(
s
, "ÿche_¡©e %s.\n", (
	`g‘_´eãtch_’abË_¡©e
(&
sdev
->
sdisk
.
´eãtch
)) ? "enable" : "disable");

1648 ià(
	`g‘_´eãtch_’abË_¡©e
(&
sdev
->
sdisk
.
´eãtch
)) {

1649 
	`shªnÚ_£q_´štf
(
s
, "run_¡©e %s.\n", (
	`g‘_´eãtch_wÜkšg_¡©e
(&
sdev
->
sdisk
.
´eãtch
)) ? "working" : "sleeping");

1650 
	`shªnÚ_£q_´štf
(
s
, "ÿche_size %luK.\n", 
sdev
->
sdisk
.
´eãtch
.
tÙ®_size
 / 1024);

1651 
	`shªnÚ_£q_´štf
(
s
, "ÿche_lšes %lu.\n", 
sdev
->
sdisk
.
´eãtch
.
ÿche_lšes
);

1652 
	`shªnÚ_£q_´štf
(
s
, "ÿche_lše_size %luK.\n", (
sdev
->
sdisk
.
´eãtch
.
lba_³r_lše
 * sdev->
logicb_size
) / 1024);

1653 
	`shªnÚ_£q_´štf
(
s
, "¦Ù_³r_lše %lu.\n", 
sdev
->
sdisk
.
´eãtch
.
lba_³r_lše
 / sdev->sdisk.´eãtch.
ÿche_³r_¦Ù
);

1654 
	`shªnÚ_£q_´štf
(
s
, "¦Ù_size %luK.\n", (
sdev
->
sdisk
.
´eãtch
.
ÿche_³r_¦Ù
 * sdev->
logicb_size
) / 1024);

1655 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_´eãtch %lu.\n", 
sdev
->
sdisk
.
´eãtch
.
´eãtch_couÁ
);

1656 
	`shªnÚ_£q_´štf
(
s
, "ÿche_h™s %lu(%u%).\n", 
sdev
->
sdisk
.
´eãtch
.
ÿche_h™s
,

1657 
´eãtch
->
ÿche_h™s
 * 100 / (´eãtch->ÿche_h™ +…»ãtch->
ÿche_miss
 +…»ãtch->
wa™_ÿche_»ad_h™s
 + 1));

1658 
	`shªnÚ_£q_´štf
(
s
, "ÿche_miss %lu(%u%).\n", 
sdev
->
sdisk
.
´eãtch
.
ÿche_miss
,

1659 
´eãtch
->
ÿche_miss
 * 100 / (´eãtch->
ÿche_h™s
 +…»ãtch->ÿche_mis +…»ãtch->
wa™_ÿche_»ad_h™s
 + 1));

1660 
	`shªnÚ_£q_´štf
(
s
, "wa™_ÿche_»ad_h™s %lu(%u%).\n", 
sdev
->
sdisk
.
´eãtch
.
wa™_ÿche_»ad_h™s
,

1661 
´eãtch
->
wa™_ÿche_»ad_h™s
 * 100 / (´eãtch->
ÿche_h™s
 +…»ãtch->
ÿche_miss
 +…refetch->wait_cache_read_hits + 1));

1663 
	`shªnÚ_£q_´štf
(
s
, "\n======permanent statistics======\n");

1664 
	`upd©e_”a£_couÁ
(
sdev
);

1665 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

1666 ià(
sdev
->
¥oŞ
) {

1667 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

1668 
shªnÚ_Çme¥aû
 *
ns
 = 
sdev
->
¥oŞ
->ns[
i
];

1669 ià(
ns
)

1670 
	`shªnÚ_£q_´štf
(
s
, "n %d v®id_logicbs %lu.\n", 
i
, 
	`g‘_sdisk_v®id_logicbs
(&
ns
->
sdisk
));

1673 
	`shªnÚ_£q_´štf
(
s
, "v®id_logicbs %lu.\n", 
	`g‘_sdisk_v®id_logicbs
(&
sdev
->
sdisk
));

1675 
	`shªnÚ_£q_´štf
(
s
, "œq_d–ay %d.\n", 
sdev
->
œq_d–ay
.irq_delay);

1676 
	`shªnÚ_£q_´štf
(
s
, "ho¡_acûss_blocked %d.\n", 
sdev
->
ho¡_acûss_blocked
);

1677 
	`shªnÚ_£q_´štf
(
s
, "pow”_Ú_£cÚds %Îu.\n", 
sdev
->
pow”_Ú_£cÚds
);

1678 
	`shªnÚ_£q_´štf
(
s
, "pow”_cyşe_couÁ %d.\n", 
sdev
->
pow”_cyşe_couÁ
);

1679 
	`shªnÚ_£q_´štf
(
s
, "max_”a£_couÁ %d.\n", 
sdev
->
max_”a£_couÁ
);

1680 
	`shªnÚ_£q_´štf
(
s
, "mš_”a£_couÁ %d.\n", 
sdev
->
mš_”a£_couÁ
);

1681 
	`shªnÚ_£q_´štf
(
s
, "av”age_”a£_couÁ %d.\n", 
sdev
->
av”age_”a£_couÁ
);

1682 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_”a£_couÁ %d.\n", 
sdev
->
tÙ®_”a£_couÁ
);

1683 
	`shªnÚ_£q_´štf
(
s
, "v¬Ÿnû_of_”a£_couÁ %d/100.\n", 
sdev
->
v¬Ÿnû_of_”a£_couÁ
);

1684 
	`upd©e_io_¡©i¡ics
(
sdev
);

1685 
	`shªnÚ_£q_´štf
(
s
, "ho¡_wr™e_£ùÜs %Îu.\n", 
sdev
->
ho¡_wr™e_£ùÜs
);

1686 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_wr™e_£ùÜs %Îu.\n", 
sdev
->
tÙ®_wr™e_£ùÜs
);

1687 
	`shªnÚ_£q_´štf
(
s
, "ho¡_wr™e_iİs %Îu.\n", 
sdev
->
ho¡_wr™e_iİs
);

1688 
	`shªnÚ_£q_´štf
(
s
, "ho¡_wr™e_bªdwidth %Îu KB/s.\n", 
sdev
->
ho¡_wr™e_bªdwidth
);

1689 
	`shªnÚ_£q_´štf
(
s
, "ho¡_wr™e_Ï‹ncy %Îu us.\n", 
sdev
->
ho¡_wr™e_Ï‹ncy
);

1690 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_have_»ad_£ùÜs
(sdev);

1691 
	`shªnÚ_£q_´štf
(
s
, "ho¡_»ad_£ùÜs %Îu.\n", 
sdev
->
ho¡_»ad_£ùÜs
);

1692 
	`shªnÚ_£q_´štf
(
s
, "ho¡_»ad_iİs %Îu.\n", 
sdev
->
ho¡_»ad_iİs
);

1693 
	`shªnÚ_£q_´štf
(
s
, "ho¡_»ad_bªdwidth %Îu KB/s.\n", 
sdev
->
ho¡_»ad_bªdwidth
);

1694 
	`shªnÚ_£q_´štf
(
s
, "ho¡_»ad_Ï‹ncy %Îu us.\n", 
sdev
->
ho¡_»ad_Ï‹ncy
);

1695 
	`shªnÚ_£q_´štf
(
s
, "¢­_»ad_couÁ” %Îu.\n", 
	`shªnÚ_©omic64_»ad
(&
sdev
->
¢­_»ad_couÁ”
));

1696 
	`shªnÚ_£q_´štf
(
s
, "³riod_»ad_blkút %Îu.\n", 
sdev
->
³riod_»ad
.
blkút
);

1697 
	`shªnÚ_£q_´štf
(
s
, "³riod_»ad_š‹rv® %Îu ms.\n", 
	`shªnÚ_jiff›s_to_m£cs
(
sdev
->
³riod_»ad
.
_š‹rv®
));

1698 
	`shªnÚ_£q_´štf
(
s
, "¡©ic_bad_blkút %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
¡©ic_bad_blkút
));

1699 
	`shªnÚ_£q_´štf
(
s
, "dyÇmic_bad_blkút %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
dyÇmic_bad_blkút
));

1700 
	`shªnÚ_£q_´štf
(
s
, "\n======impermanent statistics======\n");

1701 
	`shªnÚ_£q_´štf
(
s
, "m­bË_poŞ_ä“út %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
m­_bË_poŞ
.
ä“_út
));

1702 
	`shªnÚ_£q_´štf
(
s
, "m­bË_poŞ_u£dút %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
m­_bË_poŞ
.
u£d_út
));

1703 
	`shªnÚ_£q_´štf
(
s
, "m­bË_poŞ_mšt %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
m­_bË_poŞ
.
mš_th»shŞd
));

1704 
	`shªnÚ_£q_´štf
(
s
, "m­bË_poŞ_maxt %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
m­_bË_poŞ
.
max_th»shŞd
));

1705 
	`shªnÚ_£q_´štf
(
s
, "‹m±abË_poŞ_ä“út %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
‹mp_bË_poŞ
.
ä“_út
));

1706 
	`shªnÚ_£q_´štf
(
s
, "‹m±abË_poŞ_u£dút %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
‹mp_bË_poŞ
.
u£d_út
));

1707 
	`shªnÚ_£q_´štf
(
s
, "‹m±abË_poŞ_mšt %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
‹mp_bË_poŞ
.
mš_th»shŞd
));

1708 
	`shªnÚ_£q_´štf
(
s
, "‹m±abË_poŞ_maxt %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
‹mp_bË_poŞ
.
max_th»shŞd
));

1709 
	`shªnÚ_£q_´štf
(
s
, "buf_»ad_çed %Îu.\n", 
sdev
->
buf_»ad_çed
);

1710 
	`shªnÚ_£q_´štf
(
s
, "bufãr_wr™e_couÁ” %Îu.\n", 
sdev
->
bufãr_wr™e_couÁ”
);

1711 
	`shªnÚ_£q_´štf
(
s
, "dœeù_wr™e_couÁ” %Îu.\n", 
sdev
->
dœeù_wr™e_couÁ”
);

1712 
	`shªnÚ_£q_´štf
(
s
, "fl_İ’_chunk_logicbs %Îu.\n", 
sdev
->
fl_İ’_chunk_logicbs
);

1713 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++)

1714 
	`shªnÚ_£q_´štf
(
s
, "aùive_blk_İ’_time[%d] %Îu s.\n", 
i
, 
	`shªnÚ_jiff›s_to_m£cs
(
	`g‘_jiff›s
(è- 
sdev
->
aùive_blk_¡¬t_jiff›s
[i]) / 1000);

1715 
	`shªnÚ_£q_´štf
(
s
, "gc_»şaimed_block  %d.\n", 
sdev
->
gc_sbs
);

1716 
	`shªnÚ_£q_´štf
(
s
, "”r_»cov”ed_block  %d.\n", 
sdev
->
”r_»cov”ed_sbs
);

1717 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_”r_»cov”_logicb  %Îu.\n", 
sdev
->
tÙ®_”r_»cov”_logicbs
);

1720 
	`shªnÚ_£q_´štf
(
s
, "wl_»şaimed_block  %d.\n", 
sdev
->
wl_sbs
);

1721 
	`shªnÚ_£q_´štf
(
s
, "d©a_»‹ÁiÚ_block  %d.\n", 
sdev
->
d©a_»‹ÁiÚ_sbs
);

1722 
	`shªnÚ_£q_´štf
(
s
, "»ad_di¡urb_block  %d.\n", 
sdev
->
»ad_di¡urb_sbs
);

1723 
	`shªnÚ_£q_´štf
(
s
, "”a£_b®ªû_block  %d.\n", 
sdev
->
”a£_b®ªû_sbs
);

1724 
	`shªnÚ_£q_´štf
(
s
, "ecc_çu»_block  %d.\n", 
sdev
->
ecc_çu»_sbs
);

1725 
	`shªnÚ_£q_´štf
(
s
, "š_wl_logicbs %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_wl_logicbs
));

1726 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_wl_logicb  %Îu.\n", 
sdev
->
tÙ®_wl_logicbs
);

1727 
	`shªnÚ_£q_´štf
(
s
, "š_wl_blkút %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_wl_blkút
));

1728 #ifdeà
CONFIG_SHANNON_STATISTICS


1729 
	`shªnÚ_£q_´štf
(
s
, "»que¡s_äom_gc %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
äom_gc
));

1730 
	`shªnÚ_£q_´štf
(
s
, "»que¡s_äom_ho¡ %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
äom_ho¡
));

1732 
	`shªnÚ_£q_´štf
(
s
, "wr™e_»qs_š_»q_queue[0] %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[0]));

1733 
	`shªnÚ_£q_´štf
(
s
, "wr™e_»qs_š_»q_queue[1] %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[1]));

1734 
	`shªnÚ_£q_´štf
(
s
, "wr™e_»qs_š_»q_queue[2] %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[2]));

1735 
	`shªnÚ_£q_´štf
(
s
, "gc_wr™e_»qs %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
gc_wr™e_»qs
));

1736 
	`shªnÚ_£q_´štf
(
s
, "exŒa_»qs %ld.\n", 
sdev
->
exŒa_»qs
);

1737 
	`shªnÚ_£q_´štf
(
s
, "gc_th»ads %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
gc_th»ads
));

1738 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


1739 
	`shªnÚ_£q_´štf
(
s
, "»ad_bios %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
»ad_bios
));

1740 
	`shªnÚ_£q_´štf
(
s
, "wr™e_bios %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_bios
));

1742 
	`shªnÚ_£q_´štf
(
s
, "š_block_¡©e %d.\n", 
sdev
->
š_block_¡©e
);

1743 
	`shªnÚ_£q_´štf
(
s
, "ä“_blkút %d.\n", 
sdev
->
ä“_blkút
);

1744 
	`shªnÚ_£q_´štf
(
s
, "wa™_cİy_blkúˆ %d.\n", 
sdev
->
wa™_cİy_blkút
);

1745 
	`shªnÚ_£q_´štf
(
s
, "hÙ_blkút %d.\n", 
sdev
->
u£d_blkút
[
HOT_INDEX
]);

1746 
	`shªnÚ_£q_´štf
(
s
, "cŞd_blkút %d.\n", 
sdev
->
u£d_blkút
[
COLD_INDEX
]);

1747 
	`shªnÚ_£q_´štf
(
s
, "š_æight_wr™e_»qs %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_æight_wr™es
è+ shªnÚ_©omic_»ad(&sdev->
gc_š_æight
));

1748 
	`shªnÚ_£q_´štf
(
s
, "š_gc_logicbs %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
));

1749 
	`shªnÚ_£q_´štf
(
s
, "š_cmd_queue_wr™e  %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_cmd_queue_wr™es
));

1750 
	`shªnÚ_£q_´štf
(
s
, "š_cmd_queue_adv_»ads %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_cmd_queue_adv_»ads
));

1751 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_gc_logicb  %Îu.\n", 
sdev
->
tÙ®_gc_logicbs
);

1752 
	`shªnÚ_£q_´štf
(
s
, "logicb_buf_couÁ %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
logicb_buf_couÁ
));

1753 
	`shªnÚ_£q_´štf
(
s
, "disk_š_æight %d.\n", 
	`shªnÚ_bio_š_æight
(
sdev
));

1755 
	`shªnÚ_£q_´štf
(
s
, "”r_blkút %d.\n", 
sdev
->
”r_blkút
);

1756 
	`shªnÚ_£q_´štf
(
s
, "³ndšg_”r_blk  %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
³ndšg_”r_blks
));

1757 
	`shªnÚ_£q_´štf
(
s
, "this_”r_sb %d.\n", 
sdev
->
this_”r_sb_šdex
);

1758 
	`shªnÚ_£q_´štf
(
s
, "this_”r_¡re %d.\n", 
sdev
->
this_”r_¡re
);

1759 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_»ad_bªdwidth %ld.\n", 
sdev
->
tÙ®_»ad_bªdwidth
);

1760 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_wr™e_bªdwidth %ld.\n", 
sdev
->
tÙ®_wr™e_bªdwidth
);

1761 #ifdeà
SHANNON_USE_WRITE_BUFFER


1762 
	`shªnÚ_£q_´štf
(
s
, "bufãr_wr™e_lim™ %d.\n", 
sdev
->
bufãr_wr™e_lim™
);

1763 
	`shªnÚ_£q_´štf
(
s
, "bufq_d•th(0) %d.\n", 
	`bufq_queue_d•th
(
sdev
, 0));

1764 
	`shªnÚ_£q_´štf
(
s
, "bufq_d•th(1) %d.\n", 
	`bufq_queue_d•th
(
sdev
, 1));

1766 
	`shªnÚ_£q_´štf
(
s
, "shªnÚ_»q_poŞ couÁ %d.\n", 
	`g‘_mempoŞ_couÁ
(
shªnÚ_»q_poŞ
));

1767 
	`shªnÚ_£q_´štf
(
s
, "shªnÚ_bio_poŞ couÁ %d.\n", 
	`g‘_mempoŞ_couÁ
(
shªnÚ_bio_poŞ
));

1768 
	`shªnÚ_£q_´štf
(
s
, "logicb_buf_poŞ couÁ %d.\n", 
	`g‘_mempoŞ_couÁ
(
sdev
->
logicb_buf_poŞ
));

1769 ià(
has_dma_d–ay
) {

1770 
	`shªnÚ_£q_´štf
(
s
, "¡©us_»Œy %ld %ld.\n", 
sdev
->
¡©us_pŞl_couÁ
, sdev->
¡©us_pŞl_»Œy
);

1771 
	`shªnÚ_£q_´štf
(
s
, "»ad_»Œy %ld %ld.\n", 
sdev
->
»ad_pŞl_couÁ
, sdev->
»ad_pŞl_»Œy
);

1772 
	`shªnÚ_£q_´štf
(
s
, "bufq_»Œy %ld %ld.\n", 
sdev
->
bufq_pŞl_couÁ
, sdev->
bufq_pŞl_»Œy
);

1774 
	`shªnÚ_£q_´štf
(
s
, "\n======ecc statistics======\n");

1775 ià(!
	`shªnÚ_dev_is_g5_ff§
(
sdev
))

1776 
	`»ad_£u_šfo
(
sdev
);

1777 
	`shªnÚ_£q_´štf
(
s
, "ecc_cÜ»ùiÚ_pow” %u.\n", 
sdev
->
ecc_cÜ»ùiÚ_pow”
);

1778 
	`shªnÚ_£q_´štf
(
s
, "ecc_codewÜd_size %u.\n", 
sdev
->
ecc_codewÜd_size
);

1779 
	`shªnÚ_£q_´štf
(
s
, "£u_üc_”rÜ %u.\n", 
sdev
->
£u_üc_”rÜ
);

1780 
	`shªnÚ_£q_´štf
(
s
, "£u_üc_”rÜ_hi¡Üy %u.\n", 
sdev
->
£u_üc_”rÜ_hi¡Üy
);

1781 
	`shªnÚ_£q_´štf
(
s
, "£u_ecc_”rÜ %u.\n", 
sdev
->
£u_ecc_”rÜ
);

1782 
	`shªnÚ_£q_´štf
(
s
, "£u_ecc_”rÜ_hi¡Üy %u.\n", 
sdev
->
£u_ecc_”rÜ_hi¡Üy
);

1783 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_»cÚfig_times %u.\n", 
sdev
->
tÙ®_»cÚfig_times
);

1784 
	`shªnÚ_£q_´štf
(
s
, "ecc_çu»_times %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
ecc_çu»_times
));

1785 
	`shªnÚ_£q_´štf
(
s
, "¢­_»ad_mism©ch %Îu.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
¢­_»ad_mism©ch
));

1786 
	`shªnÚ_£q_´štf
(
s
, "ecc_fc_¡©i¡ics %d.\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
ecc_fc_¡©i¡ics
));

1787 
i
 = 0; i <ğ
sdev
->
ecc_cÜ»ùiÚ_pow”
; i++)

1788 
	`shªnÚ_£q_´štf
(
s
, "%db™s_cÜ»ùed_by_ecc %Îu.\n", 
i
, 
sdev
->
ecc_¡©i¡ics
[i]);

1791 
	}
}

1793 
	$debugfs_¡©i¡ics_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1795  
	`shªnÚ_sšgË_İ’
(
fe
, 
¡©i¡ics_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1796 
	}
}

1798 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_¡©i¡ics_fİs
;

1800 
	$bßrd_·¿m‘”s_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1802 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1803 
	`shªnÚ_£q_´štf
(
s
, "max_chªÃl  %d\n", 
sdev
->
max_chªÃls
);

1804 
	`shªnÚ_£q_´štf
(
s
, "max_lun£t_š_chªÃÈ %d\n", 
sdev
->
max_lun£t_š_chªÃl
);

1805 
	`shªnÚ_£q_´štf
(
s
, "max_lun_š_lun£ˆ %d\n", 
sdev
->
max_lun_š_lun£t
);

1806 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1807 
	`shªnÚ_£q_´štf
(
s
, "io_width %d\n", 
	`shªnÚ_»ad_»g
(&
sdev
->
glob®_b¬
->
¿id_šfo
, 
PER_BYTE_DISABLE
) == 0 ? 16 : 8);

1808 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1809 
	`shªnÚ_£q_´štf
(
s
, "ecc_cÜ»ùiÚ_pow” %d\n", 
sdev
->
ecc_cÜ»ùiÚ_pow”
);

1810 
	`shªnÚ_£q_´štf
(
s
, "ecc_codewÜds_š_logicb %d\n", 
sdev
->
ecc_codewÜds_š_logicb
);

1811 
	`shªnÚ_£q_´štf
(
s
, "æashid %016LX\n", 
sdev
->
æashid
);

1812 
	`shªnÚ_£q_´štf
(
s
, "subsy¡em_deviû_id %04X\n", 
sdev
->
pci_šfo
.
subsy¡em_deviû_id
);

1815 
	}
}

1817 
	$debugfs_bßrd_·¿m‘”s_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1819  
	`shªnÚ_sšgË_İ’
(
fe
, 
bßrd_·¿m‘”s_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1820 
	}
}

1822 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_bßrd_·¿m‘”s_fİs
;

1824 
	$»ad_couÁ_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1826 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1827 
shªnÚ_sb
 *
sb
, *
viùim
 = 
NULL
;

1828 
u32
 
max_»ad_couÁ
 = 0;

1829 
i
, 
lun
;

1831 
viùim
 = &
sdev
->
sbs
[0];

1832 
i
 = 0; i < 
sdev
->
sb_couÁ
; i++) {

1833 
sb
 = 
sdev
->
sbs
 + 
i
;

1834 
	`shªnÚ_£q_´štf
(
s
, "sb=%d, max=%u.…”†uÀcouÁ:", 
sb
->
sb_šdex
, sb->
max_»ad_couÁ
);

1835 ià(
sb
->
max_»ad_couÁ
 > max_read_count) {

1836 
max_»ad_couÁ
 = 
sb
->max_read_count;

1837 
viùim
 = 
sb
;

1839 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++)

1840 
	`shªnÚ_£q_´štf
(
s
, " %d(%u).", 
lun
, 
sb
->
»ad_couÁ
[lun]);

1841 
	`shªnÚ_£q_´štf
(
s
, "\n\n");

1843 
	`shªnÚ_£q_´štf
(
s
, "max_read_count sb=%d, max_read_count=%u, state=%d.\n",

1844 
viùim
->
sb_šdex
, viùim->
max_»ad_couÁ
, viùim->
¡©e
);

1846 
	}
}

1848 
	$debugfs_»ad_couÁ_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1850  
	`shªnÚ_sšgË_İ’
(
fe
, 
»ad_couÁ_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1851 
	}
}

1853 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_»ad_couÁ_fİs
;

1855 
	$ecc_çu»_times_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1857 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1858 
shªnÚ_sb
 *
sb
, *
viùim
 = 
NULL
;

1859 
max_lun_ecc_çu»_times
 = 0;

1860 
i
, 
lun
;

1862 
viùim
 = &
sdev
->
sbs
[0];

1863 
i
 = 0; i < 
sdev
->
sb_couÁ
; i++) {

1864 
sb
 = 
sdev
->
sbs
 + 
i
;

1865 
	`shªnÚ_£q_´štf
(
s
, "sb=%d, max=%d.…”†uÀcouÁ:", 
sb
->
sb_šdex
, sb->
max_lun_ecc_çu»_times
);

1866 ià(
sb
->
max_lun_ecc_çu»_times
 > max_lun_ecc_failure_times) {

1867 
max_lun_ecc_çu»_times
 = 
sb
->max_lun_ecc_failure_times;

1868 
viùim
 = 
sb
;

1870 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++)

1871 
	`shªnÚ_£q_´štf
(
s
, " %d(%u).", 
lun
, 
sb
->
ecc_çu»_times
[lun]);

1872 
	`shªnÚ_£q_´štf
(
s
, "\n\n");

1874 
	`shªnÚ_£q_´štf
(
s
, "max_lun_ecc_failure_times sb=%d, max_lun_ecc_failure_times=%d, state=%d.\n",

1875 
viùim
->
sb_šdex
, viùim->
max_lun_ecc_çu»_times
, viùim->
¡©e
);

1877 
	}
}

1879 
	$debugfs_ecc_çu»_times_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1881  
	`shªnÚ_sšgË_İ’
(
fe
, 
ecc_çu»_times_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1882 
	}
}

1884 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_ecc_çu»_times_fİs
;

1886 
	$bad_blocks_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1888 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1889 
shªnÚ_lun
 *
lun
;

1890 
i
, 
j
;

1891 
b™
 = 0;

1893 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

1894 
lun
 = 
sdev
->lun[
i
];

1895 ià(
	`is_¡©ic_bad_lun
(
sdev
, 
i
)) {

1896 
	`shªnÚ_£q_´štf
(
s
, "lun %d(bad=%d,‡vail_data_sbs=%d,‚ext_empty_page=%d) : static bad†un.\n",

1897 
i
, 
lun
->
bad
, 
	`shªnÚ_©omic_»ad
(&lun->
ava_d©a_sbs
), shªnÚ_©omic_»ad(&lun->
Ãxt_em±y_·ge
));

1899 
	`shªnÚ_£q_´štf
(
s
, "lun %d(bad=%d,‡vail_data_sbs=%d,‚ext_empty_page=%d) :",

1900 
i
, 
lun
->
bad
, 
	`shªnÚ_©omic_»ad
(&lun->
ava_d©a_sbs
), shªnÚ_©omic_»ad(&lun->
Ãxt_em±y_·ge
));

1901 
j
 = 0;

1902 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

1903 
	`shªnÚ_fÜ_—ch_£t_b™_Ë
(
b™
, 
lun
->
bbt
, 
LUN_BBT_SIZE
 * 8)

1904 
	`shªnÚ_£q_´štf
(
s
, " %d", 
b™
);

1905 } ià(
	`bbt_usšg_b™m­
(
lun
->
bbt
, 
sdev
)) {

1906 
	`shªnÚ_fÜ_—ch_£t_b™_Ë
(
b™
, (
u64
 *)
lun
->
bbt
 + 1, 
LUN_BBT_SIZE
 * 8 - 64)

1907 
	`shªnÚ_£q_´štf
(
s
, " %d", 
b™
);

1909 
lun
->
bbt
[
j
] != 0xFFFF) {

1910 
	`shªnÚ_£q_´štf
(
s
, " %d", 
lun
->
bbt
[
j
]);

1911 
j
++;

1914 
	`shªnÚ_£q_´štf
(
s
, "\n");

1919 
	}
}

1921 
	$debugfs_bad_blocks_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1923  
	`shªnÚ_sšgË_İ’
(
fe
, 
bad_blocks_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1924 
	}
}

1926 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_bad_blocks_fİs
;

1928 
	$rmw_li¡_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1930 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1931 
lba_li¡
 *
p
;

1932 
i
, 
j
;

1934 
i
 = 0; i < 2; i++) {

1935 
j
 = 0; j < 
RMW_LIST_COUNT
; j++) {

1936 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
sdisk
.
rmw_li¡_lock
[
i
][
j
]);

1937 
	`shªnÚ_£q_´štf
(
s
, "%s%2d:> ", 
i
?"wr™e":"»ad", 
j
);

1938 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
sdev
->
sdisk
.
rmw_li¡
[
i
][
j
], 
li¡
) {

1939 
	`shªnÚ_£q_´štf
(
s
, " %d=%d.", 
p
->
lba
,…->
¡©us
);

1941 
	`shªnÚ_£q_´štf
(
s
, "\n");

1942 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
sdisk
.
rmw_li¡_lock
[
i
][
j
]);

1944 
	`shªnÚ_£q_´štf
(
s
, "----------------------------------\n");

1948 
	}
}

1950 
	$debugfs_rmw_li¡_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1952  
	`shªnÚ_sšgË_İ’
(
fe
, 
rmw_li¡_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1953 
	}
}

1955 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_rmw_li¡_fİs
;

1958 
	$wa™queue_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

1960 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

1961 
i
;

1963 
	`shªnÚ_£q_´štf
(
s
, "lim™_»q_queue[0] \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
lim™_»q_queue
[0])?"ACTIVE":"EMPTY");

1964 
	`shªnÚ_£q_´štf
(
s
, "lim™_»q_queue[1] \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
lim™_»q_queue
[1])?"ACTIVE":"EMPTY");

1965 
	`shªnÚ_£q_´štf
(
s
, "·r™y_š™_dÚe_ev’t[0]\t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
·r™y_š™_dÚe_ev’t
[0])?"ACTIVE":"EMPTY");

1966 
	`shªnÚ_£q_´štf
(
s
, "·r™y_š™_dÚe_ev’t[1]\t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
·r™y_š™_dÚe_ev’t
[1])?"ACTIVE":"EMPTY");

1967 
	`shªnÚ_£q_´štf
(
s
, "block_ho¡_wr \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
block_ho¡_wr
)?"ACTIVE":"EMPTY");

1968 
	`shªnÚ_£q_´štf
(
s
, "wa™_ä“_blk \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
wa™_ä“_blk
)?"ACTIVE":"EMPTY");

1969 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

1970 
	`shªnÚ_£q_´štf
(
s
, "bufq_emu_wa™[0] %s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
bufq_emu_wa™
[0])?"ACTIVE":"EMPTY");

1971 
	`shªnÚ_£q_´štf
(
s
, "bufq_emu_wa™[1] %s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
bufq_emu_wa™
[1])?"ACTIVE":"EMPTY");

1973 #ifdeà
SHANNON_USE_WRITE_BUFFER


1974 
	`shªnÚ_£q_´štf
(
s
, "bufq_wa™_cmd_pos[0] \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
bufq_wa™_cmd_pos
[0])?"ACTIVE":"EMPTY");

1975 
	`shªnÚ_£q_´štf
(
s
, "bufq_wa™_cmd_pos[1] \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
bufq_wa™_cmd_pos
[1])?"ACTIVE":"EMPTY");

1977 
	`shªnÚ_£q_´štf
(
s
, "»cov”_dÚe_ev’t \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
»cov”_dÚe_ev’t
)?"ACTIVE":"EMPTY");

1978 
	`shªnÚ_£q_´štf
(
s
, "big_lock_ev’t \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
big_lock_ev’t
)?"ACTIVE":"EMPTY");

1979 
	`shªnÚ_£q_´štf
(
s
, "”a£_dÚe_ev’t %s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
”a£_dÚe_ev’t
)?"ACTIVE":"EMPTY");

1980 
	`shªnÚ_£q_´štf
(
s
, "wa™_pick_ev’t \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
wa™_pick_ev’t
)?"ACTIVE":"EMPTY");

1981 
	`shªnÚ_£q_´štf
(
s
, "”a£_dummy_dÚe_ev’t \t%s.\n", 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
”a£_dummy_dÚe_ev’t
)?"ACTIVE":"EMPTY");

1982 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

1983 
	`shªnÚ_£q_´štf
(
s
, "wa™_cmd_pos[%d] \t%s.\n", 
i
, 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
lun£ts
[i].
wa™_cmd_pos
)?"ACTIVE":"EMPTY");

1984 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

1985 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

1986 
	`shªnÚ_£q_´štf
(
s
, "emu_wa™[%d] \t%s.\n", 
i
, 
	`shªnÚ_wa™queue_aùive
(&
sdev
->
lun£ts
[i].
emu_wa™
)?"ACTIVE":"EMPTY");

1990 
	}
}

1993 
	$debugfs_wa™queue_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

1995  
	`shªnÚ_sšgË_İ’
(
fe
, 
wa™queue_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

1996 
	}
}

1998 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_wa™queue_fİs
;

2000 
	$lock_¡©_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2002 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2003 
	`shªnÚ_£q_´štf
(
s
, "pick_£m \t%s.\n", 
	`show_pick_£m_š_debugfs
(
sdev
)?"locked":"unlocked");

2005 
	}
}

2007 
	$debugfs_lock_¡©_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2009  
	`shªnÚ_sšgË_İ’
(
fe
, 
lock_¡©_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2010 
	}
}

2012 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_lock_¡©_fİs
;

2014 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


2016 
	$çke_wr_bad_luÅ·_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2018 
lun
, 
µa
;

2019 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2021 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

2022 
µa
 = 0;…· < 
sdev
->
sb_couÁ
 * sdev->
¶ªes
 * sdev->
·ges_š_eblock
;…pa++) {

2023 ià(
	`is_çke_wr_bad_luÅ·
(
sdev
, 
lun
, 
µa
)) {

2024 
	`shªnÚ_£q_´štf
(
s
, "lun=%d block=%d…age=%d\n",

2025 
lun
,

2026 
µa
 / 
sdev
->
·ges_š_eblock
,

2027 
µa
 % 
sdev
->
·ges_š_eblock
);

2033 
	}
}

2035 
	$debugfs_çke_wr_bad_luÅ·_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2037  
	`shªnÚ_sšgË_İ’
(
fe
, 
çke_wr_bad_luÅ·_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2038 
	}
}

2043 
shªnÚ_ssize_t
 
	$debugfs_çke_wr_bad_luÅ·_wr™e
(
shªnÚ_fe_t
 *
fe
, cÚ¡ 
__u£r
 *
bufãr
,

2044 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2046 
lun
, 
blkoff
, 
·geoff
;

2047 
lše
[16], *
p
, *
²ext
;

2048 
shªnÚ_dev
 *
sdev
;

2050 
sdev
 = (
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2052 ià(
couÁ
 > 16)

2053  -
EINVAL
;

2054 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2055  -
EFAULT
;

2058 
p
 = 
²ext
 = 
lše
;

2059 
²ext
 = 
	`¡rchr
(
p
, ',');

2060 ià(
NULL
 =ğ
²ext
) {

2061 
	`shªnÚ_”r
("Valid input:†un,blkoff,pageoff");

2062  -
EINVAL
;

2064 *
²ext
 = '\0';

2065 
lun
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2067 
p
 = ++
²ext
;

2068 
²ext
 = 
	`¡rchr
(
p
, ',');

2069 ià(
NULL
 =ğ
²ext
) {

2070 
	`shªnÚ_”r
("Valid input:†un,blkoff,pageoff");

2071  -
EINVAL
;

2073 *
²ext
 = '\0';

2074 
blkoff
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2076 
p
 = ++
²ext
;

2077 
·geoff
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2079 
	`shªnÚ_šfo
("%s:lun=%d, blkoff=%d,…ageoff=%d\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun
, 
blkoff
, 
·geoff
);

2081 ià(
lun
 >ğ
sdev
->
lun_couÁ
 || 
blkoff
 >ğsdev->
sb_couÁ
 * sdev->
¶ªes


2082 || 
·geoff
 >ğ
sdev
->
·ges_š_eblock
) {

2083 
	`shªnÚ_”r
("Overrang NAND‡ddress!\n");

2084  -
EINVAL
;

2086 
	`m¬k_çke_wr_bad_luÅ·
(
sdev
, 
lun
, 
blkoff
 * sdev->
·ges_š_eblock
 + 
·geoff
);

2088  
couÁ
;

2089 
	}
}

2091 
shªnÚ_fe_İ”©iÚs_t
 
	gçke_wr_bad_luÅ·_fİs
;

2094 
	$çke_rd_bad_luÅba_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2096 
pba
, 
lun
;

2097 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2099 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

2100 
pba
 = 0;…b¨< 
sdev
->
sb_couÁ
 * sdev->
logicbs_š_siblšg_eblock
;…ba++) {

2102 ià(
	`is_çke_rd_bad_luÅba
(
sdev
, 
lun
, 
pba
)) {

2103 
	`shªnÚ_£q_´štf
(
s
, "lun=%d block=%d…age=%d sector=%d\n",

2104 
lun
,

2105 (
pba
 / 
sdev
->
logicbs_š_·ge
è/ sdev->
·ges_š_eblock
,

2106 (
pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
,

2107 
pba
 % 
sdev
->
logicbs_š_·ge
);

2110 
	`shªnÚ_scheduË
();

2114 
	}
}

2116 
	$debugfs_çke_rd_bad_luÅba_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2118  
	`shªnÚ_sšgË_İ’
(
fe
, 
çke_rd_bad_luÅba_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2119 
	}
}

2126 
	$´_çke_rd_bad_luÅba_u§ge
()

2128 
	`shªnÚ_šfo
("User input format:ƒcho \"[@]lun,blkoff,pageoff,sectoroff\" > fake_rd_bad_lunpba\n"

2131 
	}
}

2133 
shªnÚ_ssize_t
 
	$debugfs_çke_rd_bad_luÅba_wr™e
(
shªnÚ_fe_t
 *
fe
, cÚ¡ 
__u£r
 *
bufãr
,

2134 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2136 
pba
, 
mode
;

2137 
lun
, 
blkoff
, 
·geoff
, 
£ùÜoff
;

2138 
lše
[32], *
p
, *
²ext
;

2139 
shªnÚ_dev
 *
sdev
;

2141 
sdev
 = (
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2143 ià(
couÁ
 > 32)

2144  -
EINVAL
;

2145 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2146  -
EFAULT
;

2148 ià('@' =ğ
lše
[0]) {

2149 
mode
 = 1;

2150 
p
 = 
²ext
 = &
lše
[1];

2152 
mode
 = 0;

2153 
p
 = 
²ext
 = &
lše
[0];

2155 
²ext
 = 
	`¡rchr
(
p
, ',');

2156 ià(
NULL
 =ğ
²ext
) {

2157 
	`´_çke_rd_bad_luÅba_u§ge
();

2158  -
EINVAL
;

2160 *
²ext
 = '\0';

2161 
lun
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2163 
p
 = ++
²ext
;

2164 
²ext
 = 
	`¡rchr
(
p
, ',');

2165 ià(
NULL
 =ğ
²ext
) {

2166 
	`´_çke_rd_bad_luÅba_u§ge
();

2167  -
EINVAL
;

2169 *
²ext
 = '\0';

2170 
blkoff
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2172 
p
 = ++
²ext
;

2173 
²ext
 = 
	`¡rchr
(
p
, ',');

2174 ià(
NULL
 =ğ
²ext
) {

2175 
	`´_çke_rd_bad_luÅba_u§ge
();

2176  -
EINVAL
;

2178 *
²ext
 = '\0';

2179 
·geoff
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2181 
p
 = ++
²ext
;

2182 
£ùÜoff
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2184 
	`shªnÚ_šfo
("%s:lun=%d, blkoff=%d,…ageoff=%d, seùÜoff=%d\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun
, 
blkoff
, 
·geoff
, 
£ùÜoff
);

2186 ià(
lun
 >ğ
sdev
->
lun_couÁ
 || 
blkoff
 >ğsdev->
sb_couÁ
 * sdev->
¶ªes


2187 || 
·geoff
 >ğ
sdev
->
·ges_š_eblock
 || 
£ùÜoff
 >ğsdev->
logicbs_š_·ge
) {

2188 
	`shªnÚ_”r
("Overrang NAND‡ddress!\n");

2189  -
EINVAL
;

2192 
pba
 = 
blkoff
 * (
sdev
->
logicbs_š_siblšg_eblock
 / sdev->
¶ªes
)

2193 + 
·geoff
 * 
sdev
->
logicbs_š_·ge


2194 + 
£ùÜoff
;

2195 ià(
mode
)

2196 
	`m¬k_çke_rd_bad_luÅba
(
sdev
, 
lun
, 
pba
);

2198 
	`m¬k_çke_rd_bad_luÅba_¿idmu‹x
(
sdev
, 
lun
, 
pba
);

2200  
couÁ
;

2201 
	}
}

2203 
shªnÚ_fe_İ”©iÚs_t
 
	gçke_rd_bad_luÅba_fİs
;

2206 
	$çke_”_bad_block_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2208 
lun
, 
blk
;

2209 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2211 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

2212 
blk
 = 0; blk < 
sdev
->
eblocks_š_lun
; blk++) {

2213 ià(
	`is_çke_”_bad_block
(
sdev
, 
lun
, 
blk
))

2214 
	`shªnÚ_£q_´štf
(
s
, "lun=%d block=%d\n", 
lun
, 
blk
);

2219 
	}
}

2221 
	$debugfs_çke_”_bad_block_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2223  
	`shªnÚ_sšgË_İ’
(
fe
, 
çke_”_bad_block_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2224 
	}
}

2229 
shªnÚ_ssize_t
 
	$debugfs_çke_”_bad_block_wr™e
(
shªnÚ_fe_t
 *
fe
, cÚ¡ 
__u£r
 *
bufãr
,

2230 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2232 
lun
, 
blk
;

2233 
lše
[16], *
p
, *
²ext
;

2234 
shªnÚ_dev
 *
sdev
;

2236 
sdev
 = (
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2238 ià(
couÁ
 > 16)

2239  -
EINVAL
;

2240 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2241  -
EFAULT
;

2243 
p
 = 
lše
;

2244 
lun
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, &
²ext
, 10);

2245 ià(',' !ğ*
²ext
) {

2246 
	`shªnÚ_”r
("Valid input:†un,blk\n");

2247  -
EINVAL
;

2250 
p
 = 
²ext
 + 1;

2251 
blk
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
p
, 
NULL
, 10);

2253 
	`debugs1
("lun=%d, blk=%d\n", 
lun
, 
blk
);

2255 ià(
lun
 >ğ
sdev
->
lun_couÁ
 || 
blk
 >ğsdev->
eblocks_š_lun
) {

2256 
	`shªnÚ_”r
("Overrang NAND‡ddress!\n");

2257  -
EINVAL
;

2259 
	`m¬k_çke_”_bad_block
(
sdev
, 
lun
, 
blk
);

2261  
couÁ
;

2262 
	}
}

2264 
shªnÚ_fe_İ”©iÚs_t
 
	gçke_”_bad_block_fİs
;

2267 
	$çke_bad_lun_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2269 
lun
;

2270 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2272 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

2273 ià(
	`is_çke_bad_lun
(
sdev
, 
lun
))

2274 
	`shªnÚ_£q_´štf
(
s
, "lun=%d%s\n", ()
lun
, 
sdev
->
çke_bad_lun_skmbr
 ? "x" : "");

2278 
	}
}

2280 
	$debugfs_çke_bad_lun_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2282  
	`shªnÚ_sšgË_İ’
(
fe
, 
çke_bad_lun_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2283 
	}
}

2288 
shªnÚ_ssize_t
 
	$debugfs_çke_bad_lun_wr™e
(
shªnÚ_fe_t
 *
fe
, cÚ¡ 
__u£r
 *
bufãr
,

2289 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2291 
lun
;

2292 
lše
[16], *
’d±r
;

2293 
shªnÚ_dev
 *
sdev
;

2295 
sdev
 = (
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2297 ià(
couÁ
 > 16)

2298  -
EINVAL
;

2299 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2300  -
EFAULT
;

2302 
lun
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
lše
, &
’d±r
, 10);

2303 
	`debugs1
("lun=%d\n", 
lun
);

2305 
sdev
->
çke_bad_lun_skmbr
 = ('x' =ğ*
’d±r
 || 'X' == *endptr);

2307 ià(
lun
 >ğ
sdev
->
lun_couÁ
) {

2308 
	`shªnÚ_”r
("Overrang†un‡mount!\n");

2309  -
EINVAL
;

2311 
	`m¬k_çke_bad_lun
(
sdev
, 
lun
);

2313  
couÁ
;

2314 
	}
}

2316 
shªnÚ_fe_İ”©iÚs_t
 
	gçke_bad_lun_fİs
;

2319 
	$çke_cmd_timeout_lun_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2321 
lun
;

2322 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2324 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

2325 ià(
	`is_çke_cmd_timeout_lun
(
sdev
, 
lun
))

2326 
	`shªnÚ_£q_´štf
(
s
, "lun=%d%s\n", ()
lun
, 
sdev
->
çke_cmd_timeout_lun_skmbr
 ? "x" : "");

2330 
	}
}

2332 
	$debugfs_çke_cmd_timeout_lun_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2334  
	`shªnÚ_sšgË_İ’
(
fe
, 
çke_cmd_timeout_lun_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2335 
	}
}

2340 
shªnÚ_ssize_t
 
	$debugfs_çke_cmd_timeout_lun_wr™e
(
shªnÚ_fe_t
 *
fe
, cÚ¡ 
__u£r
 *
bufãr
,

2341 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2343 
lun
;

2344 
lše
[16], *
’d±r
;

2345 
shªnÚ_dev
 *
sdev
;

2347 
sdev
 = (
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2349 ià(
couÁ
 > 16)

2350  -
EINVAL
;

2351 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2352  -
EFAULT
;

2354 
lun
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
lše
, &
’d±r
, 10);

2355 
	`debugs1
("lun=%d\n", 
lun
);

2357 
sdev
->
çke_cmd_timeout_lun_skmbr
 = ('x' =ğ*
’d±r
 || 'X' == *endptr);

2359 ià(
lun
 > 
sdev
->
lun_couÁ
) {

2360 
	`shªnÚ_”r
("Overrang†un‡mount!\n");

2361  -
EINVAL
;

2363 
	`m¬k_çke_cmd_timeout_lun
(
sdev
, 
lun
);

2365  
couÁ
;

2366 
	}
}

2368 
shªnÚ_fe_İ”©iÚs_t
 
	gçke_cmd_timeout_lun_fİs
;

2371 
	$çke_rd_bad_lun_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2373 
lun
;

2374 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2376 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

2377 ià(
	`is_çke_rd_bad_lun
(
sdev
, 
lun
))

2378 
	`shªnÚ_£q_´štf
(
s
, "lun=%d%s\n", ()
lun
, 
sdev
->
çke_bad_lun_skmbr
 ? "x" : "");

2382 
	}
}

2384 
	$debugfs_çke_rd_bad_lun_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2386  
	`shªnÚ_sšgË_İ’
(
fe
, 
çke_rd_bad_lun_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2387 
	}
}

2392 
shªnÚ_ssize_t
 
	$debugfs_çke_rd_bad_lun_wr™e
(
shªnÚ_fe_t
 *
fe
, cÚ¡ 
__u£r
 *
bufãr
,

2393 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2395 
lun
;

2396 
lše
[16], *
’d±r
;

2397 
shªnÚ_dev
 *
sdev
;

2399 
sdev
 = (
shªnÚ_dev
 *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2401 ià(
couÁ
 > 16)

2402  -
EINVAL
;

2403 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2404  -
EFAULT
;

2406 
lun
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
lše
, &
’d±r
, 10);

2408 
sdev
->
çke_bad_lun_skmbr
 = ('x' =ğ*
’d±r
 || 'X' == *endptr);

2409 
	`shªnÚ_log
("%s:set†un=%do fake„ead bad†un, skipmbr=%d.\n",

2410 
sdev
->
sdisk
.
disk_Çme
, 
lun
, sdev->
çke_bad_lun_skmbr
);

2412 ià(
lun
 >ğ
sdev
->
lun_couÁ
) {

2413 
	`shªnÚ_”r
("Overrang†un‡mount!\n");

2414  -
EINVAL
;

2416 
	`m¬k_çke_rd_bad_lun
(
sdev
, 
lun
);

2418  
couÁ
;

2419 
	}
}

2421 
shªnÚ_fe_İ”©iÚs_t
 
	gçke_rd_bad_lun_fİs
;

2423 
shªnÚ_size_t
 
	$debugfs_mªu®_»ad_”r_wr™e
(
shªnÚ_fe_t
 *
fe
,

2424 cÚ¡ 
__u£r
 *
bufãr
, 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2426 
v®ue
;

2427 
lše
[16], *
’d±r
;

2428 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2430 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2431  -
EFAULT
;

2433 
v®ue
 = 
	`sim¶e_¡¹oul
(
lše
, &
’d±r
, 0x10);

2434 
	`shªnÚ_šfo
("v®ue=%ld,ƒnd±r=%c.\n", 
v®ue
, *
’d±r
);

2435 
sdev
->
mªu®_»ad_”r
 = 
v®ue
;

2437  
couÁ
;

2438 
	}
}

2440 
	$mªu®_»ad_”r_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2442 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2443 
	`shªnÚ_£q_´štf
(
s
, "%d\n", 
sdev
->
mªu®_»ad_”r
);

2445 
	}
}

2447 
	$debugfs_mªu®_»ad_”r_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2449  
	`shªnÚ_sšgË_İ’
(
fe
, 
mªu®_»ad_”r_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2450 
	}
}

2452 
shªnÚ_fe_İ”©iÚs_t
 
	gmªu®_»ad_”r_fİs
;

2454 
shªnÚ_size_t
 
	$debugfs_mªu®_wr™e_”r_wr™e
(
shªnÚ_fe_t
 *
fe
,

2455 cÚ¡ 
__u£r
 *
bufãr
, 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2457 
v®ue
;

2458 
lše
[16], *
’d±r
;

2459 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2461 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2462  -
EFAULT
;

2464 
v®ue
 = 
	`sim¶e_¡¹oul
(
lše
, &
’d±r
, 0x10);

2465 
	`shªnÚ_šfo
("v®ue=%ld,ƒnd±r=%c.\n", 
v®ue
, *
’d±r
);

2466 
sdev
->
mªu®_wr™e_”r
 = 
v®ue
;

2468  
couÁ
;

2469 
	}
}

2471 
	$mªu®_wr™e_”r_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2473 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2474 
	`shªnÚ_£q_´štf
(
s
, "%d\n", 
sdev
->
mªu®_wr™e_”r
);

2476 
	}
}

2478 
	$debugfs_mªu®_wr™e_”r_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2480  
	`shªnÚ_sšgË_İ’
(
fe
, 
mªu®_wr™e_”r_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2481 
	}
}

2483 
shªnÚ_fe_İ”©iÚs_t
 
	gmªu®_wr™e_”r_fİs
;

2487 
shªnÚ_size_t
 
	$debugfs_twš_»ad_”r_wr™e
(
shªnÚ_fe_t
 *
fe
,

2488 cÚ¡ 
__u£r
 *
bufãr
, 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2490 
v®ue
;

2491 
lše
[16], *
’d±r
;

2492 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2494 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2495  -
EFAULT
;

2497 
v®ue
 = 
	`sim¶e_¡¹oul
(
lše
, &
’d±r
, 0x10);

2498 
sdev
->
twš_»ad_”r
 = !!
v®ue
;

2500  
couÁ
;

2501 
	}
}

2503 
	$twš_»ad_”r_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2505 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2506 
	`shªnÚ_£q_´štf
(
s
, "%d\n", 
sdev
->
twš_»ad_”r
);

2508 
	}
}

2510 
	$debugfs_twš_»ad_”r_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2512  
	`shªnÚ_sšgË_İ’
(
fe
, 
twš_»ad_”r_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2513 
	}
}

2515 
shªnÚ_fe_İ”©iÚs_t
 
	gtwš_»ad_”r_fİs
;

2518 #ifdeà
CONFIG_SHANNON_PLVERIFY


2519 
shªnÚ_size_t
 
	$debugfs_¶ù¾_wr™e
(
shªnÚ_fe_t
 *
fe
,

2520 cÚ¡ 
__u£r
 *
bufãr
, 
shªnÚ_size_t
 
couÁ
, 
shªnÚ_loff_t
 *
pos
)

2522 
v®ue
;

2523 
lše
[16], *
’d±r
;

2524 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
));

2526 ià(
	`shªnÚ_cİy_äom_u£r
(
lše
, 
bufãr
, 
couÁ
))

2527  -
EFAULT
;

2529 
v®ue
 = 
	`sim¶e_¡¹oul
(
lše
, &
’d±r
, 0x10);

2531 ià('m' =ğ*
’d±r
 || 'M' == *endptr)

2532 
sdev
->
¶ù¾
 |ğ
v®ue
;

2534 
sdev
->
¶ù¾
 = 
v®ue
;

2536  
couÁ
;

2537 
	}
}

2539 
	$¶ù¾_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2541 
i
;

2542 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2544 
	`shªnÚ_£q_´štf
(
s
, "b™ 0: fÜû-h—d [%s]\n", (
sdev
->
¶ù¾
 & 0x01) ? "ENABLE" : "DISABLE");

2545 
	`shªnÚ_£q_´štf
(
s
, "b™ 1:…rohib™-”a£ [%s]\n", (
sdev
->
¶ù¾
 & 0x02) ? "ENABLE" : "DISABLE");

2547 
	`shªnÚ_£q_´štf
(
s
, "booting_wait_erased:");

2548 
i
 = 0; i < 
	`ARRAY_SIZE
(
sdev
->
boÙšg_wa™_”a£d
); i++) {

2549 ià(0xFFFFFFFF =ğ
sdev
->
boÙšg_wa™_”a£d
[
i
]) {

2550 
	`shªnÚ_£q_´štf
(
s
, " END\n");

2553 
	`shªnÚ_£q_´štf
(
s
, " %d", 
sdev
->
boÙšg_wa™_”a£d
[
i
]);

2557 
	}
}

2559 
	$debugfs_¶ù¾_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2561  
	`shªnÚ_sšgË_İ’
(
fe
, 
¶ù¾_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2562 
	}
}

2564 
shªnÚ_fe_İ”©iÚs_t
 
	g¶ù¾_fİs
;

2568 
	$badlun_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2570 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
v
;

2571 
i
;

2573 
	`shªnÚ_£q_´štf
(
s
, "bad_lun[%04d]:", 
sb
->
sb_šdex
);

2574 
i
 = 0; i < 
	`ARRAY_SIZE
(
sb
->
bad_lun
); i++)

2575 
	`shªnÚ_£q_´štf
(
s
, " %016lX", 
sb
->
bad_lun
[
i
]);

2576 
	`shªnÚ_£q_´štf
(
s
, "\n");

2579 
	}
}

2581 
shªnÚ_£q_İ”©iÚs_t
 
	gbadlun_£q_İs
;

2583 
	$debugfs_badlun_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2585 
»t
;

2586 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(&
badlun_£q_İs
, 
£q_®l_blocks_¡¬t
);

2587 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(&
badlun_£q_İs
, 
£q_®l_blocks_Ãxt
);

2588 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(&
badlun_£q_İs
, 
£q_®l_blocks_¡İ
);

2589 
	`shªnÚ_£t_£q_İs_show_hªdËr
(&
badlun_£q_İs
, 
badlun_£q_show
);

2590 
»t
 = 
	`shªnÚ_£q_İ’
(
fe
, &
badlun_£q_İs
);

2591 ià(0 =ğ
»t
)

2592 
	`shªnÚ_£t_£q_fe_´iv©e
(
	`shªnÚ_fe_´iv©e_d©a
(
fe
), 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2593  
»t
;

2594 
	}
}

2596 
shªnÚ_fe_İ”©iÚs_t
 
	gbadlun_fİs
;

2598 
	$vŞge_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2600 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2601 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

2602 
	`shªnÚ_£q_´štf
(
s
, "cÚŒŞË¸‹m³¿tu»ğ%d degC, maxğ%d degC.\n", 
sdev
->
‹m³¿tu»_št
, sdev->
‹m³¿tu»_št_max
);

2603 
	`shªnÚ_£q_´štf
(
s
, "mÙh”bßrdem³¿tu»ğ%d degC, maxğ%d degC.\n", 
sdev
->
‹m³¿tu»_bßrd
, sdev->
‹m³¿tu»_bßrd_max
);

2604 
	`shªnÚ_£q_´štf
(
s
, "æashem³¿tu»ğ%d degC, maxğ%d degC.\n", 
sdev
->
‹m³¿tu»_æash
, sdev->
‹m³¿tu»_æash_max
);

2605 
	`shªnÚ_£q_´štf
(
s
, "š‹º– vŞgeğ%d mV, maxğ%d mV.\n", 
sdev
->
vŞge_št
, sdev->
vŞge_št_max
);

2606 
	`shªnÚ_£q_´štf
(
s
, "auxŸry vŞgeğ%d mV, maxğ%d mV.\n", 
sdev
->
vŞge_aux
, sdev->
vŞge_aux_max
);

2607 
	`shªnÚ_£q_´štf
(
s
, "ex‹º®em³¿tu»1ğ%d degC.\n", 
sdev
->
‹m³¿tu»_aux1
);

2608 
	`shªnÚ_£q_´štf
(
s
, "ex‹º®em³¿tu»2ğ%d degC.\n", 
sdev
->
‹m³¿tu»_aux2
);

2610 
	}
}

2612 
	$debugfs_vŞge_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2614  
	`shªnÚ_sšgË_İ’
(
fe
, 
vŞge_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2615 
	}
}

2617 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_vŞge_fİs
;

2619 *
	$nÜ_block_¡©e
(
¡©e
)

2621 
¡©e
) {

2622 
NOR_BLOCK_FULL
:

2624 
NOR_BLOCK_FREE
:

2626 
NOR_BLOCK_USED
:

2628 
NOR_BLOCK_ACTIVE
:

2630 
NOR_BLOCK_WAIT_ERASE
:

2632 
NOR_BLOCK_ERASE_ERR
:

2634 
NOR_BLOCK_WRITE_ERR
:

2641 
	}
}

2643 
	$bbt_¡©e_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2645 
i
;

2646 
blk_num
, 
·ge_num
;

2647 
nÜ_block
 *
nblock
;

2648 
nÜ_·ge
 *
Åage
;

2649 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2651 
blk_num
 = 
sdev
->
nÜæash
.
bbt_size
 / (sdev->nÜæash.
size_šby‹s
/sdev->nÜæash.
blk_couÁ
);

2652 
·ge_num
 = 
sdev
->
nÜæash
.
bbt_size
 / 
NOR_PAGE_SIZE
;

2654 
	`shªnÚ_£q_´štf
(
s
, "nor_block, valid_pages, state\n");

2655 
i
 = 0; i < 
blk_num
; i++) {

2656 
nblock
 = &
sdev
->
nÜ_blocks
[
i
];

2657 
	`shªnÚ_£q_´štf
(
s
, "%3d, %3d, %s\n", 
nblock
->
šdex
, \

2658 
nblock
->
v®id_·ges
, 
	`nÜ_block_¡©e
Òblock->
¡©e
));

2661 
	`shªnÚ_£q_´štf
(
s
, "\n");

2662 
	`shªnÚ_£q_´štf
(
s
, "nor_page, index,‚or_block, seq_num\n");

2663 
i
 = 0; i < 
·ge_num
; i++) {

2664 
Åage
 = 
sdev
->
nÜ_·ge_¬¿y
[
i
];

2665 ià(
Åage
->
šdex
 !ğ
INVALID_NOR_PAGE_INDEX
)

2666 
	`shªnÚ_£q_´štf
(
s
, "%3d, %3d, %3d, %u\n", 
i
, \

2667 
Åage
->
šdex
,‚·ge->
nÜ_block
,‚·ge->
d©a
->
£q_num
);

2670 
	`shªnÚ_£q_´štf
(
s
, "\n");

2671 
	`shªnÚ_£q_´štf
(
s
, "curr_page=%d,‚ext_slot=%d,…os_block=%d,…os_page=%d, state=%u.\n", \

2672 
sdev
->
cu¼_·ge
, sdev->
Ãxt_¦Ù
, sdev->
pos_block
, sdev->
pos_·ge
, sdev->
nÜ_bbt_¡©e
);

2675 
	}
}

2677 
	$debugfs_bbt_¡©e_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2679  
	`shªnÚ_sšgË_İ’
(
fe
, 
bbt_¡©e_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2680 
	}
}

2682 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_bbt_¡©e_fİs
;

2685 
	$mbr_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2687 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2688 
ã©u»_cfg
 *
cfg
 = 
sdev
->
ã©u»_cfg_li¡
;

2689 
i
, 
´io
;

2691 
	`shªnÚ_£q_´štf
(
s
, "id=%s\n", 
sdev
->
mbr
.
id
);

2692 
	`shªnÚ_£q_´štf
(
s
, "mbr_v”siÚ=0x%04X\n", ()
sdev
->
mbr
.
mbr_fÜm©_v”siÚ
);

2693 
	`shªnÚ_£q_´štf
(
s
, "h¬dw¬e_v”siÚ=0x%08X\n", ()
sdev
->
mbr
.
h¬dw¬e_v”siÚ
);

2694 
	`shªnÚ_£q_´štf
(
s
, "soáw¬e_v”siÚ=%d\n", ()
sdev
->
mbr
.
soáw¬e_v”siÚ
);

2695 
	`shªnÚ_£q_´štf
(
s
, "Çnd_mªuçùu»=0x%04X\n", ()
sdev
->
mbr
.
Çnd_mªuçùu»
);

2696 
	`shªnÚ_£q_´štf
(
s
, "Çnd_id=0x%04X\n", ()
sdev
->
mbr
.
Çnd_id
);

2697 
	`shªnÚ_£q_´štf
(
s
, "ÿ·c™y=%Îu\n", 
sdev
->
mbr
.
ÿ·c™y
);

2699 
	`shªnÚ_£q_´štf
(
s
, "lun_amouÁ=%d\n", 
sdev
->
mbr
.
lun_amouÁ
);

2700 
	`shªnÚ_£q_´štf
(
s
, "eblocks_š_lun=%d\n", 
sdev
->
mbr
.
eblocks_š_lun
);

2701 
	`shªnÚ_£q_´štf
(
s
, "·ges_š_eblock=%d\n", 
sdev
->
mbr
.
·ges_š_eblock
);

2702 
	`shªnÚ_£q_´štf
(
s
, "Çnd_·ge_shiá=%d\n", 
sdev
->
mbr
.
Çnd_·ge_shiá
);

2703 
	`shªnÚ_£q_´štf
(
s
, "oob_size=%d\n", 
sdev
->
mbr
.
oob_size
);

2704 
	`shªnÚ_£q_´štf
(
s
, "logicb_shiá=%d\n", 
sdev
->
mbr
.
logicb_shiá
);

2705 
	`shªnÚ_£q_´štf
(
s
, "u£r_logicb_shiá=%d\n", 
sdev
->
mbr
.
u£r_logicb_shiá
);

2706 
	`shªnÚ_£q_´štf
(
s
, "¶ªe_Üd”=%d\n", 
sdev
->
mbr
.
¶ªe_Üd”
);

2707 
	`shªnÚ_£q_´štf
(
s
, "¶ªe_couÁ=%d\n", 
sdev
->
mbr
.
¶ªe_couÁ
);

2708 
	`shªnÚ_£q_´štf
(
s
, "p£udo_¶ªe=%d\n", 
sdev
->
mbr
.
p£udo_¶ªe
);

2709 
	`shªnÚ_£q_´štf
(
s
, "cÚfig_chªÃls=%d\n", 
sdev
->
mbr
.
cfg_chªÃls
);

2710 
	`shªnÚ_£q_´štf
(
s
, "cÚfig_lun£t_š_chªÃl=%d\n", 
sdev
->
mbr
.
cfg_lun£t_š_chªÃl
);

2711 
	`shªnÚ_£q_´štf
(
s
, "cÚfig_lun_š_lun£t=%d\n", 
sdev
->
mbr
.
cfg_lun_š_lun£t
);

2713 
	`shªnÚ_£q_´štf
(
s
, "š™_hÙ_sblk=%d\n", 
sdev
->
mbr
.
š™_hÙ_sblk
);

2714 
	`shªnÚ_£q_´štf
(
s
, "š™_cŞd_sblk=%d\n", 
sdev
->
mbr
.
š™_cŞd_sblk
);

2716 
	`shªnÚ_£q_´štf
(
s
, "š‹¼u±_d–ay=%d\n", 
sdev
->
mbr
.
š‹¼u±_d–ay
);

2717 
	`shªnÚ_£q_´štf
(
s
, "ov”´ovisiÚ_¿‹=%d.%d\n", 
sdev
->
ov”´ovisiÚ_¿‹
 / 100, sdev->overprovision_rate % 100);

2718 
	`shªnÚ_£q_´štf
(
s
, "ecc_codewÜds_š_logicb=%d\n", 
sdev
->
mbr
.
ecc_codewÜds_š_logicb
);

2719 
	`shªnÚ_£q_´štf
(
s
, "ecc_cÜ»ùiÚ_pow”=%d\n", 
sdev
->
mbr
.
ecc_cÜ»ùiÚ_pow”
);

2721 
	`shªnÚ_£q_´štf
(
s
, "hi¡Üy_”a£_couÁ=%d\n", 
sdev
->
mbr
.
hi¡Üy_”a£_couÁ
);

2722 
	`shªnÚ_£q_´štf
(
s
, "pow”_cyşe_couÁ=%Îd\n", 
sdev
->
mbr
.
pow”_cyşe_couÁ
);

2723 
	`shªnÚ_£q_´štf
(
s
, "pow”_Ú_£cÚds=%Îd\n", 
sdev
->
mbr
.
pow”_Ú_£cÚds
);

2724 
	`shªnÚ_£q_´štf
(
s
, "ho¡_wr™e_£ùÜs=%Îd\n", 
sdev
->
mbr
.
ho¡_wr™e_£ùÜs
);

2725 
	`shªnÚ_£q_´štf
(
s
, "tÙ®_wr™e_£ùÜs=%Îd\n", 
sdev
->
mbr
.
tÙ®_wr™e_£ùÜs
);

2726 
	`shªnÚ_£q_´štf
(
s
, "ho¡_»ad_£ùÜs=%Îd\n", 
sdev
->
mbr
.
ho¡_»ad_£ùÜs
);

2727 
	`shªnÚ_£q_´štf
(
s
, "æash_drvmode=%d\n", 
sdev
->
mbr
.
æash_drvmode
);

2728 
	`shªnÚ_£q_´štf
(
s
, "luns_³r_û_mask=0x%02X\n", 
sdev
->
mbr
.
luns_³r_û_mask
);

2729 
	`shªnÚ_£q_´štf
(
s
, "lun_m­_mode=%d\n", 
sdev
->
mbr
.
lun_m­_mode
);

2730 
	`shªnÚ_£q_´štf
(
s
, "¿id_¡res=%d\n", 
sdev
->
mbr
.
¿id_¡res
);

2731 
	`shªnÚ_£q_´štf
(
s
, "ã©u»_æags=0x%Îx\n", 
sdev
->
mbr
.
ã©u»_æags
);

2732 
	`shªnÚ_£q_´štf
(
s
, "pow”_budg‘=%d\n", 
sdev
->
mbr
.
pow”_budg‘
);

2733 
	`shªnÚ_£q_´štf
(
s
, "dma_max_»ad_lim™=%d\n", 
sdev
->
mbr
.
dma_max_»ad_lim™
);

2734 
	`shªnÚ_£q_´štf
(
s
, "şk=%d\n", 
sdev
->
mbr
.
şk
);

2735 
	`shªnÚ_£q_´štf
(
s
, "max_out¡ªdšg_bios=%d\n", 
sdev
->
mbr
.
max_out¡ªdšg_bios
);

2736 
	`shªnÚ_£q_´štf
(
s
, "mbr_upd©e=%d.\n", 
sdev
->
mbr
.
mbr_upd©e
);

2737 
	`shªnÚ_£q_´štf
(
s
, "‹mp_th»shŞd1=%d.\n", 
sdev
->
mbr
.
‹mp_th»shŞd1
);

2738 
	`shªnÚ_£q_´štf
(
s
, "‹mp_ü™iÿl_th»shŞd1=%d.\n", 
sdev
->
mbr
.
‹mp_ü™iÿl_th»shŞd1
);

2739 
	`shªnÚ_£q_´štf
(
s
, "‹mp_th»shŞd2=%d.\n", 
sdev
->
mbr
.
‹mp_th»shŞd2
);

2740 
	`shªnÚ_£q_´štf
(
s
, "‹mp_ü™iÿl_th»shŞd2=%d.\n", 
sdev
->
mbr
.
‹mp_ü™iÿl_th»shŞd2
);

2741 
	`shªnÚ_£q_´štf
(
s
, "poŞ_w©”m¬k=%d.\n", 
sdev
->
mbr
.
poŞ_w©”m¬k
);

2742 
	`shªnÚ_£q_´štf
(
s
, "sdev_id=%d.\n", 
sdev
->
mbr
.
sdev_id
);

2743 
	`shªnÚ_£q_´štf
(
s
, "sdev_couÁ=%d.\n", 
sdev
->
mbr
.
sdev_couÁ
);

2744 
	`shªnÚ_£q_´štf
(
s
, "sh¬ed_·ges=%d.\n", 
sdev
->
mbr
.
sh¬ed_·ges
);

2745 
	`shªnÚ_£q_´štf
(
s
, "p£udo_¶ªe=%d.\n", 
sdev
->
mbr
.
p£udo_¶ªe
);

2746 
	`shªnÚ_£q_´štf
(
s
, "¶ªe_couÁ=%d.\n", 
sdev
->
mbr
.
¶ªe_couÁ
);

2747 
	`shªnÚ_£q_´štf
(
s
, "³riod_»ad_³riod=%d.\n", 
sdev
->
mbr
.
³riod_»ad_³riod
);

2748 
	`shªnÚ_£q_´štf
(
s
, "³riod_»ad_µa=%d.\n", 
sdev
->
mbr
.
³riod_»ad_µa
);

2749 
	`shªnÚ_£q_´štf
(
s
, "dummy_wÜdlše=%d.\n", 
sdev
->
mbr
.
dummy_wÜdlše
);

2750 
	`shªnÚ_£q_´štf
(
s
, "max_k“p_”a£d_hours=%d.\n", 
sdev
->
mbr
.
max_k“p_”a£d_hours
);

2751 
	`shªnÚ_£q_´štf
(
s
, "»ad_»Œy=%d.\n", 
sdev
->
mbr
.
»ad_»Œy
);

2752 
	`shªnÚ_£q_´štf
(
s
, "ecc_çu»_¿‹_th»shŞd=%d.\n", 
sdev
->
mbr
.
ecc_çu»_¿‹_th»shŞd
);

2753 
	`shªnÚ_£q_´štf
(
s
, "max_wr™e_bw=%u.\n", 
sdev
->
mbr
.
max_wr™e_bw
);

2754 
	`shªnÚ_£q_´štf
(
s
, "d©a_»‹ÁiÚ_š‹rv®=%u.\n", 
sdev
->
mbr
.
d©a_»‹ÁiÚ_š‹rv®
);

2755 
	`shªnÚ_£q_´štf
(
s
, "µa_·ge_width=%u.\n", 
sdev
->
mbr
.
µa_·ge_width
);

2756 
	`shªnÚ_£q_´štf
(
s
, "µa_¶ªe_width=%u.\n", 
sdev
->
mbr
.
µa_¶ªe_width
);

2757 
	`shªnÚ_£q_´štf
(
s
, "ıs_v”siÚ=%u.\n", 
sdev
->
mbr
.
ıs_v”siÚ
);

2758 
	`shªnÚ_£q_´štf
(
s
, "ov”Ïp_sblk=%u.\n", 
sdev
->
mbr
.
ov”Ïp_sblk
);

2759 
	`shªnÚ_£q_´štf
(
s
, "³_cyşe=%u.\n", 
sdev
->
mbr
.
³_cyşe
);

2761 
	`shªnÚ_£q_´štf
(
s
, "bad_phy_lun_map=");

2762 
i
 = 0; i < 
BAD_LUN_MAP_ARRAY_SIZE
 - 1; i++)

2763 
	`shªnÚ_£q_´štf
(
s
, "%016ÎX_", 
sdev
->
mbr
.
bad_phy_lun_m­
[
i
]);

2764 
	`shªnÚ_£q_´štf
(
s
, "%016ÎX\n", 
sdev
->
mbr
.
bad_phy_lun_m­
[
BAD_LUN_MAP_ARRAY_SIZE
 - 1]);

2766 
i
 = 0; i < 
FEATURE_CFG_LIST_SIZE
; i++) {

2767 ià(
cfg
->
v®id
 =ğ
FEATURE_INVALID
)

2769 ià(
cfg
->
v®id
 & 
FEATURE_PRIO_0_MASK
)

2770 
´io
 = 0;

2771 ià(
cfg
->
v®id
 & 
FEATURE_PRIO_1_MASK
)

2772 
´io
 = 1;

2774 
´io
 = -1;

2775 
	`shªnÚ_£q_´štf
(
s
, "feature: [prio=%d,‡ddr=0x%02x, cmd=0x%02x, sec_cmd=0x%02x, "

2777 
´io
, 
cfg
->
addr
, cfg->
cmd
, cfg->
£cÚd¬y_cmd
, cfg->
misc
, cfg->
nby‹
,

2778 
cfg
->
d©a
[
FEATURE_CFG_MAX_DATA
], cfg->data[FEATURE_CFG_MAX_DATA + 1],

2779 *(
__u64
*)
cfg
->
d©a
);

2780 
cfg
++;

2783 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

2785 
	`shªnÚ_£q_´štf
(
s
, "*hw_max_chªÃls=%d\n", (
	`»ad_»g_§ã
(
sdev
, sdev->
b¬
) >> 16) & 0xFF);

2786 
	`shªnÚ_£q_´štf
(
s
, "*hw_max_lun£ts_š_chªÃl=%d\n", (
	`»ad_»g_§ã
(
sdev
, sdev->
b¬
) >> 24) & 0x0F);

2787 
	`shªnÚ_£q_´štf
(
s
, "*hw_max_luns_š_lun£t=%d\n", ((
	`»ad_»g_§ã
(
sdev
, sdev->
b¬
) >> 28) & 0x0F) + 1);

2789 
	`shªnÚ_£q_´štf
(
s
, "*logicbs_š_·ge=%d\n", 
sdev
->
logicbs_š_·ge
);

2790 
	`shªnÚ_£q_´štf
(
s
, "*•og_size=%d\n", 
sdev
->
max_•og_size
);

2792 ià(
sdev
->
nÜ_mbr_¡©us
 & 
READ_FROM_NORFLASH
) {

2793 
	`shªnÚ_£q_´štf
(
s
, "NM-w©”m¬k=%016lX\n", 
NOR_MBR_MAGIC
);

2796 
	}
}

2798 
	$debugfs_mbr_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2800  
	`shªnÚ_sšgË_İ’
(
fe
, 
mbr_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2801 
	}
}

2803 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_mbr_fİs
;

2806 
	$l2p_lunm­_£q_show
(
shªnÚ_£q_fe_t
 *
s
, *
v
)

2808 
i
;

2809 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_£q_fe_´iv©e
(
s
);

2811 
	`shªnÚ_£q_´štf
(
s
, "lun_m­_mode=%d\n\n", 
sdev
->
mbr
.
lun_m­_mode
);

2812 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++)

2813 
	`shªnÚ_£q_´štf
(
s
, "logiÿl_lun=%d,…hysiÿl_lun=%d.\n", 
i
, 
sdev
->
lun
[i]->
phy_lun_num
);

2816 
	}
}

2818 
	$debugfs_l2p_lunm­_İ’
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

2820  
	`shªnÚ_sšgË_İ’
(
fe
, 
l2p_lunm­_£q_show
, 
	`shªnÚ_šode_i_´iv©e
(
šode
));

2821 
	}
}

2823 
shªnÚ_fe_İ”©iÚs_t
 
	gshow_l2p_lunm­_fİs
;

2825 
	$shªnÚ_debugfs_š™
(
shªnÚ_dev
 *
dev
)

2827 
i
;

2828 
Çmebuf
[30];

2830 
dev
->
shªnÚ_debug_roÙ
 = 
	`shªnÚ_debugfs_ü—‹_dœ
(
	`shªnÚ_disk_Çme
(dev), 
NULL
);

2831 ià(!
dev
->
shªnÚ_debug_roÙ
)

2832  -
ENOENT
;

2834 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_®l_blocks_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2835 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_®l_blocks_fİs
, 
debugfs_®l_blocks_İ’
);

2836 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_®l_blocks_fİs
, 
shªnÚ_£q_»ad
);

2837 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_®l_blocks_fİs
, 
shªnÚ_£q_l£ek
);

2838 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_®l_blocks_fİs
, 
shªnÚ_£q_»Ëa£
);

2839 
dev
->
debugfs_®l_blocks
 = 
	`shªnÚ_debugfs_ü—‹_fe
("all_blocks", 0444,

2840 
dev
->
shªnÚ_debug_roÙ
, dev,

2841 &
show_®l_blocks_fİs
);

2842 ià(!
dev
->
debugfs_®l_blocks
)

2843  -
ENOENT
;

2845 #ifdeà
CONFIG_SHANNON_DEBUG_DUMP


2846 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_dump_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2847 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_dump_fİs
, 
debugfs_dump_İ’
);

2848 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_dump_fİs
, 
shªnÚ_£q_»ad
);

2849 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_dump_fİs
, 
shªnÚ_£q_l£ek
);

2850 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_dump_fİs
, 
shªnÚ_£q_»Ëa£
);

2851 
dev
->
debugfs_dump
 = 
	`shªnÚ_debugfs_ü—‹_fe
("dump", 0444,

2852 
dev
->
shªnÚ_debug_roÙ
, dev,

2853 &
show_dump_fİs
);

2854 ià(!
dev
->
debugfs_dump
)

2855  -
ENOENT
;

2858 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_hÙ_blocks_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2859 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_hÙ_blocks_fİs
, 
debugfs_hÙ_blocks_İ’
);

2860 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_hÙ_blocks_fİs
, 
shªnÚ_£q_»ad
);

2861 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_hÙ_blocks_fİs
, 
shªnÚ_£q_l£ek
);

2862 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_hÙ_blocks_fİs
, 
shªnÚ_£q_»Ëa£
);

2863 
dev
->
debugfs_hÙ_blocks
 = 
	`shªnÚ_debugfs_ü—‹_fe
("hot_blocks", 0444,

2864 
dev
->
shªnÚ_debug_roÙ
, dev,

2865 &
show_hÙ_blocks_fİs
);

2866 ià(!
dev
->
debugfs_hÙ_blocks
)

2867  -
ENOENT
;

2869 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_cŞd_blocks_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2870 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_cŞd_blocks_fİs
, 
debugfs_cŞd_blocks_İ’
);

2871 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_cŞd_blocks_fİs
, 
shªnÚ_£q_»ad
);

2872 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_cŞd_blocks_fİs
, 
shªnÚ_£q_l£ek
);

2873 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_cŞd_blocks_fİs
, 
shªnÚ_£q_»Ëa£
);

2874 
dev
->
debugfs_cŞd_blocks
 = 
	`shªnÚ_debugfs_ü—‹_fe
("cold_blocks", 0444,

2875 
dev
->
shªnÚ_debug_roÙ
, dev,

2876 &
show_cŞd_blocks_fİs
);

2877 ià(!
dev
->
debugfs_cŞd_blocks
)

2878  -
ENOENT
;

2880 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_wa™_”a£d_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2881 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_wa™_”a£d_fİs
, 
debugfs_wa™_”a£d_İ’
);

2882 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_wa™_”a£d_fİs
, 
shªnÚ_£q_»ad
);

2883 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_wa™_”a£d_fİs
, 
shªnÚ_£q_l£ek
);

2884 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_wa™_”a£d_fİs
, 
shªnÚ_£q_»Ëa£
);

2885 
dev
->
debugfs_wa™_”a£d
 = 
	`shªnÚ_debugfs_ü—‹_fe
("wait_erased", 0444,

2886 
dev
->
shªnÚ_debug_roÙ
, dev,

2887 &
show_wa™_”a£d_fİs
);

2888 ià(!
dev
->
debugfs_wa™_”a£d
)

2889  -
ENOENT
;

2891 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_wa™_cİy_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2892 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_wa™_cİy_fİs
, 
debugfs_wa™_cİy_İ’
);

2893 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_wa™_cİy_fİs
, 
shªnÚ_£q_»ad
);

2894 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_wa™_cİy_fİs
, 
shªnÚ_£q_l£ek
);

2895 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_wa™_cİy_fİs
, 
shªnÚ_£q_»Ëa£
);

2896 
dev
->
debugfs_wa™_cİy
 = 
	`shªnÚ_debugfs_ü—‹_fe
("wait_copy", 0444,

2897 
dev
->
shªnÚ_debug_roÙ
, dev,

2898 &
show_wa™_cİy_fİs
);

2899 ià(!
dev
->
debugfs_wa™_cİy
)

2900  -
ENOENT
;

2902 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_ä“_blocks_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2903 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_ä“_blocks_fİs
, 
debugfs_ä“_blocks_İ’
);

2904 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_ä“_blocks_fİs
, 
shªnÚ_£q_»ad
);

2905 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_ä“_blocks_fİs
, 
shªnÚ_£q_l£ek
);

2906 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_ä“_blocks_fİs
, 
shªnÚ_£q_»Ëa£
);

2907 
dev
->
debugfs_ä“_blocks
 = 
	`shªnÚ_debugfs_ü—‹_fe
("free_blocks", 0444,

2908 
dev
->
shªnÚ_debug_roÙ
, dev,

2909 &
show_ä“_blocks_fİs
);

2910 ià(!
dev
->
debugfs_ä“_blocks
)

2911  -
ENOENT
;

2913 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_”r_blks_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2914 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_”r_blks_fİs
, 
debugfs_”r_blks_İ’
);

2915 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_”r_blks_fİs
, 
shªnÚ_£q_»ad
);

2916 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_”r_blks_fİs
, 
shªnÚ_£q_l£ek
);

2917 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_”r_blks_fİs
, 
shªnÚ_£q_»Ëa£
);

2918 
dev
->
debugfs_”r_blks
 = 
	`shªnÚ_debugfs_ü—‹_fe
("err_blks", 0444,

2919 
dev
->
shªnÚ_debug_roÙ
, dev,

2920 &
show_”r_blks_fİs
);

2921 ià(!
dev
->
debugfs_”r_blks
)

2922  -
ENOENT
;

2924 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


2925 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_out¡ªdšg_»qs_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2926 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_out¡ªdšg_»qs_fİs
, 
debugfs_out¡ªdšg_»qs_İ’
);

2927 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_out¡ªdšg_»qs_fİs
, 
shªnÚ_£q_»ad
);

2928 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_out¡ªdšg_»qs_fİs
, 
shªnÚ_£q_l£ek
);

2929 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_out¡ªdšg_»qs_fİs
, 
shªnÚ_£q_»Ëa£
);

2930 
dev
->
debugfs_out¡ªdšg_»qs
 = 
	`shªnÚ_debugfs_ü—‹_fe
("outstanding_reqs", 0444,

2931 
dev
->
shªnÚ_debug_roÙ
, dev,

2932 &
show_out¡ªdšg_»qs_fİs
);

2933 ià(!
dev
->
debugfs_out¡ªdšg_»qs
)

2934  -
ENOENT
;

2936 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_out¡ªdšg_sbios_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2937 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_out¡ªdšg_sbios_fİs
, 
debugfs_out¡ªdšg_sbios_İ’
);

2938 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_out¡ªdšg_sbios_fİs
, 
shªnÚ_£q_»ad
);

2939 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_out¡ªdšg_sbios_fİs
, 
shªnÚ_£q_l£ek
);

2940 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_out¡ªdšg_sbios_fİs
, 
shªnÚ_£q_»Ëa£
);

2941 
dev
->
debugfs_out¡ªdšg_sbios
 = 
	`shªnÚ_debugfs_ü—‹_fe
("outstanding_sbios", 0444,

2942 
dev
->
shªnÚ_debug_roÙ
, dev,

2943 &
show_out¡ªdšg_sbios_fİs
);

2944 ià(!
dev
->
debugfs_out¡ªdšg_sbios
)

2945  -
ENOENT
;

2948 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_»q_queue0_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2949 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_»q_queue0_fİs
, 
debugfs_»q_queue0_İ’
);

2950 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_»q_queue0_fİs
, 
shªnÚ_£q_»ad
);

2951 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_»q_queue0_fİs
, 
shªnÚ_£q_l£ek
);

2952 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_»q_queue0_fİs
, 
shªnÚ_£q_»Ëa£
);

2953 
dev
->
debugfs_»q_queue0
 = 
	`shªnÚ_debugfs_ü—‹_fe
("request_queue0", 0444,

2954 
dev
->
shªnÚ_debug_roÙ
, dev,

2955 &
show_»q_queue0_fİs
);

2956 ià(!
dev
->
debugfs_»q_queue0
)

2957  -
ENOENT
;

2959 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_»q_queue1_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2960 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_»q_queue1_fİs
, 
debugfs_»q_queue1_İ’
);

2961 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_»q_queue1_fİs
, 
shªnÚ_£q_»ad
);

2962 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_»q_queue1_fİs
, 
shªnÚ_£q_l£ek
);

2963 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_»q_queue1_fİs
, 
shªnÚ_£q_»Ëa£
);

2964 
dev
->
debugfs_»q_queue1
 = 
	`shªnÚ_debugfs_ü—‹_fe
("request_queue1", 0444,

2965 
dev
->
shªnÚ_debug_roÙ
, dev,

2966 &
show_»q_queue1_fİs
);

2967 ià(!
dev
->
debugfs_»q_queue1
)

2968  -
ENOENT
;

2970 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_cmd_queue_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2971 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_cmd_queue_fİs
, 
debugfs_cmd_queue_İ’
);

2972 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_cmd_queue_fİs
, 
shªnÚ_£q_»ad
);

2973 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_cmd_queue_fİs
, 
shªnÚ_£q_l£ek
);

2974 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_cmd_queue_fİs
, 
shªnÚ_sšgË_»Ëa£
);

2975 
dev
->
debugfs_cmd_queue
 = 
	`shªnÚ_debugfs_ü—‹_fe
("command_queue", 0444,

2976 
dev
->
shªnÚ_debug_roÙ
, dev,

2977 &
show_cmd_queue_fİs
);

2978 ià(!
dev
->
debugfs_cmd_queue
)

2979  -
ENOENT
;

2981 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_gc_¡©e_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2982 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_gc_¡©e_fİs
, 
debugfs_gc_¡©e_İ’
);

2983 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_gc_¡©e_fİs
, 
shªnÚ_£q_»ad
);

2984 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_gc_¡©e_fİs
, 
shªnÚ_£q_l£ek
);

2985 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_gc_¡©e_fİs
, 
shªnÚ_sšgË_»Ëa£
);

2986 
dev
->
debugfs_gc_¡©e
 = 
	`shªnÚ_debugfs_ü—‹_fe
("gc_state", 0444,

2987 
dev
->
shªnÚ_debug_roÙ
, dev,

2988 &
show_gc_¡©e_fİs
);

2989 ià(!
dev
->
debugfs_gc_¡©e
)

2990  -
ENOENT
;

2992 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

2993 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_»gi¡”s_fİs
, 
	`shªnÚ_g‘_this_moduË
());

2994 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_»gi¡”s_fİs
, 
debugfs_»gi¡”s_İ’
);

2995 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_»gi¡”s_fİs
, 
shªnÚ_£q_»ad
);

2996 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_»gi¡”s_fİs
, 
shªnÚ_£q_l£ek
);

2997 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_»gi¡”s_fİs
, 
shªnÚ_sšgË_»Ëa£
);

2998 
dev
->
debugfs_»gi¡”s
 = 
	`shªnÚ_debugfs_ü—‹_fe
("registers", 0444,

2999 
dev
->
shªnÚ_debug_roÙ
, dev,

3000 &
show_»gi¡”s_fİs
);

3001 ià(!
dev
->
debugfs_»gi¡”s
)

3002  -
ENOENT
;

3004 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_queue_d•th_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3005 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_queue_d•th_fİs
, 
debugfs_queue_d•th_İ’
);

3006 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_queue_d•th_fİs
, 
shªnÚ_£q_»ad
);

3007 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_queue_d•th_fİs
, 
shªnÚ_£q_l£ek
);

3008 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_queue_d•th_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3009 
dev
->
debugfs_queue_d•th
 = 
	`shªnÚ_debugfs_ü—‹_fe
("queue_depth", 0444,

3010 
dev
->
shªnÚ_debug_roÙ
, dev,

3011 &
show_queue_d•th_fİs
);

3012 ià(!
dev
->
debugfs_queue_d•th
)

3013  -
ENOENT
;

3015 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


3016 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_sq_d•th_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3017 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_sq_d•th_fİs
, 
debugfs_sq_d•th_İ’
);

3018 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_sq_d•th_fİs
, 
shªnÚ_£q_»ad
);

3019 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_sq_d•th_fİs
, 
shªnÚ_£q_l£ek
);

3020 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_sq_d•th_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3021 
dev
->
debugfs_sq_d•th
 = 
	`shªnÚ_debugfs_ü—‹_fe
("sq_depth", 0444,

3022 
dev
->
shªnÚ_debug_roÙ
, dev,

3023 &
show_sq_d•th_fİs
);

3024 ià(!
dev
->
debugfs_sq_d•th
)

3025  -
ENOENT
;

3027 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_lun_¡©i¡ics_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3028 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_lun_¡©i¡ics_fİs
, 
debugfs_lun_¡©i¡ics_İ’
);

3029 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_lun_¡©i¡ics_fİs
, 
shªnÚ_£q_»ad
);

3030 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_lun_¡©i¡ics_fİs
, 
shªnÚ_£q_l£ek
);

3031 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_lun_¡©i¡ics_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3032 
dev
->
debugfs_lun_¡©i¡ics
 = 
	`shªnÚ_debugfs_ü—‹_fe
("lun_statistics", 0444,

3033 
dev
->
shªnÚ_debug_roÙ
, dev,

3034 &
show_lun_¡©i¡ics_fİs
);

3035 ià(!
dev
->
debugfs_lun_¡©i¡ics
)

3036  -
ENOENT
;

3038 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_¡©i¡ics_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3039 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_¡©i¡ics_fİs
, 
debugfs_¡©i¡ics_İ’
);

3040 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_¡©i¡ics_fİs
, 
shªnÚ_£q_»ad
);

3041 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_¡©i¡ics_fİs
, 
shªnÚ_£q_l£ek
);

3042 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_¡©i¡ics_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3043 
dev
->
debugfs_¡©i¡ics
 = 
	`shªnÚ_debugfs_ü—‹_fe
("statistics", 0444,

3044 
dev
->
shªnÚ_debug_roÙ
, dev,

3045 &
show_¡©i¡ics_fİs
);

3046 ià(!
dev
->
debugfs_¡©i¡ics
)

3047  -
ENOENT
;

3049 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_bßrd_·¿m‘”s_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3050 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_bßrd_·¿m‘”s_fİs
, 
debugfs_bßrd_·¿m‘”s_İ’
);

3051 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_bßrd_·¿m‘”s_fİs
, 
shªnÚ_£q_»ad
);

3052 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_bßrd_·¿m‘”s_fİs
, 
shªnÚ_£q_l£ek
);

3053 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_bßrd_·¿m‘”s_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3054 
dev
->
debugfs_bßrd_·¿m‘”s
 = 
	`shªnÚ_debugfs_ü—‹_fe
("board_parameters", 0444,

3055 
dev
->
shªnÚ_debug_roÙ
, dev,

3056 &
show_bßrd_·¿m‘”s_fİs
);

3057 ià(!
dev
->
debugfs_bßrd_·¿m‘”s
)

3058  -
ENOENT
;

3060 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_»ad_couÁ_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3061 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_»ad_couÁ_fİs
, 
debugfs_»ad_couÁ_İ’
);

3062 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_»ad_couÁ_fİs
, 
shªnÚ_£q_»ad
);

3063 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_»ad_couÁ_fİs
, 
shªnÚ_£q_l£ek
);

3064 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_»ad_couÁ_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3065 
dev
->
debugfs_»ad_couÁ
 = 
	`shªnÚ_debugfs_ü—‹_fe
("read_count", 0444,

3066 
dev
->
shªnÚ_debug_roÙ
, dev,

3067 &
show_»ad_couÁ_fİs
);

3068 ià(!
dev
->
debugfs_»ad_couÁ
)

3069  -
ENOENT
;

3071 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_ecc_çu»_times_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3072 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_ecc_çu»_times_fİs
, 
debugfs_ecc_çu»_times_İ’
);

3073 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_ecc_çu»_times_fİs
, 
shªnÚ_£q_»ad
);

3074 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_ecc_çu»_times_fİs
, 
shªnÚ_£q_l£ek
);

3075 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_ecc_çu»_times_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3076 
dev
->
debugfs_ecc_çu»_times
 = 
	`shªnÚ_debugfs_ü—‹_fe
("ecc_failure_times", 0444,

3077 
dev
->
shªnÚ_debug_roÙ
, dev,

3078 &
show_ecc_çu»_times_fİs
);

3079 ià(!
dev
->
debugfs_ecc_çu»_times
)

3080  -
ENOENT
;

3082 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_bad_blocks_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3083 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_bad_blocks_fİs
, 
debugfs_bad_blocks_İ’
);

3084 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_bad_blocks_fİs
, 
shªnÚ_£q_»ad
);

3085 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_bad_blocks_fİs
, 
shªnÚ_£q_l£ek
);

3086 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_bad_blocks_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3087 
dev
->
debugfs_bad_blocks
 = 
	`shªnÚ_debugfs_ü—‹_fe
("bad_blocks", 0444,

3088 
dev
->
shªnÚ_debug_roÙ
, dev,

3089 &
show_bad_blocks_fİs
);

3090 ià(!
dev
->
debugfs_bad_blocks
)

3091  -
ENOENT
;

3093 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_rmw_li¡_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3094 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_rmw_li¡_fİs
, 
debugfs_rmw_li¡_İ’
);

3095 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_rmw_li¡_fİs
, 
shªnÚ_£q_»ad
);

3096 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_rmw_li¡_fİs
, 
shªnÚ_£q_l£ek
);

3097 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_rmw_li¡_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3098 
dev
->
sdisk
.
debugfs_rmw_li¡
 = 
	`shªnÚ_debugfs_ü—‹_fe
("rmw_list", 0444,

3099 
dev
->
shªnÚ_debug_roÙ
, dev,

3100 &
show_rmw_li¡_fİs
);

3101 ià(!
dev
->
sdisk
.
debugfs_rmw_li¡
)

3102  -
ENOENT
;

3104 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_wa™queue_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3105 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_wa™queue_fİs
, 
debugfs_wa™queue_İ’
);

3106 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_wa™queue_fİs
, 
shªnÚ_£q_»ad
);

3107 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_wa™queue_fİs
, 
shªnÚ_£q_l£ek
);

3108 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_wa™queue_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3109 
dev
->
debugfs_wa™queue
 = 
	`shªnÚ_debugfs_ü—‹_fe
("waitqueue", 0444,

3110 
dev
->
shªnÚ_debug_roÙ
, dev,

3111 &
show_wa™queue_fİs
);

3112 ià(!
dev
->
debugfs_wa™queue
)

3113  -
ENOENT
;

3115 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_lock_¡©_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3116 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_lock_¡©_fİs
, 
debugfs_lock_¡©_İ’
);

3117 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_lock_¡©_fİs
, 
shªnÚ_£q_»ad
);

3118 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_lock_¡©_fİs
, 
shªnÚ_£q_l£ek
);

3119 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_lock_¡©_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3120 
dev
->
debugfs_lock_¡©
 = 
	`shªnÚ_debugfs_ü—‹_fe
("lock_stat", 0444,

3121 
dev
->
shªnÚ_debug_roÙ
, dev,

3122 &
show_lock_¡©_fİs
);

3123 ià(!
dev
->
debugfs_lock_¡©
)

3124  -
ENOENT
;

3126 #ifdeà
CONFIG_SHANNON_PLVERIFY


3127 
	`shªnÚ_£t_fe_İs_owÃr
(&
¶ù¾_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3128 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
¶ù¾_fİs
, 
debugfs_¶ù¾_İ’
);

3129 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
¶ù¾_fİs
, 
shªnÚ_£q_»ad
);

3130 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
¶ù¾_fİs
, 
debugfs_¶ù¾_wr™e
);

3131 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
¶ù¾_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3132 
dev
->
debugfs_¶ù¾
 = 
	`shªnÚ_debugfs_ü—‹_fe
("plctrl", 0666,

3133 
dev
->
shªnÚ_debug_roÙ
, dev,

3134 &
¶ù¾_fİs
);

3135 ià(!
dev
->
debugfs_¶ù¾
)

3136  -
ENOENT
;

3139 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


3140 
	`shªnÚ_£t_fe_İs_owÃr
(&
mªu®_»ad_”r_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3141 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
mªu®_»ad_”r_fİs
, 
debugfs_mªu®_»ad_”r_İ’
);

3142 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
mªu®_»ad_”r_fİs
, 
shªnÚ_£q_»ad
);

3143 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
mªu®_»ad_”r_fİs
, 
debugfs_mªu®_»ad_”r_wr™e
);

3144 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
mªu®_»ad_”r_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3145 
dev
->
debugfs_mªu®_»ad_”r
 = 
	`shªnÚ_debugfs_ü—‹_fe
("manual_read_err", 0666,

3146 
dev
->
shªnÚ_debug_roÙ
, dev,

3147 &
mªu®_»ad_”r_fİs
);

3148 ià(!
dev
->
debugfs_mªu®_»ad_”r
)

3149  -
ENOENT
;

3151 
	`shªnÚ_£t_fe_İs_owÃr
(&
mªu®_wr™e_”r_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3152 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
mªu®_wr™e_”r_fİs
, 
debugfs_mªu®_wr™e_”r_İ’
);

3153 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
mªu®_wr™e_”r_fİs
, 
shªnÚ_£q_»ad
);

3154 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
mªu®_wr™e_”r_fİs
, 
debugfs_mªu®_wr™e_”r_wr™e
);

3155 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
mªu®_wr™e_”r_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3156 
dev
->
debugfs_mªu®_wr™e_”r
 = 
	`shªnÚ_debugfs_ü—‹_fe
("manual_write_err", 0666,

3157 
dev
->
shªnÚ_debug_roÙ
, dev,

3158 &
mªu®_wr™e_”r_fİs
);

3159 ià(!
dev
->
debugfs_mªu®_wr™e_”r
)

3160  -
ENOENT
;

3162 
	`shªnÚ_£t_fe_İs_owÃr
(&
çke_bad_lun_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3163 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
çke_bad_lun_fİs
, 
debugfs_çke_bad_lun_İ’
);

3164 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
çke_bad_lun_fİs
, 
debugfs_çke_bad_lun_wr™e
);

3165 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
çke_bad_lun_fİs
, 
shªnÚ_£q_»ad
);

3166 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
çke_bad_lun_fİs
, 
shªnÚ_£q_l£ek
);

3167 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
çke_bad_lun_fİs
, 
shªnÚ_£q_»Ëa£
);

3168 
dev
->
debugfs_çke_bad_lun
 = 
	`shªnÚ_debugfs_ü—‹_fe
("fake_bad_lun", 0666,

3169 
dev
->
shªnÚ_debug_roÙ
, dev,

3170 &
çke_bad_lun_fİs
);

3171 ià(!
dev
->
debugfs_çke_bad_lun
)

3172  -
ENOENT
;

3174 
	`shªnÚ_£t_fe_İs_owÃr
(&
çke_cmd_timeout_lun_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3175 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
çke_cmd_timeout_lun_fİs
, 
debugfs_çke_cmd_timeout_lun_İ’
);

3176 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
çke_cmd_timeout_lun_fİs
, 
debugfs_çke_cmd_timeout_lun_wr™e
);

3177 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
çke_cmd_timeout_lun_fİs
, 
shªnÚ_£q_»ad
);

3178 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
çke_cmd_timeout_lun_fİs
, 
shªnÚ_£q_l£ek
);

3179 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
çke_cmd_timeout_lun_fİs
, 
shªnÚ_£q_»Ëa£
);

3180 
dev
->
debugfs_çke_cmd_timeout_lun
 = 
	`shªnÚ_debugfs_ü—‹_fe
("fake_cmd_timeout_lun", 0666,

3181 
dev
->
shªnÚ_debug_roÙ
, dev,

3182 &
çke_cmd_timeout_lun_fİs
);

3183 ià(!
dev
->
debugfs_çke_cmd_timeout_lun
)

3184  -
ENOENT
;

3186 
	`shªnÚ_£t_fe_İs_owÃr
(&
çke_rd_bad_lun_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3187 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
çke_rd_bad_lun_fİs
, 
debugfs_çke_rd_bad_lun_İ’
);

3188 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
çke_rd_bad_lun_fİs
, 
debugfs_çke_rd_bad_lun_wr™e
);

3189 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
çke_rd_bad_lun_fİs
, 
shªnÚ_£q_»ad
);

3190 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
çke_rd_bad_lun_fİs
, 
shªnÚ_£q_l£ek
);

3191 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
çke_rd_bad_lun_fİs
, 
shªnÚ_£q_»Ëa£
);

3192 
dev
->
debugfs_çke_rd_bad_lun
 = 
	`shªnÚ_debugfs_ü—‹_fe
("fake_rd_bad_lun", 0666,

3193 
dev
->
shªnÚ_debug_roÙ
, dev,

3194 &
çke_rd_bad_lun_fİs
);

3195 ià(!
dev
->
debugfs_çke_rd_bad_lun
)

3196  -
ENOENT
;

3198 
	`shªnÚ_£t_fe_İs_owÃr
(&
çke_rd_bad_luÅba_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3199 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
çke_rd_bad_luÅba_fİs
, 
debugfs_çke_rd_bad_luÅba_İ’
);

3200 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
çke_rd_bad_luÅba_fİs
, 
debugfs_çke_rd_bad_luÅba_wr™e
);

3201 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
çke_rd_bad_luÅba_fİs
, 
shªnÚ_£q_»ad
);

3202 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
çke_rd_bad_luÅba_fİs
, 
shªnÚ_£q_l£ek
);

3203 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
çke_rd_bad_luÅba_fİs
, 
shªnÚ_£q_»Ëa£
);

3204 
dev
->
debugfs_çke_rd_bad_luÅba
 = 
	`shªnÚ_debugfs_ü—‹_fe
("fake_rd_bad_lunpba", 0666,

3205 
dev
->
shªnÚ_debug_roÙ
, dev,

3206 &
çke_rd_bad_luÅba_fİs
);

3207 ià(!
dev
->
debugfs_çke_rd_bad_luÅba
)

3208  -
ENOENT
;

3210 
	`shªnÚ_£t_fe_İs_owÃr
(&
çke_wr_bad_luÅ·_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3211 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
çke_wr_bad_luÅ·_fİs
, 
debugfs_çke_wr_bad_luÅ·_İ’
);

3212 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
çke_wr_bad_luÅ·_fİs
, 
debugfs_çke_wr_bad_luÅ·_wr™e
);

3213 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
çke_wr_bad_luÅ·_fİs
, 
shªnÚ_£q_»ad
);

3214 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
çke_wr_bad_luÅ·_fİs
, 
shªnÚ_£q_l£ek
);

3215 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
çke_wr_bad_luÅ·_fİs
, 
shªnÚ_£q_»Ëa£
);

3216 
dev
->
debugfs_çke_wr_bad_luÅ·
 = 
	`shªnÚ_debugfs_ü—‹_fe
("fake_wr_bad_lunppa", 0666,

3217 
dev
->
shªnÚ_debug_roÙ
, dev,

3218 &
çke_wr_bad_luÅ·_fİs
);

3219 ià(!
dev
->
debugfs_çke_wr_bad_luÅ·
)

3220  -
ENOENT
;

3222 
	`shªnÚ_£t_fe_İs_owÃr
(&
çke_”_bad_block_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3223 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
çke_”_bad_block_fİs
, 
debugfs_çke_”_bad_block_İ’
);

3224 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
çke_”_bad_block_fİs
, 
debugfs_çke_”_bad_block_wr™e
);

3225 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
çke_”_bad_block_fİs
, 
shªnÚ_£q_»ad
);

3226 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
çke_”_bad_block_fİs
, 
shªnÚ_£q_l£ek
);

3227 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
çke_”_bad_block_fİs
, 
shªnÚ_£q_»Ëa£
);

3228 
dev
->
debugfs_çke_”_bad_block
 = 
	`shªnÚ_debugfs_ü—‹_fe
("fake_er_bad_block", 0666,

3229 
dev
->
shªnÚ_debug_roÙ
, dev,

3230 &
çke_”_bad_block_fİs
);

3231 ià(!
dev
->
debugfs_çke_”_bad_block
)

3232  -
ENOENT
;

3234 
	`shªnÚ_£t_fe_İs_owÃr
(&
twš_»ad_”r_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3235 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
twš_»ad_”r_fİs
, 
debugfs_twš_»ad_”r_İ’
);

3236 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
twš_»ad_”r_fİs
, 
shªnÚ_£q_»ad
);

3237 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(&
twš_»ad_”r_fİs
, 
debugfs_twš_»ad_”r_wr™e
);

3238 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
twš_»ad_”r_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3239 
dev
->
debugfs_twš_»ad_”r
 = 
	`shªnÚ_debugfs_ü—‹_fe
("twin_read_err", 0666,

3240 
dev
->
shªnÚ_debug_roÙ
, dev,

3241 &
twš_»ad_”r_fİs
);

3242 ià(!
dev
->
debugfs_twš_»ad_”r
)

3243  -
ENOENT
;

3246 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_mbr_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3247 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_mbr_fİs
, 
debugfs_mbr_İ’
);

3248 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_mbr_fİs
, 
shªnÚ_£q_»ad
);

3249 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_mbr_fİs
, 
shªnÚ_£q_l£ek
);

3250 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_mbr_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3251 
dev
->
debugfs_mbr
 = 
	`shªnÚ_debugfs_ü—‹_fe
("mbr", 0444,

3252 
dev
->
shªnÚ_debug_roÙ
, dev,

3253 &
show_mbr_fİs
);

3254 ià(!
dev
->
debugfs_mbr
)

3255  -
ENOENT
;

3257 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_l2p_lunm­_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3258 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_l2p_lunm­_fİs
, 
debugfs_l2p_lunm­_İ’
);

3259 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_l2p_lunm­_fİs
, 
shªnÚ_£q_»ad
);

3260 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_l2p_lunm­_fİs
, 
shªnÚ_£q_l£ek
);

3261 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_l2p_lunm­_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3262 
dev
->
debugfs_l2p_lunm­
 = 
	`shªnÚ_debugfs_ü—‹_fe
("l2p_lunmap", 0444,

3263 
dev
->
shªnÚ_debug_roÙ
, dev,

3264 &
show_l2p_lunm­_fİs
);

3265 ià(!
dev
->
debugfs_l2p_lunm­
)

3266  -
ENOENT
;

3268 
	`shªnÚ_£t_fe_İs_owÃr
(&
badlun_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3269 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
badlun_fİs
, 
debugfs_badlun_İ’
);

3270 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
badlun_fİs
, 
shªnÚ_£q_»ad
);

3271 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
badlun_fİs
, 
shªnÚ_£q_l£ek
);

3272 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
badlun_fİs
, 
shªnÚ_£q_»Ëa£
);

3273 
dev
->
debugfs_badlun
 = 
	`shªnÚ_debugfs_ü—‹_fe
("badlun_bitmap", 0444,

3274 
dev
->
shªnÚ_debug_roÙ
, dev,

3275 &
badlun_fİs
);

3276 ià(!
dev
->
debugfs_badlun
)

3277  -
ENOENT
;

3279 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

3280 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_bbt_¡©e_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3281 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_bbt_¡©e_fİs
, 
debugfs_bbt_¡©e_İ’
);

3282 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_bbt_¡©e_fİs
, 
shªnÚ_£q_»ad
);

3283 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_bbt_¡©e_fİs
, 
shªnÚ_£q_l£ek
);

3284 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_bbt_¡©e_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3285 
dev
->
debugfs_bbt_¡©e
 = 
	`shªnÚ_debugfs_ü—‹_fe
("bbt_state", 0444,

3286 
dev
->
shªnÚ_debug_roÙ
, dev,

3287 &
show_bbt_¡©e_fİs
);

3288 ià(!
dev
->
debugfs_bbt_¡©e
)

3289  -
ENOENT
;

3292 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_vŞge_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3293 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_vŞge_fİs
, 
debugfs_vŞge_İ’
);

3294 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_vŞge_fİs
, 
shªnÚ_£q_»ad
);

3295 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_vŞge_fİs
, 
shªnÚ_£q_l£ek
);

3296 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_vŞge_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3297 
dev
->
debugfs_vŞge
 = 
	`shªnÚ_debugfs_ü—‹_fe
("voltage_temperature", 0444,

3298 
dev
->
shªnÚ_debug_roÙ
, dev,

3299 &
show_vŞge_fİs
);

3300 ià(!
dev
->
debugfs_vŞge
)

3301  -
ENOENT
;

3303 
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
 = 
	`shªnÚ_debugfs_ü—‹_dœ
("commªd_queue_¿w_d©a", dev->
shªnÚ_debug_roÙ
);

3304 ià(!
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
)

3305  -
ENOENT
;

3306 
dev
->
debugfs_cmd_queue_¿w_d©a
 = 
	`shªnÚ_km®loc
((
shªnÚ_d’Œy_t
 *è* (dev->
lun£t_couÁ
 + 2), 
GFP_SHANNON
);

3307 ià(!
dev
->
debugfs_cmd_queue_¿w_d©a
)

3308  -
ENOMEM
;

3310 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

3311 
	`shªnÚ_mem£t
(
Çmebuf
, 0, 30);

3312 
	`shªnÚ_¥rštf
(
Çmebuf
, "commªd_queue_¿w_d©a_%d", 
i
);

3313 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_cmd_queue_¿w_d©a_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3314 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_cmd_queue_¿w_d©a_fİs
, 
debugfs_cmd_queue_¿w_d©a_İ’
);

3315 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_cmd_queue_¿w_d©a_fİs
, 
shªnÚ_£q_»ad
);

3316 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_cmd_queue_¿w_d©a_fİs
, 
shªnÚ_£q_l£ek
);

3317 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_cmd_queue_¿w_d©a_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3318 
dev
->
debugfs_cmd_queue_¿w_d©a
[
i
] = 
	`shªnÚ_debugfs_ü—‹_fe
(
Çmebuf
, 0444,

3319 
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
, &dev->
lun£ts
[
i
],

3320 &
show_cmd_queue_¿w_d©a_fİs
);

3321 ià(!
dev
->
debugfs_cmd_queue_¿w_d©a
[
i
])

3322  -
ENOENT
;

3325 
	`shªnÚ_mem£t
(
Çmebuf
, 0, 30);

3326 
	`shªnÚ_¥rštf
(
Çmebuf
, "command_queue_raw_data_bufq_%d", 0);

3327 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_cmd_queue_¿w_d©a_bufq0_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3328 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq0_fİs
, 
debugfs_cmd_queue_¿w_d©a_bufq0_İ’
);

3329 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq0_fİs
, 
shªnÚ_£q_»ad
);

3330 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq0_fİs
, 
shªnÚ_£q_l£ek
);

3331 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq0_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3332 
dev
->
debugfs_cmd_queue_¿w_d©a
[dev->
lun£t_couÁ
] = 
	`shªnÚ_debugfs_ü—‹_fe
(
Çmebuf
, 0444,

3333 
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
, dev,

3334 &
show_cmd_queue_¿w_d©a_bufq0_fİs
);

3335 ià(!
dev
->
debugfs_cmd_queue_¿w_d©a
[dev->
lun£t_couÁ
])

3336  -
ENOENT
;

3338 
	`shªnÚ_mem£t
(
Çmebuf
, 0, 30);

3339 
	`shªnÚ_¥rštf
(
Çmebuf
, "command_queue_raw_data_bufq_%d", 1);

3340 
	`shªnÚ_£t_fe_İs_owÃr
(&
show_cmd_queue_¿w_d©a_bufq1_fİs
, 
	`shªnÚ_g‘_this_moduË
());

3341 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq1_fİs
, 
debugfs_cmd_queue_¿w_d©a_bufq1_İ’
);

3342 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq1_fİs
, 
shªnÚ_£q_»ad
);

3343 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq1_fİs
, 
shªnÚ_£q_l£ek
);

3344 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(&
show_cmd_queue_¿w_d©a_bufq1_fİs
, 
shªnÚ_sšgË_»Ëa£
);

3345 
dev
->
debugfs_cmd_queue_¿w_d©a
[dev->
lun£t_couÁ
 + 1] = 
	`shªnÚ_debugfs_ü—‹_fe
(
Çmebuf
, 0444,

3346 
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
, dev,

3347 &
show_cmd_queue_¿w_d©a_bufq1_fİs
);

3348 ià(!
dev
->
debugfs_cmd_queue_¿w_d©a
[dev->
lun£t_couÁ
 + 1])

3349  -
ENOENT
;

3352 
	}
}

3354 
	$shªnÚ_debugfs_ş—nup
(
shªnÚ_dev
 *
dev
)

3356 
i
;

3358 
i
 = 0; i < 
dev
->
lun£t_couÁ
 + 2; i++) {

3359 ià(
dev
->
debugfs_cmd_queue_¿w_d©a
[
i
]) {

3360 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_cmd_queue_¿w_d©a
[
i
]);

3361 
dev
->
debugfs_cmd_queue_¿w_d©a
[
i
] = 
NULL
;

3364 ià(
dev
->
debugfs_cmd_queue_¿w_d©a
) {

3365 
	`shªnÚ_kä“
(
dev
->
debugfs_cmd_queue_¿w_d©a
);

3366 
dev
->
debugfs_cmd_queue_¿w_d©a
 = 
NULL
;

3368 ià(
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
) {

3369 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
);

3370 
dev
->
debugfs_cmd_queue_¿w_d©a_dœ
 = 
NULL
;

3372 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

3373 ià(
dev
->
debugfs_bbt_¡©e
) {

3374 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_bbt_¡©e
);

3375 
dev
->
debugfs_bbt_¡©e
 = 
NULL
;

3378 ià(
dev
->
debugfs_vŞge
) {

3379 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_vŞge
);

3380 
dev
->
debugfs_vŞge
 = 
NULL
;

3382 ià(
dev
->
debugfs_badlun
) {

3383 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_badlun
);

3384 
dev
->
debugfs_badlun
 = 
NULL
;

3386 ià(
dev
->
debugfs_l2p_lunm­
) {

3387 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_l2p_lunm­
);

3388 
dev
->
debugfs_l2p_lunm­
 = 
NULL
;

3390 ià(
dev
->
debugfs_mbr
) {

3391 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_mbr
);

3392 
dev
->
debugfs_mbr
 = 
NULL
;

3394 #ifdeà
CONFIG_SHANNON_PLVERIFY


3395 ià(
dev
->
debugfs_¶ù¾
) {

3396 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_¶ù¾
);

3397 
dev
->
debugfs_¶ù¾
 = 
NULL
;

3400 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


3401 ià(
dev
->
debugfs_mªu®_»ad_”r
) {

3402 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_mªu®_»ad_”r
);

3403 
dev
->
debugfs_mªu®_»ad_”r
 = 
NULL
;

3406 ià(
dev
->
debugfs_mªu®_wr™e_”r
) {

3407 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_mªu®_wr™e_”r
);

3408 
dev
->
debugfs_mªu®_wr™e_”r
 = 
NULL
;

3411 ià(
dev
->
debugfs_çke_rd_bad_lun
) {

3412 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_çke_rd_bad_lun
);

3413 
dev
->
debugfs_çke_rd_bad_lun
 = 
NULL
;

3416 ià(
dev
->
debugfs_çke_bad_lun
) {

3417 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_çke_bad_lun
);

3418 
dev
->
debugfs_çke_bad_lun
 = 
NULL
;

3421 ià(
dev
->
debugfs_çke_cmd_timeout_lun
) {

3422 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_çke_cmd_timeout_lun
);

3423 
dev
->
debugfs_çke_cmd_timeout_lun
 = 
NULL
;

3426 ià(
dev
->
debugfs_çke_”_bad_block
) {

3427 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_çke_”_bad_block
);

3428 
dev
->
debugfs_çke_”_bad_block
 = 
NULL
;

3431 ià(
dev
->
debugfs_çke_rd_bad_luÅba
) {

3432 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_çke_rd_bad_luÅba
);

3433 
dev
->
debugfs_çke_rd_bad_luÅba
 = 
NULL
;

3436 ià(
dev
->
debugfs_çke_wr_bad_luÅ·
) {

3437 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_çke_wr_bad_luÅ·
);

3438 
dev
->
debugfs_çke_wr_bad_luÅ·
 = 
NULL
;

3441 ià(
dev
->
debugfs_twš_»ad_”r
) {

3442 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_twš_»ad_”r
);

3443 
dev
->
debugfs_twš_»ad_”r
 = 
NULL
;

3446 ià(
dev
->
debugfs_lock_¡©
) {

3447 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_lock_¡©
);

3448 
dev
->
debugfs_lock_¡©
 = 
NULL
;

3450 ià(
dev
->
debugfs_wa™queue
) {

3451 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_wa™queue
);

3452 
dev
->
debugfs_wa™queue
 = 
NULL
;

3455 ià(
dev
->
sdisk
.
debugfs_rmw_li¡
) {

3456 
	`shªnÚ_debugfs_»move
(
dev
->
sdisk
.
debugfs_rmw_li¡
);

3457 
dev
->
sdisk
.
debugfs_rmw_li¡
 = 
NULL
;

3459 ià(
dev
->
debugfs_bad_blocks
) {

3460 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_bad_blocks
);

3461 
dev
->
debugfs_bad_blocks
 = 
NULL
;

3463 ià(
dev
->
debugfs_»ad_couÁ
) {

3464 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_»ad_couÁ
);

3465 
dev
->
debugfs_»ad_couÁ
 = 
NULL
;

3467 ià(
dev
->
debugfs_ecc_çu»_times
) {

3468 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_ecc_çu»_times
);

3469 
dev
->
debugfs_ecc_çu»_times
 = 
NULL
;

3471 ià(
dev
->
debugfs_bßrd_·¿m‘”s
) {

3472 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_bßrd_·¿m‘”s
);

3473 
dev
->
debugfs_bßrd_·¿m‘”s
 = 
NULL
;

3475 ià(
dev
->
debugfs_¡©i¡ics
) {

3476 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_¡©i¡ics
);

3477 
dev
->
debugfs_¡©i¡ics
 = 
NULL
;

3479 ià(
dev
->
debugfs_lun_¡©i¡ics
) {

3480 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_lun_¡©i¡ics
);

3481 
dev
->
debugfs_lun_¡©i¡ics
 = 
NULL
;

3483 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


3484 ià(
dev
->
debugfs_sq_d•th
) {

3485 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_sq_d•th
);

3486 
dev
->
debugfs_sq_d•th
 = 
NULL
;

3489 ià(
dev
->
debugfs_queue_d•th
) {

3490 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_queue_d•th
);

3491 
dev
->
debugfs_queue_d•th
 = 
NULL
;

3493 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

3494 ià(
dev
->
debugfs_»gi¡”s
) {

3495 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_»gi¡”s
);

3496 
dev
->
debugfs_»gi¡”s
 = 
NULL
;

3499 ià(
dev
->
debugfs_gc_¡©e
) {

3500 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_gc_¡©e
);

3501 
dev
->
debugfs_gc_¡©e
 = 
NULL
;

3503 ià(
dev
->
debugfs_cmd_queue
) {

3504 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_cmd_queue
);

3505 
dev
->
debugfs_cmd_queue
 = 
NULL
;

3507 ià(
dev
->
debugfs_»q_queue1
) {

3508 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_»q_queue1
);

3509 
dev
->
debugfs_»q_queue1
 = 
NULL
;

3511 ià(
dev
->
debugfs_»q_queue0
) {

3512 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_»q_queue0
);

3513 
dev
->
debugfs_»q_queue0
 = 
NULL
;

3515 ià(
dev
->
debugfs_ä“_blocks
) {

3516 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_ä“_blocks
);

3517 
dev
->
debugfs_ä“_blocks
 = 
NULL
;

3519 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


3520 ià(
dev
->
debugfs_out¡ªdšg_sbios
) {

3521 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_out¡ªdšg_sbios
);

3522 
dev
->
debugfs_out¡ªdšg_sbios
 = 
NULL
;

3525 ià(
dev
->
debugfs_out¡ªdšg_»qs
) {

3526 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_out¡ªdšg_»qs
);

3527 
dev
->
debugfs_out¡ªdšg_»qs
 = 
NULL
;

3530 ià(
dev
->
debugfs_”r_blks
) {

3531 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_”r_blks
);

3532 
dev
->
debugfs_”r_blks
 = 
NULL
;

3535 ià(
dev
->
debugfs_wa™_cİy
) {

3536 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_wa™_cİy
);

3537 
dev
->
debugfs_wa™_cİy
 = 
NULL
;

3539 ià(
dev
->
debugfs_wa™_”a£d
) {

3540 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_wa™_”a£d
);

3541 
dev
->
debugfs_wa™_”a£d
 = 
NULL
;

3543 ià(
dev
->
debugfs_cŞd_blocks
) {

3544 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_cŞd_blocks
);

3545 
dev
->
debugfs_cŞd_blocks
 = 
NULL
;

3547 ià(
dev
->
debugfs_hÙ_blocks
) {

3548 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_hÙ_blocks
);

3549 
dev
->
debugfs_hÙ_blocks
 = 
NULL
;

3551 #ifdeà
CONFIG_SHANNON_DEBUG_DUMP


3552 ià(
dev
->
debugfs_dump
){

3553 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_dump
);

3554 
dev
->
debugfs_dump
 = 
NULL
;

3557 ià(
dev
->
debugfs_®l_blocks
) {

3558 
	`shªnÚ_debugfs_»move
(
dev
->
debugfs_®l_blocks
);

3559 
dev
->
debugfs_®l_blocks
 = 
NULL
;

3561 ià(
dev
->
shªnÚ_debug_roÙ
) {

3562 
	`shªnÚ_debugfs_»move
(
dev
->
shªnÚ_debug_roÙ
);

3563 
dev
->
shªnÚ_debug_roÙ
 = 
NULL
;

3565 
	}
}

3567 
	$check_v®id_·ges
(
shªnÚ_dev
 *
dev
, 
sb_šdex
)

3569 
lun
, 
v®id_·ges
 = 0;

3570 
shªnÚ_sb
 *
sb
;

3571 
logicb_t
 
pba
, 
fœ¡_pba
, 
Ï¡_pba
;

3573 ià(!
	`shªnÚ_dev_is_g5
(
dev
))

3574 
	`BUG_ON
(
sb_šdex
==0);

3575 
sb
 = 
dev
->
sbs
 + 
sb_šdex
;

3577 
fœ¡_pba
 = 
sb
->
sb_šdex
 * 
dev
->
logicbs_š_siblšg_eblock
;

3578 
Ï¡_pba
 = (
sb
->
sb_šdex
 + 1è* 
dev
->
logicbs_š_siblšg_eblock
;

3580 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

3581 
lun
 = 
	`g‘_·r™y_lun
(&
sb
->
sub_group
[0]);

3583 
lun
 = (luÀ+ 1è% 
dev
->
lun_couÁ
;

3584 
	`is_bad_lun
(
sb
, 
lun
))

3585 
lun
 = (luÀ+ 1è% 
dev
->
lun_couÁ
;

3586 
pba
 = 
fœ¡_pba
;…b¨< 
Ï¡_pba
;…ba++) {

3587 ià(!
	`is_¡®e
(
dev
, 
lun
, 
pba
)) {

3588 
v®id_·ges
++;

3591 } 
lun
 !ğ
	`Ï¡_d©a_lun
(&
sb
->
sub_group
[0]));

3593 
	`shªnÚ_šfo
("%s(): sb_šdex=%2d, v®id_·ges=%d, sb->v®id_·ges=%d.\n", 
__func__
, 
sb_šdex
, 
v®id_·ges
, 
	`shªnÚ_©omic_»ad
(&
sb
->valid_pages));

3594 
	`BUG_ON
((
sb
->
¡©e
 !ğ
HOT_ACTIVE_BLOCK
è&& (sb->¡©!ğ
COLD_ACTIVE_BLOCK
è&& (
v®id_·ges
 !ğ
	`shªnÚ_©omic_»ad
(&sb->valid_pages)));

3595 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

3596 
	}
}

3598 
	$dump_pba_bË
(
shªnÚ_dev
 *
dev
, 
sb_šdex
)

3600 
off£t
 = (
sb_šdex
*
dev
->
logicbs_š_siblšg_eblock
*
PBA_ENTRY_LEN
)/8;

3601 
Ën
 = (
dev
->
logicbs_š_siblšg_eblock
*
PBA_ENTRY_LEN
)/8;

3602 *
ba£
;

3603 
lun
, 
j
;

3605 
	`shªnÚ_šfo
("%s(): sb_šdex=%d. ---------\n", 
__func__
, 
sb_šdex
);

3606 
lun
 = 0;†uÀ< 
dev
->
lun_couÁ
;†un++) {

3607 
	`shªnÚ_šfo
("lun=%d: ", 
lun
);

3608 
ba£
 = (*)
dev
->
lun
[lun]->
pba_bË
 + 
off£t
;

3609 
j
 = 0; j < 
Ën
; j++) {

3610 
	`shªnÚ_šfo
("%3x ", *(
ba£
 + 
j
));

3612 
	`shªnÚ_šfo
("\n");

3614 
	}
}

	@shannon_device.c

1 
	~<lšux/fs.h
>

2 
	~<lšux/deviû.h
>

3 
	~<lšux/cdev.h
>

4 
	~<lšux/š‹¼u±.h
>

5 
	~<lšux/blkdev.h
>

6 
	~<lšux/g’hd.h
>

7 
	~<lšux/k”Ãl.h
>

8 
	~<lšux/jiff›s.h
>

9 
	~<lšux/moduË.h
>

10 
	~<lšux/v”siÚ.h
>

12 
	~"shªnÚ_deviû.h
"

13 
	~"shªnÚ_dma.h
"

14 
	~"shªnÚ_block.h
"

16 
	#NAMEBUF_LEN
 256

	)

18 *
	$shªnÚ_g‘_this_moduË
()

20  
THIS_MODULE
;

21 
	}
}

23 
shªnÚ_dev_t
 
	$SHANNON_MAJOR
(
shªnÚ_dev_t
 
dev
)

25  
	`MAJOR
(
dev
);

26 
	}
}

28 
shªnÚ_dev_t
 
	$SHANNON_MINOR
(
shªnÚ_dev_t
 
dev
)

30  
	`MINOR
(
dev
);

31 
	}
}

33 
shªnÚ_dev_t
 
	$SHANNON_MKDEV
(
shªnÚ_dev_t
 
ma
, shªnÚ_dev_ˆ
mi
)

35  
	`MKDEV
(
ma
, 
mi
);

36 
	}
}

39 
	$shªnÚ_cdev_add
(
shªnÚ_cdev_t
 *
p
, 
shªnÚ_dev_t
 
dev
, 
couÁ
)

41  
	`cdev_add
((
cdev
 *)
p
, 
dev
, 
couÁ
);

42 
	}
}

44 
	$shªnÚ_cdev_d–
(
shªnÚ_cdev_t
 *
p
)

46 
	`cdev_d–
((
cdev
 *)
p
);

47 
	}
}

49 
	$shªnÚ_cdev_š™
(
shªnÚ_cdev_t
 *
cdev
, cÚ¡ 
shªnÚ_fe_İ”©iÚs_t
 *
fİs
)

51 
	`cdev_š™
((
cdev
 *)cdev, (cÚ¡ 
fe_İ”©iÚs
 *)
fİs
);

52 
	}
}

54 
	$shªnÚ_£t_cdev_owÃr_this_moduË
(
shªnÚ_cdev_t
 *
cdev
)

56 ((
cdev
 *)cdev)->
owÃr
 = 
THIS_MODULE
;

57 
	}
}

59 
fe_İ”©iÚs
 
debug_cdev_fİs
;

61 
	$shªnÚ_š™_debug_cdev
(
shªnÚ_cdev_t
 *
cdev
)

63 
	`cdev_š™
((
cdev
 *)cdev, &
debug_cdev_fİs
);

64 
	}
}

67 
shªnÚ_deviû_t
 *
	$shªnÚ_deviû_ü—‹
(
shªnÚ_şass_t
 *
şass
, 
shªnÚ_deviû_t
 *
·»Á
,

68 
shªnÚ_dev_t
 
devt
, *
drvd©a
, cÚ¡ *
fmt
, ...)

70 
va_li¡
 
v¬gs
;

71 
Çmebuf
[
NAMEBUF_LEN
];

73 
	`va_¡¬t
(
v¬gs
, 
fmt
);

74 
	`v¢´štf
(
Çmebuf
, 
NAMEBUF_LEN
, 
fmt
, 
v¬gs
);

75 
	`va_’d
(
v¬gs
);

77 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 27)

79  
	`deviû_ü—‹
((
şass
 *)şass, (
deviû
 *)
·»Á
, 
devt
, 
drvd©a
, 
Çmebuf
);

83  
	`deviû_ü—‹
((
şass
 *)şass, (
deviû
 *)
·»Á
, 
devt
, 
Çmebuf
);

86 
	}
}

88 
	$shªnÚ_deviû_de¡roy
(
shªnÚ_şass_t
 *
şs
, 
shªnÚ_dev_t
 
devt
)

90 
	`deviû_de¡roy
((
şass
 *)
şs
, 
devt
);

91 
	}
}

93 
shªnÚ_şass_t
 *
	$shªnÚ_şass_ü—‹
(
shªnÚ_moduË_t
 *
owÃr
, *
Çme
)

95  
	`şass_ü—‹
((
moduË
 *)
owÃr
, 
Çme
);

96 
	}
}

98 
	$shªnÚ_şass_de¡roy
(
shªnÚ_şass_t
 *
şs
)

100 
	`şass_de¡roy
((
şass
 *)
şs
);

101 
	}
}

104 
	$shªnÚ_®loc_chrdev_»giÚ
(
shªnÚ_dev_t
 *
dev
, 
ba£mšÜ
, 
couÁ
, cÚ¡ *
Çme
)

106  
	`®loc_chrdev_»giÚ
(
dev
, 
ba£mšÜ
, 
couÁ
, 
Çme
);

107 
	}
}

109 
	$shªnÚ_uÄegi¡”_chrdev_»giÚ
(
shªnÚ_dev_t
 
äom
, 
couÁ
)

111 
	`uÄegi¡”_chrdev_»giÚ
(
äom
, 
couÁ
);

112 
	}
}

115 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 28)

117 
	$shªnÚ_disk_š_æight
(
shªnÚ_g’disk_t
 *
gdt
)

119 
g’disk
 *
gd
 = (g’disk *)
gdt
;

120  
	`©omic_»ad
((
©omic_t
 *)(&
gd
->
š_æight
));

121 
	}
}

123 #–ià
LINUX_VERSION_CODE
 =ğ
KERNEL_VERSION
(2, 6, 28)

125 
šlše
 
	$shªnÚ_·¹_šc_š_æight
(
hd_¡ruù
 *
·¹
, 
rw
)

127 
	`©omic_šc
((
©omic_t
 *)(&
·¹
->
š_æight
));

128 ià(
·¹
->
·¹no
)

129 
	`©omic_šc
((
©omic_t
 *)(&
	`·¹_to_disk
(
·¹
)->
·¹0
.
š_æight
));

130 
	}
}

132 
šlše
 
	$shªnÚ_·¹_dec_š_æight
(
hd_¡ruù
 *
·¹
, 
rw
)

134 
	`©omic_dec
((
©omic_t
 *)(&
·¹
->
š_æight
));

135 ià(
·¹
->
·¹no
)

136 
	`©omic_dec
((
©omic_t
 *)(&
	`·¹_to_disk
(
·¹
)->
·¹0
.
š_æight
));

137 
	}
}

139 
	$shªnÚ_disk_š_æight
(
shªnÚ_g’disk_t
 *
gdt
)

141 
g’disk
 *
gd
 = (g’disk *)
gdt
;

142  
	`©omic_»ad
((
©omic_t
 *)(&
gd
->
·¹0
.
š_æight
));

143 
	}
}

147 
šlše
 
	$shªnÚ_·¹_šc_š_æight
(
hd_¡ruù
 *
·¹
, 
rw
)

149 
	`©omic_šc
((
©omic_t
 *)(&
·¹
->
š_æight
[
rw
]));

150 ià(
·¹
->
·¹no
)

151 
	`©omic_šc
((
©omic_t
 *)(&
	`·¹_to_disk
(
·¹
)->
·¹0
.
š_æight
[
rw
]));

152 
	}
}

154 
šlše
 
	$shªnÚ_·¹_dec_š_æight
(
hd_¡ruù
 *
·¹
, 
rw
)

156 
	`©omic_dec
((
©omic_t
 *)(&
·¹
->
š_æight
[
rw
]));

157 ià(
·¹
->
·¹no
)

158 
	`©omic_dec
((
©omic_t
 *)(&
	`·¹_to_disk
(
·¹
)->
·¹0
.
š_æight
[
rw
]));

159 
	}
}

161 
	$shªnÚ_disk_š_æight
(
shªnÚ_g’disk_t
 *
gdt
)

163 
g’disk
 *
gd
 = (g’disk *)
gdt
;

165 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 14, 0)

167 #ifdeà
RHEL_RELEASE_CODE


168 #ià
RHEL_RELEASE_CODE
 >ğ
	`RHEL_RELEASE_VERSION
(7, 6)

169  
	`©omic_»ad
(&
gd
->
·¹0
.
š_æight
[0]) +‡tomic_read(&gd->part0.in_flight[1]);

171  
	`·¹_š_æight
(&
gd
->
·¹0
);

174  
	`·¹_š_æight
(&
gd
->
·¹0
);

178  
	`©omic_»ad
(&
gd
->
·¹0
.
š_æight
[0]) +‡tomic_read(&gd->part0.in_flight[1]);

180 
	}
}

184 
	$shªnÚ_¡¬t_io_acù
(
shªnÚ_g’disk_t
 *
gdt
, 
shªnÚ_bio_t
 *
p
)

186 
bio
 *biØğ(biØ*)
p
;

187 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

188 
ıu
, 
rw
;

189 
g’disk
 *
gd
 = (g’disk *)
gdt
;

190 
hd_¡ruù
 *
·¹
;

192 
rw
 = 
	`shªnÚ_bio_d©a_dœ
(
bio
);

193 
ıu
 = 
	`·¹_¡©_lock
();

194 
·¹
 = 
	`disk_m­_£ùÜ_rcu
(
gd
, 
	`g‘_bi_£ùÜ
(
bio
));

195 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 14, 0)

197 #ifdeà
RHEL_RELEASE_CODE


198 #ià
RHEL_RELEASE_CODE
 >ğ
	`RHEL_RELEASE_VERSION
(7, 6)

199 
	`·¹_round_¡©s
(
gd
->
queue
, 
ıu
, 
·¹
);

201 
	`·¹_round_¡©s
(
ıu
, 
·¹
);

204 
	`·¹_round_¡©s
(
ıu
, 
·¹
);

208 
	`·¹_round_¡©s
(
gd
->
queue
, 
ıu
, 
·¹
);

210 
	`·¹_¡©_šc
(
ıu
, 
·¹
, 
ios
[
rw
]);

211 
	`·¹_¡©_add
(
ıu
, 
·¹
, 
£ùÜs
[
rw
], 
	`bio_£ùÜs
(
bio
));

212 
	`shªnÚ_·¹_šc_š_æight
(
·¹
, 
rw
);

213 
	`·¹_¡©_uÆock
();

215 
rw
;

216 
g’disk
 *
gd
 = (g’disk *)
gdt
;

218 
rw
 = 
	`shªnÚ_bio_d©a_dœ
(
bio
);

219 
	`´“m±_di§bË
();

220 
	`disk_round_¡©s
(
gd
);

221 
	`disk_¡©_šc
(
gd
, 
ios
[
rw
]);

222 
	`disk_¡©_add
(
gd
, 
£ùÜs
[
rw
], 
	`bio_£ùÜs
(
bio
));

223 
	`©omic_šc
((
©omic_t
 *)(&
gd
->
š_æight
));

224 
	`´“m±_’abË
();

227 
	}
}

229 
	$shªnÚ_’d_io_acù
(
shªnÚ_g’disk_t
 *
gdt
, 
shªnÚ_bio_t
 *
p
, 
du¿tiÚ
)

231 
bio
 *biØğ(biØ*)
p
;

232 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

233 
ıu
, 
rw
;

234 
g’disk
 *
gd
 = (g’disk *)
gdt
;

235 
hd_¡ruù
 *
·¹
;

237 
rw
 = 
	`shªnÚ_bio_d©a_dœ
(
bio
);

238 
ıu
 = 
	`·¹_¡©_lock
();

239 
·¹
 = 
	`disk_m­_£ùÜ_rcu
(
gd
, 
	`g‘_bi_£ùÜ
(
bio
));

240 
	`·¹_¡©_add
(
ıu
, 
·¹
, 
ticks
[
rw
], 
du¿tiÚ
);

241 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 14, 0)

243 #ifdeà
RHEL_RELEASE_CODE


244 #ià
RHEL_RELEASE_CODE
 >ğ
	`RHEL_RELEASE_VERSION
(7, 6)

245 
	`·¹_round_¡©s
(
gd
->
queue
, 
ıu
, 
·¹
);

247 
	`·¹_round_¡©s
(
ıu
, 
·¹
);

250 
	`·¹_round_¡©s
(
ıu
, 
·¹
);

254 
	`·¹_round_¡©s
(
gd
->
queue
, 
ıu
, 
·¹
);

256 
	`shªnÚ_·¹_dec_š_æight
(
·¹
, 
rw
);

257 
	`·¹_¡©_uÆock
();

259 
rw
;

260 
g’disk
 *
gd
 = (g’disk *)
gdt
;

262 
rw
 = 
	`shªnÚ_bio_d©a_dœ
(
bio
);

263 
	`´“m±_di§bË
();

264 
	`disk_¡©_add
(
gd
, 
ticks
[
rw
], 
du¿tiÚ
);

265 
	`disk_round_¡©s
(
gd
);

266 
	`©omic_dec
((
©omic_t
 *)(&
gd
->
š_æight
));

267 
	`´“m±_’abË
();

269 
	}
}

271 
	$shªnÚ_»ad_£ùÜs
(
shªnÚ_g’disk_t
 *
gdt
)

273 
g’disk
 *
gd
 = (g’disk *)
gdt
;

275 ià(
gd
 =ğ
NULL
)

278 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

279  
	`·¹_¡©_»ad
(&
gd
->
·¹0
, 
£ùÜs
[
READ
]);

281  
	`disk_¡©_»ad
(
gd
, 
£ùÜs
[
READ
]);

283 
	}
}

285 
	$shªnÚ_wr™e_£ùÜs
(
shªnÚ_g’disk_t
 *
gdt
)

287 
g’disk
 *
gd
 = (g’disk *)
gdt
;

289 ià(
gd
 =ğ
NULL
)

292 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

293  
	`·¹_¡©_»ad
(&
gd
->
·¹0
, 
£ùÜs
[
WRITE
]);

295  
	`disk_¡©_»ad
(
gd
, 
£ùÜs
[
WRITE
]);

297 
	}
}

299 
	$shªnÚ_»ad_ios
(
shªnÚ_g’disk_t
 *
gdt
)

301 
g’disk
 *
gd
 = (g’disk *)
gdt
;

303 ià(
gd
 =ğ
NULL
)

306 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

307  
	`·¹_¡©_»ad
(&
gd
->
·¹0
, 
ios
[
READ
]);

309  
	`disk_¡©_»ad
(
gd
, 
ios
[
READ
]);

311 
	}
}

313 
	$shªnÚ_wr™e_ios
(
shªnÚ_g’disk_t
 *
gdt
)

315 
g’disk
 *
gd
 = (g’disk *)
gdt
;

317 ià(
gd
 =ğ
NULL
)

320 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

321  
	`·¹_¡©_»ad
(&
gd
->
·¹0
, 
ios
[
WRITE
]);

323  
	`disk_¡©_»ad
(
gd
, 
ios
[
WRITE
]);

325 
	}
}

327 
	$shªnÚ_»ad_m£cs
(
shªnÚ_g’disk_t
 *
gdt
)

329 
g’disk
 *
gd
 = (g’disk *)
gdt
;

331 ià(
gd
 =ğ
NULL
)

334 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

335  
	`jiff›s_to_m£cs
(
	`·¹_¡©_»ad
(&
gd
->
·¹0
, 
ticks
[
READ
]));

337  
	`jiff›s_to_m£cs
(
	`disk_¡©_»ad
(
gd
, 
ticks
[
READ
]));

339 
	}
}

341 
	$shªnÚ_wr™e_m£cs
(
shªnÚ_g’disk_t
 *
gdt
)

343 
g’disk
 *
gd
 = (g’disk *)
gdt
;

345 ià(
gd
 =ğ
NULL
)

348 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

349  
	`jiff›s_to_m£cs
(
	`·¹_¡©_»ad
(&
gd
->
·¹0
, 
ticks
[
WRITE
]));

351  
	`jiff›s_to_m£cs
(
	`disk_¡©_»ad
(
gd
, 
ticks
[
WRITE
]));

353 
	}
}

	@shannon_device.h

1 #iâdeà
__SHANNON_DEVICE_H


2 
	#__SHANNON_DEVICE_H


	)

4 
	~"shªnÚ_kcÜe.h
"

5 
	~"shªnÚ_wÜkqueue.h
"

6 
	~"shªnÚ_block.h
"

7 
	~"shªnÚ_fe.h
"

9 
	s__shªnÚ_cdev
 {

10 
RESERVE_MEM
(256);

12 
__shªnÚ_cdev
 
	tshªnÚ_cdev_t
;

14 
	s__shªnÚ_miscdeviû
 {

15 
RESERVE_MEM
(256);

17 
__shªnÚ_miscdeviû
 
	tshªnÚ_miscdeviû_t
;

19 
fe_İ”©iÚs
 
shªnÚ_ù¾_cdev_fİs
;

20 
fe_İ”©iÚs
 
debug_cdev_fİs
;

22 
	sdebug_cdev
 {

23 
	#SCATTER_MEMBLOCK_TYPE
 (0x11)

	)

24 
	#NORMAL_TYPE
 (0x22)

	)

25 
	mty³
;

26 
	mmšÜ
;

27 *
	mbuf
;

28 
	msize
;

29 
shªnÚ_cdev_t
 
	mcdev
;

32 
	tshªnÚ_şass_t
;

33 
	tshªnÚ_moduË_t
;

35 
	tshªnÚ_dev_t
;

37 *
shªnÚ_g‘_this_moduË
();

38 
shªnÚ_dev_t
 
SHANNON_MAJOR
(shªnÚ_dev_ˆ
dev
);

39 
shªnÚ_dev_t
 
SHANNON_MINOR
(shªnÚ_dev_ˆ
dev
);

40 
shªnÚ_dev_t
 
SHANNON_MKDEV
(shªnÚ_dev_ˆ
ma
, shªnÚ_dev_ˆ
mi
);

43 
shªnÚ_deviû_t
 *
shªnÚ_deviû_ü—‹
(
shªnÚ_şass_t
 *
şass
, shªnÚ_deviû_ˆ*
·»Á
,

44 
shªnÚ_dev_t
 
devt
, *
drvd©a
, cÚ¡ *
fmt
, ...);

45 
shªnÚ_deviû_de¡roy
(
shªnÚ_şass_t
 *
şs
, 
shªnÚ_dev_t
 
devt
);

46 
shªnÚ_şass_t
 *
shªnÚ_şass_ü—‹
(
shªnÚ_moduË_t
 *
owÃr
, *
Çme
);

47 
shªnÚ_şass_de¡roy
(
shªnÚ_şass_t
 *
şs
);

50 
shªnÚ_cdev_add
(
shªnÚ_cdev_t
 *
p
, 
dev_t
 
dev
, 
couÁ
);

51 
shªnÚ_cdev_d–
(
shªnÚ_cdev_t
 *
p
);

52 
shªnÚ_cdev_š™
(
shªnÚ_cdev_t
 *
cdev
, cÚ¡ 
shªnÚ_fe_İ”©iÚs_t
 *
fİs
);

53 
shªnÚ_š™_debug_cdev
(
shªnÚ_cdev_t
 *
cdev
);

54 
shªnÚ_£t_cdev_owÃr_this_moduË
(
shªnÚ_cdev_t
 *
cdev
);

58 
shªnÚ_®loc_chrdev_»giÚ
(
dev_t
 *
dev
, 
ba£mšÜ
, 
couÁ
, cÚ¡ *
Çme
);

59 
shªnÚ_uÄegi¡”_chrdev_»giÚ
(
dev_t
 
äom
, 
couÁ
);

62 
shªnÚ_disk_š_æight
(
shªnÚ_g’disk_t
 *
gdt
);

63 
shªnÚ_¡¬t_io_acù
(
shªnÚ_g’disk_t
 *
gdt
, 
shªnÚ_bio_t
 *
bio
);

64 
shªnÚ_’d_io_acù
(
shªnÚ_g’disk_t
 *
gdt
, 
shªnÚ_bio_t
 *
bio
, 
du¿tiÚ
);

65 
shªnÚ_»ad_£ùÜs
(
shªnÚ_g’disk_t
 *
gdt
);

66 
shªnÚ_wr™e_£ùÜs
(
shªnÚ_g’disk_t
 *
gdt
);

67 
shªnÚ_»ad_ios
(
shªnÚ_g’disk_t
 *
gdt
);

68 
shªnÚ_wr™e_ios
(
shªnÚ_g’disk_t
 *
gdt
);

69 
shªnÚ_»ad_m£cs
(
shªnÚ_g’disk_t
 *
gdt
);

70 
shªnÚ_wr™e_m£cs
(
shªnÚ_g’disk_t
 *
gdt
);

	@shannon_dma.c

1 
	~"shªnÚ_dma.h
"

2 
	~<lšux/dma-m­pšg.h
>

3 
	~<lšux/pci.h
>

4 
	~<lšux/v”siÚ.h
>

5 
	~<lšux/d–ay.h
>

6 
	~<lšux/sÿ‰”li¡.h
>

8 #ià!
defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

9 
	$shªnÚ_dma_£t_mask
(
shªnÚ_pci_dev_t
 *
pdev
, 
u64
 
mask
)

11  
	`dma_£t_mask
(&((
pci_dev
 *)
pdev
)->
dev
, 
mask
);

12 
	}
}

14 
	$shªnÚ_dma_£t_coh”’t_mask
(
shªnÚ_pci_dev_t
 *
pdev
, 
u64
 
mask
)

16 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 34)

18 ià(!
	`dma_suµÜ‹d
(&((
pci_dev
 *)
pdev
)->
dev
, 
mask
))

19  -
EIO
;

20 ((
pci_dev
 *)
pdev
)->
dev
.
coh”’t_dma_mask
 = 
mask
;

25  
	`dma_£t_coh”’t_mask
(&((
pci_dev
 *)
pdev
)->
dev
,
mask
);

28 
	}
}

30 * 
	$shªnÚ_dma_®loc_coh”’t
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_size_t
 
size
, 
shªnÚ_dma_addr_t
 *
dma_hªdË
, 
shªnÚ_gå_t
 
gå
)

32  
	`dma_®loc_coh”’t
(&((
pci_dev
 *)
pdev
)->
dev
, 
size
, 
dma_hªdË
, 
gå
);

33 
	}
}

35 
	$shªnÚ_dma_ä“_coh”’t
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_size_t
 
size
, *
vaddr
, 
shªnÚ_dma_addr_t
 
bus
)

37 
	`dma_ä“_coh”’t
(&((
pci_dev
 *)
pdev
)->
dev
, 
size
, 
vaddr
, 
bus
);

38 
	}
}

41 
	$shªnÚ_dma_m­pšg_”rÜ
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
dma_addr
)

43 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 27)

45  
	`dma_m­pšg_”rÜ
(&((
pci_dev
 *)
pdev
)->
dev
, 
dma_addr
);

49  
	`dma_m­pšg_”rÜ
(
dma_addr
);

52 
	}
}

55 
shªnÚ_dma_addr_t
 
	$shªnÚ_dma_m­_Úe_sg_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
dœ
)

57 
shªnÚ_dma_addr_t
 
dma_hªdË
;

61 
dma_hªdË
 = 
	`dma_m­_·ge
(&((
pci_dev
 *)
pdev
)->
dev
, 
	`shªnÚ_sg_·ge
(
sg
), \

62 
	`shªnÚ_sg_off£t
(
sg
), 
	`shªnÚ_sg_Ëngth
(sg), \

63 
dœ
 =ğ
SHANNON_DMA_FROMDEVICE
 ? 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

64 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
pdev
, 
dma_hªdË
)) {

65 
	`shªnÚ_”r
("dma_map_pageƒrror!");

66 
	`ud–ay
(1);

68 
	`shªnÚ_sg_£t_dma_add»ss
(
sg
, 
dma_hªdË
);

73  
dma_hªdË
;

74 
	}
}

76 
	$shªnÚ_dma_unm­_Úe_sg_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
dœ
)

78 
	`dma_unm­_·ge
(&((
pci_dev
 *)
pdev
)->
dev
, 
	`shªnÚ_sg_dma_add»ss
(
sg
), 
	`shªnÚ_sg_Ëngth
(sg),

79 
dœ
 =ğ
SHANNON_DMA_FROMDEVICE
 ? 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

80 
	}
}

82 
	$shªnÚ_dma_unm­_sg
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
, 
dœ
)

84 
	`dma_unm­_sg
(&((
pci_dev
 *)
pdev
)->
dev
, (
sÿ‰”li¡
 *)
sgl
, 
ÃÁs
, 
dœ
);

85 
	}
}

88 
	$shªnÚ_dma_m­_sg
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
, 
dœ
)

90  
	`dma_m­_sg
(&((
pci_dev
 *)
pdev
)->
dev
, (
sÿ‰”li¡
 *)
sgl
, 
ÃÁs
, 
dœ
);

91 
	}
}

93 
shªnÚ_dma_addr_t
 
	$shªnÚ_dma_m­_sšgË
(
shªnÚ_pci_dev_t
 *
pdev
, *
±r
, 
shªnÚ_size_t
 
size
, 
dœ
)

95  
	`dma_m­_sšgË
(&((
pci_dev
 *)
pdev
)->
dev
, 
±r
, 
size
, \

96 
dœ
 =ğ
SHANNON_DMA_FROMDEVICE
 ? 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

97 
	}
}

99 
	$shªnÚ_dma_unm­_sšgË
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
addr
, 
shªnÚ_size_t
 
size
, 
dœ
)

101 
	`dma_unm­_sšgË
(&((
pci_dev
 *)
pdev
)->
dev
, 
addr
, 
size
, \

102 
dœ
 =ğ
SHANNON_DMA_FROMDEVICE
 ? 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

103 
	}
}

105 
shªnÚ_dma_addr_t
 
	$shªnÚ_dma_m­_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, *
±r
, 
shªnÚ_size_t
 
off£t
, shªnÚ_size_ˆ
size
, 
dœ
)

107  
	`dma_m­_·ge
(&((
pci_dev
 *)
pdev
)->
dev
, (
·ge
 *)
±r
, 
off£t
, 
size
, \

108 
dœ
 =ğ
SHANNON_DMA_FROMDEVICE
 ? 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

109 
	}
}

111 
	$shªnÚ_dma_unm­_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
addr
, 
shªnÚ_size_t
 
size
, 
dœ
)

113 
	`dma_unm­_·ge
(&((
pci_dev
 *)
pdev
)->
dev
, 
addr
, 
size
, \

114 
dœ
 =ğ
SHANNON_DMA_FROMDEVICE
 ? 
DMA_FROM_DEVICE
 : 
DMA_TO_DEVICE
);

115 
	}
}

	@shannon_dma.h

1 #iâdeà
__SHANNON_DMA_H


2 
	#__SHANNON_DMA_H


	)

4 
	~"shªnÚ_kcÜe.h
"

5 
	~"shªnÚ_sÿ‰”.h
"

7 
	#SHANNON_DMA_TODEVICE
 1

	)

8 
	#SHANNON_DMA_FROMDEVICE
 2

	)

10 
	#SHANNON_DMA_BIT_MASK
(
n
è((Òè=ğ64è? ~0ULL : ((1ULL<<Ò))-1))

	)

12 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

14 
	~<lšux/pci.h
>

15 
	~<lšux/v”siÚ.h
>

16 
	~<lšux/dma-m­pšg.h
>

18 
šlše
 
shªnÚ_dma_addr_t
 
	$shªnÚ_dma_m­_Úe_sg_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sgl
, 
dœ
)

20  (
shªnÚ_dma_addr_t
)
	`shªnÚ_sg_vœt
(
sgl
);

21 
	}
}

23 
šlše
 
	$shªnÚ_dma_unm­_Úe_sg_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sgl
, 
dœ
)

26 
	}
}

28 
šlše
 
	$shªnÚ_dma_m­_sg
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
, 
dœ
)

30 
i
;

32 
i
 = 0; i < 
ÃÁs
; i++) {

33 
	`shªnÚ_sg_dma_add»ss
(
sgl
èğ(
shªnÚ_dma_addr_t
)
	`shªnÚ_sg_vœt
(sgl);

34 
sgl
 = 
	`shªnÚ_sg_Ãxt
(sgl);

36  
ÃÁs
;

37 
	}
}

39 
šlše
 
	$shªnÚ_dma_unm­_sg
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
ÃÁs
, 
dœ
)

42 
	}
}

44 
šlše
 
shªnÚ_dma_addr_t
 
	$shªnÚ_dma_m­_sšgË
(
shªnÚ_pci_dev_t
 *
pdev
, *
±r
, 
shªnÚ_size_t
 
size
, 
dœ
)

46  (
shªnÚ_dma_addr_t
)
±r
;

47 
	}
}

49 
šlše
 
	$shªnÚ_dma_unm­_sšgË
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
addr
, 
shªnÚ_size_t
 
size
, 
dœ
)

52 
	}
}

54 
šlše
 
	$shªnÚ_dma_m­pšg_”rÜ
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
dma_addr
)

57 
	}
}

59 
šlše
 
	$shªnÚ_dma_£t_mask
(
shªnÚ_pci_dev_t
 *
pdev
, 
u64
 
mask
)

61  
	`dma_£t_mask
(&((
pci_dev
 *)
pdev
)->
dev
, 
mask
);

62 
	}
}

64 
šlše
 
	$shªnÚ_dma_£t_coh”’t_mask
(
shªnÚ_pci_dev_t
 *
pdev
, 
u64
 
mask
)

66 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 34)

68 ià(!
	`dma_suµÜ‹d
(&((
pci_dev
 *)
pdev
)->
dev
, 
mask
))

69  -
EIO
;

70 ((
pci_dev
 *)
pdev
)->
dev
.
coh”’t_dma_mask
 = 
mask
;

75  
	`dma_£t_coh”’t_mask
(&((
pci_dev
 *)
pdev
)->
dev
,
mask
);

78 
	}
}

80 
šlše
 * 
	$shªnÚ_dma_®loc_coh”’t
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_size_t
 
size
, 
shªnÚ_dma_addr_t
 *
dma_hªdË
, 
shªnÚ_gå_t
 
gå
)

82  
	`dma_®loc_coh”’t
(&((
pci_dev
 *)
pdev
)->
dev
, 
size
, 
dma_hªdË
, 
gå
);

83 
	}
}

85 
šlše
 
	$shªnÚ_dma_ä“_coh”’t
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_size_t
 
size
, *
vaddr
, 
shªnÚ_dma_addr_t
 
bus
)

87 
	`dma_ä“_coh”’t
(&((
pci_dev
 *)
pdev
)->
dev
, 
size
, 
vaddr
, 
bus
);

88 
	}
}

92 
shªnÚ_dma_addr_t
 
shªnÚ_dma_m­_Úe_sg_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
dœ
);

93 
shªnÚ_dma_unm­_Úe_sg_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
dœ
);

94 
shªnÚ_dma_m­_sg
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
ÃÁs
, 
dœ
);

95 
shªnÚ_dma_unm­_sg
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_sg_li¡_t
 *
sg
, 
ÃÁs
, 
dœ
);

96 
shªnÚ_dma_addr_t
 
shªnÚ_dma_m­_sšgË
(
shªnÚ_pci_dev_t
 *
pdev
, *
±r
, 
shªnÚ_size_t
 
size
, 
dœ
);

97 
shªnÚ_dma_unm­_sšgË
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
addr
, 
shªnÚ_size_t
 
size
, 
dœ
);

98 
shªnÚ_dma_m­pšg_”rÜ
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
dma_addr
);

100 
shªnÚ_dma_£t_mask
(
shªnÚ_pci_dev_t
 *
pdev
, 
u64
 
mask
);

101 
shªnÚ_dma_£t_coh”’t_mask
(
shªnÚ_pci_dev_t
 *
pdev
, 
u64
 
mask
);

102 * 
shªnÚ_dma_®loc_coh”’t
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_size_t
 
size
, 
shªnÚ_dma_addr_t
 *
dma_hªdË
, 
gå_t
 
gå
);

103 
shªnÚ_dma_ä“_coh”’t
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_size_t
 
size
, *
vaddr
, 
shªnÚ_dma_addr_t
 
bus
);

104 
shªnÚ_dma_addr_t
 
shªnÚ_dma_m­_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, *
±r
, 
shªnÚ_size_t
 
off£t
, shªnÚ_size_ˆ
size
, 
dœ
);

105 
shªnÚ_dma_unm­_·ge
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dma_addr_t
 
addr
, 
shªnÚ_size_t
 
size
, 
dœ
);

	@shannon_dna.c

2 
__u64
 
	gçùÜ
[16] = {

21 
	#RANDOM_COUNT
 4

	)

22 
__u64
 
	$codšg
(
__u64
 
Üig
)

24 
__u64
 
v®ue
;

25 
i
, 
šdex
, 
sum
;

26 
¿ndom
[
RANDOM_COUNT
] = {

33 
i
 = 0;

34 
v®ue
 = 0;

35 
sum
 = 0;

37 
šdex
 = 
Üig
 & 0xf;

38 
sum
 +ğ
šdex
;

39 
v®ue
 +ğ
çùÜ
[
šdex
] + faùÜ[
i
];

40 
v®ue
 = v®u* (
sum
 + 
i
);

41 
v®ue
 +ğ
¿ndom
[
šdex
 % 
RANDOM_COUNT
];

42 
v®ue
 +ğ
çùÜ
[
sum
 % 16];

43 
Üig
 >>= 4;

44 
i
++;

45 } 
i
 < 16);

47  
v®ue
;

48 
	}
}

50 
	#SF1
(
x
, 
y
, 
z
è(z ^ (x & (y ^ z)))

	)

51 
	#SF2
(
x
, 
y
, 
z
è
	`SF1
(z, x, y)

	)

52 
	#SF3
(
x
, 
y
, 
z
è(x ^ y ^ z)

	)

53 
	#SF4
(
x
, 
y
, 
z
è(y ^ (x | ~z))

	)

55 
	#SHANNON_STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
š
, 
s
) \

56 (
w
 +ğ
	`f
(
x
, 
y
, 
z
è+ 
š
, w = (w<<
s
 | w>>(16-s)è+ x)

	)

58 
	$shªnÚ_ŒªsfÜm
(
__u16
 *
hash
, __u16 cÚ¡ *
š
)

60 
__u16
 
a
, 
b
, 
c
, 
d
;

62 
a
 = 
hash
[0];

63 
b
 = 
hash
[1];

64 
c
 = 
hash
[2];

65 
d
 = 
hash
[3];

67 
	`SHANNON_STEP
(
SF1
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xd76a, 7);

68 
	`SHANNON_STEP
(
SF1
, 
d
, 
a
, 
b
, 
c
, 
š
[1] + 0xe8c7, 12);

69 
	`SHANNON_STEP
(
SF1
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x2420, 9);

70 
	`SHANNON_STEP
(
SF1
, 
b
, 
c
, 
d
, 
a
, 
š
[3] + 0xc1bd, 2);

72 
	`SHANNON_STEP
(
SF2
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xf61e, 5);

73 
	`SHANNON_STEP
(
SF2
, 
b
, 
c
, 
d
, 
a
, 
š
[0] + 0xe9b6, 10);

74 
	`SHANNON_STEP
(
SF2
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xf4d5, 14);

75 
	`SHANNON_STEP
(
SF2
, 
d
, 
a
, 
b
, 
c
, 
š
[2] + 0xfcef, 9);

77 
	`SHANNON_STEP
(
SF3
, 
b
, 
c
, 
d
, 
a
, 
š
[2] + 0xc4ac, 13);

78 
	`SHANNON_STEP
(
SF3
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xa4be, 4);

79 
	`SHANNON_STEP
(
SF3
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xd4ef, 6);

80 
	`SHANNON_STEP
(
SF3
, 
d
, 
a
, 
b
, 
c
, 
š
[0] + 0xe3a1, 11);

82 
	`SHANNON_STEP
(
SF4
, 
d
, 
a
, 
b
, 
c
, 
š
[3] + 0x8f0c, 10);

83 
	`SHANNON_STEP
(
SF4
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x2ad7, 7);

84 
	`SHANNON_STEP
(
SF4
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xf429, 6);

85 
	`SHANNON_STEP
(
SF4
, 
b
, 
c
, 
d
, 
a
, 
š
[1] + 0x8584, 8);

87 
hash
[0] +ğ
a
;

88 
hash
[1] +ğ
b
;

89 
hash
[2] +ğ
c
;

90 
hash
[3] +ğ
d
;

91 
	}
}

93 
__u64
 
	$shªnÚ_’code
(
__u64
 
Üig
)

96 
__u64
 
v®ue
;

97 
__u16
 
¬¿y
[4];

98 } 
hash
, 
£ü‘
;

101 
hash
.
v®ue
 = 
	`codšg
(
Üig
);

102 
£ü‘
.
v®ue
 = 
Üig
;

103 
	`shªnÚ_ŒªsfÜm
(
hash
.
¬¿y
, 
£ü‘
.array);

104  
hash
.
v®ue
;

105 
	}
}

	@shannon_emu.c

1 
	~<lšux/k”Ãl.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/moduË·¿m.h
>

4 
	~<lšux/mm.h
>

5 
	~<lšux/fs.h
>

6 
	~<lšux/¦ab.h
>

7 
	~<lšux/cdev.h
>

8 
	~<lšux/ty³s.h
>

9 
	~<lšux/v”siÚ.h
>

10 
	~<asm/uacûss.h
>

11 
	~<lšux/d–ay.h
>

12 
	~<asm/b™İs.h
>

14 
	~"shªnÚ_emu.h
"

17 
	gemu_lun_amouÁ
 = 16;

18 
	gemu_eblocks_š_lun
 = 512;

19 
	gemu_·ges_š_eblock
 = 8;

20 
	gemu_Çnd_·ge_shiá
 = 13;

21 
	gemu_oob_size
 = 448;

22 
	gemu_¶ªe_Üd”
 = 1;

23 
	gemu_logicb_shiá
 = 12;

24 
	gemu_ecc_codewÜds_š_logicb
 = 8;

27 
	gemu_chªÃls
 = 16;

28 
	gemu_lun£t_š_chªÃl
 = 1;

29 
	gemu_lun_š_lun£t
 = 1;

30 
	gemu_¿id_¡res
 = 2;

32 
EXPORT_SYMBOL
(
emu_lun_amouÁ
);

33 
EXPORT_SYMBOL
(
emu_eblocks_š_lun
);

34 
EXPORT_SYMBOL
(
emu_·ges_š_eblock
);

35 
EXPORT_SYMBOL
(
emu_Çnd_·ge_shiá
);

36 
EXPORT_SYMBOL
(
emu_oob_size
);

37 
EXPORT_SYMBOL
(
emu_¶ªe_Üd”
);

38 
EXPORT_SYMBOL
(
emu_logicb_shiá
);

39 
EXPORT_SYMBOL
(
emu_chªÃls
);

41 
shªnÚ_emu_lun
 *
	gemu_luns
;

42 
EXPORT_SYMBOL
(
emu_luns
);

44 
	#WRITE_ERR
 0x01;

	)

45 
	g¿ndom_rd_¿‹
 = 0;

46 
	g³rmª’t_rd_”r_¿‹
 = 0;

47 
	g¿ndom_wr_¿‹
 = 0;

49 
u8
 
	$emu_´e_»ad
(
shªnÚ_emu_lun
 *
lun
, 
logicb_t
 
µa
)

52 
	}
}

55 
u8
 
	$emu_ÿche_»ad
(
shªnÚ_emu_lun
 *
lun
, 
logicb_t
 
lun_pba
, 
shªnÚ_»que¡
 *
»q
)

57 
¿nd
;

58 *
µa_buf
;

59 
logicb_t
 
·ge
 = 
»q
->
pba
.
lun_pba
/
lun
->
logicbs_š_·ge
;

60 
eblk
 = 
·ge
/
emu_·ges_š_eblock
;

61 
fœ¡_size
, 
Ï¡_size
;

63 ià(
lun
->
bbt
[
eblk
/32] & (1<<(eblk%32))) {

64 
»q
->
emu_m‘ad©a
 = 
INVALID_LBA
;

68 ià((
lun
->
wr_æags
[
·ge
/32] & (1<<(page%32))) == 0) {

69 
»q
->
emu_m‘ad©a
 = 
INVALID_LBA
;

70  
SH_FRESH_ERASED
;

73 ià(
¿ndom_rd_¿‹
) {

74 
¿nd
 = 
	`´ªdom32
(&
lun
->
»ad_¿nd_¡©e
);

75 ià((
¿nd
%
¿ndom_rd_¿‹
) == 0)

79 ià(
³rmª’t_rd_”r_¿‹
) {

80 
¿nd
 = 
	`´ªdom32
(&
lun
->
»ad_¿nd_¡©e
);

81 ià((
¿nd
 % 
³rmª’t_rd_”r_¿‹
) == 0) {

82 
	`shªnÚ_šfo
("%s(): s‘ƒblk %dØbad block.\n", 
__func__
, 
eblk
);

83 
lun
->
bbt
[
eblk
/32] |= 1 << (eblk%32);

88 
µa_buf
 = 
lun
->
emu_bufãr
 + 
·ge
 * (1 << 
emu_Çnd_·ge_shiá
);

91 ià(
»q
->
dma_add»ss_2
) {

92 
Ï¡_size
 = ()
»q
->
vœt_addr
 & (
lun
->
logicb_size
 - 1);

93 
fœ¡_size
 = 
lun
->
logicb_size
 - 
Ï¡_size
;

94 
	`BUG_ON
(
Ï¡_size
 == 0);

95 
	`BUG_ON
(
fœ¡_size
 == 0);

96 
	`memıy
(
»q
->
vœt_addr
, 
µa_buf
 + (»q->
pba
.
lun_pba
 % 
lun
->
logicbs_š_·ge
è*†un->
logicb_size
, 
fœ¡_size
);

97 
	`memıy
(
»q
->
vœt_addr_2
, 
µa_buf
 + (»q->
pba
.
lun_pba
 % 
lun
->
logicbs_š_·ge
è*†un->
logicb_size
 + 
fœ¡_size
, 
Ï¡_size
);

99 
	`memıy
(
»q
->
vœt_addr
, 
µa_buf
 + (»q->
pba
.
lun_pba
 % 
lun
->
logicbs_š_·ge
è*†un->
logicb_size
,†un->logicb_size);

100 
»q
->
emu_m‘ad©a
 = 
lun
->
m‘a_bufãr
[»q->
pba
.
lun_pba
];

101 
	`BUG_ON
(!
	`lba_is_šv®id
(
»q
->
lba
è&& ((
logicb_t
ìeq->
emu_m‘ad©a
 !=„eq->lba));

104 
	}
}

106 
u8
 
	$emu_wr™e
(
shªnÚ_emu_lun
 *
lun
, 
logicb_t
 
µa
, 
shªnÚ_li¡_h—d
 *
»q_li¡
)

108 
¿nd
;

109 
shªnÚ_»que¡
 *
»q
;

110 
i
, 
eblk
;

111 *
µa_buf
;

112 
fœ¡_size
, 
Ï¡_size
;

114 ià(
lun
->
wr_æags
[
µa
/32] & (1<<(ppa%32))) {

115 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, 
»q_li¡
, 
li¡
) {

116 
	`shªnÚ_šfo
("%s():†ba=%ld,†un=%d,†un_pba=%d,ag=0x%lx.\n",

117 
__func__
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
g
);

119 
	`shªnÚ_šfo
("%s(): wr_æags[%d] = 0x%x.\n", 
__func__
, 
µa
/32, 
lun
->
wr_æags
[ppa/32]);

120 
	`shªnÚ_šfo
("%s(): ov”wr™·g%d!\n", 
__func__
, 
µa
);

121 
	`asm
(" int $3");

125 
eblk
 = 
µa
/
emu_·ges_š_eblock
;

126 ià(
lun
->
bbt
[
eblk
/32] & (1<<(eblk%32))) {

127  
WRITE_ERR
;

130 ià(
¿ndom_wr_¿‹
) {

131 
¿nd
 = 
	`´ªdom32
(&
lun
->
wr™e_¿nd_¡©e
);

132 ià(
¿nd
%
¿ndom_wr_¿‹
 == 0) {

133 
	`shªnÚ_šfo
("%s(): s‘ƒblk %dØbad block.\n", 
__func__
, 
eblk
);

134 
lun
->
bbt
[
eblk
/32] |= 1 << (eblk%32);

135  
WRITE_ERR
;

139 
µa_buf
 = 
lun
->
emu_bufãr
 + 
µa
 * (1 << 
emu_Çnd_·ge_shiá
);

140 
i
 = 0;

141 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, 
»q_li¡
, 
li¡
) {

142 ià(!
»q
 || !»q->
vœt_addr
) {

143 
	`shªnÚ_w¬nšg
("req is NULL!!! ---------------------\n");

144 
	`BUG
();

146 ià(
»q
->
pba
.
lun_pba
 !ğ(
µa
 * 
lun
->
logicbs_š_·ge
 + 
i
)) {

147 
	`shªnÚ_šfo
("%s():…·=%d,†un_pba=%d, i=%d.\n", 
__func__
, 
µa
, 
»q
->
pba
.
lun_pba
, 
i
);

148 
	`shªnÚ_šfo
("%s(): WrÚg†un_pba!\n", 
__func__
);

149 
	`asm
(" int $3");

152 
¿nd
 = 
	`´ªdom32
(&
lun
->
wr™e_¿nd_¡©e
);

153 
	`ud–ay
(
¿nd
 % 20);

154 ià(
»q
->
dma_add»ss_2
) {

155 
Ï¡_size
 = ()
»q
->
vœt_addr
 & (
lun
->
logicb_size
 - 1);

156 
fœ¡_size
 = 
lun
->
logicb_size
 - 
Ï¡_size
;

157 
	`BUG_ON
(
Ï¡_size
 == 0);

158 
	`BUG_ON
(
fœ¡_size
 == 0);

159 
	`memıy
(
µa_buf
 + (
»q
->
pba
.
lun_pba
 % 
lun
->
logicbs_š_·ge
è*†un->
logicb_size
,„eq->
vœt_addr
, 
fœ¡_size
);

160 
	`memıy
(
µa_buf
 + (
»q
->
pba
.
lun_pba
 % 
lun
->
logicbs_š_·ge
è*†un->
logicb_size
 + 
fœ¡_size
,„eq->
vœt_addr_2
, 
Ï¡_size
);

162 
	`memıy
(
µa_buf
 + (
»q
->
pba
.
lun_pba
 % 
lun
->
logicbs_š_·ge
è*†un->
logicb_size
,„eq->
vœt_addr
,†un->logicb_size);

163 
lun
->
m‘a_bufãr
[
»q
->
pba
.
lun_pba
] =„eq->
emu_m‘ad©a
;

164 
	`BUG_ON
(
»q
->
emu_m‘ad©a
 !ğ»q->
lba
);

165 
i
++;

167 
	`£t_b™
(
µa
 % 32, 
lun
->
wr_æags
 +…pa/32);

170 
	}
}

172 
u8
 
	$bufq_emu_wr™e
(
shªnÚ_emu_lun
 *
lun
, 
logicb_t
 
µa
, *
¤c
, *
m‘ad©a
)

174 *
µa_buf
;

175 
¿nd
;

176 
eblk
;

178 ià(
lun
->
wr_æags
[
µa
/32] & (1<<(ppa%32))) {

179 
	`shªnÚ_šfo
("%s(): wr_æags[%d] = 0x%x.\n", 
__func__
, 
µa
/32, 
lun
->
wr_æags
[ppa/32]);

180 
	`shªnÚ_šfo
("%s(): ov”wr™·g%d!\n", 
__func__
, 
µa
);

181 
	`asm
(" int $3");

185 
eblk
 = 
µa
/
emu_·ges_š_eblock
;

186 ià(
lun
->
bbt
[
eblk
/32] & (1<<(eblk%32))) {

187  
WRITE_ERR
;

190 ià(
¿ndom_wr_¿‹
) {

191 
¿nd
 = 
	`´ªdom32
(&
lun
->
wr™e_¿nd_¡©e
);

192 ià((
¿nd
 % 
¿ndom_wr_¿‹
) == 0) {

193 
	`shªnÚ_šfo
("%s(): s‘ƒblk %dØbad block.\n", 
__func__
, 
eblk
);

194 
lun
->
bbt
[
eblk
/32] |= 1 << (eblk%32);

195  
WRITE_ERR
;

199 
µa_buf
 = 
lun
->
emu_bufãr
 + 
µa
 * (1 << 
emu_Çnd_·ge_shiá
);

200 
	`memıy
(
µa_buf
, 
¤c
, 
lun
->
logicb_size
 *†un->
logicbs_š_·ge
);

201 
	`memıy
(
lun
->
m‘a_bufãr
 + 
µa
 *†un->
logicbs_š_·ge
, 
m‘ad©a
,†un->logicbs_š_·g* (
u64
));

203 
	`£t_b™
(
µa
 % 32, 
lun
->
wr_æags
 +…pa/32);

206 
	}
}

208 
u8
 
	$emu_”a£
(
shªnÚ_emu_lun
 *
lun
, 
eblk
)

210 
eblk_æags_Ën
 = 
emu_·ges_š_eblock
/8;

211 
eblk_size
 = (1 << 
emu_Çnd_·ge_shiá
è* 
emu_·ges_š_eblock
;

213 ià(
lun
->
bbt
[
eblk
/32] & (1<<(eblk%32))) {

217 
	`mem£t
(
lun
->
emu_bufãr
 + 
eblk
 * 
eblk_size
, 0,ƒblk_size);

218 
	`mem£t
((*)
lun
->
wr_æags
 + 
eblk_æags_Ën
*
eblk
, 0,ƒblk_flags_len);

220 
	}
}

222 
u16
 
	g¡©ic_bbt
[][50] = {

242 
u16
 
	gdyÇmic_bbt
[][30] = {

261 
emu_buf_cdev_š™
();

262 
emu_buf_cdev_»Ëa£
();

263 
m‘ad©a_cdev_š™
();

264 
m‘ad©a_cdev_»Ëa£
();

265 
lun_bbt_cdev_š™
();

266 
lun_bbt_cdev_»Ëa£
();

268 
	$shªnÚ_emu_š™
()

270 
i
, 
j
, 
eblk
, 
emu_lun_size
, 
m‘a_buf_Ën
, 
wr_æags_Ën
, 
bbt_Ën
, 
»t
 = 0;

271 
emu_Çnd_·ge_size
 = 1<<
emu_Çnd_·ge_shiá
;

272 
shªnÚ_mbr
 
mbr
;

274 
	`mem£t
(&
mbr
, 0, (mbr));

275 
mbr
.
lun_amouÁ
 = 
emu_lun_amouÁ
;

276 
mbr
.
eblocks_š_lun
 = 
emu_eblocks_š_lun
;

277 
mbr
.
·ges_š_eblock
 = 
emu_·ges_š_eblock
;

278 
mbr
.
Çnd_·ge_shiá
 = 
emu_Çnd_·ge_shiá
;

279 
mbr
.
oob_size
 = 
emu_oob_size
;

280 
mbr
.
logicb_shiá
 = 
emu_logicb_shiá
;

281 
mbr
.
u£r_logicb_shiá
 = 9;

282 
mbr
.
¶ªe_Üd”
 = 
emu_¶ªe_Üd”
;

283 
mbr
.
cfg_chªÃls
 = 
emu_chªÃls
;

284 
mbr
.
cfg_lun£t_š_chªÃl
 = 
emu_lun£t_š_chªÃl
;

285 
mbr
.
cfg_lun_š_lun£t
 = 
emu_lun_š_lun£t
;

289 
mbr
.
š‹¼u±_d–ay
 = 1;

290 
mbr
.
ÿ·c™y
 = ((
emu_lun_amouÁ
 * 
emu_eblocks_š_lun
 * 
emu_·ges_š_eblock
 * 50è<< (
emu_Çnd_·ge_shiá
 - 9)) / 100;

291 
mbr
.
ÿ·c™y
 = mbr.capacity & ~0x3ff;

292 
mbr
.
ecc_codewÜds_š_logicb
 = 
emu_ecc_codewÜds_š_logicb
;

293 
mbr
.
ecc_cÜ»ùiÚ_pow”
 = 16;

294 
mbr
.
š™_hÙ_sblk
 = 2;

295 
mbr
.
š™_cŞd_sblk
 = 3;

296 
mbr
.
hi¡Üy_”a£_couÁ
 = 0;

297 
mbr
.
¿id_¡res
 = 
emu_¿id_¡res
;

299 
emu_lun_size
 = 
	`PAGE_ALIGN
(
emu_eblocks_š_lun
 * 
emu_·ges_š_eblock
 * (
emu_Çnd_·ge_size
 + 
emu_oob_size
));

300 
m‘a_buf_Ën
 = 
	`PAGE_ALIGN
(8 * 
MAX_LOGICBS_IN_PAGE
 * 
emu_·ges_š_eblock
 * 
emu_eblocks_š_lun
);

301 
wr_æags_Ën
 = (
emu_·ges_š_eblock
 * 
emu_eblocks_š_lun
 + 8)/8;

302 
bbt_Ën
 = (
emu_eblocks_š_lun
 + 8)/8;

304 
emu_luns
 = 
	`km®loc
((*emu_lunsè* 
emu_lun_amouÁ
, 
GFP_SHANNON
);

305 
	`shªnÚ_šfo
("%s():ƒmu_luns=0x%lx.\n", 
__func__
, ()
emu_luns
);

306 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

307 
	`shªnÚ_šfo
("%s(): &emu_lun[%d]=0x%lx.\n", 
__func__
, 
i
, ()&
emu_luns
[i]);

308 
	`´ªdom32_£ed
(&
emu_luns
[
i
].
»ad_¿nd_¡©e
, 100 + 2 * i);

309 
	`´ªdom32_£ed
(&
emu_luns
[
i
].
wr™e_¿nd_¡©e
, 101 + 2 * i);

310 
emu_luns
[
i
].
lun_num
 = i;

311 
emu_luns
[
i
].
max_chªÃls
 = 
emu_chªÃls
;

312 
emu_luns
[
i
].
max_lun£t_š_chªÃl
 = 
emu_lun£t_š_chªÃl
;

313 
emu_luns
[
i
].
hw_lun_š_lun£t
 = 
emu_lun_š_lun£t
;

314 
emu_luns
[
i
].
logicb_size
 = 1 << 
MBR_LOGICB_SHIFT
;

315 
emu_luns
[
i
].
logicbs_š_·ge
 = 1;

316 
emu_luns
[
i
].
´e_»ad
 = 
emu_´e_»ad
;

317 
emu_luns
[
i
].
ÿche_»ad
 = 
emu_ÿche_»ad
;

318 
emu_luns
[
i
].
wr™e
 = 
emu_wr™e
;

319 
emu_luns
[
i
].
bufq_wr™e
 = 
bufq_emu_wr™e
;

320 
emu_luns
[
i
].
”a£
 = 
emu_”a£
;

321 
emu_luns
[
i
].
emu_bufãr
 = 
	`vm®loc
(
emu_lun_size
);

322 ià(
emu_luns
[
i
].
emu_bufãr
 =ğ
NULL
) {

323 
	`shªnÚ_”r
("cannot‡llocateƒnough memory forƒmu_buffer.\n");

324 
»t
 = -
ENOMEM
;

326 
	`mem£t
(
emu_luns
[
i
].
emu_bufãr
, 0, 
emu_lun_size
);

327 
emu_luns
[
i
].
m‘a_bufãr
 = 
	`vm®loc
(
m‘a_buf_Ën
);

328 
	`mem£t
((*)
emu_luns
[
i
].
m‘a_bufãr
, 0x“, 
m‘a_buf_Ën
);

330 
emu_luns
[
i
].
wr_æags
 = (
u32
 *)
	`kz®loc
(
wr_æags_Ën
, 
GFP_SHANNON
);

331 
emu_luns
[
i
].
bbt
 = (
u32
 *)
	`kz®loc
(
bbt_Ën
, 
GFP_SHANNON
);

334 
emu_luns
[
i
].
wr_æags
[0/32] |= 1<<(0%32);

335 
	`memıy
(
emu_luns
[
i
].
emu_bufãr
, &
mbr
, (
shªnÚ_mbr
));

336 
emu_luns
[
i
].
m‘a_bufãr
[0] = 
MBR_WATERMARK
;

339 
emu_luns
[
i
].
wr_æags
[1/32] |= 1<<(1%32);

342 
j
 = 0;

343 
eblk
 = 
¡©ic_bbt
[
i
][
j
];

344 
eblk
 != 0xFFFF) {

346 *((
u16
 *)(
emu_luns
[
i
].
emu_bufãr
 + 
emu_Çnd_·ge_size
è+ 
j
èğ
eblk
;

348 
emu_luns
[
i
].
bbt
[
eblk
/32] |= 1 << (eblk%32);

349 
j
++;

350 
eblk
 = 
¡©ic_bbt
[
i
][
j
];

352 *((
u16
 *)(
emu_luns
[
i
].
emu_bufãr
 + 
emu_Çnd_·ge_size
è+ 
j
) = 0xFFFF;

355 
j
 = 0;

356 
eblk
 = 
dyÇmic_bbt
[
i
][
j
];

357 
eblk
 != 0xFFFF) {

359 *(
u16
 *)(
emu_luns
[
i
].
emu_bufãr
 + (2 + 
j
è* 
emu_Çnd_·ge_size
èğ
eblk
;

361 
emu_luns
[
i
].
bbt
[
eblk
/32] |= 1 << (eblk%32);

363 
emu_luns
[
i
].
wr_æags
[(2 + 
j
)/32] |= 1<<((2 + j)%32);

364 
j
++;

365 
eblk
 = 
dyÇmic_bbt
[
i
][
j
];

369 
	`emu_buf_cdev_š™
(
emu_lun_size
);

370 
	`m‘ad©a_cdev_š™
(
m‘a_buf_Ën
);

371 
	`lun_bbt_cdev_š™
(
bbt_Ën
);

373  
»t
;

374 
	}
}

376 
	$shªnÚ_emu_ex™
()

378 
i
;

380 
i
 = 0; i < 
emu_lun_amouÁ
; i++)

381 
	`vä“
(
emu_luns
[
i
].
emu_bufãr
);

382 
	`kä“
(
emu_luns
);

384 
	`emu_buf_cdev_»Ëa£
();

385 
	`m‘ad©a_cdev_»Ëa£
();

386 
	`lun_bbt_cdev_»Ëa£
();

387 
	}
}

389 
moduË_š™
(
shªnÚ_emu_š™
);

390 
moduË_ex™
(
shªnÚ_emu_ex™
);

392 
dev_t
 
	gemu_buf_dev_num
;

393 
	gemu_buf_majÜ
;

394 
şass
 *
	gemu_buf_şass
;

395 
debug_cdev
 *
	gemu_buf_cdevs
;

397 
	$emu_buf_cdev_š™
(
emu_lun_size
)

399 
i
;

400 
dev_t
 
devno
;

402 ià(
	`®loc_chrdev_»giÚ
(&
emu_buf_dev_num
, 0, 
emu_lun_amouÁ
, "emu_buf") < 0) {

403 
	`shªnÚ_”r
("Can't„egister deviceƒmu_buf.\n");

406 
emu_buf_majÜ
 = 
	`MAJOR
(
emu_buf_dev_num
);

407 
emu_buf_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "emu_buf");

408 
emu_buf_cdevs
 = 
	`km®loc
((*emu_buf_cdevsè* 
emu_lun_amouÁ
, 
GFP_SHANNON
);

409 
i
=0; i<
emu_lun_amouÁ
; i++) {

410 
emu_buf_cdevs
[
i
].
mšÜ
 = i;

411 
emu_buf_cdevs
[
i
].
buf
 = 
emu_luns
[i].
emu_bufãr
;

412 
emu_buf_cdevs
[
i
].
size
 = 
emu_lun_size
;

414 
	`cdev_š™
((
cdev
 *)(&
emu_buf_cdevs
[
i
].cdev), &
debug_cdev_fİs
);

415 ((
cdev
 *)(&
emu_buf_cdevs
[
i
].cdev))->
owÃr
 = 
THIS_MODULE
;

417 
devno
 = 
	`MKDEV
(
emu_buf_majÜ
, 
i
);

418 ià(
	`cdev_add
((
cdev
 *)(&
emu_buf_cdevs
[
i
].cdev), 
devno
, 1)) {

419 
	`shªnÚ_”r
("cdev_add Error.\n");

420 
	`BUG
();

422 
	`deviû_ü—‹
(
emu_buf_şass
, 
NULL
, 
devno
, NULL, "emu_buf%d", 
i
);

425 
	}
}

427 
	$emu_buf_cdev_»Ëa£
()

429 
i
;

430 
dev_t
 
devno
;

432 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

433 
	`cdev_d–
((
cdev
 *)(&
emu_buf_cdevs
[
i
].cdev));

434 
devno
 = 
	`MKDEV
(
emu_buf_majÜ
, 
i
);

435 
	`deviû_de¡roy
(
emu_buf_şass
, 
devno
);

437 
	`uÄegi¡”_chrdev_»giÚ
(
emu_buf_dev_num
, 
emu_lun_amouÁ
);

438 
	`şass_de¡roy
(
emu_buf_şass
);

439 
	`kä“
(
emu_buf_cdevs
);

440 
	}
}

442 
dev_t
 
	gm‘a_dev_num
;

443 
	gm‘a_majÜ
;

444 
şass
 *
	gm‘a_şass
;

445 
debug_cdev
 *
	gm‘a_cdevs
;

447 
	$m‘ad©a_cdev_š™
(
m‘a_buf_Ën
)

449 
i
;

450 
dev_t
 
devno
;

452 ià(
	`®loc_chrdev_»giÚ
(&
m‘a_dev_num
, 0, 
emu_lun_amouÁ
, "meta") < 0) {

453 
	`shªnÚ_”r
("Can't„egister device metadata.\n");

456 
m‘a_majÜ
 = 
	`MAJOR
(
m‘a_dev_num
);

457 
m‘a_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "meta");

458 
m‘a_cdevs
 = 
	`km®loc
((*m‘a_cdevsè* 
emu_lun_amouÁ
, 
GFP_SHANNON
);

459 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

460 
m‘a_cdevs
[
i
].
mšÜ
 = i;

461 
m‘a_cdevs
[
i
].
buf
 = (*)
emu_luns
[i].
m‘a_bufãr
;

462 
m‘a_cdevs
[
i
].
size
 = 
m‘a_buf_Ën
;

464 
	`cdev_š™
(((
cdev
 *)(&
m‘a_cdevs
[
i
].cdev)), &
debug_cdev_fİs
);

465 ((
cdev
 *)(&
m‘a_cdevs
[
i
].cdev))->
owÃr
 = 
THIS_MODULE
;

467 
devno
 = 
	`MKDEV
(
m‘a_majÜ
, 
i
);

468 ià(
	`cdev_add
((
cdev
 *)(&
m‘a_cdevs
[
i
].cdev), 
devno
, 1)) {

469 
	`shªnÚ_”r
("cdev_add Error.\n");

470 
	`BUG
();

472 
	`deviû_ü—‹
(
m‘a_şass
, 
NULL
, 
devno
, NULL, "m‘a%d", 
i
);

475 
	}
}

477 
	$m‘ad©a_cdev_»Ëa£
()

479 
i
;

480 
dev_t
 
devno
;

482 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

483 
	`cdev_d–
((
cdev
 *)(&
m‘a_cdevs
[
i
].cdev));

484 
devno
 = 
	`MKDEV
(
m‘a_majÜ
, 
i
);

485 
	`deviû_de¡roy
(
m‘a_şass
, 
devno
);

487 
	`uÄegi¡”_chrdev_»giÚ
(
m‘a_dev_num
, 
emu_lun_amouÁ
);

488 
	`şass_de¡roy
(
m‘a_şass
);

489 
	`kä“
(
m‘a_cdevs
);

490 
	}
}

492 
dev_t
 
	glun_bbt_dev_num
;

493 
	glun_bbt_majÜ
;

494 
şass
 *
	glun_bbt_şass
;

495 
debug_cdev
 *
	glun_bbt_cdevs
;

497 
	$lun_bbt_cdev_š™
(
lun_bbt_size
)

499 
i
;

500 
dev_t
 
devno
;

502 ià(
	`®loc_chrdev_»giÚ
(&
lun_bbt_dev_num
, 0, 
emu_lun_amouÁ
, "lun_bbt") < 0) {

503 
	`shªnÚ_”r
(
KERN_ERR
 "Can't„egister device†un_bbt.\n");

506 
lun_bbt_majÜ
 = 
	`MAJOR
(
lun_bbt_dev_num
);

507 
lun_bbt_şass
 = 
	`şass_ü—‹
(
THIS_MODULE
, "lun_bbt");

508 
lun_bbt_cdevs
 = 
	`km®loc
((*lun_bbt_cdevsè* 
emu_lun_amouÁ
, 
GFP_SHANNON
);

509 
i
=0; i<
emu_lun_amouÁ
; i++) {

510 
lun_bbt_cdevs
[
i
].
mšÜ
 = i;

511 
lun_bbt_cdevs
[
i
].
buf
 = (*)
emu_luns
[i].
bbt
;

512 
lun_bbt_cdevs
[
i
].
size
 = 
lun_bbt_size
;

514 
	`cdev_š™
((
cdev
 *)(&
lun_bbt_cdevs
[
i
].cdev), &
debug_cdev_fİs
);

515 ((
cdev
 *)(&
lun_bbt_cdevs
[
i
].cdev))->
owÃr
 = 
THIS_MODULE
;

517 
devno
 = 
	`MKDEV
(
lun_bbt_majÜ
, 
i
);

518 ià(
	`cdev_add
((
cdev
 *)(&
lun_bbt_cdevs
[
i
].cdev), 
devno
, 1)) {

519 
	`shªnÚ_”r
("cdev_add Error.\n");

520 
	`BUG
();

522 
	`deviû_ü—‹
(
lun_bbt_şass
, 
NULL
, 
devno
, NULL, "lun_bbt%d", 
i
);

525 
	}
}

527 
	$lun_bbt_cdev_»Ëa£
()

529 
i
;

530 
dev_t
 
devno
;

532 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

533 
	`cdev_d–
((
cdev
 *)(&
lun_bbt_cdevs
[
i
].cdev));

534 
devno
 = 
	`MKDEV
(
lun_bbt_majÜ
, 
i
);

535 
	`deviû_de¡roy
(
lun_bbt_şass
, 
devno
);

537 
	`uÄegi¡”_chrdev_»giÚ
(
lun_bbt_dev_num
, 
emu_lun_amouÁ
);

538 
	`şass_de¡roy
(
lun_bbt_şass
);

539 
	`kä“
(
lun_bbt_cdevs
);

540 
	}
}

542 
MODULE_LICENSE
("GPL");

	@shannon_emu.h

1 #iâdeà
__SHANNON_EMU_H


2 
	#__SHANNON_EMU_H


	)

4 
	~<lšux/¿ndom.h
>

5 
	~"shªnÚ.h
"

7 
	sshªnÚ_emu_lun
 {

8 
	mlun_num
;

9 
	mlogiÿl_lun
;

10 
	mmax_chªÃls
;

11 
	mmax_lun£t_š_chªÃl
;

12 
	mhw_lun_š_lun£t
;

13 *
	memu_bufãr
;

14 
u64
 *
	mm‘a_bufãr
;

15 
u32
 *
	mwr_æags
;

16 
u32
 *
	mbbt
;

17 
ºd_¡©e
 
	m»ad_¿nd_¡©e
;

18 
ºd_¡©e
 
	mwr™e_¿nd_¡©e
;

20 
	mlogicb_size
;

21 
	mlogicbs_š_·ge
;

22 
	mlogicb_shiá
;

23 
u8
 (*
´e_»ad
è(
	mshªnÚ_emu_lun
 *, 
	mlogicb_t
);

24 
u8
 (*
ÿche_»ad
è(
	mshªnÚ_emu_lun
 *, 
	mlogicb_t
, 
	mshªnÚ_»que¡
 *);

25 
u8
 (*
wr™e
è(
	mshªnÚ_emu_lun
 *, 
	mlogicb_t
, 
	mshªnÚ_li¡_h—d
 *);

26 
u8
 (*
bufq_wr™e
è(
shªnÚ_emu_lun
 *
	mlun
, 
logicb_t
 
	mµa
, *
	m¤c
, *
	mm‘ad©a
);

27 
u8
 (*
”a£
è(
	mshªnÚ_emu_lun
 *, );

	@shannon_epilog.c

12 
	~"shªnÚ.h
"

14 
	#METADATA_ARRAY_SIZE
 (64)

	)

15 
	sm‘ad©a_’Œy
 {

16 
logicb64_t
 
	mlba
;

17 
u64
 
	m¦Ù
;

18 
u8
 
	m‹mp
;

19 
u8
 
	md©©y³
;

20 
u16
 
	mns_id
;

21 
u16
 
	mns_£q_num
;

22 
u16
 
	mlun
;

23 
u32
 
	mlun_pba
;

24 
u32
 
	msb_pba
;

26 
u8
 *
	m‹mp_bË_pos
;

27 
u32
 *
	mm­_bË_pos
;

28 
u64
 *
	mv®id_logicbs_pos
;

29 
shªnÚ_¥šlock_t
 *
	m¥šlock
;

30 
shªnÚ_disk
 *
	msdisk
;

33 
	$£t_•og_size
(
shªnÚ_dev
 *
sdev
)

35 
chunk_size
 = 
sdev
->
logicb_size
 * sdev->
logicbs_š_chunk
;

36 ià(
sdev
->
mbr
.
ã©u»_æags
 & 
BIG_EPILOG
) {

37 
sdev
->
•og_h—d_size
 = (
shªnÚ_•og_h—d_4k
);

38 
sdev
->
•og_’Œy_size
 = (
u64
);

40 
sdev
->
•og_h—d_size
 = (
shªnÚ_•og_h—d
);

41 
sdev
->
•og_’Œy_size
 = (
logicb_t
);

43 
sdev
->
max_•og_size
 = sdev->
max_avaabË_groups
 * sdev->
max_luns_š_group
 * sdev->
logicbs_š_siblšg_eblock
 * sdev->
•og_’Œy_size
 + sdev->
•og_h—d_size
;

44 
sdev
->
max_•og_size
 = ((sdev->max_•og_siz+ 
chunk_size
 - 1) / chunk_size) * chunk_size;

45 
sdev
->
max_logicbs_š_•og
 = sdev->
max_•og_size
/sdev->
logicb_size
;

46 
	`debugs1
("epilog_head_size=%d,ƒpilog_entry_size=%d,ƒpilog_size=%d.\n",

47 
sdev
->
•og_h—d_size
, sdev->
•og_’Œy_size
, sdev->
max_•og_size
);

48 
	}
}

50 *
	$®loc_•og_·ge
(
shªnÚ_dev
 *
sdev
, 
gå_t
 
gå_mask
)

52 *
addr
;

53 
»Œy
:

54 
addr
 = 
	`shªnÚ_mempoŞ_®loc
(
sdev
->
•og_·ge_poŞ
, 
gå_mask
);

55 ià(
	`uÆik–y
(!
addr
)) {

56 
	`shªnÚ_w¬n
("allocateƒpilog_page failed!\n");

57 ià(
gå_mask
 & 
GFP_SHANNON
)

58 
	`shªnÚ_m¦“p
(1);

59 
»Œy
;

62  
addr
;

63 
	}
}

65 
	$ä“_•og_·ge
(
shªnÚ_dev
 *
sdev
, *
addr
)

67 
	`shªnÚ_mempoŞ_ä“
(
addr
, 
sdev
->
•og_·ge_poŞ
);

68 
	}
}

70 *
	$®loc_·ges_poš‹rs
(
size
)

72 *
addr
;

73 
»Œy_out
 = 100;

75 
»Œy
:

76 
addr
 = 
	`shªnÚ_vz®loc
(
size
);

77 ià(
	`uÆik–y
(!
addr
)) {

78 
	`shªnÚ_w¬n
("allocate…age_buf failed,„etry");

79 
	`shªnÚ_m¦“p
(1);

80 ià(
»Œy_out
--)

81 
»Œy
;

84  
addr
;

85 
	}
}

87 
	$ä“_·ges_poš‹rs
(*
addr
)

89 
	`shªnÚ_vä“
(
addr
);

90 
	}
}

92 
	$shªnÚ_»Ëa£_»bud_•ogs
(
shªnÚ_dev
 *
sdev
)

94 
shªnÚ_•og
 *
•og
;

95 
i
, 
j
;

97 
	`shªnÚ_¥š_lock
(&
sdev
->
•og_lock
);

98 
sdev
->
•og_couÁ
 = 
RUN_EPILOG_COUNT
;

99 
	`shªnÚ_¥š_uÆock
(&
sdev
->
•og_lock
);

100 
i
 = 
INIT_EPILOG_COUNT
 - 1; i >ğ
RUN_EPILOG_COUNT
; i--) {

101 
•og
 = 
sdev
->
•ogs
[
i
];

102 ià(
•og
 =ğ
NULL
)

105 
	`BUG_ON
(
	`shªnÚ_‹¡_ªd_£t_b™
(
i
, &
sdev
->
•og_b™m­
));

106 ià(
•og
->
·ges_poš‹rs
) {

107 
j
 = 0; j < 
sdev
->
max_logicbs_š_•og
; j++) {

108 ià(
•og
->
·ges_poš‹rs
[
j
])

109 
	`ä“_•og_·ge
(
sdev
, 
•og
->
·ges_poš‹rs
[
j
]);

111 
	`ä“_·ges_poš‹rs
(
•og
->
·ges_poš‹rs
);

113 
	`shªnÚ_kä“
(
sdev
->
•ogs
[
i
]);

114 
sdev
->
•ogs
[
i
] = 
NULL
;

117 
	}
}

119 
	$shªnÚ_»Ëa£_•ogs
(
shªnÚ_dev
 *
sdev
)

121 
shªnÚ_•og
 *
•og
;

122 
i
, 
j
;

124 
i
 = 0; i < 
INIT_EPILOG_COUNT
; i++) {

125 
•og
 = 
sdev
->
•ogs
[
i
];

126 ià(
•og
 =ğ
NULL
)

129 ià(
•og
->
·ges_poš‹rs
) {

130 
j
 = 0; j < 
sdev
->
max_logicbs_š_•og
; j++) {

131 ià(
•og
->
·ges_poš‹rs
[
j
])

132 
	`ä“_•og_·ge
(
sdev
, 
•og
->
·ges_poš‹rs
[
j
]);

134 
	`ä“_·ges_poš‹rs
(
•og
->
·ges_poš‹rs
);

136 
	`shªnÚ_kä“
(
sdev
->
•ogs
[
i
]);

137 
sdev
->
•ogs
[
i
] = 
NULL
;

139 
	}
}

141 
	$shªnÚ_®loc_•ogs
(
shªnÚ_dev
 *
sdev
)

143 
shªnÚ_•og
 *
•og
;

144 
i
, 
j
;

146 
sdev
->
•og_couÁ
 = 
INIT_EPILOG_COUNT
;

147 
i
 = 0; i < 
INIT_EPILOG_COUNT
; i++) {

148 
sdev
->
•ogs
[
i
] = 
	`shªnÚ_kz®loc
((
shªnÚ_•og
), 
GFP_SHANNON
);

149 ià(
NULL
 =ğ
sdev
->
•ogs
[
i
])

150 
ç
;

152 
•og
 = 
sdev
->
•ogs
[
i
];

153 
•og
->
šdex
 = 
i
;

154 
•og
->
·ges_poš‹rs
 = 
	`®loc_·ges_poš‹rs
((*•og->·ges_poš‹rsè* 
sdev
->
max_logicbs_š_•og
);

155 ià(
	`uÆik–y
(
NULL
 =ğ
•og
->
·ges_poš‹rs
)) {

156 
	`debugs0
("allocƒpilog…ages_pointers failed!\n");

157 
ç
;

160 
j
 = 0; j < 
sdev
->
max_logicbs_š_•og
; j++) {

161 
•og
->
·ges_poš‹rs
[
j
] = 
	`®loc_•og_·ge
(
sdev
, 
GFP_SHANNON
);

162 
	`shªnÚ_mem£t
(
•og
->
·ges_poš‹rs
[
j
], 0xFF, 
sdev
->
logicb_size
);

164 
•og
->
•og_h—d
 = (
shªnÚ_•og_h—d_4k
 *ëpog->
·ges_poš‹rs
[0];

165 
	`shªnÚ_mem_wr™eq
(
EPILOG_WATERMARK
, &
•og
->
•og_h—d
->
h—d
.
•og_w©”m¬k
);

167 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
•og_lock
);

168 
sdev
->
•og_b™m­
 = 0;

170 
ç
:

171 
	`shªnÚ_»Ëa£_•ogs
(
sdev
);

172  -
ENOMEM
;

173 
	}
}

175 
shªnÚ_•og
 *
	$•og_®loc
(
size
, 
shªnÚ_dev
 *
sdev
)

177 
shªnÚ_•og
 *
•og
;

178 
šdex
;

180 
	`shªnÚ_¥š_lock
(&
sdev
->
•og_lock
);

181 
šdex
 = 
	`shªnÚ_fšd_fœ¡_z”o_b™
(&
sdev
->
•og_b™m­
, sdev->
•og_couÁ
);

182 ià(
šdex
 =ğ
sdev
->
•og_couÁ
) {

183 
	`shªnÚ_¥š_uÆock
(&
sdev
->
•og_lock
);

184 
	`shªnÚ_”r
("cannot getƒpilog!\n");

185  
NULL
;

187 
	`shªnÚ_£t_b™
(
šdex
, &
sdev
->
•og_b™m­
);

188 
	`shªnÚ_¥š_uÆock
(&
sdev
->
•og_lock
);

190 
•og
 = 
sdev
->
•ogs
[
šdex
];

191 
•og
->
logicbs_š_u£
 = 
size
/
sdev
->
logicb_size
;

193  
•og
;

194 
	}
}

196 
šlše
 
	$•og_ä“
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og
 *
•og
)

198 
j
;

200 ià(
•og
 =ğ
NULL
)

203 
j
 = 0; j < 
sdev
->
max_logicbs_š_•og
; j++)

204 
	`shªnÚ_mem£t
(
•og
->
·ges_poš‹rs
[
j
], 0xFF, 
sdev
->
logicb_size
);

205 
•og
->
•og_h—d
 = (
shªnÚ_•og_h—d_4k
 *ëpog->
·ges_poš‹rs
[0];

206 
	`shªnÚ_mem_wr™eq
(
EPILOG_WATERMARK
, &
•og
->
•og_h—d
->
h—d
.
•og_w©”m¬k
);

209 
	`shªnÚ_¥š_lock
(&
sdev
->
•og_lock
);

210 
	`shªnÚ_ş—r_b™
(
•og
->
šdex
, &
sdev
->
•og_b™m­
);

211 
	`shªnÚ_¥š_uÆock
(&
sdev
->
•og_lock
);

212 
	}
}

214 
	$sb_ä“_•og
(
shªnÚ_sb
 *
sb
)

216 
	`•og_ä“
(
sb
->
sdev
, sb->
•og
);

217 
sb
->
•og
 = 
NULL
;

218 
	}
}

220 
	$»Ëa£_aùive_blocks_•og
(
shªnÚ_dev
 *
sdev
)

222 
i
;

224 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

225 ià(
sdev
->
aùive_blk
[
i
] && sdev->aùive_blk[i]->
•og
)

226 
	`sb_ä“_•og
(
sdev
->
aùive_blk
[
i
]);

228 
	}
}

230 *
	$•og_g‘_addr
(
shªnÚ_•og
 *
•og
, 
logicb_šdex
, 
shªnÚ_dev
 *
sdev
)

232  
•og
->
·ges_poš‹rs
[
logicb_šdex
];

233 
	}
}

235 
	$•og_£t_m‘ad©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og
 *
•og
, 
pba
, 
u64
 
m‘ad©a
)

237 
addr
, 
·ge
, 
off
;

239 
addr
 = 
pba
 * 
sdev
->
•og_’Œy_size
 + sdev->
•og_h—d_size
;

240 
·ge
 = 
addr
 / 
sdev
->
logicb_size
;

241 
off
 = 
addr
 % 
sdev
->
logicb_size
;

243 ià(
sdev
->
mbr
.
ã©u»_æags
 & 
BIG_EPILOG
)

244 
	`shªnÚ_mem_wr™eq
(
m‘ad©a
, &
•og
->
·ges_poš‹rs
[
·ge
][
off
]);

246 
logicb_t
 
lba
 = (logicb_t)
m‘ad©a
;

247 
	`shªnÚ_mem_wr™–
(
lba
, &
•og
->
·ges_poš‹rs
[
·ge
][
off
]);

249 
	}
}

251 
u64
 
	$•og_g‘_m‘ad©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og
 *
•og
, 
pba
)

253 
addr
, 
·ge
, 
off
;

255 
addr
 = 
pba
 * 
sdev
->
•og_’Œy_size
 + sdev->
•og_h—d_size
;

256 
·ge
 = 
addr
 / 
sdev
->
logicb_size
;

257 
off
 = 
addr
 % 
sdev
->
logicb_size
;

259 ià(
sdev
->
mbr
.
ã©u»_æags
 & 
BIG_EPILOG
)

260  
	`shªnÚ_mem_»adq
(&
•og
->
·ges_poš‹rs
[
·ge
][
off
]);

262  
	`shªnÚ_mem_»adl
(&
•og
->
·ges_poš‹rs
[
·ge
][
off
]);

263 
	}
}

265 
	$wr™e_•og_ÿÎback
(
shªnÚ_bio
 *
sbio
)

267 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

268 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

269 
shªnÚ_»que¡
 *
»q
, *
tmp
;

270 
shªnÚ_•og
 *
•og
;

272 
•og
 = 
sbio
->
vœt_addr
;

273 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

274 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

275 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

276 
	`BUG_ON
(
sb
->
sb_šdex
 !ğ
»q
->
pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
);

277 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

278 
	`ä“_»q
(
»q
);

280 
	`sb_ä“_•og
(
sb
);

281 
	`ä“_sbio
(
sbio
);

282 ià((
	`shªnÚ_©omic_»ad
(&
sdev
->
wa™_blk
è=ğ
sb
->
sb_šdex
è|| sdev->
¶ug_out
) {

283 
	`shªnÚ_©omic_£t
(&
sdev
->
wa™_blk
, -1);

284 
	`shªnÚ_wake_up
(&
sdev
->
wa™_blk_dÚe_ev’t
);

286 
	}
}

288 
	$wr™e_•og
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
h—d
)

290 
shªnÚ_»que¡
 *
»q
, *
fœ¡
, *
·r™y
 = 
NULL
;

291 
shªnÚ_bio
 *
sbio
;

292 
i
, 
couÁ
, 
·r™y_lun
 = -1;

293 
aùu®_logicbs
 = 
sb
->
•og
->
logicbs_š_u£
;

295 
sbio
 = 
	`®loc_sbio
(
GFP_NOWAIT
);

296 
	`£t_sbio_debug_g
(
sbio
, 
WRITE_EPILOG_TAG
);

297 
sbio
->
vœt_addr
 = 
sb
->
•og
;

298 
sbio
->
logicbs
 = 
aùu®_logicbs
;

299 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

300 
sbio
->
ÿÎback
 = 
wr™e_•og_ÿÎback
;

301 
sbio
->
d©a
 = 
sb
;

303 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


304 
	`cİy_•og_buf
(
sdev
, 
sb
->
sb_šdex
, sb->
•og
);

306 
fœ¡
 = 
NULL
;

307 
couÁ
 = 0;

308 
i
 = 0; i < 
aùu®_logicbs
; i++) {

309 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

310 
	`£t_»q_debug_g
(
»q
, 
WRITE_EPILOG_TAG
, 
i
);

311 
»q
->
İcode
 = 
sh_cmd_wr™e
;

312 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

313 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

314 
»q
->
h—d
 = h—d & ~
NO_POLL_MASK
;

315 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

316 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
è| (»q->
lba
 & 
LONG_LBA_MASK
);

317 
»q
->
vœt_addr
 = 
	`•og_g‘_addr
(
sb
->
•og
, 
i
, 
sdev
);

318 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

319 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

320 
	`shªnÚ_”r
("dma_map_single failed!.\n");

321 
	`BUG
();

323 
	`®loc_lun_pba
(
sdev
, 
»q
->
_m‘ad©a
, 
h—d
, &»q->
pba
);

324 
»q
->
sbio
 = sbio;

325 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

326 ià(
fœ¡
 =ğ
NULL
) {

327 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

328 
fœ¡
 = 
»q
;

330 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
fœ¡
->chunk_list);

331 
couÁ
++;

332 ià(
couÁ
 =ğ
sdev
->
logicbs_š_chunk
) {

333 ià(
sdev
->
¿id5_suµÜ‹d
 && (sdev->
lun_š_group
[
h—d
 & 
HEAD_INDEX_MASK
] == 0)) {

334 
·r™y_lun
 = 
	`g‘_·r™y_lun
(&
sb
->
sub_group
[
fœ¡
->
pba
.
lun
/
sdev
->
max_luns_š_group
]);

335 
·r™y
 = 
	`make_·r™y_»q
(
sb
, 
·r™y_lun
, 
fœ¡
);

338 
	`shªnÚ_wr™e_cmd
(
sdev
->
lun
[
fœ¡
->
pba
.lun]->
lun£t
, first);

339 
fœ¡
 = 
NULL
;

340 
couÁ
 = 0;

342 ià(
·r™y
) {

343 
	`shªnÚ_·r™y_cmd
(
sdev
->
lun
[
·r™y_lun
]->
lun£t
, 
·r™y
);

344 
·r™y
 = 
NULL
;

348 
	}
}

350 
	$is_fœ¡_•og_pba
(
shªnÚ_sb
 *
sb
, 
logicb_t
 
wr_off£t
)

352 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

353  (
wr_off£t
 =ğ
	`fœ¡_•og_pba
(
sdev
, 
sb
));

354 
	}
}

356 
	$is_•og_pba
(
shªnÚ_sb
 *
sb
, 
logicb_t
 
wr_off£t
)

358 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

359  (
wr_off£t
 >ğ(
sb
->
mš_d©a_luns
 * 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_siblšg_eblock
 - sb->
logicbs_š_•og
));

360 
	}
}

362 
	$is_•og_·ge_¡re
(
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
group_šdex
)

364 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

365 
sub_group
 *
group
 = &
sb
->sub_group[
group_šdex
];

366 
logicbs_š_group
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
;

367 
•og_groups
 = (
sb
->
logicbs_š_•og
 + 
logicbs_š_group
 - 1) /†ogicbs_in_group;

369  ((
·ge_¡re
 * 
sdev
->
max_avaabË_groups
 + 
group
->
phy_šdex
è>ğ(sdev->
·ges_š_eblock
 * sdev->max_avaabË_group - 
•og_groups
));

370 
	}
}

373 
	$upd©e_•og_h—d
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

375 
	`shªnÚ_mem_wr™eq
(
sdev
->
£qu’û_numb”
++, &
sb
->
•og
->
•og_h—d
->
h—d
.
£q_num
);

376 
sb
->
£q_num
 = 
	`shªnÚ_mem_»adq
(&sb->
•og
->
•og_h—d
->
h—d
.seq_num);

377 
	`shªnÚ_mem_wr™ew
(
sb
->
h—d_šdex
, &sb->
•og
->
•og_h—d
->
h—d
.head_index);

378 
	`shªnÚ_mem_wr™–
(
sb
->
”a£_couÁ”
, &sb->
•og
->
•og_h—d
->
h—d
.erase_counter);

379 
	`shªnÚ_mem_wr™ew
(
sb
->
Ãxt_sb
, &sb->
•og
->
•og_h—d
->
h—d
.next_sb);

380 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

381 
	`shªnÚ_mem_wr™eq
(
sdev
->
pow”_Ú_£cÚds
, &
sb
->
•og
->
•og_h—d
->
h—d
.power_on_seconds);

382 
	`shªnÚ_mem_wr™eq
(
sdev
->
pow”_cyşe_couÁ
, &
sb
->
•og
->
•og_h—d
->
h—d
.power_cycle_count);

383 
	`shªnÚ_mem_wr™eq
(
sdev
->
ho¡_wr™e_£ùÜs
, &
sb
->
•og
->
•og_h—d
->
h—d
.host_write_sectors);

384 
	`shªnÚ_mem_wr™eq
(
sdev
->
tÙ®_wr™e_£ùÜs
, &
sb
->
•og
->
•og_h—d
->
h—d
.total_write_sectors);

385 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

386 
	`shªnÚ_mem_wr™–
(
sdev
->
‹m³¿tu»_št_max
, &
sb
->
•og
->
•og_h—d
->
h—d
.temperature_int_max);

387 
	`shªnÚ_mem_wr™–
(
sdev
->
‹m³¿tu»_bßrd_max
, &
sb
->
•og
->
•og_h—d
->
h—d
.temperature_board_max);

388 
	`shªnÚ_mem_wr™–
(
sdev
->
‹m³¿tu»_æash_max
, &
sb
->
•og
->
•og_h—d
->
h—d
.temperature_flash_max);

389 
	`shªnÚ_mem_wr™–
(
sdev
->
vŞge_št_max
, &
sb
->
•og
->
•og_h—d
->
h—d
.voltage_int_max);

390 
	`shªnÚ_mem_wr™–
(
sdev
->
vŞge_aux_max
, &
sb
->
•og
->
•og_h—d
->
h—d
.voltage_aux_max);

392 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_have_»ad_£ùÜs
(sdev);

393 
	`shªnÚ_mem_wr™eq
(
sdev
->
ho¡_»ad_£ùÜs
, &
sb
->
•og
->
•og_h—d
->
h—d
.host_read_sectors);

395 
	`shªnÚ_mem_wr™–
(
sdev
->
£u_üc_”rÜ
 + sdev->
£u_üc_”rÜ_hi¡Üy
, &
sb
->
•og
->
•og_h—d
->
h—d
.seu_crc_error_history);

396 
	`shªnÚ_mem_wr™–
(
sdev
->
£u_ecc_”rÜ
 + sdev->
£u_ecc_”rÜ_hi¡Üy
, &
sb
->
•og
->
•og_h—d
->
h—d
.seu_ecc_error_history);

397 
	}
}

399 
	$»Œ›ve_sm¬t_äom_•og_h—d
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_•og_h—d
 *
•og_h—d
)

401 ià(
sdev
->
pow”_Ú_£cÚds
 < (
	`shªnÚ_mem_»adq
(&
•og_h—d
->power_on_seconds) + 1))

402 
sdev
->
pow”_Ú_£cÚds
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->power_on_seconds);

403 ià(
sdev
->
pow”_cyşe_couÁ
 < (
	`shªnÚ_mem_»adq
(&
•og_h—d
->power_cycle_count) + 1))

404 
sdev
->
pow”_cyşe_couÁ
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->power_cycle_count);

405 ià(
sdev
->
ho¡_wr™e_£ùÜs
 < (
	`shªnÚ_mem_»adq
(&
•og_h—d
->host_write_sectors) + 1))

406 
sdev
->
ho¡_wr™e_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->host_write_sectors);

407 ià(
sdev
->
tÙ®_wr™e_£ùÜs
 < (
	`shªnÚ_mem_»adq
(&
•og_h—d
->total_write_sectors) + 1))

408 
sdev
->
tÙ®_wr™e_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->total_write_sectors);

409 ià(
sdev
->
ho¡_»ad_£ùÜs_hi¡Üy
 < (
	`shªnÚ_mem_»adq
(&
•og_h—d
->
ho¡_»ad_£ùÜs
) + 1))

410 
sdev
->
ho¡_»ad_£ùÜs_hi¡Üy
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->
ho¡_»ad_£ùÜs
);

411 ià(
sdev
->
‹m³¿tu»_št_max
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->temperature_int_max) + 1))

412 
sdev
->
‹m³¿tu»_št_max
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->temperature_int_max);

413 ià(
sdev
->
‹m³¿tu»_bßrd_max
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->temperature_board_max) + 1))

414 
sdev
->
‹m³¿tu»_bßrd_max
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->temperature_board_max);

415 ià(
sdev
->
‹m³¿tu»_æash_max
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->temperature_flash_max) + 1))

416 
sdev
->
‹m³¿tu»_æash_max
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->temperature_flash_max);

417 ià(
sdev
->
vŞge_št_max
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->voltage_int_max) + 1))

418 
sdev
->
vŞge_št_max
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->voltage_int_max);

419 ià(
sdev
->
vŞge_aux_max
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->voltage_aux_max) + 1))

420 
sdev
->
vŞge_aux_max
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->voltage_aux_max);

421 ià(
sdev
->
£u_üc_”rÜ_hi¡Üy
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->seu_crc_error_history) + 1))

422 
sdev
->
£u_üc_”rÜ_hi¡Üy
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->seu_crc_error_history);

423 ià(
sdev
->
£u_ecc_”rÜ_hi¡Üy
 < (
	`shªnÚ_mem_»adl
(&
•og_h—d
->seu_ecc_error_history) + 1))

424 
sdev
->
£u_ecc_”rÜ_hi¡Üy
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->seu_ecc_error_history);

425 
	}
}

427 
šlše
 
	$•og_d©a_is_šv®id
(
shªnÚ_dev
 *
sdev
, 
u64
 
m‘ad©a
)

429 
u32
 
ns_£q_num
 = (
m‘ad©a
 >> 
NS_SEQ_NUM_SHIFT
è& 
NS_SEQ_NUM_MASK
;

430 ià(
m‘ad©a
 == ~0ULL)

432 ià(
sdev
->
mbr
.
ã©u»_æags
 & 
BIG_EPILOG
) {

433 
d©©y³
;

434 
u64
 
lba64
;

435 
d©©y³
 = (
m‘ad©a
 >> 
DATATYPE_SHIFT
è& 
DATATYPE_MASK
;

436 ià((
d©©y³
 !ğ
SHORT_LBA
è&& (d©©y³ !ğ
LONG_LBA
))

438 
lba64
 = 
m‘ad©a
 & 
LONG_LBA_MASK
;

439  
	`lÚg_lba_is_šv®id
(
lba64
è&& 
ns_£q_num
 == 0;

441  
	`lba_is_šv®id
(
m‘ad©a
 & 
LONG_LBA_MASK
è&& 
ns_£q_num
 == 0;

442 
	}
}

444 
	$»cov”_ns_d©a_äom_»q
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_»que¡
 *
»q
, 
shªnÚ_dev
 *
sdev
)

446 
u64
 
v”siÚ_num
 = 
	`shªnÚ_mem_»adq
(
»q
->
vœt_addr
);

447 
	`shªnÚ_¥š_lock_bh
(&
ns
->
d©a_lock
);

448 ià(
v”siÚ_num
 > 
ns
->
d©a
->
v”siÚ
) {

449 
	`cİy_ns_d©a
(
ns
->
d©a
, 
»q
->
vœt_addr
);

450 ià(
ns
->
d©a_pba
.
lun_pba
 != 0x03ffffff)

451 
	`£t_Şd_pba_¡®e
(
sdev
, 
ns
->
d©a_pba
.
lun
,‚s->d©a_pba.
lun_pba
);

452 
ns
->
d©a_pba
 = 
»q
->
pba
;

453 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

455 
	`shªnÚ_¥š_uÆock_bh
(&
ns
->
d©a_lock
);

456 
	}
}

458 
	$»cov”_ns_d©a_ÿÎback
(
shªnÚ_bio
 *
sbio
)

460 
shªnÚ_Çme¥aû
 *
ns
 = 
sbio
->
d©a
;

461 
shªnÚ_dev
 *
sdev
 = 
ns
->
poŞ
->
sdevs
[0];

462 
shªnÚ_»que¡
 *
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, shannon_request,

463 
bio_li¡
);

464 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

465 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

466 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

468 ià(
sbio
->
¡©us
)

469 
	`shªnÚ_w¬n
("error(%d)„eading‚s_data,†un: 0x%x,†un_pba: 0x%x\n",

470 
sbio
->
¡©us
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

472 
	`»cov”_ns_d©a_äom_»q
(
ns
, 
»q
, 
sdev
);

473 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, (*(
ns
->
d©a
)), 
SHANNON_DMA_FROMDEVICE
);

474 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

475 
	`ä“_»q
(
»q
);

476 
	`ä“_sbio
(
sbio
);

477 
	`shªnÚ_©omic_dec
(&
ns
->
poŞ
->
»cov”_ns_d©a_dÚe
);

478 ià(
	`shªnÚ_©omic_»ad
(&
ns
->
poŞ
->
»cov”_ns_d©a_dÚe
) == 0)

479 
	`shªnÚ_wake_up
(&
ns
->
poŞ
->
»cov”_ns_d©a_dÚe_ev’t
);

480 
	}
}

482 
	$»cov”_ns_d©a
(
shªnÚ_Çme¥aû
 *
ns
, 
lun_pba
 
pba
)

484 
shªnÚ_bio
 *
sbio
;

485 
shªnÚ_»que¡
 *
»q
;

486 
shªnÚ_dev
 *
sdev
 = 
ns
->
poŞ
->
sdevs
[0];

487 
ns_d©a_size
 = (
shªnÚ_ns_d©a
);

489 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

490 
	`£t_sbio_debug_g
(
sbio
, 
RECOVER_NS_DATA_TAG
);

491 
sbio
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

492 
sbio
->
logicbs
 = 1;

493 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

494 
sbio
->
ÿÎback
 = 
»cov”_ns_d©a_ÿÎback
;

495 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

496 
sbio
->
d©a
 = 
ns
;

497 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, 
ns_d©a_size
,

498 
SHANNON_DMA_FROMDEVICE
);

500 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

501 
	`£t_»q_debug_g
(
»q
, 
RECOVER_NS_DATA_TAG
, 0);

502 
»q
->
İcode
 = 
sh_cmd_»ad
;

503 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

504 
»q
->
lba
 = 
LONG_INVALID_LBA
;

505 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

506 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

507 
»q
->
pba
 =…ba;

508 
»q
->
sbio
 = sbio;

509 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

510 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

511 
	`add_»que¡_queue_
(
sdev
, 
»q
, 0);

513 
	`shªnÚ_©omic_šc
(&
ns
->
poŞ
->
»cov”_ns_d©a_dÚe
);

514 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

516 
	}
}

518 
šlše
 
	$m‘ad©a_’Œy_´eãtch
(
shªnÚ_dev
 *
sdev
, 
m‘ad©a_’Œy
 *
m‘a_’Œy
)

520 *
b™_ba£
 = (
u64
 *)
sdev
->
lun
[
m‘a_’Œy
->lun]->
pba_bË
 + (m‘a_’Œy->
lun_pba
*
PBA_ENTRY_LEN
)/64;

522 
	`shªnÚ_¥š_lock_´eãtch
(&(
m‘a_’Œy
->
sdisk
->
Ímt_¬¿y
[
sdev
->
sdev_id
].
m­_bË_lock
[
	`g‘_Ímt_lock_šdex
(m‘a_’Œy->
¦Ù
)]));

523 
	`shªnÚ_´eãtch
(
b™_ba£
);

524 
	`shªnÚ_´eãtch
(
m‘a_’Œy
->
m­_bË_pos
);

525 
	`shªnÚ_´eãtch
(
m‘a_’Œy
->
‹mp_bË_pos
);

526 
	}
}

528 
šlše
 
	$ç¡_hªdË_m‘ad©a_¬¿y
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
m‘ad©a_’Œy
 *
m‘a_¬¿y
, 
couÁ
)

530 
lun_pba
 
Şd_pba
;

531 
sb_num
;

532 
šdex
;

534 
	`shªnÚ_´eãtch
(&
m‘a_¬¿y
[0]);

535 
	`m‘ad©a_’Œy_´eãtch
(
sdev
, &
m‘a_¬¿y
[0]);

536 
šdex
 = 0; index < 
couÁ
; index++) {

537 ià((
šdex
 + 1è< 
couÁ
) {

538 
	`shªnÚ_´eãtch
(&
m‘a_¬¿y
[
šdex
 + 1]);

539 
	`m‘ad©a_’Œy_´eãtch
(
sdev
, &
m‘a_¬¿y
[
šdex
 + 1]);

542 
	`Ímt_lock_š_»cov”_Ímt
(
sdev
, 
m‘a_¬¿y
[
šdex
].
sdisk
, m‘a_¬¿y[šdex].
¦Ù
);

543 ià(
	`g‘_lun_pba_äom_lba
(
m‘a_¬¿y
[
šdex
].
lba
, &
Şd_pba
, 
NULL
, m‘a_¬¿y[šdex].
sdisk
) < 0) {

544 
	`shªnÚ_´eãtch
(&(
m‘a_¬¿y
[
šdex
].
sdisk
->
Ímt_¬¿y
[
sdev
->
sdev_id
].
v®id_logicbs_¬¿y
[
	`g‘_Ímt_lock_šdex
(m‘a_¬¿y[šdex].
¦Ù
)]));

546 
	`£t_v®id
(
sdev
, 
m‘a_¬¿y
[
šdex
].
lun
, m‘a_¬¿y[šdex].
lun_pba
);

547 
m‘a_¬¿y
[
šdex
].
sdisk
->
Ímt_¬¿y
[
sdev
->
sdev_id
].
v®id_logicbs_¬¿y
[
	`g‘_Ímt_lock_šdex
(m‘a_¬¿y[šdex].
¦Ù
)]++;

548 *
m‘a_¬¿y
[
šdex
].
m­_bË_pos
 = 
	`m­_bË_d©a
(m‘a_¬¿y[šdex].
lun
, m‘a_¬¿y[šdex].
lun_pba
);

549 *
m‘a_¬¿y
[
šdex
].
‹mp_bË_pos
 = 
	`‹mp_bË_d©a
(m‘a_¬¿y[šdex].
‹mp
, m‘a_¬¿y[šdex].
lun
);

550 ià(
sdev
->
¥oŞ
)

551 
	`shªnÚ_©omic64_šc
(&
sdev
->
¥oŞ
->
u£d_logicbs
);

553 
sb_num
 = 
Şd_pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
;

554 ià(
sdev
->
sbs
[
sb_num
].
£q_num
 <ğ
sb
->seq_num) {

556 
	`£t_v®id
(
sdev
, 
m‘a_¬¿y
[
šdex
].
lun
, m‘a_¬¿y[šdex].
lun_pba
);

557 *
m‘a_¬¿y
[
šdex
].
m­_bË_pos
 = 
	`m­_bË_d©a
(m‘a_¬¿y[šdex].
lun
, m‘a_¬¿y[šdex].
lun_pba
);

558 *
m‘a_¬¿y
[
šdex
].
‹mp_bË_pos
 = 
	`‹mp_bË_d©a
(m‘a_¬¿y[šdex].
‹mp
, m‘a_¬¿y[šdex].
lun
);

559 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

562 
	`Ímt_uÆock_š_»cov”_Ímt
(
sdev
, 
m‘a_¬¿y
[
šdex
].
sdisk
, m‘a_¬¿y[šdex].
¦Ù
);

564 
	}
}

566 
	$»cov”_lm±_group
(
shªnÚ_sb
 *
sb
, 
shªnÚ_•og
 *
•og
, 
·ge_¡re
, 
group_šdex
)

568 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

569 
shªnÚ_poŞ
 *
¥oŞ
 = 
sdev
->spool;

570 
shªnÚ_Çme¥aû
 *
ns
;

571 
sb_num
;

572 
šdex
 = 0;

573 
sub_group
 *
group
 = &
sb
->sub_group[
group_šdex
];

574 
logicb64_t
 
sb_pba
, 
lun_pba
, 
m‘ad©a
;

575 
lun
, 
lun_off£t
, 
¶ªe
, 
logicb
;

576 
lun_š_group
;

577 
‹mp
;

578 
»t
 = 0;

579 
m‘ad©a_’Œy
 *
m‘a_¬¿y
 = 
NULL
;

582 
m‘a_¬¿y
 = 
	`shªnÚ_kz®loc
((
m‘ad©a_’Œy
è* 
METADATA_ARRAY_SIZE
, 
GFP_SHANNON
);

583 } 
m‘a_¬¿y
 =ğ
NULL
);

585 ià(
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
è=ğ
HOT_INDEX
)

586 
‹mp
 = 
INIT_HOT_STATE
;

588 
‹mp
 = 
COLD_STATE
;

591 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

592 
lun_š_group
 = -1;

595 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

596 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

597 } 
	`is_bad_lun
(
sb
, 
lun
));

598 
lun_š_group
++;

600 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

601 
logicb
 = 0;†ogicb < 
sdev
->
logicbs_š_·ge
;†ogicb++) {

603 ià(
sdev
->
com·ù_•og
)

604 
sb_pba
 = 
group
->
phy_šdex
 * 
sb
->
mš_d©a_luns
 * 
sdev
->
logicbs_š_siblšg_eblock
 + \

605 
lun_š_group
 * 
sdev
->
logicbs_š_siblšg_eblock
 + \

606 
¶ªe
 * 
sdev
->
logicbs_š_siblšg_eblock
 / sdev->
¶ªes
 + \

607 
·ge_¡re
 * 
sdev
->
logicbs_š_·ge
 + \

608 
logicb
;

610 
sb_pba
 = 
group
->
phy_šdex
 * 
sdev
->
max_luns_š_group
 * sdev->
logicbs_š_siblšg_eblock
 + \

611 
lun_off£t
 * 
sdev
->
logicbs_š_siblšg_eblock
 + \

612 
¶ªe
 * 
sdev
->
logicbs_š_siblšg_eblock
 / sdev->
¶ªes
 + \

613 
·ge_¡re
 * 
sdev
->
logicbs_š_·ge
 + \

614 
logicb
;

616 
lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + \

617 
¶ªe
 * 
sdev
->
logicbs_š_siblšg_eblock
/sdev->
¶ªes
 + \

618 
·ge_¡re
 * 
sdev
->
logicbs_š_·ge
 + \

619 
logicb
;

620 
m‘ad©a
 = 
	`•og_g‘_m‘ad©a
(
sdev
, 
•og
, 
sb_pba
);

621 ià(
	`•og_d©a_is_šv®id
(
sdev
, 
m‘ad©a
))

624 
m‘a_¬¿y
[
šdex
].
lba
 = 
m‘ad©a
 & 
LONG_LBA_MASK
;

625 
m‘a_¬¿y
[
šdex
].
lun
 =†un;

626 
m‘a_¬¿y
[
šdex
].
lun_pba
 =†un_pba;

627 
m‘a_¬¿y
[
šdex
].
ns_id
 = (
m‘ad©a
 >> 
NS_ID_SHIFT
è& 
NS_ID_MASK
;

628 
m‘a_¬¿y
[
šdex
].
ns_£q_num
 = (
m‘ad©a
 >> 
NS_SEQ_NUM_SHIFT
è& 
NS_SEQ_NUM_MASK
;

629 
m‘a_¬¿y
[
šdex
].
d©©y³
 = (
m‘ad©a
 >> 
DATATYPE_SHIFT
è& 
DATATYPE_MASK
;

630 
m‘a_¬¿y
[
šdex
].
‹mp
 =emp;

631 
m‘a_¬¿y
[
šdex
].
sb_pba
 = sb_pba;

633 ià(
¥oŞ
) {

634 
ns
 = 
¥oŞ
->ns[
m‘a_¬¿y
[
šdex
].
ns_id
];

635 ià((
ns
 =ğ
NULL
è|| (
m‘a_¬¿y
[
šdex
].
ns_id
 >ğ
SHANNON_NS_NUM
)) {

636 
	`debugs1
("m‘ad©a=0x%lx, WrÚg‚s_id=%d.\n", 
m‘ad©a
, 
m‘a_¬¿y
[
šdex
].
ns_id
);

639 ià(
m‘a_¬¿y
[
šdex
].
ns_£q_num
 !ğ
ns
->
£q_num
) {

640 
	`debugs1
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

641 
sb
->
sb_šdex
, 
m‘a_¬¿y
[
šdex
].
ns_£q_num
, m‘a_¬¿y[šdex].
ns_id
, 
ns
->
£q_num
);

644 ià(
m‘a_¬¿y
[
šdex
].
lba
 =ğ
šv®id_lba
[
sdev
->
lba_fÜm©
] && sdev->
sdev_id
 == 0) {

645 
lun_pba
 
Í
 = {.
lun
 = 
m‘a_¬¿y
[
šdex
].lun, .lun_pba = meta_array[index].lun_pba};

646 
sb_num
 = 
ns
->
d©a_pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
;

647 ià(
ns
->
d©a_pba
.
lun_pba
 == 0x03ffffff ||

648 
sdev
->
sbs
[
sb_num
].
£q_num
 <ğ
sb
->seq_num) {

649 
	`£t_v®id
(
sdev
, 
m‘a_¬¿y
[
šdex
].
lun
, m‘a_¬¿y[šdex].
lun_pba
);

650 ià(
ns
->
d©a_pba
.
lun_pba
 != 0x03ffffff)

651 
	`£t_Şd_pba_¡®e
(
sdev
, 
ns
->
d©a_pba
.
lun
,‚s->d©a_pba.
lun_pba
);

652 
ns
->
d©a_pba
 = 
Í
;

656 
m‘a_¬¿y
[
šdex
].
sdisk
 = &
ns
->sdisk;

659 ià((
m‘a_¬¿y
[
šdex
].
ns_id
 !ğ0è|| (m‘a_¬¿y[šdex].
ns_£q_num
 != 0)) {

660 
	`shªnÚ_”r
("Wrong metadata in‚on-namespace mode. metadata=0x%lx,‚s_id=%d,‚s_seq_num=%d.\n",

661 
m‘ad©a
, 
m‘a_¬¿y
[
šdex
].
ns_id
, m‘a_¬¿y[šdex].
ns_£q_num
);

664 
m‘a_¬¿y
[
šdex
].
sdisk
 = &
sdev
->sdisk;

666 ià(
m‘a_¬¿y
[
šdex
].
lba
 > m‘a_¬¿y[šdex].
sdisk
->
tÙ®_m­_bË_size
 / (
u32
)) {

667 
	`shªnÚ_”r
("Wrong Epilog data: sb_index=%d, sb_pba=0x%x,†ba=0x%lx.\n",

668 
sb
->
sb_šdex
, 
m‘a_¬¿y
[
šdex
].
sb_pba
, m‘a_¬¿y[šdex].
lba
);

669 
»t
 = -
EIO
;

670 
out
;

672 ià(
	`check_ªd_®loc_m­bË
(
m‘a_¬¿y
[
šdex
].
sdisk
, m‘a_¬¿y[šdex].
lba
)) {

673 
»t
 = -
EIO
;

674 
out
;

676 
m‘a_¬¿y
[
šdex
].
¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(m‘a_¬¿y[šdex].
sdisk
, m‘a_¬¿y[šdex].
lba
);

677 
m‘a_¬¿y
[
šdex
].
‹mp_bË_pos
 = 
	`‹mp_bË_g‘_pos™iÚ
(&m‘a_¬¿y[šdex].
sdisk
->
Ímt_¬¿y
[
sdev
->
sdev_id
], m‘a_¬¿y[šdex].
¦Ù
);

678 
m‘a_¬¿y
[
šdex
].
m­_bË_pos
 = 
	`m­_bË_g‘_pos™iÚ
(&m‘a_¬¿y[šdex].
sdisk
->
Ímt_¬¿y
[
sdev
->
sdev_id
], m‘a_¬¿y[šdex].
¦Ù
);

679 ià(
m‘a_¬¿y
[
šdex
].
‹mp_bË_pos
 =ğ
NULL
 || m‘a_¬¿y[šdex].
m­_bË_pos
 == NULL) {

680 
	`shªnÚ_”r
("sdev->sdev_id=%d, index=%d, m‘ad©a=0x%lx,†ba=0x%lx.\n", 
sdev
->
sdev_id
, 
šdex
, 
m‘ad©a
, 
m‘a_¬¿y
[šdex].
lba
);

681 
	`BUG_ON
(1);

684 
šdex
++;

685 ià(
šdex
 =ğ
METADATA_ARRAY_SIZE
) {

686 
	`ç¡_hªdË_m‘ad©a_¬¿y
(
sdev
, 
sb
, 
m‘a_¬¿y
, 
šdex
);

687 
šdex
 = 0;

689 
	`shªnÚ_´eãtch
(&
m‘a_¬¿y
[
šdex
]);

692 } 
lun_off£t
 !ğ
group
->
Ï¡_d©a_lun_off£t
);

694 ià(
šdex
)

695 
	`ç¡_hªdË_m‘ad©a_¬¿y
(
sdev
, 
sb
, 
m‘a_¬¿y
, 
šdex
);

697 
out
:

698 
	`shªnÚ_kä“
(
m‘a_¬¿y
);

699  
»t
;

700 
	}
}

702 
	$»cov”_lm±
(
shªnÚ_sb
 *
sb
, 
shªnÚ_•og
 *
•og
)

704 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

705 
sub_group
 *
group
;

706 
·ge
, 
group_šdex
;

708 
·ge
 = 0;…ag< 
sdev
->
·ges_š_eblock
;…age++){

709 
group_šdex
 = 0; group_šdex < 
sdev
->
·r™y_groups
; group_index++) {

710 
group
 = &
sb
->
sub_group
[
group_šdex
];

711 ià(
group
->
phy_šdex
 < 0)

713 ià(
	`»cov”_lm±_group
(
sb
, 
•og
, 
·ge
, 
group_šdex
) < 0)

714  -
EIO
;

715 
	`shªnÚ_cÚd_»sched
();

720 
	}
}

722 
	$add_to_li¡_by_£q_num
(
shªnÚ_sb
 *
sb
, 
shªnÚ_li¡_h—d
 *
sb_li¡
)

724 
shªnÚ_sb
 *
tmp
;

725 
shªnÚ_li¡_h—d
 *
li¡
;

727 ià(
	`shªnÚ_li¡_em±y
(
sb_li¡
)) {

728 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, 
sb_li¡
);

732 
li¡
 = 
sb_li¡
->
Ãxt
;

733 
li¡
 !ğ
sb_li¡
) {

734 
tmp
 = 
	`shªnÚ_li¡_’Œy
(
li¡
, 
shªnÚ_sb
,†ist);

735 ià(
tmp
->
£q_num
 > 
sb
->seq_num)

737 
li¡
 =†i¡->
Ãxt
;

739 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
,†ist);

740 
	}
}

742 
	$»ad_•og_ÿÎback
(
shªnÚ_bio
 *
sbio
)

744 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

745 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

746 
shªnÚ_»que¡
 *
»q
, *
tmp
;

747 
shªnÚ_•og
 *
•og
 = 
sb
->epilog;

748 
i
, 
bÏnk_logicbs
 = 0;

749 
Ãed_»sÿn
 = 0, 
off£t
;

750 
·r™y_is_em±y
 = 0, 
d©a_lun_is_em±y
 = 0;

751 
sub_group
 *
group
;

752 
logicbs_š_·ge_¡re
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
;

753 
·ge_¡res
 = (
sb
->
logicbs_š_•og
 + 
logicbs_š_·ge_¡re
 - 1) /†ogicbs_in_page_stripe;

754 
d©a_logicbs
 = 
sbio
->
logicbs
;

755 
u8
 
h—d_ecc
 = 0;

756 ià(
sdev
->
¿id5_suµÜ‹d
)

757 
d©a_logicbs
 = 
sbio
->
logicbs
 - 
·ge_¡res
 * 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_chunk
;

759 
d©a_logicbs
 = 
sbio
->
logicbs
;

761 
off£t
 = 0;

762 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

763 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

764 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

765 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

766 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

769 
group
 = &
sb
->
sub_group
[
»q
->
pba
.
lun
 / 
sdev
->
max_luns_š_group
];

770 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
) {

771 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
)))

772 
·r™y_is_em±y
 = 1;

774 
d©a_lun_is_em±y
 = 1;

775 
bÏnk_logicbs
++;

778 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
)))

780 ià(((
»q
->
d©©y³
 =ğ
SHORT_LBA
è&& (»q->
_m‘ad©a
 =ğ
INVALID_LBA2
)) ||

781 (
»q
->
d©©y³
 =ğ
NEED_RESCAN
))

782 
Ãed_»sÿn
 = 1;

783 
i
 = 
off£t
 - (
d©a_logicbs
 - 
sb
->
logicbs_š_•og
);

784 ià(
i
 >= 0) {

785 ià(
i
 == 0)

786 
h—d_ecc
 = 
»q
->
_ecc
;

787 
	`shªnÚ_memıy
(
	`•og_g‘_addr
(
•og
, 
i
, 
sdev
), 
»q
->
vœt_addr
, sdev->
logicb_size
);

789 
off£t
++;

792 ià((
	`shªnÚ_mem_»adq
(&
•og
->
•og_h—d
->
h—d
.
•og_w©”m¬k
è=ğ
EPILOG_WATERMARK
è&& (
h—d_ecc
 < 
SH_FAKE_ERR
)) {

794 
sb
->
£q_num
 = 
	`shªnÚ_mem_»adq
(&
•og
->
•og_h—d
->
h—d
.seq_num);

795 
sb
->
”a£_couÁ”
 = 
	`shªnÚ_mem_»adl
(&
•og
->
•og_h—d
->
h—d
.erase_counter);

796 
sb
->
h—d_šdex
 = 
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.head_index);

797 
sb
->
Ãxt_sb
 = 
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.next_sb);

798 
	`£t_»cov”ed_•og_h—d
(
sb
);

801 ià(
sbio
->
¡©us
 & 
HAVE_ERROR_SECTOR
) {

802 
group
 = -1, 
max_”r_logicbs
 = 0;

803 
cur_”r_logicbs
 = 0;

804 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
)

805 ià((
»q
->
_ecc
 >ğ
SH_FAKE_ERR
è&& (»q->_ecø!ğ
SH_FRESH_ERASED
)) {

806 
	`shªnÚ_w¬n
("sb(sb_šdex=%dèha bad†un=%d.\n", 
sb
->
sb_šdex
, 
»q
->
pba
.
lun
);

807 ià(
group
 < 0)

808 
group
 = 
»q
->
pba
.
lun
 / 
sdev
->
max_luns_š_group
;

809 ià(
group
 !ğ
»q
->
pba
.
lun
 / 
sdev
->
max_luns_š_group
) {

810 ià(
cur_”r_logicbs
 > 
max_”r_logicbs
)

811 
max_”r_logicbs
 = 
cur_”r_logicbs
;

812 
cur_”r_logicbs
 = 1;

813 
group
 = 
»q
->
pba
.
lun
 / 
sdev
->
max_luns_š_group
;

815 
cur_”r_logicbs
++;

819 
	`shªnÚ_šfo
("sb=%d, sbio->status=0x%x, sbio->logicbs=%d, data_logicbs=%d, blank_logicbs=%d, max_err_logicbs==%d.\n",

820 
sb
->
sb_šdex
, 
sbio
->
¡©us
, sbio->
logicbs
, 
d©a_logicbs
, 
bÏnk_logicbs
, 
max_”r_logicbs
);

822 ià((
max_”r_logicbs
 <ğ
sdev
->
logicbs_š_chunk
) && \

823 (
bÏnk_logicbs
 >ğ(
sbio
->
logicbs
 - 
sdev
->
logicbs_š_chunk
 * sdev->
max_avaabË_groups
 * 
·ge_¡res
))) {

824 
	`shªnÚ_šfo
("%s(): sb(sb_šdex=%dèi ¨ä“ su³¸block.\n", 
__func__
, 
sb
->
sb_šdex
);

826 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

827 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

828 
	`shªnÚ_”r
("sb=%d,†un=%d,…ba=%d,ƒcc=0x%x.\n",

829 
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
,„eq->pba.
lun
,„eq->pba.lun_pba,„eq->
_ecc
);

832 
	`shªnÚ_”r
("R—d E¼Ü¼¼¼¼¸!. sb_šdex=0x%x,†a¡_d©a_lun=%d.\n", 
sb
->
sb_šdex
, 
	`Ï¡_d©a_lun
(&sb->
sub_group
[0]));

833 
	`»move_sb_äom_ä“_blk_li¡
(
sdev
, 
sb
);

834 
sb
->
¡©e
 = 
RECOVER_ERR_BLOCK
;

835 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

837 } ià(
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
 && 
d©a_lun_is_em±y
) {

838 ià(
bÏnk_logicbs
 !ğ
sbio
->
logicbs
) {

839 
	`shªnÚ_šfo
("sb=%d, sbio->status=0x%x, sbio->logicbs=%d, data_logicbs=%d, blank_logicbs=%d.\n", \

840 
sb
->
sb_šdex
, 
sbio
->
¡©us
, sbio->
logicbs
, 
d©a_logicbs
, 
bÏnk_logicbs
);

841 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

842 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

843 
	`shªnÚ_šfo
("%s(): sb=%d,†un=%d,…ba=%d,ƒcc=0x%x.\n",

844 
__func__
, 
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
,„eq->pba.
lun
,„eq->pba.lun_pba,„eq->
_ecc
);

846 
	`shªnÚ_log
("Blank…age inƒpilog! Might…ower failure whenƒrase sb_index=%d,†ast_data_lun=%d.\n",

847 
sb
->
sb_šdex
, 
	`Ï¡_d©a_lun
(&sb->
sub_group
[0]));

848 
	`»move_sb_äom_ä“_blk_li¡
(
sdev
, 
sb
);

849 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

850 
	`shªnÚ_¥š_lock
(&
sdev
->
wa™_”a£d_lock
);

851 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
wa™_”a£d
);

852 
sdev
->
wa™_”a£d_blkút
++;

853 
	`shªnÚ_¥š_uÆock
(&
sdev
->
wa™_”a£d_lock
);

855 
	`debugs4
("sb(sb_šdex=%dèi bÏnk su³¸block.\n", 
sb
->
sb_šdex
);

857 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


858 
	`cİy_•og_buf
(
sdev
, 
sb
->
sb_šdex
, 
•og
);

860 
	`»move_sb_äom_ä“_blk_li¡
(
sdev
, 
sb
);

861 ià((
	`shªnÚ_mem_»adq
(&
•og
->
•og_h—d
->
h—d
.
•og_w©”m¬k
è!ğ
EPILOG_WATERMARK
) ||

862 ((
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
è!ğ
HOT_INDEX
è&& (shªnÚ_mem_»adw(&•og->•og_h—d->h—d.h—d_šdexè!ğ
COLD_INDEX
))) {

863 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

864 
sb
->
¡©e
 = 
RECOVER_ERR_BLOCK
;

865 
	`shªnÚ_”r
("sb_index=%d, watermark=0x%lx, head_index=%d!\n",

866 
sb
->
sb_šdex
, ()
	`shªnÚ_mem_»adq
(&
•og
->
•og_h—d
->
h—d
.
•og_w©”m¬k
),

867 
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
));

870 ià(
·r™y_is_em±y
)

871 
sb
->
»cov”_¡©us
 |ğ
NEED_RECLAIM
;

872 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
£qu’û_numb”_lock
);

873 ià(
	`shªnÚ_mem_»adq
(&
•og
->
•og_h—d
->
h—d
.
£q_num
è>ğ
sdev
->
£qu’û_numb”
)

874 
sdev
->
£qu’û_numb”
 = 
	`shªnÚ_mem_»adq
(&
•og
->
•og_h—d
->
h—d
.
£q_num
) + 1;

875 
	`»Œ›ve_sm¬t_äom_•og_h—d
(
sdev
, &
•og
->
•og_h—d
->
h—d
);

876 ià((
sdev
->
Ï¡_blk
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)] =ğ
NULL
) || \

877 (
sdev
->
Ï¡_blk
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)]->
£q_num
 < 
sb
->seq_num))

878 
sdev
->
Ï¡_blk
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)] = 
sb
;

879 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
£qu’û_numb”_lock
);

881 ià(
Ãed_»sÿn
 || 
·r™y_is_em±y
) {

882 
	`put_što_wa™_cİy_li¡
(
sb
);

884 ià(0 !ğ
	`»cov”_lm±
(
sb
, 
•og
)) {

885 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

886 
sb
->
¡©e
 = 
RECOVER_ERR_BLOCK
;

888 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) == 0) {

889 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

890 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_”a£d_lock
);

891 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
wa™_”a£d
);

892 
sdev
->
wa™_”a£d_blkút
++;

893 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_”a£d_lock
);

895 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)]);

896 
sb
->
¡©e
 = 
u£d_blk_¡©e
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)];

897 
	`add_to_li¡_by_£q_num
(
sb
, &
sdev
->
u£d_blocks
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)]);

898 
sdev
->
u£d_blkút
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)]++;

899 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
	`shªnÚ_mem_»adw
(&
•og
->
•og_h—d
->
h—d
.
h—d_šdex
)]);

906 ià(
sb
->
¡©e
 =ğ
RECOVER_ERR_BLOCK
) {

907 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
»cov”_”r_blocks
);

908 
sdev
->
»cov”_”r_blkút
++;

911 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

912 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

913 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

914 
	`ä“_»q
(
»q
);

916 
	`sb_ä“_•og
(
sb
);

917 
	`ä“_sbio
(
sbio
);

919 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

920 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

922 
__echo_out
;

923 
	}
}

925 
	$»ad_•og
(
shªnÚ_sb
 *
sb
)

927 
shªnÚ_bio
 *
sbio
;

928 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

929 
shªnÚ_»que¡
 *
»q
, *
tmp
;

930 
shªnÚ_•og
 *
•og
;

931 
sub_group
 *
group
;

932 
¡re
, 
·ge_¡res
, 
group_šdex
, 
lun
, 
lun_off£t
, 
lun_š_group
, 
¶ªe
, 
i
;

933 
logicbs_š_·ge_¡re
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
;

934 
sb_lun_pba
, 
logicbs_š_eblk
;

936 
__echo_š
;

937 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

938 
	`£t_sbio_debug_g
(
sbio
, 
READ_LAST_EPILOG_TAG
);

940 
•og
 = 
	`•og_®loc
(
sb
->
•og_size
, 
sdev
);

941 ià(
NULL
 =ğ
•og
) {

942 
	`shªnÚ_w¬n
("epilog_alloc failed, sleep 5ms‡ndry‡gain.\n");

943 
	`shªnÚ_m¦“p
(5);

945 } 
NULL
 =ğ
•og
);

946 
	`shªnÚ_mem_wr™eq
(0, &
•og
->
•og_h—d
->
h—d
.
•og_w©”m¬k
);

947 
sb
->
•og
 =ƒpilog;

948 
·ge_¡res
 = (
sb
->
logicbs_š_•og
 + 
logicbs_š_·ge_¡re
 - 1) /†ogicbs_in_page_stripe;

949 ià(
sdev
->
¿id5_suµÜ‹d
)

950 
sbio
->
logicbs
 = 
·ge_¡res
 * (
logicbs_š_·ge_¡re
 + 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_chunk
);

952 
sbio
->
logicbs
 = 
·ge_¡res
 * 
logicbs_š_·ge_¡re
;

953 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

954 
sbio
->
ÿÎback
 = 
»ad_•og_ÿÎback
;

955 
sbio
->
may_¦“p_š_ÿÎback
 = 99;

956 
sbio
->
d©a
 = 
sb
;

958 
sb_lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
;

959 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

960 
¡re
 = 
sdev
->
·ges_š_eblock
 - 
·ge_¡res
; stripe < sdev->pages_in_eblock; stripe++) {

961 
group_šdex
 = 0; group_šdex < 
sdev
->
·r™y_groups
; group_index++) {

962 
group
 = &
sb
->
sub_group
[
group_šdex
];

963 ià(
group
->
phy_šdex
 < 0)

965 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

966 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

967 
lun_š_group
 = 0;

969 ià(
lun_š_group
 =ğ
sb
->
mš_d©a_luns
) {

970 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

971 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

974 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

975 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

976 } 
	`is_bad_lun
(
sb
, 
lun
));

979 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

980 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

981 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

982 
	`£t_»q_debug_g
(
»q
, 
READ_LAST_EPILOG_TAG
, 0);

983 
»q
->
İcode
 = 
sh_cmd_»ad
;

984 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

985 
»q
->
lba
 = 
LONG_INVALID_LBA
;

986 
»q
->
pba
.
lun
 =†un;

987 
»q
->
pba
.
lun_pba
 = 
sb_lun_pba
 + 
¶ªe
 * 
logicbs_š_eblk
 + 
¡re
 * 
sdev
->
logicbs_š_·ge
 + 
i
;

988 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

989 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

990 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

991 
	`shªnÚ_”r
("dma_map_single failed!.\n");

992 
dma_çed
;

994 
»q
->
sbio
 = sbio;

995 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

996 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

997 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

1001 
lun_š_group
++;

1002 } 
lun_off£t
 !ğ
group
->
·r™y_lun_off£t
);

1006 
	`shªnÚ_pick_»que¡
(
sdev
, 0xffffffff);

1008 
__echo_out
;

1012 
dma_çed
:

1013 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1014 
	`ä“_»q
(
»q
);

1015 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1016 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1017 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1018 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1019 
	`ä“_»q
(
»q
);

1021 
	`ä“_sbio
(
sbio
);

1022 
	`sb_ä“_•og
(
sb
);

1024  -
ENOMEM
;

1025 
	}
}

	@shannon_err_handler.c

12 
	~"shªnÚ.h
"

15 
	$sb_m¬k_”rÜ_lun
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun
, 
¶ªe
)

17 
shªnÚ_lun
 *
luÅ
 = 
dev
->
lun
[lun];

18 
šdex
, 
off£t
;

19 
b™s
 = (*
sb
->
”rÜ_lun
)*8;

21 
šdex
 = (
lun
 * 
dev
->
¶ªes
è/ 
b™s
;

22 
off£t
 = (
lun
 * 
dev
->
¶ªes
è% 
b™s
;

24 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
off£t
 + 
¶ªe
, 
sb
->
”rÜ_lun
 + 
šdex
) == 0) {

25 
	`shªnÚ_©omic_šc
(&
luÅ
->
”r_blocks
);

26 ià(
dev
->
”r_check_debug
)

27 
	`debugs0
("%s:†un=%d,ƒ¼_blocks=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
lun
, 
	`shªnÚ_©omic_»ad
(&
luÅ
->
”r_blocks
));

28 ià(
dev
->
su¥icious_bad_lun_šdiÿtÜ
 && (
	`shªnÚ_©omic_»ad
(&
luÅ
->
”r_blocks
) >= dev->suspicious_bad_lun_indicator)) {

29 ià((
luÅ
->
bad
 =ğ1è|| 
	`shªnÚ_‹¡_b™
ÖuÅ->
phy_lun_num
, (*)
dev
->
mbr
.
bad_phy_lun_m­
))

31 ià(!
	`shªnÚ_‹¡_ªd_£t_b™
(
lun
, (*)
dev
->
”r_check_b™m­
)) {

32 
luÅ
->
su¥icious_bad_lun
 = 1;

33 ià(
dev
->
”r_check_debug
)

34 
	`debugs0
("%s: s¹ checkšg†un=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
lun
);

36 
	`shªnÚ_queue_wÜk
(
dev
->
misc_wq
, &
luÅ
->
”r_checkšg_wÜk
);

40 
	}
}

42 
	$sb_ş—r_”rÜ_lun
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun
, 
¶ªe
)

44 
shªnÚ_lun
 *
luÅ
 = 
dev
->
lun
[lun];

45 
šdex
, 
off£t
;

46 
b™s
 = (*
sb
->
”rÜ_lun
)*8;

48 
šdex
 = (
lun
 * 
dev
->
¶ªes
è/ 
b™s
;

49 
off£t
 = (
lun
 * 
dev
->
¶ªes
è% 
b™s
;

51 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™
(
off£t
 + 
¶ªe
, 
sb
->
”rÜ_lun
 + 
šdex
)) {

52 ià(
dev
->
”r_check_debug
)

53 
	`debugs0
("%s:†un=%d,ƒ¼_blocks=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
lun
, 
	`shªnÚ_©omic_»ad
(&
luÅ
->
”r_blocks
));

54 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
luÅ
->
”r_blocks
)) {

55 ià(
luÅ
->
su¥icious_bad_lun
 && 
	`shªnÚ_‹¡_ªd_ş—r_b™
(
lun
, (*)
dev
->
”r_check_b™m­
)) {

56 ià(
dev
->
”r_check_debug
)

57 
	`debugs0
("%s:ƒ¼ checkšg‡gaš !!!†un=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
lun
);

59 
	`shªnÚ_queue_wÜk
(
dev
->
misc_wq
, &
luÅ
->
”r_checkšg_wÜk
);

63 
	}
}

65 
	$is_”rÜ_lun
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun
, 
¶ªe
)

67 
šdex
, 
off£t
;

68 
b™s
 = (*
sb
->
”rÜ_lun
)*8;

70 
šdex
 = (
lun
 * 
dev
->
¶ªes
è/ 
b™s
;

71 
off£t
 = (
lun
 * 
dev
->
¶ªes
è% 
b™s
;

73  
	`shªnÚ_‹¡_b™
(
off£t
 + 
¶ªe
, 
sb
->
”rÜ_lun
 + 
šdex
);

74 
	}
}

76 
	$sb_m¬k_”rÜ_lun_bad
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
)

78 
lun
, 
¶ªe
;

80 
lun
 = 0;†uÀ< 
dev
->
lun_couÁ
;†un++) {

81 
¶ªe
 = 0;…ÏÃ < 
dev
->
¶ªes
;…lane++) {

82 ià(
	`is_”rÜ_lun
(
dev
, 
sb
, 
lun
, 
¶ªe
)) {

83 
	`debugs1
("sb=%d,†un=%d,…ÏÃ=%d.\n", 
sb
->
sb_šdex
, 
lun
, 
¶ªe
);

84 
	`sb_m¬k_bad_lun
(
sb
, 
lun
);

88 
	}
}

90 
	$m¬k_sb_”r_fÜ_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
)

92 
shªnÚ_sb
 *
sb
;

93 
¶ªe
, 
i
;

95 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

96 
sb
 = 
sdev
->
sbs
 + 
i
;

97 ià(
	`shªnÚ_‹¡_b™
(
lun
->
lun_num
, 
sb
->
bad_lun
))

99 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

100 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
lun
->
lun_num
, 
¶ªe
)) {

101 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
lun
->
lun_num
, 
¶ªe
);

104 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
) == 0)

105 
	`shªnÚ_©omic_šc
(&
sdev
->
³ndšg_”r_blks
);

107 
	}
}

109 
	$sb_m¬k_bad_lun
(
shªnÚ_sb
 *
sb
, 
lun_num
)

111 
šdex
, 
off£t
;

112 
b™s
 = (*
sb
->
bad_lun
)*8;

113 
sub_group
 *
group
 = &
sb
->sub_group[
lun_num
/sb->
sdev
->
max_luns_š_group
];

115 
šdex
 = 
lun_num
/
b™s
;

116 
off£t
 = 
lun_num
%
b™s
;

117 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
off£t
, 
sb
->
bad_lun
 + 
šdex
) == 0) {

118 
	`shªnÚ_©omic_dec
(&
sb
->
avaabË_luns
);

119 ià(
	`shªnÚ_©omic_dec_»tuº
(&
group
->
avaabË_luns
) == 3) {

120 
group
->
phy_šdex
 = -1;

121 
	`shªnÚ_©omic_dec
(&
sb
->
avaabË_groups
);

123 ià(
sb
->
sb_šdex
 >ğsb->
sdev
->
mbr_eblocks
/sb->sdev->
¶ªes
) {

124 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sb
->
sdev
->
lun
[
lun_num
]->
ava_d©a_sbs
)) {

125 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

126 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
lun_num
];

127 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
lun
->
phy_lun_num
, (*)
sdev
->
mbr
.
bad_phy_lun_m­
) == 0) {

128 
lun
->
bad
 = 1;

129 
	`shªnÚ_šfo
("£ˆbad_phy_lun_m­:†un=%d,…hy_lun_num=%d.\n", 
lun
->
lun_num
,†un->
phy_lun_num
);

130 ià(
sdev
->
š™_dÚe
 >ğ
STAGE9_DONE
) {

131 
	`shªnÚ_queue_wÜk
(
sdev
->
»äesh_wq
, &sdev->
»äesh_wÜk
);

132 
sdev
->
»äesh_£qu’û
 = sdev->
pow”_Ú_£cÚds
 / 
MBR_REFRESH_INTERVAL
;

133 
	`shªnÚ_šfo
("%s:»äesh_£qu’û=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, sdev->
»äesh_£qu’û
);

139 
	}
}

141 
	$m¬k_bad_block_dev
(
shªnÚ_dev
 *
dev
, 
lun
, 
sb_šdex
)

143 
	`sb_m¬k_bad_lun
(
dev
->
sbs
 + 
sb_šdex
, 
lun
);

144 
	}
}

146 
	$is_bad_lun
(
shªnÚ_sb
 *
sb
, 
lun
)

148 
šdex
, 
off£t
;

149 
b™s
 = (*
sb
->
bad_lun
)*8;

151 
šdex
 = 
lun
/
b™s
;

152 
off£t
 = 
lun
%
b™s
;

154  
	`shªnÚ_‹¡_b™
(
off£t
, 
sb
->
bad_lun
 + 
šdex
);

155 
	}
}

157 
	$is_¡©ic_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

159  
	`shªnÚ_‹¡_b™
(
lun
, (*)
sdev
->
¡©ic_bad_lun_m­
);

160 
	}
}

162 
	$is_bad_block_dev
(
shªnÚ_dev
 *
dev
, 
lun
, 
sb_šdex
)

164  
	`is_bad_lun
(
dev
->
sbs
 + 
sb_šdex
, 
lun
);

165 
	}
}

167 
	$m¬k_su³r_block_bad
(
shªnÚ_sb
 *
sb
)

169 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

170 
i
;

172 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++)

173 
	`sb_m¬k_bad_lun
(
sb
, 
i
);

174 
	}
}

176 
	$»ad_su¥icious_bad_lun_ÿÎback
(
shªnÚ_bio
 *
sbio
)

178 
shªnÚ_lun
 *
lun
 = (shªnÚ_luÀ*)
sbio
->
d©a
;

179 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

180 
sb_šdex
 = 0;

181 
shªnÚ_»que¡
 *
tmp
, *
»q
 = 
NULL
;

183 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

184 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

186 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

188 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

189 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
,

190 
sdev
->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

191 
sb_šdex
 = 
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
;

192 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

193 
	`ä“_»q
(
»q
);

196 
	`ä“_sbio
(
sbio
);

198 
lun
->
¡¬t_sb
 = 
sb_šdex
 + 1;

199 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &
lun
->
»ad_su¥icious_bad_lun_wÜk
);

200 
	}
}

202 
	$»ad_su¥icious_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
,

203 
sb_šdex
)

205 
i
, 
¶ªe
;

206 
shªnÚ_sb
 *
sb
;

207 
shªnÚ_bio
 *
sbio
;

208 
shªnÚ_»que¡
 *
»q
;

210 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
 || sdev->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
))) {

211 
	`shªnÚ_¥š_lock
(&
lun
->
check_lock
);

212 
lun
->
”r_checkšg
 = 0;

213 
	`shªnÚ_¥š_uÆock
(&
lun
->
check_lock
);

217 
i
 = 
sb_šdex
; i < 
sdev
->
sb_couÁ
; i++) {

218 ià(
i
 < 
sdev
->
mbr_eblocks
/sdev->
¶ªes
)

220 
sb
 = &
sdev
->
sbs
[
i
];

221 ià(
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
 || sb->¡©=ğ
COLD_BLOCK_LIST
) {

223 ià(
	`is_bad_lun
(
sb
, 
lun
->
lun_num
))

231 ià(
i
 =ğ
sdev
->
sb_couÁ
) {

232 
	`shªnÚ_log
("checkšg fÜ†uÀ%d fšished\n", 
lun
->
lun_num
);

233 
	`shªnÚ_¥š_lock
(&
lun
->
check_lock
);

234 
lun
->
”r_checkšg
 = 0;

235 
	`shªnÚ_¥š_uÆock
(&
lun
->
check_lock
);

239 ià(
sdev
->
”r_check_debug
)

240 
	`debugs0
("%s: check†un=%d, sb=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun
->
lun_num
, 
i
);

242 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

243 
sbio
->
logicbs
 = 0;

244 
sbio
->
ÿÎback
 = 
»ad_su¥icious_bad_lun_ÿÎback
;

245 
sbio
->
d©a
 = 
lun
;

246 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

247 
sbio
->
logicbs
 = 
sdev
->
¶ªes
;

248 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

250 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

251 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

252 
	`£t_»q_debug_g
(
»q
, 
BAD_LUN_CHECKING_TAG
, 
¶ªe
);

253 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

254 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

255 
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

256 
	`shªnÚ_”r
("dma_map_single failed!\n");

257 
	`shªnÚ_m¦“p
(100);

258 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

260 
»q
->
sbio
 = sbio;

261 
»q
->
İcode
 = 
sh_cmd_»ad
;

262 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

263 
»q
->
lba
 = 
LONG_INVALID_LBA
;

264 
»q
->
pba
.
lun
 =†un->
lun_num
;

265 
»q
->
pba
.
lun_pba
 = 
sdev
->
logicbs_š_siblšg_eblock
 * 
i
 + sdev->
logicbs_š_eblock
 * 
¶ªe
 + sdev->
logicbs_š_·ge
;

266 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

267 
	`add_lun_»que¡_queue_
(
lun
, 
»q
);

270 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &
lun
->
lun£t
->
subm™_wÜk
);

271 
	}
}

273 
	$»ad_su¥icious_bad_lun_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

275 
shªnÚ_lun
 *
lun
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_lun, 
»ad_su¥icious_bad_lun_wÜk
);

276 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

278 
	`»ad_su¥icious_bad_lun
(
sdev
, 
lun
,†un->
¡¬t_sb
);

279 
	}
}

281 
	$shªnÚ_lun_”r_checkšg_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

283 
shªnÚ_lun
 *
lun
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_lun, 
”r_checkšg_wÜk
);

284 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

286 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
 || sdev->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)))

289 
	`shªnÚ_¥š_lock
(&
lun
->
check_lock
);

290 ià(
lun
->
”r_checkšg
) {

291 
	`shªnÚ_¥š_uÆock
(&
lun
->
check_lock
);

294 
lun
->
”r_checkšg
 = 1;

295 
	`shªnÚ_¥š_uÆock
(&
lun
->
check_lock
);

296 
	`shªnÚ_log
("wakšg u°checkšgask fÜ†uÀ%d\n", 
lun
->
lun_num
);

298 
lun
->
¡¬t_sb
 = 0;

299 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &
lun
->
»ad_su¥icious_bad_lun_wÜk
);

300 
	}
}

302 
	$£t_Ãw_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
)

304 
group_šdex
 = 
lun
->
lun_num
 / 
sdev
->
max_luns_š_group
;

305 
	`shªnÚ_šfo
("%s():‚ew_bad_lun=%d.\n", 
__func__
, 
lun
->
lun_num
);

306 
lun
->
bad
 = 1;

307 ià(
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] == 0)

308 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] = 
lun
->
lun_num
 + 1;

309 ià(
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] !ğ(
lun
->
lun_num
 + 1))

310 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] = ~0;

311 
sdev
->
Ãw_bad_lun
->
bad_lun_æag
 |ğsdev->Ãw_bad_lun->
group_bad_lun
[
group_šdex
];

312 
	}
}

314 
	$£t_fuÎ_dyÇmic_bad_blocks
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
)

316 
group_šdex
 = 
lun
->
lun_num
 / 
sdev
->
max_luns_š_group
;

318 ià(
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] == 0)

319 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] = 
lun
->
lun_num
 + 1;

320 ià(
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] !ğ(
lun
->
lun_num
 + 1)) {

321 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] = ~0;

323 
sdev
->
Ãw_bad_lun
->
bad_lun_æag
 |ğsdev->Ãw_bad_lun->
group_bad_lun
[
group_šdex
];

324 
	}
}

326 
	$move_blks_to_”r_blks_li¡
(
shªnÚ_dev
 *
sdev
)

328 
shªnÚ_sb
 *
sb
;

329 
i
;

331 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

332 
sb
 = 
sdev
->
sbs
 + 
i
;

334 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

335 ià((
sb
->
¡©e
 !ğ
HOT_BLOCK_LIST
è&& (sb->¡©!ğ
COLD_BLOCK_LIST
)) {

336 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

339 ià(!
	`shªnÚ_‹¡_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
)) {

340 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

344 ià(
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
) {

345 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

346 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

347 
sdev
->
u£d_blkút
[
HOT_INDEX
]--;

348 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

349 } ià(
sb
->
¡©e
 =ğ
COLD_BLOCK_LIST
) {

350 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


351 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

353 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

354 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

355 
sdev
->
u£d_blkút
[
COLD_INDEX
]--;

356 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

358 
	`BUG
();

359 
sb
->
¡©e
 = 
ERROR_BLOCK
;

360 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
”r_blks_lock
);

361 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
”r_blks
);

362 
sdev
->
”r_blkút
++;

363 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
”r_blks_lock
);

364 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

365 
	`shªnÚ_šfo
("%s: change sb=%do‚ew state %d.\n",

366 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
ERROR_BLOCK
);

368 
	}
}

370 
	$eblk_is_bad_block
(
shªnÚ_lun
 *
lun
, 
eblk
)

372 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

373 
u16
 *
bbt
 = 
lun
->bbt;

374 
i
 = 0;

376 ià(
	`bbt_usšg_b™m­
(
bbt
, 
sdev
)) {

377 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

378 ià(
sdev
->
p£udo_¶ªe
)

379  
	`shªnÚ_‹¡_b™_Ë
(
eblk
 / 
sdev
->
¶ªes
, (*)
lun
->
bbt
);

381  
	`shªnÚ_‹¡_b™_Ë
(
eblk
, (*)
lun
->
bbt
);

383  
	`shªnÚ_‹¡_b™_Ë
(
eblk
, (*)((
u64
 *)
lun
->
bbt
 + 1));

385 
bbt
[
i
] != 0xFFFF) {

386 ià(
bbt
[
i
] =ğ
eblk
)

388 
i
++;

393 
	}
}

395 
	$®l_mbr_block_¬e_bad
(
shªnÚ_lun
 *
lun
)

397 
eblk
;

399 
eblk
 = 0;ƒblk < 
lun
->
sdev
->
mbr_eblocks
;ƒblk++)

400 ià(!
	`eblk_is_bad_block
(
lun
, 
eblk
))

404 
	}
}

406 
	$add_bad_eblk_to_lun_bbt
(
shªnÚ_lun
 *
lun
, 
bad_eblk
)

408 ià(
lun
->
bad_blk_couÁ
 >ğ2048 && !
	`bbt_usšg_b™m­
Öun->
bbt
,†un->
sdev
)) {

409 
i
;

410 
u16
 *
tmp_bbt
 = 
	`shªnÚ_km®loc
(
LUN_BBT_SIZE
, 
GFP_ATOMIC
);

411 ià(!
tmp_bbt
) {

412 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for bbt switcho bitmap.\n");

414 
	`shªnÚ_¥š_lock_bh
(&
lun
->
bbt_lock
);

415 ià(!
	`bbt_usšg_b™m­
(
lun
->
bbt
,†un->
sdev
)) {

416 
	`shªnÚ_memıy
(
tmp_bbt
, 
lun
->
bbt
, 
LUN_BBT_SIZE
);

417 
	`shªnÚ_mem£t
(
lun
->
bbt
, 0, 
LUN_BBT_SIZE
);

418 ((
u64
 *)
lun
->
bbt
)[0] = 
BBT_BITMAP_WATERMARK
;

419 
i
 = 0; i < 
lun
->
bad_blk_couÁ
; i++)

420 
	`shªnÚ_£t_b™_Ë
(
tmp_bbt
[
i
] + 64, 
lun
->
bbt
);

422 
	`shªnÚ_¥š_uÆock_bh
(&
lun
->
bbt_lock
);

423 
	`shªnÚ_kä“
(
tmp_bbt
);

427 
	`shªnÚ_¥š_lock_bh
(&
lun
->
bbt_lock
);

428 ià(
	`eblk_is_bad_block
(
lun
, 
bad_eblk
)) {

429 
	`shªnÚ_¥š_uÆock_bh
(&
lun
->
bbt_lock
);

432 ià(
	`bbt_usšg_b™m­
(
lun
->
bbt
,†un->
sdev
)) {

433 ià(
	`shªnÚ_dev_is_g5
(
lun
->
sdev
)) {

434 ià(
lun
->
sdev
->
p£udo_¶ªe
)

435 
	`shªnÚ_£t_b™_Ë
(
bad_eblk
 / 
lun
->
sdev
->
¶ªes
,†un->
bbt
);

437 
	`shªnÚ_£t_b™_Ë
(
bad_eblk
, 
lun
->
bbt
);

439 
	`shªnÚ_£t_b™_Ë
(
bad_eblk
 + 64, 
lun
->
bbt
);

440 
lun
->
bad_blk_couÁ
++;

442 
lun
->
bbt
[lun->
bad_blk_couÁ
++] = 
bad_eblk
;

443 
lun
->
bbt
[lun->
bad_blk_couÁ
] = 0xFFFF;

445 
	`shªnÚ_¥š_uÆock_bh
(&
lun
->
bbt_lock
);

447 
	}
}

449 
	$add_dyÇmic_bbt_ÿÎback
(
shªnÚ_bio
 *
sbio
)

451 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

452 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

453 
shªnÚ_»que¡
 *
»q
, *
tmp
;

454 
ä“_æag
 = ()
sbio
->
d©a2
;

456 
	`debugs1
("sb=%d,†ogicbs=%d.\n", 
sb
->
sb_šdex
, 
sbio
->
logicbs
);

457 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

458 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

459 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

460 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

461 
	`ä“_»q
(
»q
);

463 
	`ä“_sbio
(
sbio
);

465 ià(
ä“_æag
 && (
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
)) {

466 
	`add_sb_to_ä“_li¡
(
sdev
, 
sb
);

468 
	}
}

470 
	$»cÜd_bad_block
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
, 
bad_eblk
)

472 ià(
	`add_bad_eblk_to_lun_bbt
(
lun
, 
bad_eblk
) < 0)

475 
	`shªnÚ_©omic_šc
(&
sdev
->
dyÇmic_bad_blkút
);

476 
	`shªnÚ_©omic_šc
(&
lun
->
dyÇmic_bad_blkút
);

478 ià(
sdev
->
”r_check_debug
)

479 
	`shªnÚ_šfo
("dyÇmiøbad block: %s:lun=%d,ƒblk=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun
->
lun_num
, 
bad_eblk
);

481 ià((
bad_eblk
 < 
sdev
->
mbr_eblocks
è&& 
	`®l_mbr_block_¬e_bad
(
lun
)) {

482 
	`shªnÚ_šfo
("®Èmb¸block š†uÀ%d‡» brok’.\n", 
lun
->
lun_num
);

483 
	`£t_Ãw_bad_lun
(
sdev
, 
lun
);

484 
	`m¬k_sb_”r_fÜ_bad_lun
(
sdev
, 
lun
);

485 
	`move_blks_to_”r_blks_li¡
(
sdev
);

486 
	`check_”r_blkút_šc
(
sdev
);

489 
	}
}

491 
lun_»äesh_mbr_eblks
(
shªnÚ_lun
 *
lun
);

493 
	$lun_add_dyÇmic_bbt
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_lun
 *
lun
, 
bad_eblk
)

495 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

496 
shªnÚ_»que¡
 *
»q
, *
fœ¡_»q
;

497 
shªnÚ_poŞ
 *
¥oŞ
;

498 
eblk
, 
i
, 
cu¼’t_·ge
;

500 ià(
	`»cÜd_bad_block
(
sdev
, 
lun
, 
bad_eblk
) < 0)

504 ià(
bad_eblk
 < 
sdev
->
mbr_eblocks
)

507 
	`shªnÚ_mu‹x_lock
(&
lun
->
»äesh_£m
);

508 ià(
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
è> 
LUN_REFRESH_MBR_THRESHOLD
) {

509 
	`lun_»äesh_mbr_eblks
(
lun
);

510 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
»äesh_£m
);

514 
cu¼’t_·ge
 = 
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
);

515 
	`shªnÚ_©omic_šc
(&
lun
->
Ãxt_em±y_·ge
);

517 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_·ge
 * sdev->
mbr_eblocks
, &
sbio
->
u£r_couÁ
);

518 
sbio
->
logicbs
 +ğ
sdev
->
logicbs_š_·ge
 * sdev->
mbr_eblocks
;

520 
eblk
 = 0;ƒblk < 
sdev
->
mbr_eblocks
;ƒblk++) {

521 
fœ¡_»q
 = 
NULL
;

522 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

523 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

524 
	`£t_»q_debug_g
(
»q
, 
ADD_BBT_TO_MBR_TAG
, 
i
);

525 
»q
->
İcode
 = 
sh_cmd_wr™e
;

526 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

527 
»q
->
h—d
 = 
MBR_HEAD
;

528 
»q
->
d©©y³
 = 
SHORT_LBA
;

529 
»q
->
lba
 = 
MBR_WATERMARK
;

530 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
è| (»q->
lba
 & 
LONG_LBA_MASK
);

531 
»q
->
pba
.
lun
 =†un->
lun_num
;

532 
»q
->
pba
.
lun_pba
 = 
eblk
 * 
sdev
->
·ges_š_eblock
 * sdev->
logicbs_š_·ge
 + \

533 
cu¼’t_·ge
 * 
sdev
->
logicbs_š_·ge
 + 
i
;

534 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

535 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0xFF, 
sdev
->
logicb_size
);

536 
	`shªnÚ_mem_wr™ew
(
bad_eblk
, 
»q
->
vœt_addr
);

537 
»m­
:

538 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

539 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

540 
	`shªnÚ_w¬n
("shannon_dma_map_singleƒrror.\n");

541 
	`shªnÚ_m¦“p
(5 * 
	`g‘_HZ
());

542 
»m­
;

544 
»q
->
sbio
 = sbio;

545 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

546 ià(
i
 == 0) {

547 
fœ¡_»q
 = 
»q
;

548 
	`SHANNON_INIT_LIST_HEAD
(&
fœ¡_»q
->
chunk_li¡
);

550 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
fœ¡_»q
->chunk_list);

553 
	`shªnÚ_mu‹x_lock
(&
lun
->
lun£t
->
sq_£m
);

554 
	`__shªnÚ_wr™e_cmd
(
lun
->
lun£t
, 
fœ¡_»q
);

555 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
lun£t
->
sq_£m
);

556 
	`upd©e_lun£t_sq_h—d
(
lun
->
lun£t
);

559 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
»äesh_£m
);

561 
sdev
->
ov”´ovisiÚ_¿‹
 = 
	`ÿlcuÏ‹_ov”´ovisiÚ_¿‹
(sdev);

562 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

563 ià(
¥oŞ
) {

564 
»t
 = 
	`ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
¥oŞ
);

565 ià((
»t
 =ğ0è&& (
¥oŞ
->
ov”´ovisiÚ
 < 
SHN_OVERPROVISION_THRESHOLD
)) {

566 
	`shªnÚ_w¬n
("pool overprovision is below %d%% dueo dynamic bad block, set…ool„eadonly.\n",

567 
SHN_OVERPROVISION_THRESHOLD
/100);

568 
	`shªnÚ_£t_b™
(
SHN_REASON_LOW_OVERPROVISION
, &
¥oŞ
->
»adÚly_»asÚ
);

569 
	`¥oŞ_upd©e_acûss_mode
(
¥oŞ
);

571 
	`¥oŞ_put_»ã»nû
(
¥oŞ
);

574 ià(
sdev
->
ov”´ovisiÚ_¿‹
 < 
SHN_OVERPROVISION_THRESHOLD
) {

575 
	`shªnÚ_w¬n
("overprovision is below %d%% dueo dynamic bad block, set disk„eadonly.\n",

576 
SHN_OVERPROVISION_THRESHOLD
/100);

577 
	`shªnÚ_£t_b™
(
SHN_REASON_LOW_OVERPROVISION
, &
sdev
->
»adÚly_»asÚ
);

578 
	`upd©e_acûss_mode
(
sdev
);

582 
	}
}

584 
	$add_dyÇmic_bbt
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
ä“_æag
)

586 
lun
, 
¶ªe
;

587 
shªnÚ_bio
 *
sbio
;

589 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

590 
	`£t_sbio_debug_g
(
sbio
, 
ADD_BBT_TO_MBR_TAG
);

591 
sbio
->
ÿÎback
 = 
add_dyÇmic_bbt_ÿÎback
;

592 
sbio
->
d©a
 = 
sb
;

593 
sbio
->
d©a2
 = (*)
ä“_æag
;

596 
sbio
->
logicbs
 = 1;

597 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

599 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

600 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

601 ià(
	`is_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
)) {

602 
	`shªnÚ_šfo
("add_dynamic_bbt(): %s: sb=%d,†un=%d,…lane=%d.\n",

603 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
lun
, 
¶ªe
);

604 
	`lun_add_dyÇmic_bbt
(
sbio
, 
sdev
->
lun
[lun], 
sb
->
sb_šdex
 * sdev->
¶ªes
 + 
¶ªe
);

605 
	`sb_ş—r_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
);

610 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

611 
	}
}

614 
	$check_”r_blkút_šc
(
shªnÚ_dev
 *
sdev
)

616 ià(
sdev
->
”r_blkút
 == 0)

619 ià(
sdev
->
»cov”_th»ad
)

620 
	`shªnÚ_wake_up_´oûss
(
sdev
->
»cov”_th»ad
);

622 ià(
sdev
->
”r_blkút
 > 5) {

624 
	`shªnÚ_£t_b™
(
SHN_REASON_MANY_BAD_BLOCKS
, &
sdev
->
»duûd_wr™e_»asÚ
);

625 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
acûss_mode_wÜk
);

627 
	}
}

629 
	$check_”r_blkút_dec
(
shªnÚ_dev
 *
sdev
)

631 ià(
sdev
->
”r_blkút
 == 0) {

632 
	`shªnÚ_ş—r_b™
(
SHN_REASON_MANY_BAD_BLOCKS
, &
sdev
->
»duûd_wr™e_»asÚ
);

633 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
acûss_mode_wÜk
);

635 
	}
}

637 
šlše
 
	$__add_sb_to_”r_blks_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

639 
	`shªnÚ_šfo
("%s: chªgsb=%d s‹=%dØ%d.\n", 
sdev
->
sdisk
.
disk_Çme
,

640 
sb
->
sb_šdex
, sb->
¡©e
, 
ERROR_BLOCK
);

641 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
”r_blks_lock
);

642 
sb
->
¡©e
 = 
ERROR_BLOCK
;

644 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
) == 0) {

645 ià(
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
)

646 
	`shªnÚ_©omic_šc
(&
sdev
->
³ndšg_”r_blks
);

648 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
”r_blks
);

649 
sdev
->
”r_blkút
++;

650 
	`check_”r_blkút_šc
(
sdev
);

651 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
”r_blks_lock
);

652 
	}
}

654 
	$hªdË_wr™e_”rÜ
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
shªnÚ_cmd_šfo
 *
šfo
)

656 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
) == 0) {

657 ià(
sb
->
sb_šdex
 >ğ
dev
->
mbr_eblocks
/dev->
¶ªes
)

658 
	`shªnÚ_©omic_šc
(&
dev
->
³ndšg_”r_blks
);

660 
	}
}

662 
	$»şaim_»ad_”rÜ_sb
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

664 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

665 ià((
sb
->
¡©e
 !ğ
HOT_BLOCK_LIST
è&& (sb->¡©!ğ
COLD_BLOCK_LIST
)) {

666 
	`shªnÚ_šfo
("%s: sb=%d, state=%d, in_write_logicbs=%d.\n",

667 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, sb->
¡©e
, 
	`shªnÚ_©omic_»ad
(&sb->
š_wr™e_logicbs
));

668 
out
;

670 ià(
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
) {

671 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

672 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

673 
sdev
->
u£d_blkút
[
HOT_INDEX
]--;

674 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

675 } ià(
sb
->
¡©e
 =ğ
COLD_BLOCK_LIST
) {

676 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


677 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

679 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

680 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

681 
sdev
->
u£d_blkút
[
COLD_INDEX
]--;

682 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

684 
	`__add_sb_to_”r_blks_li¡
(
sdev
, 
sb
);

685 
out
:

686 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

687 
	}
}

689 
	$check_»»ad_çed_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

691 
shªnÚ_poŞ
 *
¥oŞ
 = 
NULL
;

692 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

693 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

694 
shªnÚ_sb
 *
sb
;

695 
lun
, 
»t
;

697 ià(
	`lÚg_lba_is_šv®id
(
»q
->
lba
)) {

699 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
)

700 
»q
->
sbio
->
¡©us
 |ğ
HAVE_BLANK_SECTOR
;

701 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

702 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

703 
»q
->
¡©e
 = 
REQ_DONE
;

704 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

707 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

708 ià(
¥oŞ
) {

709 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

710 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

711 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

712 
	`BUG
();

714 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

715 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

716 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

717 
	`BUG
();

719 
sdisk
 = &
ns
->sdisk;

722 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

723 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, 
NULL
, 
sdisk
);

724 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

725 ià(
»t
 < 0) {

726 
	`shªnÚ_log
("%s:†b¨%x i disÿrd‚ow. Ju¡ cË¬ iˆtØz”o.\n", 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
lba
);

728 
»q
->
_ecc
 = 0;

729 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0,„eq->
Ëngth
);

730 
»q
->
¡©e
 = 
REQ_DONE
;

731 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

732 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

735 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

736 
»q
->
£q_num
 = 
sb
->seq_num;

738 
»q
->
»»ad
 = 0;

739 
»q
->
»ad_luns_fÜ_»cov”
 = 0;

740 
»q
->
_ecc
 = 0;

741 
»q
->
_m‘ad©a
 = 0;

742 
lun
 = 
»q
->
pba
.lun;

743 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

744 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

745 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

748 
	}
}

750 
	$»q_is_š_aùive_chunks_¿nge
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
,

751 *
ph—d
)

753 
di¡
, 
h—d_šdex
;

754 
š_¿nge
 = 
sdev
->
dummy_wÜdlše
 ? sdev->dummy_wÜdlš: sdev->
sh¬ed_·ges
 * 2 - 1;

755 
sb_šdex
 = 
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
;

756 
chunk
 = (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
;

758 ià(
sb_šdex
 =ğ
sdev
->
wr_sb
[
HOT_INDEX
])

759 
h—d_šdex
 = 
HOT_INDEX
;

760 ià(
sdev
->
u£_du®_h—d
 && (
sb_šdex
 =ğsdev->
wr_sb
[
COLD_INDEX
]))

761 
h—d_šdex
 = 
COLD_INDEX
;

765 
di¡
 = 
sdev
->
wr_chunk
[
h—d_šdex
] - 
chunk
;

767 ià((0 <ğ
di¡
è&& (di¡ < 
š_¿nge
è&& (
sb_šdex
 =ğ
sdev
->
wr_sb
[
h—d_šdex
])) {

768 ià(
ph—d
)

769 *
ph—d
 = (
h—d_šdex
 =ğ
HOT_INDEX
è? 
HOT_HEAD
 : 
COLD_HEAD
;

774 
	}
}

776 
	$fl_th’_»ad_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

778 
shªnÚ_”rÜ_hªdËr
 *
hªdËr
 = 
	`cÚš”_of
(
wÜk
, shannon_error_handler, work);

779 
shªnÚ_dev
 *
sdev
 = 
hªdËr
->
dev
;

780 
shªnÚ_poŞ
 *
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

781 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

782 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

783 
shªnÚ_»que¡
 *
»q
 = 
hªdËr
->req;

784 
shªnÚ_sb
 *
sb
;

785 
lun_pba
†un_pba;

786 
»t
, 
lun
, 
fl
 = 0;

788 
	`BUG_ON
(
	`lÚg_lba_is_šv®id
(
»q
->
lba
));

789 ià(
¥oŞ
) {

790 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

791 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

792 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

793 
	`BUG
();

795 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

796 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

797 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

798 
	`BUG
();

800 
sdisk
 = &
ns
->sdisk;

804 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

805 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
lun_pba
, 
NULL
, 
sdisk
);

806 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

807 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

809 ià(
»t
 < 0) {

810 
	`shªnÚ_log
("%s:†b¨%x ha ®»ady b“Àov”wr™‹n.\n", 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
lba
);

811 
»q
->
¡©e
 = 
REQ_DONE
;

812 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

813 
	`shªnÚ_kä“
(
hªdËr
);

817 ià((
lun_pba
.lun_pb¨!ğ
»q
->
pba
.lun_pbaè|| (lun_pba.
lun
 !=„eq->pba.lun)) {

818 
	`shªnÚ_log
("%s:†ba=%ld has been„e-written: old†un=%d†un_pba=%d,‚ew†un=%d†un_pba=%d.\n",

819 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,†un_pba.lun,†un_pba.lun_pba);

820 
»q
->
pba
 = 
lun_pba
;

821 
fËd_»ad
;

824 ià(
	`»q_is_š_aùive_chunks_¿nge
(
sdev
, 
»q
, 
NULL
)) {

825 ià(
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
) {

826 
h—d
;

827 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

828 ià(
	`»q_is_š_aùive_chunks_¿nge
(
sdev
, 
»q
, &
h—d
)) {

829 
logicbs_út
 = 0, 
max_logicbs
;

830 
¡re_út
 = 
sdev
->
dummy_wÜdlše
 ? sdev->dummy_wÜdlš: (sdev->
sh¬ed_·ges
 - 1);

831 
sb
 = 
sdev
->
sbs
 + sdev->
wr_sb
[
h—d
 & 
HEAD_INDEX_MASK
];

832 
max_logicbs
 = 
¡re_út
 * (
sb
->
mš_d©a_luns
 * 
	`shªnÚ_©omic_»ad
(&sb->
avaabË_groups
è* 
sdev
->
logicbs_š_chunk
);

833 
	`shªnÚ_šfo
("fill‡ctive chunks:†ba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x, wr_sb=%d,"

835 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
, 
sdev
->
wr_sb
[
h—d
 & 
HEAD_INDEX_MASK
],

836 
sdev
->
wr_chunk
[
h—d
 & 
HEAD_INDEX_MASK
], sdev->
wr_group
[head & HEAD_INDEX_MASK], head);

837 
	`»q_is_š_aùive_chunks_¿nge
(
sdev
, 
»q
, &
h—d
è&& (
logicbs_út
 < 
max_logicbs
)) {

838 
	`£nd_dummy_»q
(
sdev
, 
h—d
);

839 
logicbs_út
++;

842 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

843 
fl
 = 1;

846 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

847 
»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

848 
»q
->
¡©e
 = 
REQ_DONE
;

849 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

850 
	`shªnÚ_kä“
(
hªdËr
);

855 
fËd_»ad
:

856 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

857 
»q
->
£q_num
 = 
sb
->seq_num;

858 
»q
->
»»ad
 &ğ~
REREAD_NUM_MASK
;

859 
»q
->
_ecc
 = 0;

860 
»q
->
_m‘ad©a
 = 0;

861 
lun
 = 
»q
->
pba
.lun;

862 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

863 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

865 ià(
fl
 && !
	`®l_»q_queue_is_em±y
(
sdev
))

866 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

868 
	`shªnÚ_kä“
(
hªdËr
);

869 
	}
}

871 
	$fl_th’_»ad_wÜk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

874 
shªnÚ_”rÜ_hªdËr
 *
hªdËr
 = 
	`shªnÚ_km®loc
((shªnÚ_”rÜ_hªdËr), 
GFP_ATOMIC
);

875 ià(
hªdËr
) {

876 
	`shªnÚ_š™_wÜk
(&
hªdËr
->
wÜk
, 
fl_th’_»ad_sk
);

877 
hªdËr
->
dev
 = 
sdev
;

878 
hªdËr
->
»q
 =„eq;

879 
	`shªnÚ_queue_wÜk
(
sdev
->
»ad_”r_wq
, &
hªdËr
->
wÜk
);

881 
	`shªnÚ_”r
("Allocate memory failed!\n");

882 
»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

883 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

884 
»q
->
¡©e
 = 
REQ_DONE
;

885 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

887 
	}
}

889 
£nd_¿id5_»cov”y_»q
(
shªnÚ_sb
 *
sb
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
, shªnÚ_»que¡ *
çed_»q
);

890 
	$¿id5_»cov”y_ÿÎback
(
shªnÚ_bio
 *
sbio
)

892 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

893 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

894 
shªnÚ_»que¡
 *
»q
, *
çed_»q
 = (shªnÚ_»que¡ *)
sbio
->
d©a2
;

895 
sub_group
 *
group
 = &
sb
->sub_group[
çed_»q
->
pba
.
lun
/
sdev
->
max_luns_š_group
];

896 
Ãxt_lun
, 
lun_off£t
;

898 
çed_»q
->
»ad_luns_fÜ_»cov”
++;

899 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

900 ià(
çed_»q
->
»cov”_buf
 =ğ
NULL
) {

901 
çed_»q
->
»cov”_buf
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

902 ià(
çed_»q
->
»cov”_buf
 =ğ
NULL
) {

903 
	`shªnÚ_”r
("cannot‡llocate memory for„ecover_buf!\n");

904 
çed_»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

905 
çed_»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

906 
çed_»q
->
¡©e
 = 
REQ_DONE
;

907 
	`sbio_»Ëa£
(
sdev
, 
çed_»q
->
sbio
);

908 
out
;

912 ià((
çed_»q
->
£q_num
 !ğ0è&& (çed_»q->£q_num !ğ
sb
->seq_num) && \

913 (
çed_»q
->
£q_num
 !ğ
MAX_SEQ_NUM
) && \

914 (
sdev
->
š™_dÚe
 >ğ
STAGE9_DONE
)) {

915 
	`shªnÚ_log
("%s():†ba=%d,†un=%d,†un_pba=%d, seq_num=0x%x, sb=%d, sb->seq_num=0x%x.\n",

916 
__func__
, 
çed_»q
->
lba
, faed_»q->
pba
.
lun
, faed_»q->pba.
lun_pba
,

917 
çed_»q
->
£q_num
, 
sb
->
sb_šdex
, sb->seq_num);

918 
çed_»q
->
»»ad
 &ğ~
RAID_READ_MASK
;

919 ià(
çed_»q
->
»cov”_buf
 !ğ
NULL
) {

920 
	`ä“_logicb_buf
(
sdev
, 
çed_»q
->
»cov”_buf
);

921 
çed_»q
->
»cov”_buf
 = 
NULL
;

923 
	`check_»»ad_çed_»q
(
sdev
, 
çed_»q
);

924 
ä“
;

927 ià(
çed_»q
->
£q_num
 =ğ
MAX_SEQ_NUM
)

928 
çed_»q
->
£q_num
 = 
sb
->seq_num;

930 ià(
sbio
->
¡©us
) {

931 
çed_»q
->
»»ad
 &ğ~
RAID_READ_MASK
;

932 ià(
çed_»q
->
»cov”_buf
 !ğ
NULL
) {

933 
	`ä“_logicb_buf
(
sdev
, 
çed_»q
->
»cov”_buf
);

934 
çed_»q
->
»cov”_buf
 = 
NULL
;

940 ià((
sb
->
¡©e
 =ğ
WAIT_ERASE_BLOCK
è|| (sb->¡©=ğ
DISCARDED_BLOCK
) || \

941 ((
sb
->
¡©e
 =ğ
FREE_BLOCK
è&& (
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
))) {

942 
	`check_»»ad_çed_»q
(
sdev
, 
çed_»q
);

944 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

945 
çed_»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

946 
çed_»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

947 
	`shªnÚ_”r
("%s:„aid5_recovery failed! sethe failed_req's ECCo 0xF2,†ba=0x%lx,†un=%d,†un_pba=%d.\n",

948 
sdev
->
sdisk
.
disk_Çme
, 
çed_»q
->
lba
, faed_»q->
pba
.
lun
, faed_»q->pba.
lun_pba
);

949 
	`shªnÚ_”r
("... because %s: sb_index=%d, state=0x%x,†un=%d,†un_pba=%d,ƒcc=0x%x.\n",

950 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, sb->
¡©e
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
);

952 
çed_»q
->
¡©e
 = 
REQ_DONE
;

953 
	`sbio_»Ëa£
(
sdev
, 
çed_»q
->
sbio
);

956 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

957 
	`__shªnÚ_b™m­_xÜ
(
çed_»q
->
»cov”_buf
, faed_»q->»cov”_buf, 
»q
->
vœt_addr
, 
sdev
->
logicb_size
 * 8);

958 
çed_»q
->
_m‘ad©a
 = 
»q
->_metadata ^ failed_req->_metadata;

960 ià(
çed_»q
->
»ad_luns_fÜ_»cov”
 =ğ
sb
->
mš_d©a_luns
) {

962 
çed_»q
->
_ecc
 = 0;

963 ià(
	`decom´ess_m‘ad©a
(
çed_»q
)) {

964 
shªnÚ_sb
 *
tmp_sb
 = 
sdev
->
sbs
 + 
çed_»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

965 
	`shªnÚ_”r
("%s:†ba‡nd metadata don't match.†un=%d,†un_pba=%d,†ba=0x%lx, metadata=0x%lx, sb=%d, state=%d, seq_num=0x%lx.\n",

966 
sdev
->
sdisk
.
disk_Çme
, 
çed_»q
->
pba
.
lun
, faed_»q->pba.
lun_pba
, faed_»q->
lba
,

967 ()
çed_»q
->
_m‘ad©a
, 
tmp_sb
->
sb_šdex
,mp_sb->
¡©e
,mp_sb->
£q_num
);

968 
çed_»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

970 
çed_»q
->
¡©e
 = 
REQ_DONE
;

971 
	`sbio_»Ëa£
(
sdev
, 
çed_»q
->
sbio
);

974 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& ((
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
è|| (sb->¡©=ğ
COLD_BLOCK_LIST
)))

975 
	`»şaim_»ad_”rÜ_sb
(
sdev
, 
sb
);

978 
lun_off£t
 = (
»q
->
pba
.
lun
 + 
sdev
->
max_luns_š_group
 - 
group
->
¡¬t_lun
) % sdev->max_luns_in_group;

980 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

981 
Ãxt_lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

982 } 
	`is_bad_lun
(
sb
, 
Ãxt_lun
è|| (Ãxt_luÀ=ğ
çed_»q
->
pba
.
lun
));

984 
sbio
->
logicbs
 = 1;

985 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

986 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

987 
	`£t_»q_debug_g
(
»q
, 
RAID5_RECOVERY_TAG
, 
Ãxt_lun
);

988 
»q
->
pba
.
lun
 = 
Ãxt_lun
;

989 
	`£nd_¿id5_»cov”y_»q
(
sb
, 
sbio
, 
»q
, 
çed_»q
);

994 
ä“
:

995 !
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
)) {

996 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

997 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

998 
	`ä“_»q
(
»q
);

1000 
out
:

1001 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

1002 
	`ä“_sbio
(
sbio
);

1003 
	}
}

1005 
	$¿id5_»cov”y
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
çed_»q
)

1007 
shªnÚ_bio
 *
sbio
;

1008 
shªnÚ_»que¡
 *
»q
;

1009 
lun
, 
lun_off£t
;

1010 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + 
çed_»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1011 
sub_group
 *
group
 = &
sb
->sub_group[
çed_»q
->
pba
.
lun
/
sdev
->
max_luns_š_group
];

1013 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

1014 
sbio
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1015 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1016 
sbio
->
logicbs
 = 1;

1017 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

1018 
sbio
->
ÿÎback
 = 
¿id5_»cov”y_ÿÎback
;

1019 
sbio
->
d©a
 = 
sb
;

1020 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

1021 
sbio
->
d©a2
 = 
çed_»q
;

1023 
çed_»q
->
_m‘ad©a
 = 0;

1024 
çed_»q
->
»ad_luns_fÜ_»cov”
 = 0;

1026 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

1027 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1028 
	`is_bad_lun
(
sb
, 
lun
è|| (luÀ=ğ
çed_»q
->
pba
.lun)) {

1029 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

1030 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1033 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

1034 
»q
->
sbio
 = sbio;

1035 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1036 
	`£t_»q_debug_g
(
»q
, 
RAID5_RECOVERY_TAG
, 
lun
);

1037 
»q
->
pba
.
lun
 =†un;

1038 
	`£nd_¿id5_»cov”y_»q
(
sb
, 
sbio
, 
»q
, 
çed_»q
);

1039 
	}
}

1042 
	$£nd_¿id5_»cov”y_»q
(
shªnÚ_sb
 *
sb
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
, shªnÚ_»que¡ *
çed_»q
)

1044 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

1045 
shªnÚ_»que¡
 *
tmp
;

1046 
lun
;

1048 
»q
->
İcode
 = 
sh_cmd_»ad
;

1049 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1050 
»q
->
lba
 = 
LONG_INVALID_LBA
;

1051 
»q
->
pba
.
lun_pba
 = 
çed_»q
->pba.lun_pba;

1052 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

1053 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

1054 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1055 
»q
->
»»ad
 = 
RAID_READ_MASK
;

1059 ià((
sb
->
¡©e
 =ğ
WAIT_ERASE_BLOCK
è|| (sb->¡©=ğ
DISCARDED_BLOCK
) || \

1060 ((
sb
->
¡©e
 =ğ
FREE_BLOCK
è&& (
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
))) {

1061 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1062 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1063 
	`ä“_»q
(
»q
);

1065 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
 * sdev->
lun_couÁ
, 
SHANNON_DMA_FROMDEVICE
);

1066 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

1067 
	`ä“_sbio
(
sbio
);

1069 
çed_»q
->
»»ad
 &ğ~
RAID_READ_MASK
;

1070 ià(
çed_»q
->
»cov”_buf
 !ğ
NULL
) {

1071 
	`ä“_logicb_buf
(
sdev
, 
çed_»q
->
»cov”_buf
);

1072 
çed_»q
->
»cov”_buf
 = 
NULL
;

1074 
	`check_»»ad_çed_»q
(
sdev
, 
çed_»q
);

1077 
lun
 = 
»q
->
pba
.lun;

1078 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

1079 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

1080 
	}
}

1082 
	$ç¡_¿id5_»cov”y_ÿÎback
(
shªnÚ_bio
 *
sbio
)

1084 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

1085 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

1086 
shªnÚ_»que¡
 *
»q
, *
tmp
, *
çed_»q
 = (shªnÚ_»que¡ *)
sbio
->
d©a2
;

1088 
çed_»q
->
_m‘ad©a
 = 0;

1089 
	`shªnÚ_mem£t
(
çed_»q
->
»cov”_buf
, 0, 
sdev
->
logicb_size
);

1090 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1091 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1092 
	`__shªnÚ_b™m­_xÜ
(
çed_»q
->
»cov”_buf
, faed_»q->»cov”_buf, 
»q
->
vœt_addr
, 
sdev
->
logicb_size
 * 8);

1093 
çed_»q
->
_m‘ad©a
 = 
»q
->_metadata ^ failed_req->_metadata;

1096 ià((
çed_»q
->
£q_num
 !ğ0è&& (çed_»q->£q_num !ğ
sb
->seq_num) && \

1097 (
çed_»q
->
£q_num
 !ğ
MAX_SEQ_NUM
) && \

1098 (
sdev
->
š™_dÚe
 >ğ
STAGE9_DONE
)) {

1099 
	`shªnÚ_log
("%s():†ba=%d,†un=%d,†un_pba=%d, seq_num=0x%x, sb=%d, sb->seq_num=0x%x.\n",

1100 
__func__
, 
çed_»q
->
lba
, faed_»q->
pba
.
lun
, faed_»q->pba.
lun_pba
,

1101 
çed_»q
->
£q_num
, 
sb
->
sb_šdex
, sb->seq_num);

1102 
çed_»q
->
»»ad
 &ğ~
RAID_READ_MASK
;

1103 ià(
çed_»q
->
»cov”_buf
 !ğ
NULL
) {

1104 
	`ä“_logicb_buf
(
sdev
, 
çed_»q
->
»cov”_buf
);

1105 
çed_»q
->
»cov”_buf
 = 
NULL
;

1108 
	`check_»»ad_çed_»q
(
sdev
, 
çed_»q
);

1109 
ä“
;

1112 ià(
çed_»q
->
£q_num
 =ğ
MAX_SEQ_NUM
)

1113 
çed_»q
->
£q_num
 = 
sb
->seq_num;

1115 ià(
sbio
->
¡©us
) {

1116 
çed_»q
->
»»ad
 &ğ~
RAID_READ_MASK
;

1117 ià(
çed_»q
->
»cov”_buf
 !ğ
NULL
) {

1118 
	`ä“_logicb_buf
(
sdev
, 
çed_»q
->
»cov”_buf
);

1119 
çed_»q
->
»cov”_buf
 = 
NULL
;

1125 ià((
sb
->
¡©e
 =ğ
WAIT_ERASE_BLOCK
è|| (sb->¡©=ğ
DISCARDED_BLOCK
) || \

1126 ((
sb
->
¡©e
 =ğ
FREE_BLOCK
è&& (
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
))) {

1127 
	`check_»»ad_çed_»q
(
sdev
, 
çed_»q
);

1129 
	`shªnÚ_»cov”_”r
("%s:„aid5_recovery failed! sethe failed_req's ECC from 0x%xo 0xF2,†ba=0x%lx,†un=%d,†un_pba=%d.\n",

1130 
sdev
->
sdisk
.
disk_Çme
, 
çed_»q
->
_ecc
, faed_»q->
lba
, faed_»q->
pba
.
lun
, faed_»q->pba.
lun_pba
);

1131 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1132 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

1133 
	`shªnÚ_»cov”_šfo
("... because %s: sb_index=%d, state=0x%x,†un=%d,†un_pba=%d,ƒcc=0x%x, metadata=0x%lx.\n",

1134 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, sb->
¡©e
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
_m‘ad©a
);

1136 ià(
çed_»q
->
»»ad
 & 
FILL_READ_MASK
) {

1137 
	`shªnÚ_šfo
("%s:†ba=%ld†un=%d†un_pba=%dryo fillhen„ead.\n",

1138 
sdev
->
sdisk
.
disk_Çme
, 
çed_»q
->
lba
, faed_»q->
pba
.
lun
, faed_»q->pba.
lun_pba
);

1139 
	`fl_th’_»ad_wÜk
(
sdev
, 
çed_»q
);

1140 
ä“
;

1143 
çed_»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

1144 
çed_»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

1145 
çed_»q
->
¡©e
 = 
REQ_DONE
;

1146 
	`sbio_»Ëa£
(
sdev
, 
çed_»q
->
sbio
);

1151 
çed_»q
->
_ecc
 = 0;

1152 ià(
	`decom´ess_m‘ad©a
(
çed_»q
)) {

1153 
shªnÚ_sb
 *
tmp_sb
 = 
sdev
->
sbs
 + 
çed_»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1154 
	`shªnÚ_”r
("%s:†ba‡nd metadata don't match.†un=%d,†un_pba=%d,†ba=0x%lx, metadata=0x%lx, sb=%d, state=%d, seq_num=0x%lx.\n",

1155 
sdev
->
sdisk
.
disk_Çme
, 
çed_»q
->
pba
.
lun
, faed_»q->pba.
lun_pba
, faed_»q->
lba
,

1156 ()
çed_»q
->
_m‘ad©a
, 
tmp_sb
->
sb_šdex
,mp_sb->
¡©e
,mp_sb->
£q_num
);

1157 
çed_»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

1159 
çed_»q
->
¡©e
 = 
REQ_DONE
;

1160 
	`sbio_»Ëa£
(
sdev
, 
çed_»q
->
sbio
);

1163 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& ((
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
è|| (sb->¡©=ğ
COLD_BLOCK_LIST
)))

1164 
	`»şaim_»ad_”rÜ_sb
(
sdev
, 
sb
);

1167 
ä“
:

1168 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1169 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1170 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1171 
	`ä“_»q
(
»q
);

1173 
	`ä“_sbio
(
sbio
);

1174 
	}
}

1176 
	$ç¡_¿id5_»cov”y
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
çed_»q
)

1178 
shªnÚ_bio
 *
sbio
;

1179 
shªnÚ_»que¡
 *
»q
;

1180 
lun
, 
lun_off£t
;

1181 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + 
çed_»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1182 
sub_group
 *
group
 = &
sb
->sub_group[
çed_»q
->
pba
.
lun
/
sdev
->
max_luns_š_group
];

1183 
lun_š_group
;

1185 
çed_»q
->
¡©e
 = 
REQ_WAIT_RAID5
;

1186 
çed_»q
->
»cov”_buf
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1188 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

1189 
sbio
->
logicbs
 = 
sb
->
mš_d©a_luns
;;

1190 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

1191 
sbio
->
ÿÎback
 = 
ç¡_¿id5_»cov”y_ÿÎback
;

1192 
sbio
->
d©a
 = 
sb
;

1193 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

1194 
sbio
->
d©a2
 = 
çed_»q
;

1196 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

1197 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1198 
lun_š_group
 = 0;

1200 
	`is_bad_lun
(
sb
, 
lun
è|| (luÀ=ğ
çed_»q
->
pba
.lun)) {

1201 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

1202 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1205 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

1206 
»q
->
sbio
 = sbio;

1207 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1208 
	`£t_»q_debug_g
(
»q
, 
RAID5_RECOVERY_TAG
, 
lun
);

1209 
»q
->
pba
.
lun
 =†un;

1210 
»q
->
İcode
 = 
sh_cmd_»ad
;

1211 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1212 
»q
->
lba
 = 
LONG_INVALID_LBA
;

1213 
»q
->
pba
.
lun_pba
 = 
çed_»q
->pba.lun_pba;

1214 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1215 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1216 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1217 
»q
->
»»ad
 = 
RAID_READ_MASK
;

1219 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

1220 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

1222 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

1223 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1224 
lun_š_group
++;

1225 } 
lun_š_group
 < 
sb
->
mš_d©a_luns
);

1226 
	}
}

1228 
	$£t_»ad_”rÜ_block
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

1230 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1231 
eblk
 = 
»q
->
pba
.
lun_pba
/
sdev
->
logicbs_š_eblock
;

1232 
¶ªe
 = 
eblk
 % 
sdev
->
¶ªes
;

1233 
lun
 = 
»q
->
pba
.lun;

1235 ià((
sb
->
£q_num
 =ğ
MAX_SEQ_NUM
è|| ((sb->£q_num >ğ
sdev
->
pow”_Ú_£q_num
) &&

1236 ((
sb
->
£q_num
 + 
sdev
->
sb_couÁ
 * 50è> sdev->
£qu’û_numb”
)) ||

1237 
sdev
->
lun
[lun]->
su¥icious_bad_lun
) {

1238 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
)) {

1239 
	`shªnÚ_log
("%s: mark„ead block! sb=%d, state=%d,†un=%d,…lane=%d.\n",

1240 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, sb->
¡©e
, 
lun
, 
¶ªe
);

1241 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
) == 0) {

1242 ià(
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
)

1243 
	`shªnÚ_©omic_šc
(&
sdev
->
³ndšg_”r_blks
);

1245 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
);

1248 
	}
}

1250 
	$__»q_is_š_Ï‹¡_two_groups
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, 
h—d_šdex
)

1252 
sb_šdex
 = 
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
;

1253 ià(
sb_šdex
 =ğ
sdev
->
wr_sb
[
h—d_šdex
]) {

1254 
shªnÚ_sb
 *
sb
 = &
sdev
->
sbs
[
sb_šdex
];

1255 
chunk
 = (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
;

1256 
group
 = 
»q
->
pba
.
lun
 / 
sdev
->
max_luns_š_group
;

1257 
groups
 = 
chunk
 * 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_groups
è+ sb->
sub_group
[
group
].
phy_šdex
;

1258 
wr_groups
 = 
sdev
->
wr_chunk
[
h—d_šdex
] * 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_groups
è+ sb->
sub_group
[sdev->
wr_group
[h—d_šdex]].
phy_šdex
;

1259 ià((
groups
 =ğ
wr_groups
) || (groups == wr_groups - 1))

1263 
	}
}

1265 
	$»q_is_š_Ï‹¡_two_groups
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, *
ph—d
)

1267 
i
;

1269 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

1270 ià(
	`__»q_is_š_Ï‹¡_two_groups
(
sdev
, 
»q
, 
i
)) {

1271 *
ph—d
 = 
wr™e_h—d
[
i
];

1277 
	}
}

1279 
	$»q_is_š_aùive_·r™y_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, *
ph—d
)

1281 
sb_šdex
 = 
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
;

1282 
chunk
 = (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
;

1283 
group
 = 
»q
->
pba
.
lun
 / 
sdev
->
max_luns_š_group
;

1284 
i
;

1286 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

1287 ià((
sb_šdex
 =ğ
sdev
->
wr_sb
[
i
]è&& (
chunk
 =ğsdev->
wr_chunk
[i]è&& (
group
 =ğsdev->
wr_group
[i])) {

1288 *
ph—d
 = 
wr™e_h—d
[
i
];

1294 
	}
}

1296 
	$¿id5_»cov”y_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

1298 
shªnÚ_”rÜ_hªdËr
 *
hªdËr
 = 
	`cÚš”_of
(
wÜk
, shannon_error_handler, work);

1299 
shªnÚ_dev
 *
sdev
 = 
hªdËr
->
dev
;

1300 
shªnÚ_»que¡
 *
»q
 = 
hªdËr
->req;

1301 
h—d
 = 0, 
»Œ›s
 = 0, 
do_fl
 = 0;

1303 
»q
->
¡©e
 = 
REQ_IN_RAID5
;

1304 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& (sdev->
acûss_mode
 !ğ
SHN_MODE_READONLY
)) {

1305 ià(
	`»q_is_š_Ï‹¡_two_groups
(
sdev
, 
»q
, &
h—d
)) {

1306 
	`shªnÚ_šfo
("fill…arity group:†un=%d,†un_pba=%d,ƒcc=0x%x, wr_sb=%d, wr_chunk=%d, wr_group=%d, head=%d.\n",

1307 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
, 
sdev
->
wr_sb
[
h—d
 & 
HEAD_INDEX_MASK
],

1308 
sdev
->
wr_chunk
[
h—d
 & 
HEAD_INDEX_MASK
], sdev->
wr_group
[head & HEAD_INDEX_MASK], head);

1309 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

1310 
	`»q_is_š_aùive_·r™y_group
(
sdev
, 
»q
, &
h—d
))

1311 
	`£nd_dummy_»q
(
sdev
, 
h—d
);

1312 ià(
	`»q_is_š_Ï‹¡_two_groups
(
sdev
, 
»q
, &
h—d
))

1313 
	`£nd_dummy_»q
(
sdev
, 
h—d
);

1314 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

1315 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

1316 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

1318 
do_fl
 = 1;

1319 } ià(
	`»q_is_š_aùive_chunks_¿nge
(
sdev
, 
»q
, &
h—d
))

1320 
do_fl
 = 1;

1328 ià(
do_fl
) {

1329 ià(
»q
->
»»ad
 & 
FILL_READ_MASK
) {

1330 
	`shªnÚ_log
("%s: hits‡ctive block‡gain!:†un=%d,†un_pba=%d,ƒcc=0x%x, wr_sb=%d, wr_chunk=%d, wr_group=%d, head=%d.\n",

1331 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
, sdev->
wr_sb
[
h—d
 & 
HEAD_INDEX_MASK
],

1332 
sdev
->
wr_chunk
[
h—d
 & 
HEAD_INDEX_MASK
], sdev->
wr_group
[head & HEAD_INDEX_MASK], head);

1334 
	`shªnÚ_šfo
("%s: hits‡ctive block:†un=%d,†un_pba=%d,ƒcc=0x%x, wr_sb=%d, wr_chunk=%d, wr_group=%d, head=%d.\n",

1335 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
, sdev->
wr_sb
[
h—d
 & 
HEAD_INDEX_MASK
],

1336 
sdev
->
wr_chunk
[
h—d
 & 
HEAD_INDEX_MASK
], sdev->
wr_group
[head & HEAD_INDEX_MASK], head);

1337 
»q
->
»»ad
 |ğ
FILL_READ_MASK
;

1339 } ià(
»q
->
»»ad
 & 
FILL_READ_MASK
)

1340 
»q
->
»»ad
 &ğ~
FILL_READ_MASK
;

1342 
»q
->
»»ad
 |ğ
RAID_READ_MASK
;

1344 ià(
»q
->
£nd”
 =ğ
FROM_HOST
) {

1345 
	`shªnÚ_©omic_»ad
(&
sdev
->
logicb_buf_couÁ
è> 
MAX_LOGICB_BUF_COUNT
)

1346 
	`shªnÚ_m¦“p
(1);

1347 
	`ç¡_¿id5_»cov”y
(
sdev
, 
»q
);

1348 } ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
logicb_buf_couÁ
) < 25000)

1349 
	`ç¡_¿id5_»cov”y
(
sdev
, 
»q
);

1351 
	`¿id5_»cov”y
(
sdev
, 
»q
);

1353 
	`shªnÚ_©omic_»ad
(&
sdev
->
logicb_buf_couÁ
è> 
MAX_LOGICB_BUF_COUNT
) {

1354 
	`shªnÚ_m¦“p
(1);

1355 
»Œ›s
++;

1356 ià((
»Œ›s
 % 10000) == 5000)

1357 
	`shªnÚ_šfo
("%s, wa™†ogicb_buf_couÁ=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
	`shªnÚ_©omic_»ad
(&sdev->
logicb_buf_couÁ
));

1359 
	`ç¡_¿id5_»cov”y
(
sdev
, 
»q
);

1362 
	`shªnÚ_kä“
(
hªdËr
);

1363 
	}
}

1365 
	$queue_¿id5_»cov”y_sk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

1367 
shªnÚ_”rÜ_hªdËr
 *
hªdËr
 = 
	`shªnÚ_km®loc
((shªnÚ_”rÜ_hªdËr), 
GFP_ATOMIC
);

1368 ià(
hªdËr
) {

1369 
	`shªnÚ_š™_wÜk
(&
hªdËr
->
wÜk
, 
¿id5_»cov”y_sk
);

1370 
hªdËr
->
dev
 = 
sdev
;

1371 
hªdËr
->
»q
 =„eq;

1372 
	`shªnÚ_queue_wÜk
(
sdev
->
»ad_”r_wq
, &
hªdËr
->
wÜk
);

1374 
	`shªnÚ_”r
("Allocate memory failed!\n");

1375 
»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

1376 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

1377 
»q
->
¡©e
 = 
REQ_DONE
;

1378 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

1380 
	}
}

1382 
	$is_”r_msg_lun
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun
, 
¶ªe
)

1384 
šdex
, 
off£t
;

1385 
b™s
 = (*
sb
->
”r_msg_lun
) * 8;

1387 
šdex
 = (
lun
 * 
dev
->
¶ªes
è/ 
b™s
;

1388 
off£t
 = (
lun
 * 
dev
->
¶ªes
è% 
b™s
;

1389  
	`shªnÚ_‹¡_b™
(
off£t
 + 
¶ªe
, 
sb
->
”r_msg_lun
 + 
šdex
);

1390 
	}
}

1392 
	$sb_m¬k_”r_msg_lun
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun
, 
¶ªe
)

1394 
šdex
, 
off£t
;

1395 
b™s
 = (*
sb
->
”r_msg_lun
) * 8;

1397 
šdex
 = (
lun
 * 
dev
->
¶ªes
è/ 
b™s
;

1398 
off£t
 = (
lun
 * 
dev
->
¶ªes
è% 
b™s
;

1399 
	`shªnÚ_£t_b™
(
off£t
 + 
¶ªe
, 
sb
->
”r_msg_lun
 + 
šdex
);

1400 
	}
}

1402 
	$hªdË_»ad_”rÜ
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
)

1404 
shªnÚ_poŞ
 *
¥oŞ
 = 
NULL
;

1405 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

1406 
shªnÚ_disk
 *
sdisk
 = &
dev
->sdisk;

1407 
lun
, 
¶ªe
, 
eblk
, 
»t
;

1408 
shªnÚ_sb
 *
sb
;

1410 
»q
->
¡©e
 = 
REQ_ERROR
;

1411 
sb
 = 
dev
->
sbs
 + 
»q
->
pba
.
lun_pba
/dev->
logicbs_š_siblšg_eblock
;

1412 ià(
»q
->
£q_num
 == 0)

1413 
»q
->
£q_num
 = 
sb
->seq_num;

1415 ià(
dev
->
advªûd_»ad_¡©e
 & 
ADV_READ_SUPPORT_MASK
)

1416 
»q
->
İcode
 = 
sh_cmd_advªûd_»ad
;

1418 ià(
dev
->
»ad_”r_msg_Ëv–
 >ğ
MSG_ON_EACH_READ_FAIL
)

1419 
	`shªnÚ_log
("%s:„eread=%d,†un=%d,†un_pba=%d,†ba=0x%lx,ƒcc=0x%x, metadata=0x%lx,ag=0x%lx.\n",

1420 
dev
->
sdisk
.
disk_Çme
, 
»q
->
»»ad
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
lba
,„eq->
_ecc
,

1421 (
ulÚg
)
»q
->
_m‘ad©a
, (ulÚgìeq->
g
);

1423 
»q
->
»»ad
++;

1424 ià((
»q
->
£q_num
 !ğ0è&& (»q->£q_num !ğ
sb
->£q_numè&& (»q->£q_num !ğ
MAX_SEQ_NUM
)) {

1425 
	`shªnÚ_šfo
("reread=%d,†ba=0x%lx,†un=%d,†un_pba=%d, seq_num=%lx, sb=%d, sb->state=%d, sb->seq_num=0x%lx.\n",

1426 
»q
->
»»ad
,„eq->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
£q_num
,

1427 
sb
->
sb_šdex
, sb->
¡©e
, sb->
£q_num
);

1428 
	`check_»»ad_çed_»q
(
dev
, 
»q
);

1431 
¶ªe
 = ((
»q
->
pba
.
lun_pba
 / 
dev
->
logicbs_š_·ge
è/ dev->
·ges_š_eblock
è% dev->
¶ªes
;

1433 ià(
	`is_”rÜ_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
))

1434 
»q
->
»»ad
 += 2;

1436 ià((
»q
->
»»ad
 & 
REREAD_NUM_MASK
è> 
dev
->
»Œy_times_Ú_”rÜ
) {

1437 
sb_šdex
 = 
»q
->
pba
.
lun_pba
/
dev
->
logicbs_š_siblšg_eblock
;

1439 ià((
sb_šdex
 < 
dev
->
mbr_eblocks
/dev->
¶ªes
è|| (dev->
ov”Ïp_wr™e
 && (sb_šdex =ğdev->
mbr
.
ov”Ïp_sblk
))) {

1441 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
)

1442 
»q
->
sbio
->
¡©us
 |ğ
HAVE_BLANK_SECTOR
;

1443 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
) {

1444 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

1445 ià(
dev
->
š™_dÚe
 >ğ
STAGE9_DONE
) {

1449 
	`»cÜd_bad_block
(
dev
, dev->
lun
[
»q
->
pba
.lun],

1450 
»q
->
pba
.
lun_pba
/(
dev
->
logicbs_š_·ge
 * dev->
·ges_š_eblock
));

1453 
»q
->
¡©e
 = 
REQ_DONE
;

1454 
	`sbio_»Ëa£
(
dev
, 
»q
->
sbio
);

1459 
eblk
 = 
»q
->
pba
.
lun_pba
/(
dev
->
logicbs_š_·ge
 * dev->
·ges_š_eblock
);

1460 ià(!
	`is_”r_msg_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
eblk
 % dev->
¶ªes
è|| (dev->
»ad_”r_msg_Ëv–
 > 
ONE_MSG_PER_BLK
)) {

1461 ià(
dev
->
»ad_”r_msg_Ëv–
 > 
NO_READ_ERR_MSG
)

1462 
	`shªnÚ_log
("%s:†un=%d,†un_pba=%d,†ba=0x%lx,ƒcc=0x%x,ƒblk=%d, metadata=0x%lx,ag=0x%lx.\n",

1463 
dev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
lba
,„eq->
_ecc
,

1464 
eblk
, (
ulÚg
)
»q
->
_m‘ad©a
, (ulÚgìeq->
g
);

1465 
	`sb_m¬k_”r_msg_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
eblk
 % dev->
¶ªes
);

1467 ià(!((
dev
->
š™_dÚe
 =ğ
STAGE_RECOVER_USED_DONE
è&& 
	`is_aùive_blk
(
sb
))) {

1468 ià(!
	`»q_is_š_aùive_chunks_¿nge
(
dev
, 
»q
, 
NULL
))

1469 
	`£t_»ad_”rÜ_block
(
dev
, 
»q
);

1472 ià(
dev
->
¿id5_suµÜ‹d
 && ((
»q
->
»»ad
 & 
RAID_READ_MASK
è=ğ0è&& (dev->
š™_dÚe
 >ğ
STAGE_BBT_DONE
)) {

1473 
	`queue_¿id5_»cov”y_sk
(
dev
, 
»q
);

1475 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
)

1476 
»q
->
sbio
->
¡©us
 |ğ
HAVE_BLANK_SECTOR
;

1477 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

1478 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

1479 
»q
->
¡©e
 = 
REQ_DONE
;

1480 
	`sbio_»Ëa£
(
dev
, 
»q
->
sbio
);

1484 ià(!
	`lÚg_lba_is_šv®id
(
»q
->
lba
)) {

1485 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
dev
->spool);

1486 ià(
¥oŞ
) {

1487 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

1488 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

1489 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

1490 
	`BUG
();

1492 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

1493 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

1494 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

1495 
	`BUG
();

1497 
sdisk
 = &
ns
->sdisk;

1500 
	`Ímt_lock
(
dev
, 
sdisk
, 
»q
->
lba
);

1501 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, 
NULL
, 
sdisk
);

1502 
	`Ímt_uÆock
(
dev
, 
sdisk
, 
»q
->
lba
);

1503 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

1504 ià(
»t
 < 0) {

1505 
	`shªnÚ_log
("%s:†b¨%x may bdisÿrded. Ju¡ ignÜ™.\n", 
dev
->
sdisk
.
disk_Çme
, 
»q
->
lba
);

1506 
»q
->
¡©e
 = 
REQ_DONE
;

1507 
	`sbio_»Ëa£
(
dev
, 
»q
->
sbio
);

1510 
sb
 = 
dev
->
sbs
 + 
»q
->
pba
.
lun_pba
/dev->
logicbs_š_siblšg_eblock
;

1511 
»q
->
£q_num
 = 
sb
->seq_num;

1514 
»q
->
_ecc
 = 0;

1515 
»q
->
_m‘ad©a
 = 0;

1516 
lun
 = 
»q
->
pba
.lun;

1517 
	`add_lun_»que¡_queue_
(
dev
->
lun
[lun], 
»q
);

1518 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_»ad_wq
, &dev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

1520 
	}
}

	@shannon_err_injection.c

12 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


15 
	$m¬k_çke_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

17 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

20 
	`shªnÚ_£t_b™
(
lun
, 
sdev
->
çke_bad_lun
);

21 
	}
}

23 
	$m¬k_çke_cmd_timeout_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

25 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

28 
	`shªnÚ_£t_b™
(
lun
, 
sdev
->
çke_cmd_timeout_lun
);

29 
	}
}

31 
	$is_çke_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

33 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

36  
	`shªnÚ_‹¡_b™
(
lun
, 
sdev
->
çke_bad_lun
);

37 
	}
}

39 
	$is_çke_cmd_timeout_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

41 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

44  
	`shªnÚ_‹¡_b™
(
lun
, 
sdev
->
çke_cmd_timeout_lun
);

45 
	}
}

48 
	$m¬k_çke_rd_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

50 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

53 
	`shªnÚ_£t_b™
(
lun
, 
sdev
->
çke_rd_bad_lun
);

54 
	}
}

56 
	$is_çke_rd_bad_lun
(
shªnÚ_dev
 *
sdev
, 
lun
)

58 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

61  
	`shªnÚ_‹¡_b™
(
lun
, 
sdev
->
çke_rd_bad_lun
);

62 
	}
}

65 
	$m¬k_çke_wr_bad_luÅ·
(
shªnÚ_dev
 *
sdev
, 
lun
, 
µa
)

67 
off£t
, 
b™_off£t
;

68 *
b™_ba£
;

70 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

73 
off£t
 = ()
lun
 * 
sdev
->
sb_couÁ
 * sdev->
¶ªes
 * sdev->
·ges_š_eblock
 + 
µa
;

74 
b™_off£t
 = 
off£t
 % 64;

75 
b™_ba£
 = (
u64
 *)
sdev
->
çke_wr_bad_luÅ·
 + 
off£t
/64;

77 
	`shªnÚ_£t_b™
(
b™_off£t
, 
b™_ba£
);

78 
	}
}

80 
	$is_çke_wr_bad_luÅ·
(
shªnÚ_dev
 *
sdev
, 
lun
, 
µa
)

82 
off£t
, 
b™_off£t
;

83 *
b™_ba£
;

84 
blk_šdex
 = 
µa
 / 
sdev
->
·ges_š_eblock
;

86 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

89 
off£t
 = ()
lun
 * 
sdev
->
sb_couÁ
 * sdev->
¶ªes
 * sdev->
·ges_š_eblock
 + 
µa
;

90 
b™_off£t
 = 
off£t
 % 64;

91 
b™_ba£
 = (
u64
 *)
sdev
->
çke_wr_bad_luÅ·
 + 
off£t
/64;

93 ià(
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
))

96 ià(
	`is_çke_bad_lun
(
sdev
, 
lun
)) {

97 ià((
blk_šdex
 < 
sdev
->
mbr_eblocks
è&& sdev->
çke_bad_lun_skmbr
)

103 
	}
}

106 
	$m¬k_çke_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
)

108 
off£t
, 
b™_off£t
;

109 *
b™_ba£
;

111 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

114 
off£t
 = ()
lun
 * 
sdev
->
sb_couÁ
 * sdev->
logicbs_š_siblšg_eblock
 + 
pba
;

115 
b™_off£t
 = 
off£t
 % 64;

116 
b™_ba£
 = (
u64
 *)
sdev
->
çke_rd_bad_luÅba
 + 
off£t
/64;

118 
	`shªnÚ_£t_b™
(
b™_off£t
, 
b™_ba£
);

119 
	}
}

121 
	$is_çke_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
)

123 
off£t
, 
b™_off£t
;

124 *
b™_ba£
;

125 
blk_šdex
 = (
pba
 / 
sdev
->
logicbs_š_·ge
è/ sdev->
·ges_š_eblock
;

127 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

130 
off£t
 = ()
lun
 * 
sdev
->
sb_couÁ
 * sdev->
logicbs_š_siblšg_eblock
 + 
pba
;

131 
b™_off£t
 = 
off£t
 % 64;

132 
b™_ba£
 = (
u64
 *)
sdev
->
çke_rd_bad_luÅba
 + 
off£t
/64;

134 ià(
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
))

137 ià(
	`is_çke_bad_lun
(
sdev
, 
lun
)) {

138 ià((
blk_šdex
 < 
sdev
->
mbr_eblocks
è&& sdev->
çke_bad_lun_skmbr
)

142 } ià(
	`is_çke_rd_bad_lun
(
sdev
, 
lun
)) {

143 ià((
blk_šdex
 < 
sdev
->
mbr_eblocks
è&& sdev->
çke_bad_lun_skmbr
)

149 
	}
}

151 
	$m¬k_çke_rd_bad_luÅba_¿idmu‹x
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
)

153 
i
;

154 
begšlun
 = (
lun
 / 
sdev
->
max_luns_š_group
) * sdev->max_luns_in_group;

155 
’dlun
 = 
begšlun
 + 
sdev
->
max_luns_š_group
;

157 
i
 = 
begšlun
; i < 
’dlun
; i++)

158 ià(
	`is_çke_rd_bad_luÅba
(
sdev
, 
i
, 
pba
))

161 
	`m¬k_çke_rd_bad_luÅba
(
sdev
, 
lun
, 
pba
);

162 
	}
}

165 
	$m¬k_çke_”_bad_block
(
shªnÚ_dev
 *
sdev
, 
lun
, 
blk
)

167 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

170 
	`shªnÚ_£t_b™
(
lun
 * 
sdev
->
eblocks_š_lun
 + 
blk
, sdev->
çke_”_bad_block
);

171 
	}
}

173 
	$is_çke_”_bad_block
(
shªnÚ_dev
 *
sdev
, 
lun
, 
blk
)

175 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

178 ià(
	`shªnÚ_‹¡_b™
(
lun
 * 
sdev
->
eblocks_š_lun
 + 
blk
, sdev->
çke_”_bad_block
))

181 ià(
	`is_çke_bad_lun
(
sdev
, 
lun
)) {

182 ià((
blk
 < 
sdev
->
mbr_eblocks
è&& sdev->
çke_bad_lun_skmbr
)

188 
	}
}

191 
	$m¬k_çke_twš_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
, 
h—d_šdex
)

193 
off£t
, 
b™_off£t
, 
ba£_off£t
;

194 *
b™_ba£
;

196 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

199 
pba
 =…b¨% 
sdev
->
logicbs_š_siblšg_eblock
;

200 
off£t
 = ()
lun
 * 
sdev
->
logicbs_š_siblšg_eblock
 + 
pba
;

201 
b™_off£t
 = 
off£t
 % 64;

202 
ba£_off£t
 = (
h—d_šdex
 =ğ0è? 0 : (()
sdev
->
lun_couÁ
 * sdev->
logicbs_š_siblšg_eblock
/64);

203 
b™_ba£
 = (
u64
 *)
sdev
->
çke_twš_rd_bad_luÅba
 + 
ba£_off£t
 + 
off£t
/64;

205 
	`shªnÚ_£t_b™
(
b™_off£t
, 
b™_ba£
);

206 
	}
}

208 
	$is_çke_twš_rd_bad_luÅba
(
shªnÚ_dev
 *
sdev
, 
lun
, 
pba
, 
h—d_šdex
)

210 
off£t
, 
b™_off£t
, 
ba£_off£t
;

211 *
b™_ba£
;

213 ià(!
	`shªnÚ_©omic_»ad
(&
sdev
->
rwe_”r_buf_dÚe
))

216 ià(
sdev
->
twš_»ad_”r
 == 0)

219 
pba
 =…b¨% 
sdev
->
logicbs_š_siblšg_eblock
;

220 
off£t
 = ()
lun
 * 
sdev
->
logicbs_š_siblšg_eblock
 + 
pba
;

221 
b™_off£t
 = 
off£t
 % 64;

222 
ba£_off£t
 = (
h—d_šdex
 =ğ0è? 0 : (()
sdev
->
lun_couÁ
 * sdev->
logicbs_š_siblšg_eblock
/64);

223 
b™_ba£
 = (
u64
 *)
sdev
->
çke_twš_rd_bad_luÅba
 + 
ba£_off£t
 + 
off£t
/64;

225 ià(
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
))

229 
	}
}

231 
šlše
 
	$g‘_¿ndom
(
mš
, 
max
)

233 
¿nd
;

235 ià(
mš
 >ğ
max
)

236  
max
;

238 
	`shªnÚ_g‘_¿ndom_by‹s
(&
¿nd
, (rand));

239 
¿nd
 =„ªd % (
max
 - 
mš
 + 1) + min;

240  
¿nd
;

241 
	}
}

243 
	$upd©e_çke_·‰”n
(
shªnÚ_dev
 *
sdev
, 
Ãxt_sb
, 
h—d_šdex
)

245 
ch
, 
¶
, 
¡•
;

246 
luns
[2], 
lun
, 
luns_Ãeded
 = 2;

247 
shªnÚ_sb
 *
sb
;

248 
sub_group
 *
group
;

249 
lim™
;

250 
g½
, 
off£t
, 
£ùÜ
, 
pba
;

251 
u64
 
luns_mask
[4];

253 ià(
sdev
->
twš_»ad_”r
 == 0)

256 
sb
 = 
sdev
->
sbs
 + 
Ãxt_sb
;

259 
g½
 = 
	`g‘_¿ndom
(0, 
sdev
->
·r™y_groups
 - 1);

260 
lim™
 = 0;

261 
group
 = &
sb
->
sub_group
[
g½
];

262 
group
->
phy_šdex
 < 0 || 
	`shªnÚ_©omic_»ad
(&group->
avaabË_luns
è< 
luns_Ãeded
) {

263 ià(++
lim™
 >ğ
sdev
->
·r™y_groups
) {

264 
	`shªnÚ_šfo
("NØv®id grou°fÜwš_»ad_”¸found iÀsb_šdex=%d\n", 
sb
->
sb_šdex
);

267 
g½
 = (g½ + 1è% 
sdev
->
·r™y_groups
;

268 
group
 = &
sb
->
sub_group
[
g½
];

270 
	`shªnÚ_šfo
("%s: simuÏ‹„—dƒ¼Ü © sb_šdex=%d,group=%d,h—d=%d,", 
__func__
, 
sb
->
sb_šdex
, 
g½
, 
h—d_šdex
);

273 
	`shªnÚ_mem£t
(
luns_mask
, 0, (luns_mask));

274 
lim™
 = 0;

275 
lun
 = 0;†uÀ< 
luns_Ãeded
;†un++) {

276 
off£t
 = 
	`g‘_¿ndom
(0, 
sdev
->
max_luns_š_group
 - 1);

278 
	`is_bad_lun
(
sb
, 
group
->
¡¬t_lun
 + 
off£t
è|| 
	`shªnÚ_‹¡_ªd_£t_b™
(off£t%64, (*)((
u64
 *)
luns_mask
 + offset/64))) {

279 ià(++
lim™
 >ğ
sdev
->
max_luns_š_group
) {

280 
	`shªnÚ_šfo
("NØv®id†un fÜwš_»ad_”¸found iÀgroup=%d, sb_šdex=%d\n", 
g½
, 
sb
->
sb_šdex
);

283 
off£t
 = (off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

286 
luns
[
lun
] = (
group
->
¡¬t_lun
 + 
off£t
è% 
sdev
->
max_luns_š_group
;

287 
lim™
 = 0;

289 
	`shªnÚ_šfo
("lun0=%d,lun1=%d,\n", 
luns
[0],†uns[1]);

291 
	`shªnÚ_šfo
("pba†ist:\n");

293 
¡•
 = 
	`g‘_¿ndom
(0, 
sdev
->
sh¬ed_·ges
 - 1);

294 
ch
 = 
¡•
; ch < 
sdev
->
mbr
.
·ges_š_eblock
; ch += step) {

295 
¡•
 = 
	`g‘_¿ndom
(0, 
sdev
->
sh¬ed_·ges
 * 4);

296 
¡•
 = 
	`g‘_¿ndom
(¡•, 
sdev
->
sh¬ed_·ges
 * 8) ? : 1;

297 
¶
 = (
sdev
->
¶ªes
 =ğ1è? 0 : 
	`g‘_¿ndom
(0, sdev->planes - 1);

298 
£ùÜ
 = 
	`g‘_¿ndom
(0, 
sdev
->
logicbs_š_·ge
 - 1);

300 
pba
 = 
ch
 * 
sdev
->
logicbs_š_·ge
 + 
¶
 * sdev->
logicbs_š_eblock
 + 
£ùÜ
;

301 
	`m¬k_çke_twš_rd_bad_luÅba
(
sdev
, 
luns
[0], 
pba
, 
h—d_šdex
);

302 
	`m¬k_çke_twš_rd_bad_luÅba
(
sdev
, 
luns
[1], 
pba
, 
h—d_šdex
);

303 
	`shªnÚ_šfo
("%d ", 
pba
);

307 
	}
}

310 
	$š™_”r_šjeùiÚ
(
shªnÚ_dev
 *
sdev
)

312 
çke_bad_lun_size
, 
çke_rd_bad_luÅba_size
, 
çke_wr_bad_luÅ·_size
, 
çke_”_bad_block_size
, 
çke_twš_rd_bad_luÅba_size
;

314 
	`shªnÚ_šfo
("%s:…ages_in_eblock=%d,†un_count=%d, sb_count=%d,†ogicbs_in_sibling_eblock=%d,…lanes=%d.\n",

315 
sdev
->
cdev_Çme
, sdev->
·ges_š_eblock
, sdev->
lun_couÁ
, sdev->
sb_couÁ
, sdev->
logicbs_š_siblšg_eblock
, sdev->
¶ªes
);

317 
çke_bad_lun_size
 = ((()
sdev
->
lun_couÁ
 + 8 * () - 1) / (8 * ())) * ();

318 
sdev
->
çke_bad_lun
 = 
	`shªnÚ_vm®loc
(
çke_bad_lun_size
);

319 ià(
NULL
 =ğ
sdev
->
çke_bad_lun
) {

320 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld fÜ fake_bad_luÀçed!\n", 
çke_bad_lun_size
);

321 
ä“
;

323 
	`shªnÚ_mem£t
(
sdev
->
çke_bad_lun
, 0x00, 
çke_bad_lun_size
);

325 
sdev
->
çke_cmd_timeout_lun
 = 
	`shªnÚ_vm®loc
(
çke_bad_lun_size
);

326 ià(
NULL
 =ğ
sdev
->
çke_cmd_timeout_lun
) {

327 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld fÜ fake_cmd_timeout_luÀçed!\n", 
çke_bad_lun_size
);

328 
ä“
;

330 
	`shªnÚ_mem£t
(
sdev
->
çke_cmd_timeout_lun
, 0x00, 
çke_bad_lun_size
);

332 
sdev
->
çke_rd_bad_lun
 = 
	`shªnÚ_vm®loc
(
çke_bad_lun_size
);

333 ià(
NULL
 =ğ
sdev
->
çke_rd_bad_lun
) {

334 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld fÜ fake_rd_bad_luÀçed!\n", 
çke_bad_lun_size
);

335 
ä“
;

337 
	`shªnÚ_mem£t
(
sdev
->
çke_rd_bad_lun
, 0x00, 
çke_bad_lun_size
);

339 
çke_rd_bad_luÅba_size
 = (()
sdev
->
lun_couÁ
 * sdev->
sb_couÁ
 * sdev->
logicbs_š_siblšg_eblock
/8UL + 4095) & ~4095UL;

340 
sdev
->
çke_rd_bad_luÅba
 = 
	`shªnÚ_vm®loc
(
çke_rd_bad_luÅba_size
);

341 ià(
NULL
 =ğ
sdev
->
çke_rd_bad_luÅba
) {

342 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld, fÜ fake_rd_bad_luÅb¨çed!\n", 
çke_rd_bad_luÅba_size
);

343 
ä“
;

345 
	`shªnÚ_mem£t
(
sdev
->
çke_rd_bad_luÅba
, 0, 
çke_rd_bad_luÅba_size
);

347 
çke_wr_bad_luÅ·_size
 = (()
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
 * sdev->
sb_couÁ
 * sdev->
lun_couÁ
/8UL + 4095) & ~4095;

348 
sdev
->
çke_wr_bad_luÅ·
 = 
	`shªnÚ_vm®loc
(
çke_wr_bad_luÅ·_size
);

349 ià(
NULL
 =ğ
sdev
->
çke_wr_bad_luÅ·
) {

350 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld fÜ fake_wr_bad_luÅ· faed!\n", 
çke_wr_bad_luÅ·_size
);

351 
ä“
;

353 
	`shªnÚ_mem£t
(
sdev
->
çke_wr_bad_luÅ·
, 0x00, 
çke_wr_bad_luÅ·_size
);

355 
çke_”_bad_block_size
 = ((()
sdev
->
eblocks_š_lun
 * sdev->
lun_couÁ
 + 7)/8UL + 4095) & ~4095;

356 
sdev
->
çke_”_bad_block
 = 
	`shªnÚ_vm®loc
(
çke_”_bad_block_size
);

357 ià(
NULL
 =ğ
sdev
->
çke_”_bad_block
) {

358 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld fÜ fake_”_bad_block!\n", 
çke_”_bad_block_size
);

359 
ä“
;

361 
	`shªnÚ_mem£t
(
sdev
->
çke_”_bad_block
, 0x00, 
çke_”_bad_block_size
);

364 
çke_twš_rd_bad_luÅba_size
 = (()
sdev
->
lun_couÁ
 * sdev->
logicbs_š_siblšg_eblock
 * 2/8UL + 4095) & ~4095UL;

365 
sdev
->
çke_twš_rd_bad_luÅba
 = 
	`shªnÚ_vm®loc
(
çke_twš_rd_bad_luÅba_size
);

366 ià(
NULL
 =ğ
sdev
->
çke_twš_rd_bad_luÅba
) {

367 
	`shªnÚ_”r
("AÎoÿ‹ memÜy†’gth=%ld, fÜ fake_twš_rd_bad_luÅb¨çed!\n", 
çke_twš_rd_bad_luÅba_size
);

368 
ä“
;

370 
	`shªnÚ_mem£t
(
sdev
->
çke_twš_rd_bad_luÅba
, 0x00, 
çke_twš_rd_bad_luÅba_size
);

372 
	`shªnÚ_©omic_£t
(&
sdev
->
rwe_”r_buf_dÚe
, 1);

375 
ä“
:

376 ià(
sdev
->
çke_”_bad_block
)

377 
	`shªnÚ_vä“
(
sdev
->
çke_”_bad_block
);

378 ià(
sdev
->
çke_wr_bad_luÅ·
)

379 
	`shªnÚ_vä“
(
sdev
->
çke_wr_bad_luÅ·
);

380 ià(
sdev
->
çke_rd_bad_luÅba
)

381 
	`shªnÚ_vä“
(
sdev
->
çke_rd_bad_luÅba
);

382 ià(
sdev
->
çke_rd_bad_lun
)

383 
	`shªnÚ_vä“
(
sdev
->
çke_rd_bad_lun
);

384 ià(
sdev
->
çke_bad_lun
)

385 
	`shªnÚ_vä“
(
sdev
->
çke_bad_lun
);

386 ià(
sdev
->
çke_cmd_timeout_lun
)

387 
	`shªnÚ_vä“
(
sdev
->
çke_cmd_timeout_lun
);

388 ià(
sdev
->
çke_twš_rd_bad_luÅba
)

389 
	`shªnÚ_vä“
(
sdev
->
çke_twš_rd_bad_luÅba
);

391  -
ENOMEM
;

392 
	}
}

394 
	$»Ëa£_”r_šjeùiÚ
(
shªnÚ_dev
 *
sdev
)

396 
	`shªnÚ_vä“
(
sdev
->
çke_bad_lun
);

397 
	`shªnÚ_vä“
(
sdev
->
çke_cmd_timeout_lun
);

398 
	`shªnÚ_vä“
(
sdev
->
çke_rd_bad_lun
);

399 
	`shªnÚ_vä“
(
sdev
->
çke_rd_bad_luÅba
);

400 
	`shªnÚ_vä“
(
sdev
->
çke_wr_bad_luÅ·
);

401 
	`shªnÚ_vä“
(
sdev
->
çke_”_bad_block
);

402 
	`shªnÚ_vä“
(
sdev
->
çke_twš_rd_bad_luÅba
);

403 
	}
}

405 
šlše
 
	$š™_”r_šjeùiÚ
(
shªnÚ_dev
 *
sdev
)

408 
	}
}

410 
	$»Ëa£_”r_šjeùiÚ
(
shªnÚ_dev
 *
sdev
è{
	}
}

	@shannon_file.c

1 
	~"shªnÚ_fe.h
"

2 
	~"shªnÚ_li¡.h
"

3 
	~<lšux/moduË.h
>

4 
	~<lšux/£q_fe.h
>

5 
	~<lšux/debugfs.h
>

6 
	~<lšux/v”siÚ.h
>

8 
	$shªnÚ_loff_t
 (*
	tfe_İs_Î£ek_â
è(
	tfe
 *, 
	tshªnÚ_loff_t
, );

9 
	$shªnÚ_ssize_t
 (*
	tfe_İs_»ad_â
è(
	tfe
 *, *, 
	tshªnÚ_size_t
, 
	tshªnÚ_loff_t
 *);

10 
	$shªnÚ_ssize_t
 (*
	tfe_İs_wr™e_â
è(
	tfe
 *, cÚ¡ *, 
	tshªnÚ_size_t
, 
	tshªnÚ_loff_t
 *);

11 (*
	tfe_İs_İ’_â
è(
	tšode
 *, 
	tfe
 *);

12 (*
	tfe_İs_»Ëa£_â
è(
	tšode
 *, 
	tfe
 *);

14 * (*
	t£q_İs_¡¬t_â
è(
	t£q_fe
 *
	tm
, 
	tshªnÚ_loff_t
 *
	tpos
);

15 (*
	t£q_İs_¡İ_â
è(
	t£q_fe
 *
	tm
, *
	tv
);

16 * (*
	t£q_İs_Ãxt_â
è(
	t£q_fe
 *
	tm
, *
	tv
, 
	tshªnÚ_loff_t
 *
	tpos
);

17 (*
	t£q_İs_show_â
è(
	t£q_fe
 *
	tm
, *
	tv
);

19 
	$shªnÚ_£q_İ’
(
shªnÚ_fe_t
 *
fe
, 
shªnÚ_£q_İ”©iÚs_t
 *
İ
)

21  
	`£q_İ’
((
fe
 *)fe, (
£q_İ”©iÚs
 *)
İ
);

22 
	}
}

24 
shªnÚ_ssize_t
 
	$shªnÚ_£q_»ad
(
shªnÚ_fe_t
 *
fe
, 
__u£r
 *
buf
, 
shªnÚ_size_t
 
size
, 
shªnÚ_loff_t
 *
µos
)

26  
	`£q_»ad
((
fe
 *)fe, 
buf
, 
size
, 
µos
);

27 
	}
}

29 
	$shªnÚ_£q_puts
(
shªnÚ_£q_fe_t
 *
m
, cÚ¡ *
s
)

31 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 3, 0)

32  
	`£q_puts
((
£q_fe
 *)
m
, 
s
);

34 
	`£q_puts
((
£q_fe
 *)
m
, 
s
);

38 
	}
}

40 
	$shªnÚ_£q_´štf
(
shªnÚ_£q_fe_t
 *
m
, cÚ¡ *
f
, ...)

42 
va_li¡
 
¬gs
;

43 
Ën
;

44 
£q_fe
 *
mm
 = (£q_f*)
m
;

46 ià(
mm
->
couÁ
 < mm->
size
) {

47 
	`va_¡¬t
(
¬gs
, 
f
);

48 
Ën
 = 
	`v¢´štf
(
mm
->
buf
 + mm->
couÁ
, mm->
size
 - mm->couÁ, 
f
, 
¬gs
);

49 
	`va_’d
(
¬gs
);

50 ià(
mm
->
couÁ
 + 
Ën
 < mm->
size
) {

51 
mm
->
couÁ
 +ğ
Ën
;

55 
mm
->
couÁ
 = mm->
size
;

57 
	}
}

59 
shªnÚ_sšgË_İ’
(
shªnÚ_fe_t
 *
fe
, (*
show
)(
shªnÚ_£q_fe_t
 *, *), *
d©a
)

61  
	`sšgË_İ’
((
fe
 *)fe, (
£q_İs_show_â
)
show
, 
d©a
);

62 
	}
}

64 
	$shªnÚ_sšgË_»Ëa£
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

66  
	`sšgË_»Ëa£
((
šode
 *)šode, (
fe
 *)file);

67 
	}
}

69 
shªnÚ_loff_t
 
	$shªnÚ_£q_l£ek
(
shªnÚ_fe_t
 *
fe
, 
shªnÚ_loff_t
 
off£t
, 
Üigš
)

71  
	`£q_l£ek
((
fe
 *)fe, 
off£t
, 
Üigš
);

72 
	}
}

74 
	$shªnÚ_£q_»Ëa£
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
)

76  
	`£q_»Ëa£
((
šode
 *)šode, (
fe
 *)file);

77 
	}
}

79 
shªnÚ_li¡_h—d
 *
	$shªnÚ_£q_li¡_¡¬t
(
shªnÚ_li¡_h—d
 *
h—d
, 
shªnÚ_loff_t
 
pos
)

81 
shªnÚ_li¡_h—d
 *
lh
;

83 
	`shªnÚ_li¡_fÜ_—ch
(
lh
, 
h—d
)

84 ià(
pos
-- == 0)

85  
lh
;

87  
NULL
;

88 
	}
}

90 
shªnÚ_li¡_h—d
 *
	$shªnÚ_£q_li¡_¡¬t_h—d
(
shªnÚ_li¡_h—d
 *
h—d
, 
shªnÚ_loff_t
 
pos
)

92 ià(!
pos
)

93  
h—d
;

95  
	`shªnÚ_£q_li¡_¡¬t
(
h—d
, 
pos
 - 1);

96 
	}
}

98 
shªnÚ_li¡_h—d
 *
	$shªnÚ_£q_li¡_Ãxt
(*
v
, 
shªnÚ_li¡_h—d
 *
h—d
, 
shªnÚ_loff_t
 *
µos
)

100 
shªnÚ_li¡_h—d
 *
lh
;

102 
lh
 = ((
shªnÚ_li¡_h—d
 *)
v
)->
Ãxt
;

103 ++*
µos
;

104  
lh
 =ğ
h—d
 ? 
NULL
 :†h;

105 
	}
}

107 * 
	$shªnÚ_fe_´iv©e_d©a
(
shªnÚ_fe_t
 *
å
)

109  ((
fe
 *)
å
)->
´iv©e_d©a
;

110 
	}
}

112 
	$shªnÚ_£t_fe_´iv©e_d©a
(
shªnÚ_fe_t
 *
fe
, *
pv
)

114 ((
fe
 *)fe)->
´iv©e_d©a
 = 
pv
;

115 
	}
}

117 * 
	$shªnÚ_£q_fe_´iv©e
(
shªnÚ_£q_fe_t
 *
f¥
)

119  ((
£q_fe
 *)
f¥
)->
´iv©e
;

120 
	}
}

122 
	$shªnÚ_£t_£q_fe_´iv©e
(
shªnÚ_£q_fe_t
 *
¥
, *
pv
)

124 ((
£q_fe
 *)
¥
)->
´iv©e
 = 
pv
;

125 
	}
}

127 *
	$shªnÚ_šode_i_´iv©e
(
shªnÚ_šode_t
 *
šode
)

129  ((
šode
 *)šode)->
i_´iv©e
;

130 
	}
}

133 
	$shªnÚ_£t_fe_İs_owÃr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
owÃr
)

135 ((
fe_İ”©iÚs
 *)
fİs
)->
owÃr
 = (
moduË
 *)owner;

136 
	}
}

138 
	$shªnÚ_£t_fe_İs_Î£ek_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
Î£ek
)

140 ((
fe_İ”©iÚs
 *)
fİs
)->
Î£ek
 = (
fe_İs_Î£ek_â
)llseek;

141 
	}
}

143 
	$shªnÚ_£t_fe_İs_»ad_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
»ad
)

145 ((
fe_İ”©iÚs
 *)
fİs
)->
»ad
 = (
fe_İs_»ad_â
)read;

146 
	}
}

148 
	$shªnÚ_£t_fe_İs_wr™e_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
wr™e
)

150 ((
fe_İ”©iÚs
 *)
fİs
)->
wr™e
 = (
fe_İs_wr™e_â
)write;

151 
	}
}

153 
	$shªnÚ_£t_fe_İs_İ’_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
İ’
)

155 ((
fe_İ”©iÚs
 *)
fİs
)->
İ’
 = (
fe_İs_İ’_â
)open;

156 
	}
}

158 
	$shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
»Ëa£
)

160 ((
fe_İ”©iÚs
 *)
fİs
)->
»Ëa£
 = (
fe_İs_»Ëa£_â
)release;

161 
	}
}

163 
	$shªnÚ_£t_£q_İs_¡¬t_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
¡¬t
)

165 ((
£q_İ”©iÚs
 *)
sİs
)->
¡¬t
 = (
£q_İs_¡¬t_â
)start;

166 
	}
}

168 
	$shªnÚ_£t_£q_İs_¡İ_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
¡İ
)

170 ((
£q_İ”©iÚs
 *)
sİs
)->
¡İ
 = (
£q_İs_¡İ_â
)stop;

171 
	}
}

173 
	$shªnÚ_£t_£q_İs_Ãxt_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
Ãxt
)

175 ((
£q_İ”©iÚs
 *)
sİs
)->
Ãxt
 = (
£q_İs_Ãxt_â
)next;

176 
	}
}

178 
	$shªnÚ_£t_£q_İs_show_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
show
)

180 ((
£q_İ”©iÚs
 *)
sİs
)->
show
 = (
£q_İs_show_â
)show;

181 
	}
}

185 
shªnÚ_d’Œy_t
 *
	$shªnÚ_debugfs_ü—‹_dœ
(cÚ¡ *
Çme
, 
shªnÚ_d’Œy_t
 *
·»Á
)

187  
	`debugfs_ü—‹_dœ
(
Çme
, (
d’Œy
 *)
·»Á
);

188 
	}
}

190 
shªnÚ_d’Œy_t
 *
	$shªnÚ_debugfs_ü—‹_fe
(cÚ¡ *
Çme
, 
shªnÚ_mode_t
 
mode
, 
shªnÚ_d’Œy_t
 *
·»Á
, *
d©a
, cÚ¡ 
shªnÚ_fe_İ”©iÚs_t
 *
fİs
){

191  
	`debugfs_ü—‹_fe
(
Çme
, 
mode
, (
d’Œy
 *)
·»Á
, 
d©a
, (
fe_İ”©iÚs
 *)
fİs
);

192 
	}
}

194 
	$shªnÚ_debugfs_»move
(
shªnÚ_d’Œy_t
 *
d’Œy
)

196 
	`debugfs_»move
((
d’Œy
 *)dentry);

197 
	}
}

	@shannon_file.h

1 #iâdeà
__SHANNON_FILE_H


2 
	#__SHANNON_FILE_H


	)

3 
	~"shªnÚ_kcÜe.h
"

5 
	s__shªnÚ_fe_İ”©iÚs
 {

6 
RESERVE_MEM
(248);

9 
	s__shªnÚ_£q_İ”©iÚs
 {

10 
RESERVE_MEM
(64);

14 
	tshªnÚ_fe_t
;

15 
	tshªnÚ_šode_t
;

16 
	tshªnÚ_d’Œy_t
;

17 
	tshªnÚ_£q_fe_t
;

18 
__shªnÚ_£q_İ”©iÚs
 
	tshªnÚ_£q_İ”©iÚs_t
;

19 
__shªnÚ_fe_İ”©iÚs
 
	tshªnÚ_fe_İ”©iÚs_t
;

23 
shªnÚ_£q_İ’
(
shªnÚ_fe_t
 *
fe
, 
shªnÚ_£q_İ”©iÚs_t
 *
İ
);

24 
shªnÚ_ssize_t
 
shªnÚ_£q_»ad
(
shªnÚ_fe_t
 *
fe
, 
__u£r
 *
buf
, 
shªnÚ_size_t
 
size
, 
shªnÚ_loff_t
 *
µos
);

25 
shªnÚ_£q_puts
(
shªnÚ_£q_fe_t
 *
m
, cÚ¡ *
s
);

26 
shªnÚ_£q_´štf
(
shªnÚ_£q_fe_t
 *
m
, cÚ¡ *
f
, ...);

27 
shªnÚ_sšgË_İ’
(
shªnÚ_fe_t
 *
fe
, (*
show
)(
shªnÚ_£q_fe_t
 *, *), *
d©a
);

28 
	`shªnÚ_sšgË_»Ëa£
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
);

29 
shªnÚ_li¡_h—d
 *
	`shªnÚ_£q_li¡_¡¬t
(shªnÚ_li¡_h—d *
h—d
, 
shªnÚ_loff_t
 
pos
);

30 
shªnÚ_li¡_h—d
 *
	`shªnÚ_£q_li¡_¡¬t_h—d
(shªnÚ_li¡_h—d *
h—d
, 
shªnÚ_loff_t
 
pos
);

31 
shªnÚ_li¡_h—d
 *
	`shªnÚ_£q_li¡_Ãxt
(*
v
, shªnÚ_li¡_h—d *
h—d
, 
shªnÚ_loff_t
 *
µos
);

32 
shªnÚ_loff_t
 
	`shªnÚ_£q_l£ek
(
shªnÚ_fe_t
 *
fe
, shªnÚ_loff_ˆ
off£t
, 
Üigš
);

33 
	`shªnÚ_£q_»Ëa£
(
shªnÚ_šode_t
 *
šode
, 
shªnÚ_fe_t
 *
fe
);

35 *
	`shªnÚ_fe_´iv©e_d©a
(
shªnÚ_fe_t
 *
fe
);

36 
	`shªnÚ_£t_fe_´iv©e_d©a
(
shªnÚ_fe_t
 *
fe
, *
pv
);

37 *
	`shªnÚ_£q_fe_´iv©e
(
shªnÚ_£q_fe_t
 *
fe
);

38 
	`shªnÚ_£t_£q_fe_´iv©e
(
shªnÚ_£q_fe_t
 *
¥
, *
pv
);

39 *
	`shªnÚ_šode_i_´iv©e
(
shªnÚ_šode_t
 *
šode
);

41 
	`shªnÚ_£t_fe_İs_owÃr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
owÃr
);

42 
	`shªnÚ_£t_fe_İs_Î£ek_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
Î£ek
);

43 
	`shªnÚ_£t_fe_İs_»ad_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
»ad
);

44 
	`shªnÚ_£t_fe_İs_wr™e_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
wr™e
);

45 
	`shªnÚ_£t_fe_İs_İ’_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
İ’
);

46 
	`shªnÚ_£t_fe_İs_»Ëa£_hªdËr
(
shªnÚ_fe_İ”©iÚs_t
 *
fİs
, *
»Ëa£
);

48 
	`shªnÚ_£t_£q_İs_¡¬t_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
¡¬t
);

49 
	`shªnÚ_£t_£q_İs_¡İ_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
¡İ
);

50 
	`shªnÚ_£t_£q_İs_Ãxt_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
Ãxt
);

51 
	`shªnÚ_£t_£q_İs_show_hªdËr
(
shªnÚ_£q_İ”©iÚs_t
 *
sİs
, *
show
);

54 
shªnÚ_d’Œy_t
 *
	`shªnÚ_debugfs_ü—‹_dœ
(cÚ¡ *
Çme
, shªnÚ_d’Œy_ˆ*
·»Á
);

55 
shªnÚ_d’Œy_t
 *
	`shªnÚ_debugfs_ü—‹_fe
(cÚ¡ *
Çme
, 
shªnÚ_mode_t
 
mode
, shªnÚ_d’Œy_ˆ*
·»Á
, *
d©a
, cÚ¡ 
shªnÚ_fe_İ”©iÚs_t
 *
fİs
);

56 
	`shªnÚ_debugfs_»move
(
shªnÚ_d’Œy_t
 *
d’Œy
);

	@shannon_fpga_emu.c

13 
	$´eš™_emuÏtÜ_exec_cmd
(
shªnÚ_lun_b¬
 *
lun_£ùiÚ
, 
lun£t_šdex
)

15 
shªnÚ_»que¡
 
»q
;

16 
shªnÚ_cmd
 *
cmd
;

17 
sq_
;

18 
u8
 *
ecc
, *
¡©us
;

19 
u64
 *
m‘ad©a
, *
tmp
, 
sq_addr
, 
cq_addr
;

20 
cmd_Ën
 = 8;

21 
shªnÚ_emu_lun
 *
emu_lun
;

23 
	`shªnÚ_mem£t
(&
»q
, 0, (
shªnÚ_»que¡
));

24 
sq_
 = 
lun_£ùiÚ
->sq_tail;

25 
sq_addr
 = ((
u64
)
lun_£ùiÚ
->
sq_dma_addr1
 << 32)|lun_£ùiÚ->
sq_dma_addr0
;

26 
cq_addr
 = ((
u64
)
lun_£ùiÚ
->
cq_dma_addr1
 << 32)|lun_£ùiÚ->
cq_dma_addr0
;

27 
cmd
 = (
shªnÚ_cmd
 *)(
sq_addr
 + 
sq_
);

28 
	`BUG_ON
(
cmd
->
phy_lun
 > 
emu_luns
[0].
max_chªÃls
 *ƒmu_luns[0].
max_lun£t_š_chªÃl
 *ƒmu_luns[0].
hw_lun_š_lun£t
);

29 
emu_lun
 = &
emu_luns
[
cmd
->
phy_lun
];

30 
cmd
->
İcode
) {

31 
sh_cmd_»£t
:

32 
cmd_Ën
 = 8;

33 
¡©us
 = (
__u8
 *)(
cq_addr
 + 
sq_
);

34 *
¡©us
 = 0;

36 
sh_cmd_´e_»ad
:

37 
cmd_Ën
 = 8;

38 
¡©us
 = (
__u8
 *)(
cq_addr
 + 
sq_
);

39 *
¡©us
 = 
emu_lun
->
	`´e_»ad
Ómu_lun, 
cmd
->
µa
);

41 
sh_cmd_»ad
:

42 
cmd_Ën
 = 16;

43 
ecc
 = (
__u8
 *)(
cq_addr
 + 
sq_
);

44 
m‘ad©a
 = 
	`cmd_queue_šc
(
ecc
, 1);

45 
»q
.
pba
.
lun_pba
 = (
cmd
->
µa
 << 
emu_lun
->
logicb_shiá
è+ cmd->
fœ¡_logicb
;

46 
tmp
 = 
	`cmd_queue_šc
(
cmd
, 1);

47 
»q
.
vœt_addr
 = (*)(*
tmp
);

48 
»q
.
lba
 = 
INVALID_LBA
;

49 
ecc
[0] = (
u8
)
emu_lun
->
	`ÿche_»ad
Ómu_lun, 
»q
.
pba
.
lun_pba
, &req);

50 *
m‘ad©a
 = 
»q
.
emu_m‘ad©a
;

51 
	`shªnÚ_šfo
("%s():„—d:ƒcc=%d, m‘ad©a=0x%Îx.\n", 
__func__
, *
ecc
, *
m‘ad©a
);

54 
	`shªnÚ_”r
("Unknown command.\n");

56 
lun_£ùiÚ
->
sq_
 = (lun_£ùiÚ->sq_ + 
cmd_Ën
)%
QUEUE_SIZE
;

57 
lun_£ùiÚ
->
cq_h—d
 =†un_£ùiÚ->
sq_
;

60 
	}
}

62 
	$´eš™_emuÏtÜ_th»ad
(*
d©a
)

64 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
 = 
d©a
;

65 
sq_h—d
, 
sq_
;

66 
i
, 
æag
;

69 
æag
 = 0;

70 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_INTERRUPTIBLE
);

72 
i
 = 0; i < 
MBR_MAX_TRY
; i++) {

73 
sq_h—d
 = 
lun_£ùiÚ
[
i
].sq_head;

74 
sq_
 = 
lun_£ùiÚ
[
i
].sq_tail;

75 ià(
sq_h—d
 !ğ
sq_
) {

76 
æag
 = 1;

77 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_RUNNING
);

78 
	`´eš™_emuÏtÜ_exec_cmd
(
lun_£ùiÚ
 + 
i
, i);

81 ià(
æag
 == 0)

82 
	`shªnÚ_scheduË
();

83 } !
	`shªnÚ_kth»ad_should_¡İ
());

85 
	}
}

87 
	$g‘_sq_
(
shªnÚ_lun£t
 *
lun£t
)

89 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
lun£t
->
emu_wa™
, (
	`shªnÚ_kth»ad_should_¡İ
(è|| (lun£t->
sq_hw_h—d
 !ğlun£t->
sq_hw_
)));

90  
lun£t
->
sq_hw_
;

91 
	}
}

93 
u64
 *
	gm‘ad©a_·r™y
[2];

94 *
	g·r™y_buf
[2];

95 
¥šlock_t
 
	g·r™y_buf_lock
[2];

96 
	gÏ¡_sb_dÚe
[2] = {1, 1};

97 
shªnÚ_wa™_queue_h—d_t
 
	gsb_dÚe_ev’t
[2];

98 
©omic_t
 
	g»maššg_¡re_·ges
[2];

99 
	gcu¼’t_¡re_·ge
[2] = {-1, -1};

100 
©omic_t
 
	g»maššg_·ges
[2];

101 
	g·ges_š_group
[2];

102 
	gcu¼’t_·r™y_group
[2] = {-1, -1};

103 
shªnÚ_wa™_queue_h—d_t
 
	gwr™e_dÚe_ev’t
[2];

104 
shªnÚ_wa™_queue_h—d_t
 
	gÏ¡_·r™y_dÚe_ev’t
[2];

105 
	g·r™y_cmd
[2];

107 
	ggroups_š_¡re
 = 1;

109 
	$buf_xÜ
(*
de¡
, *
¤c
, 
size
)

111 *
d
 = 
de¡
;

112 cÚ¡ *
s
 = 
¤c
;

113 
k
;

115 
k
 = 0; k < 
size
; k++)

116 
d
[
k
] = 
s
[k] ^ d[k];

117 
	}
}

119 
	$logicb_buf_xÜ
(
shªnÚ_»que¡
 *
»q
, *
buf
, 
shªnÚ_dev
 *
sdev
)

121 
¶ªe
 = (
»q
->
pba
.
lun_pba
 % (
sdev
->
logicbs_š_siblšg_eblock
)è/ (sdev->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

122 
logicb_šdex
 = 
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
;

123 *
de¡
 = 
buf
 + 
sdev
->
Çnd_·ge_ÿ·c™y
 * 
¶ªe
 + sdev->
logicb_size
 * 
logicb_šdex
;

124 *
¤c
 = (*)
»q
->
dma_add»ss
;

126 ià(
»q
->
dma_add»ss_2
) {

127 
fœ¡_size
, 
Ï¡_size
;

128 
Ï¡_size
 = ()
»q
->
dma_add»ss
 & (
sdev
->
logicb_size
 - 1);

129 
fœ¡_size
 = 
sdev
->
logicb_size
 - 
Ï¡_size
;

130 
	`BUG_ON
(
Ï¡_size
 == 0);

131 
	`BUG_ON
(
fœ¡_size
 == 0);

132 
	`buf_xÜ
(
de¡
, 
¤c
, 
fœ¡_size
);

133 
¤c
 = (*)
»q
->
dma_add»ss_2
;

134 
	`buf_xÜ
(
de¡
 + 
fœ¡_size
, 
¤c
, 
Ï¡_size
);

136 
	`buf_xÜ
(
de¡
, 
¤c
, 
sdev
->
logicb_size
);

137 
	}
}

139 
	$emuÏtÜ_th»ad
(*
d©a
)

141 
shªnÚ_lun£t
 *
lun£t
 = (shªnÚ_lun£ˆ*)
d©a
;

142 
shªnÚ_emu_lun
 *
emu_lun
;

143 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

144 
shªnÚ_»que¡
 *
»q
;

145 
shªnÚ_cmd
 *
cmd
;

146 
shªnÚ_cmd_šfo
 *
šfo
;

147 
shªnÚ_sb
 *
sb
;

148 
shªnÚ_li¡_h—d
 
li¡_h—d
;

149 
sq_hw_
;

150 
i
, 
h—d_šdex
, 
¡re_·ge
, 
¶ªe
, 
·r™y_group
;

151 
u8
 *
ecc
, *
¡©us
;

152 
u64
 *
m‘ad©a
;

153 
¶ªe_mask
 = (
sdev
->
¶ªes
 - 1è* sdev->
·ges_š_eblock
;

155 
__echo_š
;

157 
sq_hw_
 = 
	`g‘_sq_
(
lun£t
);

159 ià(
sq_hw_
 =ğ
lun£t
->
sq_hw_h—d
)

161 
cmd
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + (
sq_hw_
>>3));

162 
šfo
 = &
lun£t
->
cmd_šfo
[
sq_hw_
>>3];

163 
	`BUG_ON
(
cmd
->
phy_lun
 > 
emu_luns
[0].
max_chªÃls
 *ƒmu_luns[0].
max_lun£t_š_chªÃl
 *ƒmu_luns[0].
hw_lun_š_lun£t
);

164 
emu_lun
 = &
emu_luns
[
cmd
->
phy_lun
];

165 
cmd
->
İcode
) {

166 
sh_cmd_»£t
:

167 
¡©us
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

168 *
¡©us
 = 0;

170 
sh_cmd_no_İ
:

171 
¡©us
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

172 *
¡©us
 = 0xe0;

174 
sh_cmd_´e_»ad
:

175 
¡©us
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

176 *
¡©us
 = 
emu_lun
->
	`´e_»ad
Ómu_lun, 
cmd
->
µa
);

178 
sh_cmd_»ad
:

179 
sh_cmd_advªûd_»ad
:

180 
sh_cmd_»ad_’d
:

181 ià(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

182 
	`shªnÚ_”r
("NØ»que¡ š„—d commªd info.†’gth=%d. !!!!! ----\n", 
šfo
->
cmd_Ën
);

183 
	`BUG
();

185 
ecc
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

186 
m‘ad©a
 = 
	`cmd_queue_šc
(
ecc
, 1);

187 
i
 = 0;

188 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
šfo
->
»q_li¡
, 
li¡
) {

189 
ecc
[
i
] = (
u8
)
emu_lun
->
	`ÿche_»ad
Ómu_lun, 
»q
->
pba
.
lun_pba
,„eq);

190 *
m‘ad©a
 = 
»q
->
emu_m‘ad©a
;

191 
m‘ad©a
 = 
	`cmd_queue_šc
(metadata, 1);

192 
i
++;

195 
sh_cmd_wr™e
:

196 ià(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

197 
	`shªnÚ_”r
("NØ»que¡ š wr™commªd info.†’gth=%d. !!! ---\n", 
šfo
->
cmd_Ën
);

198 
	`BUG
();

200 
h—d_šdex
 = 
cmd
->
h—d
 & 
HEAD_INDEX_MASK
;

201 ià(
sdev
->
¿id5_suµÜ‹d
 && (
cmd
->
µa
 >ğsdev->
·ges_š_eblock
 * sdev->
mbr_eblocks
)) {

202 
¡re_·ge
 = 
cmd
->
µa
 & ~
¶ªe_mask
;

203 
·r™y_group
 = 
cmd
->
¿id_¡re
;

204 
	`BUG_ON
(
·r™y_group
 !ğ
cmd
->
phy_lun
/
sdev
->
max_luns_š_group
);

205 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
Ï¡_·r™y_dÚe_ev’t
[
h—d_šdex
], \

206 (
cu¼’t_¡re_·ge
[
h—d_šdex
] =ğ
¡re_·ge
è&& (
cu¼’t_·r™y_group
[h—d_šdex] =ğ
·r™y_group
));

209 
m‘ad©a
 = (
u64
 *)
cmd
;

210 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
šfo
->
»q_li¡
, 
li¡
) {

211 ià(
»q
->
dma_add»ss_2
)

212 
m‘ad©a
 = 
	`cmd_queue_šc
(metadata, 3);

214 
m‘ad©a
 = 
	`cmd_queue_šc
(metadata, 2);

215 
»q
->
emu_m‘ad©a
 = *
m‘ad©a
;

216 
	`BUG_ON
(
»q
->
emu_m‘ad©a
 !ğ»q->
lba
);

217 
¶ªe
 = (
»q
->
pba
.
lun_pba
 % (
sdev
->
logicbs_š_siblšg_eblock
)è/ (sdev->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

218 ià(
sdev
->
¿id5_suµÜ‹d
 && (
cmd
->
µa
 >ğsdev->
·ges_š_eblock
 * sdev->
mbr_eblocks
)) {

219 
	`¥š_lock
(&
·r™y_buf_lock
[
h—d_šdex
]);

220 
m‘ad©a_·r™y
[
h—d_šdex
][
¶ªe
 * 
sdev
->
logicbs_š_·ge
 + 
»q
->
pba
.
lun_pba
 % sdev->logicbs_š_·ge] ^ğ»q->
emu_m‘ad©a
;

221 
	`logicb_buf_xÜ
(
»q
, 
·r™y_buf
[
h—d_šdex
], 
sdev
);

222 
	`¥š_uÆock
(&
·r™y_buf_lock
[
h—d_šdex
]);

225 
¡©us
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

226 ià(
cmd
->
h—d
 & 
DUMMY_WRITE_MASK
)

227 *
¡©us
 = 0xe0;

229 *
¡©us
 = 
emu_lun
->
	`wr™e
Ómu_lun, 
cmd
->
µa
, &
šfo
->
»q_li¡
);

231 ià(
sdev
->
¿id5_suµÜ‹d
 && (
cmd
->
µa
 >ğsdev->
·ges_š_eblock
 * sdev->
mbr_eblocks
)) {

232 
	`©omic_»ad
(&
»maššg_·ges
[
h—d_šdex
]) <= 0)

233 
	`shªnÚ_m¦“p
(1);

234 ià(
	`©omic_dec_ªd_‹¡
(&
»maššg_·ges
[
h—d_šdex
]))

235 
	`shªnÚ_wake_up
(&
wr™e_dÚe_ev’t
[
h—d_šdex
]);

238 
sh_cmd_”a£
:

239 
¡©us
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

240 *
¡©us
 = 
emu_lun
->
	`”a£
Ómu_lun, 
cmd
->
µa
/
sdev
->
·ges_š_eblock
);

242 
sh_cmd_·r™y_š™
:

243 
h—d_šdex
 = 
cmd
->
h—d
 & 
HEAD_INDEX_MASK
;

244 ià(
·r™y_buf
[
h—d_šdex
] =ğ
NULL
) {

245 
m‘ad©a_·r™y
[
h—d_šdex
] = 
	`shªnÚ_kz®loc
(8 * 
sdev
->
logicbs_š_chunk
, 
GFP_SHANNON
);

246 
·r™y_buf
[
h—d_šdex
] = 
	`shªnÚ_kz®loc
(
sdev
->
logicb_size
 * sdev->
logicbs_š_chunk
, 
GFP_SHANNON
);

247 ià(
·r™y_buf
[
h—d_šdex
] =ğ
NULL
) {

248 
	`shªnÚ_”r
("®loÿ‹ % ·r™y_buàçed!\n", 
h—d_šdex
?"cold":"hot");

249 
	`BUG
();

252 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sb_dÚe_ev’t
[
h—d_šdex
], 
Ï¡_sb_dÚe
[head_index] == 1);

253 
Ï¡_sb_dÚe
[
h—d_šdex
] = 0;

254 
	`©omic_£t
(&
»maššg_¡re_·ges
[
h—d_šdex
], 
sdev
->
·ges_š_eblock
 - (
cmd
->
µa
 % (sdev->·ges_š_eblock * sdev->
¶ªes
)));

255 
·r™y_cmd
[
h—d_šdex
] = 
sdev
->
¶ªes
;

256 
sb
 = 
sdev
->
sbs
 + 
cmd
->
µa
 / (sdev->
·ges_š_eblock
 * sdev->
¶ªes
);

257 
·ges_š_group
[
h—d_šdex
] = 
cmd
->
d©a_luns
 * 
sdev
->
¶ªes
;

259 
	`©omic_£t
(&
»maššg_·ges
[
h—d_šdex
], 
·ges_š_group
[head_index]);

260 
cu¼’t_¡re_·ge
[
h—d_šdex
] = 
cmd
->
µa
 & ~
¶ªe_mask
;

261 
cu¼’t_·r™y_group
[
h—d_šdex
] = 
cmd
->
¿id_¡re
;

262 
	`BUG_ON
(
cmd
->
¿id_¡re
 !ğcmd->
phy_lun
/
sdev
->
max_luns_š_group
);

263 
	`shªnÚ_wake_up
(&
Ï¡_·r™y_dÚe_ev’t
[
h—d_šdex
]);

265 
sh_cmd_·r™y
:

266 
h—d_šdex
 = 
cmd
->
h—d
 & 
HEAD_INDEX_MASK
;

267 
¡re_·ge
 = 
cmd
->
µa
 & ~
¶ªe_mask
;

268 
·r™y_group
 = 
cmd
->
¿id_¡re
;

269 
	`BUG_ON
(
·r™y_group
 !ğ
cmd
->
phy_lun
/
sdev
->
max_luns_š_group
);

270 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
Ï¡_·r™y_dÚe_ev’t
[
h—d_šdex
], \

271 (
cu¼’t_¡re_·ge
[
h—d_šdex
] =ğ
¡re_·ge
è&& (
cu¼’t_·r™y_group
[h—d_šdex] =ğ
·r™y_group
));

272 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
wr™e_dÚe_ev’t
[
h—d_šdex
], 
	`©omic_»ad
(&
»maššg_·ges
[head_index]) == 0);

273 
¶ªe
 = (
cmd
->
µa
 % (
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
)) / sdev->pages_in_eblock;

274 
	`SHANNON_INIT_LIST_HEAD
(&
li¡_h—d
);

275 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

276 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

277 
»q
->
emu_m‘ad©a
 = 
m‘ad©a_·r™y
[
h—d_šdex
][
¶ªe
 * 
sdev
->
logicbs_š_·ge
 + 
i
];

278 
»q
->
lba
 = (
logicb_t
ìeq->
emu_m‘ad©a
;

279 
»q
->
pba
.
lun
 = 
emu_lun
->
logiÿl_lun
;

280 
»q
->
pba
.
lun_pba
 = 
cmd
->
µa
 * 
sdev
->
logicbs_š_·ge
 + 
i
;

281 
»q
->
vœt_addr
 = 
·r™y_buf
[
h—d_šdex
] + 
sdev
->
Çnd_·ge_ÿ·c™y
 * 
¶ªe
 + sdev->
logicb_size
 * 
i
;

282 
»q
->
dma_add»ss
 = (
dma_addr_t
ìeq->
vœt_addr
;

283 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
li¡_h—d
);

285 
¡©us
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (
sq_hw_
>>3));

286 *
¡©us
 = 
emu_lun
->
	`wr™e
Ómu_lun, 
cmd
->
µa
, &
li¡_h—d
);

287 
	`mem£t
(
m‘ad©a_·r™y
[
h—d_šdex
] + 
sdev
->
logicbs_š_·ge
 * 
¶ªe
, 0, 8 * sdev->logicbs_in_page);

288 
	`mem£t
(
·r™y_buf
[
h—d_šdex
] + 
sdev
->
Çnd_·ge_ÿ·c™y
 * 
¶ªe
, 0, sdev->nand_page_capacity);

289 !
	`shªnÚ_li¡_em±y
(&
li¡_h—d
)) {

290 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
li¡_h—d
, 
shªnÚ_»que¡
, 
li¡
);

291 
	`shªnÚ_li¡_d–
(&
»q
->
li¡
);

292 
	`ä“_»q
(
»q
);

295 
·r™y_cmd
[
h—d_šdex
]--;

296 ià(
·r™y_cmd
[
h—d_šdex
] == 0) {

297 
·r™y_cmd
[
h—d_šdex
] = 
sdev
->
¶ªes
;

298 
	`©omic_£t
(&
»maššg_·ges
[
h—d_šdex
], 
·ges_š_group
[head_index]);

299 
cu¼’t_·r™y_group
[
h—d_šdex
]++;

300 ià(
cu¼’t_·r™y_group
[
h—d_šdex
] =ğ
groups_š_¡re
) {

301 
cu¼’t_·r™y_group
[
h—d_šdex
] = 0;

302 ià(
	`©omic_dec_ªd_‹¡
(&
»maššg_¡re_·ges
[
h—d_šdex
])) {

303 
Ï¡_sb_dÚe
[
h—d_šdex
] = 1;

304 
	`shªnÚ_wake_up
(&
sb_dÚe_ev’t
[
h—d_šdex
]);

306 
cu¼’t_¡re_·ge
[
h—d_šdex
]++;

307 
	`shªnÚ_wake_up
(&
Ï¡_·r™y_dÚe_ev’t
[
h—d_šdex
]);

310 
	`shªnÚ_wake_up
(&
Ï¡_·r™y_dÚe_ev’t
[
h—d_šdex
]);

315 
	`shªnÚ_”r
("UÄecognized opcod0x%x.\n", 
cmd
->
İcode
);

317 
lun£t
->
sq_hw_
 = (lun£t->sq_hw_ + 
šfo
->
cmd_Ën
)%
QUEUE_SIZE
;

318 
lun£t
->
cq_hw_h—d
 =†un£t->
sq_hw_
;

319 
	`¥š_lock_bh
(&
emu_št_lock
);

320 
emu_š‹¼u±_veùÜ
 |ğ(1 << 
lun£t
->
šdex
);

321 ià(
emu_di§bË_œq
 == 0) {

322 
emu_di§bË_œq
 = 1;

323 
	`shªnÚ_skËt_scheduË
(&
sdev
->
comp_skËt
);

325 
	`¥š_uÆock_bh
(&
emu_št_lock
);

327 
__echo_out
;

329 
	}
}

331 #ifdeà
SHANNON_USE_WRITE_BUFFER


332 
	$g‘_bufq_sq_
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

334 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
bufq_emu_wa™
[
h—d_šdex
], \

335 (
	`shªnÚ_kth»ad_should_¡İ
(è|| (
sdev
->
bufq_sq_hw_h—d
[
h—d_šdex
] !ğsdev->
bufq_sq_hw_
[head_index])));

336  
sdev
->
bufq_sq_hw_
[
h—d_šdex
];

337 
	}
}

339 *
	gwr_buf
[2];

340 
	#BUFQ_VECT_LUN
 0

	)

341 
	#BUFQ_VECT_CHUNK
 1

	)

342 
	#BUFQ_VECT_LOGICB
 2

	)

343 
	gbuf_šdex
[2][3] = {{0, 0, 0}, {0, 0, 0}};

344 
u64
 *
	gbufq_m‘ad©a
[2];

346 
	$bufq_emuÏtÜ_th»ad
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

348 
shªnÚ_buf_cmd
 *
cmd
;

349 
shªnÚ_cmd_šfo
 *
šfo
;

350 
u64
 *
m‘ad©a
, *
d©a_±r
;

351 
u8
 *
¡©us
;

352 
bufq_sq_hw_
;

353 
µa
, 
¶ªe
, 
¡re_·ge
, 
·r™y_group
;

354 
¶ªe_mask
 = (
sdev
->
¶ªes
 - 1è* sdev->
·ges_š_eblock
;

355 
fœ¡_size
, 
Ï¡_size
;

358 
bufq_sq_hw_
 = 
	`g‘_bufq_sq_
(
sdev
, 
h—d_šdex
);

360 ià(
bufq_sq_hw_
 =ğ
sdev
->
bufq_sq_hw_h—d
[
h—d_šdex
])

362 
¡©us
 = (
__u8
 *)(
sdev
->
bufq_cq_addr
[
h—d_šdex
] + (
bufq_sq_hw_
 >> 3));

363 
cmd
 = (
shªnÚ_buf_cmd
 *)(
sdev
->
bufq_sq_addr
[
h—d_šdex
] + (
bufq_sq_hw_
 >> 3));

364 
d©a_±r
 = 
	`cmd_queue_šc
(
cmd
, 1);

365 
šfo
 = &
sdev
->
cmd_šfo
[
h—d_šdex
][
bufq_sq_hw_
 >> 3];

366 
cmd
->
İcode
) {

367 
sh_cmd_buf_wr™e
:

368 
sh_cmd_buf_wr™e_no_comm™
:

369 
	`BUG_ON
(
cmd
->
logicb_šdex
 !ğ
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LOGICB
]);

370 ià(
cmd
->
logicb_šdex
 == 0) {

371 
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LUN
] = 
cmd
->
phy_lun
;

372 
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_CHUNK
] = 
cmd
->
µa
 & ~
¶ªe_mask
;

374 
	`BUG_ON
(
cmd
->
phy_lun
 !ğ
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LUN
]);

375 
	`BUG_ON
((
cmd
->
µa
 & ~
¶ªe_mask
è!ğ
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_CHUNK
]);

376 ià(
cmd
->
±es
) {

377 
Ï¡_size
 = ()*
d©a_±r
 & (
sdev
->
logicb_size
 - 1);

378 
fœ¡_size
 = 
sdev
->
logicb_size
 - 
Ï¡_size
;

379 
	`BUG_ON
(
Ï¡_size
 == 0);

380 
	`BUG_ON
(
fœ¡_size
 == 0);

381 
	`memıy
(
wr_buf
[
h—d_šdex
] + 
cmd
->
logicb_šdex
 * 
sdev
->
logicb_size
, (*)*
d©a_±r
, 
fœ¡_size
);

382 
d©a_±r
 = 
	`cmd_queue_šc
(data_ptr, 1);

383 
	`memıy
(
wr_buf
[
h—d_šdex
] + 
cmd
->
logicb_šdex
 * 
sdev
->
logicb_size
 + 
fœ¡_size
, (*)*
d©a_±r
, 
Ï¡_size
);

385 
	`memıy
(
wr_buf
[
h—d_šdex
] + 
cmd
->
logicb_šdex
 * 
sdev
->
logicb_size
, (*)*
d©a_±r
, sdev->logicb_size);

387 
m‘ad©a
 = 
	`cmd_queue_šc
(
d©a_±r
, 1);

388 
bufq_m‘ad©a
[
h—d_šdex
][
cmd
->
logicb_šdex
] = *
m‘ad©a
;

389 
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LOGICB
]++;

391 ià(
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LOGICB
] =ğ
sdev
->
logicbs_š_chunk
) {

392 ià(
sdev
->
¿id5_suµÜ‹d
) {

393 
¡re_·ge
 = 
cmd
->
µa
 & ~
¶ªe_mask
;

394 
·r™y_group
 = 
cmd
->
¿id_¡re
;

395 
	`BUG_ON
(
·r™y_group
 !ğ
cmd
->
phy_lun
/
sdev
->
max_luns_š_group
);

396 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
Ï¡_·r™y_dÚe_ev’t
[
h—d_šdex
], \

397 (
cu¼’t_¡re_·ge
[
h—d_šdex
] =ğ
¡re_·ge
è&& (
cu¼’t_·r™y_group
[h—d_šdex] =ğ
·r™y_group
));

400 
	`¥š_lock
(&
·r™y_buf_lock
[
h—d_šdex
]);

401 
	`buf_xÜ
(
m‘ad©a_·r™y
[
h—d_šdex
], 
bufq_m‘ad©a
[h—d_šdex], 
sdev
->
logicbs_š_chunk
 * (
u64
));

402 
	`buf_xÜ
(
·r™y_buf
[
h—d_šdex
], 
wr_buf
[h—d_šdex], 
sdev
->
logicbs_š_chunk
 * sdev->
logicb_size
);

403 
	`¥š_uÆock
(&
·r™y_buf_lock
[
h—d_šdex
]);

404 
µa
 = 
cmd
->ppa;

405 
¶ªe
 = 
sdev
->
¶ªes
 - 1;

407 
emu_luns
[
cmd
->
phy_lun
].
	`bufq_wr™e
Ómu_lun + cmd->phy_lun, 
µa
, 
wr_buf
[
h—d_šdex
] + 
sdev
->
Çnd_·ge_ÿ·c™y
 * 
¶ªe
, 
bufq_m‘ad©a
[h—d_šdex] + sdev->
logicbs_š_·ge
 *…lane);

408 
µa
 -ğ
sdev
->
·ges_š_eblock
;

409 
¶ªe
--;

411 ià(
sdev
->
¿id5_suµÜ‹d
) {

412 
	`©omic_»ad
(&
»maššg_·ges
[
h—d_šdex
]) <= 0)

413 
	`shªnÚ_m¦“p
(1);

414 ià(
	`©omic_dec_ªd_‹¡
(&
»maššg_·ges
[
h—d_šdex
]))

415 
	`shªnÚ_wake_up
(&
wr™e_dÚe_ev’t
[
h—d_šdex
]);

417 } 
¶ªe
 >= 0);

419 
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LOGICB
] = 0;

420 
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LUN
] = 0;

421 
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_CHUNK
] = 0;

423 *
¡©us
 = 0;

425 
sh_cmd_buf_»ad
:

426 
m‘ad©a
 = 
	`cmd_queue_šc
(
¡©us
, 1);

427 ià((
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LUN
] !ğ
cmd
->
phy_lun
) ||

428 (
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_CHUNK
] !ğ(
cmd
->
µa
 & ~
¶ªe_mask
)) ||

429 (
buf_šdex
[
h—d_šdex
][
BUFQ_VECT_LOGICB
] <ğ
cmd
->
logicb_šdex
)) {

430 
¡©us
[0] = 0xfe;

431 
¡©us
[1] = 0xff;

432 
¡©us
[2] = 0xff;

433 
¡©us
[3] = 0xff;

434 
¡©us
[4] = 0xff;

435 
¡©us
[5] = 0xff;

436 
¡©us
[6] = 0xff;

437 
¡©us
[7] = 0xff;

438 *
m‘ad©a
 = 0xffffffffffffffff;

439 
	`debugs1
("bufq_»ad:hi pb¨i nÙ iÀbufã¸queue.....phy_lun=%d,…·=%d, index=%d.\n", 
cmd
->
phy_lun
, cmd->
µa
, cmd->
logicb_šdex
);

442 ià(
cmd
->
±es
) {

443 
Ï¡_size
 = ()*
d©a_±r
 & (
sdev
->
logicb_size
 - 1);

444 
fœ¡_size
 = 
sdev
->
logicb_size
 - 
Ï¡_size
;

445 
	`BUG_ON
(
Ï¡_size
 == 0);

446 
	`BUG_ON
(
fœ¡_size
 == 0);

447 
	`memıy
((*)*
d©a_±r
, 
wr_buf
[
h—d_šdex
] + 
cmd
->
logicb_šdex
 * 
sdev
->
logicb_size
, 
fœ¡_size
);

448 
d©a_±r
 = 
	`cmd_queue_šc
(data_ptr, 1);

449 
	`memıy
((*)*
d©a_±r
, 
wr_buf
[
h—d_šdex
] + 
cmd
->
logicb_šdex
 * 
sdev
->
logicb_size
 + 
fœ¡_size
, 
Ï¡_size
);

451 
	`memıy
((*)*
d©a_±r
, 
wr_buf
[
h—d_šdex
] + 
cmd
->
logicb_šdex
 * 
sdev
->
logicb_size
, sdev->logicb_size);

452 *
m‘ad©a
 = 
bufq_m‘ad©a
[
h—d_šdex
][
cmd
->
logicb_šdex
];

453 
¡©us
[0] = 0;

454 
¡©us
[1] = 0;

455 
¡©us
[2] = 0;

456 
¡©us
[3] = 0;

457 
¡©us
[4] = 0;

458 
¡©us
[5] = 0;

459 
¡©us
[6] = 0;

460 
¡©us
[7] = 0;

463 
	`shªnÚ_”r
("unknowÀİcode=0x%x.\n", 
cmd
->
İcode
);

465 
sdev
->
bufq_sq_hw_
[
h—d_šdex
] = (sdev->bufq_sq_hw_[h—d_šdex] + 
šfo
->
cmd_Ën
)%
QUEUE_SIZE
;

466 
sdev
->
bufq_cq_hw_h—d
[
h—d_šdex
] = sdev->
bufq_sq_hw_
[head_index];

468 
	`¥š_lock_bh
(&
emu_št_lock
);

469 
emu_š‹¼u±_veùÜ
 |ğ(1UL << 
sdev
->
šŒ_big_shiá
[
h—d_šdex
]);

470 ià(
emu_di§bË_œq
 == 0) {

471 
emu_di§bË_œq
 = 1;

472 
	`shªnÚ_skËt_scheduË
(&
sdev
->
comp_skËt
);

474 
	`¥š_uÆock_bh
(&
emu_št_lock
);

477 
	}
}

479 
	$hÙ_bufq_emuÏtÜ_th»ad
(*
d©a
)

481 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
d©a
;

482 
	`bufq_emuÏtÜ_th»ad
(
sdev
, 
HOT_INDEX
);

484 
	}
}

486 
	$cŞd_bufq_emuÏtÜ_th»ad
(*
d©a
)

488 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
d©a
;

489 
	`bufq_emuÏtÜ_th»ad
(
sdev
, 
COLD_INDEX
);

491 
	}
}

495 
	$š™_åga_emu_v¬ŸbËs
(
shªnÚ_dev
 *
sdev
)

497 
	`¥š_lock_š™
(&
·r™y_buf_lock
[0]);

498 
	`¥š_lock_š™
(&
·r™y_buf_lock
[1]);

499 
	`shªnÚ_š™_wa™queue_h—d
(&
sb_dÚe_ev’t
[0]);

500 
	`shªnÚ_š™_wa™queue_h—d
(&
sb_dÚe_ev’t
[1]);

501 
	`©omic_£t
(&
»maššg_¡re_·ges
[0], 0);

502 
	`©omic_£t
(&
»maššg_¡re_·ges
[1], 0);

503 
	`©omic_£t
(&
»maššg_·ges
[0], 0xffffffff);

504 
	`©omic_£t
(&
»maššg_·ges
[1], 0xffffffff);

505 
	`shªnÚ_š™_wa™queue_h—d
(&
wr™e_dÚe_ev’t
[0]);

506 
	`shªnÚ_š™_wa™queue_h—d
(&
wr™e_dÚe_ev’t
[1]);

507 
	`shªnÚ_š™_wa™queue_h—d
(&
Ï¡_·r™y_dÚe_ev’t
[0]);

508 
	`shªnÚ_š™_wa™queue_h—d
(&
Ï¡_·r™y_dÚe_ev’t
[1]);

510 #ifdeà
SHANNON_USE_WRITE_BUFFER


512 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
bufq_emu_wa™
[0]);

513 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
bufq_emu_wa™
[1]);

514 
sdev
->
bufq_emu_th»ad
[
HOT_INDEX
] = 
	`shªnÚ_kth»ad_run
(
hÙ_bufq_emuÏtÜ_th»ad
, sdev, "shannon_hot_bufq");

515 ià(
	`SHANNON_IS_ERR
(
sdev
->
bufq_emu_th»ad
[
HOT_INDEX
])) {

516 
	`shªnÚ_”r
("create hot_bufqƒmulatorhread failed.\n");

517 
	`BUG
();

519 
sdev
->
bufq_emu_th»ad
[
COLD_INDEX
] = 
	`shªnÚ_kth»ad_run
(
cŞd_bufq_emuÏtÜ_th»ad
, sdev, "shannon_cold_bufq");

520 ià(
	`SHANNON_IS_ERR
(
sdev
->
bufq_emu_th»ad
[
COLD_INDEX
])) {

521 
	`shªnÚ_”r
("create cold_bufqƒmulatorhread failed.\n");

522 
	`BUG
();

525 
wr_buf
[0] = 
	`shªnÚ_kz®loc
(
sdev
->
logicb_size
 * sdev->
logicbs_š_chunk
, 
GFP_SHANNON
);

526 ià(!
wr_buf
[0]) {

527 
	`shªnÚ_”r
("Can‚ot‡llocateƒnough memory for hot_buf.\n");

528 
	`BUG
();

530 
wr_buf
[1] = 
	`shªnÚ_kz®loc
(
sdev
->
logicb_size
 * sdev->
logicbs_š_chunk
, 
GFP_SHANNON
);

531 ià(!
wr_buf
[1]) {

532 
	`shªnÚ_”r
("Can‚ot‡llocateƒnough memory for cold_buf.\n");

533 
	`BUG
();

536 
bufq_m‘ad©a
[0] = 
	`shªnÚ_kz®loc
(
sdev
->
logicbs_š_chunk
 * (
u64
), 
GFP_SHANNON
);

537 
bufq_m‘ad©a
[1] = 
	`shªnÚ_kz®loc
(
sdev
->
logicbs_š_chunk
 * (
u64
), 
GFP_SHANNON
);

539 
	}
}

541 
	$ä“_åga_emu_v¬ŸbËs
(
shªnÚ_dev
 *
sdev
)

543 ià(
·r™y_buf
[0]) {

544 
	`shªnÚ_kä“
(
m‘ad©a_·r™y
[0]);

545 
	`shªnÚ_kä“
(
·r™y_buf
[0]);

547 ià(
·r™y_buf
[1]) {

548 
	`shªnÚ_kä“
(
m‘ad©a_·r™y
[1]);

549 
	`shªnÚ_kä“
(
·r™y_buf
[1]);

552 #ifdeà
SHANNON_USE_WRITE_BUFFER


553 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
bufq_emu_th»ad
[0]);

554 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
bufq_emu_th»ad
[1]);

555 
	`shªnÚ_kä“
(
wr_buf
[0]);

556 
	`shªnÚ_kä“
(
wr_buf
[1]);

557 
	`shªnÚ_kä“
(
bufq_m‘ad©a
[0]);

558 
	`shªnÚ_kä“
(
bufq_m‘ad©a
[1]);

560 
	}
}

	@shannon_ftl.c

12 
	~"shªnÚ_»gs.h
"

13 
	~"shªnÚ.h
"

15 
	gwl_debug
 = 0;

16 
shªnÚ_memblock_´—Îoc
;

17 
shªnÚ_š™_‹mp
;

18 
shªnÚ_memblock_poŞ
 
m­_bË_poŞ
;

19 
shªnÚ_memblock_poŞ
 
‹mp_bË_poŞ
;

20 
shªnÚ_fÜû_»şaim_aùiveblock
;

21 
shªnÚ_dyÇmic_œq_d–ay
;

23 
	$g‘_·r™y_lun
(
sub_group
 *
group
)

25  
group
->
¡¬t_lun
 + group->
·r™y_lun_off£t
;

26 
	}
}

28 
	$fœ¡_lun
(
sub_group
 *
group
)

30  
group
->
¡¬t_lun
 + group->
fœ¡_lun_off£t
;

31 
	}
}

33 
	$Ï¡_d©a_lun
(
sub_group
 *
group
)

35  
group
->
¡¬t_lun
 + group->
Ï¡_d©a_lun_off£t
;

36 
	}
}

38 #ifdeà
CONFIG_SHANNON_DEBUG


39 
	~"shªnÚ_debug.c
"

42 
	$Ímt_lock_š™
(
m­_bË_¡ruù
 *
Ímt
)

44 
i
;

45 
i
 = 0; i < 
LOCK_COUNT
; i++) {

46 
	`shªnÚ_¥š_lock_š™
(&
Ímt
->
m­_bË_lock
[
i
]);

49 
	}
}

51 
	$sdisk_m­_bË_lock_š™
(
shªnÚ_disk
 *
sdisk
)

53 
i
;

55 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++)

56 
	`Ímt_lock_š™
(&
sdisk
->
Ímt_¬¿y
[
i
]);

57 
	}
}

59 
	$£t_pba_bË_¡©e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
, 
¡©e
)

61 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
¡©e
;

62 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

63 
	`shªnÚ_£t_b™
(
b™_off£t
, 
b™_ba£
);

64 
	}
}

66 
	$ş—r_pba_bË_¡©e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
, 
¡©e
)

68 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
¡©e
;

69 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

70 
	`shªnÚ_ş—r_b™
(
b™_off£t
, 
b™_ba£
);

71 
	}
}

73 
	$‹¡_pba_bË_¡©e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
, 
¡©e
)

75 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
¡©e
;

76 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

77  
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
);

78 
	}
}

80 
	$‹¡_ªd_£t_pba_bË_¡©e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
, 
¡©e
)

82 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
¡©e
;

83 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

84  
	`shªnÚ_‹¡_ªd_£t_b™
(
b™_off£t
, 
b™_ba£
);

85 
	}
}

87 
	$£t_pba_Ãxt_h—d
(
shªnÚ_dev
 *
sdev
, 
lun
, 
logicb_t
 
lun_pba
, 
h—d
)

89 
h—d_šdex
 = 
h—d
 & 
HEAD_INDEX_MASK
;

91 
	`BUG_ON
((
h—d_šdex
 !=0) && (head_index != 1));

92 ià(
h—d_šdex
) {

93 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


94 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

96 
	`£t_pba_bË_¡©e
(
sdev
, 
lun
, 
lun_pba
, 
NEXT_HEAD_SHIFT
);

98 
	`ş—r_pba_bË_¡©e
(
sdev
, 
lun
, 
lun_pba
, 
NEXT_HEAD_SHIFT
);

99 
	}
}

102 
	$g‘_pba_Ãxt_h—d
(
shªnÚ_dev
 *
sdev
, 
lun
, 
logicb_t
 
lun_pba
)

104  
	`‹¡_pba_bË_¡©e
(
sdev
, 
lun
, 
lun_pba
, 
NEXT_HEAD_SHIFT
);

105 
	}
}

107 
	$£t_gc_»ad_¡©e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
)

109 
	`£t_pba_bË_¡©e
(
dev
, 
lun
, 
lun_pba
, 
STATE_GC_READ
);

110 
	}
}

112 
	$‹¡_gc_»ad_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

114  
	`‹¡_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_GC_READ
);

115 
	}
}

117 
	$£t_gc_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun_pba
 *
pba
)

119 
	`shªnÚ_©omic_šc
(&
dev
->
gc_š_æight
);

120 
sb
->
gc_š_æight
++;

121 
	`£t_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_GC_WRITE
);

122 
	}
}

124 
	$‹¡_ªd_£t_gc_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun_pba
 *
pba
)

126 
Şd_¡©e
;

127 
Şd_¡©e
 = 
	`‹¡_ªd_£t_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_GC_WRITE
);

128 ià(
Şd_¡©e
 == 0) {

129 
	`shªnÚ_©omic_šc
(&
dev
->
gc_š_æight
);

130 
sb
->
gc_š_æight
++;

132  
Şd_¡©e
;

133 
	}
}

135 
	$‹¡_gc_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

137  
	`‹¡_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_GC_WRITE
);

138 
	}
}

140 
	$£t_gc_wr™e_dÚe
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
lun_pba
 *
pba
)

142 
	`shªnÚ_©omic_dec
(&
dev
->
gc_š_æight
);

143 
sb
->
gc_š_æight
--;

144 
	}
}

146 
	$£t_pba_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
, 
h—d_šdex
)

148 
	`BUG_ON
((
h—d_šdex
 != 0) && (head_index != 1));

149 
	`£t_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_IN_HOT_BUFQ
 + 
h—d_šdex
);

150 
	}
}

152 
	$ş—r_pba_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun
, 
lun_pba
, 
h—d_šdex
)

154 
	`BUG_ON
((
h—d_šdex
 != 0) && (head_index != 1));

155 
	`ş—r_pba_bË_¡©e
(
dev
, 
lun
, 
lun_pba
, 
STATE_IN_HOT_BUFQ
 + 
h—d_šdex
);

156 
	}
}

158 
	$‹¡_pba_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun
, 
lun_pba
)

160  
	`‹¡_pba_bË_¡©e
(
dev
, 
lun
, 
lun_pba
, 
STATE_IN_HOT_BUFQ
) ||

161 
	`‹¡_pba_bË_¡©e
(
dev
, 
lun
, 
lun_pba
, 
STATE_IN_COLD_BUFQ
);

162 
	}
}

164 
	$g‘_h—d_šdex_š_bufq
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

166 if(
	`‹¡_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_IN_HOT_BUFQ
))

167  
HOT_INDEX
;

168 if(
	`‹¡_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_IN_COLD_BUFQ
)) {

169 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


170 
	`BUG_ON
(!
dev
->
u£_du®_h—d
);

172  
COLD_INDEX
;

175 
	}
}

177 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


178 
	$£t_ho¡_wr™e_šv®id
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

180 
	`£t_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_HOST_INVALID_WR
);

181 
	}
}

183 
	$£t_gc_wr™e_šv®id
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

185 
	`£t_pba_bË_¡©e
(
dev
, 
pba
->
lun
,…ba->
lun_pba
, 
STATE_GC_INVALID_WR
);

186 
	}
}

188 
	$£t_ho¡_wr™e_šv®id
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

191 
	}
}

193 
	$£t_gc_wr™e_šv®id
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

196 
	}
}

199 
	$£t_ho¡_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
Şd
)

201 
b™_off£t
 = (
Şd
->
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
STATE_HOST_WRITE
;

202 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[
Şd
->lun]->
pba_bË
 + (Şd->
lun_pba
*
PBA_ENTRY_LEN
)/64;

203 
	`shªnÚ_£t_b™
(
b™_off£t
, 
b™_ba£
);

204 
	}
}

206 
	$ş—r_ho¡_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
Şd
)

208 
b™_off£t
 = (
Şd
->
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
STATE_HOST_WRITE
;

209 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[
Şd
->lun]->
pba_bË
 + (Şd->
lun_pba
*
PBA_ENTRY_LEN
)/64;

210 
	`shªnÚ_ş—r_b™
(
b™_off£t
, 
b™_ba£
);

211 
	}
}

213 
	$‹¡_ho¡_wr™e_¡©e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
)

215 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
STATE_HOST_WRITE
;

216 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

218  
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
);

219 
	}
}

221 
	$‹¡_wr™e_š_´oûss
(
shªnÚ_dev
 *
dev
, 
lun_pba
 *
pba
)

223  
	`‹¡_gc_wr™e_¡©e
(
dev
, 
pba
è|| 
	`‹¡_ho¡_wr™e_¡©e
(dev,…ba->
lun
,…ba->
lun_pba
);

224 
	}
}

226 
	$is_¡®e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
)

228 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
STATE_STALE_SHIFT
;

229 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

231  
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
);

232 
	}
}

234 
	$£t_v®id
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
)

236 
sb_šdex
;

237 
shªnÚ_sb
 *
sb
;

238 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
STATE_STALE_SHIFT
;

239 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

241 
sb_šdex
 = 
lun_pba
/
dev
->
logicbs_š_siblšg_eblock
;

242 ià(!
	`shªnÚ_dev_is_g5
(
dev
))

243 
	`BUG_ON
(
sb_šdex
==0);

244 
sb
 = 
dev
->
sbs
 + 
sb_šdex
;

246 
	`shªnÚ_ş—r_b™
(
b™_off£t
, 
b™_ba£
);

247 
	`shªnÚ_©omic_šc
(&
sb
->
v®id_·ges
);

248 
	}
}

252 
	$£t_Şd_pba_¡®e
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
)

254 
sb_šdex
;

255 
shªnÚ_sb
 *
sb
;

256 
shªnÚ_¥šlock_t
 *
lock
;

257 
b™_off£t
 = (
lun_pba
*
PBA_ENTRY_LEN
)%64 + 
STATE_STALE_SHIFT
;

258 *
b™_ba£
 = (
u64
 *)
dev
->
lun
[lun]->
pba_bË
 + (
lun_pba
*
PBA_ENTRY_LEN
)/64;

260 
	`BUG_ON
(
	`shªnÚ_‹¡_b™
(
b™_off£t
, 
b™_ba£
));

262 
sb_šdex
 = 
lun_pba
/
dev
->
logicbs_š_siblšg_eblock
;

263 ià(!
	`shªnÚ_dev_is_g5
(
dev
))

264 
	`BUG_ON
(
sb_šdex
==0);

265 
sb
 = 
dev
->
sbs
 + 
sb_šdex
;

267 
	`shªnÚ_£t_b™
(
b™_off£t
, 
b™_ba£
);

268 ià(
	`uÆik–y
(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sb
->
v®id_·ges
è&& (
	`shªnÚ_©omic_»ad
(&sb->
š_wr™e_logicbs
) == 0))) {

269 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

270 
sb
->
¡©e
) {

271 
COPY_ERR_BLOCK
:

272 
	`shªnÚ_šfo
("% :block w™hy³ %d become em±y. sb_šdex=%d.\n", 
dev
->
sdisk
.
disk_Çme
,

273 
COPY_ERR_BLOCK
, 
sb
->
sb_šdex
);

274 
	`sb_m¬k_”rÜ_lun_bad
(
dev
, 
sb
);

275 
	`»move_äom_gc_¡©e_li¡
(
sb
);

276 
lock
 = &
dev
->
cİy_”r_lock
;

278 
ERROR_BLOCK
:

279 
	`shªnÚ_šfo
("%s: block w™hy³ %d become em±y. sb_šdex=%d.\n", 
dev
->
sdisk
.
disk_Çme
,

280 
ERROR_BLOCK
, 
sb
->
sb_šdex
);

281 
lock
 = &
dev
->
”r_blks_lock
;

283 
IN_RECOVER_BLOCK
:

284 
	`debugs1
("%s: A in_»cov”_block fšished. sb_šdex=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
);

285 
”a£
;

286 
IN_GC_BLOCK
:

288 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_blkút
);

289 
	`»move_äom_gc_¡©e_li¡
(
sb
);

290 
”a£
;

291 
IN_WL_BLOCK
:

293 
	`shªnÚ_©omic_dec
(&
dev
->
š_wl_blkút
);

294 
”a£
;

296 
LAST_HOT_BLOCK
:

297 
LAST_COLD_BLOCK
:

298 
”a£
;

299 
HOT_BLOCK_LIST
:

300 
lock
 = &
dev
->
u£d_blocks_lock
[
HOT_INDEX
];

302 
COLD_BLOCK_LIST
:

303 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


304 
	`BUG_ON
(!
dev
->
u£_du®_h—d
);

306 
lock
 = &
dev
->
u£d_blocks_lock
[
COLD_INDEX
];

308 
WAIT_COPY_BLOCK
:

309 
	`debugs3
("A wa™_cİy_block(sb_šdex=%dèbecom0 v®id_·ges.\n", 
sb
->
sb_šdex
);

310 
lock
 = &
dev
->
wa™_cİy_lock
;

312 
WAIT_WL_BLOCK
:

313 
	`debugs3
("A wa™_wl_block(sb_šdex=%dèbecom0 v®id_·ges.\n", 
sb
->
sb_šdex
);

314 
lock
 = &
dev
->
wa™_wl_lock
;

321 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

324 
	`shªnÚ_¥š_lock_bh
(
lock
);

325 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

326 ià(
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
)

327 
dev
->
u£d_blkút
[
HOT_INDEX
]--;

328 ià(
sb
->
¡©e
 =ğ
COLD_BLOCK_LIST
)

329 
dev
->
u£d_blkút
[
COLD_INDEX
]--;

330 ià(
sb
->
¡©e
 =ğ
COPY_ERR_BLOCK
)

331 
dev
->
cİy_”r_blkút
--;

332 ià(
sb
->
¡©e
 =ğ
WAIT_COPY_BLOCK
)

333 
dev
->
wa™_cİy_blkút
--;

334 ià(
sb
->
¡©e
 =ğ
ERROR_BLOCK
) {

335 
dev
->
”r_blkút
--;

336 
	`check_”r_blkút_dec
(
dev
);

338 
	`shªnÚ_¥š_uÆock_bh
(
lock
);

339 
”a£
:

341 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

342 
	`shªnÚ_¥š_lock_bh
(&
dev
->
wa™_”a£d_lock
);

343 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
dev
->
wa™_”a£d
);

344 
dev
->
wa™_”a£d_blkút
++;

345 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_”a£d_lock
);

346 ià(
	`lik–y
((
dev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& dev->
gc_th»ad
))

347 
	`shªnÚ_wake_up_´oûss
(
dev
->
gc_th»ad
);

348 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

350 
	}
}

352 
	$pba_is_šv®id
(
shªnÚ_dev
 *
dev
, 
lun
, 
logicb_t
 
lun_pba
)

354  
	`is_¡®e
(
dev
, 
lun
, 
lun_pba
è|| 
	`‹¡_ho¡_wr™e_¡©e
(dev,†un,†un_pba);

355 
	}
}

357 
	$ş—r_pba_bË
(
shªnÚ_dev
 *
dev
, 
sb_šdex
)

359 
off£t
 = (
sb_šdex
*
dev
->
logicbs_š_siblšg_eblock
*
PBA_ENTRY_LEN
)/8;

360 
Ën
 = (
dev
->
logicbs_š_siblšg_eblock
*
PBA_ENTRY_LEN
)/8;

361 
i
;

363 
i
 = 0; i < 
dev
->
lun_couÁ
; i++) {

364 ià(!
dev
->
lun
[
i
]->
pba_bË
)

366 
	`shªnÚ_mem£t
((*)
dev
->
lun
[
i
]->
pba_bË
 + 
off£t
, 
ALL_STALE
, 
Ën
);

368 
	}
}

370 
	sshªnÚ_chunk_»q
 {

371 
shªnÚ_»que¡
 *
	mfœ¡
;

372 
	mcouÁ
;

376 
	$g©h”_chunk_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_chunk_»q
 *
chunk
, 
shªnÚ_»que¡
 *
»q
)

378 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
) | \

379 (((
u64
)
»q
->
ns_id
 & 
NS_ID_MASK
è<< 
NS_ID_SHIFT
) | \

380 (((
u64
)
»q
->
ns_£q_num
 & 
NS_SEQ_NUM_MASK
è<< 
NS_SEQ_NUM_SHIFT
) | \

381 (
»q
->
lba
 & 
LONG_LBA_MASK
);

382 ià(
chunk
->
fœ¡
 =ğ
NULL
) {

383 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

384 
chunk
->
fœ¡
 = 
»q
;

386 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
chunk
->
fœ¡
->chunk_list);

387 
chunk
->
couÁ
++;

388 ià(
chunk
->
couÁ
 =ğ
sdev
->
logicbs_š_chunk
) {

389 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»q_queue_lock
[1]);

390 
	`shªnÚ_li¡_add_
(&
chunk
->
fœ¡
->
li¡
, &
sdev
->
»q_queue
[1]);

391 
chunk
->
fœ¡
 = 
NULL
;

392 
chunk
->
couÁ
 = 0;

393 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»q_queue_lock
[1]);

394 
	`shªnÚ_©omic_šc
(&
sdev
->
wr™e_»qs
[1]);

396 
	}
}

400 
	$»move_sb_äom_ä“_blk_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

402 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

403 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

404 
sdev
->
ä“_blkút
--;

405 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
ä“_blocks_lock
);

406 
	}
}

408 
	$__put_što_wa™_cİy_li¡
(
shªnÚ_sb
 *
sb
)

410 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

411 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_cİy_lock
);

412 
sb
->
¡©e
 = 
WAIT_COPY_BLOCK
;

413 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
wa™_cİy
);

414 
sdev
->
wa™_cİy_blkút
++;

415 
	`shªnÚ_šfo
("%s(): Add sb_šdex=%dØwa™_cİy†i¡.\n", 
__func__
, 
sb
->
sb_šdex
);

416 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_cİy_lock
);

417 
	}
}

420 
	$put_što_wa™_cİy_li¡
(
shªnÚ_sb
 *
sb
)

422 
	`shªnÚ_šfo
("%s():ƒÁ”, sb=%d.\n", 
__func__
, 
sb
->
sb_šdex
);

423 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

424 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

425 
	`__put_što_wa™_cİy_li¡
(
sb
);

426 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

427 
	}
}

429 
šlše
 
	$add_wr_group_pošt
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
h—d_šdex
)

431 
sub_group
 *
group
;

433 
	`BUG_ON
(
sdev
->
wr_group
[
h—d_šdex
] >ğsdev->
·r™y_groups
);

434 
	`BUG_ON
(
sdev
->
wr_chunk
[
h—d_šdex
] >ğsdev->
·ges_š_eblock
);

436 
sdev
->
wr_group
[
h—d_šdex
]++;

437 ià(
sdev
->
wr_group
[
h—d_šdex
] =ğsdev->
·r™y_groups
) {

438 
sdev
->
wr_group
[
h—d_šdex
] = 0;

439 
sdev
->
wr_chunk
[
h—d_šdex
]++;

441 ià(
	`lik–y
(
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_ACTIVE_DONE
)) {

442 ià((
sdev
->
·ges_š_eblock
 - sdev->
wr_chunk
[
h—d_šdex
]) < sdev->pages_in_eblock / 4) {

443 
sb
->
Ãxt_sb
 =ğ
INVALID_SB_INDEX
) {

444 
sb
->
Ãxt_sb
 = 
	`g‘_Ãxt_sb
(
sdev
, 
h—d_šdex
);

445 ià(
sb
->
Ãxt_sb
 !ğ
INVALID_SB_INDEX
)

447 
	`shªnÚ_m¦“p
(5);

448 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
wa™_ä“_blk
, (sdev->
ä“_blkút
 != 0));

450 
	`check_”a£d_¡©e
(&
sdev
->
sbs
[
sb
->
Ãxt_sb
]);

454 ià(
sdev
->
wr_chunk
[
h—d_šdex
] =ğsdev->
·ges_š_eblock
) {

458 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[
h—d_šdex
]];

459 } 
group
->
phy_šdex
 < 0);

462 
	}
}

464 
	$£nd_dummy_·r™y_»q
(
shªnÚ_sb
 *
sb
, 
·r™y_lun
, 
µa
)

466 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

467 
shªnÚ_»que¡
 *
»q
, *
·r™y
;

468 
¶ªe
;

471 
·r™y
 = 
	`®loc_»q
(
GFP_SHANNON
);

472 
	`£t_»q_debug_g
(
·r™y
, 
WRITE_PARITY_TAG
, 0);

473 
·r™y
->
İcode
 = 
sh_cmd_·r™y
;

474 
·r™y
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
] | (1 << 
DUMMY_WRITE_SHIFT
è| (1 << 
PHANTOM_WRITE_SHIFT
);

475 
·r™y
->
pba
.
lun
 = 
·r™y_lun
;

476 
·r™y
->
µa
 =…pa;

477 
·r™y
->
pba
.
lun_pba
 = 
µa
 * 
sdev
->
logicbs_š_·ge
;

478 
	`SHANNON_INIT_LIST_HEAD
(&
·r™y
->
chunk_li¡
);

480 
¶ªe
 = 1;

481 
¶ªe
 < 
sdev
->
¶ªes
) {

482 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

483 
	`£t_»q_debug_g
(
»q
, 
WRITE_PARITY_TAG
, 
¶ªe
);

484 
»q
->
İcode
 = 
sh_cmd_·r™y
;

485 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
] | (1 << 
DUMMY_WRITE_SHIFT
è| (1 << 
PHANTOM_WRITE_SHIFT
);

486 
»q
->
pba
.
lun
 = 
·r™y_lun
;

487 
»q
->
µa
 = 
·r™y
->µ¨+ 
sdev
->
·ges_š_eblock
 * 
¶ªe
;

488 
»q
->
pba
.
lun_pba
 =„eq->
µa
 * 
sdev
->
logicbs_š_·ge
;

489 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
·r™y
->chunk_list);

490 
¶ªe
++;

492 
	`add_»que¡_queue_
(
sb
->
sdev
, 
·r™y
, 1);

493 
	}
}

495 
	$£nd_·r™y_»q
(
shªnÚ_sb
 *
sb
, 
·r™y_lun
, 
µa
)

497 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

498 
shªnÚ_»que¡
 *
»q
, *
·r™y
;

499 
¶ªe
;

502 
·r™y
 = 
	`®loc_»q
(
GFP_SHANNON
);

503 
	`£t_»q_debug_g
(
·r™y
, 
WRITE_PARITY_TAG
, 0);

504 
·r™y
->
İcode
 = 
sh_cmd_·r™y
;

505 
·r™y
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

506 
·r™y
->
pba
.
lun
 = 
·r™y_lun
;

507 
·r™y
->
µa
 =…pa;

508 
·r™y
->
pba
.
lun_pba
 = 
µa
 * 
sdev
->
logicbs_š_·ge
;

509 
	`SHANNON_INIT_LIST_HEAD
(&
·r™y
->
chunk_li¡
);

511 
¶ªe
 = 1;

512 
¶ªe
 < 
sdev
->
¶ªes
) {

513 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

514 
	`£t_»q_debug_g
(
»q
, 
WRITE_PARITY_TAG
, 
¶ªe
);

515 
»q
->
İcode
 = 
sh_cmd_·r™y
;

516 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

517 
»q
->
pba
.
lun
 = 
·r™y_lun
;

518 
»q
->
µa
 = 
·r™y
->µ¨+ 
sdev
->
·ges_š_eblock
 * 
¶ªe
;

519 
»q
->
pba
.
lun_pba
 =„eq->
µa
 * 
sdev
->
logicbs_š_·ge
;

520 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
·r™y
->chunk_list);

521 
¶ªe
++;

523 
	`add_»que¡_queue_
(
sb
->
sdev
, 
·r™y
, 1);

524 
	}
}

526 
	$__fl_®l_bÏnk_•og_·r™y_group_ÿÎback
(
shªnÚ_bio
 *
sbio
)

528 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

529 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

530 
shªnÚ_»que¡
 *
»q
, *
tmp
;

532 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

533 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

534 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

535 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

536 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

537 
	`ä“_»q
(
»q
);

539 
	`ä“_sbio
(
sbio
);

541 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

542 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

543 
	}
}

545 
	$__fl_®l_bÏnk_•og_·r™y_group
(
shªnÚ_sb
 *
sb
)

547 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

548 
shªnÚ_bio
 *
sbio
;

549 
shªnÚ_»que¡
 *
»q
;

550 
sub_group
 *
group
 = &
sb
->sub_group[
sdev
->
wr_group
[sb->
h—d_šdex
]];

551 
wr_off£t
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

552 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

553 
•og_¡¬t
 = 
sdev
->
logicbs_š_siblšg_eblock
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 - sb->
logicbs_š_•og
;

554 
shªnÚ_chunk_»q
 
»q_h—d
;

555 
i
, 
¶ªe
, 
fœ¡_pba
, 
lun_off£t
, 
lun_š_group
;

556 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

558 
	`shªnÚ_©omic_šc
(&
sdev
->
»cov”_dÚe
);

559 
»q_h—d
.
fœ¡
 = 
NULL
;

560 
»q_h—d
.
couÁ
 = 0;

562 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

563 
	`£t_sbio_debug_g
(
sbio
, 
FILL_BLANK_EPILOG_TAG
);

564 
sbio
->
ÿÎback
 = 
__fl_®l_bÏnk_•og_·r™y_group_ÿÎback
;

565 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

566 
sbio
->
d©a
 = 
sb
;

568 
fœ¡_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + sdev->
logicbs_š_·ge
 * sdev->
wr_chunk
[sb->
h—d_šdex
];

569 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

570 
lun_š_group
 = 0;

572 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

573 
	`is_bad_lun
(
sb
, 
group
->
¡¬t_lun
 + 
lun_off£t
))

574 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

576 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_chunk
, &
sbio
->
u£r_couÁ
);

577 
sbio
->
logicbs
 +ğ
sdev
->
logicbs_š_chunk
;

579 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

580 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

581 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

582 
	`£t_»q_debug_g
(
»q
, 
FILL_BLANK_EPILOG_TAG
, 
i
);

583 
»q
->
İcode
 = 
sh_cmd_wr™e
;

584 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

585 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

586 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

587 
»q
->
pba
.
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

588 
»q
->
pba
.
lun_pba
 = 
fœ¡_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
;

589 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

590 
»q
->
wr_off£t
 = wr_offset++;

591 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

592 ià(
»q
->
wr_off£t
 >ğ
•og_¡¬t
)

593 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, 
	`•og_g‘_addr
(
sb
->
•og
,„eq->
wr_off£t
 - 
•og_¡¬t
, 
sdev
), sdev->
logicb_size
);

594 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

595 
»q
->
sbio
 = sbio;

596 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

597 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

598 
	`g©h”_chunk_»q
(
sdev
, &
»q_h—d
, 
»q
);

601 
lun_š_group
++;

602 } 
lun_š_group
 !ğ
sb
->
mš_d©a_luns
);

603 
	`BUG_ON
(
»q_h—d
.
couÁ
 != 0);

604 ià(
sb
->
»cov”_¡©us
 & 
SKIP_PARITY
)

605 
	`£nd_dummy_·r™y_»q
(
sb
, 
	`g‘_·r™y_lun
(
group
), sb->
sb_šdex
 * 
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->
h—d_šdex
]);

607 
	`£nd_·r™y_»q
(
sb
, 
	`g‘_·r™y_lun
(
group
), sb->
sb_šdex
 * 
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->
h—d_šdex
]);

608 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

609 
	}
}

611 
šlše
 
	$£t_aùive_fœ¡_v®id_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

613 
sub_group
 *
group
;

615 
sdev
->
wr_lun_off£t
[
sb
->
h—d_šdex
] = sb->
sub_group
[sdev->
wr_group
[sb->h—d_šdex]].
fœ¡_lun_off£t
;

616 
sdev
->
wr_·ge
[
sb
->
h—d_šdex
] = sdev->
wr_chunk
[sb->head_index];

617 
sdev
->
wr_¶ªe
[
sb
->
h—d_šdex
] = 0;

618 
sdev
->
wr_logicb
[
sb
->
h—d_šdex
] = 0;

619 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

620 
sb
->
wr_off£t
 = 
sdev
->
logicbs_š_chunk
 * sb->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

621 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

622 
	}
}

624 
	$fl_h®f_bÏnk_aùive_·r™y_group_ÿÎback
(
shªnÚ_bio
 *
sbio
)

626 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

627 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

628 
shªnÚ_»que¡
 *
»q
, *
tmp
;

630 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

631 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

632 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

633 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

634 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

635 
	`ä“_»q
(
»q
);

637 
	`ä“_sbio
(
sbio
);

639 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

640 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

641 
	}
}

643 
	$fl_h®f_bÏnk_aùive_·r™y_group
(
shªnÚ_bio
 *
sbio
, 
š_•og
, 
fl_”r_·ge
)

645 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

646 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

647 
shªnÚ_»que¡
 *
»q
, *
tmp
;

648 
sub_group
 *
group
 = &
sb
->sub_group[
sdev
->
wr_group
[sb->
h—d_šdex
]];

649 
shªnÚ_chunk_»q
 
chunk
;

650 
•og_off£t
 = 
sb
->
mš_d©a_luns
 * 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_siblšg_eblock
 - sb->
logicbs_š_•og
;

652 
	`shªnÚ_©omic_šc
(&
sdev
->
»cov”_dÚe
);

653 
chunk
.
fœ¡
 = 
NULL
;

654 
chunk
.
couÁ
 = 0;

656 ià(
š_•og
) {

658 
shªnÚ_»que¡
 *
fœ¡_»q
 = 
NULL
;

659 
i
;

661 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
)

662 ià(
»q
->
pba
.
lun
 =ğ
	`fœ¡_lun
(
group
)) {

663 
fœ¡_»q
 = 
»q
;

666 
fœ¡_»q
->
wr_off£t
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

667 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

668 
i
 = 1;

669 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
fœ¡_»q
->
bio_li¡
, bio_list) {

670 ià(&
»q
->
bio_li¡
 =ğ&
sbio
->
»q_li¡
)

672 ià(
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
))

674 
»q
->
wr_off£t
 = 
fœ¡_»q
->wr_off£ˆ+ 
i
;

675 
i
++;

677 ià(
»q
->
wr_off£t
 =ğ
•og_off£t
) {

678 ià(
»q
->
_ecc
 < 
SH_FAKE_ERR
) {

679 
shªnÚ_•og_h—d
 *
•og_h—d
 = (shªnÚ_•og_h—d *)
»q
->
vœt_addr
;

680 ià((
	`shªnÚ_mem_»adq
(&
•og_h—d
->
•og_w©”m¬k
è!ğ
EPILOG_WATERMARK
) || \

681 (
	`shªnÚ_mem_»adw
(&
•og_h—d
->
h—d_šdex
è!ğ
sb
->head_index)) {

682 
	`shªnÚ_”r
("sb_index=%d, watermark=0x%lx, head_index=%d!\n",

683 
sb
->
sb_šdex
, ()
	`shªnÚ_mem_»adq
(&
•og_h—d
->
•og_w©”m¬k
),

684 
	`shªnÚ_mem_»adw
(&
•og_h—d
->
h—d_šdex
));

686 
sb
->
£q_num
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->seq_num);

687 
sb
->
”a£_couÁ”
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->erase_counter);

688 
sb
->
h—d_šdex
 = 
	`shªnÚ_mem_»adw
(&
•og_h—d
->head_index);

689 
sb
->
Ãxt_sb
 = 
	`shªnÚ_mem_»adw
(&
•og_h—d
->next_sb);

690 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
£qu’û_numb”_lock
);

691 ià(
	`shªnÚ_mem_»adq
(&
•og_h—d
->
£q_num
è>ğ
sdev
->
£qu’û_numb”
)

692 
sdev
->
£qu’û_numb”
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->
£q_num
) + 1;

693 
	`»Œ›ve_sm¬t_äom_•og_h—d
(
sdev
, 
•og_h—d
);

694 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
£qu’û_numb”_lock
);

695 
	`WARN_ON
(
sdev
->
sbs
[
sb
->
Ãxt_sb
].
¡©e
 !ğ
Ãxt_blk_¡©e
[sb->
h—d_šdex
]);

699 
Ãxt_sb
 = 
sb
->next_sb;

700 
	`BUG_ON
(
Ãxt_sb
 !ğ
INVALID_SB_INDEX
);

701 
Ãxt_sb
 = 
	`g‘_Ãxt_sb
(
sdev
, 
sb
->
h—d_šdex
);

702 
	`BUG_ON
(
Ãxt_sb
 =ğ
INVALID_SB_INDEX
);

703 
sb
->
Ãxt_sb
 =‚ext_sb;

704 
	`upd©e_•og_h—d
(
sdev
, 
sb
);

710 
sbio
->
¡©us
 = 0;

711 
sbio
->
logicbs
 = 
sb
->
mš_d©a_luns
 * 
sdev
->
logicbs_š_chunk
;

712 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

713 
sbio
->
ÿÎback
 = 
fl_h®f_bÏnk_aùive_·r™y_group_ÿÎback
;

714 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

716 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

717 ià(
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
)) {

718 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

719 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

720 
	`ä“_»q
(
»q
);

724 ià(
»q
->
_ecc
 < 
SH_FAKE_ERR
) {

725 
	`debugs3
("dummy wr™e:†un=%d,†un_pba=%d.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

727 
»q
->
İcode
 = 
sh_cmd_wr™e
;

728 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

730 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

731 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
] | (1 << 
DUMMY_WRITE_SHIFT
è| (1 << 
PHANTOM_WRITE_SHIFT
);

732 
	`g©h”_chunk_»q
(
sdev
, &
chunk
, 
»q
);

733 } ià((
»q
->
_ecc
 =ğ
SH_ECC_UNCORRECTABLE
è|| (»q->_ecø=ğ
SH_SOFT_ERR_2
)) {

734 
	`debugs3
("dummy wr™štØ”rÜ…age:†un=%d,†un_pba=%d.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

736 
»q
->
İcode
 = 
sh_cmd_wr™e
;

737 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

739 ià(
š_•og
 && (
»q
->
wr_off£t
 - 
•og_off£t
) == 0) {

740 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, 
	`•og_g‘_addr
(
sb
->
•og
, 0, 
sdev
), sdev->
logicb_size
);

741 
»q
->
İcode
 = 
sh_cmd_wr™e
;

742 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

743 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

744 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

745 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

746 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

748 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

749 ià(
fl_”r_·ge
) {

750 ià(
š_•og
)

751 
»q
->
d©©y³
 = 
NEED_RESCAN
;

753 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

754 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

755 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

757 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
] | (1 << 
DUMMY_WRITE_SHIFT
è| (1 << 
PHANTOM_WRITE_SHIFT
);

759 
	`g©h”_chunk_»q
(
sdev
, &
chunk
, 
»q
);

760 } ià(
š_•og
 && 
	`is_•og_pba
(
sb
, 
»q
->
wr_off£t
)) {

761 
off£t_š_•og
 = 
»q
->
wr_off£t
 - 
•og_off£t
;

763 
	`debugs1
("bÏnkƒpog…age:†un=%d,†un_pba=%d.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

764 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, 
	`•og_g‘_addr
(
sb
->
•og
, 
off£t_š_•og
, 
sdev
), sdev->
logicb_size
);

766 
»q
->
İcode
 = 
sh_cmd_wr™e
;

767 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

768 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

769 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

770 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

771 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

772 
	`g©h”_chunk_»q
(
sdev
, &
chunk
, 
»q
);

774 
	`debugs3
("bÏnk d©¨·ge:†un=%d,†un_pba=%d.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

776 
»q
->
İcode
 = 
sh_cmd_wr™e
;

777 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

778 ià(
š_•og
) {

779 ià(
sdev
->
lba_fÜm©
) {

780 
»q
->
d©©y³
 = 
NEED_RESCAN
;

781 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

783 
»q
->
d©©y³
 = 
SHORT_LBA
;

784 
»q
->
lba
 = 
INVALID_LBA2
;

787 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

788 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

790 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

791 
»q
->
h—d
 = 
wr™e_h—d
[
sb
->
h—d_šdex
];

792 
	`g©h”_chunk_»q
(
sdev
, &
chunk
, 
»q
);

795 
	`BUG_ON
(
chunk
.
couÁ
 != 0);

796 ià(
sb
->
»cov”_¡©us
 & 
SKIP_PARITY
)

797 
	`£nd_dummy_·r™y_»q
(
sb
, 
	`g‘_·r™y_lun
(
group
), sb->
sb_šdex
 * 
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->
h—d_šdex
]);

799 
	`£nd_·r™y_»q
(
sb
, 
	`g‘_·r™y_lun
(
group
), sb->
sb_šdex
 * 
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->
h—d_šdex
]);

800 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

802 ià(
š_•og
) {

804 ià(
	`add_wr_group_pošt
(
sdev
, 
sb
, sb->
h—d_šdex
) < 0)

806 
	`__fl_®l_bÏnk_•og_·r™y_group
(
sb
);

810 
	}
}

812 
£t_Ï¡_aùive_blk
(
shªnÚ_dev
 *
dev
, 
h—d_šdex
);

813 
	$aá”_fl_•og_of_aùive_block
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

815 
shªnÚ_sb
 *
aùive_sb
;

817 
	`sb_ä“_•og
(
sb
);

818 
	`£t_Ï¡_aùive_blk
(
sdev
, 
sb
->
h—d_šdex
);

819 
	`put_što_wa™_cİy_li¡
(
sb
);

820 ià(
sb
->
Ãxt_sb
 =ğ
INVALID_SB_INDEX
) {

821 
	`debugs0
("the†ast…age of‡ctive sb is‡llƒrror. cannot get‚ext_sb.\n");

822 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

826 
aùive_sb
 = &
sdev
->
sbs
[
sb
->
Ãxt_sb
];

828 ià(
aùive_sb
->
¡©e
 =ğ
FREE_BLOCK
) {

829 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

830 
	`shªnÚ_li¡_d–_š™
(&
aùive_sb
->
li¡
);

831 
sdev
->
ä“_blkút
--;

832 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
ä“_blocks_lock
);

833 
aùive_sb
->
h—d_šdex
 = 
sb
->head_index;

834 
aùive_sb
->
¡©e
 = 
aùive_blk_¡©e
[aùive_sb->
h—d_šdex
];

835 
aùive_sb
->
•og
 = 
	`•og_®loc
×ùive_sb->
•og_size
, 
sdev
);

836 ià(
aùive_sb
->
•og
 =ğ
NULL
)

837 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

839 
sdev
->
wr_sb
[
sb
->
h—d_šdex
] = sb->
Ãxt_sb
;

840 
sdev
->
aùive_blk
[
sb
->
h—d_šdex
] = &sdev->
sbs
[sb->
Ãxt_sb
];

841 
sdev
->
aùive_blk
[
sb
->
h—d_šdex
]->
¡©e
 = 
aùive_blk_¡©e
[sb->head_index];

842 
sdev
->
wr_group
[
sb
->
h—d_šdex
] = 0;

843 
sdev
->
lun_š_group
[
sb
->
h—d_šdex
] = 0;

844 
sdev
->
wr_lun_off£t
[
sb
->
h—d_šdex
] = sdev->
aùive_blk
[sb->h—d_šdex]->
sub_group
[0].
fœ¡_lun_off£t
;

845 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
] = 0;

846 
sdev
->
wr_¶ªe
[
sb
->
h—d_šdex
] = 0;

847 
sdev
->
wr_·ge
[
sb
->
h—d_šdex
] = 0;

848 
sdev
->
wr_logicb
[
sb
->
h—d_šdex
] = 0;

849 
aùive_sb
->
wr_off£t
 = 0;

851 ià(
	`uÆik–y
(
sdev
->
·r™y_š™_dÚe
[
sb
->
h—d_šdex
] == 0))

852 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
·r™y_š™_dÚe_ev’t
[
sb
->
h—d_šdex
], sdev->
·r™y_š™_dÚe
[sb->head_index] == 1);

854 ià(
sdev
->
¿id5_suµÜ‹d
 && (
aùive_sb
->
·r™y_š™_dÚe
 == 0)) {

855 
	`·r™y_š™
(
aùive_sb
, 
sdev
->
wr_group
[
sb
->
h—d_šdex
], sdev->
wr_sb
[sb->h—d_šdex] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->head_index],

856 
wr™e_h—d
[
sb
->
h—d_šdex
]);

857 
sb
->
·r™y_š™_dÚe
 = 1;

859 
	}
}

861 
	$check_d©a_»cov”ab™y
(
shªnÚ_bio
 *
sbio
)

863 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

864 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

865 
sub_group
 *
group
 = &
sb
->sub_group[
sdev
->
wr_group
[sb->
h—d_šdex
]];

866 
shªnÚ_»que¡
 *
»q
;

867 
»t
 = 0;

868 
lun
 = -1;

869 
ecc
 = 0, 
ecc2
;

871 ià(
shªnÚ_fÜû_»şaim_aùiveblock
)

872  
»t
;

873 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

874 ià((
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
)è&& (»q->
_ecc
 < 
SH_FAKE_ERR
)) {

875 
»t
 = -1;

876 
	`debugs0
("parity_lun=%d has data(ecc=0x%x) in‡ half blank group. sb=%d, chunk=%d, group=%d.\n",

877 
»q
->
pba
.
lun
,„eq->
_ecc
, 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], 
group
->
phy_šdex
);

878  
»t
;

880 ià(
»q
->
pba
.
lun
 !=†un) {

881 
lun
 = 
»q
->
pba
.lun;

882 
ecc
 = (
»q
->
_ecc
 == 0xFB)?0xFB:0;

884 
ecc2
 = (
»q
->
_ecc
 == 0xFB)?0xFB:0;

885 ià(
ecc2
 !ğ
ecc
) {

886 
»t
 = -2;

887 
	`debugs0
("blank…age‡nd data…age mixed in‡ chunk! sb=%d, chunk=%d,†un=%d.\n",

888 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], 
»q
->
pba
.
lun
);

889  
»t
;

893  
»t
;

895 
	}
}

896 
»cov”_aùive_blk
(
shªnÚ_dev
 *, 
shªnÚ_sb
 *);

898 
	$__check_aùive_Ãxt_·r™y_group_ÿÎback
(
shªnÚ_bio
 *
sbio
)

900 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

901 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

902 
shªnÚ_»que¡
 *
»q
, *
tmp
;

903 
sub_group
 *
group
;

904 
d©a_·ge
 = 0;

906 ià(
sbio
->
¡©us
)

907 
	`debugs3
("enter, sb_index=%d, chunk=%d, status=0x%x.\n",

908 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], 
sbio
->
¡©us
);

910 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

911 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

912 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

913 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

914 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

915 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

918 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

921 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
)))

924 ià(++
d©a_·ge
 && (
	`shªnÚ_©omic_»ad
(&
sdev
->
aùive_wa™_¡©us
è=ğ
WAIT_NEXT_GROUP_STATUS
))

925 
sb
->
»cov”_¡©us
 |ğ
NEXT_GROUP_HAS_DATA
;

929 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
aùive_wa™_¡©us
è=ğ
WAIT_NEXT_GROUP_STATUS
) {

930 
	`shªnÚ_©omic_£t
(&
sdev
->
aùive_wa™_¡©us
, 
GET_NEXT_GROUP_STATUS_FINISH
);

931 
	`shªnÚ_wake_up
(&
sdev
->
aùive_wa™_ev’t
);

934 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

935 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

936 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

937 
	`ä“_»q
(
»q
);

939 
	`ä“_sbio
(
sbio
);

940 
	}
}

942 
	$__check_aùive_Ãxt_·r™y_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

944 
shªnÚ_bio
 *
sbio
;

945 
shªnÚ_»que¡
 *
tmp
, *
»q
 = 
NULL
;

946 
sub_group
 *
group
;

947 
i
, 
chunk
, 
¶ªe
, 
fœ¡_pba
, 
lun_š_group
, 
lun_off£t
, 
lun
, 
group_šdex
;

948 
»t
 = 0;

949 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

950 
	`BUG_ON
((
	`shªnÚ_©omic_»ad
(&
sdev
->
aùive_wa™_¡©us
è!ğ
IDLE
è|| (
sb
->
»cov”_¡©us
 & 
NEXT_GROUP_HAS_DATA
));

951 
	`BUG_ON
((
sb
->
h—d_šdex
 !ğ
HOT_INDEX
è&& (sb->h—d_šdex !ğ
COLD_INDEX
));

952 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


953 
	`BUG_ON
((
sdev
->
u£_du®_h—d
 =ğ0è&& (
sb
->
h—d_šdex
 =ğ
COLD_INDEX
));

956 
chunk
 = 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
];

957 
group_šdex
 = 
sdev
->
wr_group
[
sb
->
h—d_šdex
];

959 
group_šdex
++;

960 ià(
group_šdex
 =ğ
sdev
->
·r™y_groups
) {

961 
group_šdex
 = 0;

962 
chunk
++;

963 ià(
chunk
 =ğ
sdev
->
·ges_š_eblock
) {

964 
»t
 = -1;

965 
out
;

968 
group
 = &
sb
->
sub_group
[
group_šdex
];

969 } 
group
->
phy_šdex
 < 0);

971 
sb
->
»cov”_¡©us
 &ğ~
NEXT_GROUP_HAS_DATA
;

972 
	`shªnÚ_©omic_£t
(&
sdev
->
aùive_wa™_¡©us
, 
WAIT_NEXT_GROUP_STATUS
);

974 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

975 
	`£t_sbio_debug_g
(
sbio
, 
CHECK_NEXT_GROUP_TAG
);

976 
sbio
->
ÿÎback
 = 
__check_aùive_Ãxt_·r™y_group_ÿÎback
;

977 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

978 
sbio
->
d©a
 = 
sb
;

980 
fœ¡_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + sdev->
logicbs_š_·ge
 * 
chunk
;

981 
lun_š_group
 = 0;

982 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;;

984 ià(
lun_š_group
 =ğ
sb
->
mš_d©a_luns
) {

985 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

986 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

989 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

990 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

991 } 
	`is_bad_lun
(
sb
, 
lun
));

994 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_chunk
, &
sbio
->
u£r_couÁ
);

995 
sbio
->
logicbs
 +ğ
sdev
->
logicbs_š_chunk
;

996 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

997 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

998 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

999 
	`£t_»q_debug_g
(
»q
, 
RECOVER_ACTIVE_BLK_TAG
, 
i
);

1000 
»q
->
İcode
 = 
sh_cmd_»ad
;

1001 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1002 
»q
->
lba
 = 
LONG_INVALID_LBA
;

1003 
»q
->
pba
.
lun
 =†un;

1004 
»q
->
pba
.
lun_pba
 = 
fœ¡_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
;

1006 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1007 ià(!
»q
->
vœt_addr
) {

1008 
	`shªnÚ_”r
("kmalloc failed.\n");

1009 
km®loc_ç
;

1011 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1012 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

1013 
	`shªnÚ_”r
("dma_map_single failed!.\n");

1014 
dma_ç
;

1016 
»q
->
sbio
 = sbio;

1017 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1018 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1019 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

1022 
lun_š_group
++;

1023 } 
lun_off£t
 !ğ
group
->
·r™y_lun_off£t
);

1026 ià(
sbio
->
logicbs
 != 0) {

1027 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

1028 
	`shªnÚ_wa™_ev’t
(
sdev
->
aùive_wa™_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
aùive_wa™_¡©us
è=ğ
GET_NEXT_GROUP_STATUS_FINISH
);

1029 
	`shªnÚ_©omic_£t
(&
sdev
->
aùive_wa™_¡©us
, 
IDLE
);

1030 
»t
 = 0;

1032 
»t
 = -1;

1033 
	`ä“_sbio
(
sbio
);

1035  
»t
;

1037 
dma_ç
:

1038 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1039 
km®loc_ç
:

1040 
	`ä“_»q
(
»q
);

1041 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1042 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1043 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1044 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1045 
	`ä“_»q
(
»q
);

1047 
	`ä“_sbio
(
sbio
);

1049 
»t
 = -
EIO
;

1050 
out
:

1051 
sb
->
»cov”_¡©us
 &ğ~
NEXT_GROUP_HAS_DATA
;

1052 
	`shªnÚ_©omic_£t
(&
sdev
->
aùive_wa™_¡©us
, 
IDLE
);

1053  
»t
;

1054 
	}
}

1056 
šlše
 
	$check_aùive_Ãxt_·r™y_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

1058 
»t
 = 0;

1060 
	`debugs1
("active %s sb(%d): start check‚ext…arity_group. wr_chunk=%d, wr_group=%d.\n", \

1061 (
sb
->
h—d_šdex
 =ğ
HOT_INDEX
è? "hÙ": "cŞd", sb->
sb_šdex
, 
sdev
->
wr_chunk
[sb->h—d_šdex], sdev->
wr_group
[sb->head_index]);

1062 
»t
 = 
	`__check_aùive_Ãxt_·r™y_group
(
sdev
, 
sb
);

1063 ià(
»t
 == -1) {

1064 
	`debugs1
("this ishe†ast group\n");

1066 } ià(
»t
 =ğ-
EIO
){

1067 
	`shªnÚ_”r
("check‡ctive block‚ext…arity group failed.\n");

1068 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1071 
	`debugs1
("check_aùive_Ãxt_·r™y_gÜu°i fšish.‚exˆgrou°%s.\n", (
sb
->
»cov”_¡©us
 & 
NEXT_GROUP_HAS_DATA
) ? "has data" : "isƒmpty");

1072 ià((
sb
->
»cov”_¡©us
 & 
NEXT_GROUP_HAS_DATA
)) {

1077 
	}
}

1079 
šlše
 
	$fl_®l_bÏnk_•og_·r™y_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

1081 
Ãxt_sb
;

1083 ià(
sdev
->
ä“_blkút
 == 0) {

1084 
	`shªnÚ_”r
("No free blocks!\n");

1085 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1086 } ià(
sdev
->
»adÚly_»asÚ
) {

1089 ià(
sb
->
Ãxt_sb
 =ğ
INVALID_SB_INDEX
) {

1091 
Ãxt_sb
 = 
	`g‘_Ãxt_sb
(
sdev
, 
sb
->
h—d_šdex
);

1092 
	`BUG_ON
(
Ãxt_sb
 =ğ
INVALID_SB_INDEX
);

1093 
sb
->
Ãxt_sb
 =‚ext_sb;

1094 
	`upd©e_•og_h—d
(
sdev
, 
sb
);

1098 
	`__fl_®l_bÏnk_•og_·r™y_group
(
sb
);

1099 } 
	`add_wr_group_pošt
(
sdev
, 
sb
, sb->
h—d_šdex
) >= 0);

1100 
	`aá”_fl_•og_of_aùive_block
(
sdev
, 
sb
);

1102 
	}
}

1104 
fl_aùive_blk
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
¡¬t
);

1105 
	$fl_aùive_blk_ÿÎback
(
shªnÚ_bio
 *
sbio
)

1107 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

1108 
h—d_šdex
 = ()
sbio
->
d©a2
;

1109 
shªnÚ_»que¡
 *
»q
, *
tmp
;

1110 
shªnÚ_sb
 *
sb
;

1111 
»t
 = 0;

1113 ià(
h—d_šdex
 >= 2) {

1114 
	`debugs0
("h—d_šdex=%d.\n", 
h—d_šdex
);

1115 
	`BUG
();

1118 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1119 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1120 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1121 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

1122 
	`ä“_»q
(
»q
);

1124 
	`ä“_sbio
(
sbio
);

1126 
sb
 = 
sdev
->
aùive_blk
[
h—d_šdex
];

1128 ià((
	`shªnÚ_©omic_»ad
(&
sdev
->
wa™_blk
è=ğ
sb
->
sb_šdex
è&& (sb->
wr_off£t
 < 
	`fœ¡_•og_pba
(sdev, sb))) {

1129 
»t
 = 
	`fl_aùive_blk
(
sdev
, 
h—d_šdex
, 0);

1130 ià(
»t
) {

1131 
	`shªnÚ_”r
("fill‡ctive blk failed.\n");

1132 
	`shªnÚ_©omic_£t
(&
sdev
->
wa™_blk
, -1);

1133 
	`shªnÚ_wake_up
(&
sdev
->
wa™_blk_dÚe_ev’t
);

1136 
	}
}

1144 
	$fl_aùive_blk
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
¡¬t
)

1146 
shªnÚ_»que¡
 *
»q
;

1147 
shªnÚ_bio
 *
sbio
;

1148 
d–
;

1150 
d–
 = (
sdev
->
¶ªes
 - sdev->
wr_¶ªe
[
h—d_šdex
]è* sdev->
logicbs_š_·ge
 - sdev->
wr_logicb
[head_index];

1151 ià(
d–
 == 0)

1152 
d–
 = 
sdev
->
logicbs_š_chunk
;

1153 ià((
d–
 <ğ0è|| (d– > 
sdev
->
logicbs_š_chunk
))

1156 ià(
¡¬t
) {

1157 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
sdev
->
wa™_blk
) != -1);

1158 
	`shªnÚ_©omic_£t
(&
sdev
->
wa™_blk
, sdev->
aùive_blk
[
h—d_šdex
]->
sb_šdex
);

1160 
sbio
 = 
	`®loc_sbio
(
GFP_NOWAIT
);

1161 
	`£t_sbio_debug_g
(
sbio
, 
FILL_ACTIVE_BLK_TAG
);

1162 
sbio
->
ÿÎback
 = 
fl_aùive_blk_ÿÎback
;

1163 
sbio
->
d©a
 = 
sdev
;

1164 
sbio
->
d©a2
 = (*)()
h—d_šdex
;

1165 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

1166 
sbio
->
logicbs
 = 
d–
;

1167 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

1168 
	`debugs1
("h—d_šdex=%d, d–=%d.\n", 
h—d_šdex
, 
d–
);

1169 
	`upd©e_d©a_š_dummy_·ge
(
sdev
);

1170 
d–
) {

1171 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

1172 
	`£t_»q_debug_g
(
»q
, 
FILL_BUFFER_WRITE_CHUNK_TAG
, 
d–
);

1173 
»q
->
İcode
 = 
sh_cmd_wr™e
;

1174 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

1175 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

1176 
»q
->
h—d
 = 
wr™e_h—d
[
h—d_šdex
];

1177 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

1178 
»q
->
dma_add»ss
 = 
sdev
->
dummy_dma_·ge
;

1179 
»q
->
vœt_addr
 = 
sdev
->
dummy_·ge
;

1180 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1181 
»q
->
sbio
 = sbio;

1182 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1183 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 1);

1184 
d–
--;

1185 
sdev
->
fl_İ’_chunk_logicbs
++;

1187 
	`debugs1
("exit: head_index=%d, wr_plane=%d, wr_logicb=%d.\n",

1188 
h—d_šdex
, 
sdev
->
wr_¶ªe
[h—d_šdex], sdev->
wr_logicb
[head_index]);

1189 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

1190 ià(
¡¬t
)

1191 
	`shªnÚ_wa™_ev’t
(
sdev
->
wa™_blk_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
wa™_blk
) == -1);

1194 
	}
}

1196 
	$»cov”_Ãxt_·r™y_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

1198 
sub_group
 *
group
 = 
NULL
;

1200 ià(
	`add_wr_group_pošt
(
sdev
, 
sb
, sb->
h—d_šdex
) == 0) {

1201 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

1202 
sb
->
wr_off£t
 = 
sdev
->
logicbs_š_chunk
 * sb->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

1203 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

1204 
	`»cov”_aùive_blk
(
sdev
, 
sb
);

1207 
	`aá”_fl_•og_of_aùive_block
(
sdev
, 
sb
);

1210 
	}
}

1218 
	$check_ªd_fl_h®f_bÏnk_·r™y_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
,

1219 
shªnÚ_bio
 *
sbio
, 
fl_”r_·ge
)

1221 
»t
 = 0;

1222 
shªnÚ_»que¡
 *
»q
, *
tmp
;

1224 ià((!
fl_”r_·ge
è&& (
	`check_d©a_»cov”ab™y
(
sbio
) < 0)) {

1226 
	`shªnÚ_”r
("Data in‡ctive…age_stripe is‚ot„ecoverable.\n");

1227 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1228 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1229 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1230 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1231 
	`ä“_»q
(
»q
);

1233 
	`ä“_sbio
(
sbio
);

1234 
»t
 = -1;

1236 ià(
sdev
->
»adÚly_»asÚ
) {

1237 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1238 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1239 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

1240 
	`shªnÚ_”r
("lun=%d,†un_pba=%d,ƒcc=0x%x.\n", \

1241 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
);

1242 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1243 
	`ä“_»q
(
»q
);

1245 
	`ä“_sbio
(
sbio
);

1246 
»t
 = -1;

1248 ià(
	`is_•og_·ge_¡re
(
sb
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], sdev->
wr_group
[sb->head_index])) {

1249 ià(
sdev
->
ä“_blkút
 == 0) {

1250 
	`shªnÚ_”r
("No free blocks!\n");

1251 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1252 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1253 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1254 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1255 
	`ä“_»q
(
»q
);

1257 
	`ä“_sbio
(
sbio
);

1258 
»t
 = -1;

1260 
	`fl_h®f_bÏnk_aùive_·r™y_group
(
sbio
, 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
], 
fl_”r_·ge
);

1261 
	`aá”_fl_•og_of_aùive_block
(
sdev
, 
sb
);

1262 
»t
 = 1;

1265 
	`fl_h®f_bÏnk_aùive_·r™y_group
(
sbio
, 0, 
fl_”r_·ge
);

1266 
»t
 = 
	`»cov”_Ãxt_·r™y_group
(
sdev
, 
sb
);

1271  
»t
;

1272 
	}
}

1279 
	$hªdË_aùive_blk_bÏnk_group
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
shªnÚ_bio
 *
sbio
)

1281 
»t
 = 1;

1282 
shªnÚ_»que¡
 *
»q
, *
tmp
;

1283 
sub_group
 *
group
 = &
sb
->sub_group[
sdev
->
wr_group
[sb->
h—d_šdex
]];

1284 
fœ¡_off£t
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

1285 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

1286 
•og_off£t
 = 
sb
->
mš_d©a_luns
 * 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_siblšg_eblock
 - sb->
logicbs_š_•og
;

1289 ià(
sdev
->
¿id5_suµÜ‹d
 && (
sb
->
·r™y_š™_dÚe
 == 0)) {

1290 
	`·r™y_š™
(
sb
, 
sdev
->
wr_group
[sb->
h—d_šdex
],

1291 
sdev
->
wr_sb
[
sb
->
h—d_šdex
] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->h—d_šdex], 
wr™e_h—d
[sb->head_index]);

1292 
sb
->
·r™y_š™_dÚe
 = 1;

1296 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1297 ià((
»q
->
_ecc
 >ğ
SH_FAKE_ERR
è&& (»q->_ecø!ğ
SH_FRESH_ERASED
)) {

1298 
	`shªnÚ_log
("aùive_blk %d ha bad†uÀ%d iÀem±y group.\n", 
sb
->
sb_šdex
, 
»q
->
pba
.
lun
);

1299 
	`£t_»ad_”rÜ_block
(
sdev
, 
»q
);

1303 ià(
fœ¡_off£t
 >ğ
•og_off£t
) {

1304 
	`fl_®l_bÏnk_•og_·r™y_group
(
sdev
, 
sb
);

1305 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1306 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1307 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1308 
	`ä“_»q
(
»q
);

1310 
	`ä“_sbio
(
sbio
);

1311 
»t
 = 1;

1312 } ià(
	`is_•og_·ge_¡re
(
sb
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], sdev->
wr_group
[sb->h—d_šdex]è|| (sb->
»cov”_¡©us
 & 
NEED_FILL
)) {

1313 
»t
 = 
	`check_ªd_fl_h®f_bÏnk_·r™y_group
(
sdev
, 
sb
, 
sbio
, 1);

1314 
»t
 = !!ret;

1317 
	`£t_aùive_fœ¡_v®id_group
(
sdev
, 
sb
);

1318 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1319 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1320 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1321 
	`ä“_»q
(
»q
);

1323 
	`ä“_sbio
(
sbio
);

1324 
»t
 = 1;

1327  
»t
;

1328 
	}
}

1330 
	$»cov”_aùive_blk_ÿÎback
(
shªnÚ_bio
 *
sbio
)

1332 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

1333 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

1334 
shªnÚ_poŞ
 *
¥oŞ
 = 
sdev
->spool;

1335 
shªnÚ_Çme¥aû
 *
ns
;

1336 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

1337 
sub_group
 *
group
;

1338 
shªnÚ_»que¡
 *
»q
, *
tmp
;

1339 
‹mp
;

1340 
lun_pba
 
Şd_pba
;

1341 
·r™y_is_em±y
 = 0;

1342 
»t
, 
eblk_pba
, 
sb_pba
, 
bÏnk_logicbs
 = 0;

1343 
Ãxt_group_has_d©a
 = 0;

1344 
fœ¡_off£t
 = 0;

1345 
i
 = 0, 
lun_š_group
;

1346 
fl
 = 0;

1347 
•og_off£t
 = 
sb
->
mš_d©a_luns
 * 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_siblšg_eblock
 - sb->
logicbs_š_•og
;

1349 ià(
sbio
->
¡©us
)

1350 
	`debugs3
("enter, sb_index=%d, chunk=%d, status=0x%x.\n",

1351 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], 
sbio
->
¡©us
);

1353 ià(
sb
->
h—d_šdex
 =ğ
HOT_INDEX
)

1354 
‹mp
 = 
INIT_HOT_STATE
;

1356 
‹mp
 = 
COLD_STATE
;

1358 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

1359 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1360 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1361 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

1362 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

1363 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

1364 ià(!
sdev
->
lun
[
»q
->
pba
.lun]->
bad
) {

1365 
fl
 = 1;

1366 
sb
->
»cov”_¡©us
 |ğ
NEED_FILL
;

1370 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
) {

1371 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
) {

1372 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
))) {

1373 
·r™y_is_em±y
 = 1;

1375 
bÏnk_logicbs
++;

1377 ià(!
sdev
->
lun
[
»q
->
pba
.lun]->
bad
)

1378 
fl
 = 1;

1383 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(
group
)))

1386 
	`debugs1
("datatype=0x%lx,‚s_id=0x%x,‚s_seq_num=0x%x,†ba=0x%lx.\n",

1387 
»q
->
d©©y³
,„eq->
ns_id
,„eq->
ns_£q_num
,„eq->
lba
);

1388 
lun_š_group
 = 
	`g‘_»q_šdex
(
»q
è/ 
sdev
->
logicbs_š_chunk
;

1389 
eblk_pba
 = 
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_siblšg_eblock
;

1390 ià(
sdev
->
com·ù_•og
)

1391 
sb_pba
 = 
group
->
phy_šdex
 * 
sb
->
mš_d©a_luns
 * 
sdev
->
logicbs_š_siblšg_eblock
 + \

1392 
lun_š_group
 * 
sdev
->
logicbs_š_siblšg_eblock
 + 
eblk_pba
;

1394 
sb_pba
 = 
group
->
phy_šdex
 * 
sdev
->
max_luns_š_group
 * sdev->
logicbs_š_siblšg_eblock
 + \

1395 ((
»q
->
pba
.
lun
 + 
sdev
->
max_luns_š_group
 - 
group
->
¡¬t_lun
è% sdev->max_luns_š_groupè* sdev->
logicbs_š_siblšg_eblock
 + \

1396 
eblk_pba
;

1397 ià(!
	`»q_has_šv®id_lba
(
»q
)) {

1398 ià(
¥oŞ
) {

1399 
ns
 = 
¥oŞ
->ns[
»q
->
ns_id
];

1400 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

1401 
	`debugs1
("Wrong‚s_id=%d, metadata=0x%lx, datatype=0x%x,†ba=0x%lx,†un=%d,†un_pba=%lu, chunk=%d.\n",

1402 
»q
->
ns_id
,„eq->
_m‘ad©a
,„eq->
d©©y³
,„eq->
lba
,

1403 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
, 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
]);

1406 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

1407 
	`debugs1
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

1408 
sb
->
sb_šdex
, 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

1411 
sdisk
 = &
ns
->sdisk;

1414 ià(
»q
->
ns_id
 ||„eq->
ns_£q_num
) {

1415 
	`shªnÚ_”r
("%s: Wrong data,‚s_id=%d,‚s_seq_num=%d, metadata=0x%lx,†un=%d,†un_pba=%d.\n",

1416 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
ns_id
,„eq->
ns_£q_num
,„eq->
_m‘ad©a
,

1417 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

1421 ià(
»q
->
lba
 > 
sdisk
->
tÙ®_m­_bË_size
 / (
u32
)) {

1422 
	`shªnÚ_”r
("Wrong data:†un=%d,†un_pba=%d,ƒcc=%d, datatype=0x%x,†ba=0x%lx.\n",

1423 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
d©©y³
,„eq->
lba
);

1428 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

1429 ià(
»t
 == 0)

1430 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

1432 ià(
sdev
->
¥oŞ
)

1433 
	`shªnÚ_©omic64_šc
(&
sdev
->
¥oŞ
->
u£d_logicbs
);

1434 ià(
	`check_ªd_®loc_m­bË
(
sdisk
, 
»q
->
lba
)) {

1435 ià(
sdev
->
»cov”_¡©e
 > 
RECOVER_ERROR
)

1436 
sdev
->
»cov”_¡©e
 = 
RECOVER_ERROR
;

1437 
	`shªnÚ_£t_b™
(
SHN_REASON_EPILOG_FAILURE
, &
sdev
->
»adÚly_»asÚ
);

1438 
	`shªnÚ_”r
("mapableƒrror.\n");

1439 
»Ëa£_»qs
;

1443 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

1444 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

1445 
	`•og_£t_m‘ad©a
(
sdev
, 
sb
->
•og
, 
sb_pba
, 
»q
->
_m‘ad©a
);

1446 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

1448 ià(!
¥oŞ
 || 
»q
->
lba
 !ğ
šv®id_lba
[
sdev
->
lba_fÜm©
]

1449 || 
»q
->
ns_£q_num
 =ğ0 || 
sdev
->
mbr
.
sdev_id
 != 0) {

1450 
	`»cov”_d©a_äom_dummy_·ge
(
sdev
, 
»q
->
vœt_addr
);

1453 
ns
 = 
¥oŞ
->ns[
»q
->
ns_id
];

1454 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

1455 
	`debugs1
("Wrong‚s_id=%d, metadata=0x%lx, datatype=0x%x,†ba=0x%lx,†un=%d,†un_pba=%lu, chunk=%d.\n",

1456 
»q
->
ns_id
,„eq->
_m‘ad©a
,„eq->
d©©y³
,„eq->
lba
,

1457 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
, 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
]);

1460 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

1461 
	`debugs1
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

1462 
sb
->
sb_šdex
, 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

1465 
	`»cov”_ns_d©a_äom_»q
(
ns
, 
»q
, 
sdev
);

1466 
	`•og_£t_m‘ad©a
(
sdev
, 
sb
->
•og
, 
sb_pba
, 
»q
->
_m‘ad©a
);

1470 ià(
sbio
->
¡©us
 & 
HAVE_ERROR_SECTOR
) {

1471 ià(
bÏnk_logicbs
 >ğ(
sbio
->
logicbs
 - 
sdev
->
logicbs_š_chunk
)) {

1472 ià(
	`hªdË_aùive_blk_bÏnk_group
(
sdev
, 
sb
, 
sbio
))

1473 
fšish
;

1475 
out
;

1480 ià(
fl
) {

1481 
sb
->
»cov”_¡©us
 |ğ
NEED_FILL
;

1482 ià(
·r™y_is_em±y
) {

1483 ià(!(
sb
->
»cov”_¡©us
 & 
SKIP_PARITY
))

1484 
	`shªnÚ_šfo
("%s:he chunk %d of sb_index %d is‚ot filled up,‡nd it hasƒrror†ogicb.!\n", \

1485 
__func__
, 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
], sb->
sb_šdex
);

1486 
sb
->
»cov”_¡©us
 |ğ
SKIP_PARITY
;

1487 
sb
->
»cov”_¡©us
 |ğ
NEED_RECLAIM
;

1490 ià(
bÏnk_logicbs
 == 0) {

1492 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1493 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1494 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1495 
	`ä“_»q
(
»q
);

1497 
	`ä“_sbio
(
sbio
);

1498 ià(
	`»cov”_Ãxt_·r™y_group
(
sdev
, 
sb
))

1499 
fšish
;

1501 
out
;

1503 
	`debugs1
("active %s sb(%d):his group has data‡ndƒrror…age,‚ow fill it uphis super block.\n", \

1504 (
sb
->
h—d_šdex
 =ğ
HOT_INDEX
è? "hÙ" : "cŞd", sb->
sb_šdex
);

1506 ià(
sdev
->
¿id5_suµÜ‹d
 && (
sb
->
·r™y_š™_dÚe
 == 0)) {

1507 
	`·r™y_š™
(
sb
, 
sdev
->
wr_group
[sb->
h—d_šdex
],

1508 
sdev
->
wr_sb
[
sb
->
h—d_šdex
] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->h—d_šdex], 
wr™e_h—d
[sb->head_index]);

1509 
sb
->
·r™y_š™_dÚe
 = 1;

1511 
»t
 = 
	`check_ªd_fl_h®f_bÏnk_·r™y_group
(
sdev
, 
sb
, 
sbio
, 0);

1512 ià(
»t
 == 0)

1513 
out
;

1515 
fšish
;

1518 } ià(
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
) {

1519 ià(
sdev
->
¿id5_suµÜ‹d
 && (
sb
->
·r™y_š™_dÚe
 == 0)) {

1520 
	`·r™y_š™
(
sb
, 
sdev
->
wr_group
[sb->
h—d_šdex
],

1521 
sdev
->
wr_sb
[
sb
->
h—d_šdex
] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[sb->h—d_šdex], 
wr™e_h—d
[sb->head_index]);

1522 
sb
->
·r™y_š™_dÚe
 = 1;

1525 ià(
bÏnk_logicbs
 =ğ
sbio
->
logicbs
) {

1526 ià(
	`hªdË_aùive_blk_bÏnk_group
(
sdev
, 
sb
, 
sbio
))

1527 
fšish
;

1529 
out
;

1532 
	`debugs1
("active %s sb(%d):his group has data but‚ot full,‚eed fill=%d. wr_chunk=%d, wr_group=%d.\n", \

1533 (
sb
->
h—d_šdex
 =ğ
HOT_INDEX
è? "hÙ": "cŞd", sb->
sb_šdex
, sb->
»cov”_¡©us
 & 
NEED_FILL
, \

1534 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
], sdev->
wr_group
[sb->head_index]);

1535 ià(
·r™y_is_em±y
 && !(
sb
->
»cov”_¡©us
 & 
SKIP_PARITY
)) {

1536 
Ãxt_group_has_d©a
 = 
	`check_aùive_Ãxt_·r™y_group
(
sdev
, 
sb
);

1538 ià(
Ãxt_group_has_d©a
) {

1539 
sb
->
»cov”_¡©us
 &ğ~
NEXT_GROUP_HAS_DATA
;

1540 ià(!(
sb
->
»cov”_¡©us
 & 
SKIP_PARITY
))

1541 
	`shªnÚ_šfo
("%s: sb_index %d start hasƒmpty…arity in chunk %d.\n", \

1542 
__func__
, 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
]);

1543 
sb
->
»cov”_¡©us
 |ğ
SKIP_PARITY
;

1544 
sb
->
»cov”_¡©us
 |ğ
NEED_FILL
;

1545 
sb
->
»cov”_¡©us
 |ğ
NEED_RECLAIM
;

1549 ià((
bÏnk_logicbs
 > 
sdev
->
logicbs_š_chunk
è|| !(
sb
->
»cov”_¡©us
 & 
SKIP_PARITY
))

1550 
	`shªnÚ_šfo
("%s:hchunk %d oàsb_šdex %d i nÙ fËd up!\n", 
__func__
, 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
], sb->
sb_šdex
);

1551 ià((
bÏnk_logicbs
 <ğ(
sdev
->
logicbs_š_chunk
)è&& 
·r™y_is_em±y
) {

1552 
»t
 = 
	`check_ªd_fl_h®f_bÏnk_·r™y_group
(
sdev
, 
sb
, 
sbio
, 0);

1553 ià(
»t
)

1554 
fšish
;

1556 
out
;

1558 ià(
Ãxt_group_has_d©a
) {

1559 
	`shªnÚ_”r
("active %s sb(%d) group(wr_chunk=%d, wr_group=%d) is‚ot full,‡nd‚ext group has data.\n", \

1560 (
sb
->
h—d_šdex
 =ğ
HOT_INDEX
è? "hÙ" : "cŞd", sb->
sb_šdex
, \

1561 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
], sdev->
wr_group
[sb->head_index]);

1562 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1563 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1564 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1565 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1566 
	`ä“_»q
(
»q
);

1568 
	`ä“_sbio
(
sbio
);

1569 
fšish
;

1571 
	`debugs1
("active %s sb(%d):his group is‚ot filled up‡nd‚ext group isƒmpty.‚ow fillhis group up. wr_chunk=%d, wr_group=%d\n", \

1572 (
sb
->
h—d_šdex
 =ğ
HOT_INDEX
è? "hÙ" : "cŞd", sb->
sb_šdex
, \

1573 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
], sdev->
wr_group
[sb->head_index]);

1574 
»t
 = 
	`check_ªd_fl_h®f_bÏnk_·r™y_group
(
sdev
, 
sb
, 
sbio
, 0);

1575 ià(
»t
)

1576 
fšish
;

1578 
out
;

1584 
fœ¡_off£t
 = 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

1585 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

1587 ià(
sb
->
·r™y_š™_dÚe
) {

1588 
	`shªnÚ_”r
("sb=%d is…arity_init_done! chunk=%d, group=%d.\n",

1589 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
], sdev->
wr_group
[sb->head_index]);

1590 
	`£t_»cov”_¡©e_´obËm©ic
(
sdev
);

1592 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1593 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1594 
»q
->
wr_off£t
 = 
fœ¡_off£t
 + 
i
++;

1595 ià(
»q
->
wr_off£t
 =ğ
•og_off£t
) {

1596 
shªnÚ_•og_h—d
 *
•og_h—d
 = (shªnÚ_•og_h—d *)
»q
->
vœt_addr
;

1597 ià((
	`shªnÚ_mem_»adq
(&
•og_h—d
->
•og_w©”m¬k
è!ğ
EPILOG_WATERMARK
) || \

1598 (
	`shªnÚ_mem_»adw
(&
•og_h—d
->
h—d_šdex
è!ğ
sb
->head_index)) {

1599 
	`shªnÚ_”r
("sb_index=%d, watermark=0x%lx,emp=%d, metadata=0x%llx!\n",

1600 
sb
->
sb_šdex
, ()
	`shªnÚ_mem_»adq
(&
•og_h—d
->
•og_w©”m¬k
),

1601 
	`shªnÚ_mem_»adw
(&
•og_h—d
->
h—d_šdex
), 
»q
->
_m‘ad©a
);

1603 
sb
->
£q_num
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->seq_num);

1604 
sb
->
”a£_couÁ”
 = 
	`shªnÚ_mem_»adl
(&
•og_h—d
->erase_counter);

1605 
sb
->
h—d_šdex
 = 
	`shªnÚ_mem_»adw
(&
•og_h—d
->head_index);

1606 
sb
->
Ãxt_sb
 = 
	`shªnÚ_mem_»adw
(&
•og_h—d
->next_sb);

1607 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
£qu’û_numb”_lock
);

1608 ià(
	`shªnÚ_mem_»adq
(&
•og_h—d
->
£q_num
è>ğ
sdev
->
£qu’û_numb”
)

1609 
sdev
->
£qu’û_numb”
 = 
	`shªnÚ_mem_»adq
(&
•og_h—d
->
£q_num
) + 1;

1610 
	`»Œ›ve_sm¬t_äom_•og_h—d
(
sdev
, 
•og_h—d
);

1611 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
£qu’û_numb”_lock
);

1612 
	`WARN_ON
(
sdev
->
sbs
[
sb
->
Ãxt_sb
].
¡©e
 !ğ
Ãxt_blk_¡©e
[sb->
h—d_šdex
]);

1615 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1616 
	`ä“_»q
(
»q
);

1618 
	`add_wr_group_pošt
(
sdev
, 
sb
, sb->
h—d_šdex
);

1619 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

1620 
sb
->
wr_off£t
 = 
sdev
->
logicbs_š_chunk
 * sb->
mš_d©a_luns
 * sdev->
max_avaabË_groups
 * sdev->
wr_chunk
[sb->
h—d_šdex
] + \

1621 
sdev
->
logicbs_š_chunk
 * 
sb
->
mš_d©a_luns
 * 
group
->
phy_šdex
;

1622 ià(
sdev
->
wr_chunk
[
sb
->
h—d_šdex
] >ğsdev->
·ges_š_eblock
) {

1624 
	`£t_»cov”_¡©e_d—d
(
sdev
);

1625 
	`shªnÚ_”r
("aùivblock i fËd up!!! sb_šdex=%d, chunk=%d.\n", 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
]);

1626 
	`ä“_sbio
(
sbio
);

1627 
fšish
;

1629 
	`»cov”_aùive_blk
(
sdev
, 
sb
);

1630 
	`ä“_sbio
(
sbio
);

1635 
fšish
:

1636 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

1637 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

1638 
out
:

1639 
__echo_out
;

1642 
»Ëa£_»qs
:

1643 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1644 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1645 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1646 
	`ä“_»q
(
»q
);

1648 
	`ä“_sbio
(
sbio
);

1649 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

1650 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

1652 
	}
}

1654 
	$»cov”_aùive_blk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

1656 
shªnÚ_bio
 *
sbio
;

1657 
shªnÚ_»que¡
 *
tmp
, *
»q
 = 
NULL
;

1658 
sub_group
 *
group
;

1659 
i
, 
chunk
, 
¶ªe
, 
fœ¡_pba
, 
lun_š_group
, 
lun_off£t
, 
lun
;

1660 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

1662 
chunk
 = 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
];

1663 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

1664 
group
->
phy_šdex
 < 0) {

1665 ià(
	`add_wr_group_pošt
(
sdev
, 
sb
, sb->
h—d_šdex
) < 0) {

1667 
	`£t_»cov”_¡©e_d—d
(
sdev
);

1668 
	`shªnÚ_”r
("active block is filled up!!! sb_index=%d, chunk=%d.\n",

1669 
sb
->
sb_šdex
, 
sdev
->
wr_chunk
[sb->
h—d_šdex
]);

1670 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

1671 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

1673 
chunk
 = 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
];

1674 
group
 = &
sb
->
sub_group
[
sdev
->
wr_group
[sb->
h—d_šdex
]];

1677 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

1678 
	`£t_sbio_debug_g
(
sbio
, 
RECOVER_ACTIVE_BLK_TAG
);

1679 
sbio
->
ÿÎback
 = 
»cov”_aùive_blk_ÿÎback
;

1680 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

1681 
sbio
->
d©a
 = 
sb
;

1683 
fœ¡_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + sdev->
logicbs_š_·ge
 * 
chunk
;

1684 
lun_š_group
 = 0;

1685 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

1687 ià(
lun_š_group
 =ğ
sb
->
mš_d©a_luns
) {

1688 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

1689 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1692 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

1693 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1694 } 
	`is_bad_lun
(
sb
, 
lun
));

1697 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_chunk
, &
sbio
->
u£r_couÁ
);

1698 
sbio
->
logicbs
 +ğ
sdev
->
logicbs_š_chunk
;

1699 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

1700 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

1701 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

1702 
	`£t_»q_debug_g
(
»q
, 
RECOVER_ACTIVE_BLK_TAG
, 
i
);

1703 
	`£t_»q_šdex
(
»q
, 
lun_š_group
 * 
sdev
->
logicbs_š_chunk
 + 
¶ªe
 * sdev->
logicbs_š_·ge
 + 
i
);

1704 
»q
->
İcode
 = 
sh_cmd_»ad
;

1705 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1706 
»q
->
lba
 = 
LONG_INVALID_LBA
;

1707 
»q
->
pba
.
lun
 =†un;

1708 
»q
->
pba
.
lun_pba
 = 
fœ¡_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
;

1710 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1711 ià(!
»q
->
vœt_addr
) {

1712 
	`shªnÚ_”r
("kmalloc failed.\n");

1713 
km®loc_ç
;

1715 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1716 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

1717 
	`shªnÚ_”r
("dma_map_single failed!.\n");

1718 
dma_ç
;

1720 
»q
->
sbio
 = sbio;

1721 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1722 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1723 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

1726 
lun_š_group
++;

1727 } 
lun_off£t
 !ğ
group
->
·r™y_lun_off£t
);

1729 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

1733 
dma_ç
:

1734 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1735 
km®loc_ç
:

1736 
	`ä“_»q
(
»q
);

1737 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1738 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1739 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1740 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1741 
	`ä“_»q
(
»q
);

1743 
	`ä“_sbio
(
sbio
);

1745 
	`£t_»cov”_¡©e_d—d
(
sdev
);

1746 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

1747 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

1749  -
EIO
;

1750 
	}
}

1752 
sÿn_su³r_block
(
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
group_šdex
);

1753 
	$sÿn_su³r_block_ÿÎback
(
shªnÚ_bio
 *
sbio
)

1755 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

1756 
group_šdex
 = ()
sbio
->
d©a2
;

1757 
sub_group
 *
group
 = &
sb
->sub_group[
group_šdex
];

1758 
·ge_¡re
 = -1;

1759 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

1760 
shªnÚ_poŞ
 *
¥oŞ
 = 
sdev
->spool;

1761 
shªnÚ_Çme¥aû
 *
ns
;

1762 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

1763 
shªnÚ_»que¡
 *
»q
, *
tmp
;

1764 
lun_pba
 
Şd_pba
;

1765 
»t
;

1766 
·r™y_is_em±y
 = 0;

1767 
d©a_is_”rÜ
 = 0;

1769 
	`BUG_ON
(
group
->
phy_šdex
 == -1);

1770 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

1771 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1772 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

1773 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

1774 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

1775 
»q
->
»cov”_buf
 = 
NULL
;

1777 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

1779 ià(
·ge_¡re
 == -1) {

1780 
·ge_¡re
 = (
»q
->
pba
.
lun_pba
 - 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
è/ sdev->
logicbs_š_·ge
;

1781 
	`debugs1
("%s:…ag¡re=%d, group=%d.\n", 
__func__
, 
·ge_¡re
, 
group_šdex
);

1784 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
) {

1785 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(&
sb
->
sub_group
[»q->pba.lun/sdev->
max_luns_š_group
]))) {

1786 ià(!(
sb
->
»cov”_¡©us
 & 
NEED_RECLAIM
))

1787 
	`shªnÚ_šfo
("%s:…arity†un isƒmpty, sb_index=%d, sb_state=%d,…age_stripe=%d, group=%d.\n", \

1788 
__func__
, 
sb
->
sb_šdex
, sb->
¡©e
, 
·ge_¡re
, 
group_šdex
);

1789 
·r™y_is_em±y
 = 1;

1791 
	`shªnÚ_šfo
("%s: blank†ogicb in data†un, sb_index=%d, sb_state=%d,†un=%d,…ba=%d.\n", \

1792 
__func__
, 
sb
->
sb_šdex
, sb->
¡©e
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

1794 
sb
->
»cov”_¡©us
 |ğ
NEED_RECLAIM
;

1795 
ä“_»que¡
;

1798 ià(
sdev
->
¿id5_suµÜ‹d
 && (
»q
->
pba
.
lun
 =ğ
	`g‘_·r™y_lun
(&
sb
->
sub_group
[»q->pba.lun/sdev->
max_luns_š_group
]))) {

1800 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
)

1801 
sb
->
»cov”_¡©us
 |ğ
NEED_RECLAIM
;

1802 
ä“_»que¡
;

1805 ià(
»q
->
_ecc
 < 
SH_FAKE_ERR
) {

1806 
is_ns_d©a
 = (
»q
->
lba
 =ğ
šv®id_lba
[
sdev
->
lba_fÜm©
] && sdev->
mbr
.
sdev_id
 == 0);

1807 ià(
¥oŞ
) {

1808 
ns
 = 
¥oŞ
->ns[
»q
->
ns_id
];

1809 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

1810 ià(!
	`»q_has_šv®id_lba
(
»q
))

1811 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

1812 
ä“_»que¡
;

1814 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

1815 ià(!
	`»q_has_šv®id_lba
(
»q
))

1816 
	`shªnÚ_”r
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

1817 
sb
->
sb_šdex
, 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

1818 
ä“_»que¡
;

1820 
sdisk
 = &
ns
->sdisk;

1821 ià(
is_ns_d©a
) {

1822 
sb_num
 = 
ns
->
d©a_pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
;

1823 ià(
ns
->
d©a_pba
.
lun_pba
 == 0x03ffffff ||

1824 
sdev
->
sbs
[
sb_num
].
£q_num
 <ğ
sb
->seq_num)

1825 
	`»cov”_ns_d©a_äom_»q
(
ns
, 
»q
, 
sdev
);

1826 
ä“_»que¡
;

1829 ià(
	`»q_has_šv®id_lba
(
»q
))

1830 
ä“_»que¡
;

1831 ià(
»q
->
lba
 > 
sdisk
->
tÙ®_m­_bË_size
 / (
u32
)) {

1832 
	`shªnÚ_”r
("Wrong data: sb_index=%d,†ba=0x%lx,†un=%d,†un_pba=%d,ƒcc=0x%x, datatype=0x%x.\n",

1833 
sb
->
sb_šdex
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
d©©y³
);

1834 
ä“_»que¡
;

1836 ià(
	`check_ªd_®loc_m­bË
(
sdisk
, 
»q
->
lba
)) {

1837 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1838 
ä“_»que¡
;

1840 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

1841 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

1842 ià(
»t
 < 0) {

1844 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

1845 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

1846 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

1847 ià(
sdev
->
¥oŞ
)

1848 
	`shªnÚ_©omic64_šc
(&
sdev
->
¥oŞ
->
u£d_logicbs
);

1850 
blk_num
 = 
Şd_pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
;

1851 ià((
sdev
->
sbs
[
blk_num
].
£q_num
 > 
sb
->£q_numè|| ((
Şd_pba
.
lun
 =ğ
»q
->
pba
.lunè&& (Şd_pba.
lun_pba
 ==„eq->pba.lun_pba))) {

1853 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

1856 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

1857 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

1858 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

1859 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

1863 
d©a_is_”rÜ
 = 1;

1864 
ä“_»que¡
:

1865 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

1866 
	`ä“_»q
(
»q
);

1869 ià(
d©a_is_”rÜ
) {

1870 
	`shªnÚ_”r
("D©¨”rÜ iÀsu³rblock %d.\n", 
sb
->
sb_šdex
);

1871 ià(
·r™y_is_em±y
 && 
shªnÚ_fÜû_»şaim_aùiveblock
)

1872 
	`shªnÚ_log
("fÜû„eşaim‡ùiveblock i ’abË, driv” wÈ»şaim su³rblock %d.\n", 
sb
->
sb_šdex
);

1874 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1876 
	`ä“_sbio
(
sbio
);

1878 ià(
·r™y_is_em±y
) {

1879 
	`shªnÚ_log
("%s():…¬™y†uÀi em±y, sÿÀi fšish, sb=%d,…age_¡re=%d, group_šdex=%d.\n", 
__func__
, 
sb
->
sb_šdex
, 
·ge_¡re
, 
group_šdex
);

1880 
fšish
;

1884 
group_šdex
++;

1885 ià(
group_šdex
 =ğ
sdev
->
·r™y_groups
) {

1886 
group_šdex
 = 0;

1887 
·ge_¡re
++;

1888 ià(
·ge_¡re
 =ğ
sdev
->
·ges_š_eblock
)

1889 
fšish
;

1891 
group
 = &
sb
->
sub_group
[
group_šdex
];

1892 
	`debugs1
("%s:…age_¡re=%d, group_šdex=%d, grou°phy_šdex=%d.\n", 
__func__
, 
·ge_¡re
, 
group_šdex
, 
group
->
phy_šdex
);

1893 } 
group
->
phy_šdex
 < 0);

1895 ià(
sdev
->
¶ug_out
)

1896 
fšish
;

1897 
	`debugs1
("%s:…ages_š_eblock=%d,…age_¡re=%d,…¬™y_groups=%d, group_šdex=%d", 
__func__
, \

1898 
sdev
->
·ges_š_eblock
, 
·ge_¡re
, sdev->
·r™y_groups
, 
group_šdex
);

1899 ià(
	`sÿn_su³r_block
(
sb
, 
·ge_¡re
, 
group_šdex
))

1900 
fšish
;

1903 
fšish
:

1904 
	`debugs1
("%s: fšish.\n", 
__func__
);

1905 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

1906 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

1907 
	}
}

1916 
	$sÿn_su³r_block
(
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
group_šdex
)

1918 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

1919 
shªnÚ_bio
 *
sbio
;

1920 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

1921 
i
, 
¶ªe
, 
lun
, 
lun_off£t
, 
lun_š_group
, 
fœ¡_pba
;

1922 
sub_group
 *
group
;

1923 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

1924 
»t
 = 0;

1926 ià(
sb
->
£q_num
 == 0) {

1927 
	`shªnÚ_”r
("sb_šdex=%d, seq_num=%Îx.\n", 
sb
->
sb_šdex
, sb->
£q_num
);

1928 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

1929 
»t
 = -1;

1930 
out
;

1933 
group
 = &
sb
->
sub_group
[
group_šdex
];

1934 
group
->
phy_šdex
 < 0) {

1935 
group_šdex
++;

1936 ià(
group_šdex
 =ğ
sdev
->
·r™y_groups
) {

1937 
group_šdex
 = 0;

1938 
·ge_¡re
++;

1939 ià(
·ge_¡re
 =ğ
sdev
->
·ges_š_eblock
) {

1940 
»t
 = 1;

1941 
out
;

1944 
group
 = &
sb
->
sub_group
[
group_šdex
];

1947 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

1948 
	`£t_sbio_debug_g
(
sbio
, 
RECOVER_ACTIVE_BLK_TAG
);

1949 
sbio
->
logicbs
 = 
sb
->
mš_avaabË_luns
 * 
sdev
->
logicbs_š_chunk
;

1950 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

1951 
sbio
->
ÿÎback
 = 
sÿn_su³r_block_ÿÎback
;

1952 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

1953 
sbio
->
d©a
 = 
sb
;

1954 
sbio
->
d©a2
 = (*)
group_šdex
;

1956 
fœ¡_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + sdev->
logicbs_š_·ge
 * 
·ge_¡re
;

1957 
lun_š_group
 = 0;

1958 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

1959 
	`debugs1
("%s: sb(%dè·g¡re=%d, group=%d.\n", 
__func__
, 
sb
->
sb_šdex
, 
·ge_¡re
, 
group_šdex
);

1961 ià(
lun_š_group
 =ğ
sb
->
mš_d©a_luns
) {

1962 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

1963 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1966 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

1967 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

1968 } 
	`is_bad_lun
(
sb
, 
lun
));

1971 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

1972 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

1973 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

1974 
	`£t_»q_debug_g
(
»q
, 
RECOVER_ACTIVE_BLK_TAG
, 
i
);

1975 
»q
->
İcode
 = 
sh_cmd_»ad
;

1976 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1977 
»q
->
lba
 = 
LONG_INVALID_LBA
;

1978 
»q
->
pba
.
lun
 =†un;

1979 
»q
->
pba
.
lun_pba
 = 
fœ¡_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
;

1980 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1981 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1982 
»q
->
sbio
 = sbio;

1983 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1984 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1985 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

1988 
lun_š_group
++;

1989 } 
lun_off£t
 !ğ
group
->
·r™y_lun_off£t
);

1991 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

1992 
»t
 = 0;

1994 
out
:

1995  
»t
;

1996 
	}
}

1998 
	$»ÿlcuÏ‹_·r™y_lun
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
)

2000 
g
, 
phy_šdex
;

2001 
sub_group
 *
group
;

2003 
sb
->
mš_avaabË_luns
 = 
dev
->
max_luns_š_group
;

2004 
phy_šdex
 = 0;

2005 
g
 = 0; g < 
dev
->
·r™y_groups
; g++) {

2006 
group
 = &
sb
->
sub_group
[
g
];

2007 ià(
group
->
phy_šdex
 < 0)

2009 
group
->
phy_šdex
 =…hy_index++;

2010 ià(
sb
->
mš_avaabË_luns
 > 
	`shªnÚ_©omic_»ad
(&
group
->
avaabË_luns
))

2011 
sb
->
mš_avaabË_luns
 = 
	`shªnÚ_©omic_»ad
(&
group
->
avaabË_luns
);

2012 ià(
dev
->
¿id5_suµÜ‹d
)

2013 
group
->
d©a_luns
 = 
	`shªnÚ_©omic_»ad
(&group->
avaabË_luns
) - 1;

2015 
group
->
d©a_luns
 = 
	`shªnÚ_©omic_»ad
(&group->
avaabË_luns
);

2016 
	`is_bad_lun
(
sb
, 
group
->
¡¬t_lun
 + group->
fœ¡_lun_off£t
))

2017 
group
->
fœ¡_lun_off£t
 = (group->fœ¡_lun_off£ˆ+ 1è% 
dev
->
max_luns_š_group
;

2018 
	`is_bad_lun
(
sb
, 
group
->
¡¬t_lun
 + group->
·r™y_lun_off£t
))

2019 
group
->
·r™y_lun_off£t
 = (group->·r™y_lun_off£ˆ+ 
dev
->
max_luns_š_group
 - 1) % dev->max_luns_in_group;

2020 ià(
dev
->
¿id5_suµÜ‹d
) {

2021 
group
->
Ï¡_d©a_lun_off£t
 = (group->
·r™y_lun_off£t
 + 
dev
->
max_luns_š_group
 - 1) % dev->max_luns_in_group;

2022 
	`is_bad_lun
(
sb
, 
group
->
¡¬t_lun
 + group->
Ï¡_d©a_lun_off£t
))

2023 
group
->
Ï¡_d©a_lun_off£t
 = (group->Ï¡_d©a_lun_off£ˆ+ 
dev
->
max_luns_š_group
 - 1) % dev->max_luns_in_group;

2025 
group
->
Ï¡_d©a_lun_off£t
 = group->
·r™y_lun_off£t
;

2027 
sb
->
mš_d©a_luns
 = 
dev
->
¿id5_suµÜ‹d
?(sb->
mš_avaabË_luns
 - 1):sb->min_available_luns;

2028 
	}
}

2030 
	$»š™Ÿlize_sb
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
)

2032 
sb
->
£q_num
 = 
MAX_SEQ_NUM
;

2033 
sb
->
wr_off£t
 = 0;

2034 
	`ş—r_pba_bË
(
dev
, 
sb
->
sb_šdex
);

2035 
	`shªnÚ_©omic_£t
(&
sb
->
v®id_·ges
, 0);

2036 
	`shªnÚ_©omic_£t
(&
sb
->
unfšished_wr™es
, 0);

2037 
	`shªnÚ_©omic_£t
(&
sb
->
³riod_»ad_dÚe
, 0);

2038 
sb
->
max_lun_ecc_çu»_times
 = 0;

2039 
	`shªnÚ_mem£t
(
sb
->
ecc_çu»_times
, 0, (è* 
MAX_LUN_COUNT
);

2040 
	`»ÿlcuÏ‹_·r™y_lun
(
dev
, 
sb
);

2041 
sb
->
¡©e
 = 
FREE_BLOCK
;

2042 
sb
->
gc_š_æight
 = 0;

2043 
sb
->
»şaim_kšd
 = 0;

2044 
sb
->
Ãxt_sb
 = 
INVALID_SB_INDEX
;

2045 
	`shªnÚ_mem£t
(
sb
->
»ad_couÁ
, 0, (
u32
è* 
dev
->
lun_couÁ
);

2046 
sb
->
max_»ad_couÁ
 = 0;

2047 
sb
->
fl_sb
 = 0;

2048 
sb
->
max_ecc
 = 0;

2049 
sb
->
»cov”_¡©us
 = 0;

2050 
	`shªnÚ_mem£t
(
sb
->
”r_msg_lun
, 0, (sb->err_msg_lun));

2051 ià(
dev
->
com·ù_•og
) {

2052 
chunk_size
 = 
dev
->
logicb_size
 * dev->
logicbs_š_chunk
;

2053 
sb
->
•og_size
 = 
	`shªnÚ_©omic_»ad
(&sb->
avaabË_groups
è* sb->
mš_d©a_luns
 * 
dev
->
logicbs_š_siblšg_eblock
 * dev->
•og_’Œy_size
 + dev->
•og_h—d_size
;

2054 
sb
->
•og_size
 = ((sb->•og_siz+ 
chunk_size
 - 1) / chunk_size) * chunk_size;

2055 
sb
->
logicbs_š_•og
 = sb->
•og_size
/
dev
->
logicb_size
;

2057 
sb
->
•og_size
 = 
dev
->
max_•og_size
;

2058 
sb
->
logicbs_š_•og
 = 
dev
->
max_logicbs_š_•og
;

2060 
	}
}

2062 
	$add_sb_to_ä“_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
Ãw_sb
)

2064 
shªnÚ_sb
 *
p
;

2066 
	`BUG_ON
(
Ãw_sb
->
¡©e
 !ğ
FREE_BLOCK
);

2067 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&
Ãw_sb
->
li¡
));

2068 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

2069 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
sdev
->
ä“_blocks
, 
li¡
) {

2070 ià(
p
->
”a£_couÁ”
 > 
Ãw_sb
->erase_counter)

2073 
	`shªnÚ_li¡_add_
(&
Ãw_sb
->
li¡
, &
p
->list);

2074 
sdev
->
ä“_blkút
++;

2076 ià(
sdev
->
ä“_blkút
 =ğ
GC_THRESHOLD_N3
)

2077 
	`shªnÚ_wake_up
(&
sdev
->
block_ho¡_wr
);

2078 ià(
sdev
->
ä“_blkút
 == 1)

2079 
	`shªnÚ_wake_up
(&
sdev
->
wa™_ä“_blk
);

2081 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
ä“_blocks_lock
);

2082 
	}
}

2084 
	$add_sb_”a£_couÁ”
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
)

2086 
sb
->
”a£_couÁ”
++;

2090 ià(
	`uÆik–y
(
dev
->
max_”a£_couÁ
 < 
sb
->
”a£_couÁ”
))

2091 
dev
->
max_”a£_couÁ
 = 
sb
->
”a£_couÁ”
;

2092 
	}
}

2094 
add_dyÇmic_bbt
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
ä“_æag
);

2095 
add_dyÇmic_bbt_g5
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
ä“_æag
);

2096 
	$»_”a£_su³r_block_ÿÎback
(
shªnÚ_bio
 *
sbio
)

2098 
shªnÚ_sb
 *
sb
 = 
sbio
->
d©a
;

2099 
shªnÚ_dev
 *
dev
 = 
sb
->
sdev
;

2100 
shªnÚ_»que¡
 *
»q
;

2102 
	`shªnÚ_©omic_dec
(&
dev
->
š_”a£_blkút
);

2103 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
)

2104 
»q
->
¡©e
 = 
REQ_CALLBACK
;

2106 
	`add_sb_”a£_couÁ”
(
dev
, 
sb
);

2107 
dev
->
tÙ®_”a£_couÁ
++;

2108 ià(
	`should_upd©e_miüocode
(
dev
))

2109 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
upd©e_miüocode_wÜk
);

2110 
sb
->
Ï¡_”a£d_time¡amp
 = 
	`g‘_jiff›s
();

2111 
sb
->
¡©e
 = sb->
Şd_¡©e
;

2113 ià(
sb
->
sb_šdex
 < 
dev
->
mbr_eblocks
/dev->
¶ªes
) {

2114 
sb
->
¡©e
 = 
MBR_BLOCK
;

2115 
sb
->
wr_off£t
 = ~0;

2118 !
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
)) {

2119 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

2120 
	`BUG_ON
(
»q
->
sbio
 != sbio);

2121 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

2122 
	`ä“_»q
(
»q
);

2125 
	`ä“_sbio
(
sbio
);

2126 
	}
}

2128 
	$”a£_su³r_block_ÿÎback
(
shªnÚ_bio
 *
sbio
)

2130 
shªnÚ_sb
 *
sb
 = 
sbio
->
d©a
;

2131 
shªnÚ_dev
 *
dev
 = 
sb
->
sdev
;

2132 
shªnÚ_»que¡
 *
»q
;

2133 
Şd_»şaim_kšd
 = 
sb
->
»şaim_kšd
;

2134 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


2135 
lun
;

2138 
	`shªnÚ_©omic_dec
(&
dev
->
š_”a£_blkút
);

2139 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
)

2140 
»q
->
¡©e
 = 
REQ_CALLBACK
;

2142 ià(
Şd_»şaim_kšd
 & (1UL << 
ERROR_SB_SHIFT
)) {

2143 
	`shªnÚ_šfo
("%s:„eşaim sb %d w™h„eşaim kšd %d.\n", 
dev
->
sdisk
.
disk_Çme
,

2144 
sb
->
sb_šdex
, 
ERROR_SB_SHIFT
);

2145 
	`sb_m¬k_”rÜ_lun_bad
(
dev
, 
sb
);

2146 ià(
sb
->
sb_šdex
 >ğ
dev
->
mbr_eblocks
/dev->
¶ªes
)

2147 
	`shªnÚ_©omic_dec
(&
dev
->
³ndšg_”r_blks
);

2150 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_groups
è< 
dev
->
max_avaabË_groups
) {

2151 
sb
->
¡©e
 = 
DISCARDED_BLOCK
;

2152 
	`shªnÚ_©omic_šc
(&
dev
->
disÿrded_blkút
);

2154 
	`m¬k_su³r_block_bad
(
sb
);

2155 ià(
Şd_»şaim_kšd
 & (1UL << 
ERROR_SB_SHIFT
)) {

2156 ià(
	`shªnÚ_dev_is_g5
(
dev
))

2157 
	`add_dyÇmic_bbt_g5
(
dev
, 
sb
, 0);

2159 
	`add_dyÇmic_bbt
(
dev
, 
sb
, 0);

2161 
out
;

2164 
	`add_sb_”a£_couÁ”
(
dev
, 
sb
);

2165 
sb
->
Ï¡_”a£d_time¡amp
 = 
	`g‘_jiff›s
();

2167 
	`»š™Ÿlize_sb
(
dev
, 
sb
);

2168 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


2169 
	`BUG_ON
(
dev
->
logicbs_š_siblšg_eblock
 % 64);

2170 
lun
 = 0;†uÀ< 
dev
->
lun_couÁ
;†un++) {

2171 
u64
 
off£t
 = ()
lun
 * 
dev
->
sb_couÁ
 * dev->
logicbs_š_siblšg_eblock
;

2172 
	`shªnÚ_mem£t
((
u8
 *)
dev
->
çke_rd_bad_luÅba
 + 
off£t
/8, 0x00, dev->
logicbs_š_siblšg_eblock
/8);

2176 ià(
sb
->
sb_šdex
 < 
dev
->
mbr_eblocks
/dev->
¶ªes
) {

2177 
sb
->
¡©e
 = 
MBR_BLOCK
;

2178 
sb
->
wr_off£t
 = ~0;

2179 
out
;

2182 
dev
->
tÙ®_”a£_couÁ
++;

2183 ià(
	`should_upd©e_miüocode
(
dev
))

2184 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
upd©e_miüocode_wÜk
);

2186 ià(
Şd_»şaim_kšd
 & (1UL << 
ERROR_SB_SHIFT
)) {

2187 ià(
	`shªnÚ_dev_is_g5
(
dev
))

2188 
	`add_dyÇmic_bbt_g5
(
dev
, 
sb
, 1);

2190 
	`add_dyÇmic_bbt
(
dev
, 
sb
, 1);

2192 
	`add_sb_to_ä“_li¡
(
dev
, 
sb
);

2194 ià(
	`shªnÚ_©omic_»ad
(&
dev
->
”a£_dummy_dÚe
) != 0)

2195 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
dev
->
”a£_dummy_dÚe
))

2196 
	`shªnÚ_wake_up
(&
dev
->
”a£_dummy_dÚe_ev’t
);

2198 
out
:

2199 !
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
)) {

2200 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

2201 
	`BUG_ON
(
»q
->
sbio
 != sbio);

2202 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

2203 
	`ä“_»q
(
»q
);

2206 
	`ä“_sbio
(
sbio
);

2207 
	}
}

2209 
	$”a£_su³r_block
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
äom_gc
, 
Ãed_»š™
)

2211 
i
, 
¶ªe
;

2212 
shªnÚ_bio
 *
sbio
;

2213 
shªnÚ_»que¡
 *
»q
, *
p
;

2216 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
unfšished_wr™es
))

2217 
	`shªnÚ_”r
("sb->sb_šdex=%d, sb->¡©e=%d, sb->unfšished_wr™es=%d.\n", 
sb
->
sb_šdex
, sb->
¡©e
, 
	`shªnÚ_©omic_»ad
(&sb->
unfšished_wr™es
));

2218 
	`shªnÚ_©omic_šc
(&
dev
->
š_”a£_blkút
);

2219 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

2220 
	`£t_sbio_debug_g
(
sbio
, 
ERASE_BLOCK_TAG
);

2221 
sbio
->
logicbs
 = 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_luns
è* 
dev
->
¶ªes
;

2222 ià(
dev
->
p£udo_¶ªe
)

2223 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_luns
));

2225 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_luns
è* 
dev
->
¶ªes
);

2226 
sbio
->
ÿÎback
 = (
äom_gc
 || 
Ãed_»š™
è? 
”a£_su³r_block_ÿÎback
 : 
»_”a£_su³r_block_ÿÎback
;

2227 
sbio
->
d©a
 = 
sb
;

2233 
sbio
->
may_¦“p_š_ÿÎback
 = 3;

2235 
i
=0; i<
dev
->
lun_couÁ
; i++) {

2236 ià(!
	`is_bad_lun
(
sb
, 
i
)) {

2237 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

2238 
	`£t_»q_debug_g
(
»q
, 
ERASE_BLOCK_TAG
, 0);

2239 
»q
->
İcode
 = 
sh_cmd_”a£
;

2240 
»q
->
pba
.
lun
 = 
i
;

2241 
»q
->
µa
 = 
sb
->
sb_šdex
 * 
dev
->
·ges_š_eblock
 * dev->
¶ªes
;

2242 
»q
->
lba
 = 
LONG_INVALID_LBA
;

2243 
»q
->
sbio
 = sbio;

2244 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

2245 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

2247 ià(!
dev
->
p£udo_¶ªe
) {

2248 
¶ªe
 = 1;

2249 
¶ªe
 < 
dev
->
¶ªes
) {

2250 
p
 = 
	`®loc_»q
(
GFP_SHANNON
);

2251 
	`£t_»q_debug_g
(
p
, 
ERASE_BLOCK_TAG
, 
¶ªe
);

2252 
p
->
İcode
 = 
sh_cmd_”a£
;

2253 
p
->
pba
.
lun
 = 
i
;

2254 
p
->
µa
 = 
»q
->µ¨+ 
dev
->
·ges_š_eblock
 * 
¶ªe
;

2255 
p
->
lba
 = 
LONG_INVALID_LBA
;

2256 
p
->
sbio
 = sbio;

2257 
	`shªnÚ_li¡_add_
(&
p
->
bio_li¡
, &
sbio
->
»q_li¡
);

2258 
	`shªnÚ_li¡_add_
(&
p
->
chunk_li¡
, &
»q
->chunk_list);

2260 
¶ªe
++;

2263 
	`add_lun_»que¡_queue_
(
dev
->
lun
[
i
], 
»q
);

2267 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

2270 ià(
äom_gc
 && 
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

2272 
	`lun£t_pick_»que¡
(&
dev
->
lun£ts
[
i
], dev->
cfg_lun_š_lun£t
 * dev->
¶ªes
);

2274 
	}
}

2277 
	$gc_g‘_Ãxt_h—d
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
)

2279 ià(
dev
->
u£_du®_h—d
 == 0) {

2280 
»q
->
h—d
 = (
shªnÚ_š™_‹mp
 > 
HIGHEST_COLD_STATE
)? 
HOT_HEAD
 : 
COLD_HEAD
;

2282 
shªnÚ_sb
 *
sb
 = 
dev
->
sbs
 + 
»q
->
pba
.
lun_pba
/dev->
logicbs_š_siblšg_eblock
;

2284 
»q
->
h—d
 = 
COLD_HEAD
;

2287 ià(
sb
->
sb_šdex
 =ğ
dev
->
wr_sb
[
HOT_INDEX
])

2288 
»q
->
h—d
 = 
HOT_HEAD
;

2289 ià(
sb
->
sb_šdex
 =ğ
dev
->
wr_sb
[
COLD_INDEX
])

2290 
»q
->
h—d
 = 
COLD_HEAD
;

2292 
	}
}

2294 
	$gc_wr™e_ÿnûl_ÿÎback
(
shªnÚ_bio
 *
sbio
)

2296 
shªnÚ_sb
 *
Şd_sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

2297 
shªnÚ_dev
 *
dev
 = 
Şd_sb
->
sdev
;

2298 
shªnÚ_»que¡
 *
»q
;

2300 
	`shªnÚ_dma_unm­_sšgË
(
dev
->
pci_dev
, 
sbio
->
dma_add»ss
, dev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

2301 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

2302 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

2303 
»q
->
¡©e
 = 
REQ_CALLBACK
;

2304 
	`£t_gc_wr™e_dÚe
(
dev
, 
Şd_sb
, &
»q
->
Şd_pba
);

2306 
	`ä“_»q
(
»q
);

2307 
	`ä“_logicb_buf
(
dev
, 
sbio
->
vœt_addr
);

2308 ià(
sbio
->
g
 =ğ
WL_TAG
)

2309 
	`shªnÚ_©omic_dec
(&
dev
->
š_wl_logicbs
);

2310 ià(
	`shªnÚ_‹¡_b™
(
GC_SB_SHIFT
, &
Şd_sb
->
»şaim_kšd
))

2311 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_logicbs
);

2313 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_logicbs
);

2314 
	`ä“_sbio
(
sbio
);

2315 
	}
}

2317 
	$gc_wr™e_ÿnûl
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

2319 
	`BUG_ON
(
»q
->
sbio
->
logicbs
 != 1);

2321 
»q
->
sbio
->
ÿÎback
 = 
gc_wr™e_ÿnûl_ÿÎback
;

2322 
»q
->
sbio
->
may_¦“p_š_ÿÎback
 = 1;

2323 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

2324 
	}
}

2326 
	$gc_wr™e_ÿÎback
(
shªnÚ_bio
 *
sbio
)

2328 
shªnÚ_sb
 *
Ãw_sb
, *
Şd_sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

2329 
shªnÚ_dev
 *
dev
 = 
Şd_sb
->
sdev
;

2330 
shªnÚ_poŞ
 *
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
dev
->spool);

2331 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

2332 
shªnÚ_disk
 *
sdisk
 = &
dev
->sdisk;

2333 
shªnÚ_»que¡
 *
»q
;

2334 
lun_pba
 
Şd_pba
;

2335 
is_ns_d©a
 = 0;

2337 
	`shªnÚ_dma_unm­_sšgË
(
dev
->
pci_dev
, 
sbio
->
dma_add»ss
, dev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

2338 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

2339 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

2340 
»q
->
¡©e
 = 
REQ_CALLBACK
;

2341 
	`£t_gc_wr™e_dÚe
(
dev
, 
Şd_sb
, &
»q
->
Şd_pba
);

2343 ià(
¥oŞ
) {

2344 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

2345 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

2346 
	`shªnÚ_šfo
("%s():‚ame¥aû‚s_id=%d mighˆb»moved ju¡‚ow.\n", 
__func__
, 
»q
->
ns_id
);

2347 
out
;

2349 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

2350 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

2351 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

2352 
out
;

2354 
sdisk
 = &
ns
->sdisk;

2355 
is_ns_d©a
 = (
dev
->
mbr
.
sdev_id
 =ğ0 && 
»q
->
lba
 =ğ
šv®id_lba
[dev->
lba_fÜm©
]);

2358 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

2359 ià(
is_ns_d©a
)

2360 
	`shªnÚ_¥š_lock_bh
(&
ns
->
d©a_lock
);

2362 
	`Ímt_lock
(
dev
, 
sdisk
, 
»q
->
lba
);

2363 ià(!
	`pba_is_šv®id
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
)) {

2364 ià(
is_ns_d©a
)

2365 
Şd_pba
 = 
ns
->
d©a_pba
;

2367 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

2368 ià((
Şd_pba
.
lun
 !ğ
»q
->Şd_pba.lunè|| (Şd_pba.
lun_pba
 !=„eq->old_pba.lun_pba)) {

2369 
u8
 *
pba_bË1
, *
pba_bË2
;

2370 
pba_bË1
 = (
u8
 *)
dev
->
lun
[
Şd_pba
.lun]->
pba_bË
;

2371 
pba_bË2
 = (
u8
 *)
dev
->
lun
[
»q
->
Şd_pba
.lun]->
pba_bË
;

2372 
	`shªnÚ_šfo
("%s(): old_pba.lun=%d, old_pba.lun_pba=%d;„eq->old_pba.lun=%d,„eq->old_pba.lun_pba=%d.\n",

2373 
__func__
, 
Şd_pba
.
lun
, old_pba.
lun_pba
, 
»q
->old_pba.lun,„eq->old_pba.lun_pba);

2374 
	`shªnÚ_šfo
("%s(): old_pba status=0x%x,„eq->old_pba status=0x%x.\n",

2375 
__func__
, 
pba_bË1
[
Şd_pba
.
lun_pba
], 
pba_bË2
[
»q
->old_pba.lun_pba]);

2377 
	`BUG_ON
((
Şd_pba
.
lun
 !ğ
»q
->Şd_pba.lunè|| (Şd_pba.
lun_pba
 !=„eq->old_pba.lun_pba));

2378 
	`£t_v®id
(
dev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

2379 ià(
is_ns_d©a
)

2380 
ns
->
d©a_pba
 = 
»q
->
pba
;

2382 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

2383 ià(
dev
->
ov”Ïp_wr™e
) {

2384 
	`BUG_ON
(
	`pba_is_equ®
(&
»q
->
Şd_pba
, &
dev
->
ov”Ïp
->
pba
));

2385 
	`BUG_ON
(
	`pba_is_equ®
(&
»q
->
pba
, &
dev
->
ov”Ïp
->pba));

2387 
	`£t_Şd_pba_¡®e
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
);

2389 
	`£t_gc_wr™e_šv®id
(
dev
, &
»q
->
pba
);

2391 ià(
is_ns_d©a
)

2392 
	`shªnÚ_¥š_uÆock_bh
(&
ns
->
d©a_lock
);

2394 
	`Ímt_uÆock
(
dev
, 
sdisk
, 
»q
->
lba
);

2396 
out
:

2397 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

2399 
Ãw_sb
 = 
dev
->
sbs
 + 
»q
->
pba
.
lun_pba
/dev->
logicbs_š_siblšg_eblock
;

2400 
	`shªnÚ_©omic_dec
(&
Ãw_sb
->
š_wr™e_logicbs
);

2403 
	`ä“_»q
(
»q
);

2404 
	`ä“_logicb_buf
(
dev
, 
sbio
->
vœt_addr
);

2405 ià(
sbio
->
g
 =ğ
WL_TAG
) {

2406 
	`shªnÚ_©omic_dec
(&
dev
->
š_wl_logicbs
);

2407 
dev
->
tÙ®_wl_logicbs
++;

2408 } ià(
	`shªnÚ_‹¡_b™
(
GC_SB_SHIFT
, &
Şd_sb
->
»şaim_kšd
)) {

2409 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_logicbs
);

2410 
dev
->
tÙ®_gc_logicbs
++;

2412 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_logicbs
);

2413 
dev
->
tÙ®_”r_»cov”_logicbs
++;

2415 
	`ä“_sbio
(
sbio
);

2416 ià((((
	`shªnÚ_©omic_»ad
(&
dev
->
wa™_blk
è=ğ
Şd_sb
->
sb_šdex
è&& (dev->
š™_dÚe
 =ğ
STAGE_RECOVER_ACTIVE_DONE
)) \

2417 && (
	`shªnÚ_©omic_»ad
(&
Şd_sb
->
v®id_·ges
è=ğ0)è|| 
dev
->
¶ug_out
) {

2418 
	`shªnÚ_©omic_£t
(&
dev
->
wa™_blk
, -1);

2419 
	`shªnÚ_wake_up
(&
dev
->
wa™_blk_dÚe_ev’t
);

2422 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

2423 
	}
}

2425 
	$£t_sb_cİy_”r_¡©e
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

2427 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

2428 
sb
->
¡©e
) {

2429 
IN_GC_BLOCK
:

2430 
	`shªnÚ_©omic_dec
(&
sdev
->
š_gc_blkút
);

2432 
IN_RECOVER_BLOCK
:

2434 
COPY_ERR_BLOCK
:

2435 
WAIT_ERASE_BLOCK
:

2436 
FREE_BLOCK
:

2437 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2440 
	`shªnÚ_šfo
("%s: Might be‡…roactive gc. sb=%d, state=%d.\n",

2441 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, sb->
¡©e
);

2442 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2445 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
cİy_”r_lock
);

2446 
sb
->
¡©e
 = 
COPY_ERR_BLOCK
;

2447 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
cİy_”r_blocks
);

2448 
sdev
->
cİy_”r_blkút
++;

2449 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
cİy_”r_lock
);

2450 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2451 ià(
	`lik–y
((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& sdev->
gc_th»ad
))

2452 
	`shªnÚ_wake_up_´oûss
(
sdev
->
gc_th»ad
);

2453 
	`shªnÚ_šfo
("%s: change sb=%do‚ew state %d. Total blocks‚ow: %d\n",

2454 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
COPY_ERR_BLOCK
, sdev->
cİy_”r_blkút
);

2455 
	}
}

2457 
	$gc_»ad_ÿÎback
(
shªnÚ_bio
 *
sbio
)

2459 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

2460 
shªnÚ_dev
 *
dev
 = 
sb
->
sdev
;

2461 
shªnÚ_poŞ
 *
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
dev
->spool);

2462 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

2463 
shªnÚ_disk
 *
sdisk
 = &
dev
->sdisk;

2464 
shªnÚ_»que¡
 *
»q
;

2465 
lun_pba
 
Şd_pba
;

2466 
¶ªe
, 
fl_h—d
 = 0;

2467 
is_ns_d©a
 = 0;

2469 
	`shªnÚ_dma_unm­_sšgË
(
dev
->
pci_dev
, 
sbio
->
dma_add»ss
, dev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

2470 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

2471 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

2472 
»q
->
¡©e
 = 
REQ_CALLBACK
;

2473 
	`BUG_ON
(
sb
->
sb_šdex
 !ğ
»q
->
pba
.
lun_pba
/
dev
->
logicbs_š_siblšg_eblock
);

2474 ià(
»q
->
»»ad
 & 
RAID_READ_MASK
) {

2475 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
dev
->
logicb_size
);

2476 
	`ä“_logicb_buf
(
dev
, 
»q
->
»cov”_buf
);

2479 ià(
	`uÆik–y
(
dev
->
¶ug_out
))

2480 
kä“
;

2482 ià(
	`pba_is_šv®id
(
dev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
))

2483 
kä“
;

2485 ià(
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
) {

2486 
	`shªnÚ_log
("%s:hadd»s lun=%d,†un_pba=0x%x i bÏnk!\n", 
dev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

2487 
kä“
;

2490 ià(
sbio
->
¡©us
 & 
HAVE_ERROR_SECTOR
) {

2491 ià(!(
dev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
)) {

2492 
	`shªnÚ_”r
("The‡ddress†un=%d,†un_pba=0x%x can‚ot be„ead out correctly! status=0x%x.\n",

2493 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
, 
sbio
->
¡©us
);

2494 
¶ªe
 = ((
»q
->
pba
.
lun_pba
/
dev
->
logicbs_š_·ge
)/dev->
·ges_š_eblock
è% dev->
¶ªes
;

2495 ià(!
	`is_”rÜ_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
))

2496 
	`sb_m¬k_”rÜ_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
);

2497 ià((
dev
->
š™_dÚe
 > 
STAGE_BBT_DONE
è&& (dev->š™_dÚ<ğ
STAGE_RECOVER_DONE
)) {

2498 
	`shªnÚ_”r
("%s: Recov”‡ùivsb(%d), R—d E¼Ü¼¼¼¼¼¼¼¼¼¼r.\n", 
dev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
);

2499 
	`£t_»cov”_¡©e_”rÜ
(
dev
);

2501 
	`£t_sb_cİy_”r_¡©e
(
dev
, 
sb
);

2503 
kä“
;

2506 ià(
¥oŞ
) {

2507 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

2508 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

2509 
	`shªnÚ_šfo
("%s():‚ame¥aû‚s_id=%d mighˆb»moved ju¡‚ow.\n", 
__func__
, 
»q
->
ns_id
);

2510 
kä“
;

2512 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

2513 
	`shªnÚ_”r
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

2514 
sb
->
sb_šdex
, 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

2515 
kä“
;

2517 
sdisk
 = &
ns
->sdisk;

2518 
is_ns_d©a
 = (
dev
->
mbr
.
sdev_id
 =ğ0 && 
»q
->
lba
 =ğ
šv®id_lba
[dev->
lba_fÜm©
]);

2522 ià(
	`uÆik–y
((
»q
->
ns_id
 !ğ0è|| (»q->
ns_£q_num
 != 0))) {

2523 
	`shªnÚ_w¬n
("%s:spool might be„emoved just‚ow.‚s_id=%d,‚s_seq_num=%d, metadata=0x%lx,†un=%d,†un_pba=%d.\n",

2524 
dev
->
sdisk
.
disk_Çme
, 
»q
->
ns_id
,„eq->
ns_£q_num
,„eq->
_m‘ad©a
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

2525 
kä“
;

2529 ià(
»q
->
lba
 > 
sdisk
->
tÙ®_m­_bË_size
/(
u32
è&& !
is_ns_d©a
) {

2530 
	`shªnÚ_”r
("Data Corrupted on Disk:†ba=0x%lx,†un=%d,†un_pba=%d,„eread=%d,ƒcc=0x%x.\n",

2531 ()
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
»»ad
,„eq->
_ecc
);

2532 
	`£t_sb_cİy_”r_¡©e
(
dev
, 
sb
);

2533 
kä“
;

2536 
sbio
->
ÿÎback
 = 
gc_wr™e_ÿÎback
;

2537 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

2538 
sbio
->
logicbs
 = 1;

2539 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

2540 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
dev
->
pci_dev
, sbio->
vœt_addr
, dev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

2541 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
dev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

2542 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

2543 
kä“
;

2546 
»q
->
İcode
 = 
sh_cmd_wr™e
;

2547 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

2548 
»q
->
d©©y³
 = 
lba_ty³
[
dev
->
lba_fÜm©
];

2549 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

2550 
»q
->
Şd_pba
.
lun
 =„eq->
pba
.lun;

2551 
»q
->
Şd_pba
.
lun_pba
 =„eq->
pba
.lun_pba;

2553 ià(
	`uÆik–y
(
is_ns_d©a
)) {

2554 
	`shªnÚ_¥š_lock_bh
(&
ns
->
d©a_lock
);

2555 ià(
	`pba_is_šv®id
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
)) {

2556 
	`shªnÚ_¥š_uÆock_bh
(&
ns
->
d©a_lock
);

2557 
out
;

2559 ià(
	`‹¡_ªd_£t_gc_wr™e_¡©e
(
dev
, 
sb
, &
»q
->
Şd_pba
)) {

2560 
	`shªnÚ_¥š_uÆock_bh
(&
ns
->
d©a_lock
);

2561 
out
;

2563 ià(
dev
->
u£_du®_h—d
)

2564 
»q
->
h—d
 = 
COLD_HEAD
;

2566 
»q
->
h—d
 = 
HOT_HEAD
;

2567 
	`£t_pba_Ãxt_h—d
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
,„eq->
h—d
);

2568 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

2569 
	`shªnÚ_¥š_uÆock_bh
(&
ns
->
d©a_lock
);

2571 
	`Ímt_lock
(
dev
, 
sdisk
, 
»q
->
lba
);

2572 ià(
	`pba_is_šv®id
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
)) {

2573 
	`Ímt_uÆock
(
dev
, 
sdisk
, 
»q
->
lba
);

2574 
out
;

2576 
	`BUG_ON
(
	`»q_has_šv®id_lba
(
»q
));

2577 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

2578 ià((
Şd_pba
.
lun
 !ğ
»q
->Şd_pba.lunè|| (Şd_pba.
lun_pba
 !=„eq->old_pba.lun_pba)) {

2579 
	`shªnÚ_”r
("lba mismatch:†ba=0x%lx,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n\n",

2580 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

2581 
¶ªe
 = ((
»q
->
pba
.
lun_pba
/
dev
->
logicbs_š_·ge
)/dev->
·ges_š_eblock
è% dev->
¶ªes
;

2582 ià(!
	`is_”rÜ_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
))

2583 
	`sb_m¬k_”rÜ_lun
(
dev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
);

2584 
	`£t_sb_cİy_”r_¡©e
(
dev
, 
sb
);

2585 
	`Ímt_uÆock
(
dev
, 
sdisk
, 
»q
->
lba
);

2586 
out
;

2588 ià(
	`‹¡_ªd_£t_gc_wr™e_¡©e
(
dev
, 
sb
, &
»q
->
Şd_pba
)) {

2589 
	`Ímt_uÆock
(
dev
, 
sdisk
, 
»q
->
lba
);

2590 
out
;

2592 
	`gc_g‘_Ãxt_h—d
(
dev
, 
»q
);

2593 
	`£t_pba_Ãxt_h—d
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
,„eq->
h—d
);

2594 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

2595 
	`Ímt_uÆock
(
dev
, 
sdisk
, 
»q
->
lba
);

2597 #ifdeà
CONFIG_SHANNON_STATISTICS


2598 
	`shªnÚ_©omic_šc
(&
dev
->
äom_gc
);

2600 ià((
»q
->
h—d
 & 
HEAD_INDEX_MASK
è=ğ
HOT_INDEX
)

2601 
fl_h—d
 |ğ1 << 
HOT_INDEX
;

2603 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


2604 
	`BUG_ON
(!
dev
->
u£_du®_h—d
);

2606 
fl_h—d
 |ğ1 << 
COLD_INDEX
;

2608 
	`add_»q_to_gc_wr™e_queue_
(
dev
, 
»q
);

2609 
	`mod_fl_chunk_tim”
(
dev
, 
fl_h—d
);

2611 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
wÜk
);

2613 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

2615 
out
:

2616 
	`shªnÚ_dma_unm­_sšgË
(
dev
->
pci_dev
, 
sbio
->
dma_add»ss
, dev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

2617 
kä“
:

2618 
	`ä“_»q
(
»q
);

2619 
	`ä“_logicb_buf
(
dev
, 
sbio
->
vœt_addr
);

2620 ià(
sbio
->
g
 =ğ
WL_TAG
) {

2621 
	`shªnÚ_©omic_dec
(&
dev
->
š_wl_logicbs
);

2622 
dev
->
tÙ®_wl_logicbs
++;

2623 } ià(
	`shªnÚ_‹¡_b™
(
GC_SB_SHIFT
, &
sb
->
»şaim_kšd
)) {

2624 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_logicbs
);

2625 
dev
->
tÙ®_gc_logicbs
++;

2627 
	`shªnÚ_©omic_dec
(&
dev
->
š_gc_logicbs
);

2628 
dev
->
tÙ®_”r_»cov”_logicbs
++;

2630 
	`ä“_sbio
(
sbio
);

2632 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

2634 
	}
}

2636 
	$gc_»ad_logicb
(
shªnÚ_sb
 *
sb
, 
lun
, 
logicb_t
 
lun_pba
, 
is_wl
)

2638 
shªnÚ_bio
 *
sbio
;

2639 
shªnÚ_»que¡
 *
»q
;

2640 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

2642 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

2643 ià(
is_wl
)

2644 
	`£t_sbio_debug_g
(
sbio
, 
WL_TAG
);

2646 
	`£t_sbio_debug_g
(
sbio
, 
GC_TAG
);

2647 
sbio
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

2648 
sbio
->
logicbs
 = 1;

2649 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

2650 
sbio
->
ÿÎback
 = 
gc_»ad_ÿÎback
;

2651 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

2652 
sbio
->
d©a
 = 
sb
;

2653 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

2654 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

2655 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

2656 
	`BUG
();

2657 
out
;

2660 ià(
is_wl
)

2661 
	`shªnÚ_©omic_šc
(&
sdev
->
š_wl_logicbs
);

2663 
	`shªnÚ_©omic_šc
(&
sdev
->
š_gc_logicbs
);

2664 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

2665 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 0);

2666 
»q
->
İcode
 = 
sh_cmd_»ad
;

2667 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

2668 
»q
->
lba
 = 
LONG_INVALID_LBA
;

2669 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

2670 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

2671 
»q
->
£q_num
 = 
sb
->seq_num;

2672 
»q
->
pba
.
lun
 =†un;

2673 
»q
->
pba
.
lun_pba
 =†un_pba;

2674 
»q
->
sbio
 = sbio;

2675 
»q
->
£nd”
 = 
FROM_GC
;

2676 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

2677 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

2678 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

2679 
	`£t_gc_»ad_¡©e
(
sdev
, 
lun
, 
lun_pba
);

2682 
out
:

2683  -
EIO
;

2684 
	}
}

2686 
	$cİy_·ge_¡re
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
cur_¡©e
)

2688 
i
, 
lun
, 
lun_off£t
, 
¶ªe
, 
group
, 
logicbs_š_eblk
, 
avaabË_logicbs
 = 0;

2689 
logicb_t
 
lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + 
·ge_¡re
 * sdev->
logicbs_š_·ge
;

2691 
	`debugs1
("sb=%d, s‹=%d,…age_¡re=%d.\n", 
sb
->
sb_šdex
, sb->
¡©e
, 
·ge_¡re
);

2692 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

2693 
group
 = 0; grou°< 
sdev
->
·r™y_groups
; group++) {

2694 ià(
sb
->
sub_group
[
group
].
phy_šdex
 < 0)

2696 
lun_off£t
 = 
sb
->
sub_group
[
group
].
·r™y_lun_off£t
;

2701 ià(
sb
->
¡©e
 !ğ
cur_¡©e
)

2702  
avaabË_logicbs
;

2705 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

2706 
lun
 = 
sb
->
sub_group
[
group
].
¡¬t_lun
 + 
lun_off£t
;

2707 } 
	`is_bad_lun
(
sb
, 
lun
));

2709 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

2710 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

2711 ià(!
	`pba_is_šv®id
(
sdev
, 
lun
, 
lun_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
)) {

2712 
	`gc_»ad_logicb
(
sb
, 
lun
, 
lun_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
, 0);

2713 
avaabË_logicbs
++;

2717 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, sdev->
logicbs_š_chunk
);

2718 } 
lun_off£t
 !ğ
sb
->
sub_group
[
group
].
Ï¡_d©a_lun_off£t
);

2724  
avaabË_logicbs
;

2725 
	}
}

2727 
	$cİy_chunk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
lun
)

2729 
i
, 
¶ªe
, 
logicbs_š_eblk
, 
avaabË_logicbs
 = 0;

2730 
logicb_t
 
lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + 
·ge_¡re
 * sdev->
logicbs_š_·ge
;

2732 
	`debugs1
("sb=%d, s‹=%d,…age_¡re=%d†un=%d.\n", 
sb
->
sb_šdex
, sb->
¡©e
, 
·ge_¡re
, 
lun
);

2733 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

2735 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

2736 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

2737 ià(!
	`pba_is_šv®id
(
sdev
, 
lun
, 
lun_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
)) {

2738 
	`gc_»ad_logicb
(
sb
, 
lun
, 
lun_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
, 0);

2739 
avaabË_logicbs
++;

2743 ià(
avaabË_logicbs
) {

2744 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, sdev->
logicbs_š_chunk
);

2747  
avaabË_logicbs
;

2748 
	}
}

2750 
	$upd©e_gc_çùÜ
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

2752 
v®id_logicbs
, 
tÙ®_logicbs
;

2753 
çùÜ
, 
Ï¡_gc_çùÜ
;

2754 
ava_tÙ®_logicbs
;

2756 
v®id_logicbs
 = 
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
);

2757 
tÙ®_logicbs
 = 
sdev
->
logicbs_š_siblšg_eblock
 * 
sb
->
mš_d©a_luns
 * sdev->
max_avaabË_groups
;

2758 
ava_tÙ®_logicbs
 = 
sdev
->
logicbs_š_siblšg_eblock
 * (
sb
->
mš_d©a_luns
 - 1è* sdev->
max_avaabË_groups
;

2759 
çùÜ
 = (
v®id_logicbs
 * 
GC_DIVIDE_FACTOR
)/(
tÙ®_logicbs
 - valid_logicbs);

2760 ià(
v®id_logicbs
 >ğ
ava_tÙ®_logicbs
)

2761 
sdev
->
”r_gc_çùÜ
 = 4000000;

2763 
sdev
->
”r_gc_çùÜ
 = (
v®id_logicbs
 * 
GC_DIVIDE_FACTOR
)/(
ava_tÙ®_logicbs
 - valid_logicbs);

2764 
	`debugs1
("valid_logicbs=%d,‡vail_total_logicbs=%d,otal_logicbs=%d, factor=%d,ƒrr_gc_factor=%d.\n",

2765 
v®id_logicbs
, 
ava_tÙ®_logicbs
, 
tÙ®_logicbs
, 
çùÜ
, 
sdev
->
”r_gc_çùÜ
);

2766 
Ï¡_gc_çùÜ
 = 
sdev
->
gc_çùÜ
;

2767 
sdev
->
gc_çùÜ
 = (
çùÜ
 + (
GC_THROTTLE_FACTOR
 - 1è* 
Ï¡_gc_çùÜ
 + GC_THROTTLE_FACTOR/2) / GC_THROTTLE_FACTOR;

2768 
	}
}

2770 
shªnÚ_sb
 *
	$g‘_wa™_wl_sb
(
shªnÚ_dev
 *
sdev
)

2772 
shªnÚ_sb
 *
sb
;

2774 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_wl_li¡
))

2775  
NULL
;

2777 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_wl_lock
);

2778 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_wl_li¡
)) {

2779 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_wl_lock
);

2780  
NULL
;

2782 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
wa™_wl_li¡
, 
shªnÚ_sb
, 
li¡
);

2783 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_wl_lock
);

2786 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

2787 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_wl_lock
);

2788 ià(
sb
->
¡©e
 !ğ
WAIT_WL_BLOCK
) {

2789 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_wl_lock
);

2790 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2791  
NULL
;

2793 
sdev
->
wa™_wl_blkút
--;

2794 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

2795 
sb
->
¡©e
 = 
IN_WL_BLOCK
;

2796 
	`shªnÚ_©omic_šc
(&
sdev
->
š_wl_blkút
);

2797 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_wl_lock
);

2798 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2799  
sb
;

2800 
	}
}

2802 
shªnÚ_sb
 *
	$g‘_wa™_cİy_sb
(
shªnÚ_dev
 *
sdev
)

2804 
shªnÚ_sb
 *
sb
;

2806 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_cİy
))

2807  
NULL
;

2809 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_cİy_lock
);

2810 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_cİy
)) {

2811 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_cİy_lock
);

2812  
NULL
;

2814 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
wa™_cİy
, 
shªnÚ_sb
, 
li¡
);

2815 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_cİy_lock
);

2818 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

2819 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_cİy_lock
);

2820 ià(
sb
->
¡©e
 !ğ
WAIT_COPY_BLOCK
) {

2821 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_cİy_lock
);

2822 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2823  
NULL
;

2825 
sdev
->
wa™_cİy_blkút
--;

2826 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

2827 
sb
->
¡©e
 = 
IN_GC_BLOCK
;

2828 
	`shªnÚ_©omic_šc
(&
sdev
->
š_gc_blkút
);

2829 
	`add_to_gc_¡©e_li¡
(
sdev
, 
sb
);

2830 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_cİy_lock
);

2831 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

2832  
sb
;

2833 
	}
}

2835 
šlše
 
	$ÿlc_lun_loÿtiÚ
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

2837 
lun_off£t
 = 
sb
->
sub_group
[0].
·r™y_lun_off£t
;

2838 
lun_off£t
 =†un_off£ˆ% 
sdev
->
max_luns_š_group
;

2839 
sdev
->
this_lun
 = 
sb
->
sub_group
[0].
¡¬t_lun
 + 
lun_off£t
;

2840 
sdev
->
this_·ge_¡re
++;

2841 
	}
}

2843 
	$g‘_gc_»ad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
cur_¡©e
)

2845 
group
, 
group_num
, 
lun_off£t
;

2846 
lun
 = -1;

2848 
group_num
 = 
sdev
->
this_lun
 / sdev->
max_luns_š_group
;

2849 
lun_off£t
 = 
sdev
->
this_lun
 - 
sb
->
sub_group
[
group_num
].
¡¬t_lun
;

2851 
group
 = 
group_num
; grou°< 
sdev
->
·r™y_groups
; group++) {

2855 ià(
sb
->
¡©e
 !ğ
cur_¡©e
)

2856  
lun
;

2858 ià(
group
 !ğ
group_num
)

2859 
lun_off£t
 = 
sb
->
sub_group
[
group
].
·r™y_lun_off£t
;

2861 ià(
sb
->
sub_group
[
group
].
phy_šdex
 < 0 || 
lun_off£t
 =ğsb->sub_group[group].
Ï¡_d©a_lun_off£t
) {

2862 ià(
group
 =ğ
sdev
->
·r™y_groups
 - 1)

2863 
	`ÿlc_lun_loÿtiÚ
(
sdev
, 
sb
);

2868 ià(
sb
->
¡©e
 !ğ
cur_¡©e
)

2870 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

2871 
lun
 = 
sb
->
sub_group
[
group
].
¡¬t_lun
 + 
lun_off£t
;

2872 } 
	`is_bad_lun
(
sb
, 
lun
));

2873 
sdev
->
this_lun
 = 
lun
;

2877  
lun
;

2878 
	}
}

2880 
	$subm™_gc_»ad
(
shªnÚ_dev
 *
sdev
, 
couÁ
)

2882 
shªnÚ_sb
 *
sb
;

2883 
·ge_¡re
;

2884 
subm™_»qs
 = 0;

2885 
lun_off£t
;

2886 
lun
;

2888 
subm™_»qs
 < 
couÁ
) {

2889 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
this_sb_lock
);

2890 ià((
sdev
->
this_sb
 =ğ
NULL
è|| (sdev->this_sb->
¡©e
 !ğ
IN_GC_BLOCK
è|| (sdev->
this_·ge_¡re
 >ğsdev->
·ges_š_eblock
)) {

2891 
sdev
->
this_sb
 = 
	`g‘_wa™_cİy_sb
(sdev);

2892 ià(
sdev
->
this_sb
 =ğ
NULL
) {

2893 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
this_sb_lock
);

2894 ià(
	`lik–y
(
sdev
->
gc_th»ad
))

2895 
	`shªnÚ_wake_up_´oûss
(
sdev
->
gc_th»ad
);

2896  
subm™_»qs
;

2898 
sdev
->
this_·ge_¡re
 = 0;

2899 
lun_off£t
 = 
sdev
->
this_sb
->
sub_group
[0].
·r™y_lun_off£t
;

2900 
lun_off£t
 =†un_off£ˆ% 
sdev
->
max_luns_š_group
;

2901 
sdev
->
this_lun
 = sdev->
this_sb
->
sub_group
[0].
¡¬t_lun
 + 
lun_off£t
;

2902 
	`upd©e_gc_çùÜ
(
sdev
, sdev->
this_sb
);

2903 
sdev
->
gc_sbs
++;

2905 
sb
 = 
sdev
->
this_sb
;

2906 
·ge_¡re
 = 
sdev
->
this_·ge_¡re
;

2907 
lun
 = 
	`g‘_gc_»ad_lun
(
sdev
, 
sb
, 
IN_GC_BLOCK
);

2908 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
this_sb_lock
);

2909 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
è> 
MAX_IN_GC_LOGICBS
)

2910 
	`shªnÚ_m¦“p
(1);

2912 ià(
lun
 >= 0) {

2913 
subm™_»qs
 +ğ
	`cİy_chunk
(
sdev
, 
sb
, 
·ge_¡re
, 
lun
);

2916  
subm™_»qs
;

2917 
	}
}

2919 
	#shªnÚ_max
(
a
, 
b
è(×è> (bè? (aè: (b))

	)

2920 
	$g‘_gc_»ad_»qs
(
shªnÚ_dev
 *
sdev
, 
logicbs
)

2922 
couÁ
, 
»qs
, 
gc_çùÜ
, 
d–
;

2924 ià(
sdev
->
gc_»ad_»qs
 >ğ
GC_DIVIDE_FACTOR
) {

2925 
	`shªnÚ_”r
("gc_»ad_»qs=%d.\n", 
sdev
->
gc_»ad_»qs
);

2926 
	`BUG
();

2928 
	`BUG_ON
(
sdev
->
gc_çùÜ
 == 0);

2930 
d–
 = 
GC_THROTTLE_BAR
 - 
sdev
->
ä“_blkút
;

2932 ià((
sdev
->
ä“_blkút
 < 
GC_THROTTLE_BAR
è&& sdev->
”r_blkút
)

2933 
gc_çùÜ
 = 
sdev
->
”r_gc_çùÜ
 + (
d–
 * sdev->”r_gc_çùÜè/ 
GC_THROTTLE_FACTOR
;

2935 
gc_çùÜ
 = 
sdev
->gc_çùÜ + (
d–
 * sdev->gc_çùÜè/ 
GC_THROTTLE_FACTOR
;

2936 ià(
gc_çùÜ
 <= 0)

2937 
gc_çùÜ
 = 1;

2939 
»qs
 = 
sdev
->
gc_»ad_»qs
 + 
logicbs
;

2941 ià(
gc_çùÜ
 <ğ
GC_DIVIDE_FACTOR
) {

2942 ià(
»qs
 >ğ
gc_çùÜ
) {

2943 
couÁ
 = (
gc_çùÜ
 > 
sdev
->
gc_»ad_»qs
) ? (gc_factor - sdev->gc_read_reqs) : 0;

2944 
sdev
->
gc_»ad_»qs
 = 
»qs
;

2945 ià(
»qs
 >ğ
GC_DIVIDE_FACTOR
) {

2946 
couÁ
 +ğ(
»qs
/
GC_DIVIDE_FACTOR
 - 1è* 
gc_çùÜ
;

2947 
couÁ
 +ğ(
»qs
%
GC_DIVIDE_FACTOR
 > 
gc_çùÜ
) ? gc_factor : (reqs%GC_DIVIDE_FACTOR);

2948 
sdev
->
gc_»ad_»qs
 = 
»qs
 % 
GC_DIVIDE_FACTOR
;

2951 
couÁ
 = 
logicbs
;

2952 
sdev
->
gc_»ad_»qs
 = 
»qs
;

2956 ià(
»qs
 >ğ
GC_DIVIDE_FACTOR
) {

2957 
couÁ
 = 
logicbs
 + (
»qs
/
GC_DIVIDE_FACTOR
è* (
gc_çùÜ
 - GC_DIVIDE_FACTOR);

2958 
sdev
->
gc_»ad_»qs
 = 
»qs
 % 
GC_DIVIDE_FACTOR
;

2960 
couÁ
 = 
logicbs
;

2961 
sdev
->
gc_»ad_»qs
 = 
»qs
;

2965 ià(
	`uÆik–y
(
sdev
->
acûss_mode
 =ğ
SHN_MODE_REDUCED_WRITE
))

2966 
couÁ
 = 
	`shªnÚ_max
(
logicbs
, count * 4);

2968 ià(
couÁ
 < 0) {

2969 
	`shªnÚ_”r
("logicbs=%d,„eqs=%d, gc_çùÜ=%d, couÁ=%d.\n", 
logicbs
, 
»qs
, 
sdev
->
gc_çùÜ
, 
couÁ
);

2970 
	`BUG
();

2973  
couÁ
;

2974 
	}
}

2976 
	$b®ªû_gc
(
shªnÚ_dev
 *
sdev
, 
logicbs
)

2978 
couÁ
, 
subm™_»qs
;

2979 
numb”
;

2981 ià(
sdev
->
gc_th»ad_¡©e
 =ğ
NO_RECLAIM
)

2984 ià(
	`uÆik–y
(
sdev
->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)))

2987 
	`shªnÚ_©omic_add
(
logicbs
, &
sdev
->
wr™e_»qs_fÜ_gc
);

2988 
numb”
 = 
logicbs
;

2989 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs_fÜ_gc
è< 
numb”
)

2992 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
gc_»qs_lock
);

2993 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs_fÜ_gc
è>ğ
numb”
)

2994 
	`shªnÚ_©omic_sub
(
numb”
, &
sdev
->
wr™e_»qs_fÜ_gc
);

2996 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_»qs_lock
);

3000 
couÁ
 = 
	`g‘_gc_»ad_»qs
(
sdev
, 
numb”
);

3001 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_»qs_lock
);

3003 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
exŒa_»qs_lock
);

3004 ià(
couÁ
 <ğ
sdev
->
exŒa_»qs
) {

3005 
sdev
->
exŒa_»qs
 -ğ
couÁ
;

3006 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
exŒa_»qs_lock
);

3009 
couÁ
 -ğ
sdev
->
exŒa_»qs
;

3010 
sdev
->
exŒa_»qs
 = 0;

3012 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
exŒa_»qs_lock
);

3014 
	`shªnÚ_©omic_šc
(&
sdev
->
gc_th»ads
);

3015 
subm™_»qs
 = 
	`subm™_gc_»ad
(
sdev
, 
couÁ
);

3016 
	`shªnÚ_©omic_dec
(&
sdev
->
gc_th»ads
);

3017 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
exŒa_»qs_lock
);

3018 
sdev
->
exŒa_»qs
 +ğ
subm™_»qs
 - 
couÁ
;

3019 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
exŒa_»qs_lock
);

3020 
	}
}

3022 
shªnÚ_sb
 *
	$gc_fšd_viùim
(
shªnÚ_dev
 *
dev
)

3024 
shªnÚ_sb
 *
hÙ_sb
 = 
NULL
, *
cŞd_sb
 = NULL, *
p
;

3025 
šv®id_logicbs
;

3026 
hÙ_max_šv®id
, 
cŞd_max_šv®id
;

3027 
çùÜ
;

3029 
hÙ_max_šv®id
 = 0;

3030 
	`shªnÚ_¥š_lock_bh
(&
dev
->
u£d_blocks_lock
[
HOT_INDEX
]);

3031 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
dev
->
u£d_blocks
[
HOT_INDEX
], 
li¡
) {

3032 ià(
	`shªnÚ_©omic_»ad
(&
p
->
š_wr™e_logicbs
) != 0)

3034 
šv®id_logicbs
 = 
p
->
mš_d©a_luns
 * 
dev
->
max_avaabË_groups
 * dev->
logicbs_š_siblšg_eblock
 - 
	`shªnÚ_©omic_»ad
(&p->
v®id_·ges
);

3035 ià(
šv®id_logicbs
 > 
hÙ_max_šv®id
) {

3036 
hÙ_max_šv®id
 = 
šv®id_logicbs
;

3037 
hÙ_sb
 = 
p
;

3040 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
u£d_blocks_lock
[
HOT_INDEX
]);

3042 
cŞd_max_šv®id
 = 0;

3043 ià(
dev
->
u£_du®_h—d
) {

3044 
	`shªnÚ_¥š_lock_bh
(&
dev
->
u£d_blocks_lock
[
COLD_INDEX
]);

3045 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
dev
->
u£d_blocks
[
COLD_INDEX
], 
li¡
) {

3046 ià(
	`shªnÚ_©omic_»ad
(&
p
->
š_wr™e_logicbs
) != 0)

3048 
šv®id_logicbs
 = 
p
->
mš_d©a_luns
 * 
dev
->
max_avaabË_groups
 * dev->
logicbs_š_siblšg_eblock
 - 
	`shªnÚ_©omic_»ad
(&p->
v®id_·ges
);

3049 ià(
šv®id_logicbs
 > 
cŞd_max_šv®id
) {

3050 
cŞd_max_šv®id
 = 
šv®id_logicbs
;

3051 
cŞd_sb
 = 
p
;

3054 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
u£d_blocks_lock
[
COLD_INDEX
]);

3058 ià(
	`uÆik–y
(
dev
->
”r_blkút
)) {

3059 
	`shªnÚ_¥š_lock_bh
(&
dev
->
”r_blks_lock
);

3060 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
dev
->
”r_blks
, 
li¡
) {

3061 
šv®id_logicbs
 = 
p
->
mš_d©a_luns
 * 
dev
->
max_avaabË_groups
 * dev->
logicbs_š_siblšg_eblock
 - 
	`shªnÚ_©omic_»ad
(&p->
v®id_·ges
);

3062 ià(
šv®id_logicbs
 > 
cŞd_max_šv®id
) {

3063 
cŞd_max_šv®id
 = 
šv®id_logicbs
;

3064 
cŞd_sb
 = 
p
;

3067 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
”r_blks_lock
);

3070 #ifdeà
CONFIG_SHANNON_GC_GREEDY


3071 
çùÜ
 = 100;

3073 
çùÜ
 = 
dev
->
hÙ_block_»şaim_´iÜ™y
;

3075 
hÙ_max_šv®id
 = (hÙ_max_šv®id * 
çùÜ
) / 100;

3076 
p
 = (
hÙ_max_šv®id
 > 
cŞd_max_šv®id
è? 
hÙ_sb
 : 
cŞd_sb
;

3079 ià(
p
 =ğ
NULL
)

3080  
NULL
;

3082 ià(
	`shªnÚ_©omic_»ad
(&
p
->
š_wr™e_logicbs
) != 0) {

3083 ià(!
dev
->
¥oŞ
 || 
	`shªnÚ_´štk_¿‹lim™
())

3084 
	`shªnÚ_log
("%s: sb_index=%d, state=%d, in_write_logicbs=%d.\n",

3085 
dev
->
sdisk
.
disk_Çme
, 
p
->
sb_šdex
,…->
¡©e
, 
	`shªnÚ_©omic_»ad
(&p->
š_wr™e_logicbs
));

3086  
NULL
;

3089 ià((
p
->
mš_d©a_luns
 * 
dev
->
max_avaabË_groups
 * dev->
logicbs_š_siblšg_eblock
 -…->
logicbs_š_•og
 - 
	`shªnÚ_©omic_»ad
(&p->
v®id_·ges
)) < 3) {

3090 
	`shªnÚ_log
("%s:oØmªy v®id_·ges, s‘ sbØNULL.\n", 
dev
->
sdisk
.
disk_Çme
);

3091 
	`shªnÚ_m¦“p
(500);

3092  
NULL
;

3094 
	`shªnÚ_£t_b™
(
GC_SB_SHIFT
, &
p
->
»şaim_kšd
);

3095  
p
;

3096 
	}
}

3098 
	$gc_th»ad_â
(*
d©a
)

3100 
shªnÚ_sb
 *
sb
;

3101 
shªnÚ_dev
 *
dev
 = 
d©a
;

3102 
shªnÚ_¥šlock_t
 *
lock
;

3103 
»£rved_blocks
;

3106 ià(
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

3111 #iâdeà
CONFIG_SHANNON_PLVERIFY


3112 ià(!
	`shªnÚ_li¡_em±y
(&
dev
->
wa™_”a£d
)) {

3114 ià(!
	`shªnÚ_li¡_em±y
(&
dev
->
wa™_”a£d
è&& !(dev->
¶ù¾
 & 0x02)) {

3117 
»£rved_blocks
 = 0;

3118 
	`shªnÚ_©omic_»ad
(&
dev
->
š_”a£_blkút
è&& !
	`shªnÚ_kth»ad_should_¡İ
())

3119 
	`shªnÚ_m¦“p
(3);

3120 ià(
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

3122 
	`shªnÚ_¥š_lock_bh
(&
dev
->
wa™_”a£d_lock
);

3123 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
dev
->
wa™_”a£d
));

3124 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
dev
->
wa™_”a£d
, 
shªnÚ_sb
, 
li¡
);

3126 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

3127 (
sb
->
Ãxt_sb
 =ğ
dev
->
wr_sb
[
HOT_INDEX
]è|| ((dev->
u£_du®_h—d
è&& (sb->Ãxt_sb =ğdev->wr_sb[
COLD_INDEX
])) || \

3128 (
	`shªnÚ_©omic_»ad
(&
sb
->
š_³riod_»ad
è!ğ0è|| (shªnÚ_©omic_»ad(&sb->
unfšished_wr™es
) != 0)) {

3129 #iâdeà
SHANNON_RELEASE


3130 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
unfšished_wr™es
))

3131 
	`shªnÚ_šfo
("%s(): sb->sb_index=%d, sb->state=%d, sb->unfinished_writes=%d.\n",

3132 
__func__
, 
sb
->
sb_šdex
, sb->
¡©e
, 
	`shªnÚ_©omic_»ad
(&sb->
unfšished_wr™es
));

3134 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
dev
->
wa™_”a£d
);

3135 
»£rved_blocks
++;

3136 
	`BUG_ON
(
»£rved_blocks
 > 
dev
->
wa™_”a£d_blkút
);

3137 ià(
»£rved_blocks
 =ğ
dev
->
wa™_”a£d_blkút
) {

3138 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_”a£d_lock
);

3139 
»şaim
;

3141 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
dev
->
wa™_”a£d
, 
shªnÚ_sb
, 
li¡
);

3142 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

3144 
dev
->
wa™_”a£d_blkút
--;

3145 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_”a£d_lock
);

3146 
	`”a£_su³r_block
(
dev
, 
sb
, 1, 1);

3147 ià(
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

3149 } !
	`shªnÚ_li¡_em±y
(&
dev
->
wa™_”a£d
));

3152 
»şaim
:

3153 ià((
dev
->
wa™_cİy_blkút
 >ğ
WAIT_COPY_BLKCNT_MAX
è&& !
	`shªnÚ_kth»ad_should_¡İ
()) {

3154 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_INTERRUPTIBLE
);

3155 ià((
dev
->
wa™_cİy_blkút
 >ğ
WAIT_COPY_BLKCNT_MAX
è&& !
	`shªnÚ_kth»ad_should_¡İ
())

3156 
	`shªnÚ_scheduË
();

3158 
	`__shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_RUNNING
);

3163 ià(
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

3166 ià(
dev
->
gc_th»ad_¡©e
 =ğ
IN_GC_STATE
) {

3167 ià(
dev
->
ä“_blkút
 > 
GC_THRESHOLD_N1H
) {

3168 
dev
->
gc_th»ad_¡©e
 = 
NO_RECLAIM
;

3171 
sb
 = 
	`gc_fšd_viùim
(
dev
);

3172 ià(
sb
 =ğ
NULL
) {

3173 ià(!
dev
->
¥oŞ
 || 
	`shªnÚ_´štk_¿‹lim™
())

3174 
	`shªnÚ_log
("%s: gc_fšd_viùim(è»tuº NULL.\n", 
dev
->
sdisk
.
disk_Çme
);

3175 
	`shªnÚ_cÚd_»sched
();

3181 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_INTERRUPTIBLE
);

3182 if(
dev
->
ä“_blkút
 > 
GC_THRESHOLD_N1L
 && !
	`shªnÚ_kth»ad_should_¡İ
()) {

3183 ià(
dev
->
wa™_”a£d_blkút
)

3184 
	`debugs3
("wa™_”a£d_blkút=%d.\n", 
dev
->
wa™_”a£d_blkút
);

3185 
	`shªnÚ_scheduË
();

3187 ià(
dev
->
gc_th»ad_¡©e
 !ğ
IN_GC_STATE
) {

3188 
	`shªnÚ_w¬n
("ImpossibË! f»e_blkút=%d.\n", 
dev
->
ä“_blkút
);

3189 
	`shªnÚ_¥š_lock_bh
(&
dev
->
gc_¡©e_lock
);

3190 
dev
->
gc_th»ad_¡©e
 = 
IN_GC_STATE
;

3191 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
gc_¡©e_lock
);

3193 
	`__shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_RUNNING
);

3198 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

3199 
sb
->
¡©e
) {

3200 
HOT_BLOCK_LIST
:

3201 
lock
 = &
dev
->
u£d_blocks_lock
[
HOT_INDEX
];

3203 
COLD_BLOCK_LIST
:

3204 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


3205 
	`BUG_ON
(!
dev
->
u£_du®_h—d
);

3207 
lock
 = &
dev
->
u£d_blocks_lock
[
COLD_INDEX
];

3209 
ERROR_BLOCK
:

3210 
lock
 = &
dev
->
”r_blks_lock
;

3213 
Ãxt
;

3215 
	`shªnÚ_¥š_lock_bh
(
lock
);

3216 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

3217 ià(
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
)

3218 
dev
->
u£d_blkút
[
HOT_INDEX
]--;

3219 ià(
sb
->
¡©e
 =ğ
COLD_BLOCK_LIST
)

3220 
dev
->
u£d_blkút
[
COLD_INDEX
]--;

3221 ià(
sb
->
¡©e
 =ğ
ERROR_BLOCK
) {

3222 
dev
->
”r_blkút
--;

3223 
	`check_”r_blkút_dec
(
dev
);

3225 
	`shªnÚ_¥š_uÆock_bh
(
lock
);

3226 ià(
	`lik–y
(
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) > 0)) {

3227 
sb
->
¡©e
 = 
WAIT_COPY_BLOCK
;

3228 
	`shªnÚ_¥š_lock_bh
(&
dev
->
wa™_cİy_lock
);

3229 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
dev
->
wa™_cİy
);

3230 
dev
->
wa™_cİy_blkút
++;

3231 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_cİy_lock
);

3233 
	`debugs2
("wgÙ‡ z”Øv®id_·ge su³¸block from hÙ/cŞd_blocks_li¡! s‹=%d.\n", 
sb
->
¡©e
);

3234 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

3235 
	`shªnÚ_¥š_lock_bh
(&
dev
->
wa™_”a£d_lock
);

3236 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
dev
->
wa™_”a£d
);

3237 
dev
->
wa™_”a£d_blkút
++;

3238 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_”a£d_lock
);

3240 
Ãxt
:

3241 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

3242 ià(
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

3244 
	`shªnÚ_cÚd_»sched
();

3247 
	}
}

3249 
	$d©a_»‹ÁiÚ_tim”_sk
(
shªnÚ_tim”_li¡
 *
tim”
)

3251 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
d©a_»‹ÁiÚ_tim”
);

3253 ià(
sdev
->
sdisk
.
ex™
)

3256 
	`shªnÚ_£t_b™
(
DATA_RETENTION
, &
sdev
->
wl_»asÚ
);

3257 
	`shªnÚ_queue_wÜk
(
sdev
->
wl_wq
, &sdev->
wl_fšd_sb_wÜk
);

3258 
	`shªnÚ_mod_tim”
(&
sdev
->
d©a_»‹ÁiÚ_tim”
, 
	`g‘_jiff›s
(è+ sdev->
d©a_»‹ÁiÚ_š‹rv®
 * 
	`g‘_HZ
());

3259 
	}
}

3261 
	$wl_tim”_sk
(
shªnÚ_tim”_li¡
 *
tim”
)

3263 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
wl_tim”
);

3265 ià(
sdev
->
sdisk
.
ex™
)

3268 
	`shªnÚ_£t_b™
(
READ_DISTURB
, &
sdev
->
wl_»asÚ
);

3269 
	`shªnÚ_£t_b™
(
ERASE_BALANCE
, &
sdev
->
wl_»asÚ
);

3270 
	`shªnÚ_£t_b™
(
ECC_FAILURE
, &
sdev
->
wl_»asÚ
);

3271 
	`shªnÚ_queue_wÜk
(
sdev
->
wl_wq
, &sdev->
wl_fšd_sb_wÜk
);

3272 
	}
}

3274 
	#MAX_IRQ_DELAY
 (0xFF)

	)

3275 
	#MIN_IRQ_DELAY
 (0x01)

	)

3276 
	$upd©e_œq_d–ay_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

3278 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

3280 ià(
sdev
->
sdisk
.
ex™
)

3283 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
œq_d–ay
.
upd©e_œq_d–ay_wÜk
);

3284 
	}
}

3286 
	$upd©e_œq_d–ay_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3288 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
œq_d–ay
.
upd©e_œq_d–ay_wÜk
);

3289 sigÃd 
cur_d–ay
;

3290 
u32
 
misc_»g
;

3291 
u64
 
cu¼’t_wr™e_ios
;

3292 
u64
 
cu¼’t_wr™e_m£cs
;

3293 
u64
 
cu¼’t_»ad_ios
;

3294 
u64
 
cu¼’t_»ad_m£cs
;

3295 
u32
 
ho¡_wr™e_Ï‹ncy
 = 0;

3296 
u32
 
ho¡_»ad_Ï‹ncy
 = 0;

3297 
œq_d–ay_çùÜ
 = 
sdev
->
œq_d–ay
.
çùÜ
;

3298 
max_œq_d–ay
 = 
sdev
->
œq_d–ay
.max_irq_delay;

3299 
mš_œq_d–ay
 = 
sdev
->
œq_d–ay
.min_irq_delay;

3300 
u32
 
wr™e_Ï‹ncy_divide
 = 
sdev
->
œq_d–ay
.write_latency_divide;

3301 
u32
 
»ad_Ï‹ncy_divide
 = 
sdev
->
œq_d–ay
.read_latency_divide;

3302 
u32
 
»ad_th»shŞd_çùÜ
 = 
sdev
->
œq_d–ay
.read_threshold_factor;

3303 
u32
 
wr™e_th»shŞd_çùÜ
 = 
sdev
->
œq_d–ay
.write_threshold_factor;

3304 
u64
 
ho¡_wr™e_ios_Ï¡
 = 
sdev
->
œq_d–ay
.host_write_ios_last;

3305 
u64
 
ho¡_wr™e_m£cs_Ï¡
 = 
sdev
->
œq_d–ay
.host_write_msecs_last;

3306 
u64
 
ho¡_»ad_ios_Ï¡
 = 
sdev
->
œq_d–ay
.host_read_ios_last;

3307 
u64
 
ho¡_»ad_m£cs_Ï¡
 = 
sdev
->
œq_d–ay
.host_read_msecs_last;

3309 ià(
sdev
->
sdisk
.
ex™
 || !
	`shªnÚ_dev_is_g5
(sdev))

3312 
misc_»g
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
glob®_b¬
->
misc
);

3313 
cur_d–ay
 = 
misc_»g
 & 0xFF;

3315 
cu¼’t_wr™e_ios
 = 
	`shªnÚ_have_wr™‹n_ios
(
sdev
);

3316 
cu¼’t_wr™e_m£cs
 = 
	`shªnÚ_have_wr™‹n_m£cs
(
sdev
);

3317 
cu¼’t_»ad_ios
 = 
	`shªnÚ_have_»ad_ios
(
sdev
);

3318 
cu¼’t_»ad_m£cs
 = 
	`shªnÚ_have_»ad_m£cs
(
sdev
);

3319 ià((
cu¼’t_wr™e_ios
 > 
ho¡_wr™e_ios_Ï¡
) &&

3320 ((
cu¼’t_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
è> (
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_š‹rv®
 * 
wr™e_th»shŞd_çùÜ
)))

3321 
ho¡_wr™e_Ï‹ncy
 = (
cu¼’t_wr™e_m£cs
 > 
ho¡_wr™e_m£cs_Ï¡
) ?

3322 ((
cu¼’t_wr™e_m£cs
 - 
ho¡_wr™e_m£cs_Ï¡
è* 1000 / (
cu¼’t_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
)) : 0;

3323 ià((
cu¼’t_»ad_ios
 > 
ho¡_»ad_ios_Ï¡
) &&

3324 ((
cu¼’t_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
è> (
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_š‹rv®
 * 
»ad_th»shŞd_çùÜ
)))

3325 
ho¡_»ad_Ï‹ncy
 = (
cu¼’t_»ad_m£cs
 > 
ho¡_»ad_m£cs_Ï¡
) ?

3326 ((
cu¼’t_»ad_m£cs
 - 
ho¡_»ad_m£cs_Ï¡
è* 1000 / (
cu¼’t_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
)) : 0;

3328 ià(
ho¡_wr™e_Ï‹ncy
) {

3329 ià((
cur_d–ay
 + 
œq_d–ay_çùÜ
è<ğ(
ho¡_wr™e_Ï‹ncy
 / 
wr™e_Ï‹ncy_divide
))

3330 
cur_d–ay
 +ğ
œq_d–ay_çùÜ
;

3331 ià((
cur_d–ay
 - 
œq_d–ay_çùÜ
è> (
ho¡_wr™e_Ï‹ncy
 / 
wr™e_Ï‹ncy_divide
))

3332 
cur_d–ay
 -ğ
œq_d–ay_çùÜ
;

3333 } ià(
ho¡_»ad_Ï‹ncy
) {

3334 ià((
cur_d–ay
 + 
œq_d–ay_çùÜ
è<ğ(
ho¡_»ad_Ï‹ncy
 / 
»ad_Ï‹ncy_divide
))

3335 
cur_d–ay
 +ğ
œq_d–ay_çùÜ
;

3336 ià((
cur_d–ay
 - 
œq_d–ay_çùÜ
è> (
ho¡_»ad_Ï‹ncy
 / 
»ad_Ï‹ncy_divide
))

3337 
cur_d–ay
 -ğ
œq_d–ay_çùÜ
;

3339 
cur_d–ay
 -ğ
œq_d–ay_çùÜ
;

3341 ià(!
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 || !
shªnÚ_dyÇmic_œq_d–ay
)

3344 ià(
cur_d–ay
 > 
max_œq_d–ay
)

3345 
cur_d–ay
 = (
max_œq_d–ay
 < 
MAX_IRQ_DELAY
 ? max_irq_delay : MAX_IRQ_DELAY);

3346 ià(
cur_d–ay
 < 
mš_œq_d–ay
)

3347 
cur_d–ay
 = (
mš_œq_d–ay
 < 
MIN_IRQ_DELAY
 ? MIN_IRQ_DELAY : min_irq_delay);

3348 ià(
cur_d–ay
 =ğ(
misc_»g
 & 0xFF))

3349 
Ãxt
;

3350 
misc_»g
 &= ~0xFF;

3351 
misc_»g
 |ğ
cur_d–ay
 & 0xFF;

3352 
	`wr™e_»g_§ã
(
sdev
, 
misc_»g
, &sdev->
glob®_b¬
->
misc
);

3353 
sdev
->
œq_d–ay
.œq_d–ay = 
cur_d–ay
;

3355 
Ãxt
:

3356 
sdev
->
œq_d–ay
.
ho¡_wr™e_ios_Ï¡
 = 
cu¼’t_wr™e_ios
;

3357 
sdev
->
œq_d–ay
.
ho¡_wr™e_m£cs_Ï¡
 = 
cu¼’t_wr™e_m£cs
;

3358 
sdev
->
œq_d–ay
.
ho¡_»ad_ios_Ï¡
 = 
cu¼’t_»ad_ios
;

3359 
sdev
->
œq_d–ay
.
ho¡_»ad_m£cs_Ï¡
 = 
cu¼’t_»ad_m£cs
;

3360 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

3361 
	}
}

3363 
	$check_”a£d_¡©e
(
shªnÚ_sb
 *
sb
)

3365 
d–
 = 
	`g‘_jiff›s
(è- 
sb
->
Ï¡_”a£d_time¡amp
;

3367 ià(
sb
->
sdev
->
š™_dÚe
 < 
STAGE_RECOVER_ACTIVE_DONE
)

3370 ià(!
sb
->
sdev
->
mbr
.
max_k“p_”a£d_hours
)

3373 ià(
sb
->
¡©e
 =ğ
IN_ERASING_BLOCK
)

3376 ià((
d–
 / 
	`g‘_HZ
(è/ 3600è>ğ
sb
->
sdev
->
mbr
.
max_k“p_”a£d_hours
) {

3377 
	`debugs1
("»-”a£ sb=%d, k“°šƒ¿£d fÜ %u secÚds.\n", 
sb
->
sb_šdex
, 
d–
 / 
	`g‘_HZ
());

3378 
sb
->
Şd_¡©e
 = sb->
¡©e
;

3379 
sb
->
¡©e
 = 
IN_ERASING_BLOCK
;

3380 
	`”a£_su³r_block
(
sb
->
sdev
, sb, 0, 0);

3382 
	}
}

3384 
shªnÚ_sb
 *
	$fšd_d©a_»‹ÁiÚ_sb
(
shªnÚ_dev
 *
sdev
)

3386 
shªnÚ_sb
 *
sb
, *
viùim
 = 
NULL
;

3387 
mš_£q_num
 = 
MAX_SEQ_NUM
;

3388 
h—d
;

3390 
h—d
 = 0; h—d < 
sdev
->
h—d_couÁ
; head++) {

3391 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3392 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
u£d_blocks
[
h—d
])) {

3393 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3396 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
u£d_blocks
[
h—d
], 
shªnÚ_sb
, 
li¡
);

3397 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
š_wr™e_logicbs
) != 0) {

3398 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3401 ià(
sb
->
£q_num
 < 
mš_£q_num
) {

3402 
mš_£q_num
 = 
sb
->
£q_num
;

3403 
viùim
 = 
sb
;

3405 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3407 ià(
viùim
) {

3408 ià(((
	`g‘_jiff›s
(è- 
viùim
->
Ï¡_”a£d_time¡amp
è/ 
	`g‘_HZ
()è< 
DO_DATA_RETENTION_THRESHOLD
)

3409 
viùim
 = 
NULL
;

3411  
viùim
;

3412 
	}
}

3414 
	#MAX_WL_FACTOR
 (8)

	)

3415 
shªnÚ_sb
 *
	$wl_fšd_viùim
(
shªnÚ_dev
 *
sdev
)

3417 
shªnÚ_sb
 *
sb
, *
viùim
 = 
NULL
;

3418 
mš_”a£_couÁ
 = 0xFFFF;

3419 
h—d
, 
sÿË
, 
av”age_”a£_couÁ
;

3420 
”a£_couÁ_sÿË
;

3421 
³_th»shŞd
;

3423 
”a£_couÁ_sÿË
 = 
sdev
->
wl_”a£_couÁ_d–
[0] - sdev->wl_erase_count_delta[1] + 1;

3424 ià(
”a£_couÁ_sÿË
 < 1)

3425  
NULL
;

3427 
h—d
 = 0; h—d < 
sdev
->
h—d_couÁ
; head++) {

3428 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3429 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sb
, &
sdev
->
u£d_blocks
[
h—d
], 
li¡
) {

3430 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
š_wr™e_logicbs
) != 0)

3432 ià((
sdev
->
£qu’û_numb”
 - 
sb
->
£q_num
è> (sdev->
sb_couÁ
 / 4)) {

3433 ià(
sb
->
”a£_couÁ”
 < 
mš_”a£_couÁ
) {

3434 
mš_”a£_couÁ
 = 
sb
->
”a£_couÁ”
;

3435 
viùim
 = 
sb
;

3439 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3441 ià(
viùim
 =ğ
NULL
)

3442  
NULL
;

3443 
av”age_”a£_couÁ
 = 
sdev
->
tÙ®_”a£_couÁ
/sdev->
sb_couÁ
;

3444 
sÿË
 = (
av”age_”a£_couÁ
 * 
”a£_couÁ_sÿË
)/
sdev
->
wl_max_”a£_couÁ
;

3445 ià(
sÿË
 > (
”a£_couÁ_sÿË
 - 1))

3446 
sÿË
 = 
”a£_couÁ_sÿË
 - 1;

3447 
³_th»shŞd
 = 
sdev
->
wl_”a£_couÁ_d–
[0] - 
sÿË
;

3448 ià((
sdev
->
max_”a£_couÁ
 - 
mš_”a£_couÁ
è> 
³_th»shŞd
) {

3449 
d–
, 
çùÜ
;

3454 
d–
 = 
³_th»shŞd
/10;

3455 ià(
d–
 == 0)

3456 
d–
 = 1;

3457 
çùÜ
 = (
sdev
->
max_”a£_couÁ
 - 
mš_”a£_couÁ
 - 
³_th»shŞd
)/
d–
;

3458 ià(
çùÜ
 > 
MAX_WL_FACTOR
)

3459 
çùÜ
 = 
MAX_WL_FACTOR
;

3460 
sdev
->
cu¼’t_max_š_wl_logicbs
 = sdev->
max_š_wl_logicbs
 * (1UL << 
çùÜ
);

3461 ià(
wl_debug
)

3462 
	`debugs0
("sb=%d, max_erase_count=%d, min_erase_count=%d, factor=%d.\n",

3463 
viùim
->
sb_šdex
, 
sdev
->
max_”a£_couÁ
, 
mš_”a£_couÁ
, 
çùÜ
);

3464  
viùim
;

3466  
NULL
;

3467 
	}
}

3469 
shªnÚ_sb
 *
	$»ad_di¡urb_fšd_viùim
(
shªnÚ_dev
 *
sdev
)

3471 
shªnÚ_sb
 *
sb
, *
viùim
 = 
NULL
;

3472 
u32
 
max_»ad_couÁ
 = 0;

3473 
h—d
;

3475 
h—d
 = 0; h—d < 
sdev
->
h—d_couÁ
; head++) {

3476 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3477 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sb
, &
sdev
->
u£d_blocks
[
h—d
], 
li¡
) {

3478 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
š_wr™e_logicbs
) != 0)

3480 ià(
sb
->
max_»ad_couÁ
 > 
sdev
->
»ad_di¡urb_th»shŞd
) {

3481 ià(
sb
->
max_»ad_couÁ
 > max_read_count) {

3482 
max_»ad_couÁ
 = 
sb
->max_read_count;

3483 
viùim
 = 
sb
;

3487 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3489  
viùim
;

3490 
	}
}

3492 
shªnÚ_sb
 *
	$fšd_ecc_çu»_sb
(
shªnÚ_dev
 *
sdev
)

3494 
shªnÚ_sb
 *
sb
, *
viùim
 = 
NULL
;

3495 
h—d
, 
i
, 
tÙ®_ecc_çu»_times
, 
tÙ®_»ad_couÁ
;

3496 
ecc_çu»_¿‹
, 
max_ecc_çu»_¿‹
 = 0;

3497 
viùim_ecc_çu»_times
 = 0, 
viùim_»ad_couÁ
 = 0;

3499 
h—d
 = 0; h—d < 
sdev
->
h—d_couÁ
; head++) {

3500 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3501 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sb
, &
sdev
->
u£d_blocks
[
h—d
], 
li¡
) {

3502 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
š_wr™e_logicbs
) != 0)

3504 
tÙ®_ecc_çu»_times
 = 0;

3505 
tÙ®_»ad_couÁ
 = 0;

3506 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

3507 
tÙ®_ecc_çu»_times
 +ğ
sb
->
ecc_çu»_times
[
i
];

3508 
tÙ®_»ad_couÁ
 +ğ
sb
->
»ad_couÁ
[
i
];

3510 ià(
tÙ®_»ad_couÁ
 > 1000)

3511 
ecc_çu»_¿‹
 = (
tÙ®_ecc_çu»_times
 * 100)/
tÙ®_»ad_couÁ
;

3513 
ecc_çu»_¿‹
 = 0;

3514 ià((
ecc_çu»_¿‹
 >ğ
sdev
->
ecc_çu»_¿‹_th»shŞd
) && \

3515 (
ecc_çu»_¿‹
 > 
max_ecc_çu»_¿‹
)) {

3516 
max_ecc_çu»_¿‹
 = 
ecc_çu»_¿‹
;

3517 
viùim_ecc_çu»_times
 = 
tÙ®_ecc_çu»_times
;

3518 
viùim_»ad_couÁ
 = 
tÙ®_»ad_couÁ
;

3519 
viùim
 = 
sb
;

3522 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d
]);

3525 ià(
wl_debug
) {

3526 ià(
viùim
)

3527 
	`debugs0
("sb=%d, state=%d, seq_num=%d,otal_ecc_failure_times=%d,otal_read_count=%d.\n",

3528 
viùim
->
sb_šdex
, viùim->
¡©e
, viùim->
£q_num
,

3529 
viùim_ecc_çu»_times
, 
viùim_»ad_couÁ
);

3531 
	`debugs0
("find‚othing.\n");

3534  
viùim
;

3535 
	}
}

3537 
	$shªnÚ_wl_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3539 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
wl_fšd_sb_wÜk
);

3540 
shªnÚ_sb
 *
sb
 = 
NULL
;

3541 
shªnÚ_¥šlock_t
 *
lock
;

3542 
i
;

3544 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
 || sdev->
¡İ_®l
 || sdev->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)))

3547 
i
 = 0; i < 
TOTAL_REASON
; i++) {

3548 
sdev
->
Ãxt_wl_»asÚ
 = (sdev->Ãxt_wl_»asÚ + 1è% 
TOTAL_REASON
;

3549 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™
(
sdev
->
Ãxt_wl_»asÚ
, &sdev->
wl_»asÚ
)) {

3550 
sdev
->
Ãxt_wl_»asÚ
) {

3551 
DATA_RETENTION
:

3552 
sb
 = 
	`fšd_d©a_»‹ÁiÚ_sb
(
sdev
);

3553 ià(
sb
)

3554 
sdev
->
d©a_»‹ÁiÚ_sbs
++;

3555 ià(
wl_debug
) {

3556 ià(
sb
)

3557 
	`debugs0
("fšd d©¨»‹siÚ sb=%d.\n", 
sb
->
sb_šdex
);

3559 
	`debugs0
("find_data_retention_sb„eturn NULL.\n");

3562 
READ_DISTURB
:

3563 
sb
 = 
	`»ad_di¡urb_fšd_viùim
(
sdev
);

3564 ià(
sb
)

3565 
sdev
->
»ad_di¡urb_sbs
++;

3566 ià(
wl_debug
) {

3567 ià(
sb
)

3568 
	`debugs0
("find„ead_disturb sb=%d, max_read_count=%u.\n",

3569 
sb
->
sb_šdex
, sb->
max_»ad_couÁ
);

3571 
	`debugs0
("find„ead_disturb„eturn NULL.\n");

3574 
ERASE_BALANCE
:

3575 
sb
 = 
	`wl_fšd_viùim
(
sdev
);

3576 ià(
sb
)

3577 
sdev
->
”a£_b®ªû_sbs
++;

3578 ià(
wl_debug
) {

3579 ià(
sb
)

3580 
	`debugs0
("wl_fšd_viùim„‘uº sb=%d.\n", 
sb
->
sb_šdex
);

3582 
	`debugs0
("wl_find_victim„eturn NULL.\n");

3585 
ECC_FAILURE
:

3586 
sb
 = 
	`fšd_ecc_çu»_sb
(
sdev
);

3587 ià(
sb
)

3588 
sdev
->
ecc_çu»_sbs
++;

3589 ià(
wl_debug
) {

3590 ià(
sb
)

3591 
	`debugs0
("fšd_ecc_çu»_sb„‘uº sb=%d.\n", 
sb
->
sb_šdex
);

3593 
	`debugs0
("find_ecc_failure_sb„eturn NULL.\n");

3597 
	`shªnÚ_w¬n
("unknowÀ»asÚ=%d.\n", 
sdev
->
Ãxt_wl_»asÚ
);

3600 ià(
sb
)

3604 ià(
sb
) {

3605 
	`debugs1
("sb->šdex=%d, s‹=%d.\n", 
sb
->
sb_šdex
, sb->
¡©e
);

3606 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

3607 
sb
->
¡©e
) {

3608 
HOT_BLOCK_LIST
:

3609 
lock
 = &
sdev
->
u£d_blocks_lock
[
HOT_INDEX
];

3611 
COLD_BLOCK_LIST
:

3612 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


3613 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

3615 
lock
 = &
sdev
->
u£d_blocks_lock
[
COLD_INDEX
];

3617 
ERROR_BLOCK
:

3618 
lock
 = &
sdev
->
”r_blks_lock
;

3621 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

3622 
	`shªnÚ_w¬n
("unknowÀ¡©e: sb=%d, s‹=%d.\n", 
sb
->
sb_šdex
, sb->
¡©e
);

3625 
	`shªnÚ_¥š_lock_bh
(
lock
);

3626 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

3627 ià(
sb
->
¡©e
 =ğ
HOT_BLOCK_LIST
)

3628 
sdev
->
u£d_blkút
[
HOT_INDEX
]--;

3629 ià(
sb
->
¡©e
 =ğ
COLD_BLOCK_LIST
)

3630 
sdev
->
u£d_blkút
[
COLD_INDEX
]--;

3631 ià(
sb
->
¡©e
 =ğ
ERROR_BLOCK
) {

3632 
sdev
->
”r_blkút
--;

3633 
	`check_”r_blkút_dec
(
sdev
);

3635 
	`shªnÚ_¥š_uÆock_bh
(
lock
);

3637 ià(
	`lik–y
(
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) > 0)) {

3638 
	`shªnÚ_£t_b™
(
WL_SB_SHIFT
, &
sb
->
»şaim_kšd
);

3639 
sb
->
¡©e
 = 
WAIT_WL_BLOCK
;

3640 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_wl_lock
);

3641 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
wa™_wl_li¡
);

3642 
sdev
->
wa™_wl_blkút
++;

3643 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_wl_lock
);

3645 
	`debugs2
("wgÙ‡ z”Øv®id_·ge su³¸block from hÙ/cŞd_blocks_li¡! s‹=%d.\n", 
sb
->
¡©e
);

3646 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

3647 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_”a£d_lock
);

3648 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
wa™_”a£d
);

3649 
sdev
->
wa™_”a£d_blkút
++;

3650 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_”a£d_lock
);

3652 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

3655 ià(
sdev
->
wl_this_sb
 =ğ
NULL
) {

3656 
sb
 = 
	`g‘_wa™_wl_sb
(
sdev
);

3657 ià(
sb
) {

3658 
sdev
->
wl_this_sb
 = 
sb
;

3659 ià(
wl_debug
)

3660 
	`debugs0
("g‘ wa™_wÈsb=%d.\n", 
sb
->
sb_šdex
);

3662 ià(
wl_debug
)

3663 
	`debugs0
("get_wait_wl_sb„eturn NULL.\n");

3667 ià(
sdev
->
wl_this_sb
) {

3668 
	`shªnÚ_queue_wÜk
(
sdev
->
wl_wq
, &sdev->
wl_»ad_wÜk
);

3670 
	`shªnÚ_mod_tim”
(&
sdev
->
wl_tim”
, 
	`g‘_jiff›s
(è+ sdev->
wl_tim”_š‹rv®
 * 
	`g‘_HZ
());

3671 
	}
}

3673 
	$shªnÚ_wl_»ad_chunk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
lun
, 
·ge_¡re
)

3675 
¶ªe
, 
i
;

3676 
u64
 
lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
 + 
·ge_¡re
 * sdev->
logicbs_š_·ge
;

3677 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

3678 
avaabË_logicbs
 = 0;

3680 
	`debugs1
("sb=%d,…age_¡re=%d,†un=%d.\n", 
sb
->
sb_šdex
, 
·ge_¡re
, 
lun
);

3681 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

3682 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

3683 ià(!
	`pba_is_šv®id
(
sdev
, 
lun
, 
lun_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
)) {

3684 
	`gc_»ad_logicb
(
sb
, 
lun
, 
lun_pba
 + 
i
 + 
¶ªe
 * 
logicbs_š_eblk
, 1);

3685 
avaabË_logicbs
++;

3689 ià(
avaabË_logicbs
) {

3690 
	`lun£t_pick_»que¡
(
sdev
->
lun
[lun]->
lun£t
, sdev->
logicbs_š_chunk
);

3692  
avaabË_logicbs
;

3693 
	}
}

3695 
	$shªnÚ_wl_»ad_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3697 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
wl_»ad_wÜk
);

3698 
shªnÚ_sb
 *
sb
 = 
sdev
->
wl_this_sb
;

3699 
·ge_¡re
, 
group
, 
lun
, 
lun_off£t
;

3700 
»ad_logicbs
;

3702 ià(
sb
 =ğ
NULL
)

3705 
·ge_¡re
 = 0;…age_¡r< 
sdev
->
·ges_š_eblock
;…age_stripe++) {

3706 
group
 = 0; grou°< 
sdev
->
·r™y_groups
; group++) {

3707 ià(
sb
->
sub_group
[
group
].
phy_šdex
 < 0)

3709 
lun_off£t
 = 
sb
->
sub_group
[
group
].
·r™y_lun_off£t
;

3711 ià(
sb
->
¡©e
 !ğ
IN_WL_BLOCK
)

3712 
out
;

3714 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

3715 
lun
 = 
sb
->
sub_group
[
group
].
¡¬t_lun
 + 
lun_off£t
;

3716 } 
	`is_bad_lun
(
sb
, 
lun
));

3717 
»ad_logicbs
 = 
	`shªnÚ_wl_»ad_chunk
(
sdev
, 
sb
, 
lun
, 
·ge_¡re
);

3718 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
 || sdev->
¡İ_®l
 || sdev->
¶ug_out
 || \

3719 (
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
))) {

3720 ià(
wl_debug
)

3721 
	`debugs0
("stop wear†eveling sb=%d becauseƒxit=%d or stop_all=%d or…lug_out=%d or state=%d.\n",

3722 
sb
->
sb_šdex
, 
sdev
->
sdisk
.
ex™
, sdev->
¡İ_®l
, sdev->
¶ug_out
, sdev->
¡©e
);

3725 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_wl_logicbs
è> sdev->
cu¼’t_max_š_wl_logicbs
)

3726 
	`shªnÚ_m¦“p
(1);

3727 } 
lun_off£t
 !ğ
sb
->
sub_group
[
group
].
Ï¡_d©a_lun_off£t
);

3730 
out
:

3731 ià(
wl_debug
)

3732 
	`debugs0
("fšish„eşaim wl_sb=%d.\n", 
sb
->
sb_šdex
);

3733 
sdev
->
wl_this_sb
 = 
NULL
;

3734 
sdev
->
wl_sbs
++;

3737 
	`shªnÚ_£t_b™
(
READ_DISTURB
, &
sdev
->
wl_»asÚ
);

3738 
	`shªnÚ_£t_b™
(
ERASE_BALANCE
, &
sdev
->
wl_»asÚ
);

3739 
	`shªnÚ_£t_b™
(
ECC_FAILURE
, &
sdev
->
wl_»asÚ
);

3740 
	`shªnÚ_queue_wÜk
(
sdev
->
wl_wq
, &sdev->
wl_fšd_sb_wÜk
);

3741 
	}
}

3743 
shªnÚ_sb
 *
	$”r_fšd_viùim
(
shªnÚ_dev
 *
sdev
)

3745 
shªnÚ_sb
 *
sb
 = 
NULL
, *
p
;

3746 
šv®id_logicbs
, 
max_šv®id_logicbs
 = -1;

3747 
»Œ›s
 = 0;

3749 
»Œy
:

3750 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
”r_blks_lock
);

3751 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
”r_blks
)) {

3752 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
”r_blks_lock
);

3753  
NULL
;

3756 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
sdev
->
”r_blks
, 
li¡
) {

3757 ià(
	`shªnÚ_©omic_»ad
(&
p
->
š_wr™e_logicbs
) != 0) {

3758 ià(!
sdev
->
¥oŞ
 || 
	`shªnÚ_´štk_¿‹lim™
())

3759 
	`shªnÚ_w¬n
("sb=%d, state=%d, in_write_logicbs=%d.\n",

3760 
p
->
sb_šdex
,…->
¡©e
, 
	`shªnÚ_©omic_»ad
(&p->
š_wr™e_logicbs
));

3763 
šv®id_logicbs
 = 
p
->
mš_d©a_luns
 * 
sdev
->
max_avaabË_groups
 * sdev->
logicbs_š_siblšg_eblock
 - 
	`shªnÚ_©omic_»ad
(&p->
v®id_·ges
);

3764 ià(
šv®id_logicbs
 > 
max_šv®id_logicbs
) {

3765 
max_šv®id_logicbs
 = 
šv®id_logicbs
;

3766 
sb
 = 
p
;

3769 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
”r_blks_lock
);

3771 ià(
sb
 =ğ
NULL
) {

3772 ià(!
sdev
->
¥oŞ
 || 
	`shªnÚ_´štk_¿‹lim™
())

3773 
	`shªnÚ_w¬n
("%s: sb i NULL,„‘r›s=%d!\n", 
sdev
->
sdisk
.
disk_Çme
, 
»Œ›s
);

3774 
	`shªnÚ_m¦“p
(20);

3775 
»Œ›s
++;

3776 ià(
»Œ›s
 < 300)

3777 
»Œy
;

3779  
NULL
;

3782 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

3783 ià(
sb
->
¡©e
 !ğ
ERROR_BLOCK
) {

3784 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

3785 
	`shªnÚ_log
("%s: sb=%d, s‹=%d,„‘r›s=%d!\n", 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, sb->
¡©e
, 
»Œ›s
);

3786 
	`shªnÚ_m¦“p
(20);

3787 
»Œ›s
++;

3788 ià(
»Œ›s
 < 300)

3789 
»Œy
;

3791  
NULL
;

3794 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
”r_blks_lock
);

3795 
sdev
->
”r_blkút
--;

3796 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

3797 
sb
->
¡©e
 = 
IN_RECOVER_BLOCK
;

3798 
	`check_”r_blkút_dec
(
sdev
);

3799 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
”r_blks_lock
);

3800 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

3802  
sb
;

3803 
	}
}

3805 
	#ERR_RECOVER_INTERVAL
 10

	)

3806 
	#ERR_RECOVER_FREQUENCY
 (1000/
ERR_RECOVER_INTERVAL
)

	)

3807 
	$»cov”_th»ad_â
(*
d©a
)

3809 
shªnÚ_dev
 *
sdev
 = 
d©a
;

3810 
subm™_»qs
;

3811 
Ëá
 = 0;

3812 
»cov”_couÁ
;

3813 
jiff›s_¡¬t
, 
jiff›s_d–
;

3814 
m£c_–­£d
;

3817 ià(
	`shªnÚ_kth»ad_should_¡İ
())

3820 ià(!(
sdev
->
”r_blkút
 || sdev->
this_”r_sb
è&& !
	`shªnÚ_kth»ad_should_¡İ
()) {

3821 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_INTERRUPTIBLE
);

3822 ià(!(
sdev
->
”r_blkút
 || sdev->
this_”r_sb
è&& !
	`shªnÚ_kth»ad_should_¡İ
())

3823 
	`shªnÚ_scheduË
();

3825 
	`__shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_RUNNING
);

3829 ià((
sdev
->
this_”r_sb
 =ğ
NULL
è|| (sdev->this_”r_sb->
¡©e
 !ğ
IN_RECOVER_BLOCK
)) {

3830 ià(
sdev
->
”r_blkút
 == 0) {

3831 
sdev
->
this_”r_sb
 = 
NULL
;

3832 
sdev
->
this_”r_sb_šdex
 = ~0;

3835 
sdev
->
this_”r_sb
 = 
	`”r_fšd_viùim
(sdev);

3836 ià(
sdev
->
this_”r_sb
 =ğ
NULL
) {

3837 ià(!
sdev
->
¥oŞ
 || 
	`shªnÚ_´štk_¿‹lim™
())

3838 
	`shªnÚ_w¬n
("ImpossibË!ƒ¼_blkút=%d.\n", 
sdev
->
”r_blkút
);

3839 
sdev
->
this_”r_sb_šdex
 = ~0;

3842 
sdev
->
this_”r_sb_šdex
 = sdev->
this_”r_sb
->
sb_šdex
;

3843 
sdev
->
this_”r_¡re
 = 0;

3846 
	`debugs1
("%s: in_gc_logicbs=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
	`shªnÚ_©omic_»ad
(&sdev->
š_gc_logicbs
));

3847 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
è> 
MAX_LOGICB_BUF_COUNT
/2) {

3848 
subm™_»qs
 = 0;

3849 
	`shªnÚ_m¦“p
(1);

3853 
»cov”_couÁ
 = (
sdev
->
»cov”_¿‹
 * 1024 / 4è/ 
ERR_RECOVER_FREQUENCY
;

3854 
Ëá
 +ğ
»cov”_couÁ
;

3855 
jiff›s_¡¬t
 = ()
	`g‘_jiff›s
();

3856 
Ëá
 > 0) {

3857 
subm™_»qs
 = 
	`cİy_·ge_¡re
(
sdev
, sdev->
this_”r_sb
, sdev->
this_”r_¡re
, 
IN_RECOVER_BLOCK
);

3858 
	`debugs2
("%s: subm™_»qs=%d,ime=%ld.\n", 
sdev
->
sdisk
.
disk_Çme
, 
subm™_»qs
, ()
	`g‘_jiff›s
(è- 
jiff›s_¡¬t
);

3859 
sdev
->
this_”r_¡re
++;

3860 
Ëá
 -ğ
subm™_»qs
;

3861 ià(
sdev
->
this_”r_¡re
 =ğsdev->
·ges_š_eblock
) {

3862 
sdev
->
”r_»cov”ed_sbs
++;

3863 
sdev
->
this_”r_sb
 = 
	`”r_fšd_viùim
(sdev);

3864 
sdev
->
this_”r_¡re
 = 0;

3866 ià(
sdev
->
this_”r_sb
) {

3867 
sdev
->
this_”r_sb_šdex
 = sdev->
this_”r_sb
->
sb_šdex
;

3868 
	`debugs1
("this_”r_sb=%d,this_”r_¡re=%d.\n", 
sdev
->
this_”r_sb
->
sb_šdex
, sdev->
this_”r_¡re
);

3870 
sdev
->
this_”r_sb_šdex
 = ~0;

3871 
	`debugs1
("this_err_sb is NULL.\n");

3876 ià(
Ëá
 <= 0) {

3877 
jiff›s_d–
 = ()
	`g‘_jiff›s
(è- 
jiff›s_¡¬t
;

3878 
m£c_–­£d
 = 
	`shªnÚ_jiff›s_to_m£cs
(
jiff›s_d–
);

3879 
	`debugs2
("m£c_–­£d=%ld,†eá=%d\n", 
m£c_–­£d
, 
Ëá
);

3880 ià(
m£c_–­£d
 < 
ERR_RECOVER_INTERVAL
)

3881 
	`shªnÚ_m¦“p
(
ERR_RECOVER_INTERVAL
 - 
m£c_–­£d
);

3883 
	`shªnÚ_cÚd_»sched
();

3885 
	`debug_´št
("exit.\n");

3887 
	}
}

3889 
	#DYNAMIC_BBT_SIZE
 16384

	)

3890 
»ad_dyÇmic_bbt
(
shªnÚ_lun
 *
lun
, 
eblk
);

3891 
	$»ad_dyÇmic_bbt_ÿÎback
(
shªnÚ_bio
 *
sbio
)

3893 
shªnÚ_lun
 *
lun
 = (shªnÚ_luÀ*)
sbio
->
d©a
;

3894 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

3895 
shªnÚ_»que¡
 *
»q
, *
tmp
;

3896 
eblk
;

3897 
u16
 *
±r
;

3899 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, 
DYNAMIC_BBT_SIZE
, 
SHANNON_DMA_FROMDEVICE
);

3900 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

3901 
eblk
 = 
»q
->
pba
.
lun_pba
/(
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

3903 ià(
sbio
->
¡©us
 & 
HAVE_ERROR_SECTOR
) {

3904 ià(
eblk
 =ğ(
sdev
->
mbr_eblocks
 - 1)) {

3905 
	`shªnÚ_w¬n
("”rÜ…age:†un=%d,†un_pba=%d,ƒcc=0x%x.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
);

3906 
	`£t_Ãw_bad_lun
(
sdev
, 
lun
);

3907 
	`£t_»cov”_¡©e_w¬nšg
(
sdev
);

3908 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

3909 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

3912 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

3913 
sbio
->
¡©us
 = 0;

3914 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

3915 
»q
->
_ecc
 = 0;

3916 
»q
->
»»ad
 = 0;

3917 
»q
->
İcode
 = 
sh_cmd_»ad
;

3918 
»q
->
lba
 = 
LONG_INVALID_LBA
;

3919 
»q
->
pba
.
lun_pba
 +ğ
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

3920 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

3922 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

3925 } ià(
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
) {

3926 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

3927 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

3928 } ià(
»q
->
_m‘ad©a
 =ğ
POOL_INFO_METADATA
) {

3929 
shªnÚ_poŞ
 *
¥oŞ
 = 
sdev
->spool;

3930 
	`»cov”_poŞ_šfo
(
¥oŞ
, 
sbio
->
vœt_addr
);

3931 
	`shªnÚ_©omic_šc
(&
lun
->
Ãxt_em±y_·ge
);

3932 ià(
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
è=ğ
sdev
->
·ges_š_eblock
) {

3933 
	`shªnÚ_”r
("Error: Never get here!\n");

3935 
»t
 = 
	`»ad_dyÇmic_bbt
(
lun
, 
eblk
);

3936 ià(
»t
) {

3937 
	`£t_»cov”_¡©e_d—d
(
sdev
);

3938 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

3939 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

3943 
±r
 = 
sbio
->
vœt_addr
;

3944 ià(
	`bbt_usšg_b™m­
(
lun
->
bbt
, 
sdev
)) {

3945 
	`shªnÚ_£t_b™_Ë
(
	`shªnÚ_mem_»adw
(
±r
è+ 64, 
lun
->
bbt
);

3946 
lun
->
bad_blk_couÁ
++;

3948 
lun
->
bbt
[lun->
bad_blk_couÁ
++] = 
	`shªnÚ_mem_»adw
(
±r
);

3949 
lun
->
bbt
[lun->
bad_blk_couÁ
] = 0xFFFF;

3951 
	`shªnÚ_©omic_šc
(&
sdev
->
dyÇmic_bad_blkút
);

3952 
	`shªnÚ_©omic_šc
(&
lun
->
dyÇmic_bad_blkút
);

3953 
	`shªnÚ_©omic_šc
(&
lun
->
Ãxt_em±y_·ge
);

3954 ià(
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
è=ğ
sdev
->
·ges_š_eblock
) {

3955 
	`£t_fuÎ_dyÇmic_bad_blocks
(
sdev
, 
lun
);

3956 
	`£t_»cov”_¡©e_w¬nšg
(
sdev
);

3957 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

3958 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

3959 } ià((
	`shªnÚ_mem_»adw
(
±r
) == 0xFFFF) || \

3960 (
lun
->
bad_blk_couÁ
 > 
sdev
->
eblocks_š_lun
) || \

3961 ((!
	`bbt_usšg_b™m­
(
lun
->
bbt
, 
sdev
)è&& (lun->
bad_blk_couÁ
 > 
LUN_BBT_SIZE
 / 2 - 1)) || \

3962 
	`»ad_dyÇmic_bbt
(
lun
, 
eblk
) != 0) {

3963 
	`£t_»cov”_¡©e_d—d
(
sdev
);

3964 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

3965 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

3969 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

3970 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

3971 
	`ä“_»q
(
»q
);

3973 
	`shªnÚ_kä“
(
sbio
->
vœt_addr
);

3974 
	`ä“_sbio
(
sbio
);

3975 
	}
}

3977 
	$»ad_dyÇmic_bbt
(
shªnÚ_lun
 *
lun
, 
eblk
)

3979 
shªnÚ_bio
 *
sbio
;

3980 
shªnÚ_»que¡
 *
»q
;

3981 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

3982 
i
, 
logicbs
;

3984 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

3985 
	`£t_sbio_debug_g
(
sbio
, 
READ_BBT_TAG
);

3986 
sbio
->
vœt_addr
 = 
	`shªnÚ_km®loc
(
DYNAMIC_BBT_SIZE
, 
GFP_SHANNON
);

3987 ià(
sbio
->
vœt_addr
 =ğ
NULL
) {

3988 
	`ä“_sbio
(
sbio
);

3991 
sbio
->
logicbs
 = 
DYNAMIC_BBT_SIZE
/
sdev
->
logicb_size
;

3992 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

3993 
sbio
->
ÿÎback
 = 
»ad_dyÇmic_bbt_ÿÎback
;

3994 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

3995 
sbio
->
d©a
 = 
lun
;

3996 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, 
DYNAMIC_BBT_SIZE
, 
SHANNON_DMA_FROMDEVICE
);

3997 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

3998 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

3999 
	`BUG
();

4002 
logicbs
 = 
sbio
->logicbs;

4003 
i
 = 0; i < 
logicbs
; i++) {

4004 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

4005 
	`BUG_ON
(
»q
 =ğ
NULL
);

4006 
	`£t_»q_debug_g
(
»q
, 
READ_BBT_TAG
, 0);

4007 
»q
->
İcode
 = 
sh_cmd_»ad
;

4008 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

4009 
»q
->
lba
 = 
LONG_INVALID_LBA
;

4010 
»q
->
vœt_addr
 = 
sbio
->vœt_add¸+ 
sdev
->
logicb_size
 * 
i
;

4011 
»q
->
dma_add»ss
 = 
sbio
->dma_add»s + 
sdev
->
logicb_size
 * 
i
;

4012 
»q
->
pba
.
lun
 =†un->
lun_num
;

4013 
»q
->
pba
.
lun_pba
 = 
eblk
 * 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
 + 
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
è* sdev->logicbs_š_·g+ 
i
;

4014 
»q
->
sbio
 = sbio;

4015 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

4016 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4017 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

4020 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4022 
	}
}

4024 
	$»ad_¡©ic_bbt_ÿÎback
(
shªnÚ_bio
 *
sbio
)

4026 
shªnÚ_lun
 *
lun
 = (shªnÚ_luÀ*)
sbio
->
d©a
;

4027 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

4028 
shªnÚ_»que¡
 *
»q
;

4029 
eblk
;

4030 
u16
 *
±r
;

4032 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

4033 ià(
sbio
->
¡©us
) {

4035 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

4036 
eblk
 = 
»q
->
pba
.
lun_pba
/(
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

4037 ià(
eblk
 =ğ(
sdev
->
mbr_eblocks
 - 1)) {

4038 
	`shªnÚ_w¬n
("bÏnk o¸”rÜ…age:†un=%d,†un_pba=%d,ƒcc=0x%x.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
);

4040 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
Çnd_·ge_size
, 
SHANNON_DMA_FROMDEVICE
);

4042 !
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
)) {

4043 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

4044 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

4045 
	`ä“_»q
(
»q
);

4048 
	`ä“_sbio
(
sbio
);

4050 
	`£t_Ãw_bad_lun
(
sdev
, 
lun
);

4051 
	`£t_»cov”_¡©e_w¬nšg
(
sdev
);

4053 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

4054 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

4056 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

4057 
sbio
->
¡©us
 = 0;

4059 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4060 
»q
->
_ecc
 = 0;

4061 
»q
->
»»ad
 = 0;

4062 
»q
->
İcode
 = 
sh_cmd_»ad
;

4063 
»q
->
lba
 = 
LONG_INVALID_LBA
;

4064 
»q
->
pba
.
lun_pba
 +ğ
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

4065 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

4067 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4070 
eblk
 = 0;

4071 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, 
LUN_BBT_SIZE
, 
SHANNON_DMA_FROMDEVICE
);

4072 !
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
)) {

4073 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

4074 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

4075 
eblk
 = 
»q
->
pba
.
lun_pba
/(
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

4076 
	`ä“_»q
(
»q
);

4079 
	`ä“_sbio
(
sbio
);

4081 
lun
->
bad_blk_couÁ
 = 0;

4082 
±r
 = 
lun
->
bbt
;

4083 ià(
	`shªnÚ_mem_»adq
(
±r
è=ğ
BBT_BITMAP_WATERMARK
) {

4084 
lun
->
bad_blk_couÁ
 = 
	`__shªnÚ_b™m­_weight
((
u64
 *)
±r
 + 1, 
LUN_BBT_SIZE
 * 8 - 64);

4086 
	`shªnÚ_mem_»adw
(
±r
) != 0xFFFF) {

4087 
±r
++;

4088 
lun
->
bad_blk_couÁ
 = 
±r
 -†un->
bbt
;

4089 ià(
lun
->
bad_blk_couÁ
 >ğ
LUN_BBT_SIZE
/(
u16
)) {

4090 
	`shªnÚ_”r
("too many bad blocks,†un=%d, bad_blk_count=%d, sb_count=%d\n",

4091 
lun
->
lun_num
,†un->
bad_blk_couÁ
, 
sdev
->
sb_couÁ
);

4092 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4097 
	`shªnÚ_©omic_add
(
lun
->
bad_blk_couÁ
, &
sdev
->
¡©ic_bad_blkút
);

4098 
	`shªnÚ_©omic_£t
(&
lun
->
Ãxt_em±y_·ge
, 2);

4099 ià((
lun
->
bad_blk_couÁ
 > 
sdev
->
eblocks_š_lun
) || \

4100 
	`»ad_dyÇmic_bbt
(
lun
, 
eblk
) != 0) {

4102 
	`£t_Ãw_bad_lun
(
sdev
, 
lun
);

4103 
	`£t_»cov”_¡©e_w¬nšg
(
sdev
);

4105 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

4106 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

4109 
	}
}

4111 
	$»ad_¡©ic_bbt
(
shªnÚ_lun
 *
lun
)

4113 
shªnÚ_bio
 *
sbio
;

4114 
shªnÚ_»que¡
 *
»q
;

4115 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

4116 
i
, 
logicbs
;

4118 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

4119 
	`£t_sbio_debug_g
(
sbio
, 
READ_BBT_TAG
);

4120 
sbio
->
vœt_addr
 = 
lun
->
bbt
;

4121 
sbio
->
logicbs
 = 
LUN_BBT_SIZE
/
sdev
->
logicb_size
;

4122 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

4123 
sbio
->
ÿÎback
 = 
»ad_¡©ic_bbt_ÿÎback
;

4124 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

4125 
sbio
->
d©a
 = 
lun
;

4126 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, 
LUN_BBT_SIZE
, 
SHANNON_DMA_FROMDEVICE
);

4127 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

4128 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

4129 
	`BUG
();

4132 
logicbs
 = 
sbio
->logicbs;

4133 
i
 = 0; i < 
logicbs
; i++) {

4134 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

4135 
	`£t_»q_debug_g
(
»q
, 
READ_BBT_TAG
, 
i
);

4136 
»q
->
İcode
 = 
sh_cmd_»ad
;

4137 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

4138 
»q
->
lba
 = 
LONG_INVALID_LBA
;

4139 
»q
->
vœt_addr
 = 
sbio
->vœt_add¸+ 
sdev
->
logicb_size
 * 
i
;

4140 
»q
->
dma_add»ss
 = 
sbio
->dma_add»s + 
sdev
->
logicb_size
 * 
i
;

4141 
»q
->
pba
.
lun
 =†un->
lun_num
;

4142 
»q
->
pba
.
lun_pba
 = 
sdev
->
logicbs_š_·ge
 + 
i
;

4143 
»q
->
sbio
 = sbio;

4144 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

4145 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4146 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

4149 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4151 
	}
}

4153 
	$ª®yze_bad_phy_lun_m­
(
shªnÚ_dev
 *
sdev
)

4155 
l
, 
b
;

4157 
sdev
->
max_avaabË_luns
 = sdev->
lun_couÁ
;

4158 
l
 = 0;† < 
sdev
->
lun_couÁ
;†++) {

4159 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
l
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
)) {

4160 
	`debugs1
("lun=%d,…hy_lun_num=%d i physiÿÎy bad.\n", 
l
, 
sdev
->
lun
[l]->
phy_lun_num
);

4161 
	`shªnÚ_£t_b™
(
l
, (*)
sdev
->
¡©ic_bad_lun_m­
);

4162 
sdev
->
max_avaabË_luns
--;

4163 
b
 = 0; b < 
sdev
->
sb_couÁ
; b++)

4164 
	`m¬k_bad_block_dev
(
sdev
, 
l
, 
b
);

4167 
	}
}

4169 
	$is_®lz”o
(*
addr
, 
size
)

4171 *
p
 = 
addr
 + 
size
;

4174 ià(*--
p
)

4176 } 
p
 !ğ
addr
);

4178 
	}
}

4180 
	$»ad_·r™y_group_to_check_bad_block_ÿÎback
(
shªnÚ_bio
 *
sbio
)

4182 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

4183 
group_šdex
 = ()
sbio
->
d©a2
;

4184 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

4185 
shªnÚ_»que¡
 *
»q
, *
tmp
;

4186 
bad_lun
 = 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] - 1;

4187 
logicb64_t
 
lba
 = 0;

4188 *
vœt_addr
;

4189 
¶ªe
, 
bÏnk_logicbs
 = 0;

4191 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4192 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

4193 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
) {

4194 
	`debugs1
("sb=%d,†un=%d,†un_pba=%d,ƒcc=0x%x.\n",

4195 
sb
->
sb_šdex
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
);

4196 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0, 
sdev
->
logicb_size
);

4197 
»q
->
lba
 = 0;

4199 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
)

4200 
bÏnk_logicbs
++;

4203 ià(
sbio
->
¡©us
 & 
HAVE_ERROR_SECTOR
) {

4204 
	`shªnÚ_”r
("D©¨”rÜ iÀsu³rblock %d.\n", 
sb
->
sb_šdex
);

4205 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

4206 } ià((
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
è&& (
bÏnk_logicbs
 =ğsbio->
logicbs
)) {

4207 
	`shªnÚ_šfo
("%s(): s‘ badblock: bad_lun=%d, sb=%d.\n", 
__func__
, 
bad_lun
, 
sb
->
sb_šdex
);

4208 
	`sb_m¬k_bad_lun
(
sb
, 
bad_lun
);

4209 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++)

4210 
	`add_bad_eblk_to_lun_bbt
(
sdev
->
lun
[
bad_lun
], 
sb
->
sb_šdex
 * sdev->
¶ªes
 + 
¶ªe
);

4212 ià(
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
) {

4214 
	`shªnÚ_šfo
("%s(): sb=%d,†ogicbs=%d, bÏnk_logicbs=%d.\n", 
__func__
, 
sb
->
sb_šdex
, 
sbio
->
logicbs
, 
bÏnk_logicbs
);

4217 
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_NOWAIT
);

4218 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4219 
lba
 =†b¨^ 
»q
->lba;

4220 
	`__shªnÚ_b™m­_xÜ
(
vœt_addr
, vœt_addr, 
»q
->vœt_addr, 
sdev
->
logicb_size
 * 8);

4223 ià((
lba
 =ğ0è&& 
	`is_®lz”o
(
vœt_addr
, 
sdev
->
logicb_size
)) {

4224 
	`shªnÚ_šfo
("%s(): s‘ badblock: bad_lun=%d, sb=%d.\n", 
__func__
, 
bad_lun
, 
sb
->
sb_šdex
);

4225 
	`sb_m¬k_bad_lun
(
sb
, 
bad_lun
);

4226 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++)

4227 
	`add_bad_eblk_to_lun_bbt
(
sdev
->
lun
[
bad_lun
], 
sb
->
sb_šdex
 * sdev->
¶ªes
 + 
¶ªe
);

4229 
	`shªnÚ_šfo
("%s():†ba=%ld,†un=%d, sb=%d i good.\n", 
__func__
, 
lba
, 
bad_lun
, 
sb
->
sb_šdex
);

4231 
	`ä“_logicb_buf
(
sdev
, 
vœt_addr
);

4234 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4235 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

4236 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

4237 
	`ä“_»q
(
»q
);

4239 
	`ä“_sbio
(
sbio
);

4241 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

4242 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

4243 
	}
}

4245 
	$»ad_·r™y_group_to_check_bad_block
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
group_šdex
)

4247 
shªnÚ_bio
 *
sbio
;

4248 
shªnÚ_»que¡
 *
»q
;

4249 
lun_off£t
, 
lun
, 
logicbs
;

4250 
sub_group
 *
group
 = &
sb
->sub_group[
group_šdex
];

4251 
bad_lun
 = 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] - 1;

4253 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

4254 
	`£t_sbio_debug_g
(
sbio
, 
RECOVER_BBT_TAG
);

4255 
sbio
->
ÿÎback
 = 
»ad_·r™y_group_to_check_bad_block_ÿÎback
;

4256 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

4257 
sbio
->
d©a
 = 
sb
;

4258 
sbio
->
d©a2
 = (*)
group_šdex
;

4260 
sbio
->
logicbs
 = 
	`shªnÚ_©omic_»ad
(&
group
->
avaabË_luns
) - 1;

4261 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

4263 
logicbs
 = 0;

4264 
lun_off£t
 = 0;†un_off£ˆ< 
sdev
->
max_luns_š_group
;†un_offset++) {

4265 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

4266 ià((
lun
 =ğ
bad_lun
è|| 
	`is_bad_lun
(
sb
,†un))

4268 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

4269 
	`£t_»q_debug_g
(
»q
, 
RECOVER_BBT_TAG
, 
lun
);

4270 
»q
->
İcode
 = 
sh_cmd_»ad
;

4271 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

4272 
»q
->
lba
 = 
LONG_INVALID_LBA
;

4273 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

4274 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

4275 
»q
->
pba
.
lun
 =†un;

4276 
»q
->
pba
.
lun_pba
 = 
sdev
->
logicbs_š_siblšg_eblock
 * 
sb
->
sb_šdex
;

4277 
»q
->
sbio
 = sbio;

4278 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

4279 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4280 
logicbs
++;

4281 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

4283 
	`BUG_ON
(
logicbs
 !ğ(
	`shªnÚ_©omic_»ad
(&
group
->
avaabË_luns
) - 1));

4285 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4288 
	}
}

4290 
	$»cov”_bad_lun_bbt
(
shªnÚ_dev
 *
sdev
, 
group_šdex
)

4292 
i
;

4293 
shªnÚ_sb
 *
sb
;

4294 
sub_group
 *
group
;

4295 
bad_lun
 = 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
group_šdex
] - 1;

4297 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

4298 
sb
 = 
sdev
->
sbs
 + 
i
;

4299 
group
 = &
sb
->
sub_group
[
group_šdex
];

4301 ià((
	`shªnÚ_©omic_»ad
(&
group
->
avaabË_luns
è< 3è|| 
	`is_bad_lun
(
sb
, 
bad_lun
)) {

4302 
	`shªnÚ_šfo
("%s(): badblock ha b“À£t. bad_lun=%d, sb=%d.\n", 
__func__
, 
bad_lun
, 
sb
->
sb_šdex
);

4305 
	`shªnÚ_©omic_šc
(&
sdev
->
»cov”_dÚe
);

4306 ià(
	`»ad_·r™y_group_to_check_bad_block
(
sdev
, 
sb
, 
group_šdex
) < 0) {

4307 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4311 
	`shªnÚ_wa™_ev’t
(
sdev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
»cov”_dÚe
) == 0);

4313 
	}
}

4315 
	$·r™y_š™
(
shªnÚ_sb
 *
sb
, 
group_šdex
, 
µa
, 
u8
 
h—d
)

4317 
shªnÚ_»que¡
 *
»q
;

4318 
h—d_šdex
 = 
h—d
 & 
HEAD_INDEX_MASK
;

4320 
sb
->
sdev
->
·r™y_š™_dÚe
[
h—d_šdex
] = 0;

4322 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

4323 
	`£t_»q_debug_g
(
»q
, 
PARITY_INIT_TAG
, 0);

4324 
»q
->
İcode
 = 
sh_cmd_·r™y_š™
;

4325 
»q
->
d©a_luns
 = 
sb
->
mš_d©a_luns
;

4326 
»q
->
pba
.
lun
 = 
	`g‘_·r™y_lun
(&
sb
->
sub_group
[
group_šdex
]);

4327 
»q
->
pba
.
lun_pba
 = 
µa
 * 
sb
->
sdev
->
logicbs_š_·ge
;

4328 
»q
->
h—d
 = head;

4329 
»q
->
µa
 =…pa;

4330 
	`add_»que¡_queue_
(
sb
->
sdev
, 
»q
, 1);

4331 
	`shªnÚ_queue_wÜk
(
sb
->
sdev
->
shªnÚ_wq
, &sb->sdev->
wÜk
);

4334 
	}
}

4336 
	$upd©e_”a£_couÁ
(
shªnÚ_dev
 *
dev
)

4338 
i
, 
blk_num
 = 0;

4339 
v¬Ÿnû
 = 0;

4340 
shªnÚ_sb
 *
sb
 = 
NULL
;

4341 
mš_”a£_couÁ
, 
max_”a£_couÁ
;

4343 
mš_”a£_couÁ
 = 
dev
->
æash_³_th»shŞd
;

4344 
max_”a£_couÁ
 = 0;

4345 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

4346 
sb
 = 
dev
->
sbs
 + 
i
;

4347 ià(
sb
->
¡©e
 !ğ
DISCARDED_BLOCK
) {

4348 ià(
mš_”a£_couÁ
 > 
sb
->
”a£_couÁ”
)

4349 
mš_”a£_couÁ
 = 
sb
->
”a£_couÁ”
;

4350 ià(
max_”a£_couÁ
 < 
sb
->
”a£_couÁ”
)

4351 
max_”a£_couÁ
 = 
sb
->
”a£_couÁ”
;

4352 
blk_num
++;

4356 
dev
->
mš_”a£_couÁ
 = min_erase_count;

4357 ià(
dev
->
max_”a£_couÁ
 < max_erase_count)

4358 
dev
->
max_”a£_couÁ
 = max_erase_count;

4360 
dev
->
av”age_”a£_couÁ
 = dev->
tÙ®_”a£_couÁ
 / 
blk_num
;

4361 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

4362 
sb
 = 
dev
->
sbs
 + 
i
;

4363 ià(
sb
->
¡©e
 !ğ
DISCARDED_BLOCK
) {

4364 ià(
sb
->
”a£_couÁ”
 >ğ
dev
->
av”age_”a£_couÁ
)

4365 
v¬Ÿnû
 +ğ((
sb
->
”a£_couÁ”
 - 
dev
->
av”age_”a£_couÁ
) * (sb->erase_counter - dev->average_erase_count));

4367 
v¬Ÿnû
 +ğ((
dev
->
av”age_”a£_couÁ
 - 
sb
->
”a£_couÁ”
) * (dev->average_erase_count - sb->erase_counter));

4370 
dev
->
v¬Ÿnû_of_”a£_couÁ
 = 
v¬Ÿnû
 * 100 / 
blk_num
;

4371 
	`debugs4
("erase count statistics: max %d; min %d;‡verage %d;otal %d; variance %d/100.\n",

4372 
dev
->
max_”a£_couÁ
, dev->
mš_”a£_couÁ
, dev->
av”age_”a£_couÁ
, dev->
tÙ®_”a£_couÁ
, dev->
v¬Ÿnû_of_”a£_couÁ
);

4373 
	}
}

4375 
	$»move_sb_äom_some_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

4377 
sb
->
¡©e
) {

4378 
FREE_BLOCK
:

4379 
	`»move_sb_äom_ä“_blk_li¡
(
sdev
, 
sb
);

4381 
WAIT_COPY_BLOCK
:

4382 
	`shªnÚ_¥š_lock
(&
sdev
->
wa™_cİy_lock
);

4383 
sdev
->
wa™_cİy_blkút
--;

4384 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

4385 
	`shªnÚ_¥š_uÆock
(&
sdev
->
wa™_cİy_lock
);

4387 
WAIT_ERASE_BLOCK
:

4388 
	`shªnÚ_¥š_lock
(&
sdev
->
wa™_”a£d_lock
);

4389 
sdev
->
wa™_”a£d_blkút
--;

4390 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

4391 
	`shªnÚ_¥š_uÆock
(&
sdev
->
wa™_”a£d_lock
);

4393 
RECOVER_ERR_BLOCK
:

4394 
	`shªnÚ_¥š_lock
(&
sdev
->
»cov”_”r_lock
);

4395 
sdev
->
»cov”_”r_blkút
--;

4396 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

4397 
	`shªnÚ_¥š_uÆock
(&
sdev
->
»cov”_”r_lock
);

4399 
HOT_BLOCK_LIST
:

4400 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

4401 
sdev
->
u£d_blkút
[
HOT_INDEX
]--;

4402 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

4403 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

4405 
COLD_BLOCK_LIST
:

4406 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


4407 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

4409 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

4410 
sdev
->
u£d_blkút
[
COLD_INDEX
]--;

4411 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

4412 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

4415 
	`shªnÚ_”r
("Unknown state: sb_index=%d, state=%d.\n",

4416 
sb
->
sb_šdex
, sb->
¡©e
);

4419 
	}
}

4421 
	$add_to_li¡_by_”a£_couÁ
(
shªnÚ_sb
 *
sb
, 
shªnÚ_li¡_h—d
 *
sb_li¡
)

4423 
shªnÚ_sb
 *
tmp
;

4424 
shªnÚ_li¡_h—d
 *
li¡
;

4426 ià(
	`shªnÚ_li¡_em±y
(
sb_li¡
)) {

4427 
	`shªnÚ_li¡_add_
(&
sb
->
”a£_couÁ_li¡
, 
sb_li¡
);

4431 
li¡
 = 
sb_li¡
->
Ãxt
;

4432 
li¡
 !ğ
sb_li¡
) {

4433 
tmp
 = 
	`shªnÚ_li¡_’Œy
(
li¡
, 
shªnÚ_sb
, 
”a£_couÁ_li¡
);

4434 ià(
tmp
->
”a£_couÁ”
 > 
sb
->erase_counter)

4436 
li¡
 =†i¡->
Ãxt
;

4438 
	`shªnÚ_li¡_add_
(&
sb
->
”a£_couÁ_li¡
, 
li¡
);

4439 
	}
}

4441 
u32
 
	$fšd_medŸn_”a£_couÁ
(
shªnÚ_dev
 *
dev
, 
£®ed_sb_couÁ
)

4443 
shªnÚ_sb
 *
sb
, *
tmp
;

4444 
shªnÚ_li¡_h—d
 
li¡
;

4445 
sb_couÁ
 = 0, 
tmp_sb_couÁ
 = 0;

4446 
u32
 
medŸn_”a£_couÁ
 = 0;

4447 
i
;

4449 
	`BUG_ON
(
£®ed_sb_couÁ
 < 2);

4450 
	`SHANNON_INIT_LIST_HEAD
(&
li¡
);

4451 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

4452 
sb
 = 
dev
->
sbs
 + 
i
;

4453 ià(
	`g‘_»cov”ed_•og_h—d
(
sb
) != 0) {

4454 
sb_couÁ
++;

4455 
	`SHANNON_INIT_LIST_HEAD
(&
sb
->
”a£_couÁ_li¡
);

4456 
	`add_to_li¡_by_”a£_couÁ
(
sb
, &
li¡
);

4460 
	`BUG_ON
(
sb_couÁ
 !ğ
£®ed_sb_couÁ
);

4462 
tmp_sb_couÁ
 = 
sb_couÁ
;

4463 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
sb
, 
tmp
, &
li¡
, 
”a£_couÁ_li¡
) {

4464 
	`shªnÚ_li¡_d–
(&
sb
->
”a£_couÁ_li¡
);

4465 
tmp_sb_couÁ
--;

4466 ià(
tmp_sb_couÁ
 =ğ(
sb_couÁ
 / 2))

4467 
medŸn_”a£_couÁ
 = 
sb
->
”a£_couÁ”
;

4471  
medŸn_”a£_couÁ
;

4472 
	}
}

4474 
	$check_”a£_couÁ_¿tiÚ®™y
(
shªnÚ_dev
 *
sdev
)

4476 
shªnÚ_sb
 *
sb
;

4477 
i
;

4478 
u64
 
tÙ®_wr™e_logicbs
 = 0, 
tÙ®_disk_logicbs
 = 0;

4479 
u32
 
avg_”a£_couÁ
 = 0;

4481 
tÙ®_wr™e_logicbs
 = 
sdev
->
tÙ®_wr™e_£ùÜs
 >> (sdev->
logicb_shiá
 - 9);

4482 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

4483 
sb
 = 
sdev
->
sbs
 + 
i
;

4484 ià(
sb
->
¡©e
 =ğ
DISCARDED_BLOCK
)

4486 
tÙ®_disk_logicbs
 +ğ
	`fœ¡_•og_pba
(
sdev
, 
sb
);

4488 
avg_”a£_couÁ
 = 
tÙ®_wr™e_logicbs
 / 
tÙ®_disk_logicbs
;

4490 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

4491 
sb
 = 
sdev
->
sbs
 + 
i
;

4492 ià(
sb
->
¡©e
 =ğ
DISCARDED_BLOCK
)

4494 ià(
	`g‘_»cov”ed_•og_h—d
(
sb
)) {

4495 ià(
sb
->
”a£_couÁ”
 > (
avg_”a£_couÁ
 + 1000)) {

4496 
	`shªnÚ_®¬m
("sb=%d,ƒ¿£_couÁ=%d,‡vg_”a£_couÁ=%d\n", 
sb
->
sb_šdex
, sb->
”a£_couÁ”
, 
avg_”a£_couÁ
);

4497 
sdev
->
tÙ®_”a£_couÁ
 -ğ
sb
->
”a£_couÁ”
;

4498 
sb
->
”a£_couÁ”
 = 
avg_”a£_couÁ
;

4499 
sdev
->
tÙ®_”a£_couÁ
 +ğ
sb
->
”a£_couÁ”
;

4503 
	}
}

4505 
	$»¡Üe_”a£_couÁ”
(
shªnÚ_dev
 *
dev
)

4507 
u32
 
un£®ed_sb_”a£_couÁ
, 
£®ed_sb_couÁ
 = 0, 
i
;

4508 
shªnÚ_sb
 *
sb
;

4510 
dev
->
tÙ®_”a£_couÁ
 = 0;

4511 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

4512 
sb
 = 
dev
->
sbs
 + 
i
;

4513 ià(
	`g‘_»cov”ed_•og_h—d
(
sb
) != 0) {

4514 
£®ed_sb_couÁ
++;

4515 
dev
->
tÙ®_”a£_couÁ
 +ğ
sb
->
”a£_couÁ”
;

4518 
	`check_”a£_couÁ_¿tiÚ®™y
(
dev
);

4520 ià(
£®ed_sb_couÁ
 > 2)

4521 
un£®ed_sb_”a£_couÁ
 = 
	`fšd_medŸn_”a£_couÁ
(
dev
, 
£®ed_sb_couÁ
);

4522 ià(
£®ed_sb_couÁ
 == 0)

4523 
un£®ed_sb_”a£_couÁ
 = 
dev
->
mbr
.
hi¡Üy_”a£_couÁ
;

4525 
un£®ed_sb_”a£_couÁ
 = 
dev
->
tÙ®_”a£_couÁ
 / 
£®ed_sb_couÁ
;

4527 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

4528 
sb
 = 
dev
->
sbs
 + 
i
;

4529 ià(
	`g‘_»cov”ed_•og_h—d
(
sb
) == 0) {

4530 
sb
->
”a£_couÁ”
 = 
un£®ed_sb_”a£_couÁ
;

4531 
dev
->
tÙ®_”a£_couÁ
 +ğ
sb
->
”a£_couÁ”
;

4534 
	`upd©e_”a£_couÁ
(
dev
);

4535 
	}
}

4537 
cİy_·ge_¡re
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
·ge_¡re
, 
cur_¡©e
);

4538 
	$»şaim_rg‘_blk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

4540 
¡re
 = 0;

4541 
subm™_»qs
 = 0;

4542 
u16
 
h—d_šdex
;

4543 
»t
 = 0;

4545 
	`shªnÚ_šfo
("%s:„eclaim sb(%d), sb_state=0x%x, head_index=0x%x, valid_pages=%u.\n",\

4546 
__func__
, 
sb
->
sb_šdex
, sb->
¡©e
, sb->
h—d_šdex
, 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
));

4547 
h—d_šdex
 = 
sb
->head_index;

4548 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
sdev
->
wa™_blk
) != -1);

4549 
	`BUG_ON
(
sb
->
sb_šdex
 > 
sdev
->
sb_couÁ
);

4550 
	`shªnÚ_©omic_£t
(&
sdev
->
wa™_blk
, 
sb
->
sb_šdex
);

4551 (
¡re
 < 
sdev
->
·ges_š_eblock
è&& (
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) != 0)) {

4552 ià(
sdev
->
¶ug_out
 || (sdev->
»cov”_¡©e
 =ğ
RECOVER_ERROR
)) {

4553 
»t
 = -1;

4554 
	`shªnÚ_©omic_£t
(&
sdev
->
wa™_blk
, -1);

4555 
out
;

4557 
subm™_»qs
 = 
	`cİy_·ge_¡re
(
sdev
, 
sb
, 
¡re
, sb->
¡©e
);

4558 
¡re
++;

4560 
	`shªnÚ_wa™_ev’t
(
sdev
->
wa™_blk_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
wa™_blk
) == -1);

4561 
»t
 = 0;

4562 ià(
sdev
->
¶ug_out
 || (
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) != 0))

4563 
»t
 = -1;

4565 
out
:

4566 ià(
»t
 == -1)

4567 
	`debugs1
("»şaim¬g‘ blkƒ¼Ü.…lug_out=%d,„ecov”_¡©e=%d.\n", 
sdev
->
¶ug_out
, sdev->
»cov”_¡©e
);

4568  
»t
;

4569 
	}
}

4571 
	$check_ªd_»şaim_sb
(
shªnÚ_dev
 *
sdev
)

4573 
shªnÚ_sb
 *
sb
, *
aùive_sb
, *
sb_tmp
;

4574 
h—d_šdex
;

4575 
»t
 = 0;

4576 
»Œy
 = 10;

4578 
	`BUG_ON
(
sdev
->
š™_dÚe
 !ğ
STAGE_RECOVER_ACTIVE_DONE
);

4580 
h—d_šdex
 = 0; h—d_šdex < 
sdev
->
h—d_couÁ
; head_index++) {

4581 ià(
sdev
->
¶ug_out
)

4583 
sb
 = 
sdev
->
Ï¡_blk
[
h—d_šdex
];

4584 ià(
sb
 =ğ
NULL
)

4586 ià(
sb
->
»cov”_¡©us
 & (
NEED_RECLAIM
 | 
NEED_FILL
)) {

4587 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
sdev
->
»cov”_dÚe
) != 0);

4588 
	`shªnÚ_©omic_šc
(&
sdev
->
»cov”_dÚe
);

4589 
	`shªnÚ_šfo
("%s:„esÿÀsu³¸block %d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
);

4590 ià(
	`sÿn_su³r_block
(
sb
, 0, 0))

4591 
	`shªnÚ_©omic_dec
(&
sdev
->
»cov”_dÚe
);

4593 
	`shªnÚ_wa™_ev’t
(
sdev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
»cov”_dÚe
) == 0);

4595 ià(
sb
->
»cov”_¡©us
 & 
NEED_RECLAIM
) {

4596 
	`debugs1
("%s:†a¡ % sb(%dè»cov”_¡©e=%d,\n", 
__func__
, (
sb
->
h—d_šdex
 =ğ
HOT_INDEX
) ? "hot" : "cold", \

4597 
sb
->
sb_šdex
, sb->
»cov”_¡©us
);

4598 ià(
sdev
->
»adÚly_»asÚ
)

4600 ià(
sdev
->
¶ug_out
)

4602 ià(
sdev
->
ä“_blkút
 == 0) {

4603 
	`shªnÚ_w¬n
("ä“_blkút=%d!\n", 
sdev
->
ä“_blkút
);

4606 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) != 0)

4607 ià(
	`»şaim_rg‘_blk
(
sdev
, 
sb
))

4609 
aùive_sb
 = 
sdev
->
aùive_blk
[
h—d_šdex
];

4610 
aùive_sb
->
fl_sb
 = 1;

4611 
»Œy
--) {

4612 ià(
sdev
->
¶ug_out
)

4614 
»t
 = 
	`fl_aùive_blk
(
sdev
, 
h—d_šdex
, 1);

4615 ià(!
»t
)

4618 ià(
»Œy
 == 0) {

4619 
	`shªnÚ_”r
("%s: faed.\n", 
__func__
);

4623 ià((
sdev
->
aùive_blk
[
h—d_šdex
]->
sb_šdex
 =ğ
aùive_sb
->sb_šdexè|| sdev->
¶ug_out
) {

4626 
	`BUG_ON
(
aùive_sb
->
¡©e
 !ğ((
h—d_šdex
 =ğ
HOT_INDEX
è? 
LAST_HOT_BLOCK
 : 
LAST_COLD_BLOCK
));

4627 
	`debugs1
("%s:†a¡‡ùiv% sb(%dè¡©i %d.\n", 
__func__
, \

4628 
aùive_sb
->
h—d_šdex
 =ğ
HOT_INDEX
 ? "hot" : "cold", \

4629 
aùive_sb
->
sb_šdex
,‡ùive_sb->
¡©e
);

4630 
	`debugs1
("%s:„eşaim sb(%dè¡©i %d, v®id…ages=%d.\n", 
__func__
, 
sb
->
sb_šdex
, \

4631 
sb
->
¡©e
, 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
));

4635 
	`debugs1
("check†ast hot‡nd cold block finish.\n");

4636 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
sb
, 
sb_tmp
, &
sdev
->
wa™_cİy
, 
li¡
) {

4637 ià((
sb
->
»cov”_¡©us
 & 
NEED_RECLAIM
è&& !
sdev
->
»adÚly_»asÚ
 && !sdev->
¶ug_out
) {

4638 
	`debugs1
("%s: u£d % sb(%dèÃed„eşaim, s‹ i %d, v®id…ages=%d,‚ext_sb=%d.\n", 
__func__
, \

4639 
sb
->
¡©e
 =ğ
LAST_HOT_BLOCK
 ? "hÙ" : "cŞd", sb->
sb_šdex
, \

4640 
sb
->
¡©e
, 
	`shªnÚ_©omic_»ad
(&sb->
v®id_·ges
), sb->
Ãxt_sb
);

4641 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) > 0) {

4642 ià(
sdev
->
ä“_blkút
 == 0) {

4643 
	`shªnÚ_w¬n
("»şaim u£d_sb(%d), buˆä“_blkút=%d!\n", 
sb
->
sb_šdex
, 
sdev
->
ä“_blkút
);

4646 
	`»şaim_rg‘_blk
(
sdev
, 
sb
);

4652 
	}
}

4654 
	$»wr™e_ov”Ïp_d©a_ÿÎback
(
shªnÚ_bio
 *
sbio
)

4656 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

4657 
shªnÚ_»que¡
 *
»q
;

4658 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

4659 
shªnÚ_sb
 *
sb
;

4661 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

4662 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

4663 
»q
->
¡©e
 = 
REQ_CALLBACK
;

4664 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

4665 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

4666 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

4667 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

4668 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

4669 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

4672 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

4673 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

4676 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
)) {

4677 
	`debugs0
("wake up„ecover done.\n");

4678 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

4680 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

4681 
	`ä“_»q
(
»q
);

4682 
	`ä“_sbio
(
sbio
);

4683 
	}
}

4685 
	$»wr™e_ov”Ïp_d©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
ov”Ïp_»q
)

4687 
shªnÚ_bio
 *
sbio
;

4689 
	`BUG_ON
(
ov”Ïp_»q
 =ğ
NULL
);

4691 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

4692 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

4693 
sbio
->
logicbs
 = 1;

4694 
sbio
->
ÿÎback
 = 
»wr™e_ov”Ïp_d©a_ÿÎback
;

4695 
sbio
->
d©a
 = 
sdev
;

4696 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

4698 
	`SHANNON_INIT_LIST_HEAD
(&
ov”Ïp_»q
->
bio_li¡
);

4699 
	`SHANNON_INIT_LIST_HEAD
(&
ov”Ïp_»q
->
chunk_li¡
);

4700 
	`£t_lun_pba_šv®id
(&
ov”Ïp_»q
->
pba
);

4702 
ov”Ïp_»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

4703 
ov”Ïp_»q
->
İcode
 = 
sh_cmd_wr™e
;

4704 
ov”Ïp_»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

4705 
ov”Ïp_»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4706 
	`£t_»q_debug_g
(
ov”Ïp_»q
, 
RECOVER_OVERLAP_BLK_TAG
, 0);

4707 
	`£t_»q_šdex
(
ov”Ïp_»q
, 0);

4708 
ov”Ïp_»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, ov”Ïp_»q->
vœt_addr
, sdev->
logicb_size
, ov”Ïp_»q->
dma_dœ
);

4709 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
ov”Ïp_»q
->
dma_add»ss
)) {

4710 
	`shªnÚ_”r
("dma_map_single failed!.\n");

4711 
dma_ç
;

4713 
ov”Ïp_»q
->
sbio
 = sbio;

4714 
	`shªnÚ_li¡_add_
(&
ov”Ïp_»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

4715 
	`add_»que¡_queue_
(
sdev
, 
ov”Ïp_»q
, 1);

4716 
	`shªnÚ_pick_»que¡
(
sdev
, 0xffffffff);

4719 
dma_ç
:

4720 
	`ä“_logicb_buf
(
sdev
, 
ov”Ïp_»q
->
vœt_addr
);

4721 
	`ä“_»q
(
ov”Ïp_»q
);

4722 
	`ä“_sbio
(
sbio
);

4724 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4725 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

4726 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

4728  -
EIO
;

4729 
	}
}

4731 
	$Ãxt_ov”Ïp_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
¡¬t_lun
)

4733 
lun
 = 
¡¬t_lun
;

4735 
	`is_bad_lun
(
sb
, 
lun
è&& (luÀ< 
sdev
->
lun_couÁ
))

4736 
lun
++;

4737 ià(
lun
 >ğ
sdev
->
lun_couÁ
)

4740  
lun
;

4741 
	}
}

4743 
šlše
 
shªnÚ_sb
 *
g‘_Ãw_ä“_sb
(
shªnÚ_dev
 *
dev
);

4744 
»cov”_ov”Ïp_blk
(
shªnÚ_dev
 *
sdev
, 
·ge_¡re
, 
shªnÚ_»que¡
 *
ov”Ïp_»q
);

4745 
	$»cov”_ov”Ïp_blk_ÿÎback
(
shªnÚ_bio
 *
sbio
)

4747 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

4748 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

4749 
·ge_¡re
 = ()
sbio
->
d©a2
;

4750 
shªnÚ_»que¡
 *
´ev_»q
 = 
NULL
, *
»q
, *
tmp
, *
ov”Ïp_»q
 = (shªnÚ_»que¡ *)
sbio
->
vœt_addr
;

4751 
shªnÚ_»que¡
 *
ov”Ïp_»q_1
 = 
NULL
;

4752 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

4753 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

4754 
shªnÚ_poŞ
 *
¥oŞ
 = 
sdev
->spool;

4755 
shªnÚ_Çme¥aû
 *
ns
;

4756 
lun_pba
;

4757 
»cov”_çed
 = 0;

4758 
bÏnk_couÁ
 = 0;

4759 
»t
;

4760 
Ãed_”a£
 = 0;

4762 ià(
sbio
->
¡©us
)

4763 
	`debugs3
("enter, sb_index=%d,…age_stripe=%d, status=0x%x.\n",

4764 
sb
->
sb_šdex
, 
·ge_¡re
, 
sbio
->
¡©us
);

4766 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4767 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

4768 ià(
»q
->
_ecc
 !ğ
SH_FRESH_ERASED
) {

4769 ià(
bÏnk_couÁ
 && 
»q
->
_ecc
 < 
SH_FAKE_ERR
) {

4770 
	`shªnÚ_”r
("%s: ha d©¨b‘w“ÀbÏnk†ogicbs.\n", 
sdev
->
sdisk
.
disk_Çme
);

4771 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4772 
»cov”_çed
 = 1;

4776 ià(
»cov”_çed
)

4779 ià(
»q
->
_ecc
 < 
SH_FAKE_ERR
) {

4780 ià(
»q
->
lba
 =ğ
šv®id_lba
[
sdev
->
lba_fÜm©
])

4781 
	`»cov”_d©a_äom_dummy_·ge
(
sdev
, 
»q
->
vœt_addr
);

4784 
lun_pba
 = (
»q
->
pba
.lun_pb¨% 
sdev
->
logicbs_š_siblšg_eblock
);

4785 ià((
lun_pba
 / 
sdev
->
logicbs_š_eblock
 =ğ0è&& (lun_pb¨% sdev->
logicbs_š_·ge
 == 1))

4786 
ov”Ïp_»q_1
 = 
»q
;

4787 
´ev_»q
 = 
»q
;

4790 
bÏnk_couÁ
++;

4793 ià(
sdev
->
»cov”_¡©e
 =ğ
RECOVER_DEAD
)

4794 
dÚe
;

4796 ià(
´ev_»q
) {

4797 
	`debugs3
("stripe=%d,…rev_req:†un=%d,†un_pba=%d, overlap_req:†un=%d,†un_pba=%d.\n", \

4798 
·ge_¡re
, 
´ev_»q
->
pba
.
lun
,…»v_»q->pba.
lun_pba
, \

4799 
ov”Ïp_»q_1
->
pba
.
lun
, ov”Ïp_»q_1->pba.
lun_pba
);

4800 
	`BUG_ON
((
ov”Ïp_»q_1
 =ğ
NULL
è|| (ov”Ïp_»q_1->
pba
.
lun
 !ğ
´ev_»q
->pba.lun));

4803 ià(!(
sbio
->
¡©us
 & 
HAVE_BLANK_SECTOR
)) {

4804 
»q
 = 
ov”Ïp_»q_1
;

4805 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
) {

4806 
	`shªnÚ_”r
("error data: could‚ot„ecover.\n");

4807 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

4808 
dÚe
;

4811 ià(!
	`»q_has_šv®id_lba
(
»q
)) {

4812 ià(
ov”Ïp_»q
 =ğ
NULL
) {

4813 
ov”Ïp_»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

4814 
ov”Ïp_»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

4816 
ov”Ïp_»q
->
lba
 = 
»q
->lba;

4817 
	`shªnÚ_memıy
(
ov”Ïp_»q
->
vœt_addr
, 
»q
->vœt_addr, 
sdev
->
logicb_size
);

4819 ià((
·ge_¡re
 + 1è=ğ
sdev
->
·ges_š_eblock
) {

4821 
Ãed_”a£
 = 1;

4823 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4824 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

4825 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

4826 
	`ä“_»q
(
»q
);

4828 
	`ä“_sbio
(
sbio
);

4829 
	`»cov”_ov”Ïp_blk
(
sdev
, 
·ge_¡re
 + 1, 
ov”Ïp_»q
);

4832 } ià(
bÏnk_couÁ
 =ğ
sbio
->
logicbs
) {

4834 
Ş
->
wr_lun
 = 
	`Ãxt_ov”Ïp_lun
(
sdev
, 
sb
, 0);

4835 ià(
	`uÆik–y
(
Ş
->
wr_lun
 < 0)) {

4836 
	`shªnÚ_”r
("%s:†ine=%d, cannot find‚ext_lun,†ast†un=%d,†un_pba=%d.\n", \

4837 
sdev
->
sdisk
.
disk_Çme
, 
__LINE__
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4838 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4840 
Ş
->
wr_chunk
 = 
·ge_¡re
;

4841 
Ş
->
wr_·ge
 = 
·ge_¡re
;

4842 
Ş
->
wr_logicb
 = 0;

4843 
Ş
->
wr_¶ªe
 = 0;

4845 
»q
 = 
ov”Ïp_»q_1
;

4846 ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
) {

4847 
	`£t_»cov”_¡©e_”rÜ
(
sdev
);

4848 
dÚe
;

4851 ià(!
	`»q_has_šv®id_lba
(
»q
)) {

4852 ià(
ov”Ïp_»q
 =ğ
NULL
) {

4853 
ov”Ïp_»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

4854 
ov”Ïp_»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

4856 
ov”Ïp_»q
->
lba
 = 
»q
->lba;

4857 
	`shªnÚ_memıy
(
ov”Ïp_»q
->
vœt_addr
, 
»q
->vœt_addr, 
sdev
->
logicb_size
);

4859 
Ş
->
wr_lun
 = 
	`Ãxt_ov”Ïp_lun
(
sdev
, 
sb
, 
»q
->
pba
.
lun
 + 1);

4860 ià(
	`uÆik–y
(
Ş
->
wr_lun
 < 0)) {

4861 
	`shªnÚ_”r
("%s:†ine=%d, cannot find‚ext_lun,†ast†un=%d,†un_pba=%d.\n", \

4862 
sdev
->
sdisk
.
disk_Çme
, 
__LINE__
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4863 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4865 
Ş
->
wr_chunk
 = 
·ge_¡re
;

4866 
Ş
->
wr_·ge
 = 
·ge_¡re
;

4867 
Ş
->
wr_logicb
 = 0;

4868 
Ş
->
wr_¶ªe
 = 0;

4871 ià(
ov”Ïp_»q
) {

4872 
»q
 = 
ov”Ïp_»q
;

4873 
	`shªnÚ_šfo
("%s:…ower failure.„estore overlap data:†un=%d,†un_pba=%d, _metadata=0x%16llx, _ecc=0x%x.\n", \

4874 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_m‘ad©a
,„eq->
_ecc
);

4875 ià(!
	`»q_has_šv®id_lba
(
»q
)) {

4876 ià(
¥oŞ
) {

4877 
ns
 = 
¥oŞ
->ns[
»q
->
ns_id
];

4878 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

4879 
	`debugs1
("Wrong‚s_id=%d, metadata=0x%lx, datatype=0x%x,†ba=0x%lx,†un=%d,†un_pba=%lu, chunk=%d.\n",

4880 
»q
->
ns_id
,„eq->
_m‘ad©a
,„eq->
d©©y³
,„eq->
lba
,

4881 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
, 
sdev
->
wr_chunk
[
sb
->
h—d_šdex
]);

4882 
ä“_ov”Ïp_»q
;

4884 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

4885 
	`debugs1
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

4886 
sb
->
sb_šdex
, 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

4887 
ä“_ov”Ïp_»q
;

4889 
sdisk
 = &
ns
->sdisk;

4892 ià(
»q
->
ns_id
 ||„eq->
ns_£q_num
) {

4893 
	`shªnÚ_”r
("%s: Wrong data,‚s_id=%d,‚s_seq_num=%d, metadata=0x%lx,†un=%d,†un_pba=%d.\n",

4894 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
ns_id
,„eq->
ns_£q_num
,„eq->
_m‘ad©a
,

4895 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4896 
ä“_ov”Ïp_»q
;

4900 ià(
»q
->
lba
 > 
sdisk
->
tÙ®_m­_bË_size
 / (
u32
)) {

4901 
	`shªnÚ_”r
("Wrong data:†un=%d,†un_pba=%d,ƒcc=%d, datatype=0x%x,†ba=0x%lx.\n",

4902 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
d©©y³
,„eq->
lba
);

4903 
ä“_ov”Ïp_»q
;

4907 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
Şd_pba
, 
NULL
, 
sdisk
);

4908 ià(
»t
 == 0)

4909 
	`£t_Şd_pba_¡®e
(
sdev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
);

4911 ià(
	`check_ªd_®loc_m­bË
(
sdisk
, 
»q
->
lba
)) {

4912 ià(
sdev
->
»cov”_¡©e
 > 
RECOVER_ERROR
)

4913 
sdev
->
»cov”_¡©e
 = 
RECOVER_ERROR
;

4914 
	`shªnÚ_£t_b™
(
SHN_REASON_EPILOG_FAILURE
, &
sdev
->
»adÚly_»asÚ
);

4915 
	`shªnÚ_”r
("mapableƒrror.\n");

4916 
ä“_ov”Ïp_»q
;

4920 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4921 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

4922 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

4923 ià(!
sdev
->
»adÚly_»asÚ
) {

4924 
»q
->
h—d
 = 
HOT_HEAD
;

4925 
	`shªnÚ_©omic_šc
(&
sdev
->
»cov”_dÚe
);

4926 
	`»wr™e_ov”Ïp_d©a
(
sdev
, 
»q
);

4927 
dÚe
;

4930 ià(!
¥oŞ
 || 
»q
->
lba
 !ğ
šv®id_lba
[
sdev
->
lba_fÜm©
]

4931 || 
»q
->
ns_£q_num
 =ğ0 || 
sdev
->
mbr
.
sdev_id
 != 0) {

4932 
ä“_ov”Ïp_»q
;

4934 
ns
 = 
¥oŞ
->ns[
»q
->
ns_id
];

4935 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

4936 
	`debugs1
("Wrong‚s_id=%d, metadata=0x%lx, datatype=0x%x,†ba=0x%lx,†un=%d,†un_pba=%lu.\n",

4937 
»q
->
ns_id
,„eq->
_m‘ad©a
,„eq->
d©©y³
,„eq->
lba
,

4938 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4939 
ä“_ov”Ïp_»q
;

4941 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

4942 
	`debugs1
("Wrong‚s_seq_num: sb_index=%d,‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

4943 
sb
->
sb_šdex
, 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

4944 
ä“_ov”Ïp_»q
;

4947 
	`shªnÚ_”r
("%s: i n d©a.\n", 
sdev
->
sdisk
.
disk_Çme
);

4949 
ä“_ov”Ïp_»q
:

4950 
	`ä“_logicb_buf
(
sdev
, 
ov”Ïp_»q
->
vœt_addr
);

4951 
	`ä“_»q
(
ov”Ïp_»q
);

4954 
dÚe
:

4955 ià(
Ãed_”a£
) {

4957 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

4958 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

4959 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
wa™_”a£d_lock
);

4960 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
wa™_”a£d
);

4961 
sdev
->
wa™_”a£d_blkút
++;

4962 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
wa™_”a£d_lock
);

4963 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

4964 
sb
 = 
	`g‘_Ãw_ä“_sb
(
sdev
);

4965 ià(
sb
 =ğ
NULL
) {

4966 
	`shªnÚ_”r
("failedo get‚ew free blk for overlap.\n");

4967 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4968 
dÚe
;

4970 
	`shªnÚ_šfo
("g‘‡‚ew f»sb_šdex=%d‡ ov”Ïp_sblk.\n", 
sb
->
sb_šdex
);

4971 
sb
->
¡©e
 = 
OVERLAP_BLOCK
;

4972 
sb
->
£q_num
 = 
MAX_SEQ_NUM
;

4973 
sdev
->
mbr
.
ov”Ïp_sblk
 = 
sb
->
sb_šdex
;

4974 ià(
	`»äesh_mbr_g5
(
sdev
, 0) < 0) {

4975 
	`shªnÚ_”r
("failedo„efresh mbr for updating overlap write.\n");

4976 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4978 
Ş
->
wr_lun
 = 
	`Ãxt_ov”Ïp_lun
(
sdev
, 
sb
, 0);

4979 
Ş
->
wr_chunk
 = 0;

4980 ià(
	`uÆik–y
(
Ş
->
wr_lun
 < 0)) {

4981 
	`shªnÚ_”r
("%s:†ine=%d, cannot find‚ext_lun,†ast†un=%d,†un_pba=%d.\n", \

4982 
sdev
->
sdisk
.
disk_Çme
, 
__LINE__
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4983 
	`£t_»cov”_¡©e_d—d
(
sdev
);

4985 
Ş
->
wr_·ge
 = 0;

4986 
Ş
->
wr_logicb
 = 0;

4987 
Ş
->
wr_¶ªe
 = 0;

4991 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

4992 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

4993 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

4994 
	`ä“_»q
(
»q
);

4996 
	`ä“_sbio
(
sbio
);

4997 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

4998 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

5000 
	}
}

5002 
	$»cov”_ov”Ïp_blk
(
shªnÚ_dev
 *
sdev
, 
·ge_¡re
, 
shªnÚ_»que¡
 *
ov”Ïp_»q
)

5004 
shªnÚ_bio
 *
sbio
;

5005 
lun
, 
¶ªe
, 
i
;

5006 
sb_lun_pba
, 
logicbs_š_eblk
;

5007 
shªnÚ_»que¡
 *
»q
, *
tmp
;

5008 
shªnÚ_sb
 *
sb
;

5010 
	`BUG_ON
(
sdev
->
ov”Ïp_wr™e
 == 0);

5011 ià(
·ge_¡re
 < 0 ||…age_¡r>ğ
sdev
->
mbr
.
·ges_š_eblock
) {

5012 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

5013 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

5017 
sb
 = 
sdev
->
sbs
 + sdev->
mbr
.
ov”Ïp_sblk
;

5018 
	`BUG_ON
(
sb
->
¡©e
 !ğ
OVERLAP_BLOCK
);

5020 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

5021 
	`£t_sbio_debug_g
(
sbio
, 
RECOVER_OVERLAP_BLK_TAG
);

5023 
sbio
->
ÿÎback
 = 
»cov”_ov”Ïp_blk_ÿÎback
;

5024 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

5025 
sbio
->
d©a
 = 
sb
;

5026 
sbio
->
d©a2
 = (*)
·ge_¡re
;

5028 
sbio
->
vœt_addr
 = (*)
ov”Ïp_»q
;

5029 
sbio
->
logicbs
 = 0;

5030 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 0);

5032 
sb_lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
;

5033 
logicbs_š_eblk
 = 
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
;

5035 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

5036 ià(
	`is_bad_lun
(
sb
, 
lun
))

5039 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_chunk
, &
sbio
->
u£r_couÁ
);

5040 
sbio
->
logicbs
 +ğ
sdev
->
logicbs_š_chunk
;

5041 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

5042 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

5043 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

5044 
	`£t_»q_debug_g
(
»q
, 
RECOVER_OVERLAP_BLK_TAG
, 
i
);

5045 
»q
->
İcode
 = 
sh_cmd_»ad
;

5046 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

5047 
»q
->
lba
 = 
LONG_INVALID_LBA
;

5048 
»q
->
pba
.
lun
 =†un;

5049 
»q
->
pba
.
lun_pba
 = 
sb_lun_pba
 + 
¶ªe
 * 
logicbs_š_eblk
 + 
·ge_¡re
 * 
sdev
->
logicbs_š_·ge
 + 
i
;

5050 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

5051 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
bio_li¡
);

5052 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

5053 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

5054 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

5055 
	`shªnÚ_”r
("dma_map_single failed!.\n");

5056 
dma_çed
;

5058 
»q
->
sbio
 = sbio;

5059 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

5060 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

5061 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

5065 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

5068 
dma_çed
:

5069 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

5070 
	`ä“_»q
(
»q
);

5071 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

5072 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

5073 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

5074 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

5075 
	`ä“_»q
(
»q
);

5077 
	`ä“_sbio
(
sbio
);

5079 
	`£t_»cov”_¡©e_d—d
(
sdev
);

5080 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sdev
->
»cov”_dÚe
))

5081 
	`shªnÚ_wake_up
(&
sdev
->
»cov”_dÚe_ev’t
);

5082  -
EIO
;

5083 
	}
}

5085 
	$´•¬e_ov”Ïp_pba
(
shªnÚ_dev
 *
sdev
)

5087 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

5090 
	`£nd_dummy_ov”Ïp_»q
(
sdev
, 0);

5091 
Ş
->
pba
.
lun
 = ol->
wr_lun
;

5092 
Ş
->
pba
.
lun_pba
 = 
sdev
->
mbr
.
ov”Ïp_sblk
 * sdev->
logicbs_š_siblšg_eblock
 + \

5093 
Ş
->
wr_·ge
 * 
sdev
->
logicbs_š_·ge
 + ol->
wr_logicb
;

5094 
	`£nd_dummy_ov”Ïp_»q
(
sdev
, 0);

5096 
	`debugs0
("ov”Ï°lun=%d,†un_pba=%d.\n", 
Ş
->
pba
.
lun
, ol->pba.
lun_pba
);

5097 
	}
}

5099 
	$»ad_bbt_šfo
(
shªnÚ_dev
 *
sdev
)

5101 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

5102  
	`»ad_bbt_šfo_g5
(
sdev
);

5104  
	`»ad_bbt_šfo_g4
(
sdev
);

5105 
	}
}

5107 
	$ª®yze_bbt_šfo
(
shªnÚ_dev
 *
sdev
)

5109 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

5110 
	`ª®yze_bbt_šfo_g5
(
sdev
);

5112 
	`ª®yze_bbt_šfo_g4
(
sdev
);

5113 
	}
}

5115 
»cov”_ns_d©a
(
shªnÚ_Çme¥aû
 *, 
lun_pba
);

5116 
	$bud_d©a_¡ruù
(
shªnÚ_dev
 *
dev
)

5118 
shªnÚ_sb
 *
sb
, *
sb_tmp
;

5119 
i
, 
j
, 
h—d_šdex
, 
·r™y_lun_off£t
;

5120 
»Œ›s
;

5122 
	`debugs3
("enter. ---------------------\n");

5123 
dev
->
sbs
 = 
	`shªnÚ_vm®loc
((
shªnÚ_sb
è* dev->
sb_couÁ
);

5124 ià(
dev
->
sbs
 =ğ
NULL
)

5125  -
ENOMEM
;

5126 
	`shªnÚ_mem£t
(
dev
->
sbs
, 0x00, (
shªnÚ_sb
è* dev->
sb_couÁ
);

5128 
dev
->
sub_groups
 = 
	`shªnÚ_vm®loc
((
sub_group
è* (dev->
sb_couÁ
 + 1è* dev->
·r™y_groups
);

5129 ià(
dev
->
sub_groups
 =ğ
NULL
)

5130  -
ENOMEM
;

5131 
	`shªnÚ_mem£t
(
dev
->
sub_groups
, 0x0, (
sub_group
è* (dev->
sb_couÁ
 + 1è* dev->
·r™y_groups
);

5132 
dev
->
Ãw_bad_lun
 = (Ãw_bad_luÀ*)(dev->
sub_groups
 + dev->
sb_couÁ
 * dev->
·r™y_groups
);

5134 
dev
->
»ad_couÁ
 = 
	`shªnÚ_vm®loc
(((
u32
è* dev->
lun_couÁ
 * dev->
sb_couÁ
));

5135 ià(
dev
->
»ad_couÁ
 =ğ
NULL
)

5136  -
ENOMEM
;

5137 
	`shªnÚ_mem£t
(
dev
->
»ad_couÁ
, 0, (
u32
è* dev->
lun_couÁ
 * dev->
sb_couÁ
);

5141 
·r™y_lun_off£t
 = 
dev
->
max_luns_š_group
 - 1 - dev->
mbr_eblocks
/dev->
¶ªes
;

5142 
i
 = 0; i < 
dev
->
sb_couÁ
; i++) {

5143 
sb
 = 
dev
->
sbs
 + 
i
;

5144 
sb
->
sb_šdex
 = 
i
;

5145 
sb
->
sdev
 = 
dev
;

5146 ià(
i
 < 
dev
->
mbr_eblocks
/dev->
¶ªes
) {

5147 
sb
->
¡©e
 = 
MBR_BLOCK
;

5148 
sb
->
wr_off£t
 = ~0;

5149 } ià(
dev
->
ov”Ïp_wr™e
 && dev->
mbr
.
ov”Ïp_sblk
 =ğ
i
) {

5150 
sb
->
¡©e
 = 
OVERLAP_BLOCK
;

5151 
sb
->
wr_off£t
 = ~0;

5153 
	`shªnÚ_©omic_£t
(&
sb
->
š_wr™e_logicbs
, 0);

5154 
	`shªnÚ_©omic_£t
(&
sb
->
v®id_·ges
, 0);

5155 
	`shªnÚ_©omic_£t
(&
sb
->
š_³riod_»ad
, 0);

5156 
	`shªnÚ_©omic_£t
(&
sb
->
³riod_»ad_dÚe
, 0);

5157 
	`shªnÚ_¥š_lock_š™
(&
sb
->
lock
);

5158 
	`SHANNON_INIT_LIST_HEAD
(&
sb
->
li¡
);

5159 
	`shªnÚ_©omic_£t
(&
sb
->
avaabË_luns
, 
dev
->
lun_couÁ
);

5160 
	`shªnÚ_©omic_£t
(&
sb
->
avaabË_groups
, 
dev
->
·r™y_groups
);

5161 
sb
->
sub_group
 = 
dev
->
sub_groups
 + dev->
·r™y_groups
 * 
i
;

5162 
j
 = 0; j < 
dev
->
·r™y_groups
; j++) {

5163 
	`shªnÚ_©omic_£t
(&
sb
->
sub_group
[
j
].
avaabË_luns
, 
dev
->
max_luns_š_group
);

5164 
sb
->
sub_group
[
j
].
¡¬t_lun
 = j * 
dev
->
max_luns_š_group
;

5165 
sb
->
sub_group
[
j
].
·r™y_lun_off£t
 =…arity_lun_offset;

5166 
sb
->
sub_group
[
j
].
fœ¡_lun_off£t
 = (
·r™y_lun_off£t
 + 1 + 
dev
->
max_luns_š_group
) % dev->max_luns_in_group;

5168 ià(
dev
->
rÙ©e_·r™y
)

5169 
·r™y_lun_off£t
 = (·r™y_lun_off£ˆ+ 1è% 
dev
->
max_luns_š_group
;

5171 
sb
->
»ad_couÁ
 = (
u32
 *)(
dev
->»ad_couÁ + (u32è* dev->
lun_couÁ
 * 
i
);

5172 
sb
->
max_»ad_couÁ
 = 0;

5173 
sb
->
Ï¡_”a£d_time¡amp
 = 
	`g‘_jiff›s
();

5174 
sb
->
Ï¡_şo£d_time¡amp
 = 
	`g‘_jiff›s
();

5177 
	`ª®yze_bad_phy_lun_m­
(
dev
);

5178 
dev
->
max_avaabË_groups
 = 
	`shªnÚ_©omic_»ad
(&dev->
sbs
[2].
avaabË_groups
);

5179 ià(
dev
->
max_avaabË_groups
 == 0) {

5180 
	`shªnÚ_”r
("max_available_groups is 0.\n");

5183 
	`shªnÚ_šfo
("%s: max_avaabË_luns=%d, max_avaabË_groups=%d.\n", 
dev
->
sdisk
.
disk_Çme
, dev->
max_avaabË_luns
, dev->
max_avaabË_groups
);

5185 ià(
	`shªnÚ_dev_is_g5_ff§
(
dev
è&& (dev->
max_avaabË_luns
 > 256è&& (dev->
·r™y_groups
 < 2)) {

5186 
	`shªnÚ_”r
("FFSA controller should have‡t†east 2„aid groups.\n");

5190 
	`£t_avaabË_¿id_¡res
(
dev
);

5191 
	`£t_•og_size
(
dev
);

5192 ià(
	`shªnÚ_®loc_•ogs
(
dev
) < 0) {

5193 
	`shªnÚ_”r
("shannon_alloc_epilogs failed!\n");

5194  -
ENOMEM
;

5198 ià(
	`»ad_bbt_šfo
(
dev
) < 0)

5201 ià(
	`shªnÚ_dev_is_g5
(
dev
è&& dev->
¥oŞ
) {

5202 ià(
	`»ad_poŞ_šfo_g5
(
dev
) < 0)

5206 ià(
dev
->
»cov”_¡©e
 =ğ
RECOVER_DEAD
) {

5207 
	`shªnÚ_”r
("read bbt info failed.\n");

5211 
	`ª®yze_bbt_šfo
(
dev
);

5213 ià(
dev
->
Ãw_bad_lun
->
bad_lun_æag
 == ~0) {

5214 
	`shªnÚ_”r
("morehan one†un‡re broken.\n");

5216 } ià(
dev
->
Ãw_bad_lun
->
bad_lun_æag
) {

5217 
i
 = 0; i < 
dev
->
·r™y_groups
; i++)

5218 ià(
dev
->
Ãw_bad_lun
->
group_bad_lun
[
i
])

5219 
	`»cov”_bad_lun_bbt
(
dev
, 
i
);

5220 
	`£t_»cov”_¡©e_w¬nšg
(
dev
);

5223 ià(
dev
->
»cov”_¡©e
 =ğ
RECOVER_DEAD
) {

5224 
	`shªnÚ_”r
("%s:„ecov” bad_luÀçed.\n", 
dev
->
sdisk
.
disk_Çme
);

5228 
dev
->
š™_dÚe
 = 
STAGE_BBT_DONE
;

5230 ià(
dev
->
¥oŞ
 && (dev->¥oŞ->
Úlše_sdev_couÁ
 == 1)) {

5231 ià(
	`š™_Çme¥aûs
(
dev
->
¥oŞ
))

5234 
	`sdev_m­_bË_’abË
(
dev
);

5236 
	`shªnÚ_šfo
("start„ecoverƒpilog.\n");

5237 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

5238 
sb
 = 
dev
->
sbs
 + 
i
;

5239 ià(
dev
->
ov”Ïp_wr™e
 && dev->
mbr
.
ov”Ïp_sblk
 =ğ
sb
->
sb_šdex
) {

5240 
	`debugs0
("sk ov”Ï°sblk sb_šdex=%d fÜ„ecov”šgƒpog.\n", 
sb
->
sb_šdex
);

5241 
	`»š™Ÿlize_sb
(
dev
, 
sb
);

5242 
sb
->
¡©e
 = 
OVERLAP_BLOCK
;

5243 
sb
->
wr_off£t
 = ~0;

5246 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_groups
è=ğ
dev
->
max_avaabË_groups
) {

5247 
	`»š™Ÿlize_sb
(
dev
, 
sb
);

5248 
	`shªnÚ_¥š_lock_bh
(&
dev
->
ä“_blocks_lock
);

5249 
	`shªnÚ_li¡_add_
(&
dev
->
sbs
[
i
].
li¡
, &dev->
ä“_blocks
);

5250 
dev
->
ä“_blkút
++;

5251 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
ä“_blocks_lock
);

5252 
»Œ›s
 = 0;

5253 
	`shªnÚ_©omic_»ad
(&
dev
->
logicb_buf_couÁ
è> 
MAX_LOGICB_BUF_COUNT
/2) {

5254 
	`shªnÚ_m¦“p
(1);

5255 
»Œ›s
++;

5256 ià((
»Œ›s
 % 10000) == 5000)

5257 
	`shªnÚ_šfo
("%s, wait†ogicb_buf_count=%d.\n",

5258 
dev
->
sdisk
.
disk_Çme
, 
	`shªnÚ_©omic_»ad
(&dev->
logicb_buf_couÁ
));

5260 ià(
	`»ad_•og
(
sb
)) {

5261 
	`£t_»cov”_¡©e_d—d
(
dev
);

5264 
	`shªnÚ_©omic_šc
(&
dev
->
»cov”_dÚe
);

5265 
	`shªnÚ_wa™_ev’t
(
dev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&dev->
»cov”_dÚe
è< 
INIT_EPILOG_COUNT
);

5266 ià((
i
 % 100) == 0) {

5267 
	`shªnÚ_šfo
("%s:„ecov” %d su³rblock' •og dÚe.\n", 
dev
->
sdisk
.
disk_Çme
, 
i
);

5270 
sb
->
¡©e
 = 
DISCARDED_BLOCK
;

5271 
	`shªnÚ_©omic_šc
(&
dev
->
disÿrded_blkút
);

5272 
	`m¬k_su³r_block_bad
(
sb
);

5274 
	`shªnÚ_cÚd_»sched
();

5276 ià(
dev
->
¶ug_out
) {

5277 
	`shªnÚ_w¬n
("the disk is…lug out when„ecoveringƒpilog.\n");

5278 
	`shªnÚ_wa™_ev’t
(
dev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&dev->
»cov”_dÚe
) == 0);

5283 
	`shªnÚ_wa™_ev’t
(
dev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&dev->
»cov”_dÚe
) == 0);

5284 ià(
dev
->
»cov”_¡©e
 =ğ
RECOVER_DEAD
) {

5285 
	`shªnÚ_”r
("%s:ƒpog„ecov”y faed.\n", 
dev
->
sdisk
.
disk_Çme
);

5288 
	`shªnÚ_»Ëa£_»bud_•ogs
(
dev
);

5290 
	`shªnÚ_šfo
("recoverƒpilog done.\n");

5292 ià(
dev
->
ä“_blkút
 == 0) {

5293 
h—d_šdex
 = 0; h—d_šdex < 
dev
->
h—d_couÁ
; head_index++) {

5294 ià(!
dev
->
Ï¡_blk
[
h—d_šdex
]) {

5295 
	`shªnÚ_”r
("physiÿÈdisk fuÎ, buˆÿÂÙ fšd†a¡_blk, h—d_šdex=%d.\n", 
h—d_šdex
);

5296 
	`£t_»cov”_¡©e_d—d
(
dev
);

5297 
d—d
;

5300 ià((
dev
->
Ï¡_blk
[
h—d_šdex
]->
¡©e
 !ğ
WAIT_ERASE_BLOCK
) &&

5301 (
dev
->
Ï¡_blk
[
h—d_šdex
]->
¡©e
 !ğ
COLD_BLOCK_LIST
)) {

5302 
	`shªnÚ_”r
("last_blk=%d should be wait_erase_blk, but state=%d, head_index=%d, valid_pages=%d,‚ext_sb=%d.\n",

5303 
dev
->
Ï¡_blk
[
h—d_šdex
]->
sb_šdex
, dev->Ï¡_blk[h—d_šdex]->
¡©e
, head_index,

5304 
	`shªnÚ_©omic_»ad
(&
dev
->
Ï¡_blk
[
h—d_šdex
]->
v®id_·ges
), dev->Ï¡_blk[h—d_šdex]->
Ãxt_sb
);

5305 
	`£t_»cov”_¡©e_d—d
(
dev
);

5306 
d—d
;

5308 
	`»move_sb_äom_some_li¡
(
dev
, dev->
Ï¡_blk
[
h—d_šdex
]);

5309 
dev
->
Ï¡_blk
[
h—d_šdex
]->
¡©e
 = 
Ï¡_blk_¡©e
[head_index];

5311 !
	`shªnÚ_li¡_em±y
(&
dev
->
wa™_”a£d
)) {

5312 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
dev
->
wa™_”a£d
, 
shªnÚ_sb
, 
li¡
);

5313 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

5314 
dev
->
wa™_”a£d_blkút
--;

5315 
	`shªnÚ_©omic_šc
(&
dev
->
”a£_dummy_dÚe
);

5316 
	`”a£_su³r_block
(
dev
, 
sb
, 0, 1);

5318 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
dev
->
”a£_dummy_dÚe_ev’t
,

5319 
	`shªnÚ_©omic_»ad
(&
dev
->
”a£_dummy_dÚe
) == 0);

5323 
h—d_šdex
 = 0; head_index < 2; head_index++) {

5324 
dev
->
wr_sb
[
h—d_šdex
] = -1;

5325 
dev
->
aùive_blk
[
h—d_šdex
] = 
NULL
;

5327 
h—d_šdex
 = 0; h—d_šdex < 
dev
->
h—d_couÁ
; head_index++) {

5328 
	`debugs3
("%s: Now w¡¬ˆtØ»cov”haùiv% block >>>\n", 
dev
->
sdisk
.
disk_Çme
, (
h—d_šdex
 =ğ
HOT_INDEX
)?"hot":"cold");

5329 ià(
dev
->
Ï¡_blk
[
h—d_šdex
]) {

5330 ià(
dev
->
Ï¡_blk
[
h—d_šdex
]->
¡©e
 =ğ
u£d_blk_¡©e
[head_index]) {

5331 
	`shªnÚ_li¡_d–_š™
(&
dev
->
Ï¡_blk
[
h—d_šdex
]->
li¡
);

5332 
dev
->
u£d_blkút
[
h—d_šdex
]--;

5333 
dev
->
Ï¡_blk
[
h—d_šdex
]->
¡©e
 = 
Ï¡_blk_¡©e
[head_index];

5335 
dev
->
wr_sb
[
h—d_šdex
] = dev->
Ï¡_blk
[h—d_šdex]->
Ãxt_sb
;

5337 
dev
->
wr_sb
[
h—d_šdex
] = dev->
v”y_š™Ÿl_sblk
[head_index];

5340 ià(
dev
->
wr_sb
[
h—d_šdex
] > dev->
sb_couÁ
) {

5341 
	`shªnÚ_”r
("active blk index is beyond superblock counts. head_index=%d,‡ctive_blk=%d, sb_count=%d.\n",

5342 
h—d_šdex
, 
dev
->
wr_sb
[h—d_šdex], dev->
sb_couÁ
);

5343 
	`£t_»cov”_¡©e_d—d
(
dev
);

5344 
d—d
;

5347 
dev
->
aùive_blk
[
h—d_šdex
] = &dev->
sbs
[dev->
wr_sb
[head_index]];

5348 
dev
->
aùive_blk
[
h—d_šdex
]->
¡©e
) {

5349 
WAIT_COPY_BLOCK
:

5350 
WAIT_ERASE_BLOCK
:

5351 
RECOVER_ERR_BLOCK
:

5352 
	`shªnÚ_w¬n
("active_blk head_index=%d, sb=%d, state=%d.\n",

5353 
h—d_šdex
, 
dev
->
wr_sb
[h—d_šdex], dev->
aùive_blk
[h—d_šdex]->
¡©e
);

5354 
FREE_BLOCK
:

5355 
	`»move_sb_äom_some_li¡
(
dev
, dev->
aùive_blk
[
h—d_šdex
]);

5358 
	`shªnÚ_”r
("sb_index=%d should be‡ctive block, but its state=%d.\n",

5359 
dev
->
aùive_blk
[
h—d_šdex
]->
sb_šdex
, dev->aùive_blk[h—d_šdex]->
¡©e
);

5360 
	`£t_»cov”_¡©e_d—d
(
dev
);

5361 
d—d
;

5363 
dev
->
aùive_blk
[
h—d_šdex
]->
¡©e
 = 
aùive_blk_¡©e
[head_index];

5364 
dev
->
aùive_blk
[
h—d_šdex
]->head_index = head_index;

5366 
dev
->
aùive_blk
[
h—d_šdex
]->
•og
 = 
	`•og_®loc
(dev->aùive_blk[h—d_šdex]->
•og_size
, dev);

5367 ià(
dev
->
aùive_blk
[
h—d_šdex
]->
•og
 =ğ
NULL
) {

5368 
	`shªnÚ_”r
("Can't‡llocateƒnough memory forƒpilog.\n");

5369 
d—d
;

5372 ià(
dev
->
aùive_blk
[
h—d_šdex
]->
Ãxt_sb
 !ğ
INVALID_SB_INDEX
) {

5373 
shªnÚ_sb
 *
Ãxt_sb
 = 
dev
->
sbs
 + dev->
aùive_blk
[
h—d_šdex
]->next_sb;

5374 ià(
Ãxt_sb
->
¡©e
 !ğ
FREE_BLOCK
)

5375 
	`shªnÚ_w¬n
("head_index=%d,‚ext_sb=%d, state=%d.\n",

5376 
h—d_šdex
, 
Ãxt_sb
->
sb_šdex
,‚ext_sb->
¡©e
);

5377 
	`»move_sb_äom_some_li¡
(
dev
, 
Ãxt_sb
);

5378 
Ãxt_sb
->
¡©e
 = 
Ãxt_blk_¡©e
[
h—d_šdex
];

5379 
Ãxt_sb
->
h—d_šdex
 = head_index;

5380 
Ãxt_sb
->
•og
 = 
	`•og_®loc
Òext_sb->
•og_size
, 
dev
);

5381 ià(
Ãxt_sb
->
•og
 =ğ
NULL
)

5382 
	`£t_»cov”_¡©e_”rÜ
(
dev
);

5386 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
sb
, 
sb_tmp
, &
dev
->
wa™_cİy
, 
li¡
) {

5387 
	`shªnÚ_šfo
("%s: sÿÀsu³¸block %d.\n", 
dev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
);

5388 
	`shªnÚ_©omic_šc
(&
dev
->
»cov”_dÚe
);

5389 ià(
	`sÿn_su³r_block
(
sb
, 0, 0)) {

5390 
	`shªnÚ_©omic_dec
(&
dev
->
»cov”_dÚe
);

5392 
	`shªnÚ_wa™_ev’t
(
dev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&dev->
»cov”_dÚe
) == 0);

5394 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
v®id_·ges
) == 0) {

5395 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

5396 
	`shªnÚ_¥š_lock_bh
(&
dev
->
wa™_cİy_lock
);

5397 
dev
->
wa™_cİy_blkút
--;

5398 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

5399 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_cİy_lock
);

5400 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

5401 
	`shªnÚ_¥š_lock
(&
dev
->
wa™_”a£d_lock
);

5402 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
dev
->
wa™_”a£d
);

5403 
dev
->
wa™_”a£d_blkút
++;

5404 
	`shªnÚ_¥š_uÆock
(&
dev
->
wa™_”a£d_lock
);

5405 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

5409 
dev
->
š™_dÚe
 = 
STAGE_RECOVER_USED_DONE
;

5410 
	`»¡Üe_”a£_couÁ”
(
dev
);

5411 
dev
->
pow”_Ú_jiff›s
 = 
	`g‘_jiff›s
();

5412 
dev
->
pow”_Ú_£cÚds_hi¡Üy
 = dev->
pow”_Ú_£cÚds
;

5413 
h—d_šdex
 = 0; h—d_šdex < 
dev
->
h—d_couÁ
; head_index++) {

5415 
	`shªnÚ_šfo
("%s: s¹„ecov” % aùivsu³¸block.\n", 
dev
->
sdisk
.
disk_Çme
, \

5416 (
h—d_šdex
 =ğ
HOT_INDEX
) ? "hot" : "cold");

5417 
dev
->
wr_group
[
h—d_šdex
] = 0;

5418 
dev
->
lun_š_group
[
h—d_šdex
] = 0;

5419 
dev
->
wr_lun_off£t
[
h—d_šdex
] = dev->
aùive_blk
[h—d_šdex]->
sub_group
[0].
fœ¡_lun_off£t
;

5420 
dev
->
wr_·ge
[
h—d_šdex
] = dev->
wr_logicb
[head_index] = 0;

5421 
dev
->
wr_chunk
[
h—d_šdex
] = 0;

5422 
dev
->
aùive_blk_¡¬t_jiff›s
[
h—d_šdex
] = 
	`g‘_jiff›s
();

5424 
	`shªnÚ_©omic_šc
(&
dev
->
»cov”_dÚe
);

5425 ià(
	`»cov”_aùive_blk
(
dev
, dev->
aùive_blk
[
h—d_šdex
])) {

5426 
	`shªnÚ_”r
("failedo„ecover %s‡ctive blk…age.\n",

5427 (
h—d_šdex
 =ğ
HOT_INDEX
)?"hot":"cold");

5428 
d—d
;

5431 
	`shªnÚ_wa™_ev’t
(
dev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&dev->
»cov”_dÚe
) == 0);

5434 ià(
dev
->
»cov”_¡©e
 =ğ
RECOVER_DEAD
) {

5435 
	`shªnÚ_”r
("%s:„ecov”‡ùive_blk faed.\n", 
dev
->
sdisk
.
disk_Çme
);

5436 
d—d
;

5439 
dev
->
š™_dÚe
 = 
STAGE_RECOVER_ACTIVE_DONE
;

5440 
	`shªnÚ_šfo
("recover‡ctive super blocks done.\n");

5441 ià(
dev
->
¥oŞ
 && dev =ğdev->¥oŞ->
sdevs
[0]) {

5442 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

5443 
shªnÚ_Çme¥aû
 *
ns
 = 
dev
->
¥oŞ
->ns[
i
];

5444 
lun_pba
 
pba
;

5445 ià(!
ns
 ||‚s->
d©a_pba
.
lun_pba
 =ğ0x03fffffà||‚s->
d©a
->
v”siÚ
)

5447 
pba
 = 
ns
->
d©a_pba
;

5448 
ns
->
d©a_pba
.
lun_pba
 = 0x03ffffff;

5449 
	`»cov”_ns_d©a
(
ns
, 
pba
);

5451 
	`shªnÚ_wa™_ev’t
(
dev
->
¥oŞ
->
»cov”_ns_d©a_dÚe_ev’t
,

5452 
	`shªnÚ_©omic_»ad
(&
dev
->
¥oŞ
->
»cov”_ns_d©a_dÚe
) == 0);

5455 ià(
dev
->
ov”Ïp_wr™e
) {

5456 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&((
dev
->
sbs
 + dev->
mbr
.
ov”Ïp_sblk
)->
li¡
)));

5457 
	`shªnÚ_©omic_šc
(&
dev
->
»cov”_dÚe
);

5458 ià(
	`»cov”_ov”Ïp_blk
(
dev
, 0, 
NULL
)) {

5459 
	`shªnÚ_”r
("%s:„ecov” ov”Ï°block faed.\n", 
dev
->
sdisk
.
disk_Çme
);

5460 
	`£t_»cov”_¡©e_d—d
(
dev
);

5461 
d—d
;

5463 
	`shªnÚ_wa™_ev’t
(
dev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&dev->
»cov”_dÚe
) == 0);

5464 ià(
dev
->
»cov”_¡©e
 =ğ
RECOVER_DEAD
) {

5465 
	`shªnÚ_”r
("%s:„ecov” ov”Ï°block beÿmd—d.\n", 
dev
->
sdisk
.
disk_Çme
);

5466 
d—d
;

5469 ià(!
dev
->
»adÚly_»asÚ
)

5470 
	`´•¬e_ov”Ïp_pba
(
dev
);

5471 } ià(
dev
->
ov”Ïp
) {

5472 
shªnÚ_sb
 *
Ş_sb
 = 
	`g‘_Ãw_ä“_sb
(
dev
);

5473 
shªnÚ_ov”Ïp
 *
Ş
 = 
dev
->
ov”Ïp
;

5474 ià(
Ş_sb
 =ğ
NULL
) {

5475 
	`shªnÚ_”r
("%s: faedØg‘ f»block fÜ ov”Ï°wr™e.\n", 
dev
->
sdisk
.
disk_Çme
);

5476 
d—d
;

5479 
Ş_sb
->
¡©e
 = 
OVERLAP_BLOCK
;

5480 
Ş_sb
->
h—d_šdex
 = 
OVERLAP_INDEX
;

5481 
Ş_sb
->
£q_num
 = 
MAX_SEQ_NUM
;

5482 
	`shªnÚ_šfo
("%s: g‘ sb_šdex=%d fÜ ov”Ï°wr™e.\n", 
dev
->
sdisk
.
disk_Çme
, 
Ş_sb
->
sb_šdex
);

5484 
dev
->
ov”Ïp_wr™e
 = 1;

5485 
dev
->
mbr
.
ã©u»_æags
 |ğ
OVERLAP_WRITE
;

5486 
dev
->
mbr
.
ov”Ïp_sblk
 = 
Ş_sb
->
sb_šdex
;

5487 ià(
	`»äesh_mbr_g5
(
dev
, 0) < 0) {

5488 
	`shªnÚ_”r
("%s: faedØ»äesh mb¸fÜ upd©šg ov”Ï°wr™e.\n", 
dev
->
sdisk
.
disk_Çme
);

5489 
d—d
;

5491 
Ş
->
wr_lun
 = 
	`Ãxt_ov”Ïp_lun
(
dev
, 
Ş_sb
, 0);

5492 
Ş
->
wr_chunk
 = 0;

5493 
Ş
->
wr_·ge
 = 0;

5494 
Ş
->
wr_logicb
 = 0;

5495 
Ş
->
wr_¶ªe
 = 0;

5497 ià(!
dev
->
»adÚly_»asÚ
)

5498 
	`´•¬e_ov”Ïp_pba
(
dev
);

5501 ià(!
dev
->
»adÚly_»asÚ
) {

5503 ià(
	`check_ªd_»şaim_sb
(
dev
)) {

5504 
	`shªnÚ_”r
("%s: check‡nd„eşaim blk faed.\n", 
dev
->
sdisk
.
disk_Çme
);

5505 
	`£t_»cov”_¡©e_d—d
(
dev
);

5506 
d—d
;

5509 
	`shªnÚ_šfo
("%s: % i »adÚly, Cªˆcheck‡nd„eşaim sb.\n", 
__func__
, 
dev
->
sdisk
.
disk_Çme
);

5511 ià(
dev
->
¥oŞ
)

5512 
dev
->
max_£ùÜs
 = 
	`ÿlcuÏ‹_physiÿl_ÿ·c™y
(dev);

5514 
	`shªnÚ_b¬r›r
();

5515 
dev
->
š™_dÚe
 = 
STAGE_RECOVER_DONE
;

5516 
	`debugs3
("Recoverhe‡ctive blocks done. <<<\n");

5518 ià(
dev
->
»cÚfig_suµÜt
 == 0) {

5519 
	`»ad_£u_šfo
(
dev
);

5521 
dev
->
£u_üc_”rÜ
 = 0;

5522 
dev
->
£u_ecc_”rÜ
 = 0;

5525 ià(
dev
->
ä“_blkút
 <ğ
GC_THRESHOLD_N1L
)

5526 
dev
->
gc_th»ad_¡©e
 = 
IN_GC_STATE
;

5529 
	`debug_´št
("HOT: sb=%d,†un=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

5530 
dev
->
wr_sb
[0], dev->
wr_lun_off£t
[0], dev->
wr_chunk
[0], dev->
wr_¶ªe
[0], dev->
wr_·ge
[0], dev->
wr_logicb
[0]);

5531 
	`debug_´št
("COLD: sb=%d,†un=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

5532 
dev
->
wr_sb
[1], dev->
wr_lun_off£t
[1], dev->
wr_chunk
[1], dev->
wr_¶ªe
[1], dev->
wr_·ge
[1], dev->
wr_logicb
[1]);

5534 #ifdeà
CONFIG_SHANNON_PLVERIFY


5535 
	`shªnÚ_mem£t
(
dev
->
boÙšg_wa™_”a£d
, 0xFF, (dev->booting_wait_erased));

5536 
i
 = 0;

5537 
	`shªnÚ_¥š_lock_bh
(&
dev
->
wa™_”a£d_lock
);

5538 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sb
, &
dev
->
wa™_”a£d
, 
li¡
) {

5539 
dev
->
boÙšg_wa™_”a£d
[
i
++] = 
sb
->
sb_šdex
;

5540 ià(
i
 =ğ
	`ARRAY_SIZE
(
dev
->
boÙšg_wa™_”a£d
))

5543 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
wa™_”a£d_lock
);

5548 
d—d
:

5549 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

5550 ià(
dev
->
aùive_blk
[
i
] !ğ
NULL
 && dev->aùive_blk[i]->
•og
 != NULL)

5551 
	`sb_ä“_•og
(
dev
->
aùive_blk
[
i
]);

5554 
	}
}

5556 
	$sbs_ş—n_³riod_»ad_dÚe
(
shªnÚ_dev
 *
sdev
)

5558 
i
;

5559 
shªnÚ_sb
 *
sb
;

5561 
i
 = 0; i < 
sdev
->
sb_couÁ
; i++) {

5562 
sb
 = &
sdev
->
sbs
[
i
];

5563 
	`shªnÚ_©omic_£t
(&
sb
->
³riod_»ad_dÚe
, 0);

5566 
sdev
->
³riod_»ad
.
aùive_dÚe
[0] = 0;

5567 
sdev
->
³riod_»ad
.
aùive_dÚe
[1] = 0;

5568 
sdev
->
³riod_»ad
.
Ï¡_blk_dÚe
[0] = 0;

5569 
sdev
->
³riod_»ad
.
Ï¡_blk_dÚe
[1] = 0;

5570 
	}
}

5572 
	$³riod_»ad_di§bË
(
shªnÚ_dev
 *
sdev
)

5574 
sdev
->
³riod_»ad
.
¡©e
 = 
PERIOD_READ_DISABLE
;

5575 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
shªnÚ_³riod_»ad_wq
);

5576 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
³riod_»ad_tim”
);

5577 
sdev
->
³riod_»ad
.
_š‹rv®
 = 0;

5578 
	}
}

5580 
	$do_Ãxt_³riod_»ad
(
shªnÚ_dev
 *
sdev
)

5582 
u32
 
tÙ®_u£d_blkút
;

5583 
u64
 
³riod
 = 
sdev
->
³riod_»ad
.period;

5585 
tÙ®_u£d_blkút
 = 
sdev
->
u£d_blkút
[0] + sdev->used_blkcnt[1] + 2;

5586 ià(
tÙ®_u£d_blkút
 > (
PERIOD_READ_THRESHOLD
 - 1))

5587 
sdev
->
³riod_»ad
.
_š‹rv®
 = (
³riod
 * 
	`g‘_HZ
(è* (
PERIOD_READ_THRESHOLD
 - 1) \

5588 / 
PERIOD_READ_THRESHOLD
è/ (
tÙ®_u£d_blkút
 + 2);

5590 
sdev
->
³riod_»ad
.
_š‹rv®
 = 
³riod
 * 
	`g‘_HZ
(è/ 
PERIOD_READ_THRESHOLD
;

5591 
	`shªnÚ_mod_tim”
(&
sdev
->
³riod_»ad_tim”
, 
	`g‘_jiff›s
(è+ sdev->
³riod_»ad
.
_š‹rv®
);

5592 
	}
}

5594 
	$³riod_»ad_’abË
(
shªnÚ_dev
 *
sdev
)

5596 ià(
sdev
->
sdisk
.
ex™
)

5598 ià(
sdev
->
¶ug_out
)

5600 ià((
sdev
->
³riod_»ad
.
³riod
 <= 0) || \

5601 (
sdev
->
³riod_»ad
.
µa
 < 0) || \

5602 (
sdev
->
³riod_»ad
.
µa
 >ğsdev->
·ges_š_eblock
 * sdev->
¶ªes
))

5604 ià(
sdev
->
³riod_»ad
.
¡©e
 =ğ
PERIOD_READ_DISABLE
) {

5605 
sdev
->
³riod_»ad
.
¡©e
 = 
PERIOD_READ_ENABLE
;

5606 
sdev
->
³riod_»ad
.
mš_£q_num
 = 0;

5607 
sdev
->
³riod_»ad
.
max_£q_num
 = ~0x0;

5608 
	`sbs_ş—n_³riod_»ad_dÚe
(
sdev
);

5609 
	`do_Ãxt_³riod_»ad
(
sdev
);

5612 
	}
}

5614 
	#DEFAULT_PERIOD_READ_INTERVAL
 (10)

5615 
	`»š™_³riod_»ad
(
shªnÚ_dev
 *
sdev
)

	)

5617 ià((
	gsdev
->
	g³riod_»ad
.
	g³riod
 <= 0) || \

5618 (
sdev
->
³riod_»ad
.
µa
 < 0) || \

5619 (
sdev
->
³riod_»ad
.
µa
 >ğsdev->
·ges_š_eblock
 * sdev->
¶ªes
)) {

5620 
sdev
->
³riod_»ad
.
³riod
 = 
DEFAULT_PERIOD_READ_INTERVAL
 * sdev->
sb_couÁ
;

5621 
	gsdev
->
	g³riod_»ad
.
	gµa
 = 
sdev
->
·ges_š_eblock
 - 1;

5625 
	$ÿn_³riod_»ad
(
shªnÚ_dev
 *
sdev
)

5627 ià(
sdev
->
sdisk
.
ex™
)

5629 ià(
sdev
->
¶ug_out
)

5631 ià(
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
)

5633 ià(
sdev
->
³riod_»ad
.
¡©e
 =ğ
PERIOD_READ_DISABLE
)

5635 ià((
sdev
->
³riod_»ad
.
³riod
 <= 0) || \

5636 (
sdev
->
³riod_»ad
.
µa
 < 0) || \

5637 (
sdev
->
³riod_»ad
.
µa
 >ğsdev->
·ges_š_eblock
 * sdev->
¶ªes
))

5641 
	}
}

5643 
shªnÚ_sb
 *
	$g‘_³riod_»ad_sb
(
shªnÚ_dev
 *
dev
)

5645 
shªnÚ_sb
 *
sb
 = 
NULL
, *
p
, *
aùive_blk
;

5646 
i
;

5647 
u64
 
mš_£q_num
 = ~0x0;

5649 ià((
dev
->
u£d_blkút
[0] == 0) && (dev->used_blkcnt[1] == 0))

5650 
g‘_aùive_blk
;

5651 ià(
dev
->
³riod_»ad
.
mš_£q_num
 >ğdev->³riod_»ad.
max_£q_num
)

5652 
g‘_aùive_blk
;

5654 
i
 = 
dev
->
h—d_couÁ
 - 1; i >= 0; i--) {

5655 
	`shªnÚ_¥š_lock_bh
(&
dev
->
u£d_blocks_lock
[
i
]);

5656 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
dev
->
u£d_blocks
[
i
], 
li¡
) {

5657 ià((
	`shªnÚ_©omic_»ad
(&
p
->
³riod_»ad_dÚe
) != 0) || \

5658 (
	`shªnÚ_©omic_»ad
(&
p
->
v®id_·ges
) == 0) || \

5659 (
	`shªnÚ_©omic_»ad
(&
p
->
š_³riod_»ad
) != 0))

5661 ià((
p
->
£q_num
 > 
dev
->
³riod_»ad
.
mš_£q_num
) && \

5662 (
p
->
£q_num
 <ğ
dev
->
³riod_»ad
.
max_£q_num
) && \

5663 (
p
->
£q_num
 < 
mš_£q_num
)) {

5664 
mš_£q_num
 = 
p
->
£q_num
;

5665 
sb
 = 
p
;

5668 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
u£d_blocks_lock
[
i
]);

5671 
g‘_aùive_blk
:

5672 ià(!
sb
) {

5673 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

5674 
aùive_blk
 = 
dev
->
Ï¡_blk
[
i
];

5675 ià(
aùive_blk
 =ğ
NULL
)

5677 ià(!
	`is_Ï¡_blk
(
aùive_blk
)) {

5678 
dev
->
³riod_»ad
.
Ï¡_blk_dÚe
[
i
] = 1;

5681 ià((
	`shªnÚ_©omic_»ad
(&
aùive_blk
->
³riod_»ad_dÚe
) == 0) && \

5682 (
dev
->
³riod_»ad
.
Ï¡_blk_dÚe
[
i
] == 0) && \

5683 (
	`shªnÚ_©omic_»ad
(&
aùive_blk
->
š_³riod_»ad
) == 0)) {

5684 ià(
	`shªnÚ_©omic_»ad
(&
aùive_blk
->
v®id_·ges
) != 0) {

5685 
sb
 = 
aùive_blk
;

5686 
dev
->
³riod_»ad
.
Ï¡_blk_dÚe
[
i
] = 1;

5693 ià(!
sb
) {

5694 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

5695 
aùive_blk
 = 
dev
->aùive_blk[
i
];

5696 ià((
	`shªnÚ_©omic_»ad
(&
aùive_blk
->
³riod_»ad_dÚe
) == 0) && \

5697 (
dev
->
³riod_»ad
.
aùive_dÚe
[
i
] == 0) && \

5698 (
	`shªnÚ_©omic_»ad
(&
aùive_blk
->
š_³riod_»ad
) == 0)) {

5699 ià((
dev
->
wr_chunk
[
i
] > (dev->
³riod_»ad
.
µa
 % dev->
·ges_š_eblock
)) && \

5700 (
	`shªnÚ_©omic_»ad
(&
aùive_blk
->
v®id_·ges
) != 0)) {

5701 
sb
 = 
aùive_blk
;

5702 
dev
->
³riod_»ad
.
aùive_dÚe
[
i
] = 1;

5709  
sb
;

5710 
	}
}

5712 
šlše
 
shªnÚ_sb
 *
	$g‘_Ãw_ä“_sb
(
shªnÚ_dev
 *
dev
)

5714 
shªnÚ_sb
 *
sb
 = 
NULL
;

5716 
__echo_š
;

5717 
	`shªnÚ_¥š_lock_bh
(&
dev
->
ä“_blocks_lock
);

5718 ià(
	`shªnÚ_li¡_em±y
(&
dev
->
ä“_blocks
)) {

5719 
	`shªnÚ_w¬n
("NØmÜä“_block !!! f»e_blkút=%d.\n", 
dev
->
ä“_blkút
);

5720 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
ä“_blocks_lock
);

5721  
NULL
;

5723 
	`BUG_ON
(
dev
->
ä“_blkút
 == 0);

5724 
sb
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
dev
->
ä“_blocks
, 
shªnÚ_sb
, 
li¡
);

5725 
	`shªnÚ_li¡_d–_š™
(&
sb
->
li¡
);

5726 
dev
->
ä“_blkút
--;

5727 ià(
dev
->
ä“_blkút
 =ğ
GC_THRESHOLD_N1L
) {

5728 
	`shªnÚ_¥š_lock_bh
(&
dev
->
gc_¡©e_lock
);

5729 
dev
->
gc_th»ad_¡©e
 = 
IN_GC_STATE
;

5730 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
gc_¡©e_lock
);

5731 ià(
	`lik–y
((
dev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& dev->
gc_th»ad
)) {

5732 
	`shªnÚ_wake_up_´oûss
(
dev
->
gc_th»ad
);

5733 ià(!
	`shªnÚ_tim”_³ndšg
(&
dev
->
gc_tim”
))

5734 
	`shªnÚ_deãr_tim”
(
dev
, 
	`g‘_HZ
() * 10);

5737 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
ä“_blocks_lock
);

5739  
sb
;

5740 
	}
}

5744 
	$g‘_Ãw_hÙ_sb
(
shªnÚ_dev
 *
dev
)

5746 
shªnÚ_sb
 *
sb
;

5748 
sb
 = 
	`g‘_Ãw_ä“_sb
(
dev
);

5749 ià(
sb
) {

5750 
sb
->
•og
 = 
	`•og_®loc
(sb->
•og_size
, 
dev
);

5751 ià(
sb
->
•og
 =ğ
NULL
) {

5752 
	`shªnÚ_w¬n
("Can't‡llocateƒnough memory forƒpilog.\n");

5753 
	`add_sb_to_ä“_li¡
(
dev
, 
sb
);

5754  
INVALID_SB_INDEX
;

5756 
sb
->
¡©e
 = 
NEXT_HOT_BLOCK
;

5757 
sb
->
h—d_šdex
 = 
HOT_INDEX
;

5758  
sb
->
sb_šdex
;

5761  
INVALID_SB_INDEX
;

5762 
	}
}

5766 
	$g‘_Ãw_cŞd_sb
(
shªnÚ_dev
 *
dev
)

5768 
shªnÚ_sb
 *
sb
;

5770 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


5771 
	`BUG_ON
(!
dev
->
u£_du®_h—d
);

5773 
sb
 = 
	`g‘_Ãw_ä“_sb
(
dev
);

5774 ià(
sb
) {

5775 
sb
->
•og
 = 
	`•og_®loc
(sb->
•og_size
, 
dev
);

5776 ià(
sb
->
•og
 =ğ
NULL
) {

5777 
	`shªnÚ_w¬n
("Can't‡llocateƒnough memory forƒpilog.\n");

5778 
	`add_sb_to_ä“_li¡
(
dev
, 
sb
);

5779  
INVALID_SB_INDEX
;

5781 
sb
->
¡©e
 = 
NEXT_COLD_BLOCK
;

5782 
sb
->
h—d_šdex
 = 
COLD_INDEX
;

5783  
sb
->
sb_šdex
;

5786  
INVALID_SB_INDEX
;

5787 
	}
}

5789 
	$g‘_Ãxt_sb
(
shªnÚ_dev
 *
sdev
, 
h—d
)

5791 
sb_šdex
;

5792 
h—d_šdex
 = 
h—d
 & 
HEAD_INDEX_MASK
;

5794 ià(
h—d_šdex
 =ğ
HOT_INDEX
)

5795 
sb_šdex
 = 
	`g‘_Ãw_hÙ_sb
(
sdev
);

5796 ià(
h—d_šdex
 =ğ
COLD_INDEX
)

5797 
sb_šdex
 = 
	`g‘_Ãw_cŞd_sb
(
sdev
);

5799 
	`shªnÚ_”r
("h—d_šdex i unknown. h—d_šdex = %d.\n", 
h—d_šdex
);

5800 
sb_šdex
 = 
INVALID_SB_INDEX
;

5803  
sb_šdex
;

5804 
	}
}

5806 
	$³riod_»ad_sb_ÿÎback
(
shªnÚ_bio
 *
sbio
)

5808 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

5809 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

5810 
shªnÚ_»que¡
 *
»q
, *
tmp
;

5812 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

5813 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

5814 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

5815 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

5816 
»q
->
»cov”_buf
 = 
NULL
;

5818 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
,„eq->
dma_dœ
);

5820 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

5821 
	`ä“_»q
(
»q
);

5824 
	`ä“_sbio
(
sbio
);

5825 
	`shªnÚ_©omic_dec
(&
sb
->
š_³riod_»ad
);

5826 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
sb
->
š_³riod_»ad
) != 0);

5828 
__echo_out
;

5829 
	}
}

5831 
	$³riod_»ad_sb
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
)

5833 
shªnÚ_bio
 *
sbio
;

5834 
shªnÚ_»que¡
 *
»q
;

5835 
sub_group
 *
group
;

5836 
sb_lun_pba
;

5837 
group_šdex
, 
lun
, 
lun_off£t
, 
lun_š_group
;

5838 
µa
;

5839 
u32
 
pba
;

5841 
µa
 = 
sdev
->
³riod_»ad
.ppa;

5842 ià((
µa
 < 0è|| (µ¨>ğ(
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
)))

5845 
__echo_š
;

5847 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

5848 
sbio
->
logicbs
 = 
sdev
->
max_avaabË_groups
 * 
sb
->
mš_avaabË_luns
;

5849 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

5850 
	`£t_sbio_debug_g
(
sbio
, 
READ_LAST_EPILOG_TAG
);

5851 
sbio
->
ÿÎback
 = 
³riod_»ad_sb_ÿÎback
;

5852 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

5853 
sbio
->
d©a
 = 
sb
;

5855 
sb_lun_pba
 = 
sb
->
sb_šdex
 * 
sdev
->
logicbs_š_siblšg_eblock
;

5856 
pba
 = 
sb_lun_pba
 + 
µa
 * 
sdev
->
logicbs_š_·ge
;

5857 
group_šdex
 = 0; group_šdex < 
sdev
->
·r™y_groups
; group_index++) {

5858 
group
 = &
sb
->
sub_group
[
group_šdex
];

5859 ià(
group
->
phy_šdex
 < 0)

5861 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

5862 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

5863 
lun_š_group
 = 0;

5865 ià(
lun_š_group
 =ğ
sb
->
mš_d©a_luns
) {

5866 
lun_off£t
 = 
group
->
·r™y_lun_off£t
;

5867 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

5870 
lun_off£t
 = (lun_off£ˆ+ 1è% 
sdev
->
max_luns_š_group
;

5871 
lun
 = 
group
->
¡¬t_lun
 + 
lun_off£t
;

5872 } 
	`is_bad_lun
(
sb
, 
lun
));

5875 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

5876 
	`£t_»q_debug_g
(
»q
, 
PERIOD_READ_TAG
, 
lun
);

5877 
	`£t_dummy»ad_»q
(
»q
);

5878 
»q
->
İcode
 = 
sh_cmd_»ad
;

5879 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

5880 
»q
->
£nd”
 = 
FROM_PERIOD_READ
;

5881 
»q
->
lba
 = 
LONG_INVALID_LBA
;

5882 
»q
->
pba
.
lun
 =†un;

5883 
»q
->
pba
.
lun_pba
 =…ba;

5884 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

5885 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

5886 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

5887 
»q
->
sbio
 = sbio;

5888 
sdev
->
³riod_»ad
.
blkút
++;

5889 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

5890 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

5891 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

5893 
lun_š_group
++;

5894 } 
lun_off£t
 !ğ
group
->
·r™y_lun_off£t
);

5897 
	`shªnÚ_©omic_šc
(&
sb
->
³riod_»ad_dÚe
);

5899 
	}
}

5901 
	$£t_Ï¡_aùive_blk
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

5903 
shªnÚ_sb
 *
sb
;

5905 ià(
sdev
->
Ï¡_blk
[
h—d_šdex
]) {

5906 
sb
 = 
sdev
->
Ï¡_blk
[
h—d_šdex
];

5907 
	`shªnÚ_¥š_lock_bh
(&
sb
->
lock
);

5908 ià(
sb
->
¡©e
 =ğ
Ï¡_blk_¡©e
[
h—d_šdex
]) {

5909 ià(
	`uÆik–y
(
	`shªnÚ_‹¡_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
))) {

5910 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
”r_blks_lock
);

5911 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
”r_blks
);

5912 
sb
->
¡©e
 = 
ERROR_BLOCK
;

5913 
sdev
->
”r_blkút
++;

5914 
	`check_”r_blkút_šc
(
sdev
);

5915 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
”r_blks_lock
);

5917 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d_šdex
]);

5918 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
sdev
->
u£d_blocks
[
h—d_šdex
]);

5919 
sb
->
¡©e
 = 
u£d_blk_¡©e
[
h—d_šdex
];

5920 
sdev
->
u£d_blkút
[
h—d_šdex
]++;

5921 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
u£d_blocks_lock
[
h—d_šdex
]);

5924 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
lock
);

5925 
sdev
->
Ï¡_blk
[
h—d_šdex
] = 
NULL
;

5928 ià(
sdev
->
aùive_blk
[
h—d_šdex
]) {

5929 
sdev
->
aùive_blk
[
h—d_šdex
]->
Ï¡_şo£d_time¡amp
 = 
	`g‘_jiff›s
();

5930 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
aùive_blk
[
h—d_šdex
]->
lock
);

5931 
sdev
->
Ï¡_blk
[
h—d_šdex
] = sdev->
aùive_blk
[head_index];

5932 
sdev
->
Ï¡_blk
[
h—d_šdex
]->
¡©e
 = 
Ï¡_blk_¡©e
[head_index];

5933 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
aùive_blk
[
h—d_šdex
]->
lock
);

5935 
	}
}

5937 
	$move_to_Ãxt_chunk
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
h—d_šdex
)

5939 
sub_group
 *
group
;

5941 
dev
->
lun_š_group
[
h—d_šdex
]++;

5942 ià(
dev
->
lun_š_group
[
h—d_šdex
] =ğ
sb
->
mš_d©a_luns
) {

5943 
dev
->
lun_š_group
[
h—d_šdex
] = 0;

5945 ià(
	`add_wr_group_pošt
(
dev
, 
sb
, 
h—d_šdex
) < 0) {

5946 
	`£t_Ï¡_aùive_blk
(
dev
, 
h—d_šdex
);

5948 
dev
->
wr_chunk
[
h—d_šdex
] = 0;

5949 
group
 = &
sb
->
sub_group
[
dev
->
wr_group
[
h—d_šdex
]];

5952 
group
 = &
sb
->
sub_group
[
dev
->
wr_group
[
h—d_šdex
]];

5953 } 
group
->
phy_šdex
 < 0);

5954 
dev
->
wr_lun_off£t
[
h—d_šdex
] = 
group
->
fœ¡_lun_off£t
;

5956 
group
 = &
sb
->
sub_group
[
dev
->
wr_group
[
h—d_šdex
]];

5958 
dev
->
wr_lun_off£t
[
h—d_šdex
] = (dev->wr_lun_off£t[h—d_šdex] + 1è% dev->
max_luns_š_group
;

5959 } 
	`is_bad_lun
(
sb
, 
group
->
¡¬t_lun
 + 
dev
->
wr_lun_off£t
[
h—d_šdex
]));

5961 
	}
}

5963 
	$move_to_Ãxt_¶ªe
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
h—d_šdex
)

5965 ià(
dev
->
wr_¶ªe
[
h—d_šdex
] =ğdev->
¶ªes
 - 1) {

5966 
	`move_to_Ãxt_chunk
(
dev
, 
sb
, 
h—d_šdex
);

5967 
dev
->
wr_¶ªe
[
h—d_šdex
] = 0;

5969 
dev
->
wr_¶ªe
[
h—d_šdex
]++;

5971 
	}
}

5973 
	$move_to_Ãxt_·ge
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
h—d_šdex
)

5975 
	`move_to_Ãxt_¶ªe
(
dev
, 
sb
, 
h—d_šdex
);

5976 
dev
->
wr_·ge
[
h—d_šdex
] = dev->
wr_¶ªe
[h—d_šdex] * dev->
·ges_š_eblock
 + dev->
wr_chunk
[head_index];

5977 
	}
}

5979 
	$®loc_lun_pba
(
shªnÚ_dev
 *
dev
, 
u64
 
m‘ad©a
, 
h—d
, 
lun_pba
 *
pba
)

5981 
logicb64_t
 
lba
 = 
m‘ad©a
 & 
LONG_LBA_MASK
;

5982 
h—d_šdex
 = 
h—d
 & 
HEAD_INDEX_MASK
;

5983 
logicb_t
 
eblk_pba
;

5984 
logicb_t
 
sb_pba
;

5985 
shªnÚ_sb
 *
sb
 = 
dev
->
aùive_blk
[
h—d_šdex
];

5986 
sub_group
 *
group
 = &
sb
->sub_group[
dev
->
wr_group
[
h—d_šdex
]];

5987 
u64
 
ns_£q_num
 = (
m‘ad©a
 >> 
NS_SEQ_NUM_SHIFT
è& 
NS_SEQ_NUM_MASK
;

5990 
eblk_pba
 = 
dev
->
wr_·ge
[
h—d_šdex
] * dev->
logicbs_š_·ge
 + dev->
wr_logicb
[head_index];

5991 
pba
->
lun_pba
 = 
dev
->
wr_sb
[
h—d_šdex
] * dev->
logicbs_š_siblšg_eblock
 + 
eblk_pba
;

5992 
pba
->
lun
 = 
group
->
¡¬t_lun
 + 
dev
->
wr_lun_off£t
[
h—d_šdex
];

5993 
sb
->
wr_off£t
++;

5995 ià(!
	`lÚg_lba_is_šv®id
(
lba
è|| 
ns_£q_num
 != 0) {

5996 ià(
dev
->
com·ù_•og
)

5997 
sb_pba
 = 
group
->
phy_šdex
 * 
sb
->
mš_d©a_luns
 * 
dev
->
logicbs_š_siblšg_eblock
 + \

5998 
dev
->
lun_š_group
[
h—d_šdex
] * dev->
logicbs_š_siblšg_eblock
 + 
eblk_pba
;

6000 
sb_pba
 = 
group
->
phy_šdex
 * 
dev
->
max_luns_š_group
 * dev->
logicbs_š_siblšg_eblock
 + \

6001 
dev
->
wr_lun_off£t
[
h—d_šdex
] * dev->
logicbs_š_siblšg_eblock
 + 
eblk_pba
;

6002 
	`•og_£t_m‘ad©a
(
dev
, 
sb
->
•og
, 
sb_pba
, 
m‘ad©a
);

6005 ià(
	`lik–y
(
dev
->
š™_dÚe
 >ğ
STAGE_RECOVER_ACTIVE_DONE
)) {

6006 
	`shªnÚ_©omic_šc
(&
sb
->
š_wr™e_logicbs
);

6009 
dev
->
wr_logicb
[
h—d_šdex
]++;

6010 ià(
dev
->
wr_logicb
[
h—d_šdex
] =ğdev->
logicbs_š_·ge
) {

6011 
	`move_to_Ãxt_·ge
(
dev
, 
sb
, 
h—d_šdex
);

6012 
dev
->
wr_logicb
[
h—d_šdex
] = 0;

6015 
__echo_out
;

6017 
	}
}

	@shannon_g4.c

1 
	$lun_£t_ã©u»_g’”®_g4
(
shªnÚ_dev
 *
sdev
, 
ã©u»_cfg
 *
cfg
)

3 
shªnÚ_lun£t
 *
lun£t
;

4 
shªnÚ_»gi¡”_cmd
 *
£t_ã©u»
;

5 
cmdid
;

6 
u64
 *
d©a
;

7 
i
, 
j
;

9 ià(
cfg
->
v®id
 =ğ
FEATURE_INVALID
)

12 
	`BUG_ON
(
cfg
->
nby‹
 > 
FEATURE_CFG_MAX_DATA
);

13 
j
 = 0; j < 
sdev
->
max_lun_š_lun£t
; j+=sdev->
max_lun_š_û
) {

14 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

15 
lun£t
 = &
sdev
->
lun£ts
[
i
];

16 
cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

17 
£t_ã©u»
 = (
shªnÚ_»gi¡”_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

18 
£t_ã©u»
->
İcode
 = 
sh_cmd_»g_wr™e
;

19 
£t_ã©u»
->
æash_»g
.
æash_addr
 = 
cfg
->
addr
;

20 
£t_ã©u»
->
æash_»g
.
by‹s
 = ((
cfg
->
nby‹
 > 0 && cfg->nbyte <= 4) ? 4: cfg->nbyte);

21 
£t_ã©u»
->
æash_»g
.
æash_cmd
 = 
cfg
->
cmd
;

22 
£t_ã©u»
->
æash_»g
.
phy_lun
 = 
lun£t
->
šdex
 * 
sdev
->
max_lun_š_lun£t
 + 
j
;

23 ià(
cfg
->
misc
 =ğ
VENDOR_MODE
)

24 
£t_ã©u»
->
h—d
 |ğ
VENDOR_MODE_MASK
;

25 ià(
cfg
->
misc
 =ğ
SECOND_ENABLE
)

26 
£t_ã©u»
->
h—d
 |ğ
SECONDARY_CMD_ENABLE_MASK
;

28 
d©a
 = 
	`cmd_queue_šc
(
£t_ã©u»
, 1);

30 
	`shªnÚ_mem_wr™eq
(*((
u64
 *)
cfg
->
d©a
), data);

31 
lun£t
->
sq_h—d
 = (lun£t->sq_h—d + 16è% 
QUEUE_SIZE
;

32 
	`wr™e_»g_§ã
(
sdev
, 
lun£t
->
sq_h—d
, &lun£t->
lun_b¬
->sq_head);

34 
	`shªnÚ_m¦“p
(5);

36 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

37 
lun£t
 = &
sdev
->
lun£ts
[
i
];

38 
lun£t
->
cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->cq_head);

39 
lun£t
->
sq_h—d
 !ğlun£t->
cq_h—d
) {

40 
	`shªnÚ_m¦“p
(1);

41 
lun£t
->
cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->cq_head);

43 
lun£t
->
cq_
 =†un£t->
cq_h—d
;

44 
lun£t
->
cq__tmp
 =†un£t->
cq_h—d
;

45 
lun£t
->
sq_h—d_tmp
 =†un£t->
sq_h—d
;

46 
lun£t
->
sq_hw_h—d
 =†un£t->
sq_h—d
;

47 
lun£t
->
cq_hw_h—d
 =†un£t->
cq_h—d
;

50 
	}
}

52 
	$miüocode_checksum
(
u32
 *
bË
, u32 
Ëngth
, u32 
checksum
)

54 
u32
 
i
;

55 
u32
 
tmp
 = 0;

57 
	`BUG_ON
(
bË
 =ğ
NULL
);

59 
i
 = 0; i < 
Ëngth
; i++)

60 
tmp
 ^ğ
bË
[
i
];

62 
	`debugs1
("rg‘_checksum = 0x%lX cur_checksum = 0x%lX\n", 
checksum
, 
tmp
);

63 ià(
tmp
 =ğ
checksum
)

67 
	}
}

69 
	$g‘_cÚfig_äom_nÜæash
(
shªnÚ_dev
 *
sdev
)

71 
shªnÚ_nÜ_mbr
 
šfo
 = {0};

72 
»t
 = 0;

73 
i
;

75 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
NOR_MBR_ADDR
, (
shªnÚ_nÜ_mbr
), &
šfo
))

76 
çed
;

77 ià(
šfo
.
w©”m¬k
 !ğ
NOR_MBR_MAGIC
)

78 
çed
;

80 ià(
šfo
.
v”siÚ
 == 0) {

81 
	`BUG_ON
(
sdev
->
miüocode_¬¿y
[0].
bË
 !ğ
NULL
);

82 
sdev
->
miüocode_¬¿y
[0].
miüocode_Ëngth
 = 0;

84 ià((
šfo
.
miüocode_addr
 =ğ0è|| (šfo.
miüocode_Ëngth
 == 0)) {

86 
»t
 = -1;

87 
i
 = 0; i < 
	`ARRAY_SIZE
(
suµÜ‹d_ids
); i++) {

88 ià(
šfo
.
æashid
 =ğ
suµÜ‹d_ids
[
i
].flashid) {

89 
sdev
->
miüocode_¬¿y
[0].
bË
 = 
suµÜ‹d_ids
[
i
].
miüocode_bË
;

90 
sdev
->
miüocode_¬¿y
[0].
miüocode_Ëngth
 = 
suµÜ‹d_ids
[
i
].microcode_length;

91 
sdev
->
miüocode_¬¿y
[0].
¡©e
 = 
MICROCODE_VALID_MASK
;

92 
sdev
->
miüocode_¬¿y
[0].
¡¬t_»g
 = 
SH_ADVANCED_READ_OFFSET
;

93 
»t
 = 0;

97 ià(
»t
) {

98 
	`shªnÚ_”r
("Can`t find microcode in driver.ryo„ead config from supported_ids.");

99 
çed
;

103 
sdev
->
miüocode_¬¿y
[0].
bË
 = 
	`shªnÚ_km®loc
(
šfo
.
miüocode_Ëngth
 * (
u32
), 
GFP_SHANNON
);

104 ià(
sdev
->
miüocode_¬¿y
[0].
bË
 =ğ
NULL
)

105 
çed
;

107 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
šfo
.
miüocode_addr
, info.
miüocode_Ëngth
 * (
u32
), sdev->
miüocode_¬¿y
[0].
bË
)) {

108 
	`shªnÚ_kä“
(
sdev
->
miüocode_¬¿y
[0].
bË
);

109 
çed
;

112 
sdev
->
miüocode_¬¿y
[0].
miüocode_Ëngth
 = 
šfo
.microcode_length;

113 ià(
	`miüocode_checksum
(
sdev
->
miüocode_¬¿y
[0].
bË
, sdev->miüocode_¬¿y[0].
miüocode_Ëngth
, 
šfo
.
miüocode_checksum
)) {

114 
	`shªnÚ_”r
("microcode checksum is failed.ryo„ead config from supported_ids.\n");

115 
	`shªnÚ_kä“
(
sdev
->
miüocode_¬¿y
[0].
bË
);

116 
sdev
->
miüocode_¬¿y
[0].
miüocode_Ëngth
 = 0;

117 
çed
;

119 
sdev
->
miüocode_¬¿y
[0].
¡©e
 = (
MICROCODE_VALID_MASK
 | 
MICROCODE_FROM_NOR_MASK
);

120 
sdev
->
miüocode_¬¿y
[0].
¡¬t_»g
 = 
SH_ADVANCED_READ_OFFSET
;

121 
sdev
->
nÜ_mbr_¡©us
 |ğ
MICROCODE_FROM_NORFLASH
;

124 
sdev
->
æashid
 = 
šfo
.flashid;

125 
sdev
->
ifmode
 = 
šfo
.ifmode;

126 
sdev
->
mbr
.
şk
 = 
šfo
.
ifşock
;

127 
sdev
->
äeq_mode
 = 
šfo
.freq_mode;

128 
sdev
->
sh¬ed_·ges
 = 
šfo
.shared_pages;

129 
sdev
->
logicb_shiá
 = 
šfo
.
mbr_logicb_shiá
;

130 
sdev
->
ecc_codewÜds_š_logicb
 = 
šfo
.ecc_codewords_in_logicb;

132 ià(
šfo
.
şo£_block_»ad_couÁ
)

133 
sdev
->
»ad_di¡urb_th»shŞd
 = 
šfo
.
şo£_block_»ad_couÁ
;

134 ià(
šfo
.
İ’_block_»ad_couÁ
)

135 
sdev
->
İ’_block_»ad_di¡urb_th»shŞd
 = 
šfo
.
İ’_block_»ad_couÁ
;

137 
	`shªnÚ_memıy
(
sdev
->
ã©u»_cfg_li¡
, 
šfo
.
ã©u»_¬¿y
, (info.feature_array));

139 
çed
;

142 
	`shªnÚ_šfo
("get config from‚orflash successfully.\n");

143 
sdev
->
nÜ_mbr_¡©us
 |ğ
READ_FROM_NORFLASH
;

146 
çed
:

147 
	`debugs1
("failedo„ead config info in‚orflash.\n");

148 
»t
 = -1;

149 
sdev
->
nÜ_mbr_¡©us
 &ğ~
READ_FROM_NORFLASH
;

150  
»t
;

151 
	}
}

153 
	$chªge_š‹¼u±_što_msi_mode
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
)

155 
»suÉ
;

157 
sdev
->
max_œq_šdex
 = -1;

158 
	`debugs1
("œq=%d.\n", 
	`g‘_pci_œq_num
(
pdev
));

159 
»suÉ
 = 
	`shªnÚ_pci_’abË_msi
(
pdev
);

160 ià(
	`uÆik–y
(
»suÉ
)) {

161 
	`shªnÚ_”r
("cannotƒnable msi.\n");

164 
	`debugs1
("œq=%d.\n", 
	`g‘_pci_œq_num
(
pdev
));

166 
»suÉ
 = 
	`shªnÚ_»que¡_œq
(
	`g‘_pci_œq_num
(
pdev
), "shªnÚ", 
sdev
);

167 ià(
	`uÆik–y
(
»suÉ
)) {

168 
	`shªnÚ_”r
("request interrupt failed.\n");

169 
	`shªnÚ_pci_di§bË_msi
(
pdev
);

173 
sdev
->
š‹¼u±_¬g
[0].
dwÜd_šdex
 = -1;

174 
sdev
->
š‹¼u±_¬g
[0].sdev = sdev;

175 
	`shªnÚ_š™_wÜk
(&
sdev
->
š‹¼u±_¬g
[0].
»pŞl_wÜk
, 
shªnÚ_»pŞl_sk
);

176 
	`shªnÚ_š™_¹_wÜk
(&
sdev
->
š‹¼u±_¬g
[0].
¹_»pŞl_wÜk
, 
shªnÚ_¹_»pŞl_sk
);

177 
	`shªnÚ_skËt_š™
(&
sdev
->
comp_skËt
[0], 
com¶‘iÚ_skËt
, ()(&sdev->
š‹¼u±_¬g
[0]));

180 
	}
}

182 
	$shªnÚ_di§bË_msi
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
)

184 
	`shªnÚ_ä“_œq
(
	`g‘_pci_œq_num
(
pdev
), 
sdev
);

185 
	`shªnÚ_pci_di§bË_msi
(
pdev
);

186 
	}
}

188 
	$shªnÚ_š™_h¬dw¬e_g4
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_pci_dev_t
 *
pdev
)

190 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
;

192 
sdev
->
mbr_eblocks
 = 4;

194 
lun_£ùiÚ
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)
sdev
->
b¬
 + 256);

196 ià(
	`g‘_cÚfig_äom_nÜæash
(
sdev
)) {

197 
sdev
->
logicb_shiá
 = 
MBR_LOGICB_SHIFT
;

198 
sdev
->
ecc_codewÜds_š_logicb
 = 1;

200 
sdev
->
logicb_size
 = 1 << sdev->
logicb_shiá
;

202 
	`g‘_ecc_codewÜd_size
(
sdev
);

203 
	`š™_glob®_cÚfig_»gs_fÜ_æashid
(
sdev
);

204 
	`dump_b¬_¥aû
(
sdev
);

206 
	`ş—r_ªd_di§bË_š‹¼u±
(
sdev
);

207 
	`shªnÚ_di§bË_œq
(
	`g‘_pci_œq_num
(
pdev
));

208 
	`»£t_®l_lun£t
(
sdev
, 
lun_£ùiÚ
);

210 ià(
	`d‘eù_æashid
(
sdev
, 
lun_£ùiÚ
) < 0) {

211 
	`shªnÚ_”r
("can't„ead flashid or flashid isn't supported.\n");

214 
	`ş—r_ªd_di§bË_š‹¼u±
(
sdev
);

216 ià((
sdev
->
h¬dw¬e_v”siÚ
 >ğ5è&& (sdev->
miüocode_¬¿y
[0].
miüocode_Ëngth
 > 0)) {

217 
	`wr™e_advªûd_»ad_miüocode
(
sdev
, 0);

218 
sdev
->
advªûd_»ad_¡©e
 |ğ
ADV_READ_SUPPORT_MASK
;

221 
sdev
->
advªûd_»ad_¡©e
 &ğ~
ADV_READ_SUPPORT_MASK
;

223 ià(
	`®loc_lun£ts_¡ruùu»
(
sdev
) < 0) {

224 
	`shªnÚ_”r
("cannot‡llocate†unsets structure.\n");

228 
	`»bud_®l_ã©u»_cfg
(
sdev
);

229 
	`lun_£t_®l_ã©u»_w™h_´io
(
sdev
, 0);

231 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

232 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, sdev->
ifmode
);

233 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

234 
	`shªnÚ_m¦“p
(2);

235 
	`lun_£t_®l_ã©u»_w™h_´io
(
sdev
, 1);

237 ià(
	`dev_is_8639_w™h_§ndisk
(
sdev
)) {

238 
	`£t_şk
(
sdev
, 
CLK_166M
 + 1);

239 
	`lun_£t_ã©u»_ov”_drive
(
sdev
, 4);

240 
	`lun_£t_ã©u»_odt
(
sdev
);

243 ià(
	`d‘eù_commÚ_šfo
(
sdev
) < 0) {

244 
	`shªnÚ_”r
("cannot„ead mbr.\n");

245 
»Ëa£_lun£ts
;

247 
	`check_u£r_logicb_size
(
sdev
);

249 
	`shªnÚ_šfo
("%s: fÏsh id: %16.16Îx\n", 
sdev
->
cdev_Çme
, sdev->
æashid
);

250 
	`shªnÚ_šfo
("%s: ifmode: %d, ov”drive: %d, f»qmode: %d\n", 
sdev
->
cdev_Çme
, sdev->
ifmode
, sdev->
ov”drive
, sdev->
äeq_mode
);

254 
»Ëa£_lun£ts
:

255 
	`»Ëa£_lun£ts_¡ruùu»
(
sdev
);

258 
	}
}

261 #ià
defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

262 
	$shªnÚ_š™_emu_h¬dw¬e_g4
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun_b¬
 **
lun_£ùiÚ
)

264 
i
 = 0;

266 
sdev
->
logicb_shiá
 = 
MBR_LOGICB_SHIFT
;

267 
sdev
->
logicb_size
 = 1 << sdev->
logicb_shiá
;

268 
sdev
->
ecc_codewÜds_š_logicb
 = 1;

269 
sdev
->
¿id5_suµÜ‹d
 = 
RAID5_SUPPORTED
;

270 
sdev
->
rÙ©e_·r™y
 = 
ROTATE_PARITY
;

271 
sdev
->
ecc_by·ss
 = 
ECC_BYPASS
;

273 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

274 
emu_luns
[
i
].
logicb_size
 = 
sdev
->logicb_size;

275 
emu_luns
[
i
].
logicb_shiá
 = 
sdev
->logicb_shift;

276 
emu_luns
[
i
].
logicbs_š_·ge
 = 1;

278 
sdev
->
max_chªÃls
 = 
emu_luns
[0].max_channels;

279 
sdev
->
max_lun£t_š_chªÃl
 = 
emu_luns
[0].max_lunset_in_channel;

280 
sdev
->
max_lun_š_lun£t
 = 
emu_luns
[0].
hw_lun_š_lun£t
;

281 
sdev
->
lun£t_couÁ
 = sdev->
max_lun£t_š_chªÃl
 * sdev->
max_chªÃls
;

283 *
lun_£ùiÚ
 = 
	`shªnÚ_kz®loc
((**lun_£ùiÚè* 
MBR_MAX_TRY
, 
GFP_SHANNON
);

284 
´eš™_emu_th»ad
 = 
	`shªnÚ_kth»ad_run
(
´eš™_emuÏtÜ_th»ad
, *
lun_£ùiÚ
, "sh_preinit_emu");

286 
	`check_u£r_logicb_size
(
sdev
);

287 
	`ş—r_ªd_di§bË_š‹¼u±
(
sdev
);

290 
	}
}

293 
	$shªnÚ_nÜæash_”a£_g4
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
)

295 
timeout
;

297 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

298 
	`shªnÚ_iowr™e32
(
phyaddr
, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_ERASE_ADDR
);

299 
	`shªnÚ_iowr™e32
(0, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_ERASE_CTRL
);

300 
	`shªnÚ_iowr™e32
(1, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_ERASE_CTRL
);

301 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

303 
timeout
 = 0;

304 !(
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 
NORFLASH_ERASE_CTRL
) & 0x02)) {

305 
	`shªnÚ_ud–ay
(10);

306 ià(
timeout
++ > 
NORFLASH_TIMEOUT
) {

307 
	`shªnÚ_”r
("timeout\n");

310 
	`shªnÚ_cÚd_»sched
();

314 
	}
}

316 
	$shªnÚ_nÜæash_wr™e_g4
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
)

318 
timeout
;

320 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

321 
	`shªnÚ_iowr™e32
(
phyaddr
, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_WRITE_ADDR
);

322 
	`shªnÚ_iowr™e32
(0, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_WRITE_CTRL
);

323 
	`shªnÚ_iowr™e32
(1, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_WRITE_CTRL
);

324 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

326 
timeout
 = 0;

327 !(
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 
NORFLASH_WRITE_CTRL
) & 0x02)) {

328 
	`shªnÚ_ud–ay
(10);

329 ià(
timeout
++ > 
NORFLASH_TIMEOUT
) {

330 
	`shªnÚ_”r
("timeout\n");

336 
	}
}

338 
	$shªnÚ_nÜæash_»ad_g4
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
, u32 
xãr_size
)

340 
timeout
;

342 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

343 
	`shªnÚ_iowr™e32
(
phyaddr
, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_READ_ADDR
);

344 
	`shªnÚ_iowr™e32
(
xãr_size
, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_READ_LENGTH
);

345 
	`shªnÚ_iowr™e32
(0, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_READ_CTRL
);

346 
	`shªnÚ_iowr™e32
(1, (
u32
 *)
sdev
->
b¬
 + 
NORFLASH_READ_CTRL
);

347 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

349 
timeout
 = 0;

350 !(
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 
NORFLASH_READ_CTRL
) & 0x02)) {

351 
	`shªnÚ_ud–ay
(10);

352 ià(
timeout
++ > 
NORFLASH_TIMEOUT
) {

353 
	`shªnÚ_”r
("timeout\n");

359 
	}
}

361 
»ad_¡©ic_bbt
(
shªnÚ_lun
 *
lun
);

362 
	$»ad_bbt_šfo_g4
(
shªnÚ_dev
 *
sdev
)

364 
l
;

366 
l
 = 0;† < 
sdev
->
lun_couÁ
;†++) {

367 ià(!
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
l
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
)) {

368 ià(
sdev
->
lun
[
l
]->
bad
) {

370 
	`£t_Ãw_bad_lun
(
sdev
, sdev->
lun
[
l
]);

372 
	`shªnÚ_©omic_šc
(&
sdev
->
»cov”_dÚe
);

373 
	`»ad_¡©ic_bbt
(
sdev
->
lun
[
l
]);

376 
	`debugs1
("lun=%d,…hy_lun_num=%d i physiÿÎy bad.\n", 
l
, 
sdev
->
lun
[l]->
phy_lun_num
);

378 
	`shªnÚ_wa™_ev’t
(
sdev
->
»cov”_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
»cov”_dÚe
) == 0);

380 
	}
}

382 
	$ª®yze_bbt_šfo_g4
(
shªnÚ_dev
 *
sdev
)

384 
u16
* 
bbt
;

385 
i
, 
num
;

386 
b™
 = 0;

388 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

389 
num
 = 0;

390 
bbt
 = 
sdev
->
lun
[
i
]->bbt;

392 ià(
sdev
->
lun
[
i
]->
bad
)

394 ià(
	`bbt_usšg_b™m­
(
bbt
, 
sdev
)) {

395 
	`shªnÚ_fÜ_—ch_£t_b™_Ë
(
b™
, (
u64
 *)
bbt
 + 1, 
sdev
->
eblocks_š_lun
) {

396 ià(
b™
/
sdev
->
¶ªes
 >ğsdev->
sb_couÁ
) {

397 
	`shªnÚ_”r
("b™m­:WrÚg badblock‚umb”:†un=%d, badblock=%d.\n", 
i
, 
b™
);

399 ià(!
	`is_bad_block_dev
(
sdev
, 
i
, 
b™
/sdev->
¶ªes
))

400 
	`m¬k_bad_block_dev
(
sdev
, 
i
, 
b™
/sdev->
¶ªes
);

401 
	`debugs2
("%s: badblock:†un=%d, badblock=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
i
, 
b™
);

405 
bbt
[
num
] != 0xFFFF) {

406 ià(
bbt
[
num
]/
sdev
->
¶ªes
 >ğsdev->
sb_couÁ
) {

407 
	`shªnÚ_”r
("bbt:WrÚg badblock‚umb”:†un=%d, badblock=%d.\n", 
i
, 
bbt
[
num
]);

409 ià(!
	`is_bad_block_dev
(
sdev
, 
i
, 
bbt
[
num
]/sdev->
¶ªes
))

410 
	`m¬k_bad_block_dev
(
sdev
, 
i
, 
bbt
[
num
]/sdev->
¶ªes
);

411 
	`debugs2
("%s: badblock:†un=%d, badblock=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
i
, 
bbt
[
num
]);

413 
num
++;

417 
	}
}

419 
	$lun_upd©e_poŞ_šfo_ÿÎback
(
shªnÚ_bio
 *
sbio
)

421 
shªnÚ_lun
 *
lun
 = (shªnÚ_luÀ*)
sbio
->
d©a2
;

422 
lun
->
upd©e_poŞ_šfo_dÚe
 = 1;

423 
	`shªnÚ_wake_up
(&
lun
->
upd©e_poŞ_šfo_dÚe_ev’t
);

424 
	}
}

427 
	$lun_upd©e_poŞ_šfo
(
shªnÚ_lun
 *
lun
, 
shªnÚ_bio
 *
sbio
)

429 
shªnÚ_»que¡
 *
»q
, *
tmp
;

430 
¡¬t_pba
, 
cu¼’t_·ge
, 
eblk
, 
addr_off£t
 = 0;

431 
shªnÚ_dev
 *
sdev
 = (*)
sbio
->
d©a
;

432 
	`shªnÚ_mu‹x_lock
(&
lun
->
»äesh_£m
);

433 ià(
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
è> 
LUN_REFRESH_MBR_THRESHOLD
) {

434 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
»äesh_£m
);

435 
	`lun_»äesh_mbr_eblks_sync
(
lun
);

438 
sbio
->
d©a2
 = 
lun
;

439 
cu¼’t_·ge
 = 
	`shªnÚ_©omic_»ad
(&
lun
->
Ãxt_em±y_·ge
);

440 
	`shªnÚ_©omic_šc
(&
lun
->
Ãxt_em±y_·ge
);

441 
eblk
 = 0;ƒblk < 
sdev
->
mbr_eblocks
;ƒblk++) {

442 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
sdev
->
logicbs_š_·ge
);

443 
¡¬t_pba
 = 
eblk
 * 
sdev
->
·ges_š_eblock
 * sdev->
logicbs_š_·ge
 +

444 
cu¼’t_·ge
 * 
sdev
->
logicbs_š_·ge
;

445 
addr_off£t
 = 0;

446 
tmp
 = 
NULL
;

447 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

448 
»q
->
pba
.
lun
 =†un->
lun_num
;

449 
»q
->
pba
.
lun_pba
 = 
¡¬t_pba
++;

450 
»q
->
vœt_addr
 = 
sbio
->vœt_add¸+ 
addr_off£t
;

451 
»q
->
dma_add»ss
 = 
sbio
->dma_add»s + 
addr_off£t
;

452 
addr_off£t
 +ğ
sdev
->
logicb_size
;

454 ià(!
tmp
) {

455 
tmp
 = 
»q
;

456 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

458 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
tmp
->chunk_list);

461 
lun
->
upd©e_poŞ_šfo_dÚe
 = 0;

462 
	`shªnÚ_mu‹x_lock
(&
lun
->
lun£t
->
sq_£m
);

463 
	`__shªnÚ_wr™e_cmd
(
lun
->
lun£t
, 
tmp
);

464 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
lun£t
->
sq_£m
);

465 
	`upd©e_lun£t_sq_h—d
(
lun
->
lun£t
);

466 
	`shªnÚ_wa™_ev’t
(
lun
->
upd©e_poŞ_šfo_dÚe_ev’t
,†un->
upd©e_poŞ_šfo_dÚe
 != 0);

468 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
»äesh_£m
);

469 
	}
}

471 
shªnÚ_bio
 *
	$´•¬e_upd©e_poŞ_šfo
(
shªnÚ_dev
 *
sdev
)

473 
shªnÚ_bio
 *
sbio
;

474 
shªnÚ_»que¡
 *
»q
;

475 
shªnÚ_poŞ
 *
¥oŞ
 = 
sdev
->spool;

476 
i
;

477 
wr™e_size
 = 
sdev
->
Çnd_·ge_ÿ·c™y
;

478 *
±r
;

480 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

481 
	`£t_sbio_debug_g
(
sbio
, 
ADD_BBT_POOL_INFO_TAG
);

482 
sbio
->
logicbs
 = 
sdev
->
logicbs_š_·ge
;

483 
sbio
->
ÿÎback
 = 
lun_upd©e_poŞ_šfo_ÿÎback
;

484 
»Œy
:

485 
sbio
->
vœt_addr
 = 
	`shªnÚ_kz®loc
(
wr™e_size
, 
GFP_SHANNON
);

486 ià(
sbio
->
vœt_addr
 =ğ
NULL
) {

487 
	`shªnÚ_m¦“p
(5);

488 
»Œy
;

490 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

491 
±r
 = 
sbio
->
vœt_addr
;

492 
	`cİy_poŞ_šfo
(
±r
, 
¥oŞ
->
poŞ_šfo
);

493 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

494 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

495 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

496 
	`£t_»q_debug_g
(
»q
, 
ADD_BBT_POOL_INFO_TAG
, 
i
);

497 
»q
->
İcode
 = 
sh_cmd_wr™e
;

498 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

499 
»q
->
h—d
 = 
MBR_HEAD
;

500 
»q
->
d©©y³
 = 
SHORT_LBA
;

501 
»q
->
lba
 = 
POOL_INFO_METADATA
;

502 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
è| (»q->
lba
 & 
LONG_LBA_MASK
);

503 
»q
->
sbio
 = sbio;

504 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

506  
sbio
;

507 
	}
}

510 
	$upd©e_poŞ_šfo_g4
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_poŞ
 *
¥oŞ
)

512 
shªnÚ_»que¡
 *
»q
, *
tmp
;

513 
shªnÚ_bio
 *
sbio
;

514 
shªnÚ_lun
 *
lun
;

515 
i
;

517 
sbio
 = 
	`´•¬e_upd©e_poŞ_šfo
(
sdev
);

519 
sbio
->
d©a
 = 
sdev
;

520 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
,

521 
sdev
->
Çnd_·ge_ÿ·c™y
, 
SHANNON_DMA_TODEVICE
);

522 
i
 = 0; i < 
POOL_INFO_LUNS
; i++) {

523 
lun
 = 
sdev
->lun[
i
];

524 ià(
	`is_¡©ic_bad_lun
(
sdev
, 
lun
->
lun_num
è&& (lun->
bad
 =ğ0è&& (lun->
phy_lun_num
 != 0))

526 
	`lun_upd©e_poŞ_šfo
(
sdev
->
lun
[
i
], 
sbio
);

528 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
,

529 
sdev
->
Çnd_·ge_ÿ·c™y
, 
SHANNON_DMA_TODEVICE
);

531 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

532 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

533 
	`ä“_»q
(
»q
);

536 
	`shªnÚ_kä“
(
sbio
->
vœt_addr
);

537 
	`ä“_sbio
(
sbio
);

538 
	}
}

	@shannon_g5.c

1 
ş—n_®l_miüocode_u£d_¡©e
(
shªnÚ_dev
 *
sdev
);

2 
wr™e_advªûd_»ad_miüocode
(
shªnÚ_dev
 *
sdev
, 
num
);

4 
u32
 
shªnÚ_üc32
(
shªnÚ_dev
 *
sdev
, 
u8
 *
d©a
, 
Ën
, u32 
£ed
);

5 
	$should_upd©e_miüocode
(
shªnÚ_dev
 *
sdev
)

7 
rg‘
 = 0;

9 ià(!
	`shªnÚ_dev_is_g5
(
sdev
))

12 
rg‘
 = 
	`g‘_upd©e_miüocode
(
sdev
);

13 ià((
rg‘
 < 0è|| (rg‘ >ğ
MICROCODE_ARRAY_SIZE
))

15 ià(
sdev
->
miüocode_¬¿y
[
rg‘
].
³_cyşe
 == 0)

17 ià(!(
sdev
->
miüocode_¬¿y
[
rg‘
].
¡©e
 & 
MICROCODE_IN_USE_MASK
))

21 
	}
}

23 
	$g‘_upd©e_miüocode
(
shªnÚ_dev
 *
sdev
)

25 
i
;

26 
rg‘
 = -1;

27 
v®id_sbs
 = (
sdev
->
sb_couÁ
 - 
	`shªnÚ_©omic_»ad
(&sdev->
disÿrded_blkút
è- (sdev->
mbr_eblocks
 / sdev->
¶ªes
));

28 
avg_”a£_couÁ
;

30 ià(
v®id_sbs
 == 0)

31  
rg‘
;

33 
avg_”a£_couÁ
 = 
sdev
->
tÙ®_”a£_couÁ
 / 
v®id_sbs
;

34 
i
 = 0; i < 
MICROCODE_ARRAY_SIZE
; i++) {

35 ià(!(
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 & 
MICROCODE_VALID_MASK
))

37 ià(
sdev
->
miüocode_¬¿y
[
i
].
³_cyşe
 == 0)

39 ià((
i
 =ğ
sdev
->
cu¼’t_miüocode_šdex
è&& (!(sdev->
miüocode_¬¿y
[i].
¡©e
 & 
MICROCODE_IN_USE_MASK
)))

40  
sdev
->
cu¼’t_miüocode_šdex
;

41 ià(
sdev
->
miüocode_¬¿y
[
i
].
³_cyşe
 < 
avg_”a£_couÁ
) {

42 ià(
rg‘
 == -1)

43 
rg‘
 = 
i
;

45 ià(
sdev
->
miüocode_¬¿y
[
i
].
³_cyşe
 > sdev->miüocode_¬¿y[
rg‘
].pe_cycle)

46 
rg‘
 = 
i
;

51  
rg‘
;

52 
	}
}

54 
	$g‘_mbr_äom_nÜ
(
shªnÚ_dev
 *
sdev
)

56 
shªnÚ_mbr
 *
mbr
 = 
NULL
;

57 *
buf
 = 
NULL
;

58 
block_size
, 
i
;

59 
u32
 
phyaddr
, 
üc
;

61 
block_size
 = 
NOR_PAGE_SIZE
 * 16;

63 
buf
 = 
	`shªnÚ_vm®loc
(
block_size
);

64 ià(!
buf
) {

65 
	`shªnÚ_”r
("Can‚ot‡llocate memory for„eading mbr.\n");

66  -
ENOMEM
;

68 
	`shªnÚ_mem£t
(
buf
, 0, 
block_size
);

70 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

72 
i
 = 0; i < 2; i++) {

73 
phyaddr
 = (
i
 =ğ0è? 
sdev
->
nÜæash
.
mbr_addr
 : sdev->nÜæash.
mbr_backup_addr
;

74 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
phyaddr
, 
block_size
, 
buf
)) {

75 
	`shªnÚ_w¬n
("»ad mbr% äom NOR FÏsh faed.\n", (
i
 == 0) ? "" : "_backup");

76 ià(
i
 == 1) {

77 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

78 
	`shªnÚ_vä“
(
buf
);

82 
üc
 = *(
u32
*)(
buf
 + 
block_size
 - (crc));

83 ià(
üc
 !ğ
	`shªnÚ_üc32
(
sdev
, 
buf
, 
block_size
 - (crc), 0)) {

84 
	`shªnÚ_w¬n
("CRC check faed fÜ mbr%s.\n", (
i
 == 0) ? "" : "_backup");

85 ià(
i
 == 1) {

86 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

87 
	`shªnÚ_vä“
(
buf
);

93 
mbr
 = (
shªnÚ_mbr
*)
buf
;

94 
	`shªnÚ_šfo
("g‘ mb¸šfÜm©iÚ from NOR FÏsh sucûssfuÎy, mbr_upd©e=%d\n", 
mbr
->
mbr_upd©e
);

95 
	`ª®yze_mbr_šfo
(
sdev
, 
mbr
);

97 
	`shªnÚ_mem£t
(
buf
, 0, 
block_size
);

98 
phyaddr
 = 
sdev
->
nÜæash
.
ã©u»_addr
;

99 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
phyaddr
, 
NOR_PAGE_SIZE
, 
buf
)) {

100 
	`shªnÚ_w¬n
("read features from NOR failed.\n");

101 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

102 
	`shªnÚ_vä“
(
buf
);

105 
üc
 = *(
u32
*)(
buf
 + 
NOR_PAGE_SIZE
 - (crc));

106 ià(
üc
 !ğ
	`shªnÚ_üc32
(
sdev
, 
buf
, 
NOR_PAGE_SIZE
 - (crc), 0)) {

107 
	`shªnÚ_w¬n
("CRC check failed for features.\n");

108 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

109 
	`shªnÚ_vä“
(
buf
);

112 
	`shªnÚ_memıy
(
sdev
->
ã©u»_cfg_li¡
, 
buf
, (sdev->feature_cfg_list));

114 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

116 ià(
	`check_ã©u»_cfg_li¡
(
sdev
)) {

117 
	`shªnÚ_vä“
(
buf
);

121 
	`shªnÚ_vä“
(
buf
);

123 
	}
}

125 
	$ª®yze_nÜæash_miüocode
(
shªnÚ_dev
 *
sdev
, 
miüocode_šfo
 *
šfo
)

127 
i
 = 0;

128 
¬¿y_šdex
 = 0;

129 
miüocode_bË_šfo
 *
bË_šfo
 = 
NULL
;

130 
u32
 
üc
;

131 
u32
 
bË_Ëngth
;

132 
u32
 
bË_üc
;

134 
bË_šfo
 = (
miüocode_bË_šfo
 *)(((*)(&
šfo
->
bË_út
)) + 1);

135 
i
 = 0; i < 
šfo
->
bË_út
; i++) {

136 
	`BUG_ON
(
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
¡©e
 & (
MICROCODE_VALID_MASK
 | 
MICROCODE_IN_USE_MASK
));

137 
	`BUG_ON
(
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
 !ğ
NULL
);

139 ià(
bË_šfo
[
i
].
³_cyşe
 == 0)

142 ià(
bË_šfo
[
i
].
¡¬t_»g
 < 0) {

143 
	`shªnÚ_”r
("microcodeable infoƒrror. index=%d,…e_cycle=%d, start_reg=%d.\n", \

144 
i
, 
bË_šfo
[i].
³_cyşe
,abË_šfo[i].
¡¬t_»g
);

148 
	`BUG_ON
(
bË_šfo
[
i
].
Ëngth
 % (
u32
));

149 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
 = 
	`shªnÚ_kz®loc
(
bË_šfo
[
i
].
Ëngth
, 
GFP_SHANNON
);

150 ià(
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
 =ğ
NULL
) {

151 
	`shªnÚ_”r
("alloc microcodeable memory failed.\n");

152 
çed
;

155 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
bË_šfo
[
i
].
off£t
 * 
NOR_PAGE_SIZE
,abË_šfo[i].
Ëngth
, sdev->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
)) {

156 
	`shªnÚ_”r
("read microcodeable from NOR Flash failed.\n");

157 
	`shªnÚ_kä“
(
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
);

158 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
 = 
NULL
;

159 
çed
;

162 
bË_Ëngth
 = 
bË_šfo
[
i
].
Ëngth
 / (
u32
);

163 
bË_üc
 = (
u32
)
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
[
bË_Ëngth
 - 1];

164 
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
 *)sdev->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
, 
bË_šfo
[
i
].
Ëngth
 - (crc), 0);

165 ià(
üc
 !ğ
bË_üc
) {

166 
	`shªnÚ_”r
("CRC check faed fÜ miüocodbË %d,abË crc=0x%x, c® crc=0x%x.\n", 
i
, 
bË_üc
, 
üc
);

167 
	`shªnÚ_kä“
(
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
);

168 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
 = 
NULL
;

169 
çed
;

172 
	`shªnÚ_šfo
("%s: fšd miüocodbË %d.\n", 
sdev
->
cdev_Çme
, 
¬¿y_šdex
);

173 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
¡©e
 = 
MICROCODE_VALID_MASK
 | 
MICROCODE_FROM_NOR_MASK
;

174 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
³_cyşe
 = 
bË_šfo
[
i
].pe_cycle;

175 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
¡¬t_»g
 = 
bË_šfo
[
i
].start_reg;

176 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
miüocode_Ëngth
 = 
bË_Ëngth
 - ((
üc
è/ (
u32
));

178 
¬¿y_šdex
++;

183 
çed
:

184 
¬¿y_šdex
 -= 1;‡rray_index >= 0;‡rray_index--) {

185 
	`shªnÚ_kä“
(
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
);

186 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
bË
 = 
NULL
;

187 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
¡©e
 = 
MICROCODE_INVALID
;

188 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
³_cyşe
 = 0;

189 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
¡¬t_»g
 = -1;

190 
sdev
->
miüocode_¬¿y
[
¬¿y_šdex
].
miüocode_Ëngth
 = 0;

193 
	}
}

195 
	$g‘_miüocode_äom_nÜ
(
shªnÚ_dev
 *
sdev
)

197 
miüocode_šfo
 *
šfo
 = 
NULL
;

198 
»t
 = 0;

199 
u32
 
üc
;

201 
šfo
 = (
miüocode_šfo
*)
	`shªnÚ_kz®loc
((*šfo), 
GFP_SHANNON
);

202 ià(!
šfo
) {

203 
	`shªnÚ_”r
("Can‚ot‡llocate memory for„eading microcode info.\n");

204  -
ENOMEM
;

207 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

209 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, sdev->
nÜæash
.
miüo_code_addr
, (*
šfo
), info)) {

210 
	`shªnÚ_”r
("read microcode from NOR Flash failed.\n");

211 
»t
 = -1;

212 
out
;

215 
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
 *)
šfo
, (*info) - (crc), 0);

216 ià(
üc
 !ğ
šfo
->crc) {

217 
	`shªnÚ_”r
("CRC check failed for‚orflash microcode.\n");

218 
»t
 = -1;

219 
out
;

222 ià(
šfo
->
bË_út
 > 
MICROCODE_ARRAY_SIZE
) {

223 
	`shªnÚ_šfo
("%s:„e£ˆmiüocodbË couÁØ%d.\n", 
sdev
->
cdev_Çme
, 
MICROCODE_ARRAY_SIZE
);

224 
šfo
->
bË_út
 = 
MICROCODE_ARRAY_SIZE
;

227 
	`shªnÚ_šfo
("%s: g‘ miüocodäom NOR FÏsh sucûssfuÎy\n", 
sdev
->
cdev_Çme
);

228 ià(
	`ª®yze_nÜæash_miüocode
(
sdev
, 
šfo
))

229 
»t
 = -1;

231 
out
:

232 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

233 
	`shªnÚ_kä“
(
šfo
);

235 ià(
»t
 == 0)

236 
sdev
->
nÜ_mbr_¡©us
 |ğ
MICROCODE_FROM_NORFLASH
;

238  
»t
;

239 
	}
}

241 
	$nÜæash_»ad_modify_wr™e
(
shªnÚ_dev
 *
sdev
, 
u32
 
addr
, u32 
Ëngth
, *
d©a
)

243 
blk
, 
begš_blk
, 
’d_blk
, 
·ges_š_block
, 
block_size
;

244 
¤c_off£t
, 
de¡_off£t
, 
cİy_Ëngth
;

245 
u8
 *
bufãr
 = 
NULL
;

246 
»t
 = 0;

249 
·ges_š_block
 = 
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
 / 
NOR_PAGE_SIZE
;

250 
block_size
 = 
·ges_š_block
 * 
NOR_PAGE_SIZE
;

252 
begš_blk
 = 
addr
 / 
NOR_PAGE_SIZE
 / 
·ges_š_block
;

253 
’d_blk
 = (
addr
 + 
Ëngth
 + 
block_size
 - 1) / block_size;

255 
bufãr
 = (
u8
*)
	`shªnÚ_vm®loc
(
block_size
);

256 ià(!
bufãr
) {

257 
	`shªnÚ_”r
("Cannot‡lloc memory for„ead old data in‚or flash.\n");

260 
	`shªnÚ_mem£t
(
bufãr
, 0, 
block_size
);

262 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

264 
¤c_off£t
 = 0;

265 
blk
 = 
begš_blk
; blk < 
’d_blk
; blk++) {

266 ià(
blk
 =ğ
begš_blk
) {

267 
de¡_off£t
 = ((
addr
 / 
NOR_PAGE_SIZE
è- (
begš_blk
 * 
·ges_š_block
)) * NOR_PAGE_SIZE;

268 
cİy_Ëngth
 = 
block_size
 - 
de¡_off£t
;

269 ià(
Ëngth
 < 
cİy_Ëngth
)

270 
cİy_Ëngth
 = 
Ëngth
;

271 } ià(
blk
 =ğ(
’d_blk
 - 1)) {

272 
de¡_off£t
 = 0;

273 
cİy_Ëngth
 = 
Ëngth
 % 
block_size
;

274 ià(
cİy_Ëngth
 == 0)

275 
cİy_Ëngth
 = 
block_size
;

277 
de¡_off£t
 = 0;

278 
cİy_Ëngth
 = 
block_size
;

281 ià((
de¡_off£t
 !ğ0è|| (
cİy_Ëngth
 !ğ
block_size
)) {

282 
u32
 
¡¬t_loff
 = (
de¡_off£t
 + 
NOR_PAGE_SIZE
 - 1) & ~(NOR_PAGE_SIZE - 1);

283 
u32
 
’d_loff
 = (
de¡_off£t
 + 
cİy_Ëngth
è& ~(
NOR_PAGE_SIZE
 - 1);

285 ià(
¡¬t_loff
) {

286 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
blk
 * 
block_size
, 
¡¬t_loff
, 
bufãr
)) {

287 
	`shªnÚ_”r
("çedØ»ad fÜ upd©nÜ fÏsh, blk=%d.\n", 
blk
);

288 
»t
 = -1;

289 
çed
;

293 ià(
’d_loff
 < 
block_size
) {

294 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
blk
 * 
block_size
 + 
’d_loff
, block_siz-ƒnd_loff, 
bufãr
 +ƒnd_loff)) {

295 
	`shªnÚ_”r
("çedØ»ad fÜ upd©nÜ fÏsh, blk=%d.\n", 
blk
);

296 
»t
 = -1;

297 
çed
;

302 ià(
	`shªnÚ_nÜæash_”a£
(
sdev
, 
blk
 * 
block_size
, block_size)) {

303 
	`shªnÚ_”r
("çedØ”a£ fÜ upd©nÜ fÏsh, blk=%d.\n", 
blk
);

304 
»t
 = -1;

305 
çed
;

308 
	`shªnÚ_memıy
(
bufãr
 + 
de¡_off£t
, 
d©a
 + 
¤c_off£t
, 
cİy_Ëngth
);

310 ià(
	`shªnÚ_nÜæash_wr™e
(
sdev
, 
blk
 * 
block_size
, block_size, 
bufãr
)) {

311 
	`shªnÚ_”r
("çedØwr™fÜ upd©nÜ fÏsh, blk=%d.\n", 
blk
);

312 
»t
 = -1;

313 
çed
;

315 
¤c_off£t
 +ğ
cİy_Ëngth
;

316 
Ëngth
 -ğ
cİy_Ëngth
;

319 
çed
:

320 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

322 
	`shªnÚ_vä“
(
bufãr
);

324  
»t
;

325 
	}
}

327 
	$nÜæash_»ad_š_4k_mode
(
shªnÚ_dev
 *
sdev
, 
u32
 
addr
, u32 
Ëngth
, *
d©a
)

329 
begš_·ge
, 
’d_·ge
, 
off£t
;

330 
u32
 
»ad_Ëngth
;

331 *
buf
 = 
NULL
;

333 
begš_·ge
 = 
addr
 / 
NOR_PAGE_SIZE
;

334 
’d_·ge
 = (
addr
 + 
Ëngth
è/ 
NOR_PAGE_SIZE
;

335 
»ad_Ëngth
 = (
’d_·ge
 - 
begš_·ge
 + 1è* 
NOR_PAGE_SIZE
;

336 
off£t
 = 
addr
 - 
begš_·ge
 * 
NOR_PAGE_SIZE
;

338 
buf
 = (
u8
*)
	`shªnÚ_vm®loc
(
»ad_Ëngth
);

339 ià(!
buf
) {

340 
	`shªnÚ_”r
("alloc buffer for„ead‚or in 4k mode failed.\n");

343 
	`shªnÚ_mem£t
(
buf
, 0, 
»ad_Ëngth
);

345 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
begš_·ge
 * 
NOR_PAGE_SIZE
, 
»ad_Ëngth
, 
buf
)) {

346 
	`shªnÚ_”r
("failedo„ead‚or flash.\n");

347 
	`shªnÚ_vä“
(
buf
);

351 
	`shªnÚ_memıy
(
d©a
, 
buf
 + 
off£t
, 
Ëngth
);

353 
	`shªnÚ_vä“
(
buf
);

355 
	}
}

357 
	$nÜæash_wr™e_š_4k_mode
(
shªnÚ_dev
 *
sdev
, 
u32
 
addr
, u32 
Ëngth
, *
d©a
)

359 
begš_·ge
, 
’d_·ge
, 
off£t
;

360 *
buf
 = 
NULL
, *
wr™e_buf
 = NULL;

361 
»t
 = 0;

362 
u32
 
phyaddr
, 
wr™e_Ëngth
;

364 ià(
addr
 % 
NOR_PAGE_SIZE
) {

365 
begš_·ge
 = 
addr
 / 
NOR_PAGE_SIZE
;

366 
’d_·ge
 = (
addr
 + 
Ëngth
è/ 
NOR_PAGE_SIZE
;

367 
off£t
 = 
addr
 - 
begš_·ge
 * 
NOR_PAGE_SIZE
;

368 
wr™e_Ëngth
 = 
off£t
 + 
Ëngth
;

370 
buf
 = 
	`shªnÚ_vm®loc
(
wr™e_Ëngth
);

371 ià(!
buf
) {

372 
	`shªnÚ_”r
("alloc buffer for write‚or in 4k mode failed.\n");

375 
	`shªnÚ_mem£t
(
buf
, 0, 
wr™e_Ëngth
);

377 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
begš_·ge
 * 
NOR_PAGE_SIZE
, NOR_PAGE_SIZE, 
buf
)) {

378 
	`shªnÚ_”r
("failedo„ead‚or flash.\n");

379 
	`shªnÚ_vä“
(
buf
);

383 
	`shªnÚ_memıy
(
buf
 + 
off£t
, 
d©a
, 
Ëngth
);

385 
phyaddr
 = 
begš_·ge
 * 
NOR_PAGE_SIZE
;

386 
wr™e_buf
 = 
buf
;

388 
phyaddr
 = 
addr
;

389 
wr™e_buf
 = 
d©a
;

390 
wr™e_Ëngth
 = 
Ëngth
;

393 ià(
	`nÜæash_»ad_modify_wr™e
(
sdev
, 
phyaddr
, 
wr™e_Ëngth
, 
wr™e_buf
) < 0) {

394 
	`shªnÚ_”r
("write‚or flash in 4k mode failed.\n");

395 
»t
 = -1;

398 ià(
buf
)

399 
	`shªnÚ_vä“
(
buf
);

400  
»t
;

401 
	}
}

403 
	$»äesh_mbr_g5
(
shªnÚ_dev
 *
sdev
, 
ş—n_poŞ
)

405 *
buf
 = 
NULL
;

406 
i
, 
»Œy
 = 0, 
block_size
;

407 
u32
 
phyaddr
, 
üc
;

409 
block_size
 = 
NOR_PAGE_SIZE
 * 16;

411 
buf
 = 
	`shªnÚ_vm®loc
(
block_size
);

412 ià(!
buf
) {

413 
	`shªnÚ_”r
("Cannot‡lloc memory for„efresh mbr.\n");

416 
	`shªnÚ_mem£t
(
buf
, 0, 
block_size
);

418 
sdev
->
mbr
.
mbr_upd©e
++;

420 
	`shªnÚ_memıy
(
buf
, &
sdev
->
mbr
, (
shªnÚ_mbr
));

422 ià(
sdev
->
¥oŞ
 && !
ş—n_poŞ
) {

423 ià((
NOR_PAGE_SIZE
 + (
shªnÚ_poŞ_šfo
)è> (
block_size
 - (
üc
))) {

424 
	`shªnÚ_”r
("sizoàmb¸ªd…oŞ infØtoØlÚg, blk_size=%d.\n", 
block_size
);

425 
	`shªnÚ_vä“
(
buf
);

426 
sdev
->
mbr
.
mbr_upd©e
--;

429 
	`shªnÚ_memıy
(
buf
 + 
NOR_PAGE_SIZE
, 
sdev
->
¥oŞ
->
poŞ_šfo
, (
shªnÚ_poŞ_šfo
));

432 
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
*)
buf
, 
block_size
 - (crc), 0);

433 *((
u32
*)(
buf
 + 
block_size
 - (
üc
))) = crc;

435 
i
 = 0; i < 2; i++) {

436 
	`shªnÚ_šfo
("%s: mbr%s_upd©e=0x%x.\n", 
sdev
->
sdisk
.
disk_Çme
,

437 (
i
 =ğ0è? "": "_backup", 
sdev
->
mbr
.
mbr_upd©e
);

438 
phyaddr
 = (
i
 =ğ0è? 
sdev
->
nÜæash
.
mbr_addr
 : sdev->nÜæash.
mbr_backup_addr
;

440 
»Œy
:

441 ià(
	`nÜæash_»ad_modify_wr™e
(
sdev
, 
phyaddr
, 
block_size
, 
buf
)) {

442 ià(
»Œy
 < 5) {

443 
»Œy
++;

444 
	`shªnÚ_m¦“p
(500);

445 
»Œy
;

447 
	`shªnÚ_”r
("%s:„eäesh MBR% š NOR FÏsh faed.\n", 
sdev
->
sdisk
.
disk_Çme
,

448 (
i
 == 0) ? "": "_backup");

449 ià(
i
 == 1) {

450 
	`shªnÚ_vä“
(
buf
);

455 
	`shªnÚ_©omic_šc
(&
sdev
->
»äesh_mbr_couÁ
);

457 
	`shªnÚ_vä“
(
buf
);

459 
	}
}

461 
	$´e_gc_nÜ_block
(
shªnÚ_dev
 *
sdev
)

463 
nÜ_block
 *
gc_block
 = 
NULL
, *
pblock
;

464 
blk_sz
;

465 
»t
;

466 
gc_dÚe
 = 0;

467 
blk_sz
 = 
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
;

469 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_”a£_nÜ_block_li¡
)) {

470 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
gc_block
, 
pblock
, &
sdev
->
wa™_”a£_nÜ_block_li¡
, 
li¡
) {

471 
	`shªnÚ_li¡_d–
(&
gc_block
->
li¡
);

472 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

473 
»t
 = 
	`shªnÚ_nÜæash_”a£
(
sdev
, sdev->
nÜæash
.
bbt_addr
 + 
gc_block
->
šdex
 * 
blk_sz
, blk_sz);

474 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

475 ià(
»t
) {

476 
	`shªnÚ_”r
("´e-gø”a£‚Üæashƒ¼Ü: block=%d.\n", 
gc_block
->
šdex
);

477 
gc_block
->
¡©e
 = 
NOR_BLOCK_ERASE_ERR
;

478 
	`shªnÚ_li¡_add_
(&
gc_block
->
li¡
, &
sdev
->
”a£_”r_nÜ_block_li¡
);

480 
gc_block
->
¡©e
 = 
NOR_BLOCK_FREE
;

481 
	`shªnÚ_li¡_add_
(&
gc_block
->
li¡
, &
sdev
->
ä“_nÜ_block_li¡
);

482 
sdev
->
ä“_nÜ_block_couÁ
++;

483 
	`SHANNON_INIT_LIST_HEAD
(&
gc_block
->
·ge_li¡
);

484 
gc_dÚe
 = 1;

490 ià(
gc_dÚe
)

494 
	}
}

496 
	$g‘_Ãw_nÜ_block
(
shªnÚ_dev
 *
sdev
)

498 
nÜ_block
 *
nblock
;

499 
blk_sz
;

500 
blk_sz
 = 
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
;

502 ià(
sdev
->
ä“_nÜ_block_couÁ
 == 0) {

503 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&
sdev
->
ä“_nÜ_block_li¡
));

504 ià(
	`´e_gc_nÜ_block
(
sdev
) != 0) {

505 
	`debugs2
("No free‚or block‡vailable.\n");

506 
sdev
->
nÜ_bbt_¡©e
 |ğ
BBT_NOR_BLOCK_NO_SPACE
;

511 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sdev
->
ä“_nÜ_block_li¡
));

512 
nblock
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
ä“_nÜ_block_li¡
, 
nÜ_block
, 
li¡
);

513 
	`shªnÚ_li¡_d–_š™
(&
nblock
->
li¡
);

514 
sdev
->
ä“_nÜ_block_couÁ
--;

516 
	`debugs2
("Ãw f»nÜ block=%d.\n", 
nblock
->
šdex
);

518  
nblock
->
šdex
;

519 
	}
}

521 
	$wr™e_Úe_nÜ_·ge
(
shªnÚ_dev
 *
sdev
, 
nÜ_·ge
 *
Åage
)

523 
»t
;

524 
nÜ_block
 *
nblock
, *
pblock
 = 
NULL
;

525 
blk_sz
, 
·ges_³r_block
;

526 
off£t
;

527 
»Œy
 = 0;

529 
blk_sz
 = 
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
;

530 
·ges_³r_block
 = 
blk_sz
 / 
NOR_PAGE_SIZE
;

533 ià(
sdev
->
nÜ_bbt_¡©e
 & 
BBT_NOR_BLOCK_NO_SPACE
) {

534 
	`shªnÚ_w¬n
("% %d: NO s·û fÜ upd©šg bbt.\n", 
__func__
, 
__LINE__
);

538 ià(
sdev
->
pos_·ge
 =ğ
·ges_³r_block
) {

539 
Ãxt_block
;

541 
Ãxt_block
 = 
	`g‘_Ãw_nÜ_block
(
sdev
);

542 ià(
Ãxt_block
 == -1) {

543 
	`debugs1
("cannot get‡‚or block.\n");

547 
sdev
->
pos_block
 = 
Ãxt_block
;

548 
sdev
->
pos_·ge
 = 0;

549 
nblock
 = &
sdev
->
nÜ_blocks
[sdev->
pos_block
];

550 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

551 
nblock
->
¡©e
 = 
NOR_BLOCK_ACTIVE
;

552 
	`SHANNON_INIT_LIST_HEAD
(&
nblock
->
·ge_li¡
);

553 
	`debugs2
("Ãw‡ùivblock: %d.\n", 
nblock
->
šdex
);

555 
nblock
 = &
sdev
->
nÜ_blocks
[sdev->
pos_block
];

557 
off£t
 = 
sdev
->
nÜæash
.
bbt_addr
 + sdev->
pos_block
 * 
blk_sz
 + sdev->
pos_·ge
 * 
NOR_PAGE_SIZE
;

559 
wr™e_agaš
:

560 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

561 
»t
 = 
	`shªnÚ_nÜæash_wr™e
(
sdev
, 
off£t
, 
NOR_PAGE_SIZE
, 
Åage
->
d©a
);

562 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

564 ià(
»t
) {

565 ià(
»Œy
 < 5) {

566 
»Œy
++;

567 
	`shªnÚ_m¦“p
(50);

568 
wr™e_agaš
;

570 
	`shªnÚ_”r
("wr™bbˆš‚Ü fÏsh faed: block=%d,…age=%d.\n", 
sdev
->
pos_block
, sdev->
pos_·ge
);

572 
sdev
->
¡©e
 |ğ
SHN_STATE_ERROR_BIT
;

573 
nblock
->
¡©e
 = 
NOR_BLOCK_WRITE_ERR
;

574 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
wr™e_”r_nÜ_block_li¡
);

575 
sdev
->
pos_block
 = -1;

576 
sdev
->
pos_·ge
 = 
·ges_³r_block
;

580 ià(
Åage
->
šdex
 !ğ
INVALID_NOR_PAGE_INDEX
) {

581 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
Åage
->
li¡
));

582 
pblock
 = &
sdev
->
nÜ_blocks
[
Åage
->
nÜ_block
];

584 
Åage
->
šdex
 = 
sdev
->
pos_·ge
;

585 
Åage
->
nÜ_block
 = 
sdev
->
pos_block
;

587 ià(
pblock
 =ğ
NULL
) {

588 
	`shªnÚ_li¡_add_
(&
Åage
->
li¡
, &
nblock
->
·ge_li¡
);

589 
nblock
->
v®id_·ges
++;

590 } ià(
nblock
 !ğ
pblock
) {

591 
Şd_¡©e
 = 
pblock
->
¡©e
;

593 
	`shªnÚ_li¡_d–_š™
(&
Åage
->
li¡
);

594 
	`shªnÚ_li¡_add_
(&
Åage
->
li¡
, &
nblock
->
·ge_li¡
);

595 
nblock
->
v®id_·ges
++;

597 
pblock
->
v®id_·ges
--;

598 ià(
pblock
->
v®id_·ges
 == 0) {

599 
pblock
->
¡©e
 = 
NOR_BLOCK_WAIT_ERASE
;

600 
	`shªnÚ_li¡_d–
(&
pblock
->
li¡
);

601 
	`shªnÚ_li¡_add_
(&
pblock
->
li¡
, &
sdev
->
wa™_”a£_nÜ_block_li¡
);

602 
	`debugs2
("puˆnÜ blockØwa™ƒ¿£†i¡: block=%d, old_¡©e=%d.\n", 
pblock
->
šdex
, 
Şd_¡©e
);

603 } ià((
pblock
->
¡©e
 !ğ
NOR_BLOCK_WRITE_ERR
è&& (pblock->¡©!ğ
NOR_BLOCK_USED
)) {

604 
pblock
->
¡©e
 = 
NOR_BLOCK_USED
;

605 
	`shªnÚ_li¡_d–
(&
pblock
->
li¡
);

606 
	`shªnÚ_li¡_add_
(&
pblock
->
li¡
, &
sdev
->
u£d_nÜ_block_li¡
);

607 
	`debugs2
("puˆnÜ blockØu£d†i¡: block=%d, old_¡©e=%d, v®id_·ges=%d.\n", 
pblock
->
šdex
, 
Şd_¡©e
,…block->
v®id_·ges
);

611 ià(
sdev
->
pos_·ge
 =ğ(
·ges_³r_block
 - 1)) {

612 ià(
nblock
->
v®id_·ges
 =ğ
·ges_³r_block
) {

613 
nblock
->
¡©e
 = 
NOR_BLOCK_FULL
;

614 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

615 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
fuÎ_nÜ_block_li¡
);

616 
	`debugs2
("puˆnÜ blockØfuÎ†i¡: %d.\n", 
nblock
->
šdex
);

618 
nblock
->
¡©e
 = 
NOR_BLOCK_USED
;

619 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

620 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
u£d_nÜ_block_li¡
);

621 
	`debugs2
("puˆnÜ blockØu£d†i¡: %d.\n", 
nblock
->
šdex
);

625 
sdev
->
pos_·ge
++;

627 
	}
}

629 
	$check_gc_nÜ_block
(
shªnÚ_dev
 *
sdev
)

631 
nÜ_block
 *
gc_block
 = 
NULL
, *
pblock
;

632 
nÜ_·ge
 *
Åage
, *
tmp
;

633 
nÜ_·ge_medŸ
 *
medŸ
;

634 
»t
 = 0;

635 
blk_sz
;

636 
mš_v®id_·ges
 = 65536;

637 
·ges_³r_block
;

639 
blk_sz
 = 
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
;

640 
·ges_³r_block
 = 
blk_sz
 / 
NOR_PAGE_SIZE
;

642 
	`debugs1
("enter.\n");

644 
»check_ä“_block
:

645 ià(
sdev
->
ä“_nÜ_block_couÁ
 <= 1) {

646 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_”a£_nÜ_block_li¡
)) {

647 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
gc_block
, 
pblock
, &
sdev
->
wa™_”a£_nÜ_block_li¡
, 
li¡
) {

648 
	`shªnÚ_li¡_d–
(&
gc_block
->
li¡
);

649 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

650 
»t
 = 
	`shªnÚ_nÜæash_”a£
(
sdev
, sdev->
nÜæash
.
bbt_addr
 + 
gc_block
->
šdex
 * 
blk_sz
, blk_sz);

651 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

652 ià(
»t
) {

653 
	`shªnÚ_”r
("”a£‚Üæash faed: block=%d.\n", 
gc_block
->
šdex
);

654 
gc_block
->
¡©e
 = 
NOR_BLOCK_ERASE_ERR
;

655 
	`shªnÚ_li¡_add_
(&
gc_block
->
li¡
, &
sdev
->
”a£_”r_nÜ_block_li¡
);

658 
gc_block
->
¡©e
 = 
NOR_BLOCK_FREE
;

659 
	`shªnÚ_li¡_add_
(&
gc_block
->
li¡
, &
sdev
->
ä“_nÜ_block_li¡
);

660 
sdev
->
ä“_nÜ_block_couÁ
++;

661 
	`SHANNON_INIT_LIST_HEAD
(&
gc_block
->
·ge_li¡
);

662 
	`debugs2
("nÜ block i ä“: block=%d.\n", 
gc_block
->
šdex
);

664 
»check_ä“_block
;

669 
gc_block
 = 
NULL
;

670 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
pblock
, &
sdev
->
u£d_nÜ_block_li¡
, 
li¡
) {

671 ià(
pblock
->
v®id_·ges
 < 
mš_v®id_·ges
) {

672 
mš_v®id_·ges
 = 
pblock
->
v®id_·ges
;

673 
gc_block
 = 
pblock
;

677 ià((
gc_block
 =ğ
NULL
è|| (
mš_v®id_·ges
 >ğ
·ges_³r_block
)) {

678 ià(
sdev
->
ä“_nÜ_block_couÁ
 == 0) {

679 
sdev
->
nÜ_bbt_¡©e
 |ğ
BBT_NOR_BLOCK_NO_SPACE
;

680 
	`shªnÚ_w¬n
("nor blocks become full.\n");

682 
out
;

685 ià(!
	`shªnÚ_li¡_em±y
(&
gc_block
->
·ge_li¡
)) {

686 
	`debugs2
("gøblock i nÙƒm±y: %d.\n", 
gc_block
->
šdex
);

687 ià((
sdev
->
ä“_nÜ_block_couÁ
 =ğ0è&& (
gc_block
->
v®id_·ges
 > (
·ges_³r_block
 - sdev->
pos_·ge
))) {

688 
sdev
->
nÜ_bbt_¡©e
 |ğ
BBT_NOR_BLOCK_NO_SPACE
;

689 
	`shªnÚ_w¬n
("nor blocks is full. gc cannot go further.\n");

690 
out
;

693 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
Åage
, 
tmp
, &
gc_block
->
·ge_li¡
, 
li¡
) {

694 
medŸ
 = 
Åage
->
d©a
;

695 
medŸ
->
£q_num
 = ++
sdev
->
bbt_£q_num
;

696 
medŸ
->
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
 *)media, (*media) - (media->crc), 0);

697 
»t
 = 
	`wr™e_Úe_nÜ_·ge
(
sdev
, 
Åage
);

698 ià(
»t
) {

699 
	`shªnÚ_”r
("gønÜ blockƒ¼Ü:‚Ü block=%d, medŸ index=%d.\n", 
gc_block
->
šdex
, 
medŸ
->index);

704 ià(
»t
 == 0)

705 
»check_ä“_block
;

707 
	`debugs2
("gøblock i em±y: %d.\n", 
gc_block
->
šdex
);

708 
	`shªnÚ_li¡_d–
(&
gc_block
->
li¡
);

709 
gc_block
->
¡©e
 = 
NOR_BLOCK_WAIT_ERASE
;

710 
	`shªnÚ_li¡_add_
(&
gc_block
->
li¡
, &
sdev
->
wa™_”a£_nÜ_block_li¡
);

711 
»check_ä“_block
;

715 
out
:

716 
	`debugs1
("exit.\n");

718 ià(
sdev
->
ä“_nÜ_block_couÁ
)

722 
	}
}

724 
	$wr™e_nÜ_bad_block
(
shªnÚ_dev
 *
sdev
, 
bad_block
 *bad_block, 
blk_couÁ
)

726 
»t
 = 0;

727 
nÜ_·ge
 *
Åage
;

728 
nÜ_·ge_medŸ
 *
medŸ
;

729 
i
;

731 
i
 = 0; i < 
blk_couÁ
; i++) {

732 ià(
sdev
->
cu¼_·ge
 >ğ(sdev->
nÜæash
.
bbt_size
 / 
NOR_PAGE_SIZE
)) {

733 
»t
 = -1;

734 
sdev
->
nÜ_bbt_¡©e
 |ğ
BBT_SLOT_IS_FULL
;

735 
	`shªnÚ_w¬n
("cannot update‚or…age, bbt is full.\n");

739 
Åage
 = 
sdev
->
nÜ_·ge_¬¿y
[sdev->
cu¼_·ge
];

741 
medŸ
 = 
Åage
->
d©a
;

742 
medŸ
->
bbt
[
sdev
->
Ãxt_¦Ù
++] = 
bad_block
[
i
];

743 ià(
sdev
->
Ãxt_¦Ù
 =ğ
BAD_BLOCKS_PER_PAGE
) {

744 
medŸ
->
£q_num
 = ++
sdev
->
bbt_£q_num
;

745 
medŸ
->
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
 *)media, (*media) - (media->crc), 0);

747 
»t
 = 
	`wr™e_Úe_nÜ_·ge
(
sdev
, 
Åage
);

748 
sdev
->
cu¼_·ge
++;

749 
sdev
->
Ãxt_¦Ù
 = 0;

750 } ià(
blk_couÁ
 =ğ(
i
 + 1)) {

751 
medŸ
->
£q_num
 = ++
sdev
->
bbt_£q_num
;

752 
medŸ
->
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
 *)media, (*media) - (media->crc), 0);

753 
»t
 = 
	`wr™e_Úe_nÜ_·ge
(
sdev
, 
Åage
);

755 ià(
»t
) {

756 
	`shªnÚ_”r
("failedo write‚or…age: curr_page=%d,‚ext_slot=%d.\n", \

757 
sdev
->
cu¼_·ge
, sdev->
Ãxt_¦Ù
);

762  
»t
;

763 
	}
}

765 
	sbbt_upd©”
 {

766 
	mä“_æag
;

767 
shªnÚ_sb
 *
	msb
;

768 (*
	mÿÎback
)(
	mbbt_upd©”
 *, );

769 
shªnÚ_wÜk_¡ruù
 
	mbbt_wÜk
;

770 
bad_block
 
	mbad_block
[576];

771 
	mblk_couÁ
;

774 
	$wr™e_nÜ_bbt_wÜkfunc
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

776 
bbt_upd©”
 *
upd©”
 = 
	`cÚš”_of
(
wÜk
, bbt_upd©”, 
bbt_wÜk
);

777 
shªnÚ_sb
 *
sb
 = 
upd©”
->sb;

778 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sb
->sdev;

779 
wr™e_dÚe
;

781 
	`shªnÚ_mu‹x_lock
(&
sdev
->
wr™e_bbt_£m
);

783 ià(
	`wr™e_nÜ_bad_block
(
sdev
, 
upd©”
->
bad_block
, upd©”->
blk_couÁ
)) {

784 
	`shªnÚ_”r
("çedØupd©bad blocks: sb_šdex=%d.\n", 
sb
->
sb_šdex
);

785 
wr™e_dÚe
 = 0;

787 
wr™e_dÚe
 = 1;

789 
upd©”
->
	`ÿÎback
(upd©”, 
wr™e_dÚe
);

790 
	`ä“_logicb_buf
(
sdev
, 
upd©”
);

791 
	`check_gc_nÜ_block
(
sdev
);

793 ià(
sdev
->
nÜ_bbt_¡©e
) {

794 
	`shªnÚ_w¬n
("nØ¥aû fÜ stÜšgƒxŒ¨badblocks, bbt_¡©e=%d.\n", 
sdev
->
nÜ_bbt_¡©e
);

795 
	`shªnÚ_£t_b™
(
SHN_REASON_BBT_NO_SPACE
, &
sdev
->
»adÚly_»asÚ
);

796 
	`upd©e_acûss_mode
(
sdev
);

799 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
wr™e_bbt_£m
);

800 
	}
}

802 
add_sb_to_ä“_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
Ãw_sb
);

803 
	$wr™e_nÜ_bbt_ÿÎback
(
bbt_upd©”
 *
upd©”
, 
wr™e_dÚe
)

805 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
upd©”
->sb;

806 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

807 
ä“_æag
 = 
upd©”
->free_flag;

809 ià(
wr™e_dÚe
) {

810 ià(
ä“_æag
 && (
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
)) {

811 
	`add_sb_to_ä“_li¡
(
sdev
, 
sb
);

814 
	}
}

816 
	$lun_add_dyÇmic_bbt_g5
(
bbt_upd©”
 *
upd©”
, 
shªnÚ_lun
 *
lun
, 
bad_eblk
)

818 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

819 
shªnÚ_poŞ
 *
¥oŞ
;

821 ià(
	`»cÜd_bad_block
(
sdev
, 
lun
, 
bad_eblk
) < 0)

824 ià(
bad_eblk
 < 
sdev
->
mbr_eblocks
)

827 ià(
upd©”
) {

828 
upd©”
->
bad_block
[upd©”->
blk_couÁ
].
lun
 = (lun->
lun_num
 & ((1 << 8) - 1));

829 ià(
sdev
->
p£udo_¶ªe
)

830 
upd©”
->
bad_block
[upd©”->
blk_couÁ
++].
block
 = \

831 ((!!(
lun
->
lun_num
 & (1 << 8)è<< 15è| (
bad_eblk
 / 
sdev
->
¶ªes
));

833 
upd©”
->
bad_block
[upd©”->
blk_couÁ
++].
block
 = \

834 ((!!(
lun
->
lun_num
 & (1 << 8)è<< 15è| 
bad_eblk
);

837 
sdev
->
ov”´ovisiÚ_¿‹
 = 
	`ÿlcuÏ‹_ov”´ovisiÚ_¿‹
(sdev);

838 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

839 ià(
¥oŞ
) {

840 
	`ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
¥oŞ
);

841 ià(
¥oŞ
->
ov”´ovisiÚ
 < 
SHN_OVERPROVISION_THRESHOLD
) {

842 
	`shªnÚ_w¬n
("pool overprovision is below %d%% dueo dynamic bad block, set…ool„eadonly.\n",

843 
SHN_OVERPROVISION_THRESHOLD
/100);

844 
	`shªnÚ_£t_b™
(
SHN_REASON_LOW_OVERPROVISION
, &
¥oŞ
->
»adÚly_»asÚ
);

845 
	`¥oŞ_upd©e_acûss_mode
(
¥oŞ
);

847 
	`¥oŞ_put_»ã»nû
(
¥oŞ
);

850 ià(
sdev
->
ov”´ovisiÚ_¿‹
 < 
SHN_OVERPROVISION_THRESHOLD
) {

851 
	`shªnÚ_w¬n
("overprovision is below %d%% dueo dynamic bad block, set disk„eadonly.\n",

852 
SHN_OVERPROVISION_THRESHOLD
/100);

853 
	`shªnÚ_£t_b™
(
SHN_REASON_LOW_OVERPROVISION
, &
sdev
->
»adÚly_»asÚ
);

854 
	`upd©e_acûss_mode
(
sdev
);

858 
	}
}

860 
	$add_dyÇmic_bbt_g5
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
ä“_æag
)

862 
lun
, 
¶ªe
;

863 
bbt_upd©”
 *
upd©”
 = 
NULL
;

865 ià(
sdev
->
nÜ_bbt_¡©e
 == 0) {

866 
upd©”
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

867 
upd©”
->
blk_couÁ
 = 0;

869 
	`shªnÚ_šfo
("ÿÂÙ„ecÜd badblock tØbbt: sb_šdex=%d,‚Ü_bbt_¡©e=%d.\n", 
sb
->
sb_šdex
, 
sdev
->
nÜ_bbt_¡©e
);

871 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

872 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

873 ià(
	`is_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
)) {

874 
	`shªnÚ_šfo
("%s: % sb=%d,†un=%d,…ÏÃ=%d.\n", 
__func__
, 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
lun
, 
¶ªe
);

875 
	`lun_add_dyÇmic_bbt_g5
(
upd©”
, 
sdev
->
lun
[lun], 
sb
->
sb_šdex
 * sdev->
¶ªes
 + 
¶ªe
);

876 
	`sb_ş—r_”rÜ_lun
(
sdev
, 
sb
, 
lun
, 
¶ªe
);

881 ià(
upd©”
 && upd©”->
blk_couÁ
) {

882 
upd©”
->
ÿÎback
 = 
wr™e_nÜ_bbt_ÿÎback
;

883 
upd©”
->
sb
 = sb;

884 
upd©”
->
ä“_æag
 = free_flag;

885 
	`shªnÚ_š™_wÜk
(&
upd©”
->
bbt_wÜk
, 
wr™e_nÜ_bbt_wÜkfunc
);

886 
	`shªnÚ_queue_wÜk
(
sdev
->
»äesh_wq
, &
upd©”
->
bbt_wÜk
);

887 } ià(
upd©”
) {

888 
	`debugs0
("nØbad block ÃedØbupd©ed fÜ sb_šdex=%d.\n", 
sb
->
sb_šdex
);

890 
	`ä“_logicb_buf
(
sdev
, 
upd©”
);

891 ià(
ä“_æag
)

892 
	`add_sb_to_ä“_li¡
(
sdev
, 
sb
);

894 
	}
}

896 
£t_Ãw_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun
 *
lun
);

897 
	$ª®yze_bbt_šfo_g5
(
shªnÚ_dev
 *
sdev
)

899 
i
, 
j
, 
lun
, 
eblk
;

900 
u16
 *
bbt
;

901 
nÜ_·ge_medŸ
 *
medŸ
;

902 
max_blocks
;

904 
i
 = 0; i <ğ
sdev
->
cu¼_·ge
; i++) {

905 
medŸ
 = 
sdev
->
nÜ_·ge_¬¿y
[
i
]->
d©a
;

906 ià(
i
 < 
sdev
->
cu¼_·ge
)

907 
max_blocks
 = 
BAD_BLOCKS_PER_PAGE
;

909 
max_blocks
 = 
sdev
->
Ãxt_¦Ù
;

911 
j
 = 0; j < 
max_blocks
; j++) {

912 
lun
 = 
medŸ
->
bbt
[
j
].lun;

913 
eblk
 = 
medŸ
->
bbt
[
j
].
block
;

916 ià(
eblk
 == 0xFFFF)

919 
lun
 = (luÀ| (!!(
eblk
 & (1 << 15)) << 8));

920 
eblk
 = (eblk & ((1 << 15) - 1));

922 ià(
lun
 > 
sdev
->
lun_couÁ
) {

923 
	`shªnÚ_”r
("WrÚg†uÀnumb”:†un=%d, badblock=%d.\n", 
lun
, 
eblk
);

927 
bbt
 = 
sdev
->
lun
[lun]->bbt;

928 ià(
sdev
->
p£udo_¶ªe
) {

929 ià(
eblk
 >ğ
sdev
->
sb_couÁ
) {

930 
	`shªnÚ_”r
("WrÚg badblock‚umb”:†un=%d, badblock=%d.\n", 
lun
, 
eblk
);

932 
	`shªnÚ_£t_b™_Ë
(
eblk
, 
bbt
);

933 ià(!
	`is_bad_block_dev
(
sdev
, 
lun
, 
eblk
)) {

934 
	`m¬k_bad_block_dev
(
sdev
, 
lun
, 
eblk
);

936 
sdev
->
lun
[lun]->
bad_blk_couÁ
++;

937 ià(
sdev
->
lun
[lun]->
bad_blk_couÁ
 > sdev->
eblocks_š_lun
) {

938 
	`shªnÚ_w¬n
("lun=%d, bad_blk_count=%dƒxceedsƒblocks_in_lun=%d.\n", \

939 
lun
, 
sdev
->lun[lun]->
bad_blk_couÁ
, sdev->
eblocks_š_lun
);

940 
	`£t_»cov”_¡©e_d—d
(
sdev
);

943 
	`debugs2
("%s: badblock:†un=%d, badblock=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun
, 
eblk
);

946 ià(
eblk
/
sdev
->
¶ªes
 >ğsdev->
sb_couÁ
) {

947 
	`shªnÚ_”r
("WrÚg badblock‚umb”:†un=%d, badblock=%d.\n", 
lun
, 
eblk
);

949 
	`shªnÚ_£t_b™_Ë
(
eblk
, 
bbt
);

950 ià(!
	`is_bad_block_dev
(
sdev
, 
lun
, 
eblk
/sdev->
¶ªes
)) {

951 
	`m¬k_bad_block_dev
(
sdev
, 
lun
, 
eblk
/sdev->
¶ªes
);

953 
sdev
->
lun
[lun]->
bad_blk_couÁ
++;

954 ià(
sdev
->
lun
[lun]->
bad_blk_couÁ
 > sdev->
eblocks_š_lun
) {

955 
	`shªnÚ_w¬n
("lun=%d, bad_blk_count=%dƒxceedsƒblocks_in_lun=%d.\n", \

956 
lun
, 
sdev
->lun[lun]->
bad_blk_couÁ
, sdev->
eblocks_š_lun
);

957 
	`£t_»cov”_¡©e_d—d
(
sdev
);

960 
	`debugs2
("%s: badblock:†un=%d, badblock=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun
, 
eblk
);

966 
lun
 = 0;†uÀ< 
sdev
->
lun_couÁ
;†un++) {

967 ià(
sdev
->
lun
[lun]->
bad_blk_couÁ
)

968 
	`shªnÚ_©omic_add
(
sdev
->
lun
[lun]->
bad_blk_couÁ
, &sdev->
¡©ic_bad_blkút
);

970 
	}
}

972 
	$nÜ_·ge_is_nuÎ
(
nÜ_·ge_medŸ
 *
medŸ
)

974 
i
;

976 
i
 = 0; i < (*
medŸ
); i++) {

977 ià(*((
u8
 *)
medŸ
 + 
i
) != 0xFF)

982 
	}
}

984 
	$nÜ_·ge_is_fuÎ
(
nÜ_·ge_medŸ
 *
medŸ
, *
Ãxt_¦Ù
)

986 
i
;

988 
i
 = 0; i < 
BAD_BLOCKS_PER_PAGE
; i++) {

989 ià(
medŸ
->
bbt
[
i
].
block
 == 0xFFFF) {

990 ià(
Ãxt_¦Ù
)

991 *
Ãxt_¦Ù
 = 
i
;

996 ià(
Ãxt_¦Ù
)

997 *
Ãxt_¦Ù
 = 
BAD_BLOCKS_PER_PAGE
;

999 
	}
}

1001 
	$®loc_bbt_nÜ_¡ruùu»
(
shªnÚ_dev
 *
sdev
)

1003 
i
, 
j
;

1004 
nÜ_·ge
 *
Åage
;

1005 
nÜ_block
 *
nblock
;

1006 
nÜ_·ge_medŸ
 *
medŸ
 = 
NULL
;

1007 
blk_sz
;

1008 
blk_num
;

1009 
max_nÜ_·ges
;

1011 
blk_sz
 = 
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
;

1012 ià(
sdev
->
nÜæash
.
bbt_size
 % 
blk_sz
) {

1013 
	`shªnÚ_”r
("bbt_size is‚ot‡ligned with‚orflash block size.\n");

1017 
blk_num
 = 
sdev
->
nÜæash
.
bbt_size
 / 
blk_sz
;

1018 
max_nÜ_·ges
 = 
sdev
->
nÜæash
.
bbt_size
 / 
NOR_PAGE_SIZE
;

1020 
sdev
->
nÜ_blocks
 = 
	`shªnÚ_km®loc
((
nÜ_block
è* 
blk_num
, 
GFP_SHANNON
);

1021 ià(
sdev
->
nÜ_blocks
 =ğ
NULL
) {

1022 
	`shªnÚ_”r
("failedo‡llocate memory for‚or_blocks.\n");

1023  -
ENOMEM
;

1027 
sdev
->
bbt_fÜm©_v”siÚ
 = 0;

1029 
sdev
->
bbt_£q_num
 = 
MAX_BBT_SEQ_NUM
;

1031 
i
 = 0; i < 
blk_num
; i++) {

1032 
nblock
 = &
sdev
->
nÜ_blocks
[
i
];

1033 
nblock
->
šdex
 = 
i
;

1034 
nblock
->
¡©e
 = 
NOR_BLOCK_FREE
;

1035 
nblock
->
v®id_·ges
 = 0;

1036 
	`SHANNON_INIT_LIST_HEAD
(&
nblock
->
·ge_li¡
);

1037 
	`SHANNON_INIT_LIST_HEAD
(&
nblock
->
li¡
);

1038 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
ä“_nÜ_block_li¡
);

1040 
sdev
->
ä“_nÜ_block_couÁ
 = 
blk_num
;

1042 
medŸ
 = 
	`shªnÚ_vm®loc
((*medŸè* 
max_nÜ_·ges
);

1043 ià(
medŸ
 =ğ
NULL
) {

1044 
	`shªnÚ_”r
("failedo‡llocate memory for‚or_page_media.\n");

1045 
çed
;

1048 
	`shªnÚ_mem£t
(
medŸ
, 0xFF, (*medŸè* 
max_nÜ_·ges
);

1050 
sdev
->
nÜ_·ge_¬¿y
 = 
	`shªnÚ_kz®loc
((
nÜ_·ge
 *è* 
max_nÜ_·ges
, 
GFP_SHANNON
);

1051 ià(
sdev
->
nÜ_·ge_¬¿y
 =ğ
NULL
) {

1052 
	`shªnÚ_”r
("cannot‡llocate memory for‚or_page_array.\n");

1053 
çed
;

1056 
i
 = 0; i < 
max_nÜ_·ges
; i++) {

1057 
Åage
 = 
	`shªnÚ_km®loc
((
nÜ_·ge
), 
GFP_SHANNON
);

1058 ià(
Åage
 =ğ
NULL
) {

1059 
	`shªnÚ_”r
("failedo‡llocate memory for‚or_page_array.\n");

1060 
çed
;

1063 
Åage
->
šdex
 = 
INVALID_NOR_PAGE_INDEX
;

1064 
Åage
->
nÜ_block
 = 
INVALID_NOR_BLOCK_INDEX
;

1065 
Åage
->
d©a
 = 
medŸ
 + 
i
;

1066 
Åage
->
d©a
->
šdex
 = 
i
;

1067 
Åage
->
d©a
->
fÜm©_v”siÚ
 = 
sdev
->
bbt_fÜm©_v”siÚ
;

1068 
	`SHANNON_INIT_LIST_HEAD
(&
Åage
->
li¡
);

1069 
sdev
->
nÜ_·ge_¬¿y
[
i
] = 
Åage
;

1074 
çed
:

1075 ià(
sdev
->
nÜ_blocks
) {

1076 
	`shªnÚ_kä“
(
sdev
->
nÜ_blocks
);

1077 
sdev
->
nÜ_blocks
 = 
NULL
;

1080 ià(
medŸ
)

1081 
	`shªnÚ_vä“
(
medŸ
);

1083 ià(
sdev
->
nÜ_·ge_¬¿y
) {

1084 
j
 = 0; j < 
i
; j++) {

1085 ià(
sdev
->
nÜ_·ge_¬¿y
[
j
]) {

1086 
	`shªnÚ_kä“
(
sdev
->
nÜ_·ge_¬¿y
[
j
]);

1087 
sdev
->
nÜ_·ge_¬¿y
[
j
] = 
NULL
;

1090 
	`shªnÚ_kä“
(
sdev
->
nÜ_·ge_¬¿y
);

1091 
sdev
->
nÜ_·ge_¬¿y
 = 
NULL
;

1094  -
ENOMEM
;

1095 
	}
}

1097 
	$»Ëa£_bbt_nÜ_¡ruùu»
(
shªnÚ_dev
 *
sdev
)

1099 ià(
sdev
->
nÜ_blocks
) {

1100 
	`shªnÚ_kä“
(
sdev
->
nÜ_blocks
);

1101 
sdev
->
nÜ_blocks
 = 
NULL
;

1104 ià(
sdev
->
nÜ_·ge_¬¿y
) {

1105 
i
;

1107 ià(
sdev
->
nÜ_·ge_¬¿y
[0]) {

1108 ià(
sdev
->
nÜ_·ge_¬¿y
[0]->
d©a
) {

1109 
	`shªnÚ_vä“
(
sdev
->
nÜ_·ge_¬¿y
[0]->
d©a
);

1111 
	`shªnÚ_kä“
(
sdev
->
nÜ_·ge_¬¿y
[0]);

1112 
sdev
->
nÜ_·ge_¬¿y
[0] = 
NULL
;

1115 
i
 = 1; i < 
sdev
->
nÜæash
.
bbt_size
 / 
NOR_PAGE_SIZE
; i++) {

1116 ià(
sdev
->
nÜ_·ge_¬¿y
[
i
]) {

1117 
	`shªnÚ_kä“
(
sdev
->
nÜ_·ge_¬¿y
[
i
]);

1118 
sdev
->
nÜ_·ge_¬¿y
[
i
] = 
NULL
;

1122 
	`shªnÚ_kä“
(
sdev
->
nÜ_·ge_¬¿y
);

1123 
sdev
->
nÜ_·ge_¬¿y
 = 
NULL
;

1125 
	}
}

1127 
	$»ad_bbt_šfo_g5
(
shªnÚ_dev
 *
sdev
)

1129 
u8
 *
d©a
 = 
NULL
;

1130 
i
, 
blk
;

1131 
blk_sz
, 
·ges_³r_block
;

1132 
nÜ_·ge_medŸ
 *
medŸ
;

1133 
nÜ_·ge
 *
Åage
 = 
NULL
;

1134 
nÜ_block
 *
nblock
, *
pblock
;

1135 
u16
 
Ï¡_·ge
 = 0;

1136 
Ãxt_¦Ù
 = 0, 
tmp_¦Ù
;

1137 
bÏnk_num
, 
fuÎ_num
;

1138 
Ãed_®loc
 = 1;

1139 
·ge_dÚe
 = 0;

1140 
pos_·ge
 = 
INVALID_NOR_PAGE_INDEX
;

1141 
pos_block
 = 
INVALID_NOR_BLOCK_INDEX
;

1142 
max_nÜ_·ges
;

1144 
blk_sz
 = (
sdev
->
nÜæash
.
size_šby‹s
 / sdev->nÜæash.
blk_couÁ
);

1145 
·ges_³r_block
 = (
blk_sz
 / 
NOR_PAGE_SIZE
);

1146 
max_nÜ_·ges
 = 
sdev
->
nÜæash
.
bbt_size
 / 
NOR_PAGE_SIZE
;

1148 
d©a
 = (
u8
 *)
	`shªnÚ_vm®loc
(
blk_sz
);

1149 ià(!
d©a
) {

1150 
	`shªnÚ_”r
("Cannot‡llocate memory for„eading bbt.\n");

1151  -
ENOMEM
;

1154 
blk
 = 0; blk < (
sdev
->
nÜæash
.
bbt_size
 / 
blk_sz
); blk++) {

1155 
nblock
 = &
sdev
->
nÜ_blocks
[
blk
];

1156 
	`shªnÚ_mem£t
(
d©a
, 0, 
blk_sz
);

1157 
bÏnk_num
 = 
fuÎ_num
 = 0;

1159 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1160 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, sdev->
nÜæash
.
bbt_addr
 + 
blk
 * 
blk_sz
, blk_sz, 
d©a
)) {

1161 
	`shªnÚ_”r
("»ad bbˆblk[%d] from NOR FÏsh faed.\n", 
blk
);

1162 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1163 
	`shªnÚ_vä“
(
d©a
);

1166 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1168 
i
 = 0; i < 
·ges_³r_block
; i++) {

1169 
medŸ
 = (
nÜ_·ge_medŸ
 *)(
d©a
 + 
i
 * 
NOR_PAGE_SIZE
);

1171 ià(
	`nÜ_·ge_is_nuÎ
(
medŸ
)) {

1172 
bÏnk_num
++;

1176 ià(
medŸ
->
üc
 !ğ
	`shªnÚ_üc32
(
sdev
, (*)media, (*media) - (media->crc), 0)) {

1177 
	`shªnÚ_w¬n
("bbˆüøcheck faed: block=%d,…age=%d.\n", 
blk
, 
i
);

1181 ià(
medŸ
->
£q_num
 =ğ
MAX_BBT_SEQ_NUM
) {

1182 
	`shªnÚ_w¬n
("bbˆšv®id seq_num=0x%x, block=%d,…age=%d.\n", 
medŸ
->
£q_num
, 
blk
, 
i
);

1186 ià(
medŸ
->
šdex
 > 
max_nÜ_·ges
) {

1187 
	`shªnÚ_w¬n
("bbˆšv®id index=%d, block=%d,…age=%d.\n", 
medŸ
->
šdex
, 
blk
, 
i
);

1191 ià(
medŸ
->
fÜm©_v”siÚ
 !ğ
sdev
->
bbt_fÜm©_v”siÚ
) {

1192 
	`shªnÚ_w¬n
("bbˆšv®id fÜm©_v”siÚ=0x%x, block=%d,…age=%d.\n", 
medŸ
->
fÜm©_v”siÚ
, 
blk
, 
i
);

1196 ià((
sdev
->
bbt_£q_num
 =ğ
MAX_BBT_SEQ_NUM
è|| (sdev->bbt_£q_num < 
medŸ
->
£q_num
)) {

1197 
sdev
->
bbt_£q_num
 = 
medŸ
->
£q_num
;

1198 
pos_·ge
 = 
i
;

1199 
pos_block
 = 
blk
;

1200 } ià(
sdev
->
bbt_£q_num
 =ğ
medŸ
->
£q_num
) {

1201 
	`shªnÚ_w¬n
("§mbbˆ£q_num=%d, block=%d,…age=%d.\n", 
medŸ
->
£q_num
, 
blk
, 
i
);

1205 ià(
	`nÜ_·ge_is_fuÎ
(
medŸ
, &
tmp_¦Ù
)) {

1206 
fuÎ_num
++;

1209 
Åage
 = 
sdev
->
nÜ_·ge_¬¿y
[
medŸ
->
šdex
];

1211 ià(
Åage
->
šdex
 =ğ
INVALID_NOR_PAGE_INDEX
) {

1212 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&
Åage
->
li¡
));

1213 
Åage
->
šdex
 = 
i
;

1214 
Åage
->
nÜ_block
 = 
blk
;

1215 
nblock
->
v®id_·ges
++;

1216 
	`shªnÚ_memıy
(
Åage
->
d©a
, 
medŸ
, (*media));

1217 
	`shªnÚ_li¡_add_
(&
Åage
->
li¡
, &
nblock
->
·ge_li¡
);

1218 } ià(
Åage
->
d©a
->
£q_num
 < 
medŸ
->seq_num) {

1219 
Şd_¡©e
;

1221 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
Åage
->
li¡
));

1222 
	`BUG_ON
(
Åage
->
šdex
 =ğ
INVALID_NOR_PAGE_INDEX
 || \

1223 
Åage
->
nÜ_block
 =ğ
INVALID_NOR_BLOCK_INDEX
);

1224 
pblock
 = &
sdev
->
nÜ_blocks
[
Åage
->
nÜ_block
];

1225 
	`shªnÚ_li¡_d–
(&
Åage
->
li¡
);

1227 
Şd_¡©e
 = 
pblock
->
¡©e
;

1229 
Åage
->
šdex
 = 
i
;

1230 
Åage
->
nÜ_block
 = 
blk
;

1231 
nblock
->
v®id_·ges
++;

1232 
	`shªnÚ_li¡_add_
(&
Åage
->
li¡
, &
nblock
->
·ge_li¡
);

1233 
	`shªnÚ_memıy
(
Åage
->
d©a
, 
medŸ
, (*media));

1235 
pblock
->
v®id_·ges
--;

1236 ià(
pblock
->
v®id_·ges
 == 0) {

1237 
	`shªnÚ_li¡_d–
(&
pblock
->
li¡
);

1238 
pblock
->
¡©e
 = 
NOR_BLOCK_WAIT_ERASE
;

1239 
	`shªnÚ_li¡_add_
(&
pblock
->
li¡
, &
sdev
->
wa™_”a£_nÜ_block_li¡
);

1240 
	`debugs2
("puˆnÜØwa™ƒ¿£d†i¡: block=%d, old_¡©e=%d.\n", 
pblock
->
šdex
, 
Şd_¡©e
);

1241 } ià(
pblock
->
¡©e
 !ğ
NOR_BLOCK_USED
) {

1242 
	`shªnÚ_li¡_d–
(&
pblock
->
li¡
);

1243 
pblock
->
¡©e
 = 
NOR_BLOCK_USED
;

1244 
	`shªnÚ_li¡_add_
(&
pblock
->
li¡
, &
sdev
->
u£d_nÜ_block_li¡
);

1245 
	`debugs2
("puˆnÜØu£d†i¡: block=%d, old_¡©e=%d.\n", 
pblock
->
šdex
, 
Şd_¡©e
);

1249 ià(
medŸ
->
šdex
 > 
Ï¡_·ge
) {

1250 
Ï¡_·ge
 = 
medŸ
->
šdex
;

1251 
Ãxt_¦Ù
 = 
tmp_¦Ù
;

1252 } ià(
medŸ
->
šdex
 =ğ
Ï¡_·ge
) {

1253 ià(
Ãxt_¦Ù
 < 
tmp_¦Ù
)

1254 
Ãxt_¦Ù
 = 
tmp_¦Ù
;

1258 ià(
bÏnk_num
 =ğ
·ges_³r_block
) {

1260 
	`debugs2
("puˆnÜØä“†i¡: %d.\n", 
nblock
->
šdex
);

1264 
sdev
->
ä“_nÜ_block_couÁ
--;

1265 ià((
fuÎ_num
 =ğ
·ges_³r_block
è|| (
nblock
->
v®id_·ges
 ==…ages_per_block)) {

1267 
nblock
->
¡©e
 = 
NOR_BLOCK_FULL
;

1268 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

1269 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
fuÎ_nÜ_block_li¡
);

1270 
	`debugs2
("puˆnÜØfuÎ†i¡: %d.\n", 
nblock
->
šdex
);

1274 ià(
nblock
->
v®id_·ges
 == 0) {

1275 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&
nblock
->
·ge_li¡
));

1276 
nblock
->
¡©e
 = 
NOR_BLOCK_WAIT_ERASE
;

1277 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

1278 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
wa™_”a£_nÜ_block_li¡
);

1279 
	`debugs2
("puˆnÜØwa™ƒ¿£†i¡: %d.\n", 
nblock
->
šdex
);

1283 
nblock
->
¡©e
 = 
NOR_BLOCK_USED
;

1284 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

1285 
	`shªnÚ_li¡_add_
(&
nblock
->
li¡
, &
sdev
->
u£d_nÜ_block_li¡
);

1286 
	`debugs2
("puˆnÜØu£d†i¡: %d.\n", 
nblock
->
šdex
);

1289 ià(
sdev
->
bbt_£q_num
 =ğ
MAX_BBT_SEQ_NUM
)

1290 
sdev
->
bbt_£q_num
 = 0;

1292 
	`BUG_ON
(
Ï¡_·ge
 >ğ
max_nÜ_·ges
);

1294 ià(
Ãxt_¦Ù
 =ğ
BAD_BLOCKS_PER_PAGE
)

1295 
·ge_dÚe
 = 1;

1297 
·ge_dÚe
 = 0;

1299 ià(
·ge_dÚe
 && (
Ï¡_·ge
 =ğ(
max_nÜ_·ges
 - 1))) {

1301 
	`shªnÚ_w¬n
("bbt…age is full.\n");

1302 
sdev
->
nÜ_bbt_¡©e
 |ğ
BBT_SLOT_IS_FULL
;

1305 
sdev
->
cu¼_·ge
 = 
max_nÜ_·ges
 - 1;

1306 
sdev
->
Ãxt_¦Ù
 = 
BAD_BLOCKS_PER_PAGE
;

1309 ià(
·ge_dÚe
) {

1310 
sdev
->
cu¼_·ge
 = 
Ï¡_·ge
 + 1;

1311 
sdev
->
Ãxt_¦Ù
 = 0;

1313 
sdev
->
cu¼_·ge
 = 
Ï¡_·ge
;

1314 
sdev
->
Ãxt_¦Ù
 =‚ext_slot;

1319 ià((
pos_·ge
 !ğ
INVALID_NOR_PAGE_INDEX
è&& (pos_·g< (
·ges_³r_block
 - 1))) {

1321 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1322 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, sdev->
nÜæash
.
bbt_addr
 + 
pos_block
 * 
blk_sz
, blk_sz, 
d©a
)) {

1323 
	`shªnÚ_”r
("re-check‚orflash failed.\n");

1324 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1325 
	`shªnÚ_vä“
(
d©a
);

1328 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1330 
i
 = (
pos_·ge
 + 1); i < 
·ges_³r_block
; i++) {

1331 
medŸ
 = (
nÜ_·ge_medŸ
 *)
d©a
;

1332 ià(
	`nÜ_·ge_is_nuÎ
(
medŸ
 + 
i
)) {

1333 
	`debugs1
("nÜ…agi nuÎ: block=%d,…age=%d.\n", 
pos_block
, 
i
);

1337 ià(
i
 < 
·ges_³r_block
) {

1338 
Ãed_®loc
 = 0;

1339 
sdev
->
pos_block
 =…os_block;

1340 
sdev
->
pos_·ge
 = 
i
;

1342 
nblock
 = &
sdev
->
nÜ_blocks
[
pos_block
];

1343 
nblock
->
¡©e
 = 
NOR_BLOCK_ACTIVE
;

1344 
	`shªnÚ_li¡_d–
(&
nblock
->
li¡
);

1345 
	`debugs2
("puˆnÜ blockØaùive: %d.\n", 
nblock
->
šdex
);

1350 ià(
Ãed_®loc
) {

1351 
Ãxt_block
 = 
	`g‘_Ãw_nÜ_block
(
sdev
);

1352 ià(
Ãxt_block
 == -1) {

1353 
	`shªnÚ_w¬n
("failedo get‚ew‚or block.\n");

1354 
sdev
->
pos_block
 = -1;

1355 
sdev
->
pos_·ge
 = 
·ges_³r_block
;

1357 
sdev
->
nÜ_blocks
[
Ãxt_block
].
¡©e
 = 
NOR_BLOCK_ACTIVE
;

1358 
sdev
->
pos_block
 = 
Ãxt_block
;

1359 
sdev
->
pos_·ge
 = 0;

1363 
	`check_gc_nÜ_block
(
sdev
);

1365 ià(
sdev
->
nÜ_bbt_¡©e
) {

1366 
	`shªnÚ_w¬n
("nØ¥aû fÜ stÜšgƒxŒ¨badblocks, bbt_¡©e=%d.\n", 
sdev
->
nÜ_bbt_¡©e
);

1367 
	`shªnÚ_£t_b™
(
SHN_REASON_BBT_NO_SPACE
, &
sdev
->
»adÚly_»asÚ
);

1370 
	`debugs1
("bbt initialized: curr_page=%d,‚ext_slot=%d,…os_block=%d,…os_page=%d, state=%d.\n", \

1371 
sdev
->
cu¼_·ge
, sdev->
Ãxt_¦Ù
, sdev->
pos_block
, sdev->
pos_·ge
, sdev->
nÜ_bbt_¡©e
);

1373 
	`shªnÚ_vä“
(
d©a
);

1375 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

1376 ià(!
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
)) {

1378 
	`shªnÚ_mem£t
(
sdev
->
lun
[
i
]->
bbt
, 0, 
LUN_BBT_SIZE
);

1380 
	`debugs1
("lun=%d,…hy_lun_num=%d i physiÿÎy bad.\n", 
i
, 
sdev
->
lun
[i]->
phy_lun_num
);

1385 
	}
}

1387 
	$£t_ecc_Ügªiz©iÚ
(
shªnÚ_dev
 *
sdev
)

1389 
u32
 
dwÜd
 = 0, 
v®ue
 = 0;

1391 
dwÜd
 = 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
glob®_b¬
 + 4);

1392 
v®ue
 = (
dwÜd
 & 
SH_ECC_CORRECT_POWER_MASK
è>> 
SH_ECC_CORRECT_POWER_SHIFT
;

1394 
v®ue
) {

1396 
sdev
->
ecc_cÜ»ùiÚ_pow”
 = 72;

1399 
sdev
->
ecc_cÜ»ùiÚ_pow”
 = 96;

1402 
sdev
->
ecc_cÜ»ùiÚ_pow”
 = 120;

1405 
	`shªnÚ_”r
("Unsupportƒcc correction…ower\n");

1408 ià(
sdev
->
ecc_cÜ»ùiÚ_pow”
 > 
ECC_CORRECTION_BITS_IN_SECTOR
) {

1409 
	`shªnÚ_”r
("ecøcÜ»ùiÚ…ow” g»©”hª†im™, %d > %d\n", 
sdev
->
ecc_cÜ»ùiÚ_pow”
, 
ECC_CORRECTION_BITS_IN_SECTOR
);

1413 
v®ue
 = (
dwÜd
 & 
SH_ECC_CODEWORD_SIZE_MASK
è>> 
SH_ECC_CODEWORD_SIZE_SHIFT
;

1414 
sdev
->
ecc_codewÜd_size
 = 
v®ue
;

1416 
dwÜd
 = 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
glob®_b¬
 + 1);

1417 
v®ue
 = (
dwÜd
 & 
SH_FIRST_CODEWORD_OFFSET_MASK
è>> 
SH_FIRST_CODEWORD_OFFSET_SHIFT
;

1418 
sdev
->
fœ¡_codewÜd_off£t
 = 
v®ue
;

1419 
dwÜd
 = 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
glob®_b¬
 + 3);

1420 
v®ue
 = (
dwÜd
 & 
SH_PER_BYTE_DISABLE_MASK
è>> 
SH_PER_BYTE_DISABLE_SHIFT
;

1421 
sdev
->
b™_mode
 = 
v®ue
 ? 
MODE_8BIT
 : 
MODE_16BIT
;

1424 
	}
}

1426 
	$shªnÚ_£t_ù¾_·¿m
(
shªnÚ_dev
 *
sdev
)

1428 
·¿m_lšk
 *
¶
;

1429 
u32
 *
buf
 = 
NULL
, *
ıs_£gm’t
 = NULL, *

;

1430 
u32
 
i
, 
·ge
, 
şk
, 
üc
;

1431 
»t
 = 0;

1432 
»maš_dwÜd
, 
couÁ
, 
£gm’t_šdex
 = 0;

1434 
buf
 = (
u32
*)
	`shªnÚ_kz®loc
(
NOR_PAGE_SIZE
, 
GFP_SHANNON
);

1435 ià(!
buf
) {

1436 
	`shªnÚ_šfo
("kzalloc failed");

1440 
ıs_£gm’t
 = (
u32
*)
	`shªnÚ_vm®loc
(64 * 
NOR_PAGE_SIZE
);

1441 ià(!
ıs_£gm’t
) {

1442 
	`shªnÚ_”r
("alloc memory failed for cps_segment.\n");

1443 
	`shªnÚ_kä“
(
buf
);

1446 
	`shªnÚ_mem£t
(
ıs_£gm’t
, 0, 64 * 
NOR_PAGE_SIZE
);

1448 
sdev
->
ıs_üc
 = 0;

1449 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1451 
·ge
 = 
sdev
->
nÜæash
.
ú_·¿m_addr
 / 
NOR_PAGE_SIZE
;

1453 ià(
·ge
 =ğ0 ||…ag>ğ
sdev
->
nÜæash
.
size_šby‹s
 / 
NOR_PAGE_SIZE
)

1454 
out
;

1456 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
·ge
 * 
NOR_PAGE_SIZE
, NOR_PAGE_SIZE, 
buf
)) {

1457 
	`shªnÚ_”r
("»ad faed,…age=%d", 
·ge
);

1458 
»t
 = -1;

1459 
out
;

1462 

 = 
ıs_£gm’t
;

1463 
	`shªnÚ_memıy
(

, 
buf
, 
NOR_PAGE_SIZE
);

1464 
¶
 = (
·¿m_lšk
*)
ıs_£gm’t
;

1467 
»maš_dwÜd
 = (
¶
->
Ëngth
 + ((
üc
è/ (
u32
))è< ((
NOR_PAGE_SIZE
 - (*pl)) / (u32)) ?

1468 0 : ((
¶
->
Ëngth
 + ((
üc
è/ (
u32
))è- ((
NOR_PAGE_SIZE
 - (*pl)) / (u32)));

1470 

 =a + (
NOR_PAGE_SIZE
 / (
u32
));

1471 
»maš_dwÜd
 > 0) {

1472 ià(++
·ge
 >ğ
sdev
->
nÜæash
.
size_šby‹s
 / 
NOR_PAGE_SIZE
) {

1473 
	`shªnÚ_”r
("»ad…age=%d ov”æow,‚Üæash_size=%d\n", 
·ge
, 
sdev
->
nÜæash
.
size_šby‹s
);

1474 
»t
 = -1;

1475 
out
;

1477 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
·ge
 * 
NOR_PAGE_SIZE
, NOR_PAGE_SIZE, 
buf
)) {

1478 
	`shªnÚ_”r
("»ad oÀçed,…age=%d", 
·ge
);

1479 
»t
 = -1;

1480 
out
;

1482 
couÁ
 = (
NOR_PAGE_SIZE
 / (
u32
)è> 
»maš_dwÜd
 ?„emain_dword : (NOR_PAGE_SIZE / (u32));

1483 
	`shªnÚ_memıy
(

, 
buf
, 
couÁ
 * (
u32
));

1484 

 +ğ
couÁ
;

1485 
»maš_dwÜd
 -ğ
couÁ
;

1488 
üc
 = (
u32
)
ıs_£gm’t
[(*
¶
è/ (u32è+…l->
Ëngth
];

1489 ià(
üc
 !ğ
	`shªnÚ_üc32
(
sdev
, (
u8
*)
ıs_£gm’t
, (*
¶
è+…l->
Ëngth
 * (
u32
), 0)) {

1490 
	`shªnÚ_”r
("CRC check oÀıs_£gm’t=%d faed.\n", 
£gm’t_šdex
);

1491 
»t
 = -1;

1492 
out
;

1494 
sdev
->
ıs_üc
 = 
	`shªnÚ_üc32
(sdev, (
u8
*)
ıs_£gm’t
, (*
¶
è+…l->
Ëngth
 * (
u32
), sdev->cps_crc);

1496 
i
 = 0; i < 
¶
->
Ëngth
; i++) {

1497 
	`debugs2
("wr™e: v®ue=0x%08x, off£t=%d", 
¶
->
v®ues
[
i
],…l->
»g_off£t
 + i);

1498 
	`wr™e_»g_§ã
(
sdev
, 
¶
->
v®ues
[
i
], (
u32
*)sdev->
b¬
 +…l->
»g_off£t
 + i);

1501 ià(
¶
->
p_Ãxt
 == 0)

1504 
·ge
 = 
¶
->
p_Ãxt
;

1506 
£gm’t_šdex
++;

1509 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1510 
şk
 = 
	`shªnÚ_iÜ—d32
((
u32
 *)
sdev
->
b¬
 + 
SH_CORE_CLK_OFFSET
);

1511 
	`shªnÚ_iowr™e32
(
şk
 & 0xFFFFFFFE, (
u32
*)
sdev
->
b¬
 + 
SH_CORE_CLK_OFFSET
);

1512 
	`shªnÚ_iowr™e32
(
şk
 | 0x00000001, (
u32
*)
sdev
->
b¬
 + 
SH_CORE_CLK_OFFSET
);

1513 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1514 
	`shªnÚ_m¦“p
(5);

1516 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1517 
şk
 = 
	`shªnÚ_iÜ—d32
((
u32
 *)
sdev
->
b¬
 + 
SH_DP_CLK_OFFSET
);

1518 
	`shªnÚ_iowr™e32
(
şk
 & 0xFFFFFFFE, (
u32
*)
sdev
->
b¬
 + 
SH_DP_CLK_OFFSET
);

1519 
	`shªnÚ_iowr™e32
(
şk
 | 0x00000001, (
u32
*)
sdev
->
b¬
 + 
SH_DP_CLK_OFFSET
);

1520 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1521 
	`shªnÚ_m¦“p
(5);

1523 
	`£t_‹m³¿tu»_£nsÜ_th»shŞds
(
sdev
);

1524 
out
:

1525 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1527 
	`shªnÚ_vä“
(
ıs_£gm’t
);

1528 
	`shªnÚ_kä“
(
buf
);

1530 
	`ş—n_®l_miüocode_u£d_¡©e
(
sdev
);

1531 ià(
	`should_upd©e_miüocode
(
sdev
))

1532 
	`wr™e_advªûd_»ad_miüocode
(
sdev
, 
	`g‘_upd©e_miüocode
(sdev));

1533  
»t
;

1534 
	}
}

1536 
	#SHANNON_G5_HANDLE_IN_TASKLET


	)

1537 
	$hªdË_com¶‘iÚ_skËt_g5
(
shªnÚ_š‹¼u±_¬g
 *
š‹r_¬g
)

1539 
shªnÚ_dev
 *
dev
 = 
š‹r_¬g
->
sdev
;

1540 
dwÜd_šdex
 = 
š‹r_¬g
->dword_index;

1542 #ifdeà
SHANNON_G5_HANDLE_IN_TASKLET


1543 
	`com¶‘iÚ_pŞl_g5
(
dev
, 
dwÜd_šdex
);

1545 
	`wr™e_š‹¼u±_veùÜ
(
dev
, 
dwÜd_šdex
);

1547 
pŞl_»t
;

1548 
dev
->
pŞl
[
dwÜd_šdex
] = 
shªnÚ_pŞl_times
;

1549 
pŞl_»t
 = 
	`com¶‘iÚ_pŞl_g5
(
dev
, 
dwÜd_šdex
);

1550 ià(
	`uÆik–y
(
dev
->
¶ug_out
)) {

1551 
dev
->
pŞl
[
dwÜd_šdex
] = 0;

1552 
dev
->
š_œq
[
dwÜd_šdex
] = 0;

1553 
	`shªnÚ_b¬r›r
();

1557 ià(
	`lik–y
(
pŞl_»t
)) {

1558 ià(!
shªnÚ_u£_¹_comp_th»ad
)

1559 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_comp_wq
, &
š‹r_¬g
->
»pŞl_wÜk
);

1561 
	`shªnÚ_¹_queue_wÜk
(
dev
->
shªnÚ_¹_comp_wq
, &
š‹r_¬g
->
¹_»pŞl_wÜk
);

1564 
dev
->
pŞl
[
dwÜd_šdex
] = 0;

1565 
	`wr™e_š‹¼u±_veùÜ
(
dev
, 
dwÜd_šdex
);

1568 
	}
}

1571 
	$com¶‘iÚ_pŞl_g5
(
shªnÚ_dev
 *
dev
, 
dwÜd_šdex
)

1573 
i
, 
b™s
, 
check_begš
, 
check_’d
, 
»t
 = 0;

1575 
	`BUG_ON
(
dwÜd_šdex
 < 0);

1577 
dev
->
u32_veùÜs
[
dwÜd_šdex
] = 
	`»ad_¿w_»g_§ã
(dev, &dev->
š‹¼u±_b¬
[dword_index]);

1579 ià(
	`uÆik–y
(
dev
->
¶ug_out
 || (dev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)))

1582 #ifdeà
SHANNON_USE_WRITE_BUFFER


1583 ià(
dwÜd_šdex
 =ğ
dev
->
max_œq_šdex
) {

1584 ià(!
	`shªnÚ_dev_is_g5_ff§
(
dev
è&& (dev->
š™_dÚe
 >ğ
STAGE9_DONE
) &&

1585 
	`shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
dev
->
£u_šŒ_shiá
, dev->
š‹¼u±_veù
)) {

1586 
u32
 
£u
 = 
	`»ad_»g_§ã
(
dev
, (u32 *)dev->
b¬
 + 
SH_SEU_OFFSET
);

1587 ià(
£u
 == 0)

1588 
	`shªnÚ_w¬n
("%s:£u i mi¤•Ü‹d!.\n", 
dev
->
sdisk
.
disk_Çme
);

1590 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
»cÚfig_wÜk
);

1593 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

1594 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
dev
->
šŒ_big_shiá
[
i
], dev->
š‹¼u±_veù
)) {

1595 
	`hªdË_bufq
(
dev
, 
i
);

1596 
»t
++;

1599 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
dev
->
bufq_ack_šŒ_shiá
, dev->
š‹¼u±_veù
)) {

1600 
	`hªdË_bufq_ack_š‹¼u±
(
dev
);

1601 
»t
++;

1606 ià(
dev
->
u32_veùÜs
[
dwÜd_šdex
] == 0)

1607  
»t
;

1608 #ifdeà
SHANNON_USE_WRITE_BUFFER


1610 
	`upd©e_bufq_lim™
(
dev
);

1613 
b™s
 = 
	`shªnÚ_hweight32
(
dev
->
u32_veùÜs
[
dwÜd_šdex
]);

1614 ià(
b™s
 == 0)

1615  
»t
;

1617 
check_begš
 = 
dwÜd_šdex
 * 32;

1618 
check_’d
 = (
check_begš
 + 32è< 
dev
->
lun£t_couÁ
 ? (check_begin + 32) : dev->lunset_count;

1619 
i
 = 
check_begš
; i < 
check_’d
; i++) {

1620 ià(
	`shªnÚ_‹¡_b™_Ë
(
dev
->
lun£ts
[
i
].
šdex
, dev->
š‹¼u±_veù
)) {

1621 #ifdeà
SHANNON_G5_HANDLE_IN_TASKLET


1622 
	`hªdË_lun£t
(
dev
, dev->
lun£ts
 + 
i
, 0);

1624 ià(!
	`shªnÚ_š_soáœq
(è&& (
b™s
 <ğ1è&& (
	`shªnÚ_©omic_»ad
(&
dev
->
lun£ts
[
i
].
š_wq
) == 0)) {

1625 
	`hªdË_lun£t
(
dev
, dev->
lun£ts
 + 
i
, 0);

1627 
	`shªnÚ_©omic_šc
(&
dev
->
lun£ts
[
i
].
š_wq
);

1628 ià(
	`shªnÚ_queue_wÜk
(
dev
->
hªdË_lun_wq
[
i
 % dev->
shªnÚ_Ä_wq
], &dev->
lun£ts
[i].
comp_wÜk
) == 0)

1629 
	`shªnÚ_©omic_dec
(&
dev
->
lun£ts
[
i
].
š_wq
);

1632 
b™s
--;

1636 
dev
->
u32_veùÜs
[
dwÜd_šdex
] = 0;

1639 
	}
}

1641 
	$chªge_š‹¼u±_što_msix_mode
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
)

1643 
»suÉ
, 
veùÜ
, 
i
;

1646 ià(((
sdev
->
lun£t_couÁ
 + 3è/ 32è>ğ
MAX_MSIX_INTERRUPTS
) {

1647 
	`shªnÚ_”r
("too many†unsetso‡llocate irq‚umber,†unset_count=%d, MAX_MSIX_INTERRUPTS=%d",

1648 
sdev
->
lun£t_couÁ
, 
MAX_MSIX_INTERRUPTS
);

1651 
sdev
->
max_œq_šdex
 = (sdev->
lun£t_couÁ
 + 3) / 32;

1653 
»suÉ
 = 
	`shªnÚ_pci_’abË_msix
(
pdev
, &
sdev
->
msix_d©a
, sdev->
max_œq_šdex
 + 1);

1654 ià(
»suÉ
 == 0) {

1655 
i
 = 0; i < 
sdev
->
max_œq_šdex
 + 1; i++) {

1656 
veùÜ
 = 
	`shªnÚ_pci_g‘_msix_veùÜ
(
sdev
->
msix_d©a
, 
i
, sdev->
max_œq_šdex
 + 1);

1657 ià(
veùÜ
 < 0)

1658 
»suÉ
 = 
veùÜ
;

1660 
»suÉ
 = 
	`shªnÚ_»que¡_œq
(
veùÜ
, "shªnÚ", 
sdev
);

1661 ià(
	`uÆik–y
(
»suÉ
)) {

1662 
	`shªnÚ_”r
("»que¡ #%d iÁ”ru± faed.„esuÉ=%d\n", 
i
, 
»suÉ
);

1663 
i
--) {

1664 
veùÜ
 = 
	`shªnÚ_pci_g‘_msix_veùÜ
(
sdev
->
msix_d©a
, 
i
, sdev->
max_œq_šdex
 + 1);

1665 ià(
veùÜ
 < 0)

1667 
	`shªnÚ_ä“_œq
(
veùÜ
, 
sdev
);

1669 
	`shªnÚ_pci_di§bË_msix
(
pdev
, &
sdev
->
msix_d©a
);

1672 
sdev
->
š‹¼u±_¬g
[
i
].
dwÜd_šdex
 = i;

1673 
sdev
->
š‹¼u±_¬g
[
i
].sdev = sdev;

1674 
	`shªnÚ_š™_wÜk
(&
sdev
->
š‹¼u±_¬g
[
i
].
»pŞl_wÜk
, 
shªnÚ_»pŞl_sk
);

1675 
	`shªnÚ_š™_¹_wÜk
(&
sdev
->
š‹¼u±_¬g
[
i
].
¹_»pŞl_wÜk
, 
shªnÚ_¹_»pŞl_sk
);

1676 
	`shªnÚ_skËt_š™
(&
sdev
->
comp_skËt
[
i
], 
com¶‘iÚ_skËt
, ()(&sdev->
š‹¼u±_¬g
[i]));

1680 
	`shªnÚ_”r
("Enable MSI-X mode failed.");

1683 
	}
}

1685 
	$shªnÚ_di§bË_msix
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_dev
 *
sdev
)

1687 
i
, 
veùÜ
;

1689 
i
 = 
sdev
->
max_œq_šdex
 + 1;

1690 
i
--) {

1691 
veùÜ
 = 
	`shªnÚ_pci_g‘_msix_veùÜ
(
sdev
->
msix_d©a
, 
i
, sdev->
max_œq_šdex
 + 1);

1692 ià(
veùÜ
 < 0)

1694 
	`shªnÚ_ä“_œq
(
veùÜ
, 
sdev
);

1696 
	`shªnÚ_pci_di§bË_msix
(
pdev
, &
sdev
->
msix_d©a
);

1697 
	}
}

1699 
	$shªnÚ_nÜæash_”a£_g5
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
)

1701 
u32
 
nÜ_’gše_¡©e
;

1702 
timeout
;

1704 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1706 
nÜ_’gše_¡©e
 = 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1707 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1708 
	`shªnÚ_iowr™e32
(~
SH_NORFLASH_WRITE_PROTECT_MASK
 & 
nÜ_’gše_¡©e
, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1709 
	`shªnÚ_iowr™e32
(0, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_OPT_OFFSET
);

1710 
	`shªnÚ_iowr™e32
((1 << 
SH_NORFLASH_ERASE_SHIFT
è| ((
phyaddr
/
NOR_PAGE_SIZE
è& 
SH_NORFLASH_ADDR_MASK
), (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_OPT_OFFSET
);

1711 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1713 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1715 
timeout
 = 0;

1716 !(
	`»ad_»g_§ã
(
sdev
, (
u32
*)sdev->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
è& 
SH_NORFLASH_STATE_MASK
)) {

1717 
	`shªnÚ_ud–ay
(10);

1718 ià(
timeout
++ > 
NORFLASH_TIMEOUT
) {

1719 
	`shªnÚ_”r
("erase‚or flashimeout\n");

1722 
	`shªnÚ_cÚd_»sched
();

1724 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1726 
nÜ_’gše_¡©e
 = 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1727 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1728 
	`shªnÚ_iowr™e32
(
SH_NORFLASH_WRITE_PROTECT_MASK
 | 
nÜ_’gše_¡©e
, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1729 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1731 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1734 
	}
}

1736 
	$shªnÚ_nÜæash_wr™e_g5
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
)

1738 
u32
 
nÜ_’gše_¡©e
;

1739 
timeout
;

1741 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1743 
nÜ_’gše_¡©e
 = 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1744 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1745 
	`shªnÚ_iowr™e32
(~
SH_NORFLASH_WRITE_PROTECT_MASK
 & 
nÜ_’gše_¡©e
, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1746 
	`shªnÚ_iowr™e32
(0, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_OPT_OFFSET
);

1747 
	`shªnÚ_iowr™e32
((1 << 
SH_NORFLASH_WRITE_SHIFT
è| ((
phyaddr
/
NOR_PAGE_SIZE
è& 
SH_NORFLASH_ADDR_MASK
), (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_OPT_OFFSET
);

1748 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1750 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1752 
timeout
 = 0;

1753 !(
	`»ad_»g_§ã
(
sdev
, (
u32
*)sdev->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
è& 
SH_NORFLASH_STATE_MASK
)) {

1754 
	`shªnÚ_ud–ay
(10);

1755 ià(
timeout
++ > 
NORFLASH_TIMEOUT
) {

1756 
	`shªnÚ_”r
("write‚or flashimeout\n");

1760 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1762 
nÜ_’gše_¡©e
 = 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1763 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1764 
	`shªnÚ_iowr™e32
(
SH_NORFLASH_WRITE_PROTECT_MASK
 | 
nÜ_’gše_¡©e
, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1765 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1767 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1770 
	}
}

1772 
	$shªnÚ_nÜæash_»ad_g5
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
)

1774 
timeout
;

1776 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1778 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1779 
	`shªnÚ_iowr™e32
(0, (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_OPT_OFFSET
);

1780 
	`shªnÚ_iowr™e32
((1 << 
SH_NORFLASH_READ_SHIFT
è| ((
phyaddr
/
NOR_PAGE_SIZE
è& 
SH_NORFLASH_ADDR_MASK
), (
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_OPT_OFFSET
);

1781 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

1783 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1785 
timeout
 = 0;

1786 !(
	`»ad_»g_§ã
(
sdev
, (
u32
*)sdev->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
è& 
SH_NORFLASH_STATE_MASK
)) {

1787 
	`shªnÚ_ud–ay
(10);

1788 ià(
timeout
++ > 
NORFLASH_TIMEOUT
) {

1789 
	`shªnÚ_”r
("read‚or flashimeout\n");

1795 
	}
}

1797 
u32
 
	$shªnÚ_üc32
(
shªnÚ_dev
 *
sdev
, 
u8
 *
d©a
, 
Ën
, 
u32
 
£ed
)

1799 
u32
 *
bË
 = 
sdev
->
üc_bË
;

1800 
u32
 
üc
 = ~
£ed
;

1801 
i
;

1803 
i
 = 0; i < 
Ën
; i++)

1804 
üc
 = (üø>> 8è^ 
bË
[(üø^ 
d©a
[
i
]) & 0xFF];

1806  ~
üc
;

1807 
	}
}

1809 
	$g‘_nÜ_·ge_šdex
(
shªnÚ_dev
 *
sdev
)

1811 
nÜæash_šdex_node
 *
šdex
 = 
NULL
;

1812 
u32
 
üc
;

1814 
sdev
->
nÜæash
.
šdex_node_addr
 = sdev->nÜæash.
pc›_phy_addr
 + 
NOR_PAGE_SIZE
;

1815 
sdev
->
nÜæash
.
ú_·¿m_addr
 = sdev->nÜæash.
pc›_phy_addr
 + 
NOR_PAGE_SIZE
 * 16;

1816 
šdex
 = (
nÜæash_šdex_node
*)
	`shªnÚ_kz®loc
((*šdex), 
GFP_SHANNON
);

1817 ià(!
šdex
) {

1818 
	`shªnÚ_”r
("Can‚ot‡llocate memory for„eading‚or index‚ode.\n");

1819  -
ENOMEM
;

1822 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, sdev->
nÜæash
.
šdex_node_addr
, (*
šdex
), index)) {

1823 
	`shªnÚ_”r
("read index‚ode from NOR Flash failed.\n");

1824 
	`shªnÚ_kä“
(
šdex
);

1828 
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
*)
šdex
, (*index) - (index->crc), 0);

1829 ià(
üc
 !ğ
šdex
->crc) {

1830 
	`shªnÚ_”r
("CRC check failed for‚or…age index.\n");

1831 
	`shªnÚ_kä“
(
šdex
);

1835 
sdev
->
nÜæash
.
mbr_addr
 = 
šdex
->
mbr_·ge
 * 
NOR_PAGE_SIZE
;

1836 
sdev
->
nÜæash
.
mbr_backup_addr
 = 
šdex
->
mbr_backup_·ge
 * 
NOR_PAGE_SIZE
;

1837 
sdev
->
nÜæash
.
bbt_addr
 = 
šdex
->
bbt_¡¬t_·ge
 * 
NOR_PAGE_SIZE
;

1838 
sdev
->
nÜæash
.
bbt_size
 = (
šdex
->
bbt_’d_·ge
 - index->
bbt_¡¬t_·ge
 + 1è* 
NOR_PAGE_SIZE
;

1839 
sdev
->
nÜæash
.
ã©u»_addr
 = 
šdex
->
ã©u»_·ge
 * 
NOR_PAGE_SIZE
;

1840 
sdev
->
nÜæash
.
miüo_code_addr
 = 
šdex
->
miüo_code_·ge
 * 
NOR_PAGE_SIZE
;

1841 
sdev
->
nÜæash
.
poŞ_šfo_addr
 = sdev->nÜæash.
mbr_addr
 + 
NOR_PAGE_SIZE
;

1842 
sdev
->
nÜæash
.
poŞ_šfo_backup_addr
 = sdev->nÜæash.
mbr_backup_addr
 + 
NOR_PAGE_SIZE
;

1844 
	`shªnÚ_kä“
(
šdex
);

1847 
	}
}

1849 
	$shªnÚ_š™_h¬dw¬e_g5
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_pci_dev_t
 *
pdev
)

1851 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
;

1852 
u32
 
dwÜd
 = 0x0;

1854 
sdev
->
mbr_eblocks
 = 0;

1856 
lun_£ùiÚ
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)
sdev
->
b¬
 + 256);

1858 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1859 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
RESET
, 1);

1860 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1861 
	`shªnÚ_m¦“p
(1);

1862 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1863 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
RESET
, 0);

1864 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1866 ià(
	`g‘_nÜ_·ge_šdex
(
sdev
) < 0)

1869 ià(
	`g‘_mbr_äom_nÜ
(
sdev
) < 0)

1872 ià(
	`g‘_miüocode_äom_nÜ
(
sdev
) < 0)

1873 
	`shªnÚ_šfo
("%s: DÚ`ˆsuµÜ‹d upd©miüocodfunùiÚ.\n", 
sdev
->
cdev_Çme
);

1876 ià(
	`shªnÚ_£t_ù¾_·¿m
(
sdev
) < 0) {

1877 
	`shªnÚ_”r
("set controller…arametre failed.\n");

1880 
	`shªnÚ_m¦“p
(2);

1882 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1883 
sdev
->
ifmode
 = 
	`shªnÚ_»ad_»g
((
u32
 *)sdev->
glob®_b¬
 + 0, 
FLASH_MODE
);

1884 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, 
ONFI_ASYNC_MODE
);

1885 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1887 
	`ş—r_ªd_di§bË_š‹¼u±
(
sdev
);

1888 
	`»£t_®l_lun£t
(
sdev
, 
lun_£ùiÚ
);

1889 
	`shªnÚ_di§bË_œq
(
	`g‘_pci_œq_num
(
pdev
));

1891 ià(
	`d‘eù_æashid
(
sdev
, 
lun_£ùiÚ
) < 0) {

1892 
	`shªnÚ_”r
("can't„ead flashid or flashid isn't supported.\n");

1895 
	`ş—r_ªd_di§bË_š‹¼u±
(
sdev
);

1897 
sdev
->
advªûd_»ad_¡©e
 |ğ
ADV_READ_SUPPORT_MASK
;

1899 ià(
	`®loc_lun£ts_¡ruùu»
(
sdev
) < 0) {

1900 
	`shªnÚ_”r
("cannot‡llocate†unsets structure.\n");

1904 ià(
	`Ãed_v’dÜ_mode_cmd
(
sdev
))

1905 
	`v’dÜ_mode_cmd_£qu’û
(
sdev
);

1907 
	`lun_£t_®l_ã©u»_w™h_´io
(
sdev
, 0);

1909 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1910 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, sdev->
ifmode
);

1911 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1912 
	`shªnÚ_m¦“p
(2);

1914 ià(
sdev
->
p£udo_¶ªe
 && (sdev->
¶ªes
 == 2)) {

1915 
dwÜd
 = 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 0xc2);

1916 ià((
dwÜd
 & 0xff00) == 0x2000)

1917 
sdev
->
´efix_no_İ_cmd
 = 1;

1919 ià(
	`£t_ecc_Ügªiz©iÚ
(
sdev
) < 0)

1920 
»Ëa£_lun£ts
;

1922 
	`lun_£t_®l_ã©u»_w™h_´io
(
sdev
, 1);

1924 ià(
	`dev_is_8639_w™h_§ndisk
(
sdev
)) {

1925 
	`£t_şk
(
sdev
, 
CLK_166M
 + 1);

1926 
	`lun_£t_ã©u»_ov”_drive
(
sdev
, 4);

1927 
	`lun_£t_ã©u»_odt
(
sdev
);

1929 
	`check_u£r_logicb_size
(
sdev
);

1931 
	`shªnÚ_šfo
("%s: fÏsh id: %16.16Îx\n", 
sdev
->
cdev_Çme
, sdev->
æashid
);

1932 
	`shªnÚ_šfo
("%s: ifmode: %d, ov”drive: %d, f»qmode: %d\n", 
sdev
->
cdev_Çme
, sdev->
ifmode
, sdev->
ov”drive
, sdev->
äeq_mode
);

1936 
»Ëa£_lun£ts
:

1937 
	`»Ëa£_lun£ts_¡ruùu»
(
sdev
);

1940 
	}
}

1942 
	$»ad_poŞ_šfo_g5
(
shªnÚ_dev
 *
sdev
)

1944 *
buf
 = 
NULL
, *
pi
;

1945 
block_size
, 
i
;

1946 
u32
 
phyaddr
, 
poŞ_šfo_addr
, 
üc
;

1948 
block_size
 = 
NOR_PAGE_SIZE
 * 16;

1950 
buf
 = 
	`shªnÚ_vm®loc
(
block_size
);

1951 ià(!
buf
) {

1952 
	`shªnÚ_”r
("Can‚ot‡llocate memory for„eading mbr.\n");

1953  -
ENOMEM
;

1955 
	`shªnÚ_mem£t
(
buf
, 0, 
block_size
);

1957 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1959 
i
 = 0; i < 2; i++) {

1960 
poŞ_šfo_addr
 = (
i
 =ğ0è? 
sdev
->
nÜæash
.poŞ_šfo_add¸: sdev->nÜæash.
poŞ_šfo_backup_addr
;

1961 
phyaddr
 = (
poŞ_šfo_addr
 / 
block_size
) * block_size;

1962 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
phyaddr
, 
block_size
, 
buf
)) {

1963 
	`shªnÚ_w¬n
("»ad…oŞ_šfo% äom NOR FÏsh faed.\n", (
i
 == 0) ? "" : "_backup");

1964 ià(
i
 == 1) {

1965 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1966 
	`shªnÚ_vä“
(
buf
);

1970 
üc
 = *(
u32
*)(
buf
 + 
block_size
 - (crc));

1971 ià(
üc
 !ğ
	`shªnÚ_üc32
(
sdev
, 
buf
, 
block_size
 - (crc), 0)) {

1972 
	`shªnÚ_w¬n
("CRC check faed fÜ…oŞ_šfo%s.\n", (
i
 == 0) ? "" : "_backup");

1973 ià(
i
 == 1) {

1974 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1975 
	`shªnÚ_vä“
(
buf
);

1981 
pi
 = 
buf
 + 
poŞ_šfo_addr
 - 
phyaddr
;

1983 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1985 
	`»cov”_poŞ_šfo
(
sdev
->
¥oŞ
, 
pi
);

1987 
	`shªnÚ_vä“
(
buf
);

1989 
	}
}

1991 
	$upd©e_nÜ_šdex_node
(
shªnÚ_dev
 *
sdev
)

1993 
nÜæash_šdex_node
 *
šdex
 = 
NULL
;

1994 
»Œy
 = 0;

1996 
šdex
 = (
nÜæash_šdex_node
*)
	`shªnÚ_kz®loc
((*šdex), 
GFP_SHANNON
);

1997 ià(!
šdex
) {

1998 
	`shªnÚ_”r
("Can‚ot‡llocate memory for update‚or index‚ode.\n");

1999  -
ENOMEM
;

2002 
šdex
->
mbr_·ge
 = 
sdev
->
nÜæash
.
mbr_addr
 / 
NOR_PAGE_SIZE
;

2003 
šdex
->
mbr_backup_·ge
 = 
sdev
->
nÜæash
.
mbr_backup_addr
 / 
NOR_PAGE_SIZE
;

2004 
šdex
->
bbt_¡¬t_·ge
 = 
sdev
->
nÜæash
.
bbt_addr
 / 
NOR_PAGE_SIZE
;

2005 
šdex
->
bbt_’d_·ge
 = index->
bbt_¡¬t_·ge
 + 
sdev
->
nÜæash
.
bbt_size
 / 
NOR_PAGE_SIZE
 - 1;

2006 
šdex
->
ã©u»_·ge
 = 
sdev
->
nÜæash
.
ã©u»_addr
 / 
NOR_PAGE_SIZE
;

2007 
šdex
->
miüo_code_·ge
 = 
sdev
->
nÜæash
.
miüo_code_addr
 / 
NOR_PAGE_SIZE
;

2008 
šdex
->
üc
 = 
	`shªnÚ_üc32
(
sdev
, (
u8
*)index, (*index) - (index->crc), 0);

2010 
»Œy
:

2011 ià(
	`nÜæash_»ad_modify_wr™e
(
sdev
, sdev->
nÜæash
.
šdex_node_addr
, (*
šdex
), index)) {

2012 ià(
»Œy
 < 5) {

2013 
»Œy
++;

2014 
	`shªnÚ_m¦“p
(500);

2015 
»Œy
;

2017 
	`shªnÚ_”r
("update index‚ode in NOR Flash failed.\n");

2018 
	`shªnÚ_kä“
(
šdex
);

2022 
	`shªnÚ_kä“
(
šdex
);

2024 
	}
}

2026 
	$upd©e_poŞ_šfo_g5
(
shªnÚ_dev
 *
sdev
, 
ş—n_poŞ
)

2028  
	`»äesh_mbr_g5
(
sdev
, 
ş—n_poŞ
);

2029 
	}
}

2031 
	$lun_£t_ã©u»_g’”®_g5
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun_num
, 
ã©u»_cfg
 *
cfg
)

2033 
shªnÚ_»gi¡”_cmd
 *
£t_ã©u»
;

2034 
cmd_off£t
, 
cmdid
;

2035 
couÁ
 = (
cfg
->
nby‹
 > 1) ? 2 : 1;

2036 
u64
 *
d©a
;

2038 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

2039 ià(
cmd_off£t
 < 0) {

2040 
	`shªnÚ_”r
("we‡re killed.\n");

2041 
	`BUG
();

2044 
cmdid
 = 
cmd_off£t
 >> 3;

2045 
£t_ã©u»
 = (
shªnÚ_»gi¡”_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

2046 
£t_ã©u»
->
İcode
 = 
sh_cmd_»g_wr™e
;

2047 ià(
cfg
->
nby‹
 == 1)

2048 
£t_ã©u»
->
d©a_by‹
 = 
cfg
->
d©a
[0];

2049 
£t_ã©u»
->
h—d
 = 
cfg
->
misc
;

2050 ià(
cfg
->
misc
 & 
SECONDARY_CMD_ENABLE_MASK
)

2051 
£t_ã©u»
->
£cÚd¬y_cmd
 = 
cfg
->secondary_cmd;

2052 
£t_ã©u»
->
æash_»g
.
æash_addr
 = 
cfg
->
addr
;

2053 
£t_ã©u»
->
æash_»g
.
by‹s
 = 
cfg
->
nby‹
;

2054 
£t_ã©u»
->
æash_»g
.
æash_cmd
 = 
cfg
->
cmd
;

2055 
£t_ã©u»
->
æash_»g
.
phy_lun
 = 
phy_lun_num
;

2057 ià(
couÁ
 > 1) {

2058 
d©a
 = 
	`cmd_queue_šc
(
£t_ã©u»
, 1);

2060 
	`shªnÚ_mem_wr™eq
(*((
u64
 *)
cfg
->
d©a
), data);

2062 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

2063 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

2064 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

2065 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

2066 
	}
}

2068 
	$lun_g‘_ã©u»_g’”®_g5
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun_num
, 
ã©u»_cfg
 *
cfg
)

2070 
shªnÚ_»gi¡”_cmd
 *
g‘_ã©u»
;

2071 
cmd_off£t
, 
cmdid
;

2072 
couÁ
 = (
cfg
->
nby‹
 > 1) ? 2 : 1;

2074 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

2075 ià(
cmd_off£t
 < 0) {

2076 
	`shªnÚ_”r
("we‡re killed.\n");

2077 
	`BUG
();

2080 
cmdid
 = 
cmd_off£t
 >> 3;

2081 
g‘_ã©u»
 = (
shªnÚ_»gi¡”_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

2082 
g‘_ã©u»
->
İcode
 = 
sh_cmd_»g_»ad
;

2083 
g‘_ã©u»
->
æash_»g
.
æash_addr
 = 
cfg
->
addr
;

2084 
g‘_ã©u»
->
æash_»g
.
by‹s
 = 
cfg
->
nby‹
;

2085 
g‘_ã©u»
->
æash_»g
.
æash_cmd
 = 
cfg
->
cmd
;

2086 
g‘_ã©u»
->
æash_»g
.
phy_lun
 = 
phy_lun_num
;

2088 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

2089 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

2090 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

2091 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

2092 
	}
}

2094 
	$h¬dw¬e_d–ay_g5
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun_num
)

2096 
shªnÚ_»gi¡”_cmd
 *
£t_ã©u»
;

2097 
cmd_off£t
, 
cmdid
;

2098 
couÁ
 = 1;

2100 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

2101 ià(
cmd_off£t
 < 0) {

2102 
	`shªnÚ_”r
("we‡re killed.\n");

2103 
	`BUG
();

2106 
cmdid
 = 
cmd_off£t
 >> 3;

2107 
£t_ã©u»
 = (
shªnÚ_»gi¡”_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

2108 
£t_ã©u»
->
İcode
 = 
sh_cmd_»g_wr™e
;

2109 
£t_ã©u»
->
h—d
 = 0xA0;

2110 
£t_ã©u»
->
æash_»g
.
æash_addr
 = 0x0;

2111 
£t_ã©u»
->
æash_»g
.
by‹s
 = 4;

2112 
£t_ã©u»
->
æash_»g
.
æash_cmd
 = 0x0;

2113 
£t_ã©u»
->
æash_»g
.
phy_lun
 = 
phy_lun_num
;

2115 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

2116 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

2117 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

2118 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

2119 
	}
}

2121 
	$shªnÚ_pŞlšg_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
, 
logicb_t
 
lun_pba
, 
u8
 
©Œ
, u8 
h—d
)

2123 
shªnÚ_cmd
 *
no_İ
;

2124 
cmd_off£t
, 
cmdid
;

2125 
couÁ
 = 1;

2127 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

2128 ià(
cmd_off£t
 < 0) {

2129 
	`shªnÚ_”r
("we‡re killed.\n");

2130 
	`BUG
();

2133 
cmdid
 = 
cmd_off£t
 >> 3;

2134 
no_İ
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

2135 
no_İ
->
İcode
 = 
sh_cmd_no_İ
;

2136 
no_İ
->
fœ¡_logicb
 = 
©Œ
;

2137 
no_İ
->
h—d
 = head;

2139 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
lun£t
->
sdev
, 
lun_pba
/lun£t->sdev->
logicbs_š_·ge
, 
phy_lun
), &
no_İ
->
dwÜd1
);

2141 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

2142 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

2143 
lun£t
->
cmd_šfo
[
cmdid
].
lun_pba
 =†un_pba;

2144 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

2145 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

2146 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

2147 
	}
}

2149 
	$¢­_»ad_pŞlšg_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
, 
logicb_t
 
lun_pba
, 
u8
 
©Œ
, u8 
h—d
)

2151 
	`shªnÚ_pŞlšg_cmd
(
lun£t
, 
phy_lun
, 
lun_pba
, 
©Œ
, 
h—d
);

2152 
	}
}

2154 
	#g‘_ecc_·r™y_size
(
_sdev
è(((_sdev)->
ecc_cÜ»ùiÚ_pow”
 * 14è/ 8)

	)

2155 
	#SECTOR_PAYLOAD
 (4110)

	)

2156 
	$g‘_codewÜd_šdex
(
shªnÚ_dev
 *
sdev
, 
£ùÜ_šdex
)

2158 
cw_·ylßd
;

2159 
cw_off£t
 = 
sdev
->
fœ¡_codewÜd_off£t
;

2161 
cw_·ylßd
 = 
sdev
->
ecc_codewÜd_size
 - 
	`g‘_ecc_·r™y_size
(sdev);

2162  ((
£ùÜ_šdex
 * 
SECTOR_PAYLOAD
è+ 
cw_off£t
è/ 
cw_·ylßd
;

2163 
	}
}

2165 
	$g‘_codewÜd_addr
(
shªnÚ_dev
 *
sdev
, 
£ùÜ_šdex
)

2167 
cw_šdex
 = 
	`g‘_codewÜd_šdex
(
sdev
, 
£ùÜ_šdex
);

2168 
iow
 = (
sdev
->
b™_mode
 =ğ
MODE_8BIT
) ? 1 : 2;

2170 ià(!
cw_šdex
)

2173  (
cw_šdex
 * 
sdev
->
ecc_codewÜd_size
 - sdev->
fœ¡_codewÜd_off£t
è/ 
iow
;

2174 
	}
}

2176 
šlše
 
u32
 
	$g‘_cŞumn_addr
(
shªnÚ_dev
 *
sdev
, 
u32
 
pba
)

2178  
sdev
->
£ùÜs_codewÜd_addr
[
pba
 % sdev->
logicbs_š_·ge
];

2179 
	}
}

2181 
šlše
 
	$g‘_£ùÜ_ncodewÜd
(
shªnÚ_dev
 *
sdev
, 
£ùÜ_šdex
)

2183 
cw_off£t
 = 
sdev
->
fœ¡_codewÜd_off£t
;

2184 
phy·ge_size
 = 
sdev
->
Çnd_·ge_size
;

2185 
tÙ®_codewÜd
 = (
phy·ge_size
 + 
cw_off£t
è/ 
sdev
->
ecc_codewÜd_size
;

2186 
ncodewÜd
 = 0;

2188 ià(
£ùÜ_šdex
 =ğ(
sdev
->
logicbs_š_·ge
 - 1))

2189 
ncodewÜd
 = 
tÙ®_codewÜd
 - 
	`g‘_codewÜd_šdex
(
sdev
, 
£ùÜ_šdex
);

2191 
ncodewÜd
 = 
	`g‘_codewÜd_šdex
(
sdev
, 
£ùÜ_šdex
 + 1) - get_codeword_index(sdev, sector_index) + 1;

2193  
ncodewÜd
;

2194 
	}
}

2196 
	$g‘_£ùÜs_couÁ
(
shªnÚ_dev
 *
sdev
, 
£ùÜ_šdex
)

2198 
iow
 = (
sdev
->
b™_mode
 =ğ
MODE_8BIT
) ? 1 : 2;

2199 
·¹Ÿl_·ge_size
 = 9344 * 
iow
;

2200 
·¹Ÿl_·ge_ncw
 = 
·¹Ÿl_·ge_size
 / 
sdev
->
ecc_codewÜd_size
;

2201 
off£t
 = 0;

2202 
n£ùÜs
 = 0;

2204 
·¹Ÿl_·ge_ncw
 -ğ
	`g‘_£ùÜ_ncodewÜd
(
sdev
, 
£ùÜ_šdex
);

2205 
·¹Ÿl_·ge_ncw
 >= 0) {

2206 
n£ùÜs
++;

2207 
off£t
++;

2208 ià((
£ùÜ_šdex
 + 
off£t
è>ğ
sdev
->
logicbs_š_·ge
)

2211 
·¹Ÿl_·ge_ncw
++;

2212 
·¹Ÿl_·ge_ncw
 -ğ
	`g‘_£ùÜ_ncodewÜd
(
sdev
, 
£ùÜ_šdex
 + 
off£t
);

2215  
n£ùÜs
;

2216 
	}
}

2218 
	$¢­_»ad_’abË
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_lun
 *
lun
, 
shªnÚ_»que¡
 *
fœ¡_»q
)

2220 
ã©u»_cfg
 
cfg
 = 
	`GENERAL_CFG_4
(0xF5, 0x00245006);

2222 ià((
lun
->
û
->
ã©u»_æags
 & 
SNAPREAD_ENABLE_MASK
) == 0) {

2223 
lun
->
û
->
ã©u»_æags
 |ğ
SNAPREAD_ENABLE_MASK
;

2224 
	`BUG_ON
(
lun£t
->
sdev
->
¢­_»ad_’abË
 == 0);

2225 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2226 
	`h¬dw¬e_d–ay_g5
(
lun£t
, 
lun
->
phy_lun_num
);

2227 
	`h¬dw¬e_d–ay_g5
(
lun£t
, 
lun
->
phy_lun_num
);

2229 
	}
}

2231 
	$¢­_»ad_£t_cŞ_addr
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, 
u32
 
cŞ_addr
)

2233 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

2234 
shªnÚ_lun£t
 *
lun£t
 = 
lun
->lunset;

2235 
u32
 
·ge
 = (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
;

2236 
u32
 
block
 = (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è/ sdev->
·ges_š_eblock
;

2238 
u8
 
c1
 = 
cŞ_addr
 & 0xFF;

2239 
u8
 
c2
 = (
cŞ_addr
 >> 8) & 0x7F;

2240 
u8
 
r1
 = 
·ge
 & 0xFF;

2241 
u8
 
r2
 = ((
block
 & 0x3Fè<< 2è| ((
·ge
 >> 8) & 0x3);

2242 
u8
 
r3
 = ((
lun
->
phy_lun_num
 % 2è<< 6è| ((
block
 >> 6) & 0x3F);

2243 
u32
 
µa
 = ((
r3
 & 0x3F)<< 16è| (
r2
 << 8è| 
r1
;

2244 
ã©u»_cfg
 
cfg
 = {

2245 .
v®id
 = 
FEATURE_VALID_MASK
,

2246 .
cmd
 = 0x0,

2247 .
addr
 = 
c1
,

2248 .
misc
 = 0x26,

2249 .
nby‹
 = 0,

2250 .
£cÚd¬y_cmd
 = 0,

2253 
	`BUG_ON
(
block
 >ğ
sdev
->
mbr
.
eblocks_š_lun
);

2254 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2256 
cfg
.
addr
 = 
c2
;

2257 
cfg
.
misc
 = 0x2E;

2258 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2260 
cfg
.
addr
 = 
r1
;

2261 
cfg
.
misc
 = 0x2E;

2262 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2264 
cfg
.
addr
 = 
r2
;

2265 
cfg
.
misc
 = 0x2E;

2266 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2268 
cfg
.
addr
 = 
r3
;

2269 
cfg
.
misc
 = 0x6C;

2270 
cfg
.
£cÚd¬y_cmd
 = 0x30;

2271 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2278 ià(
µa
 !ğ
	`cÚv”t_µa
(
sdev
, 
»q
->
pba
.
lun_pba
 / sdev->
logicbs_š_·ge
))

2279 
	`shªnÚ_”r
("¢­_»ad:…·=%ld,„eq->µa=%ld\n", 
µa
, 
	`cÚv”t_µa
(
sdev
, 
»q
->
pba
.
lun_pba
 / sdev->
logicbs_š_·ge
));

2281 
	`¢­_»ad_pŞlšg_cmd
(
lun£t
, 
lun
->
phy_lun_num
, 
»q
->
pba
.
lun_pba
, 0x40, 0x22);

2282 
	}
}

2284 
	$__¢­_»ad_di§bË
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_lun
 *
lun
, 
fÜû
)

2286 
ã©u»_cfg
 
cfg
 = 
	`GENERAL_CFG_4
(0xF5, 0x00);

2288 ià((
lun
->
û
->
ã©u»_æags
 & 
SNAPREAD_ENABLE_MASK
è|| 
fÜû
) {

2289 
lun
->
û
->
ã©u»_æags
 &ğ~
SNAPREAD_ENABLE_MASK
;

2290 
	`BUG_ON
(
lun£t
->
sdev
->
¢­_»ad_’abË
 == 0);

2291 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2292 
	`h¬dw¬e_d–ay_g5
(
lun£t
, 
lun
->
phy_lun_num
);

2293 
	`h¬dw¬e_d–ay_g5
(
lun£t
, 
lun
->
phy_lun_num
);

2295 
	}
}

2297 
	$¢­_»ad_di§bË
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_lun
 *
lun
, 
fÜû
, 
has_lock
)

2299 ià(!
has_lock
)

2300 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

2302 
	`__¢­_»ad_di§bË
(
lun£t
, 
lun
, 
fÜû
);

2304 ià(!
has_lock
)

2305 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

2306 
	}
}

2308 
	$ÿn_¢­_»ad
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
fœ¡_»q
)

2310 
u32
 
fœ¡_pba
 = 
fœ¡_»q
->
pba
.
lun_pba
;

2311 
u32
 
Ï¡_pba
 = 
fœ¡_»q
->
pba
.
lun_pba
;

2312 
pba_šdex
;

2313 
lun
 = 
fœ¡_»q
->
pba
.lun;

2314 
u32
 
µa
 = 
fœ¡_»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
;

2315 
u32
 
Ï¡_µa
;

2316 
u32
 
fœ¡_µa
;

2317 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + (
µa
 / sdev->
·ges_š_siblšg_eblock
);

2318 
shªnÚ_»que¡
 *
»q
;

2320 ià(!
shªnÚ_do_¢­»ad
)

2323 ià(!
sdev
->
¢­_»ad_’abË
)

2326 ià(!
	`shªnÚ_dev_is_g5
(
sdev
))

2329 ià(
sdev
->
š™_dÚe
 < 
STAGE9_DONE
)

2332 ià(
sdev
->
¡©e
 =ğ
SHN_STATE_RECONFIG
)

2335 ià(
sdev
->
¡©e
 =ğ
SHN_STATE_RESET
)

2338 ià(
sb
->
¡©e
 =ğ
FREE_BLOCK
 || sb->¡©=ğ
MBR_BLOCK
) {

2342 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
fœ¡_»q
->
chunk_li¡
, chunk_list) {

2343 
	`BUG_ON
(
»q
->
pba
.
lun
 !=†un);

2344 ià(
»q
->
pba
.
lun_pba
 < 
fœ¡_pba
)

2345 
fœ¡_pba
 = 
»q
->
pba
.
lun_pba
;

2346 ià(
»q
->
pba
.
lun_pba
 > 
Ï¡_pba
)

2347 
Ï¡_pba
 = 
»q
->
pba
.
lun_pba
;

2350 
Ï¡_µa
 = 
Ï¡_pba
 / 
sdev
->
logicbs_š_·ge
;

2351 
fœ¡_µa
 = 
fœ¡_pba
 / 
sdev
->
logicbs_š_·ge
;

2352 ià(
Ï¡_µa
 !ğ
fœ¡_µa
)

2355 ià((
sdev
->
aùive_blk
[0]->
sb_šdex
 =ğ
sb
->sb_index) && \

2356 (
sdev
->
wr_chunk
[0] - (
µa
 % sdev->
·ges_š_eblock
) <= 64)) {

2360 ià((
sdev
->
aùive_blk
[1]->
sb_šdex
 =ğ
sb
->sb_index) && \

2361 (
sdev
->
wr_chunk
[1] - (
µa
 % sdev->
·ges_š_eblock
) <= 64)) {

2365 
pba_šdex
 = 
fœ¡_pba
 % 
sdev
->
logicbs_š_·ge
;

2366 ià((
Ï¡_pba
 - 
fœ¡_pba
è< 
	`g‘_£ùÜs_couÁ
(
sdev
, 
pba_šdex
))

2370 
	}
}

2373 
	$do_¢­_»ad
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
fœ¡_»q
, 
¶ªes
)

2375 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

2376 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
fœ¡_»q
->
pba
.lun];

2377 
u32
 
cŞ_addr
 = 0x0;

2379 
	`BUG_ON
(
lun£t
->
šdex
 !ğ
lun
->lunset->index);

2380 ià(
¶ªes
 > 1)

2381 
out
;

2382 ià(
	`ÿn_¢­_»ad
(
sdev
, 
lun£t
, 
fœ¡_»q
)) {

2383 
cŞ_addr
 = 
	`g‘_cŞumn_addr
(
sdev
, 
fœ¡_»q
->
pba
.
lun_pba
);

2385 
	`¢­_»ad_’abË
(
lun£t
, 
lun
, 
fœ¡_»q
);

2386 
	`¢­_»ad_£t_cŞ_addr
(
sdev
, 
fœ¡_»q
, 
cŞ_addr
);

2387 
	`shªnÚ_©omic64_šc
(&
sdev
->
¢­_»ad_couÁ”
);

2391 
out
:

2392 
	`¢­_»ad_di§bË
(
lun£t
, 
lun
, 0, 1);

2394 
	}
}

2396 
	$v’dÜ_mode_’‹r
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
)

2398 
ã©u»_cfg
 
cfg
;

2400 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2401 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2402 
cfg
.
cmd
 = 0x5C;

2403 
cfg
.
£cÚd¬y_cmd
 = 0xC5;

2404 
cfg
.
misc
 |ğ
SECONDARY_CMD_ENABLE_MASK
;

2405 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2407 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2408 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2409 
cfg
.
cmd
 = (
phy_lun
 % 2) ? 0xF2 : 0xF1;

2410 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2412 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2413 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2414 
cfg
.
cmd
 = 0x56;

2415 
cfg
.
d©a
[0] = 0x01;

2416 
cfg
.
nby‹
 = 1;

2417 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2418 
	}
}

2420 
	$v’dÜ_mode_ex™
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
)

2422 
ã©u»_cfg
 
cfg
;

2424 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2425 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2426 
cfg
.
cmd
 = (
phy_lun
 % 2) ? 0xF2 : 0xF1;

2427 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2429 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2430 
cfg
.
cmd
 = 0x56;

2431 
cfg
.
addr
 = 0x0;

2432 
cfg
.
nby‹
 = 1;

2433 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2435 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2436 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2437 
cfg
.
cmd
 = 0xFF;

2438 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2439 
	}
}

2441 
	$v’dÜ_mode_£t_bË1
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
)

2443 
ã©u»_cfg
 
cmd_cfg
, 
cfg
;

2444 
i
;

2446 
v’dÜ_mode_bË
 
bË1
[
VENDOR_MODE_CMD_SEQ_TABLE1_LEN
] = {

2447 {.
addr
 = 0x46, .
d©a
 = 0xE5},

2448 {.
addr
 = 0x47, .
d©a
 = 0x80},

2449 {.
addr
 = 0x5B, .
d©a
 = 0xC5},

2450 {.
addr
 = 0x97, .
d©a
 = 0x03},

2451 {.
addr
 = 0x9A, .
d©a
 = 0x4F},

2452 {.
addr
 = 0x9C, .
d©a
 = 0xF0},

2453 {.
addr
 = 0x9D, .
d©a
 = 0x0D}

2456 
	`shªnÚ_mem£t
(&
cmd_cfg
, 0, (cmd_cfg));

2457 
cmd_cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2458 
cmd_cfg
.
cmd
 = (
phy_lun
 % 2) ? 0xF2 : 0xF1;

2460 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2461 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2462 
cfg
.
cmd
 = 0x56;

2463 
cfg
.
nby‹
 = 1;

2465 
i
 = 0; i < 
VENDOR_MODE_CMD_SEQ_TABLE1_LEN
; i++) {

2466 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
);

2467 
cfg
.
addr
 = 
bË1
[
i
].addr & 0xFF;

2468 
cfg
.
d©a
[0] = 
bË1
[
i
].data & 0xFF;

2469 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2471 
	}
}

2473 
	$v’dÜ_mode_£t_bË2
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
)

2475 
ã©u»_cfg
 
cmd_cfg
[5], 
cfg
;

2476 
u8
 
»adout_d©a
[
VENDOR_MODE_CMD_SEQ_TABLE2_LEN
];

2477 
u8
 
check_bË2
[
VENDOR_MODE_CMD_SEQ_TABLE2_LEN
];

2478 
i
, 
w©ch_cmdid
;

2480 
v’dÜ_mode_bË
 
bË2
[
VENDOR_MODE_CMD_SEQ_TABLE2_LEN
] = {

2481 {.
addr
 = 0x27, .
d©a
 = 2},

2482 {.
addr
 = 0x28, .
d©a
 = 4},

2483 {.
addr
 = 0x29, .
d©a
 = 1},

2484 {.
addr
 = 0x2A, .
d©a
 = 2},

2485 {.
addr
 = 0x2B, .
d©a
 = 0},

2486 {.
addr
 = 0x3B, .
d©a
 = -2},

2487 {.
addr
 = 0x3C, .
d©a
 = 96},

2488 {.
addr
 = 0x2D, .
d©a
 = -2},

2489 {.
addr
 = 0x2F, .
d©a
 = -1},

2490 {.
addr
 = 0x31, .
d©a
 = -3},

2491 {.
addr
 = 0x33, .
d©a
 = -1}

2494 
	`shªnÚ_mem£t
(
cmd_cfg
, 0, (cmd_cfg));

2495 
cmd_cfg
[0].
v®id
 = 
FEATURE_VALID_MASK
;

2496 
cmd_cfg
[0].
cmd
 = (
phy_lun
 % 2) ? 0xF2 : 0xF1;

2498 
cmd_cfg
[1].
v®id
 = 
FEATURE_VALID_MASK
;

2499 
cmd_cfg
[1].
cmd
 = 0x56;

2500 
cmd_cfg
[1].
addr
 = 0x01;

2501 
cmd_cfg
[1].
nby‹
 = 1;

2502 
cmd_cfg
[1].
d©a
[0] = 0x06;

2504 
cmd_cfg
[2].
v®id
 = 
FEATURE_VALID_MASK
;

2505 
cmd_cfg
[2].
cmd
 = 0x00;

2506 
cmd_cfg
[2].
misc
 |ğ(
PREFIX_CMD_MASK
 | 
FORCE_ADDR_CYCLE_MASK
);

2508 
cmd_cfg
[3].
v®id
 = 
FEATURE_VALID_MASK
;

2509 
cmd_cfg
[3].
cmd
 = 0x5F;

2510 
cmd_cfg
[3].
nby‹
 = 1;

2512 
cmd_cfg
[4].
v®id
 = 
FEATURE_VALID_MASK
;

2513 
cmd_cfg
[4].
cmd
 = 0x56;

2514 
cmd_cfg
[4].
addr
 = 0x01;

2515 
cmd_cfg
[4].
nby‹
 = 1;

2516 
cmd_cfg
[4].
d©a
[0] = 0x00;

2518 
	`shªnÚ_mem£t
(&
cfg
, 0, (cfg));

2519 
cfg
.
v®id
 = 
FEATURE_VALID_MASK
;

2520 
cfg
.
cmd
 = 0x56;

2521 
cfg
.
nby‹
 = 1;

2524 
i
 = 0; i < 
VENDOR_MODE_CMD_SEQ_TABLE2_LEN
; i++) {

2525 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[0]);

2526 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[1]);

2528 
cmd_cfg
[2].
addr
 = 
bË2
[
i
].addr & 0xFF;

2529 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[2]);

2531 
w©ch_cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

2532 
	`lun_g‘_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[3]);

2534 
lun£t
->
sq_h—d
 !ğ
	`»ad_»g_§ã
Öun£t->
sdev
, &lun£t->
lun_b¬
->
cq_h—d
))

2535 
	`shªnÚ_m¦“p
(1);

2536 
»adout_d©a
[
i
] = 
	`shªnÚ_mem_»adq
(
lun£t
->
cq_addr
 + 
w©ch_cmdid
) & 0xFF;

2538 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[0]);

2539 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[4]);

2541 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[0]);

2542 
cfg
.
addr
 = 
bË2
[
i
].addr & 0xFF;

2543 
cfg
.
d©a
[0] = (
»adout_d©a
[
i
] + 
bË2
[i].data) & 0xFF;

2544 
check_bË2
[
i
] = 
cfg
.
d©a
[0];

2545 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cfg
);

2549 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[0]);

2550 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[1]);

2552 
i
 = 0; i < 
VENDOR_MODE_CMD_SEQ_TABLE2_LEN
; i++) {

2553 
cmd_cfg
[2].
addr
 = 
bË2
[
i
].addr & 0xFF;

2554 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[2]);

2556 
w©ch_cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

2557 
	`lun_g‘_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[3]);

2559 
lun£t
->
sq_h—d
 !ğ
	`»ad_»g_§ã
Öun£t->
sdev
, &lun£t->
lun_b¬
->
cq_h—d
))

2560 
	`shªnÚ_m¦“p
(1);

2561 
»adout_d©a
[
i
] = 
	`shªnÚ_mem_»adq
(
lun£t
->
cq_addr
 + 
w©ch_cmdid
) & 0xFF;

2562 ià(
»adout_d©a
[
i
] !ğ
check_bË2
[i])

2563 
	`shªnÚ_w¬n
("v’dÜ modcmd sequ’û check faed, 0x%02X - 0x%02X.\n", 
»adout_d©a
[
i
], 
check_bË2
[i]);

2566 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[0]);

2567 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[4]);

2568 
	}
}

2570 
	$Ãed_v’dÜ_mode_cmd
(
shªnÚ_dev
 *
sdev
)

2572 
shªnÚ_lun£t
 *
lun£t
 = 
NULL
;

2573 
ã©u»_cfg
 
cmd_cfg
[4];

2574 
i
, 
»t
, 
w©ch_cmdid
, 
phy_lun
 = 0;

2576 ià(!
shªnÚ_v’dÜ_cmd
)

2579 ià(!(
sdev
->
mbr
.
ã©u»_æags
 & 
VENDOR_MODE_CMD_ENABLE
))

2582 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

2583 
phy_lun
 = 
logiÿl_lun_to_phy_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
i
);

2584 
lun£t
 = &
sdev
->
lun£ts
[
phy_lun
 / sdev->
max_lun_š_lun£t
];

2585 ià(!
	`shªnÚ_‹¡_b™
(
phy_lun
, (*)
sdev
->
mbr
.
bad_phy_lun_m­
))

2588 ià(
i
 =ğ
sdev
->
lun_couÁ
)

2591 
	`shªnÚ_mem£t
(
cmd_cfg
, 0, (cmd_cfg));

2592 
cmd_cfg
[0].
v®id
 = 
FEATURE_VALID_MASK
;

2593 
cmd_cfg
[0].
cmd
 = (
phy_lun
 % 2) ? 0xF2 : 0xF1;

2595 
cmd_cfg
[1].
v®id
 = 
FEATURE_VALID_MASK
;

2596 
cmd_cfg
[1].
cmd
 = 0x56;

2597 
cmd_cfg
[1].
addr
 = 0x01;

2598 
cmd_cfg
[1].
nby‹
 = 1;

2599 
cmd_cfg
[1].
d©a
[0] = 0x06;

2601 
cmd_cfg
[2].
v®id
 = 
FEATURE_VALID_MASK
;

2602 
cmd_cfg
[2].
cmd
 = 0x00;

2603 
cmd_cfg
[2].
addr
 = 0x9A;

2604 
cmd_cfg
[2].
misc
 |ğ(
PREFIX_CMD_MASK
 | 
FORCE_ADDR_CYCLE_MASK
);

2606 
cmd_cfg
[3].
v®id
 = 
FEATURE_VALID_MASK
;

2607 
cmd_cfg
[3].
cmd
 = 0x5F;

2608 
cmd_cfg
[3].
nby‹
 = 1;

2610 
	`v’dÜ_mode_’‹r
(
lun£t
, 
phy_lun
);

2612 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[0]);

2613 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[1]);

2615 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[2]);

2617 
w©ch_cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

2618 
	`lun_g‘_ã©u»_g’”®_g5
(
lun£t
, 
phy_lun
, &
cmd_cfg
[3]);

2620 
lun£t
->
sq_h—d
 !ğ
	`»ad_»g_§ã
Öun£t->
sdev
, &lun£t->
lun_b¬
->
cq_h—d
))

2621 
	`shªnÚ_m¦“p
(1);

2622 ià((
	`shªnÚ_mem_»adq
(
lun£t
->
cq_addr
 + 
w©ch_cmdid
) & 0xFF) == 0x0F)

2623 
»t
 = 1;

2625 
»t
 = 0;

2627 
	`v’dÜ_mode_ex™
(
lun£t
, 
phy_lun
);

2629  
»t
;

2630 
	}
}

2632 
	$v’dÜ_mode_cmd_£qu’û
(
shªnÚ_dev
 *
sdev
)

2634 
shªnÚ_lun£t
 *
lun£t
;

2635 
i
, 
phy_lun
;

2637 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

2638 
phy_lun
 = 
logiÿl_lun_to_phy_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
i
);

2639 
lun£t
 = &
sdev
->
lun£ts
[
phy_lun
 / sdev->
max_lun_š_lun£t
];

2640 ià(
	`shªnÚ_‹¡_b™
(
phy_lun
, (*)
sdev
->
mbr
.
bad_phy_lun_m­
))

2643 
	`v’dÜ_mode_’‹r
(
lun£t
, 
phy_lun
);

2645 
	`v’dÜ_mode_£t_bË1
(
lun£t
, 
phy_lun
);

2647 
	`v’dÜ_mode_£t_bË2
(
lun£t
, 
phy_lun
);

2649 
	`v’dÜ_mode_ex™
(
lun£t
, 
phy_lun
);

2651 
	}
}

2653 
	$shªnÚ_ç¡_»ad_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

2655 
shªnÚ_lun
 *
lun
 = 
lun£t
->
sdev
->lun[
»q
->
pba
.lun];

2656 
ã©u»_cfg
 
cfg
 = {

2657 .
v®id
 = 
FEATURE_VALID_MASK
,

2658 .
addr
 = 0,

2659 .
cmd
 = 0x36,

2660 .
£cÚd¬y_cmd
 = 0,

2661 .
misc
 = 
VENDOR_MODE_MASK
 | 
PREFIX_CMD_MASK
,

2662 .
nby‹
 = 0

2664 
	`lun_£t_ã©u»_g’”®_g5
(
lun£t
, 
lun
->
phy_lun_num
, &
cfg
);

2665 
	}
}

	@shannon_ioctl.c

12 
	~"shªnÚ.h
"

13 
	~"shªnÚ_ioùl.h
"

14 
	~"shªnÚ_»gs.h
"

15 
	~"shªnÚ_scsi.h
"

17 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

18 
Ï¡_sb_dÚe
[2];

19 
cu¼’t_¡re_·ge
[2];

20 
u64
 *
m‘ad©a_·r™y
[2];

21 *
·r™y_buf
[2];

22 
¥šlock_t
 
·r™y_buf_lock
[2];

23 
wa™_queue_h—d_t
 
sb_dÚe_ev’t
[2];

24 
©omic_t
 
»maššg_¡re_·ges
[2];

25 
©omic_t
 
»maššg_·ges
[2];

26 
·ges_š_¡re
[2];

27 
wa™_queue_h—d_t
 
wr™e_dÚe_ev’t
[2];

28 
wa™_queue_h—d_t
 
Ï¡_·r™y_dÚe_ev’t
[2];

29 
·r™y_cmd
[2];

31 
shªnÚ_memblock_poŞ
 
m­_bË_poŞ
;

32 
shªnÚ_memblock_poŞ
 
‹mp_bË_poŞ
;

33 
shªnÚ_´eãtch_’abË
;

35 
wr™e_advªûd_»ad_miüocode
(
shªnÚ_dev
 *
sdev
, 
num
);

37 
	$lun_»äesh_mbr_eblks_ÿÎback
(
shªnÚ_bio
 *
sbio
)

39 
shªnÚ_lun
 *
lun
 = (shªnÚ_luÀ*)
sbio
->
d©a
;

40 
lun
->
»äesh_Úe_mbr_eblk_dÚe
 = 1;

41 
	`shªnÚ_wake_up
(&
lun
->
»äesh_Úe_mbr_eblk_dÚe_ev’t
);

42 
	}
}

44 
shªnÚ_bio
 *
	$´•¬e_»äesh_mbr
(
shªnÚ_lun
 *
lun
)

46 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

47 
shªnÚ_poŞ
 *
¥oŞ
ğ
sdev
->spool;

48 
shªnÚ_bio
 *
sbio
 = 
NULL
;

49 
shªnÚ_»que¡
 *
»q
;

50 *
mbr_±r
 = 
NULL
;

51 
__u16
 *
bbt_±r
 = 
NULL
;

52 
shªnÚ_poŞ_šfo
 *
poŞ_šfo
 = 
NULL
;

53 
logicbs_š_poŞ_šfo
 = 0;

54 
·ges
, 
u£_b™m­
, 
i
 = 0;

56 ià(
¥oŞ
) {

57 
poŞ_šfo
 = 
	`shªnÚ_km®loc
((*poŞ_šfo), 
GFP_SHANNON
);

58 ià(
poŞ_šfo
 =ğ
NULL
) {

59 
	`shªnÚ_”r
("allocate…ool_info failed.\n");

60 
out
;

62 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

63 
	`cİy_poŞ_šfo
(
poŞ_šfo
, 
¥oŞ
->pool_info);

64 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

65 
logicbs_š_poŞ_šfo
 = ((*
poŞ_šfo
è+ 
sdev
->
logicb_size
 - 1) / sdev->logicb_size;

67 
bbt_±r
 = 
	`shªnÚ_km®loc
(
LUN_BBT_SIZE
, 
GFP_SHANNON
);

68 ià(
bbt_±r
 =ğ
NULL
) {

69 
	`shªnÚ_”r
("allocate bbt_ptr failed!\n");

70 
out
;

72 
mbr_±r
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

74 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

75 
	`£t_sbio_debug_g
(
sbio
, 
REFRESH_MBR_EBLKS_TAG
);

77 ià(
¥oŞ
 && (
lun
->
lun_num
 < 
POOL_INFO_LUNS
))

78 
·ges
 = 3;

80 
·ges
 = 2;

81 
sbio
->
logicbs
 = 1 + 
sdev
->
logicbs_š_·ge
 * 
·ges
;

82 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

84 
sbio
->
ÿÎback
 = 
lun_»äesh_mbr_eblks_ÿÎback
;

85 
sbio
->
d©a
 = 
lun
;

86 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

88 
	`shªnÚ_mu‹x_lock
(&
sdev
->
modify_mbr_£m
);

89 
	`cİy_mbr_to_memÜy
((
shªnÚ_mbr
 *)
mbr_±r
, &
sdev
->
mbr
);

90 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
modify_mbr_£m
);

92 
	`shªnÚ_¥š_lock_bh
(&
lun
->
bbt_lock
);

93 ià(
	`bbt_usšg_b™m­
(
lun
->
bbt
, 
sdev
)) {

94 
	`shªnÚ_mem£t
(
bbt_±r
, 0, 
LUN_BBT_SIZE
);

95 
	`shªnÚ_memıy
(
bbt_±r
, 
lun
->
bbt
, 
LUN_BBT_SIZE
);

97 ià(
lun
->
bad_blk_couÁ
 >= 2048) {

98 
	`shªnÚ_memıy
(
bbt_±r
, 
lun
->
bbt
, 
LUN_BBT_SIZE
);

99 
	`shªnÚ_mem£t
(
lun
->
bbt
, 0, 
LUN_BBT_SIZE
);

100 ((
u64
 *)
lun
->
bbt
)[0] = 
BBT_BITMAP_WATERMARK
;

101 
i
 = 0; i < 
lun
->
bad_blk_couÁ
; i++)

102 
	`shªnÚ_£t_b™_Ë
(
bbt_±r
[
i
] + 64, 
lun
->
bbt
);

103 
	`shªnÚ_memıy
(
bbt_±r
, 
lun
->
bbt
, 
LUN_BBT_SIZE
);

105 
	`shªnÚ_mem£t
(
bbt_±r
, 0xFF, 
LUN_BBT_SIZE
);

106 
i
 = 0; i < 
LUN_BBT_SIZE
 / 2; i++)

107 
	`shªnÚ_mem_wr™ew
(
lun
->
bbt
[
i
], 
bbt_±r
 + i);

110 
u£_b™m­
 = 
	`bbt_usšg_b™m­
(
lun
->
bbt
, 
sdev
);

111 
	`shªnÚ_¥š_uÆock_bh
(&
lun
->
bbt_lock
);

115 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

116 
	`£t_»q_debug_g
(
»q
, 
ERASE_BLOCK_TAG
, 0);

117 
»q
->
İcode
 = 
sh_cmd_”a£
;

118 
»q
->
pba
.
lun
 =†un->
lun_num
;

119 
»q
->
µa
 = 0;

120 
»q
->
lba
 = 
LONG_INVALID_LBA
;

121 
»q
->
sbio
 = sbio;

122 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

123 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

127 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

128 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

129 
	`£t_»q_debug_g
(
»q
, 
WRITE_MBR_TAG
, 
i
);

130 
»q
->
İcode
 = 
sh_cmd_wr™e
;

131 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

132 
»q
->
h—d
 = 
MBR_HEAD
;

133 
»q
->
d©©y³
 = 
SHORT_LBA
;

134 
»q
->
lba
 = 
MBR_WATERMARK
;

135 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
è| (»q->
lba
 & 
LONG_LBA_MASK
);

136 
»q
->
pba
.
lun
 =†un->
lun_num
;

137 
»q
->
pba
.
lun_pba
 = 
i
;

138 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

139 ià(
i
 == 0)

140 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, 
mbr_±r
 + 
i
 * 
sdev
->
logicb_size
, sdev->logicb_size);

141 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

142 
»q
->
sbio
 = sbio;

143 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

147 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

148 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

149 
	`£t_»q_debug_g
(
»q
, 
WRITE_STATIC_BBT_TAG
, 
i
);

150 
»q
->
İcode
 = 
sh_cmd_wr™e
;

151 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

152 
»q
->
h—d
 = 
MBR_HEAD
;

153 
»q
->
d©©y³
 = 
SHORT_LBA
;

154 
»q
->
lba
 = 
MBR_WATERMARK
;

155 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
è| (»q->
lba
 & 
LONG_LBA_MASK
);

156 
»q
->
pba
.
lun
 =†un->
lun_num
;

157 
»q
->
pba
.
lun_pba
 = 1 * 
sdev
->
logicbs_š_·ge
 + 
i
;

158 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

159 ià(
i
 < 
LUN_BBT_SIZE
/
sdev
->
logicb_size
)

160 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, (*)
bbt_±r
 + 
sdev
->
logicb_size
 * 
i
, sdev->logicb_size);

162 ià(
u£_b™m­
)

163 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0, 
sdev
->
logicb_size
);

165 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0xFF, 
sdev
->
logicb_size
);

167 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

168 
»q
->
sbio
 = sbio;

169 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

172 ià(!
¥oŞ
 || (
lun
->
lun_num
 >ğ
POOL_INFO_LUNS
))

173 
out
;

175 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

176 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

177 
	`£t_»q_debug_g
(
»q
, 
WRITE_BBT_POOL_INFO_TAG
, 
i
);

178 
»q
->
İcode
 = 
sh_cmd_wr™e
;

179 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

180 
»q
->
h—d
 = 
MBR_HEAD
;

181 
»q
->
d©©y³
 = 
SHORT_LBA
;

182 
»q
->
lba
 = 
POOL_INFO_METADATA
;

183 
»q
->
_m‘ad©a
 = (((
u64
ìeq->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
è| (»q->
lba
 & 
LONG_LBA_MASK
);

184 
»q
->
pba
.
lun
 =†un->
lun_num
;

185 
»q
->
pba
.
lun_pba
 = 2 * 
sdev
->
logicbs_š_·ge
 + 
i
;

186 
»q
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

187 ià(
i
 < 
logicbs_š_poŞ_šfo
)

188 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, (*)
poŞ_šfo
 + 
sdev
->
logicb_size
 * 
i
, sdev->logicb_size);

189 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
,„eq->
vœt_addr
, sdev->
logicb_size
,„eq->
dma_dœ
);

190 
»q
->
sbio
 = sbio;

191 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

194 
out
:

195 ià(
poŞ_šfo
)

196 
	`shªnÚ_kä“
(
poŞ_šfo
);

197 ià(
bbt_±r
)

198 
	`shªnÚ_kä“
(
bbt_±r
);

199 ià(
mbr_±r
)

200 
	`ä“_logicb_buf
(
sdev
, 
mbr_±r
);

202  
sbio
;

203 
	}
}

206 
	$lun_»äesh_mbr_eblks
(
shªnÚ_lun
 *
lun
)

208 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

209 
shªnÚ_poŞ
 *
¥oŞ
ğ
sdev
->spool;

210 
shªnÚ_bio
 *
sbio
;

211 
shªnÚ_»que¡
 *
»q
, *
tmp
, *
fœ¡_»q
 = 
NULL
;

212 
»q_couÁ
, 
·ges
, 
eblk
;

214 
sbio
 = 
	`´•¬e_»äesh_mbr
(
lun
);

215 ià(
sbio
 =ğ
NULL
)

216  -
ENOMEM
;

218 
eblk
 = 0;ƒblk < 
sdev
->
mbr_eblocks
;ƒblk++) {

219 
»q_couÁ
 = 0;

220 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

221 
lun
->
»äesh_Úe_mbr_eblk_dÚe
 = 0;

223 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

224 ià(
»q
->
İcode
 =ğ
sh_cmd_”a£
) {

226 
»q
->
µa
 = 
eblk
 * 
sdev
->
·ges_š_eblock
;

228 
	`shªnÚ_mu‹x_lock
(&
lun
->
lun£t
->
sq_£m
);

229 
	`__shªnÚ_”a£_cmd
(
lun
->
lun£t
, 
»q
, 0);

230 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
lun£t
->
sq_£m
);

231 
	`upd©e_lun£t_sq_h—d
(
lun
->
lun£t
);

232 } ià(
»q
->
İcode
 =ğ
sh_cmd_wr™e
) {

234 ià(
eblk
)

235 
»q
->
pba
.
lun_pba
 +ğ
sdev
->
·ges_š_eblock
 * sdev->
logicbs_š_·ge
;

236 ià((
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
) == 0) {

237 
fœ¡_»q
 = 
»q
;

238 
	`SHANNON_INIT_LIST_HEAD
(&
fœ¡_»q
->
chunk_li¡
);

239 
»q_couÁ
 = 1;

241 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
fœ¡_»q
->chunk_list);

242 
»q_couÁ
++;

243 ià(
»q_couÁ
 =ğ
sdev
->
logicbs_š_·ge
) {

244 
	`shªnÚ_wr™e_cmd
(
lun
->
lun£t
, 
fœ¡_»q
);

245 
»q_couÁ
 = 0;

246 
fœ¡_»q
 = 
NULL
;

251 
	`shªnÚ_wa™_ev’t
(
lun
->
»äesh_Úe_mbr_eblk_dÚe_ev’t
,†un->
»äesh_Úe_mbr_eblk_dÚe
 != 0);

254 ià(
¥oŞ
 && (
lun
->
lun_num
 < 
POOL_INFO_LUNS
))

255 
·ges
 = 3;

257 
·ges
 = 2;

258 
	`shªnÚ_©omic_£t
(&
lun
->
Ãxt_em±y_·ge
, 
·ges
);

259 
	`shªnÚ_©omic_šc
(&
sdev
->
»äesh_mbr_couÁ
);

261 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

262 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

263 ià(
»q
->
İcode
 =ğ
sh_cmd_wr™e
) {

264 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
,„eq->
dma_dœ
);

265 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

267 
	`ä“_»q
(
»q
);

269 
	`ä“_sbio
(
sbio
);

272 
	}
}

274 
	$lun_»äesh_mbr_eblks_sync
(
shªnÚ_lun
 *
lun
)

276 
shªnÚ_dev
 *
sdev
 = 
lun
->sdev;

277 
»t
;

279 ià(
	`is_¡©ic_bad_lun
(
sdev
, 
lun
->
lun_num
è&& (lun->
bad
 =ğ0è&& (lun->
phy_lun_num
 != 0)) {

280 
	`shªnÚ_©omic_šc
(&
sdev
->
»äesh_mbr_dÚe
);

284 
	`shªnÚ_mu‹x_lock
(&
lun
->
»äesh_£m
);

285 
»t
 = 
	`lun_»äesh_mbr_eblks
(
lun
);

286 
	`shªnÚ_mu‹x_uÆock
(&
lun
->
»äesh_£m
);

287 ià(
»t
)

290 
	`shªnÚ_©omic_šc
(&
sdev
->
»äesh_mbr_dÚe
);

293 
	}
}

295 
	$»äesh_mbr_fÜ_sdev_sync
(
shªnÚ_dev
 *
sdev
)

297 
i
 = 0;

299 
sdev
->
mbr
.
mbr_upd©e
++;

300 
	`shªnÚ_šfo
("%s: mbr_upd©e=0x%x.\n", 
sdev
->
sdisk
.
disk_Çme
, sdev->
mbr
.
mbr_upd©e
);

301 
	`shªnÚ_©omic_£t
(&
sdev
->
»äesh_mbr_dÚe
, 0);

303 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++)

304 
	`lun_»äesh_mbr_eblks_sync
(
sdev
->
lun
[
i
]);

307 
	}
}

309 
	$»£t_hw_cÚŒŞËr
(
shªnÚ_dev
 *
dev
)

311 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

312 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
RESET
, 1);

313 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
RESET
, 0);

314 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

315 
	}
}

317 
	$»š™Ÿlize_ä“_blocks
(
shªnÚ_dev
 *
sdev
)

319 
shªnÚ_sb
 *
sb
;

321 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

322 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sb
, &
sdev
->
ä“_blocks
, 
li¡
) {

323 
	`»š™Ÿlize_sb
(
sdev
, 
sb
);

325 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
ä“_blocks_lock
);

326 
	}
}

328 
	$»£t_d©a_¡ruù
(
shªnÚ_dev
 *
sdev
)

330 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

331 
shªnÚ_sb
 *
sb
;

332 
i
 = 0;

333 
u64
 
Ãw_size
 = 
sdisk
->
Üig_m­_bË_size
;

335 
sdev
->
Ãw_bad_lun
->
bad_lun_æag
 = 0;

336 
i
 = 0; i < 
sdev
->
·r™y_groups
; i++)

337 
sdev
->
Ãw_bad_lun
->
group_bad_lun
[
i
] = 0;

340 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


341 
	`•og_cdev_ex™
(
sdev
);

343 
	`shªnÚ_»Ëa£_•ogs
(
sdev
);

344 
	`£t_•og_size
(
sdev
);

345 
	`shªnÚ_®loc_•ogs
(
sdev
);

346 
	`shªnÚ_»Ëa£_»bud_•ogs
(
sdev
);

347 
	`»š™Ÿlize_ä“_blocks
(
sdev
);

349 
Ãw_size
 = 
	`SHN_PAGE_ALIGN
((
sdev
->
sdisk
.
£ùÜs
 >> (sdev->
logicb_shiá
 - 9)è* (
logicb_t
));

350 ià(
sdisk
->
Üig_m­_bË_size
 !ğ
Ãw_size
) {

351 
	`shªnÚ_m­_bË_ä“
(&
sdev
->
sdisk
);

352 
sdisk
->
tÙ®_m­_bË_size
 = 
	`SHN_PAGE_ALIGN
((
sdev
->sdisk.
£ùÜs
 >> (sdev->
logicb_shiá
 - 9)è* (
logicb_t
));

353 
sdisk
->
tÙ®_‹mp_bË_size
 = 
	`SHN_PAGE_ALIGN
((
sdev
->sdisk.
£ùÜs
 >> (sdev->
logicb_shiá
 - 9)è* (
u8
));

355 ià(
	`shªnÚ_®loc_m­_bË
(&
sdev
->
sdisk
, sdev->sdisk.
£ùÜs
, sdev->
logicb_shiá
)) {

356 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for map_table!\n");

360 
	`shªnÚ_m­_bË_ş—r
(&
sdisk
->
Ímt_¬¿y
[0]);

362 
	`sdev_m­_bË_’abË
(
sdev
);

363 
	`sdisk_v®id_logicbs_ş—r
(&
sdev
->
sdisk
);

364 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


365 
	`•og_cdev_š™
(
sdev
);

368 
	`commªd_cdev_»Ëa£
(
sdev
);

369 
	`com¶‘iÚ_cdev_»Ëa£
(
sdev
);

370 
	`pba_bË_cdev_»Ëa£
(
sdev
);

371 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

372 ià(!
sdev
->
lun
[
i
]->
pba_bË
)

374 
	`shªnÚ_mem£t
(
sdev
->
lun
[
i
]->
pba_bË
, 
ALL_STALE
, sdev->
pba_bË_size
);

376 
	`pba_bË_cdev_š™
(
sdev
, sdev->
pba_bË_size
);

377 
	`commªd_cdev_š™
(
sdev
);

378 
	`com¶‘iÚ_cdev_š™
(
sdev
);

380 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

381 
Ï¡_sb_dÚe
[0] = 1;

382 
Ï¡_sb_dÚe
[1] = 1;

383 
cu¼’t_¡re_·ge
[0] = -1;

384 
cu¼’t_¡re_·ge
[1] = -1;

385 
	`¥š_lock_š™
(&
·r™y_buf_lock
[0]);

386 
	`¥š_lock_š™
(&
·r™y_buf_lock
[1]);

387 
	`š™_wa™queue_h—d
(&
sb_dÚe_ev’t
[0]);

388 
	`š™_wa™queue_h—d
(&
sb_dÚe_ev’t
[1]);

389 
	`©omic_£t
(&
»maššg_¡re_·ges
[0], 0);

390 
	`©omic_£t
(&
»maššg_¡re_·ges
[1], 0);

391 
	`©omic_£t
(&
»maššg_·ges
[0], 0xffffffff);

392 
	`©omic_£t
(&
»maššg_·ges
[1], 0xffffffff);

393 
	`š™_wa™queue_h—d
(&
wr™e_dÚe_ev’t
[0]);

394 
	`š™_wa™queue_h—d
(&
wr™e_dÚe_ev’t
[1]);

395 
	`š™_wa™queue_h—d
(&
Ï¡_·r™y_dÚe_ev’t
[0]);

396 
	`š™_wa™queue_h—d
(&
Ï¡_·r™y_dÚe_ev’t
[1]);

399 
	`shªnÚ_mem£t
(
sdev
->
dummy_·ge
, 0, sdev->
Çnd_·ge_size
);

401 
sdev
->
Ï¡_blk
[
HOT_INDEX
] = 
NULL
;

402 
sdev
->
wr_sb
[
HOT_INDEX
] = sdev->
mbr
.
š™_hÙ_sblk
;

403 
sdev
->
aùive_blk_¡¬t_jiff›s
[
HOT_INDEX
] = 
	`g‘_jiff›s
();

404 
sdev
->
aùive_blk
[
HOT_INDEX
] = &sdev->
sbs
[sdev->
wr_sb
[HOT_INDEX]];

405 
	`shªnÚ_li¡_d–_š™
(&
sdev
->
aùive_blk
[
HOT_INDEX
]->
li¡
);

406 
sdev
->
ä“_blkút
--;

407 
sdev
->
aùive_blk
[
HOT_INDEX
]->
¡©e
 = 
aùive_blk_¡©e
[HOT_INDEX];

408 
sdev
->
aùive_blk
[
HOT_INDEX
]->
•og
 = 
	`•og_®loc
(sdev->aùive_blk[HOT_INDEX]->
•og_size
, sdev);

409 ià(
sdev
->
aùive_blk
[
HOT_INDEX
]->
•og
 =ğ
NULL
) {

410 
	`shªnÚ_w¬n
("Can't‡llocateƒnough memory forƒpilog.\n");

413 
sb
 = 
sdev
->
aùive_blk
[
HOT_INDEX
];

414 
	`shªnÚ_mem_wr™ew
(
HOT_INDEX
, &
sb
->
•og
->
•og_h—d
->
h—d
.
h—d_šdex
);

415 
sb
->
h—d_šdex
 = 
HOT_INDEX
;

416 
sdev
->
wr_group
[
HOT_INDEX
] = 0;

417 
sdev
->
lun_š_group
[
HOT_INDEX
] = 0;

418 
sdev
->
wr_lun_off£t
[
HOT_INDEX
] = 
sb
->
sub_group
[0].
fœ¡_lun_off£t
;

419 
sdev
->
wr_chunk
[
HOT_INDEX
] = sdev->
wr_¶ªe
[HOT_INDEX] = sdev->
wr_·ge
[HOT_INDEX] = sdev->
wr_logicb
[HOT_INDEX] = 0;

420 ià(
sdev
->
¿id5_suµÜ‹d
)

421 
	`·r™y_š™
(
sb
, 
sdev
->
wr_group
[
HOT_INDEX
], sdev->
wr_sb
[HOT_INDEX] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
, 
HOT_HEAD
);

422 
sdev
->
chunk_»q
[
HOT_INDEX
] = 
NULL
;

423 
sdev
->
chunk_»qút
[
HOT_INDEX
] = 0;

425 ià(
sdev
->
u£_du®_h—d
) {

426 
sdev
->
Ï¡_blk
[
COLD_INDEX
] = 
NULL
;

427 
sdev
->
wr_sb
[
COLD_INDEX
] = sdev->
mbr
.
š™_cŞd_sblk
;

428 
sdev
->
aùive_blk_¡¬t_jiff›s
[
COLD_INDEX
] = 
	`g‘_jiff›s
();

429 
sdev
->
aùive_blk
[
COLD_INDEX
] = &sdev->
sbs
[sdev->
wr_sb
[COLD_INDEX]];

430 
	`shªnÚ_li¡_d–_š™
(&
sdev
->
aùive_blk
[
COLD_INDEX
]->
li¡
);

431 
sdev
->
ä“_blkút
--;

432 
sdev
->
aùive_blk
[
COLD_INDEX
]->
¡©e
 = 
aùive_blk_¡©e
[COLD_INDEX];

433 
sdev
->
aùive_blk
[
COLD_INDEX
]->
•og
 = 
	`•og_®loc
(sdev->aùive_blk[COLD_INDEX]->
•og_size
, sdev);

434 ià(
sdev
->
aùive_blk
[
COLD_INDEX
]->
•og
 =ğ
NULL
) {

435 
	`shªnÚ_w¬n
("Can't‡llocateƒnough memory forƒpilog.\n");

438 
sb
 = 
sdev
->
aùive_blk
[
COLD_INDEX
];

439 
	`shªnÚ_mem_wr™ew
(
COLD_INDEX
, &
sb
->
•og
->
•og_h—d
->
h—d
.
h—d_šdex
);

440 
sb
->
h—d_šdex
 = 
COLD_INDEX
;

441 
sdev
->
wr_group
[
COLD_INDEX
] = 0;

442 
sdev
->
lun_š_group
[
COLD_INDEX
] = 0;

443 
sdev
->
wr_lun_off£t
[
COLD_INDEX
] = 
sb
->
sub_group
[0].
fœ¡_lun_off£t
;

444 
sdev
->
wr_chunk
[
COLD_INDEX
] = sdev->
wr_¶ªe
[COLD_INDEX] = sdev->
wr_·ge
[COLD_INDEX] = sdev->
wr_logicb
[COLD_INDEX] = 0;

445 ià(
sdev
->
¿id5_suµÜ‹d
)

446 
	`·r™y_š™
(
sb
, 
sdev
->
wr_group
[
COLD_INDEX
], sdev->
wr_sb
[COLD_INDEX] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
, 
COLD_HEAD
);

448 
sdev
->
chunk_»q
[
COLD_INDEX
] = 
NULL
;

449 
sdev
->
chunk_»qút
[
COLD_INDEX
] = 0;

451 
sdev
->
Ï¡_blk
[
COLD_INDEX
] = 
NULL
;

452 
sdev
->
wr_sb
[
COLD_INDEX
] = -1;

453 
sdev
->
aùive_blk
[
COLD_INDEX
] = 
NULL
;

454 
sdev
->
wr_group
[
COLD_INDEX
] = 0;

455 
sdev
->
lun_š_group
[
COLD_INDEX
] = 0;

458 
	`shªnÚ_©omic_add
(
	`shªnÚ_©omic_»ad
(&
sdev
->
dyÇmic_bad_blkút
), &sdev->
¡©ic_bad_blkút
);

459 
	`shªnÚ_©omic_£t
(&
sdev
->
dyÇmic_bad_blkút
, 0);

463 
	}
}

465 
wr™e_nÜ_bad_block
(
shªnÚ_dev
 *
sdev
, 
bad_block
 *bad_block, 
blk_couÁ
);

466 
check_gc_nÜ_block
(
shªnÚ_dev
 *
sdev
);

467 
	$”a£_su³r_block_qu›t_ÿÎback
(
shªnÚ_bio
 *
sbio
)

469 
shªnÚ_sb
 *
p
, *
sb
 = 
sbio
->
d©a
;

470 
shªnÚ_dev
 *
dev
 = 
sb
->
sdev
;

471 
shªnÚ_»que¡
 *
»q
;

472 
Şd_»şaim_kšd
 = 
sb
->
»şaim_kšd
;

473 
mis£d
 = 0;

475 ià(
Şd_»şaim_kšd
 & (1 << 
ERROR_SB_SHIFT
)) {

476 
lun
, 
¶ªe
, 
bad_eblk
;

477 
bad_block
 *bad_block = 
NULL
;

478 
blk_couÁ
 = 0;

480 
	`shªnÚ_šfo
("%s:„eşaim sb %d,„eşaim kšd=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
ERROR_SB_SHIFT
);

482 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

483 ià(
dev
->
nÜ_bbt_¡©e
 == 0)

484 
bad_block
 = (bad_block *)
	`®loc_logicb_buf
(
dev
, 
GFP_SHANNON
);

486 
	`shªnÚ_šfo
("ÿÂÙ„ecÜd badblock tØbbt: sb_šdex=%d,‚Ü_bbt_¡©e=%d.\n", 
sb
->
sb_šdex
, 
dev
->
nÜ_bbt_¡©e
);

489 
lun
 = 0;†uÀ< 
dev
->
lun_couÁ
;†un++) {

490 
¶ªe
 = 0;…ÏÃ < 
dev
->
¶ªes
;…lane++) {

491 ià(
	`is_”rÜ_lun
(
dev
, 
sb
, 
lun
, 
¶ªe
)) {

492 
bad_eblk
 = 
sb
->
sb_šdex
 * 
dev
->
¶ªes
 + 
¶ªe
;

493 
	`shªnÚ_šfo
("sb=%d,†un=%d,…ÏÃ=%d.\n", 
sb
->
sb_šdex
, 
lun
, 
¶ªe
);

494 
	`sb_m¬k_bad_lun
(
sb
, 
lun
);

495 ià(
	`add_bad_eblk_to_lun_bbt
(
dev
->
lun
[lun], 
bad_eblk
) == 0) {

496 
	`shªnÚ_©omic_šc
(&
dev
->
dyÇmic_bad_blkút
);

497 
	`shªnÚ_©omic_šc
(&
dev
->
lun
[lun]->
dyÇmic_bad_blkút
);

499 ià(
dev
->
”r_check_debug
)

500 
	`shªnÚ_šfo
("dyÇmiøbad block: %s:lun=%d,ƒblk=%d.\n", 
dev
->
sdisk
.
disk_Çme
, dev->
lun
[lun]->
lun_num
, 
bad_eblk
);

502 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

503 ià(
bad_block
) {

504 
bad_block
[
blk_couÁ
].
lun
 = (
dev
->lun[lun]->
lun_num
 & ((1 << 8) - 1));

505 ià(
dev
->
p£udo_¶ªe
)

506 
bad_block
[
blk_couÁ
++].
block
 = \

507 ((!!(
dev
->
lun
[lun]->
lun_num
 & (1 << 8)è<< 15è| (
bad_eblk
 / dev->
¶ªes
));

509 
bad_block
[
blk_couÁ
++].
block
 = \

510 ((!!(
dev
->
lun
[lun]->
lun_num
 & (1 << 8)è<< 15è| 
bad_eblk
);

511 } ià(
mis£d
 == 0)

512 
mis£d
 = 1;

515 
	`sb_ş—r_”rÜ_lun
(
dev
, 
sb
, 
lun
, 
¶ªe
);

520 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

521 ià(
blk_couÁ
) {

522 
	`shªnÚ_mu‹x_lock
(&
dev
->
wr™e_bbt_£m
);

523 ià(
	`wr™e_nÜ_bad_block
(
dev
, 
bad_block
, 
blk_couÁ
)) {

524 
	`shªnÚ_”r
("çedØwr™bad blocks: sb_šdex=%d.\n", 
sb
->
sb_šdex
);

525 
mis£d
 = 1;

528 
	`check_gc_nÜ_block
(
dev
);

530 ià(
dev
->
nÜ_bbt_¡©e
) {

531 
	`shªnÚ_w¬n
("nØ¥aû fÜ‚Üæash bbt, bbt_¡©e=%d.\n", 
dev
->
nÜ_bbt_¡©e
);

532 
	`shªnÚ_£t_b™
(
SHN_REASON_BBT_NO_SPACE
, &
dev
->
»adÚly_»asÚ
);

535 
	`shªnÚ_mu‹x_uÆock
(&
dev
->
wr™e_bbt_£m
);

538 ià(
bad_block
)

539 
	`ä“_logicb_buf
(
dev
, 
bad_block
);

542 ià(
sb
->
sb_šdex
 >ğ
dev
->
mbr_eblocks
/dev->
¶ªes
)

543 
	`shªnÚ_©omic_dec
(&
dev
->
³ndšg_”r_blks
);

546 
dev
->
tÙ®_”a£_couÁ
++;

548 ià(
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_groups
è< 
dev
->
max_avaabË_groups
) {

549 
sb
->
¡©e
 = 
DISCARDED_BLOCK
;

550 
	`shªnÚ_©omic_šc
(&
dev
->
disÿrded_blkút
);

552 
	`m¬k_su³r_block_bad
(
sb
);

553 
out
;

556 
	`add_sb_”a£_couÁ”
(
dev
, 
sb
);

557 
	`»š™Ÿlize_sb
(
dev
, 
sb
);

558 
sb
->
Ï¡_”a£d_time¡amp
 = 
	`g‘_jiff›s
();

560 ià(
sb
->
sb_šdex
 < 
dev
->
mbr_eblocks
/dev->
¶ªes
) {

561 
sb
->
¡©e
 = 
MBR_BLOCK
;

562 
sb
->
wr_off£t
 = ~0;

563 
out
;

566 ià(
	`shªnÚ_dev_is_g5
(
dev
è&& 
mis£d
)

567 
out
;

569 
	`shªnÚ_¥š_lock_bh
(&
sb
->
sdev
->
ä“_blocks_lock
);

570 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
dev
->
ä“_blocks
, 
li¡
) {

571 ià(
p
->
”a£_couÁ”
 > 
sb
->erase_counter)

574 
	`shªnÚ_li¡_add_
(&
sb
->
li¡
, &
p
->list);

576 
sb
->
sdev
->
ä“_blkút
++;

577 
	`shªnÚ_¥š_uÆock_bh
(&
sb
->
sdev
->
ä“_blocks_lock
);

579 
out
:

580 !
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
)) {

581 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

582 
	`BUG_ON
(
»q
->
sbio
 != sbio);

583 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

584 
	`ä“_»q
(
»q
);

587 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
dev
->
”a£_dÚe
))

588 
	`shªnÚ_wake_up
(&
dev
->
”a£_dÚe_ev’t
);

590 
	`ä“_sbio
(
sbio
);

591 
	}
}

593 
	$”a£_su³r_block_qu›t
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
)

595 
i
, 
¶ªe
;

596 
shªnÚ_bio
 *
sbio
;

597 
shªnÚ_»que¡
 *
»q
, *
p
;

600 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

601 
	`£t_sbio_debug_g
(
sbio
, 
ERASE_BLOCK_TAG
);

602 
sbio
->
logicbs
 = 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_luns
è* 
dev
->
¶ªes
;

603 ià(
dev
->
p£udo_¶ªe
)

604 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_luns
));

606 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
	`shªnÚ_©omic_»ad
(&
sb
->
avaabË_luns
è* 
dev
->
¶ªes
);

607 
sbio
->
ÿÎback
 = 
”a£_su³r_block_qu›t_ÿÎback
;

608 
sbio
->
d©a
 = 
sb
;

609 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

611 
	`shªnÚ_©omic_šc
(&
dev
->
”a£_dÚe
);

613 
i
=0; i<
dev
->
lun_couÁ
; i++) {

614 ià(!
	`is_bad_lun
(
sb
, 
i
)) {

615 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

616 
	`£t_»q_debug_g
(
»q
, 
ERASE_BLOCK_TAG
, 0);

617 
»q
->
İcode
 = 
sh_cmd_”a£
;

618 
»q
->
pba
.
lun
 = 
i
;

619 
»q
->
µa
 = 
sb
->
sb_šdex
 * 
dev
->
·ges_š_eblock
 * dev->
¶ªes
;

620 
»q
->
lba
 = 
LONG_INVALID_LBA
;

621 
»q
->
sbio
 = sbio;

622 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

623 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

625 ià(!
dev
->
p£udo_¶ªe
) {

626 
¶ªe
 = 1;

627 
¶ªe
 < 
dev
->
¶ªes
) {

628 
p
 = 
	`®loc_»q
(
GFP_SHANNON
);

629 
	`£t_»q_debug_g
(
p
, 
ERASE_BLOCK_TAG
, 
¶ªe
);

630 
p
->
İcode
 = 
sh_cmd_”a£
;

631 
p
->
pba
.
lun
 = 
i
;

632 
p
->
µa
 = 
»q
->µ¨+ 
dev
->
·ges_š_eblock
 * 
¶ªe
;

633 
p
->
lba
 = 
LONG_INVALID_LBA
;

634 
p
->
sbio
 = sbio;

635 
	`shªnÚ_li¡_add_
(&
p
->
bio_li¡
, &
sbio
->
»q_li¡
);

636 
	`shªnÚ_li¡_add_
(&
p
->
chunk_li¡
, &
»q
->chunk_list);

638 
¶ªe
++;

641 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»q_queue_lock
[0]);

642 
	`shªnÚ_li¡_add
(&
»q
->
li¡
, &
dev
->
»q_queue
[0]);

643 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»q_queue_lock
[0]);

644 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
wÜk
);

647 
	}
}

649 
´•¬e_ov”Ïp_pba
(
shªnÚ_dev
 *
sdev
);

650 
Ãxt_ov”Ïp_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
¡¬t_lun
);

656 
	$»fÜm©
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_fÜm©_¬g2
 *
çrg
)

658 
shªnÚ_sb
 *
sb
;

659 
i
, 
b
;

661 
	`shªnÚ_šfo
("%s: s¹„efÜm© dÚe.\n", 
sdev
->
sdisk
.
disk_Çme
);

663 
sdev
->
ho¡_acûss_blocked
 = 1;

665 ià(
sdev
->
´eãtch_th»ad
) {

666 
	`£t_´eãtch_di§bË
(&
sdev
->
sdisk
.
´eãtch
);

667 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
´eãtch_th»ad
);

668 
sdev
->
´eãtch_th»ad
 = 
NULL
;

670 ià(
sdev
->
»cov”_th»ad
) {

671 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
»cov”_th»ad
);

672 
sdev
->
»cov”_th»ad
 = 
NULL
;

673 
sdev
->
this_”r_sb
 = 
NULL
;

674 
sdev
->
this_”r_sb_šdex
 = ~0;

675 
sdev
->
this_”r_¡re
 = 0;

677 ià(
sdev
->
gc_th»ad
) {

678 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
gc_th»ad
);

679 
sdev
->
gc_th»ad
 = 
NULL
;

680 
sdev
->
gc_th»ad_¡©e
 = 
NO_RECLAIM
;

682 
	`shªnÚ_´eãtch_de¡roy
(&
sdev
->
sdisk
.
´eãtch
);

684 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
gc_tim”
);

685 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
b®ªû_gc_tim”
);

686 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
wl_tim”
);

687 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++)

688 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_sb_tim”
[
i
]);

689 #ifdeà
SHANNON_USE_WRITE_BUFFER


690 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++)

691 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_chunk_tim”
[
i
]);

693 
	`d¿š_commªd_queue
(
sdev
, 0);

694 #ifdeà
SHANNON_USE_WRITE_BUFFER


695 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

696 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_chunk_tim”
[
i
]);

697 
sdev
->
chunk_¡¬t_jiff›s
[
i
] = 0;

700 
	`debugs1
("reformat step 1: flush‡ll…ending work done.\n");

703 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++)

704 ià(
sdev
->
lun
[
i
]->
bad
) {

705 
sdev
->
max_avaabË_luns
--;

706 
b
 = 0; b < 
sdev
->
sb_couÁ
; b++)

707 
	`sb_m¬k_bad_lun
(
sdev
->
sbs
 + 
b
, 
i
);

709 
sdev
->
ä“_blkút
 = 0;

710 
i
 = 
sdev
->
sb_couÁ
 - 1; i >ğsdev->
mbr_eblocks
 / sdev->
¶ªes
; i--) {

711 
sb
 = 
sdev
->
sbs
 + 
i
;

712 ià(
sdev
->
sbs
[
i
].
¡©e
 !ğ
DISCARDED_BLOCK
) {

717 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
sbs
[
i
].
lock
);

720 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

721 
	`shªnÚ_li¡_d–_š™
(&
sdev
->
sbs
[
i
].
li¡
);

722 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
ä“_blocks_lock
);

723 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
sbs
[
i
].
lock
);

724 ià(
sb
->
•og
)

725 
	`sb_ä“_•og
(
sb
);

726 #ifdeà
CONFIG_SHANNON_DEBUG


727 ià(
sb
->
gc_¡©e
 !ğ
NULL
)

728 
	`»move_äom_gc_¡©e_li¡
(
sb
);

730 
sb
->
¡©e
 = 
WAIT_ERASE_BLOCK
;

731 
	`”a£_su³r_block_qu›t
(
sdev
, &sdev->
sbs
[
i
]);

734 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_VALID
;

737 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
”a£_dÚe_ev’t
, 
	`shªnÚ_©omic_»ad
(&sdev->
”a£_dÚe
) == 0);

738 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
”a£_dÚe
) == 0)

740 } (
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
) == 0);

742 ià(
	`uÆik–y
(
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
))

745 
sdev
->
u£d_blkút
[
HOT_INDEX
] = 0;

746 
sdev
->
u£d_blkút
[
COLD_INDEX
] = 0;

747 
sdev
->
wa™_”a£d_blkút
 = 0;

748 
sdev
->
wa™_cİy_blkút
 = 0;

749 
sdev
->
wa™_wl_blkút
 = 0;

750 
sdev
->
”r_blkút
 = 0;

751 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
u£d_blocks
[
HOT_INDEX
]);

752 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
u£d_blocks
[
COLD_INDEX
]);

753 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_”a£d
);

754 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_cİy
);

755 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_wl_li¡
);

756 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
”r_blks
);

757 
	`shªnÚ_©omic_£t
(&
sdev
->
š_gc_blkút
, 0);

758 
	`shªnÚ_©omic_£t
(&
sdev
->
š_wl_blkút
, 0);

759 
sdev
->
this_sb
 = 
NULL
;

760 
sdev
->
this_·ge_¡re
 = 0;

761 
sdev
->
this_lun
 = 0;

762 
sdev
->
exŒa_»qs
 = 0;

763 
	`shªnÚ_©omic_£t
(&
sdev
->
wr™e_»qs_fÜ_gc
, 0);

764 
sdev
->
wl_this_sb
 = 
NULL
;

766 
	`debugs1
("reformat step 2:ƒrase‡ll superblocks done.\n");

768 
	`shªnÚ_mu‹x_lock
(&
sdev
->
modify_mbr_£m
);

770 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++)

771 ià(
sdev
->
lun
[
i
]->
bad
)

772 
	`shªnÚ_£t_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, sdev->
mbr
.
bad_phy_lun_m­
);

774 ià(
çrg
->
ÿ·c™y
)

775 
sdev
->
mbr
.
ÿ·c™y
 = 
çrg
->capacity;

776 ià(
çrg
->
u£r_logicb_shiá
)

777 
sdev
->
mbr
.
u£r_logicb_shiá
 = 
çrg
->user_logicb_shift;

779 ià(
çrg
->
æags
 & (1 << 
PRIO_WRITE_SHIFT
))

780 
sdev
->
mbr
.
ã©u»_æags
 |ğ
PRIORITIZE_WRITE
;

782 
sdev
->
mbr
.
ã©u»_æags
 &ğ~
PRIORITIZE_WRITE
;

783 ià(
çrg
->
æags
 & (1 << 
ATOMIC_WRITE_SHIFT
))

784 
sdev
->
mbr
.
ã©u»_æags
 |ğ
ATOMIC_WRITE
;

786 
sdev
->
mbr
.
ã©u»_æags
 &ğ~
ATOMIC_WRITE
;

787 ià(
çrg
->
æags
 & (1 << 
SET_WRITE_BW_SHIFT
)) {

788 
sdev
->
mbr
.
max_wr™e_bw
 = 
çrg
->max_write_bw;

789 ià(
çrg
->
lim™_bw_wh’_diskfuÎ
)

790 
sdev
->
mbr
.
ã©u»_æags
 |ğ
LIMIT_BW_WHEN_DISKFULL
;

794 ià(!(
çrg
->
æags
 & (1UL << 
KEEP_MBR_PARAS_SHIFT
))) {

795 
sdev
->
mbr
.
ã©u»_æags
 |ğ
BIG_EPILOG
;

796 
sdev
->
lba_fÜm©
 = 
LONG_LBA_FORMAT
;

797 
sdev
->
mbr
.
ã©u»_æags
 |ğ
COMPACT_EPILOG
;

798 
sdev
->
com·ù_•og
 = 1;

801 ià(
sdev
->
ä“_blkút
 < 2) {

802 
	`shªnÚ_”r
("ä“ block couÁ=%d.\n", 
sdev
->
ä“_blkút
);

806 
sdev
->
mbr
.
š™_hÙ_sblk
 = sdev->
mbr_eblocks
/sdev->
¶ªes
;

807 
sdev
->
mbr
.
š™_cŞd_sblk
 = sdev->
sb_couÁ
 - 1;

808 
sdev
->
mbr
.
š™_hÙ_sblk
 < sdev->
sb_couÁ
 && sdev->
sbs
[sdev->mbr.š™_hÙ_sblk].
¡©e
 =ğ
DISCARDED_BLOCK
)

809 
sdev
->
mbr
.
š™_hÙ_sblk
++;

810 
sdev
->
mbr
.
š™_cŞd_sblk
 >ğ0 && sdev->
sbs
[sdev->mbr.š™_cŞd_sblk].
¡©e
 =ğ
DISCARDED_BLOCK
)

811 
sdev
->
mbr
.
š™_cŞd_sblk
--;

813 ià(
çrg
->
æags
 & (1 << 
OVERLAP_WRITE_SHIFT
)) {

814 
shªnÚ_sb
 *
ov”Ïp_sb
 = 
NULL
;

816 
sdev
->
mbr
.
ã©u»_æags
 |ğ
OVERLAP_WRITE
;

817 
sdev
->
mbr
.
ov”Ïp_sblk
 = sdev->mbr.
š™_cŞd_sblk
 - 1;

818 
sdev
->
mbr
.
ov”Ïp_sblk
 < sdev->
sb_couÁ
 && sdev->
sbs
[sdev->mbr.ov”Ïp_sblk].
¡©e
 =ğ
DISCARDED_BLOCK
)

819 
sdev
->
mbr
.
ov”Ïp_sblk
--;

821 ià(
sdev
->
mbr
.
ov”Ïp_sblk
 =ğsdev->mbr.
š™_hÙ_sblk
 || sdev->mbr.ov”Ïp_sblk =ğsdev->mbr.
š™_cŞd_sblk
)

824 
sdev
->
ov”Ïp_wr™e
 = 1;

825 ià(
sdev
->
ov”Ïp
 =ğ
NULL
) {

826 
sdev
->
ov”Ïp
 = 
	`shªnÚ_km®loc
((
shªnÚ_ov”Ïp
), 
GFP_SHANNON
);

827 ià(
sdev
->
ov”Ïp
 =ğ
NULL
) {

828 
	`shªnÚ_”r
("failedo‡llocate memory for overlap.\n");

831 
	`shªnÚ_mem£t
(
sdev
->
ov”Ïp
, 0, (
shªnÚ_ov”Ïp
));

832 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
ov”Ïp
->
wa™_ov”Ïp_ev’t
);

835 
ov”Ïp_sb
 = 
sdev
->
sbs
 + sdev->
mbr
.
ov”Ïp_sblk
;

836 
	`shªnÚ_¥š_lock_bh
(&
ov”Ïp_sb
->
lock
);

837 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
ä“_blocks_lock
);

838 
	`shªnÚ_li¡_d–_š™
(&
ov”Ïp_sb
->
li¡
);

839 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
ä“_blocks_lock
);

840 
ov”Ïp_sb
->
¡©e
 = 
OVERLAP_BLOCK
;

841 
ov”Ïp_sb
->
£q_num
 = 
MAX_SEQ_NUM
;

842 
ov”Ïp_sb
->
h—d_šdex
 = 
OVERLAP_INDEX
;

843 
	`shªnÚ_¥š_uÆock_bh
(&
ov”Ïp_sb
->
lock
);

845 
sdev
->
ov”Ïp
->
wr_lun
 = 
	`Ãxt_ov”Ïp_lun
(sdev, sdev->
sbs
 + sdev->
mbr
.
ov”Ïp_sblk
, 0);

846 
sdev
->
ov”Ïp
->
wr_chunk
 = 0;

847 
sdev
->
ov”Ïp
->
wr_·ge
 = 0;

848 
sdev
->
ov”Ïp
->
wr_logicb
 = 0;

849 
sdev
->
ov”Ïp
->
wr_¶ªe
 = 0;

850 
sdev
->
ov”Ïp
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[sdev->
lba_fÜm©
];

851 
sdev
->
ov”Ïp
->
bufãd_m‘ad©a
 = 
šv®id_m‘ad©a
[sdev->
lba_fÜm©
];

853 
sdev
->
mbr
.
ã©u»_æags
 &ğ~
OVERLAP_WRITE
;

854 
sdev
->
ov”Ïp_wr™e
 = 0;

859 
	`upd©e_”a£_couÁ
(
sdev
);

860 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

861 ià(
çrg
->
æags
 & (1 << 
CLEAR_ERASE_COUNT_SHIFT
)) {

862 
	`debugs0
("çked hi¡Üy_”a£_couÁ=%d.\n", 
çrg
->
”a£_couÁ
);

863 
sdev
->
mbr
.
hi¡Üy_”a£_couÁ
 = 
çrg
->
”a£_couÁ
;

864 
sdev
->
tÙ®_”a£_couÁ
 = 0;

865 
i
 = 
sdev
->
mbr_eblocks
/sdev->
¶ªes
; i < sdev->
sb_couÁ
; i++) {

866 
sb
 = 
sdev
->
sbs
 + 
i
;

867 
sb
->
”a£_couÁ”
 = 
sdev
->
mbr
.
hi¡Üy_”a£_couÁ
;

868 
sdev
->
tÙ®_”a£_couÁ
 +ğ
sb
->
”a£_couÁ”
;

871 
sdev
->
mbr
.
hi¡Üy_”a£_couÁ
 = sdev->
av”age_”a£_couÁ
;

872 
sdev
->
mbr
.
pow”_Ú_£cÚds
 = sdev->power_on_seconds;

873 
sdev
->
mbr
.
pow”_cyşe_couÁ
 = sdev->power_cycle_count;

874 
sdev
->
mbr
.
ho¡_wr™e_£ùÜs
 = sdev->host_write_sectors;

875 
sdev
->
mbr
.
tÙ®_wr™e_£ùÜs
 = sdev->total_write_sectors;

876 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_have_»ad_£ùÜs
(sdev);

877 
sdev
->
mbr
.
ho¡_»ad_£ùÜs
 = sdev->host_read_sectors;

878 ià((
sdev
->
mbr
.
ã©u»_æags
 & (
BIG_EPILOG
 | 
COMPACT_EPILOG
)è&& !(
çrg
->
æags
 & (1UL << 
KEEP_MBR_PARAS_SHIFT
)))

879 
sdev
->
mbr
.
mbr_fÜm©_v”siÚ
 = 
CURRENT_MBR_FORMAT_VERSION
;

880 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
modify_mbr_£m
);

882 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_REFRESH_MBR
;

883 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

884 ià(
sdev
->
mbr
.
poŞ_w©”m¬k
) {

885 ià(
	`upd©e_poŞ_šfo_g5
(
sdev
, 0) < 0) {

886 
	`shªnÚ_”r
("upd©poŞ infØfÜ % çed.\n", 
sdev
->
cdev_Çme
);

890 ià(
	`upd©e_poŞ_šfo_g5
(
sdev
, 1) < 0) {

891 
	`shªnÚ_”r
("ş—ÀpoŞ infØfÜ % çed.\n", 
sdev
->
cdev_Çme
);

896 ià(
	`»äesh_mbr_fÜ_sdev_sync
(
sdev
)) {

897 
	`shªnÚ_”r
("»äesh mb¸fÜ % çed.\n", 
sdev
->
cdev_Çme
);

901 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_DONE
;

902 
	`debugs1
("reformat step 3: write mbr done.\n");

905 
sdev
->
sdev_id
 = sdev->
mbr
.sdev_id;

906 
sdev
->
sdisk
.
£ùÜs
 = sdev->
mbr
.
ÿ·c™y
;

907 
sdev
->
p£udo_¶ªe
 = sdev->
mbr
.pseudo_plane;

908 ià(
sdev
->
mbr
.
¶ªe_couÁ
)

909 
sdev
->
¶ªes
 = sdev->
mbr
.
¶ªe_couÁ
;

911 
sdev
->
¶ªes
 = 1 << sdev->
mbr
.
¶ªe_Üd”
;

912 ià(
sdev
->
mbr
.
sh¬ed_·ges
)

913 
sdev
->
sh¬ed_·ges
 = sdev->
mbr
.shared_pages;

914 ià(
sdev
->
mbr
.
dummy_wÜdlše
)

915 
sdev
->
dummy_wÜdlše
 = sdev->
mbr
.dummy_wordline;

916 ià(
sdev
->
mbr
.
p£udo_¶ªe
)

917 
sdev
->
eblocks_š_lun
 = sdev->
mbr
.eblocks_š_luÀ* sdev->
¶ªes
;

919 
sdev
->
eblocks_š_lun
 = sdev->
mbr
.eblocks_in_lun;

920 
sdev
->
·ges_š_eblock
 = sdev->
mbr
.pages_in_eblock;

921 
sdev
->
Çnd_·ge_shiá
 = sdev->
mbr
.nand_page_shift;

922 
sdev
->
oob_size
 = sdev->
mbr
.oob_size;

923 
sdev
->
logicb_shiá
 = sdev->
mbr
.logicb_shift;

924 
sdev
->
u£r_logicb_shiá
 = sdev->
mbr
.user_logicb_shift;

925 
sdev
->
¶ªe_Üd”
 = sdev->
mbr
.plane_order;

926 
sdev
->
š‹¼u±_d–ay
 = sdev->
mbr
.interrupt_delay;

927 
sdev
->
cfg_chªÃls
 = sdev->
mbr
.cfg_channels;

928 
sdev
->
cfg_lun£t_š_chªÃl
 = sdev->
mbr
.cfg_lunset_in_channel;

929 
sdev
->
cfg_lun_š_lun£t
 = sdev->
mbr
.cfg_lun_in_lunset;

930 
sdev
->
´iÜ™ize_wr™e
 = sdev->
mbr
.
ã©u»_æags
 & 
PRIORITIZE_WRITE
;

931 
sdev
->
©omic_wr™e
 = sdev->
mbr
.
ã©u»_æags
 & 
ATOMIC_WRITE
;

932 
sdev
->
max_wr™e_bw
 = 1024*1024ULL * sdev->
mbr
.max_write_bw;

933 
	`shªnÚ_©omic_£t
(&
sdev
->
wr™e_bw
, 0);

934 
	`ÿlcuÏ‹_glob®_v¬ŸbË
(
sdev
);

935 
sdev
->
ov”´ovisiÚ_¿‹
 = 
	`ÿlcuÏ‹_ov”´ovisiÚ_¿‹
(sdev);

936 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

937 
i
 = 0; i < 
emu_lun_amouÁ
; i++) {

938 
emu_luns
[
i
].
logicb_size
 = 
sdev
->logicb_size;

939 
emu_luns
[
i
].
logicb_shiá
 = 
sdev
->logicb_shift;

940 
emu_luns
[
i
].
logicbs_š_·ge
 = 
sdev
->logicbs_in_page;

943 
	`»£t_hw_cÚŒŞËr
(
sdev
);

944 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

945 
	`shªnÚ_£t_ù¾_·¿m
(
sdev
);

947 
	`š™_glob®_cÚfig_»gs
(
sdev
);

948 
	`£t_avaabË_¿id_¡res
(
sdev
);

949 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

950 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

951 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
sq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr0
);

952 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
sq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr1
);

953 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
cq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr0
);

954 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
cq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr1
);

955 
sdev
->
lun£ts
[
i
].
sq_hw_h—d
 = 0;

956 
sdev
->
lun£ts
[
i
].
sq_h—d
 = 0;

957 
sdev
->
lun£ts
[
i
].
sq_h—d_tmp
 = 0;

958 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 0;

959 
sdev
->
lun£ts
[
i
].
cq_h—d
 = 0;

960 
sdev
->
lun£ts
[
i
].
cq_
 = 0;

961 
sdev
->
lun£ts
[
i
].
cq__tmp
 = 0;

963 #ifdeà
SHANNON_USE_WRITE_BUFFER


964 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

965 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[
i
], &sdev->
bufq_b¬
[i]->
sq_dma_addr0
);

966 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[
i
] >> 32è: 0, &sdev->
bufq_b¬
[i]->
sq_dma_addr1
);

967 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[
i
], &sdev->
bufq_b¬
[i]->
cq_dma_addr0
);

968 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[
i
] >> 32è: 0, &sdev->
bufq_b¬
[i]->
cq_dma_addr1
);

969 
sdev
->
bufq_sq_hw_h—d
[
i
] = 0;

970 
sdev
->
bufq_sq_h—d
[
i
] = 0;

971 
sdev
->
bufq_sq_h—d_tmp
[
i
] = 0;

972 
sdev
->
bufq_cq_hw_h—d
[
i
] = 0;

973 
sdev
->
bufq_cq_h—d
[
i
] = 0;

974 
sdev
->
bufq_cq_
[
i
] = 0;

976 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_ack_cq_dma_addr
, &sdev->
bufq_ack_b¬
->
cq_dma_addr0
);

977 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_ack_cq_dma_addr
 >> 32è: 0, &sdev->
bufq_ack_b¬
->
cq_dma_addr1
);

978 
sdev
->
bufq_ack_cq_hw_h—d
 = 0;

979 
sdev
->
bufq_ack_cq_h—d
 = 0;

980 
sdev
->
bufq_ack_cq_
 = 0;

982 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

983 
	`dump_b¬_¥aû
(
sdev
);

985 
	`debugs1
("reformat step 4:„eset hw controller‡nd core data structs done.\n");

988 ià(
	`»£t_d©a_¡ruù
(
sdev
)) {

989 
	`shªnÚ_”r
("reset data struct failed.\n");

993 ià(
sdev
->
ov”Ïp_wr™e
)

994 
	`´•¬e_ov”Ïp_pba
(
sdev
);

996 ià(
shªnÚ_´eãtch_’abË
)

997 
	`shªnÚ_´eãtch_š™
(&
sdev
->
sdisk
.
´eãtch
, sdev->
logicb_size
);

999 
sdev
->
gc_th»ad
 = 
	`shªnÚ_kth»ad_run
(
gc_th»ad_â
, sdev, "shn_gc_th»ad%c", 'a' + sdev->
drive_no
);

1000 ià(
	`SHANNON_IS_ERR
(
sdev
->
gc_th»ad
))

1001 
	`shªnÚ_”r
("create garbage collectionhread failed!\n");

1002 
sdev
->
»cov”_th»ad
 = 
	`shªnÚ_kth»ad_run
(
»cov”_th»ad_â
, sdev, "shn_»cov”/%c", 'a' + sdev->
drive_no
);

1003 ià(
	`SHANNON_IS_ERR
(
sdev
->
»cov”_th»ad
))

1004 
	`shªnÚ_”r
("create„ecoverhread failed!\n");

1005 
sdev
->
´eãtch_th»ad
 = 
	`shªnÚ_kth»ad_run
(
´eãtch_th»ad_â
, sdev, "shn_´eãtch/%c", 'a' + sdev->
drive_no
);

1006 ià(
	`SHANNON_IS_ERR
(
sdev
->
´eãtch_th»ad
)) {

1007 
	`shªnÚ_”r
("create…refetchhread failed!\n");

1008 
	`£t_´eãtch_di§bË
(&
sdev
->
sdisk
.
´eãtch
);

1010 
	`shªnÚ_mod_tim”
(&
sdev
->
wl_tim”
, 
	`g‘_jiff›s
(è+ sdev->
wl_tim”_š‹rv®
 * 
	`g‘_HZ
());

1011 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++)

1012 
	`mod_fl_sb_tim”
(
sdev
, 
i
, sdev->
aùive_blk
[i]);

1013 
sdev
->
ho¡_acûss_blocked
 = 0;

1014 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_INVALID
;

1016 
	`³riod_»ad_’abË
(
sdev
);

1018 
	`debugs1
("reformat step 5:„enaissance done.\n");

1019 
	`shªnÚ_šfo
("%s:„efÜm© dÚe.\n", 
sdev
->
sdisk
.
disk_Çme
);

1022 
	}
}

1024 
	$ş—r_hi¡Üic_‹m³¿tu»_n_vŞge
(
shªnÚ_dev
 *
sdev
)

1026 
sdev
->
‹m³¿tu»_št_max
 = 0;

1027 
sdev
->
‹m³¿tu»_bßrd_max
 = 0;

1028 
sdev
->
‹m³¿tu»_æash_max
 = 0;

1029 
sdev
->
vŞge_št_max
 = 0;

1030 
sdev
->
vŞge_aux_max
 = 0;

1031 
	}
}

1033 
šlše
 
	$fÜm©_¬g_to_¬g2
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_fÜm©_¬g
 *
¬g1
, 
shªnÚ_fÜm©_¬g2
 *
¬g2
)

1035 ià(
¬g1
->
fÜû_fÜm©
)

1036 
¬g2
->
æags
 |ğ1 << 
FORCE_FORMAT_SHIFT
;

1037 ià(
¬g1
->
ş—r_hi¡Üy
)

1038 
¬g2
->
æags
 |ğ1 << 
CLEAR_HISTORY_SHIFT
;

1039 ià(0 =ğ
¬g1
->
©omic_wr™e
) {

1040 ià(
sdev
->
mbr
.
ã©u»_æags
 & 
ATOMIC_WRITE
)

1041 
¬g2
->
æags
 |ğ1 << 
ATOMIC_WRITE_SHIFT
;

1043 ià(
¬g1
->
©omic_wr™e
 =ğ
SHN_SET_FEATURE
)

1044 
¬g2
->
æags
 |ğ1 << 
ATOMIC_WRITE_SHIFT
;

1046 ià(0 =ğ
¬g1
->
´iÜ™ize_wr™e
) {

1047 ià(
sdev
->
mbr
.
ã©u»_æags
 & 
PRIORITIZE_WRITE
)

1048 
¬g2
->
æags
 |ğ1 << 
PRIO_WRITE_SHIFT
;

1050 if(
¬g1
->
´iÜ™ize_wr™e
 =ğ
SHN_SET_FEATURE
)

1051 
¬g2
->
æags
 |ğ1 << 
PRIO_WRITE_SHIFT
;

1054 
¬g2
->
ÿ·c™y
 = 
¬g1
->capacity;

1055 
¬g2
->
u£r_logicb_shiá
 = 
¬g1
->user_logicb_shift;

1056 
	}
}

1058 
	$shªnÚ_ioùl_nÜæash_İs
(
shªnÚ_dev
 *
sdev
, 
cmd
, 
¬g
)

1060 
shªnÚ_nÜæash_İs
 
nÜæash_İs
;

1062 
u8
 *
d©a_buf
 = 
NULL
;

1063 
»t
 = -
ENOTTY
;

1065 
	`shªnÚ_mem£t
(&
nÜæash_İs
, 0xff, (
shªnÚ_nÜæash_İs
));

1067 ià(
	`shªnÚ_cİy_äom_u£r
(&
nÜæash_İs
, (
shªnÚ_nÜæash_İs
 * 
__u£r
)
¬g
, (shannon_norflash_ops))) {

1068 
	`shªnÚ_”r
("could‚ot copy‚orflash_ops from userspace.\n");

1069  -
ENOTTY
;

1072 
cmd
) {

1073 
SHANNON_IOCWNORERASE
:

1075 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

1076 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_DONE
;

1077 
»t
 = 0;

1081 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1083 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_NORFLASH_ERASE
;

1084 
»t
 = 
	`shªnÚ_nÜæash_”a£
(
sdev
, 
nÜæash_İs
.
off£t
,‚Üæash_İs.
Ëngth
);

1086 ià(
»t
) {

1087 
	`shªnÚ_”r
("%s:‚Üæashƒ¿£ faed!\n", 
sdev
->
sdisk
.
disk_Çme
);

1088 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_INVALID
;

1090 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_DONE
;

1092 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1095 
SHANNON_IOCWNORWRITE
:

1096 
d©a_buf
 = 
	`shªnÚ_vm®loc
(
nÜæash_İs
.
Ëngth
);

1097 ià(!
d©a_buf
) {

1098 
	`shªnÚ_”r
("vmalloc data_buf failed!\n");

1101 
	`shªnÚ_mem£t
(
d©a_buf
, 0x0, 
nÜæash_İs
.
Ëngth
);

1103 ià(
	`shªnÚ_cİy_äom_u£r
(
d©a_buf
, (
u8
 * 
__u£r
)
nÜæash_İs
.
d©a
,‚Üæash_İs.
Ëngth
)) {

1104 
	`shªnÚ_”r
("could‚ot copy data_buf from userspace.\n");

1108 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

1109 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_NORFLASH_WRITE
;

1110 
»t
 = 
	`nÜæash_wr™e_š_4k_mode
(
sdev
, 
nÜæash_İs
.
off£t
,‚Üæash_İs.
Ëngth
, 
d©a_buf
);

1112 ià(
»t
) {

1113 
	`shªnÚ_”r
("%s:‚Üæash wr™çed!\n", 
sdev
->
sdisk
.
disk_Çme
);

1114 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_INVALID
;

1116 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_DONE
;

1118 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1120 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_NORFLASH_WRITE
;

1121 
»t
 = 
	`shªnÚ_nÜæash_wr™e
(
sdev
, 
nÜæash_İs
.
off£t
,‚Üæash_İs.
Ëngth
, 
d©a_buf
);

1123 ià(
»t
) {

1124 
	`shªnÚ_”r
("%s:‚Üæash wr™çed!\n", 
sdev
->
sdisk
.
disk_Çme
);

1125 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_INVALID
;

1127 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_DONE
;

1129 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1133 
SHANNON_IOCRNORREAD
:

1134 
d©a_buf
 = 
	`shªnÚ_vm®loc
(
nÜæash_İs
.
Ëngth
);

1135 ià(!
d©a_buf
) {

1136 
	`shªnÚ_”r
("vmalloc data_buf failed!\n");

1139 
	`shªnÚ_mem£t
(
d©a_buf
, 0x0, 
nÜæash_İs
.
Ëngth
);

1141 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1143 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_NORFLASH_READ
;

1144 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

1145 
»t
 = 
	`nÜæash_»ad_š_4k_mode
(
sdev
, 
nÜæash_İs
.
off£t
,‚Üæash_İs.
Ëngth
, 
d©a_buf
);

1147 
»t
 = 
	`shªnÚ_nÜæash_»ad
(
sdev
, 
nÜæash_İs
.
off£t
,‚Üæash_İs.
Ëngth
, 
d©a_buf
);

1149 ià(
»t
) {

1150 
	`shªnÚ_”r
("%s:‚Üæash„—d faed!\n", 
sdev
->
sdisk
.
disk_Çme
);

1151 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_INVALID
;

1153 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_DONE
;

1155 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1157 ià(
	`shªnÚ_cİy_to_u£r
((
u8
 * 
__u£r
)
nÜæash_İs
.
d©a
, 
d©a_buf
,‚Üæash_İs.
Ëngth
)) {

1158 
	`shªnÚ_”r
("could‚ot copy data_bufo userspace.\n");

1159 
»t
 = -
ENOTTY
;

1163 
	`shªnÚ_”r
("wrong ioctl.\n");

1167 ià(
d©a_buf
)

1168 
	`shªnÚ_vä“
(
d©a_buf
);

1169  
»t
;

1170 
	}
}

1172 
	$shªnÚ_ioùl_mªagem’t
(
shªnÚ_dev
 *
sdev
, 
cmd
, 
¬g
)

1174 
»t
 = -
ENOTTY
;

1175 
__u32
 
»que¡_mode
 = 0;

1177 ià((
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
è&& (
cmd
 !ğ
SHANNON_IOCSFORMAT
)) {

1178 
	`shªnÚ_”r
("Dœeù-IO PCIFÏsh /dev/% i š ERROR s‹! N“d„efÜm©‡ˆÚû.\n", 
sdev
->
cdev_Çme
);

1179  -
ENOTTY
;

1182 ià(
sdev
->
¥oŞ
) {

1183 
	`shªnÚ_šfo
("Operation‚ot supported, device /dev/%s belongso‡…ool!\n",

1184 
sdev
->
sdisk
.
disk_Çme
);

1185  -
EINVAL
;

1188 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1190 
cmd
) {

1191 
SHANNON_IOCSATTACH
:

1192 
»que¡_mode
 = (
__u32
)
¬g
;

1195 
	`shªnÚ_ş—r_b™
(
SHN_REASON_USER_REQUESTED
, &
sdev
->
»adÚly_»asÚ
);

1196 
	`shªnÚ_ş—r_b™
(
SHN_REASON_USER_REQUESTED
, &
sdev
->
»duûd_wr™e_»asÚ
);

1197 ià(
»que¡_mode
 =ğ
SHN_MODE_READONLY
)

1198 
	`shªnÚ_£t_b™
(
SHN_REASON_USER_REQUESTED
, &
sdev
->
»adÚly_»asÚ
);

1199 ià(
»que¡_mode
 =ğ
SHN_MODE_REDUCED_WRITE
)

1200 
	`shªnÚ_£t_b™
(
SHN_REASON_USER_REQUESTED
, &
sdev
->
»duûd_wr™e_»asÚ
);

1202 ià((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_DETACHED
) {

1204 ià((
»t
 = 
	`shªnÚ_©ch
(
sdev
))) {

1205 
	`shªnÚ_”r
("FaedØ©ch Dœeù-IO PCIFÏsh /dev/%s.\n", 
sdev
->
cdev_Çme
);

1208 } ià((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_ATTACHED
) {

1210 
	`upd©e_acûss_mode
(
sdev
);

1211 
	`shªnÚ_šfo
("Dœeù-IO PCIFÏsh /dev/% i ®»ady‡‰ached.\n", 
sdev
->
cdev_Çme
);

1214 
»t
 = 
sdev
->
acûss_mode
;

1216 
SHANNON_IOCCDETACH
:

1217 ià((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_DETACHED
) {

1219 
	`shªnÚ_šfo
("Dœeù-IO PCIFÏsh /dev/% i ®»ady d‘ached.\n", 
sdev
->
sdisk
.
disk_Çme
);

1220 } ià(
shªnÚ_scsi_mode
) {

1221 
	`shªnÚ_”r
("scsi_mode doesn't support detach/attach operation.\n");

1222 
»t
 = -
EPERM
;

1224 } ià((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_ATTACHED
) {

1226 
»t
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
u£rs
);

1227 ià((
»t
 > 1è|| (
	`shªnÚ_bio_š_æight
(
sdev
è+ 
	`shªnÚ_©omic_»ad
(&sdev->
gc_š_æight
))) {

1229 
	`shªnÚ_”r
("FaedØd‘ach Dœeù-IO PCIFÏsh /dev/%s, deviû i busy(u£rcouÁ=%d).\n", 
sdev
->
sdisk
.
disk_Çme
, 
»t
 - 1);

1232 
sdev
->
¡©e
 = ((sdev->¡©& 
SHN_STATE_MASK
è& ~
SHN_STATE_ATTACHED
è| 
SHN_STATE_DETACHED
;

1233 
	`shªnÚ_b¬r›r
();

1234 
»t
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
u£rs
);

1235 ià((
»t
 > 1è|| (
	`shªnÚ_bio_š_æight
(
sdev
è+ 
	`shªnÚ_©omic_»ad
(&sdev->
gc_š_æight
))) {

1237 
	`shªnÚ_”r
("FaedØd‘ach Dœeù-IO PCIFÏsh /dev/%s, deviû i busy(u£rcouÁ=%d).\n", 
sdev
->
sdisk
.
disk_Çme
, 
»t
 - 1);

1238 
sdev
->
¡©e
 = (sdev->¡©& 
SHN_STATE_MASK
è| 
SHN_STATE_ATTACHED
;

1242 
	`shªnÚ_d‘ach
(
sdev
);

1245 
»t
 = 0;

1247 
SHANNON_IOCSFORMAT
:

1248 
SHANNON_IOC_FORMAT
:

1250 
shªnÚ_fÜm©_¬g
 
fÜm©_¬g
;

1251 
shªnÚ_fÜm©_¬g2
 
fÜm©_¬g2
;

1253 ià(
cmd
 =ğ
SHANNON_IOCSFORMAT
) {

1254 
	`shªnÚ_mem£t
(&
fÜm©_¬g
, 0x00, (
shªnÚ_fÜm©_¬g
));

1255 
	`shªnÚ_mem£t
(&
fÜm©_¬g2
, 0x00, (
shªnÚ_fÜm©_¬g2
));

1256 ià(
	`shªnÚ_cİy_äom_u£r
(&
fÜm©_¬g
, (
shªnÚ_fÜm©_¬g
 * 
__u£r
)
¬g
, (shannon_format_arg))) {

1257 
	`shªnÚ_”r
("failedo copy format_arg2 from userspace.\n");

1260 
	`fÜm©_¬g_to_¬g2
(
sdev
, &
fÜm©_¬g
, &
fÜm©_¬g2
);

1262 
	`shªnÚ_mem£t
(&
fÜm©_¬g2
, 0x00, (
shªnÚ_fÜm©_¬g2
));

1263 ià(
	`shªnÚ_cİy_äom_u£r
(&
fÜm©_¬g2
, (
shªnÚ_fÜm©_¬g2
 * 
__u£r
)
¬g
, (shannon_format_arg2))) {

1264 
	`shªnÚ_”r
("failedo copy format_arg2 from userspace.\n");

1269 ià((0 =ğ(
fÜm©_¬g2
.
æags
 & (1 << 
FORCE_FORMAT_SHIFT
))è&& ((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_ATTACHED
)) {

1270 
	`shªnÚ_”r
("Cª‚Ù„efÜm© Dœeù-IO PCIFÏsh /dev/%s, deviû i busy.\n", 
sdev
->
cdev_Çme
);

1274 ià(
fÜm©_¬g2
.
æags
 & (1 << 
CLEAR_ERASE_COUNT_SHIFT
) && \

1275 (
fÜm©_¬g2
.
”a£_couÁ
 > 10000)) {

1276 
	`shªnÚ_”r
("Cª‚Ù„efÜm© /dev/%s,ƒ¿£ couÁ i šv®id.\n", 
sdev
->
cdev_Çme
);

1280 ià(
	`shªnÚ_bio_š_æight
(
sdev
)) {

1281 
	`shªnÚ_”r
("Cª‚Ù„efÜm© /dev/%s, deviû ha IOs.\n", 
sdev
->
cdev_Çme
);

1286 ià(
fÜm©_¬g2
.
ÿ·c™y
 >ğ
sdev
->
max_£ùÜs
) {

1287 
	`shªnÚ_”r
("capacity„equested is beyond…hysical capacity.\n");

1292 
sdev
->
sdisk
.
Üig_m­_bË_size
 = sdev->sdisk.
tÙ®_m­_bË_size
;

1294 
sdev
->
´og»ss_b¬_v®id
 = 
SHN_PROGRESS_INVALID
;

1296 ià((
»t
 = 
	`»fÜm©
(
sdev
, &
fÜm©_¬g2
))) {

1297 
sdev
->
¡©e
 |ğ
SHN_STATE_ERROR_BIT
;

1299 
	`shªnÚ_”r
("FaedØ»fÜm© Dœeù-IO PCIFÏsh /dev/%s, s‘ disk s‹ØERROR.\n", 
sdev
->
cdev_Çme
);

1303 ià(
fÜm©_¬g2
.
æags
 & (1 << 
CLEAR_HISTORY_SHIFT
))

1304 
	`ş—r_hi¡Üic_‹m³¿tu»_n_vŞge
(
sdev
);

1306 ià(
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
)

1307 
sdev
->
¡©e
 &ğ~
SHN_STATE_ERROR_BIT
;

1308 
	`shªnÚ_ş—r_b™
(
SHN_REASON_EPILOG_FAILURE
, &
sdev
->
»adÚly_»asÚ
);

1309 
	`shªnÚ_ş—r_b™
(
SHN_REASON_MANY_BAD_BLOCKS
, &
sdev
->
»duûd_wr™e_»asÚ
);

1310 
	`shªnÚ_mem£t
(
sdev
->
”r_check_b™m­
, 0, 
LUN_BITMAP_LEN
);

1311 
	`upd©e_acûss_mode
(
sdev
);

1313 ià((
shªnÚ_scsi_mode
 =ğ0è&& ((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_ATTACHED
)) {

1314 
	`shªnÚ_blk_queue_block_size
(
sdev
->
sdisk
.
queue
, sdev->
u£r_logicb_size
, sdev->
logicb_size
);

1315 
	`shªnÚ_£t_ÿ·c™y
(
sdev
->
sdisk
.
gd
, sdev->sdisk.
£ùÜs
);

1318 
	`shªnÚ_šfo
("Reformatted Direct-IO PCIe Flash /dev/%s: sector size:†ogical %d /…hysical %d, capacity: %d GB, overprovision: %d.%d%%.\n", \

1319 
sdev
->
cdev_Çme
, sdev->
u£r_logicb_size
, sdev->
logicb_size
,

1320 ()(
sdev
->
sdisk
.
£ùÜs
 * 512 / 1000000000), sdev->
ov”´ovisiÚ_¿‹
 / 100,

1321 
sdev
->
ov”´ovisiÚ_¿‹
 % 100);

1326 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1327  
»t
;

1328 
	}
}

1330 
shªnÚ_fÜû_rw
;

1333 
	$shªnÚ_ioùl_sm¬t
(
shªnÚ_dev
 *
sdev
, 
cmd
, 
¬g
)

1335 
shªnÚ_sm¬t
 *
sm¬t
 = 
NULL
;

1337 
sm¬t
 = 
	`shªnÚ_km®loc
((
shªnÚ_sm¬t
), 
GFP_SHANNON
);

1338 ià(
sm¬t
 =ğ
NULL
) {

1339 
	`shªnÚ_”r
("kmalloc smart failed.\n");

1340  -
ENOMEM
;

1343 
	`shªnÚ_mem£t
(
sm¬t
, 0xFF, (
shªnÚ_sm¬t
));

1345 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

1346 
sm¬t
->
pow”_Ú_£cÚds
 = 
sdev
->power_on_seconds;

1347 
sm¬t
->
pow”_cyşe_couÁ
 = 
sdev
->power_cycle_count;

1349 
sm¬t
->
ÿ·c™y
 = 
sdev
->
sdisk
.
£ùÜs
;

1350 
sm¬t
->
physiÿl_ÿ·c™y
 = 
sdev
->
max_£ùÜs
;

1351 
sm¬t
->
ov”´ovisiÚ
 = 
sdev
->
ov”´ovisiÚ_¿‹
;

1352 
sm¬t
->
ä“_blkút
 = 
sdev
->free_blkcnt;

1354 
sm¬t
->
Êk¡a
 = 
sdev
->
pci_šfo
.lnksta;

1355 
sm¬t
->
Êkÿp
 = 
sdev
->
pci_šfo
.lnkcap;

1356 
sm¬t
->
deviû_id
 = 
sdev
->
pci_šfo
.device_id;

1357 
sm¬t
->
subsy¡em_deviû_id
 = 
sdev
->
pci_šfo
.subsystem_device_id;

1358 
sm¬t
->
subsy¡em_v’dÜ_id
 = 
sdev
->
pci_šfo
.subsystem_vendor_id;

1359 
sm¬t
->
pci_bus_numb”
 = 
sdev
->
pci_šfo
.pci_bus_number;

1360 
sm¬t
->
pci_¦Ù_numb”
 = 
sdev
->
pci_šfo
.pci_slot_number;

1361 
sm¬t
->
pci_func_numb”
 = 
sdev
->
pci_šfo
.pci_func_number;

1363 
	`upd©e_”a£_couÁ
(
sdev
);

1364 
sm¬t
->
max_”a£_couÁ
 = 
sdev
->max_erase_count;

1365 
sm¬t
->
mš_”a£_couÁ
 = 
sdev
->min_erase_count;

1366 
sm¬t
->
av”age_”a£_couÁ
 = 
sdev
->average_erase_count;

1367 
sm¬t
->
tÙ®_”a£_couÁ
 = 
sdev
->total_erase_count;

1368 
sm¬t
->
v¬Ÿnû_of_”a£_couÁ
 = 
sdev
->variance_of_erase_count;

1369 ià(
sdev
->
av”age_”a£_couÁ
 >ğsdev->
æash_³_th»shŞd
)

1370 
sm¬t
->
e¡im©ed_liã_Ëá
 = 0UL;

1372 
sm¬t
->
e¡im©ed_liã_Ëá
 = (
sdev
->
æash_³_th»shŞd
 - sdev->
av”age_”a£_couÁ
) * 100000 / sdev->flash_pe_threshold;

1374 
sm¬t
->
¡©ic_bad_blkút
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->static_bad_blkcnt);

1375 
sm¬t
->
dyÇmic_bad_blkút
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->dynamic_bad_blkcnt);

1376 
sm¬t
->
ecc_çu»_times
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->ecc_failure_times);

1378 
	`upd©e_io_¡©i¡ics
(
sdev
);

1379 
sm¬t
->
ho¡_wr™e_£ùÜs
 = 
sdev
->host_write_sectors;

1380 
sm¬t
->
ho¡_wr™e_bªdwidth
 = 
sdev
->host_write_bandwidth;

1381 
sm¬t
->
ho¡_wr™e_ios
 = 
sdev
->host_write_ios;

1382 
sm¬t
->
ho¡_wr™e_iİs
 = 
sdev
->host_write_iops;

1383 
sm¬t
->
ho¡_wr™e_m£cs
 = 
sdev
->host_write_msecs;

1384 
sm¬t
->
ho¡_wr™e_Ï‹ncy
 = 
sdev
->host_write_latency;

1385 
sm¬t
->
tÙ®_wr™e_£ùÜs
 = 
sdev
->total_write_sectors;

1386 
sm¬t
->
tÙ®_wr™e_bªdwidth
 = 
sdev
->total_write_bandwidth;

1387 
sm¬t
->
ho¡_»ad_£ùÜs
 = 
sdev
->host_read_sectors;

1388 
sm¬t
->
ho¡_»ad_bªdwidth
 = 
sdev
->host_read_bandwidth;

1389 
sm¬t
->
ho¡_»ad_ios
 = 
sdev
->host_read_ios;

1390 
sm¬t
->
ho¡_»ad_iİs
 = 
sdev
->host_read_iops;

1391 
sm¬t
->
ho¡_»ad_m£cs
 = 
sdev
->host_read_msecs;

1392 
sm¬t
->
ho¡_»ad_Ï‹ncy
 = 
sdev
->host_read_latency;

1393 
sm¬t
->
bufãr_wr™e_³rûÁ
 = 
sdev
->buffer_write_percent;

1394 
sm¬t
->
wr™e_am¶if›r
 = 
sdev
->write_amplifier;

1395 
sm¬t
->
wr™e_am¶if›r_liãtime
 = 
sdev
->write_amplifier_lifetime;

1397 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

1398 
sm¬t
->
‹m³¿tu»_št
 = 
sdev
->temperature_int;

1399 
sm¬t
->
‹m³¿tu»_št_max
 = 
sdev
->temperature_int_max;

1400 
sm¬t
->
‹m³¿tu»_bßrd
 = 
sdev
->temperature_board;

1401 
sm¬t
->
‹m³¿tu»_bßrd_max
 = 
sdev
->temperature_board_max;

1402 
sm¬t
->
‹m³¿tu»_æash
 = 
sdev
->temperature_flash;

1403 
sm¬t
->
‹m³¿tu»_æash_max
 = 
sdev
->temperature_flash_max;

1404 
sm¬t
->
vŞge_št
 = 
sdev
->voltage_int;

1405 
sm¬t
->
vŞge_št_max
 = 
sdev
->voltage_int_max;

1406 
sm¬t
->
vŞge_aux
 = 
sdev
->voltage_aux;

1407 
sm¬t
->
vŞge_aux_max
 = 
sdev
->voltage_aux_max;

1409 ià(
	`shªnÚ_dev_is_g5_ff§
(
sdev
)) {

1410 
sm¬t
->
£u_üc_”rÜ
 = 0;

1411 
sm¬t
->
£u_üc_”rÜ_hi¡Üy
 = 0;

1412 
sm¬t
->
£u_ecc_”rÜ
 = 0;

1413 
sm¬t
->
£u_ecc_”rÜ_hi¡Üy
 = 0;

1415 
	`»ad_£u_šfo
(
sdev
);

1416 
sm¬t
->
£u_üc_”rÜ
 = 
sdev
->seu_crc_error;

1417 
sm¬t
->
£u_üc_”rÜ_hi¡Üy
 = 
sdev
->seu_crc_error_history;

1418 
sm¬t
->
£u_ecc_”rÜ
 = 
sdev
->seu_ecc_error;

1419 
sm¬t
->
£u_ecc_”rÜ_hi¡Üy
 = 
sdev
->seu_ecc_error_history;

1422 
sm¬t
->
ecc_cÜ»ùiÚ_pow”
 = 
sdev
->ecc_correction_power;

1423 
sm¬t
->
ecc_codewÜd_size
 = 
sdev
->ecc_codeword_size;

1425 
sm¬t
->
bufãr_wr™e_couÁ”
 = 
sdev
->buffer_write_counter;

1426 
sm¬t
->
dœeù_wr™e_couÁ”
 = 
sdev
->direct_write_counter;

1428 
sm¬t
->
hw_cfg_chªÃls
 = 
sdev
->
max_chªÃls
;

1429 
sm¬t
->
hw_cfg_lun£t_š_chªÃl
 = 
sdev
->
max_lun£t_š_chªÃl
;

1430 
sm¬t
->
hw_cfg_lun_š_lun£t
 = 
sdev
->
max_lun_š_lun£t
 - 1;

1432 
sm¬t
->
æashid
 = 
sdev
->flashid;

1433 
sm¬t
->
h®_v”siÚ
 = 
sdev
->
h¬dw¬e_v”siÚ
;

1434 
sm¬t
->
has_£rviû_g
 = 1;

1435 
	`shªnÚ_memıy
(
sm¬t
->
£rviû_g
, 
sdev
->service_tag, 32);

1436 
	`shªnÚ_memıy
(
sm¬t
->
mod–_id
, 
sdev
->model_id, 40);

1438 
	`shªnÚ_memıy
(
sm¬t
->
udid
, 
sdev
->udid, 36);

1440 
sm¬t
->
åga_»cÚfig_sup
 = 
sdev
->
»cÚfig_suµÜt
;

1441 
sm¬t
->
åga_»cÚfig_times
 = 
sdev
->
»cÚfig_times
;

1443 ià(
shªnÚ_scsi_mode
) {

1444 
sm¬t
->
scsi_mode
 = 1;

1445 
sm¬t
->
scsi_ho¡_no
 = ((
shªnÚ_scsi_´iv©e
 *)(
sdev
->
sdisk
.
ho¡d©a
))->scsi_host_no;

1447 
sm¬t
->
scsi_mode
 = 0;

1448 
sm¬t
->
scsi_ho¡_no
 = 0;

1451 ià(
shªnÚ_fÜû_rw
)

1452 
sm¬t
->
fÜû_rw
 = 1;

1454 
sm¬t
->
fÜû_rw
 = 0;

1456 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_sm¬t
 * 
__u£r
)
¬g
, 
sm¬t
, (shannon_smart))) {

1457 
	`shªnÚ_”r
("could‚ot copy shannon smart‡ttributeso userspace.\n");

1458 
	`shªnÚ_kä“
(
sm¬t
);

1459  -
ENOTTY
;

1462 
	`shªnÚ_kä“
(
sm¬t
);

1464 
	}
}

1466 
	$shªnÚ_g‘_dev_¡©us
(
shªnÚ_dev
 *
sdev
, 
cmd
, 
¬g
)

1468 
shªnÚ_dev_¡©us
 *
¡©us
 = 
NULL
;

1470 
¡©us
 = 
	`shªnÚ_km®loc
((
shªnÚ_dev_¡©us
), 
GFP_SHANNON
);

1471 ià(
¡©us
 =ğ
NULL
) {

1472 
	`shªnÚ_”r
("kmalloc status failed.\n");

1473  -
ENOMEM
;

1476 
	`shªnÚ_mem£t
(
¡©us
, 0xFF, (
shªnÚ_dev_¡©us
));

1480 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

1481 
¡©us
->
pow”_Ú_£cÚds
 = 
sdev
->power_on_seconds;

1482 
¡©us
->
pow”_cyşe_couÁ
 = 
sdev
->power_cycle_count;

1484 
¡©us
->
ÿ·c™y
 = 
sdev
->
sdisk
.
£ùÜs
;

1485 
¡©us
->
physiÿl_ÿ·c™y
 = 
sdev
->
max_£ùÜs
;

1486 
¡©us
->
ov”´ovisiÚ
 = 
sdev
->
ov”´ovisiÚ_¿‹
;

1487 
¡©us
->
ä“_blkút
 = 
sdev
->free_blkcnt;

1489 
¡©us
->
Êk¡a
 = 
sdev
->
pci_šfo
.lnksta;

1490 
¡©us
->
deviû_id
 = 
sdev
->
pci_šfo
.device_id;

1491 
¡©us
->
subsy¡em_deviû_id
 = 
sdev
->
pci_šfo
.subsystem_device_id;

1492 
¡©us
->
pci_bus_numb”
 = 
sdev
->
pci_šfo
.pci_bus_number;

1493 
¡©us
->
pci_¦Ù_numb”
 = 
sdev
->
pci_šfo
.pci_slot_number;

1494 
¡©us
->
pci_func_numb”
 = 
sdev
->
pci_šfo
.pci_func_number;

1496 
	`upd©e_”a£_couÁ
(
sdev
);

1497 ià(
sdev
->
av”age_”a£_couÁ
 >ğsdev->
æash_³_th»shŞd
)

1498 
¡©us
->
e¡im©ed_liã_Ëá
 = 0UL;

1500 
¡©us
->
e¡im©ed_liã_Ëá
 = (
sdev
->
æash_³_th»shŞd
 - sdev->
av”age_”a£_couÁ
) * 100000 / sdev->flash_pe_threshold;

1502 
¡©us
->
¡©ic_bad_blkút
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->static_bad_blkcnt);

1503 
¡©us
->
dyÇmic_bad_blkút
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->dynamic_bad_blkcnt);

1504 
¡©us
->
ecc_çu»_times
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->ecc_failure_times);

1506 
	`upd©e_io_¡©i¡ics
(
sdev
);

1507 
¡©us
->
ho¡_wr™e_£ùÜs
 = 
sdev
->host_write_sectors;

1508 
¡©us
->
ho¡_wr™e_bªdwidth
 = 
sdev
->host_write_bandwidth;

1509 
¡©us
->
ho¡_wr™e_iİs
 = 
sdev
->host_write_iops;

1510 
¡©us
->
ho¡_wr™e_Ï‹ncy
 = 
sdev
->host_write_latency;

1511 
¡©us
->
tÙ®_wr™e_£ùÜs
 = 
sdev
->total_write_sectors;

1512 
¡©us
->
tÙ®_wr™e_bªdwidth
 = 
sdev
->total_write_bandwidth;

1513 
¡©us
->
ho¡_»ad_£ùÜs
 = 
sdev
->host_read_sectors;

1514 
¡©us
->
ho¡_»ad_bªdwidth
 = 
sdev
->host_read_bandwidth;

1515 
¡©us
->
ho¡_»ad_iİs
 = 
sdev
->host_read_iops;

1516 
¡©us
->
ho¡_»ad_Ï‹ncy
 = 
sdev
->host_read_latency;

1517 
¡©us
->
bufãr_wr™e_³rûÁ
 = 
sdev
->buffer_write_percent;

1518 
¡©us
->
wr™e_am¶if›r
 = 
sdev
->write_amplifier;

1519 
¡©us
->
wr™e_am¶if›r_liãtime
 = 
sdev
->write_amplifier_lifetime;

1520 
¡©us
->
tÙ®_gc_£ùÜs
 = 
sdev
->
tÙ®_gc_logicbs
 * sdev->
£ùÜs_š_logicb
;

1521 
¡©us
->
tÙ®_wl_£ùÜs
 = 
sdev
->
tÙ®_wl_logicbs
 * sdev->
£ùÜs_š_logicb
;

1522 
¡©us
->
tÙ®_”r_»cov”_£ùÜs
 = 
sdev
->
tÙ®_”r_»cov”_logicbs
 * sdev->
£ùÜs_š_logicb
;

1523 
¡©us
->
gc_bªdwidth
 = 
sdev
->gc_bandwidth;

1524 
¡©us
->
wl_bªdwidth
 = 
sdev
->wl_bandwidth;

1525 
¡©us
->
”r_»cov”_bªdwidth
 = 
sdev
->err_recover_bandwidth;

1527 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

1528 
¡©us
->
‹m³¿tu»_št
 = 
sdev
->temperature_int;

1529 
¡©us
->
‹m³¿tu»_št_max
 = 
sdev
->temperature_int_max;

1530 
¡©us
->
‹m³¿tu»_bßrd
 = 
sdev
->temperature_board;

1531 
¡©us
->
‹m³¿tu»_bßrd_max
 = 
sdev
->temperature_board_max;

1532 
¡©us
->
‹m³¿tu»_æash
 = 
sdev
->temperature_flash;

1533 
¡©us
->
‹m³¿tu»_æash_max
 = 
sdev
->temperature_flash_max;

1534 
¡©us
->
vŞge_št
 = 
sdev
->voltage_int;

1535 
¡©us
->
vŞge_št_max
 = 
sdev
->voltage_int_max;

1536 
¡©us
->
vŞge_aux
 = 
sdev
->voltage_aux;

1537 
¡©us
->
vŞge_aux_max
 = 
sdev
->voltage_aux_max;

1539 ià(
	`shªnÚ_dev_is_g5_ff§
(
sdev
)) {

1540 
¡©us
->
£u_üc_”rÜ
 = 0;

1541 
¡©us
->
£u_üc_”rÜ_hi¡Üy
 = 0;

1542 
¡©us
->
£u_ecc_”rÜ
 = 0;

1543 
¡©us
->
£u_ecc_”rÜ_hi¡Üy
 = 0;

1545 
	`»ad_£u_šfo
(
sdev
);

1546 
¡©us
->
£u_üc_”rÜ
 = 
sdev
->seu_crc_error;

1547 
¡©us
->
£u_üc_”rÜ_hi¡Üy
 = 
sdev
->seu_crc_error_history;

1548 
¡©us
->
£u_ecc_”rÜ
 = 
sdev
->seu_ecc_error;

1549 
¡©us
->
£u_ecc_”rÜ_hi¡Üy
 = 
sdev
->seu_ecc_error_history;

1552 
¡©us
->
ecc_cÜ»ùiÚ_pow”
 = 
sdev
->ecc_correction_power;

1553 
¡©us
->
ecc_codewÜd_size
 = 
sdev
->ecc_codeword_size;

1555 
¡©us
->
hw_cfg_chªÃls
 = 
sdev
->
max_chªÃls
;

1556 
¡©us
->
hw_cfg_lun£t_š_chªÃl
 = 
sdev
->
max_lun£t_š_chªÃl
;

1557 
¡©us
->
hw_cfg_lun_š_lun£t
 = 
sdev
->
max_lun_š_lun£t
 - 1;

1559 
¡©us
->
æashid
 = 
sdev
->flashid;

1560 
¡©us
->
h®_v”siÚ
 = 
sdev
->
h¬dw¬e_v”siÚ
;

1561 
	`shªnÚ_memıy
(
¡©us
->
£rviû_g
, 
sdev
->service_tag, 32);

1562 
	`shªnÚ_memıy
(
¡©us
->
mod–_id
, 
sdev
->model_id, 40);

1564 
	`shªnÚ_memıy
(
¡©us
->
udid
, 
sdev
->udid, 36);

1566 
¡©us
->
åga_»cÚfig_sup
 = 
sdev
->
»cÚfig_suµÜt
;

1567 
¡©us
->
åga_»cÚfig_times
 = 
sdev
->
»cÚfig_times
;

1569 ià(
shªnÚ_scsi_mode
) {

1570 
¡©us
->
scsi_mode
 = 1;

1571 
¡©us
->
scsi_ho¡_no
 = ((
shªnÚ_scsi_´iv©e
 *)(
sdev
->
sdisk
.
ho¡d©a
))->scsi_host_no;

1573 
¡©us
->
scsi_mode
 = 0;

1574 
¡©us
->
scsi_ho¡_no
 = 0;

1577 ià(
shªnÚ_fÜû_rw
)

1578 
¡©us
->
fÜû_rw
 = 1;

1580 
¡©us
->
fÜû_rw
 = 0;

1582 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_dev_¡©us
 * 
__u£r
)
¬g
, 
¡©us
, (shannon_dev_status))) {

1583 
	`shªnÚ_”r
("could‚ot copy shannon dev_status‡ttributeso userspace.\n");

1584 
	`shªnÚ_kä“
(
¡©us
);

1585  -
ENOTTY
;

1588 
	`shªnÚ_kä“
(
¡©us
);

1590 
	}
}

1592 
	$»gi¡”_İ
(
shªnÚ_dev
 *
sdev
, 
cmd
, 
¬g
)

1594 
shªnÚ_»g
 
»g
;

1595 
u32
 *
d©a_buf
 = 
NULL
;

1596 
u32
 *
addr
 = 
NULL
;

1597 
i
, 
»t
 = -1;

1599 
addr
 = (
u32
 *)
sdev
->
b¬
;

1601 ià(
	`shªnÚ_cİy_äom_u£r
(&
»g
, (
shªnÚ_»g
 * 
__u£r
)
¬g


1602 , (
shªnÚ_»g
))) {

1603 
	`shªnÚ_”r
("could‚ot copy given„eg from userspace.\n");

1604 
»gi¡”_İ_çed
;

1607 ià((
sdev
->
š‹¼u±_b¬
 <ğ
addr
 + 
»g
.reg)

1608 && ((
addr
 + 
»g
.»g +„eg.
Ën
è< (
sdev
->
š‹¼u±_b¬
 + 9))) {

1609 
	`shªnÚ_log
("%s: inv®id‡cûs tØš‹¼u±„egi¡”.n", 
sdev
->
sdisk
.
disk_Çme
);

1613 
d©a_buf
 = 
	`shªnÚ_km®loc
((
u32
)*
»g
.
Ën
, 
GFP_SHANNON
);

1614 ià(
d©a_buf
 =ğ
NULL
) {

1615 
	`shªnÚ_”r
("kmalloc data buf failed.\n");

1616 
»gi¡”_İ_çed
;

1619 
addr
 = (
u32
 *)
sdev
->
b¬
;

1620 ià(
cmd
 =ğ
SHANNON_IOCRDREG
) {

1621 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1622 
i
 = 0; i < 
»g
.
Ën
; i++)

1623 
d©a_buf
[
i
] = 
	`shªnÚ_iÜ—d32
(
addr
 + 
»g
.reg + i);

1624 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1626 ià(
	`shªnÚ_cİy_to_u£r
((
u32
 * 
__u£r
)
»g
.
buf
,

1627 
d©a_buf
, (
u32
)*
»g
.
Ën
)) {

1628 
	`shªnÚ_”r
("could‚ot copy„ego userspace.\n");

1629 
»gi¡”_İ_çed
;

1632 ià(
	`shªnÚ_cİy_äom_u£r
(
d©a_buf
, (
u32
 * 
__u£r
)
»g
.
buf
,

1633 (
u32
)*
»g
.
Ën
)) {

1634 
	`shªnÚ_”r
("could‚ot copy„ego userspace.\n");

1635 
»gi¡”_İ_çed
;

1638 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1639 
i
 = 0; i < 
»g
.
Ën
; i++)

1640 
	`shªnÚ_iowr™e32
(
d©a_buf
[
i
], 
addr
 + 
»g
.reg + i);

1641 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1644 
»t
 = 0;

1645 
»gi¡”_İ_çed
:

1646 ià(
d©a_buf
)

1647 
	`shªnÚ_kä“
(
d©a_buf
);

1649  
»t
;

1650 
	}
}

1652 
	$shªnÚ_g‘_ÿ·b™›s
(
shªnÚ_dev
 *
sdev
, 
¬g
)

1654 
u64
 
ÿp
 = 0;

1656 
ÿp
 |ğ
SUPPORT_NEW_FORMAT
;

1657 
ÿp
 |ğ
SUPPORT_MARK_BAD_LUN
;

1658 
ÿp
 |ğ
SUPPORT_MARK_BAD_EBLK
;

1659 
ÿp
 |ğ
SUPPORT_CLEAR_ERASE_COUNT
;

1660 
ÿp
 |ğ
SUPPORT_NEW_DEV_STATUS
;

1661 
ÿp
 |ğ
SUPPORT_LARGE_ECC_POWER
;

1662 
ÿp
 |ğ
SUPPORT_UPDATE_MICROCODE
;

1664 ià(
	`shªnÚ_cİy_to_u£r
((
u64
 * 
__u£r
)
¬g
, &
ÿp
, (u64))) {

1665 
	`shªnÚ_”r
("copyo user faile!\n");

1666  -
EIO
;

1670 
	}
}

1672 
	$shªnÚ_ioùl
(
shªnÚ_fe_t
 *
fp
, 
cmd
, 
¬g
)

1674 
¬gum’t
;

1675 
»t
 = -
ENOTTY
;

1676 
shªnÚ_dev
 *
sdev
;

1677 
shªnÚ_disk_¡©us
 
disk_¡©us
;

1678 
shªnÚ_v”siÚ_šfo
 
v”_šfo
;

1679 
shªnÚ_´og»ss_b¬
 
´og»ss_b¬
;

1680 
shªnÚ_sb
 *
sb
;

1681 
shªnÚ_m¬k_¬g
 
eblk
;

1682 
u32
 
code
;

1684 
	`debugs4
("enter ioctl.\n");

1686 ià(
	`_IOC_TYPE
(
cmd
è!ğ
SHANNON_IOCMAGIC
)

1687  -
ENOTTY
;

1688 ià(
	`_IOC_NR
(
cmd
è>ğ
SHANNON_IOCMAXNR
)

1689  -
ENOTTY
;

1691 
sdev
 = 
	`shªnÚ_fe_´iv©e_d©a
(
fp
);

1692 ià((
sdev
 =ğ
NULL
è|| sdev->
sdisk
.
ex™
) {

1693 
	`shªnÚ_”r
("could‚ot get sdev.\n");

1694  -
ENOTTY
;

1697 
cmd
) {

1698 
SHANNON_IOC_GET_CAP
:

1699  
	`shªnÚ_g‘_ÿ·b™›s
(
sdev
, 
¬g
);

1700 
SHANNON_IOCRMBR
:

1701 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_mbr
 * 
__u£r
)
¬g
, &
sdev
->
mbr
, (shannon_mbr))) {

1702 
	`shªnÚ_”r
("could‚ot copy mbro userspace.\n");

1703  -
ENOTTY
;

1706 
SHANNON_IOCSATTACH
:

1707 
SHANNON_IOCCDETACH
:

1708 
SHANNON_IOCSFORMAT
:

1710 
SHANNON_IOC_FORMAT
:

1711  
	`shªnÚ_ioùl_mªagem’t
(
sdev
, 
cmd
, 
¬g
);

1712 
SHANNON_IOCCREATEPOOL
:

1713  
	`ü—‹_poŞ
(
¬g
);

1714 
SHANNON_IOCCRECONFIG
:

1715 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1716 
	`shªnÚ_»cÚfig
(
sdev
);

1717 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1720 
SHANNON_IOCCRESET
:

1721 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1722 
	`shªnÚ_»£t
(
sdev
);

1723 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1726 
SHANNON_IOCCEJECT
:

1727 ià(
sdev
->
hÙ_¶uggabË
 == 0)

1728  -
ENOTTY
;

1729 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1730 
	`shªnÚ_scheduË_d–ayed_wÜk
(&
sdev
->
ejeù_wÜk
, 
	`g‘_HZ
());

1731 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1733 
SHANNON_IOCRSTATUS
:

1735 
	`shªnÚ_mem£t
(&
disk_¡©us
, 0xFF, (
shªnÚ_disk_¡©us
));

1736 
disk_¡©us
.
¡©e
 = 
sdev
->state;

1737 
disk_¡©us
.
acûss_mode
 = 
sdev
->access_mode;

1738 
disk_¡©us
.
»adÚly_»asÚ
 = 
sdev
->readonly_reason;

1739 
disk_¡©us
.
»duûd_wr™e_»asÚ
 = 
sdev
->reduced_write_reason;

1741 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_disk_¡©us
 * 
__u£r
)
¬g
, &
disk_¡©us
, (shannon_disk_status))) {

1742 
	`shªnÚ_”r
("could‚ot copy disk_statuso userspace.\n");

1743  -
ENOTTY
;

1746 
SHANNON_IOCRSMART
:

1747  
	`shªnÚ_ioùl_sm¬t
(
sdev
, 
cmd
, 
¬g
);

1748 
SHANNON_IOCRDEVSTATUS
:

1749  
	`shªnÚ_g‘_dev_¡©us
(
sdev
, 
cmd
, 
¬g
);

1750 
SHANNON_IOCWLED
:

1751 
¬gum’t
 = ()
¬g
;

1752 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1753 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1754 ià(
¬gum’t
) {

1755 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

1756 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
G5_LED
, 
YELLOW_BRIGHT
|
GREEN_FLASHING
);

1758 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
LED
, 
YELLOW_BRIGHT
|
GREEN_FLASHING
);

1760 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

1761 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
G5_LED
, 
YELLOW_DARK
|
GREEN_FLASHING
);

1763 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
LED
, 
YELLOW_DARK
|
GREEN_FLASHING
);

1765 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1766 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1768 
SHANNON_IOCRECC
:

1769 
SHANNON_IOCRECC_LARGE
:

1770 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_ecc_¡©
 * 
__u£r
)
¬g
, &
sdev
->
ecc_¡©i¡ics
, (shannon_ecc_stat))) {

1771 
	`shªnÚ_”r
("could‚ot copyƒcc correction statisticso userspace.\n");

1772  -
ENOTTY
;

1776 
SHANNON_IOCRVERINFO
:

1777 
	`shªnÚ_mem£t
(&
v”_šfo
, 0x00, (
shªnÚ_v”siÚ_šfo
));

1779 
v”_šfo
.
fœmw¬e_v”siÚ
 = 
sdev
->firmware_version;

1780 
v”_šfo
.
fœmw¬e_g
 = 
sdev
->firmware_tag;

1781 
v”_šfo
.
driv”_v”siÚ
 = 
SHANNON_VERSION_CODE
;

1782 
v”_šfo
.
driv”_fix_v”siÚ
 = 
SHANNON_FIX_VERSION_CODE
;

1783 
v”_šfo
.
£rŸl_numb”
 = 
sdev
->
dÇ
;

1784 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_v”siÚ_šfo
 * 
__u£r
)
¬g
, &
v”_šfo
, (shannon_version_info))) {

1785 
	`shªnÚ_”r
("could‚ot copy version informationo userspace.\n");

1786  -
ENOTTY
;

1790 
SHANNON_IOCRPROGRESS
:

1791 
	`shªnÚ_mem£t
(&
´og»ss_b¬
, 0x00, (
shªnÚ_´og»ss_b¬
));

1793 
´og»ss_b¬
.
v®id
 = 
sdev
->
´og»ss_b¬_v®id
;

1795 
´og»ss_b¬
.
v®id
) {

1796 
SHN_PROGRESS_VALID
:

1797 
´og»ss_b¬
.
³rûÁ
 = 100 * (
sdev
->
sb_couÁ
 - sdev->
mbr_eblocks
 / sdev->
¶ªes
 - 
	`shªnÚ_©omic_»ad
(&sdev->
”a£_dÚe
)) / (sdev->sb_count - sdev->mbr_eblocks / sdev->planes);

1799 
SHN_PROGRESS_REFRESH_MBR
:

1800 
´og»ss_b¬
.
³rûÁ
 = 100 * (
	`shªnÚ_©omic_»ad
(&
sdev
->
»äesh_mbr_dÚe
è% sdev->
lun_couÁ
) / sdev->lun_count;

1802 
SHN_PROGRESS_NORFLASH_ERASE
:

1803 
SHN_PROGRESS_NORFLASH_WRITE
:

1804 
SHN_PROGRESS_NORFLASH_READ
:

1805 
´og»ss_b¬
.
³rûÁ
 = 
sdev
->
nÜæash
.
´og»ss
;

1811 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_´og»ss_b¬
 * 
__u£r
)
¬g
, &
´og»ss_b¬
, (shannon_progress_bar))) {

1812 
	`shªnÚ_”r
("could‚ot copy…rogress_baro userspace.\n");

1813  -
ENOTTY
;

1816 
SHANNON_IOCWNORERASE
:

1817 
SHANNON_IOCWNORWRITE
:

1818 
SHANNON_IOCRNORREAD
:

1819 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1820 
»t
 = 
	`shªnÚ_ioùl_nÜæash_İs
(
sdev
, 
cmd
, 
¬g
);

1821 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1822  
»t
;

1823 
SHANNON_IOCCRELOAD
:

1824 ià(
	`shªnÚ_dev_is_g5_ff§
(
sdev
)) {

1825 
	`shªnÚ_”r
("FFSA controller‚ot support„eload.\n");

1828 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1829 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1830 
code
 = 
	`shªnÚ_iÜ—d32
((
u32
 *)
sdev
->
b¬
 + 0x33);

1831 
code
 |= 1 << 31;

1832 
	`shªnÚ_iowr™e32
(
code
, (
u32
 *)
sdev
->
b¬
 + 0x33);

1833 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1834 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1836 
SHANNON_IOCRDREG
:

1837 
SHANNON_IOCWRREG
:

1838 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1839 
»t
 = 
	`»gi¡”_İ
(
sdev
, 
cmd
, 
¬g
);

1840 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1842 ià(
»t
)

1843  -
ENOTTY
;

1845 
SHANNON_IOCQATOMIC_SIZE
:

1846 ià(
sdev
->
©omic_wr™e
)

1847  
sdev
->
logicb_size
 * sdev->
logicbs_š_chunk
;

1849  
sdev
->
logicb_size
;

1850 
SHANNON_IOCNORINFO
:

1851 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¡©e_£m
);

1852 
	`»ad_nÜæash_šfo
(
sdev
);

1853 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¡©e_£m
);

1855 
SHANNON_IOCWBADLUN
:

1856 
¬gum’t
 = ()
¬g
;

1857 ià(
¬gum’t
 < 0 ||‡rgum’ˆ>ğ
sdev
->
lun_couÁ
) {

1858 
	`shªnÚ_”r
("Invalid†un‚umber.\n");

1859  -
ENOTTY
;

1861 
	`m¬k_sb_”r_fÜ_bad_lun
(
sdev
, sdev->
lun
[
¬gum’t
]);

1863 
SHANNON_IOCWBADBLK
:

1864 ià(
	`shªnÚ_cİy_äom_u£r
(&
eblk
, (
u32
 * 
__u£r
)
¬g
,

1865 (
eblk
))) {

1866 
	`shªnÚ_”r
("could‚ot copyƒblock‚umber from userspace.\n");

1867  -
ENOTTY
;

1869 ià(
eblk
.
lun_num
 >ğ
sdev
->
lun_couÁ
) {

1870 
	`shªnÚ_”r
("Invalid†un‚umber.\n");

1871  -
ENOTTY
;

1873 ià(
eblk
.
eblk_num
 < 
sdev
->
mbr_eblocks
 ||ƒblk.eblk_num >ğsdev->
eblocks_š_lun
) {

1874 
	`shªnÚ_”r
("Invalidƒblock‚umber.\n");

1875  -
ENOTTY
;

1877 
sb
 = 
sdev
->
sbs
 + 
eblk
.
eblk_num
 / sdev->
¶ªes
;

1878 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
eblk
.
lun_num
,ƒblk.
eblk_num
 % sdev->
¶ªes
);

1879 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
) == 0) {

1880 ià(
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
 / sdev->
¶ªes
)

1881 
	`shªnÚ_©omic_šc
(&
sdev
->
³ndšg_”r_blks
);

1885 
	`shªnÚ_”r
("unsuµÜ‹d ioùÈcmd=0x%08x., 0x%08x\n", 
cmd
, 
SHANNON_IOCRECC_LARGE
);

1886  -
ENOTTY
;

1889 
	`debugs4
("leave ioctl.\n");

1891 
	}
}

	@shannon_ioctl.h

10 #iâdeà
__SHANNON_IOCTL_H


11 
	#__SHANNON_IOCTL_H


	)

13 
	~"shªnÚ_mbr.h
"

15 
	#ECC_CORRECTION_BITS_IN_SECTOR
 120

	)

17 
	sshªnÚ_ecc_¡©
 {

18 
__u64
 
	mecc_¡©i¡ics
[
ECC_CORRECTION_BITS_IN_SECTOR
 + 1];

21 
	sshªnÚ_disk_¡©us
 {

22 
__u32
 
	m¡©e
;

23 
__u32
 
	macûss_mode
;

24 
__u64
 
	m»adÚly_»asÚ
;

25 
__u64
 
	m»duûd_wr™e_»asÚ
;

28 
	sshªnÚ_v”siÚ_šfo
 {

29 
__u32
 
	mfœmw¬e_v”siÚ
;

30 
__u32
 
	mdriv”_v”siÚ
;

31 
__u64
 
	m£rŸl_numb”
;

32 
__u32
 
	mdriv”_fix_v”siÚ
;

33 
__u32
 
	mfœmw¬e_g
;

39 
	#SHANNON_SMART_SIZE
 528

	)

41 
	sshªnÚ_sm¬t
 {

42 
__u64
 
	mpow”_Ú_£cÚds
;

43 
__u64
 
	mpow”_cyşe_couÁ
;

44 
__u64
 
	mÿ·c™y
;

45 
__u64
 
	mphysiÿl_ÿ·c™y
;

47 
__u32
 
	mov”´ovisiÚ
;

48 
__u32
 
	mä“_blkút
;

50 
__u32
 
	mmax_”a£_couÁ
;

51 
__u32
 
	mmš_”a£_couÁ
;

53 
__u32
 
	mav”age_”a£_couÁ
;

54 
__u32
 
	mtÙ®_”a£_couÁ
;

56 
__u32
 
	mv¬Ÿnû_of_”a£_couÁ
;

57 
__u32
 
	me¡im©ed_liã_Ëá
;

59 
__u32
 
	m¡©ic_bad_blkút
;

60 
__u32
 
	mdyÇmic_bad_blkút
;

62 
__u64
 
	mho¡_wr™e_£ùÜs
;

63 
__u64
 
	mho¡_wr™e_ios
;

64 
__u64
 
	mho¡_wr™e_m£cs
;

65 
__u64
 
	mtÙ®_wr™e_£ùÜs
;

66 
__u64
 
	mho¡_»ad_£ùÜs
;

67 
__u64
 
	mho¡_»ad_ios
;

68 
__u64
 
	mho¡_»ad_m£cs
;

70 
__u32
 
	mecc_çu»_times
;

71 
__u32
 
	m‹m³¿tu»_št
;

73 
__u32
 
	m‹m³¿tu»_æash
;

74 
__u32
 
	m‹m³¿tu»_bßrd
;

76 
__u32
 
	mvŞge_št
;

77 
__u32
 
	mvŞge_št_max
;

79 
__u32
 
	mvŞge_aux
;

80 
__u32
 
	mvŞge_aux_max
;

82 
__u64
 
	m£qu’û_numb”
;

84 
__u32
 
	m‹m³¿tu»_št_max
;

85 
__u32
 
	m‹m³¿tu»_æash_max
;

87 
__u32
 
	m‹m³¿tu»_bßrd_max
;

88 
__u32
 
	m£u_üc_”rÜ
;

90 
__u32
 
	m£u_üc_”rÜ_hi¡Üy
;

91 
__u32
 
	m£u_ecc_”rÜ
;

93 
__u32
 
	m£u_ecc_”rÜ_hi¡Üy
;

94 
__u32
 
	mecc_cÜ»ùiÚ_pow”
;

96 
__u32
 
	mecc_codewÜd_size
;

97 
__u32
 
	m·d1
;

99 
__u64
 
	mbufãr_wr™e_couÁ”
;

100 
__u64
 
	mdœeù_wr™e_couÁ”
;

102 
__u32
 
	mhas_£rviû_g
;

103 
__u8
 
	m£rviû_g
[32];

104 
__u8
 
	mmod–_id
[40];

105 
__u16
 
	mÊk¡a
;

106 
__u16
 
	m·d2
;

108 
__u32
 
	mÊkÿp
;

109 
__u32
 
	m·d3
;

111 
__u64
 
	mæashid
;

113 
__u16
 
	mh®_v”siÚ
;

114 
__u8
 
	mudid
[36];

115 
__u8
 
	m·d4
[2];

117 
__u32
 
	mhw_cfg_chªÃls
;

118 
__u32
 
	mhw_cfg_lun£t_š_chªÃl
;

120 
__u32
 
	mhw_cfg_lun_š_lun£t
;

121 
__u16
 
	mdeviû_id
;

122 
__u16
 
	msubsy¡em_deviû_id
;

124 
__u16
 
	msubsy¡em_v’dÜ_id
;

125 
__u8
 
	mpci_bus_numb”
;

126 
__u8
 
	mpci_¦Ù_numb”
;

127 
__u8
 
	mpci_func_numb”
;

128 
__u8
 
	m·d5
[3];

130 
__u32
 
	mho¡_wr™e_bªdwidth
;

131 
__u32
 
	mho¡_wr™e_iİs
;

133 
__u32
 
	mho¡_wr™e_Ï‹ncy
;

134 
__u32
 
	mtÙ®_wr™e_bªdwidth
;

136 
__u32
 
	mho¡_»ad_bªdwidth
;

137 
__u32
 
	mho¡_»ad_iİs
;

139 
__u32
 
	mho¡_»ad_Ï‹ncy
;

140 
__u32
 
	mbufãr_wr™e_³rûÁ
;

142 
__u32
 
	mwr™e_am¶if›r
;

143 
__u32
 
	mwr™e_am¶if›r_liãtime
;

145 
__u32
 
	måga_»cÚfig_sup
;

146 
__u32
 
	måga_»cÚfig_times
;

148 
__u16
 
	mscsi_mode
;

149 
__u16
 
	mscsi_ho¡_no
;

151 
__u8
 
	mfÜû_rw
;

152 
__u8
 
	m·d6
;

153 
__u16
 
	mdummy_couÁ
;

154 
__u64
 
	m¿ndom_num
;

155 
__u32
 
	mgc_sbs
;

156 
__u32
 
	m”r_»cov”ed_sbs
;

157 
__u32
 
	mwl_sbs
;

158 
__u32
 
	md©a_»‹ÁiÚ_sbs
;

159 
__u32
 
	m»ad_di¡urb_sbs
;

160 
__u32
 
	m”a£_b®ªû_sbs
;

161 
__u32
 
	mecc_çu»_sbs
;

162 
__u8
 
	m»£rved
[50];

165 
	sshªnÚ_dev_¡©us
 {

166 
__u64
 
	mÿ·b™›s
[2];

168 
__u16
 
	mh®_v”siÚ
;

169 
__u16
 
	mscsi_mode
;

170 
__u8
 
	mudid
[36];

172 
__u16
 
	mdeviû_id
;

173 
__u16
 
	msubsy¡em_deviû_id
;

174 
__u32
 
	mov”´ovisiÚ
;

176 
__u32
 
	mä“_blkút
;

177 
__u32
 
	me¡im©ed_liã_Ëá
;

179 
__u32
 
	m¡©ic_bad_blkút
;

180 
__u32
 
	mdyÇmic_bad_blkút
;

182 
__u32
 
	m‹m³¿tu»_št
;

183 
__u32
 
	m‹m³¿tu»_št_max
;

185 
__u32
 
	m‹m³¿tu»_bßrd
;

186 
__u32
 
	m‹m³¿tu»_bßrd_max
;

188 
__u32
 
	m‹m³¿tu»_æash
;

189 
__u32
 
	m‹m³¿tu»_æash_max
;

191 
__u32
 
	mvŞge_št
;

192 
__u32
 
	mvŞge_št_max
;

194 
__u32
 
	mvŞge_aux
;

195 
__u32
 
	mvŞge_aux_max
;

197 
__u32
 
	m£u_üc_”rÜ
;

198 
__u32
 
	m£u_üc_”rÜ_hi¡Üy
;

200 
__u32
 
	m£u_ecc_”rÜ
;

201 
__u32
 
	m£u_ecc_”rÜ_hi¡Üy
;

203 
__u32
 
	mecc_çu»_times
;

204 
__u32
 
	mhw_cfg_chªÃls
;

205 
__u32
 
	mhw_cfg_lun£t_š_chªÃl
;

206 
__u32
 
	mhw_cfg_lun_š_lun£t
;

208 
__u8
 
	mpci_bus_numb”
;

209 
__u8
 
	mpci_¦Ù_numb”
;

210 
__u8
 
	mpci_func_numb”
;

211 
__u8
 
	mfÜû_rw
;

212 
__u16
 
	mscsi_ho¡_no
;

213 
__u16
 
	mÊk¡a
;

215 
__u8
 
	m£rviû_g
[32];

216 
__u8
 
	mmod–_id
[40];

218 
__u64
 
	mæashid
;

219 
__u64
 
	mho¡_wr™e_£ùÜs
;

220 
__u64
 
	mtÙ®_wr™e_£ùÜs
;

221 
__u64
 
	mho¡_»ad_£ùÜs
;

222 
__u64
 
	mpow”_Ú_£cÚds
;

223 
__u64
 
	mpow”_cyşe_couÁ
;

224 
__u64
 
	mÿ·c™y
;

225 
__u64
 
	mphysiÿl_ÿ·c™y
;

227 
__u32
 
	mho¡_wr™e_bªdwidth
;

228 
__u32
 
	mho¡_wr™e_iİs
;

230 
__u32
 
	mho¡_wr™e_Ï‹ncy
;

231 
__u32
 
	mtÙ®_wr™e_bªdwidth
;

233 
__u32
 
	mho¡_»ad_bªdwidth
;

234 
__u32
 
	mho¡_»ad_iİs
;

236 
__u32
 
	mho¡_»ad_Ï‹ncy
;

237 
__u32
 
	mbufãr_wr™e_³rûÁ
;

239 
__u32
 
	mwr™e_am¶if›r
;

240 
__u32
 
	mwr™e_am¶if›r_liãtime
;

242 
__u32
 
	måga_»cÚfig_sup
;

243 
__u32
 
	måga_»cÚfig_times
;

245 
__u32
 
	mecc_codewÜd_size
;

246 
__u32
 
	mecc_cÜ»ùiÚ_pow”
;

248 
__u64
 
	mtÙ®_gc_£ùÜs
;

249 
__u64
 
	mtÙ®_wl_£ùÜs
;

250 
__u64
 
	mtÙ®_”r_»cov”_£ùÜs
;

252 
__u32
 
	mgc_bªdwidth
;

253 
__u32
 
	mwl_bªdwidth
;

254 
__u32
 
	m”r_»cov”_bªdwidth
;

256 
__u8
 
	m»£rved
[636];

259 
	sshªnÚ_´og»ss_b¬
 {

260 
__u32
 
	mv®id
;

261 
__u32
 
	m³rûÁ
;

264 
	sshªnÚ_ü—‹_poŞ_¬g
 {

265 
__u8
 
	mpoŞ_id
;

266 
__u8
 
	mcouÁ
;

267 
__u8
 
	mdev_id
[30];

268 
__u64
 
	mÿ·c™y
;

269 
__u8
 
	m»£rved
[80];

272 
	sshªnÚ_ns_d©a
 {

273 
__u64
 
	mv”siÚ
;

274 
	mÇme
[256];

275 
	m»£rved
[3832];

277 
	#NS_PATH_LENGTH
 ((((
shªnÚ_ns_d©a
 *)0)->
·th
))

	)

279 
	#SUPPORT_SET_MAX_IOPS_BIT
 (0)

	)

280 
	#SUPPORT_SET_PRIORITY_BIT
 (1)

	)

281 
	#SUPPORT_SET_SECTORS_BIT
 (2)

	)

282 
	#SUPPORT_SET_MAX_IOPS_MASK
 (1 << 
SUPPORT_SET_MAX_IOPS_BIT
)

	)

283 
	#SUPPORT_SET_PRIORITY_MASK
 (1 << 
SUPPORT_SET_PRIORITY_BIT
)

	)

284 
	#SUPPORT_SET_SECTORS_MASK
 (1 << 
SUPPORT_SET_SECTORS_BIT
)

	)

285 
	#SET_MAX_IOPS_MASK
 
SUPPORT_SET_MAX_IOPS_MASK


	)

286 
	#SET_PRIORITY_MASK
 
SUPPORT_SET_PRIORITY_MASK


	)

287 
	#SET_SECTORS_MASK
 
SUPPORT_SET_SECTORS_MASK


	)

288 
	sshªnÚ_ns_¬g
 {

289 
	m£‰šg
;

290 
	mpoŞ_id
;

291 
	mvŞ_idx
;

292 
	mmax_iİs
;

293 
	m´iÜ™y
;

294 
	m£q_num
;

295 
__u64
 
	m£ùÜs
;

297 
	mblock_shiá
;

298 
	m¡re_size
;

300 
shªnÚ_ns_d©a
 *
	md©a
;

301 
__u64
 
	mnÚe
;

303 
	m·d
[4];

306 
	#MAX_DEVICE_NO
 26

	)

307 
	sshªnÚ_poŞ_¡©us
 {

308 
	mid
;

309 
	m¡©e
;

310 
	msdev_couÁ
;

311 
	mÚlše_sdev_couÁ
;

312 
__u8
 
	msdev_id
[
MAX_DEVICE_NO
];

313 
	mns_couÁ
;

314 
	m·d
;

315 
__u64
 
	mns_b™m­
[16];

316 
u64
 
	mÿ·c™y
;

317 
u64
 
	mphysiÿl_£ùÜs
;

318 
__u64
 
	mu£d_£ùÜs
;

319 
__u32
 
	mov”´ovisiÚ
;

320 
__u32
 
	macûss_mode
;

321 
__u32
 
	m»adÚly_»asÚ
;

322 
	m»£rved
[36];

325 
	sshªnÚ_ns_¡©us
 {

326 
	midx
;

327 
	mpoŞ_id
;

328 
	mmax_iİs
;

329 
	m´iÜ™y
;

330 
__u64
 
	m£ùÜs
;

331 
	m£q_num
;

332 
	mblock_shiá
;

333 
	m¡r_size
;

334 
__u32
 
	m¡©e
;

335 
u64
 
	mv®id_£ùÜs
;

336 
__u32
 
	mho¡_»ad_Ï‹ncy
;

337 
__u32
 
	mho¡_»ad_bªdwidth
;

338 
__u32
 
	mho¡_»ad_iİs
;

340 
__u32
 
	mho¡_wr™e_Ï‹ncy
;

341 
__u32
 
	mho¡_wr™e_bªdwidth
;

342 
__u32
 
	mho¡_wr™e_iİs
;

344 
shªnÚ_ns_d©a
 *
	md©a
;

345 
__u64
 
	mnÚe
;

347 
	m»£rved
[48];

350 
	#SHN_PROGRESS_INVALID
 0

	)

351 
	#SHN_PROGRESS_VALID
 1

	)

352 
	#SHN_PROGRESS_DONE
 2

	)

353 
	#SHN_PROGRESS_NORFLASH_ERASE
 3

	)

354 
	#SHN_PROGRESS_NORFLASH_WRITE
 4

	)

355 
	#SHN_PROGRESS_NORFLASH_READ
 5

	)

356 
	#SHN_PROGRESS_REFRESH_MBR
 6

	)

358 
	sshªnÚ_nÜæash_İs
 {

359 *
	md©a
;

360 
__u32
 
	moff£t
;

361 
__u32
 
	mËngth
;

362 
__u32
 
	mcmd
;

365 
	#SHN_NORFLASH_CMD_ERASE
 1

	)

366 
	#SHN_NORFLASH_CMD_WRITE
 2

	)

367 
	#SHN_NORFLASH_CMD_READ
 3

	)

370 
	#SHN_SET_FEATURE
 1

	)

371 
	#SHN_UNSET_FEATURE
 2

	)

373 
	sshªnÚ_fÜm©_¬g
 {

374 
__u64
 
	mÿ·c™y
;

375 
__u32
 
	mu£r_logicb_shiá
;

376 
__u32
 
	mş—r_hi¡Üy
;

377 
__u32
 
	mfÜû_fÜm©
;

378 
__u32
 
	m©omic_wr™e
;

379 
__u32
 
	m´iÜ™ize_wr™e
;

383 
	#ATOMIC_WRITE_SHIFT
 0

	)

384 
	#PRIO_WRITE_SHIFT
 1

	)

385 
	#FORCE_FORMAT_SHIFT
 2

	)

386 
	#CLEAR_HISTORY_SHIFT
 3

	)

387 
	#CLEAR_ERASE_COUNT_SHIFT
 4

	)

388 
	#SET_WRITE_BW_SHIFT
 5

	)

389 
	#OVERLAP_WRITE_SHIFT
 6

	)

390 
	#KEEP_MBR_PARAS_SHIFT
 63

	)

392 
	sshªnÚ_fÜm©_¬g2
 {

393 
__u64
 
	mæags
;

394 
__u64
 
	mÿ·c™y
;

395 
__u32
 
	mu£r_logicb_shiá
;

396 
__u32
 
	m”a£_couÁ
;

397 
__u16
 
	mmax_wr™e_bw
;

398 
__u8
 
	mlim™_bw_wh’_diskfuÎ
;

399 
__u8
 
	m·d
[5];

400 
__u64
 
	m»£rved
[12];

403 
	sshªnÚ_»g
 {

404 
__u32
 
	m»g
;

405 
__u32
 *
	mbuf
;

406 
__u32
 
	mËn
;

409 
	sshªnÚ_m¬k_¬g
 {

410 
__u32
 
	mlun_num
;

411 
__u32
 
	meblk_num
;

416 
	#SUPPORT_NEW_FORMAT_BIT
 0

	)

417 
	#SUPPORT_MARK_BAD_LUN_BIT
 1

	)

418 
	#SUPPORT_MARK_BAD_EBLK_BIT
 2

	)

419 
	#SUPPORT_CLEAR_ERASE_COUNT_BIT
 3

	)

420 
	#SUPPORT_NEW_DEV_STATUS_BIT
 4

	)

421 
	#SUPPORT_LARGE_ECC_POWER_BIT
 5

	)

422 
	#SUPPORT_UPDATE_MICROCODE_BIT
 6

	)

424 
	#SUPPORT_NEW_FORMAT
 (1 << 
SUPPORT_NEW_FORMAT_BIT
)

	)

425 
	#SUPPORT_MARK_BAD_LUN
 (1 << 
SUPPORT_MARK_BAD_LUN_BIT
)

	)

426 
	#SUPPORT_MARK_BAD_EBLK
 (1 << 
SUPPORT_MARK_BAD_EBLK_BIT
)

	)

427 
	#SUPPORT_CLEAR_ERASE_COUNT
 (1 << 
SUPPORT_CLEAR_ERASE_COUNT_BIT
)

	)

428 
	#SUPPORT_NEW_DEV_STATUS
 (1 << 
SUPPORT_NEW_DEV_STATUS_BIT
)

	)

429 
	#SUPPORT_LARGE_ECC_POWER
 (1 << 
SUPPORT_LARGE_ECC_POWER_BIT
)

	)

430 
	#SUPPORT_UPDATE_MICROCODE
 (1 << 
SUPPORT_UPDATE_MICROCODE_BIT
)

	)

436 
	#SHN_STATE_ATTACHED
 0

	)

437 
	#SHN_STATE_DETACHED
 1

	)

438 
	#SHN_STATE_RECONFIG
 8

	)

439 
	#SHN_STATE_RESET
 16

	)

440 
	#SHN_STATE_ERROR_BIT
 0x8000

	)

441 
	#SHN_STATE_MASK
 0x7FFF

	)

443 
	#SHN_MODE_READWRITE
 0

	)

444 
	#SHN_MODE_REDUCED_WRITE
 1

	)

445 
	#SHN_MODE_READONLY
 2

	)

447 
	#SHN_REASON_USER_REQUESTED
 0

	)

448 
	#SHN_REASON_LOW_OVERPROVISION
 1

	)

449 
	#SHN_REASON_HIGH_TEMPERATURE
 2

	)

450 
	#SHN_REASON_EPILOG_FAILURE
 3

	)

451 
	#SHN_REASON_MANY_BAD_BLOCKS
 4

	)

452 
	#SHN_REASON_SEU_ERROR
 5

	)

453 
	#SHN_REASON_SENTINEL
 6

	)

454 
	#SHN_REASON_ALLOC_FAILED
 7

	)

455 
	#SHN_REASON_BBT_NO_SPACE
 8

	)

458 
	#SHANNON_IOCMAGIC
 'x'

	)

460 
	#SHANNON_IOCRMBR
 
	`_IOR
(
SHANNON_IOCMAGIC
, 1, 
shªnÚ_mbr
)

	)

463 
	#SHANNON_IOCSATTACH
 
	`_IOW
(
SHANNON_IOCMAGIC
, 4, )

	)

470 
	#SHANNON_IOCCDETACH
 
	`_IO
(
SHANNON_IOCMAGIC
, 5)

	)

473 
	#SHANNON_IOCRSTATUS
 
	`_IOR
(
SHANNON_IOCMAGIC
, 6, 
shªnÚ_disk_¡©us
)

	)

475 
	#SHANNON_IOCCEJECT
 
	`_IO
(
SHANNON_IOCMAGIC
, 8)

	)

494 
	#SHANNON_IOCSFORMAT
 
	`_IOW
(
SHANNON_IOCMAGIC
, 8, 
shªnÚ_fÜm©_¬g
)

	)

497 
	#SHANNON_IOCRSMART
 
	`_IOWR
(
SHANNON_IOCMAGIC
, 9, 
shªnÚ_sm¬t
)

	)

504 
	#SHANNON_IOCWLED
 
	`_IOW
(
SHANNON_IOCMAGIC
, 10, )

	)

507 
	#SHANNON_IOCRECC
 
	`_IOR
(
SHANNON_IOCMAGIC
, 11, 
shªnÚ_ecc_¡©
)

	)

510 
	#SHANNON_IOCRVERINFO
 
	`_IOR
(
SHANNON_IOCMAGIC
, 12, 
shªnÚ_v”siÚ_šfo
)

	)

513 
	#SHANNON_IOCRPROGRESS
 
	`_IOR
(
SHANNON_IOCMAGIC
, 13, 
shªnÚ_´og»ss_b¬
)

	)

519 
	#SHANNON_IOCWNORERASE
 
	`_IOW
(
SHANNON_IOCMAGIC
, 14, 
shªnÚ_nÜæash_İs
)

	)

520 
	#SHANNON_IOCWNORWRITE
 
	`_IOW
(
SHANNON_IOCMAGIC
, 15, 
shªnÚ_nÜæash_İs
)

	)

521 
	#SHANNON_IOCRNORREAD
 
	`_IOWR
(
SHANNON_IOCMAGIC
, 16, 
shªnÚ_nÜæash_İs
)

	)

526 
	#SHANNON_IOCCRELOAD
 
	`_IO
(
SHANNON_IOCMAGIC
, 18)

	)

531 
	#SHANNON_IOCRDREG
 
	`_IOR
(
SHANNON_IOCMAGIC
, 19, 
shªnÚ_»g
)

	)

532 
	#SHANNON_IOCWRREG
 
	`_IOR
(
SHANNON_IOCMAGIC
, 20, 
shªnÚ_»g
)

	)

534 
	#SHANNON_IOCQATOMIC_SIZE
 
	`_IO
(
SHANNON_IOCMAGIC
, 22)

	)

536 
	#SHANNON_IOCCRECONFIG
 
	`_IO
(
SHANNON_IOCMAGIC
, 23)

	)

537 
	#SHANNON_IOCCRESET
 
	`_IO
(
SHANNON_IOCMAGIC
, 24)

	)

539 
	#SHANNON_IOCNORINFO
 
	`_IO
(
SHANNON_IOCMAGIC
, 25)

	)

541 
	#SHANNON_IOCWBADLUN
 
	`_IOW
(
SHANNON_IOCMAGIC
, 26, )

	)

542 
	#SHANNON_IOCWBADBLK
 
	`_IOW
(
SHANNON_IOCMAGIC
, 27, 
shªnÚ_m¬k_¬g
)

	)

544 
	#SHANNON_IOC_GET_CAP
 
	`_IOR
(
SHANNON_IOCMAGIC
, 30, 
__u64
 *)

	)

546 
	#SHANNON_IOC_FORMAT
 
	`_IOW
(
SHANNON_IOCMAGIC
, 31, 
shªnÚ_fÜm©_¬g2
)

	)

548 
	#SHANNON_IOCRDEVSTATUS
 
	`_IOR
(
SHANNON_IOCMAGIC
, 32, 
shªnÚ_dev_¡©us
)

	)

553 
	#SHANNON_IOCCREATEPOOL
 
	`_IOWR
(
SHANNON_IOCMAGIC
, 33, 
shªnÚ_ü—‹_poŞ_¬g
)

	)

554 
	#SHANNON_IOCDELPOOL
 
	`_IO
(
SHANNON_IOCMAGIC
, 34)

	)

559 
	#SHANNON_IOCADDNS
 
	`_IOWR
(
SHANNON_IOCMAGIC
, 35, 
shªnÚ_ns_¬g
)

	)

560 
	#SHANNON_IOCDELNS
 
	`_IOW
(
SHANNON_IOCMAGIC
, 36, 
shªnÚ_ns_¬g
)

	)

561 
	#SHANNON_IOCATTACHNS
 
	`_IOW
(
SHANNON_IOCMAGIC
, 37, 
shªnÚ_ns_¬g
)

	)

562 
	#SHANNON_IOCDETACHNS
 
	`_IOW
(
SHANNON_IOCMAGIC
, 38, 
shªnÚ_ns_¬g
)

	)

563 
	#SHANNON_IOCGETPOOL
 
	`_IOWR
(
SHANNON_IOCMAGIC
, 39, 
shªnÚ_poŞ_¡©us
)

	)

564 
	#SHANNON_IOCGETNS
 
	`_IOWR
(
SHANNON_IOCMAGIC
, 40, 
shªnÚ_ns_¡©us
)

	)

565 
	#SHANNON_IOCGETPOOLCAP
 
	`_IOR
(
SHANNON_IOCMAGIC
, 41, )

	)

566 
	#SHANNON_IOCSETNS
 
	`_IOW
(
SHANNON_IOCMAGIC
, 42, 
shªnÚ_ns_¬g
)

	)

568 
	#SHANNON_IOCRECC_LARGE
 
	`_IOR
(
SHANNON_IOCMAGIC
, 43, 
shªnÚ_ecc_¡©
)

	)

570 
	#SHANNON_IOCMAXNR
 44

	)

	@shannon_kcore.c

1 
	~"shªnÚ_kcÜe.h
"

2 
	~<lšux/¥šlock.h
>

3 
	~<lšux/moduË.h
>

4 
	~<lšux/mu‹x.h
>

5 
	~<lšux/b™İs.h
>

6 
	~<lšux/b™m­.h
>

7 
	~<lšux/io.h
>

8 
	~<lšux/mm.h
>

9 
	~<asm/uacûss.h
>

10 
	~<lšux/¦ab.h
>

11 
	~<lšux/mempoŞ.h
>

12 
	~<lšux/v”siÚ.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/vm®loc.h
>

15 
	~<lšux/”r.h
>

16 
	~<lšux/¡ršg.h
>

17 
	~<lšux/¿ndom.h
>

18 
	~<lšux/´eãtch.h
>

21 #iâdeà
CONFIG_PROVE_LOCKING


23 
	$shªnÚ_¥š_lock_š™
(
shªnÚ_¥šlock_t
 *
lock
)

25 
	`¥š_lock_š™
((
¥šlock_t
 *)
lock
);

26 
	}
}

28 
	$shªnÚ_¥š_lock
(
shªnÚ_¥šlock_t
 *
lock
)

30 
	`¥š_lock
((
¥šlock_t
 *)
lock
);

31 
	}
}

33 
	$shªnÚ_¥š_lock_bh
(
shªnÚ_¥šlock_t
 *
lock
)

35 
	`¥š_lock_bh
((
¥šlock_t
 *)
lock
);

36 
	}
}

38 
	$shªnÚ_¥š_lock_œq
(
shªnÚ_¥šlock_t
 *
lock
)

40 
	`¥š_lock_œq
((
¥šlock_t
 *)
lock
);

41 
	}
}

43 
	$shªnÚ_¥š_lock_œq§ve
(
shªnÚ_¥šlock_t
 *
lock
)

45 
æags
;

46 
	`¥š_lock_œq§ve
((
¥šlock_t
 *)
lock
, 
æags
);

47  
æags
;

48 
	}
}

50 
	$shªnÚ_¥š_uÆock
(
shªnÚ_¥šlock_t
 *
lock
)

52 
	`¥š_uÆock
((
¥šlock_t
 *)
lock
);

53 
	}
}

55 
	$shªnÚ_¥š_uÆock_bh
(
shªnÚ_¥šlock_t
 *
lock
)

57 
	`¥š_uÆock_bh
((
¥šlock_t
 *)
lock
);

58 
	}
}

60 
	$shªnÚ_¥š_uÆock_œq
(
shªnÚ_¥šlock_t
 *
lock
)

62 
	`¥š_uÆock_œq
((
¥šlock_t
 *)
lock
);

63 
	}
}

65 
	$shªnÚ_¥š_uÆock_œq»¡Üe
(
shªnÚ_¥šlock_t
 *
lock
, 
æags
)

67 
	`¥š_uÆock_œq»¡Üe
((
¥šlock_t
 *)
lock
, 
æags
);

68 
	}
}

70 
	$shªnÚ_¥š_Œylock
(
shªnÚ_¥šlock_t
 *
lock
)

72  
	`¥š_Œylock
((
¥šlock_t
 *)
lock
);

73 
	}
}

75 
	$shªnÚ_¥š_Œylock_œq
(
shªnÚ_¥šlock_t
 *
lock
)

77  
	`¥š_Œylock_œq
((
¥šlock_t
 *)
lock
);

78 
	}
}

80 
	$shªnÚ_rwlock_š™
(
shªnÚ_rwlock_t
 *
lock
)

82 
	`rwlock_š™
((
rwlock_t
 *)
lock
);

83 
	}
}

85 
	$shªnÚ_»ad_lock
(
shªnÚ_rwlock_t
 *
lock
)

87 
	`»ad_lock
((
rwlock_t
 *)
lock
);

88 
	}
}

90 
	$shªnÚ_»ad_lock_bh
(
shªnÚ_rwlock_t
 *
lock
)

92 
	`»ad_lock_bh
((
rwlock_t
 *)
lock
);

93 
	}
}

95 
	$shªnÚ_»ad_lock_œq
(
shªnÚ_rwlock_t
 *
lock
)

97 
	`»ad_lock_œq
((
rwlock_t
 *)
lock
);

98 
	}
}

100 
	$shªnÚ_»ad_lock_œq§ve
(
shªnÚ_rwlock_t
 *
lock
)

102 
æags
;

103 
	`»ad_lock_œq§ve
((
rwlock_t
 *)
lock
, 
æags
);

104  
æags
;

105 
	}
}

107 
	$shªnÚ_»ad_uÆock
(
shªnÚ_rwlock_t
 *
lock
)

109 
	`»ad_uÆock
((
rwlock_t
 *)
lock
);

110 
	}
}

112 
	$shªnÚ_»ad_uÆock_bh
(
shªnÚ_rwlock_t
 *
lock
)

114 
	`»ad_uÆock_bh
((
rwlock_t
 *)
lock
);

115 
	}
}

117 
	$shªnÚ_»ad_uÆock_œq
(
shªnÚ_rwlock_t
 *
lock
)

119 
	`»ad_uÆock_œq
((
rwlock_t
 *)
lock
);

120 
	}
}

122 
	$shªnÚ_»ad_uÆock_œq»¡Üe
(
shªnÚ_rwlock_t
 *
lock
, 
æags
)

124 
	`»ad_uÆock_œq»¡Üe
((
rwlock_t
 *)
lock
, 
æags
);

125 
	}
}

127 
	$shªnÚ_»ad_Œylock
(
shªnÚ_rwlock_t
 *
lock
)

129  
	`»ad_Œylock
((
rwlock_t
 *)
lock
);

130 
	}
}

132 
	$shªnÚ_wr™e_lock
(
shªnÚ_rwlock_t
 *
lock
)

134 
	`wr™e_lock
((
rwlock_t
 *)
lock
);

135 
	}
}

137 
	$shªnÚ_wr™e_lock_bh
(
shªnÚ_rwlock_t
 *
lock
)

139 
	`wr™e_lock_bh
((
rwlock_t
 *)
lock
);

140 
	}
}

142 
	$shªnÚ_wr™e_lock_œq
(
shªnÚ_rwlock_t
 *
lock
)

144 
	`wr™e_lock_œq
((
rwlock_t
 *)
lock
);

145 
	}
}

147 
	$shªnÚ_wr™e_lock_œq§ve
(
shªnÚ_rwlock_t
 *
lock
)

149 
æags
;

150 
	`wr™e_lock_œq§ve
((
rwlock_t
 *)
lock
, 
æags
);

151  
æags
;

152 
	}
}

154 
	$shªnÚ_wr™e_uÆock
(
shªnÚ_rwlock_t
 *
lock
)

156 
	`wr™e_uÆock
((
rwlock_t
 *)
lock
);

157 
	}
}

159 
	$shªnÚ_wr™e_uÆock_bh
(
shªnÚ_rwlock_t
 *
lock
)

161 
	`wr™e_uÆock_bh
((
rwlock_t
 *)
lock
);

162 
	}
}

164 
	$shªnÚ_wr™e_uÆock_œq
(
shªnÚ_rwlock_t
 *
lock
)

166 
	`wr™e_uÆock_œq
((
rwlock_t
 *)
lock
);

167 
	}
}

169 
	$shªnÚ_wr™e_uÆock_œq»¡Üe
(
shªnÚ_rwlock_t
 *
lock
, 
æags
)

171 
	`wr™e_uÆock_œq»¡Üe
((
rwlock_t
 *)
lock
, 
æags
);

172 
	}
}

174 
	$shªnÚ_wr™e_Œylock
(
shªnÚ_rwlock_t
 *
lock
)

176  
	`wr™e_Œylock
((
rwlock_t
 *)
lock
);

177 
	}
}

182 #ià
defšed
(
__LITTLE_ENDIAN
)

183 
	#BITOP_LE_MAGIC
 0

	)

184 #–ià
defšed
(
__BIG_ENDIAN
)

185 
	#BITOP_LE_MAGIC
 ((64-1è& ~0x7)

	)

189 #iâdeà
CONFIG_PROVE_LOCKING


190 
	$shªnÚ_mu‹x_š™
(
shªnÚ_mu‹x_t
 *
lock
)

192 
	`mu‹x_š™
((
mu‹x
 *)
lock
);

193 
	}
}

195 
	$shªnÚ_mu‹x_š™2
(
shªnÚ_mu‹x_t
 *
lock
)

197 
	`mu‹x_š™
((
mu‹x
 *)
lock
);

198 
	}
}

200 
	$shªnÚ_mu‹x_lock
(
shªnÚ_mu‹x_t
 *
lock
)

202 
	`mu‹x_lock
((
mu‹x
 *)
lock
);

203 
	}
}

205 
	$shªnÚ_mu‹x_Œylock
(
shªnÚ_mu‹x_t
 *
lock
)

207  
	`mu‹x_Œylock
((
mu‹x
 *)
lock
);

208 
	}
}

210 
	$shªnÚ_mu‹x_uÆock
(
shªnÚ_mu‹x_t
 *
lock
)

212 
	`mu‹x_uÆock
((
mu‹x
 *)
lock
);

213 
	}
}

218 
	$shªnÚ_©omic_£t
(
shªnÚ_©omic_t
 *
v
, 
i
)

220 
	`©omic_£t
((
©omic_t
*)
v
, 
i
);

221 
	}
}

223 
	$shªnÚ_©omic64_£t
(
shªnÚ_©omic64_t
 *
v
, 
i
)

225 
	`©omic64_£t
((
©omic64_t
 *)
v
, 
i
);

226 
	}
}

228 
	$shªnÚ_©omic_add
(
i
, 
shªnÚ_©omic_t
 *
v
)

230 
	`©omic_add
(
i
, (
©omic_t
 *)
v
);

231 
	}
}

233 
	$shªnÚ_©omic64_add
(
i
, 
shªnÚ_©omic64_t
 *
v
)

235 
	`©omic64_add
(
i
, (
©omic64_t
 *)
v
);

236 
	}
}

238 
	$shªnÚ_©omic_sub
(
i
, 
shªnÚ_©omic_t
 *
v
)

240 
	`©omic_sub
(
i
, (
©omic_t
 *)
v
);

241 
	}
}

243 
	$shªnÚ_©omic64_sub
(
i
, 
shªnÚ_©omic64_t
 *
v
)

245 
	`©omic64_sub
(
i
, (
©omic64_t
 *)
v
);

246 
	}
}

248 
	$shªnÚ_©omic_dec
(
shªnÚ_©omic_t
 *
v
)

250 
	`©omic_dec
((
©omic_t
*)
v
);

251 
	}
}

253 
	$shªnÚ_©omic64_dec
(
shªnÚ_©omic64_t
 *
v
)

255 
	`©omic64_dec
((
©omic64_t
*)
v
);

256 
	}
}

258 
	$shªnÚ_©omic_šc
(
shªnÚ_©omic_t
 *
v
)

260 
	`©omic_šc
((
©omic_t
*)
v
);

261 
	}
}

263 
	$shªnÚ_©omic64_šc
(
shªnÚ_©omic64_t
 *
v
)

265 
	`©omic64_šc
((
©omic64_t
 *)
v
);

266 
	}
}

268 
	$shªnÚ_©omic_»ad
(cÚ¡ 
shªnÚ_©omic_t
 *
v
)

270  
	`©omic_»ad
((
©omic_t
*)
v
);

271 
	}
}

273 
	$shªnÚ_©omic64_»ad
(cÚ¡ 
shªnÚ_©omic64_t
 *
v
)

275  
	`©omic64_»ad
((
©omic64_t
 *)
v
);

276 
	}
}

278 
	$shªnÚ_©omic_dec_ªd_‹¡
(
shªnÚ_©omic_t
 *
v
)

280  
	`©omic_dec_ªd_‹¡
((
©omic_t
*)
v
);

281 
	}
}

283 
	$shªnÚ_©omic_dec_»tuº
(
shªnÚ_©omic_t
 *
v
)

285  
	`©omic_dec_»tuº
((
©omic_t
 *)
v
);

286 
	}
}

288 
	$shªnÚ_©omic64_dec_ªd_‹¡
(
shªnÚ_©omic64_t
 *
v
)

290  
	`©omic64_dec_ªd_‹¡
((
©omic64_t
*)
v
);

291 
	}
}

293 
	$shªnÚ_©omic_šc_ªd_‹¡
(
shªnÚ_©omic_t
 *
v
)

295  
	`©omic_šc_ªd_‹¡
((
©omic_t
*)
v
);

296 
	}
}

298 
	$shªnÚ_©omic64_šc_»tuº
(
shªnÚ_©omic64_t
 *
v
)

300  
	`©omic64_šc_»tuº
((
©omic64_t
 *)
v
);

301 
	}
}

303 
	$shªnÚ_©omic64_šc_ªd_‹¡
(
shªnÚ_©omic64_t
 *
v
)

305  
	`©omic64_šc_ªd_‹¡
((
©omic64_t
*)
v
);

306 
	}
}

310 
	$shªnÚ_fšd_fœ¡_z”o_b™
(cÚ¡ *
addr
, 
size
)

312  
	`fšd_fœ¡_z”o_b™
(
addr
, 
size
);

313 
	}
}

315 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 25)

317 #ifdeà
__LITTLE_ENDIAN


319 
	#g’”ic_fšd_Ãxt_Ë_b™
(
addr
, 
size
, 
off£t
) \

320 
	`fšd_Ãxt_b™
(
addr
, 
size
, 
off£t
)

	)

325 
šlše
 
	$ext2_swabp
(cÚ¡ * 
x
)

327 #ià
BITS_PER_LONG
 == 64

328  (è
	`__swab64p
((
u64
 *è
x
);

329 #–ià
BITS_PER_LONG
 == 32

330  (è
	`__swab32p
((
u32
 *è
x
);

332 #”rÜ 
BITS_PER_LONG
 
nÙ
 
defšed


334 
	}
}

337 
šlše
 
	$ext2_swab
(cÚ¡ 
y
)

339 #ià
BITS_PER_LONG
 == 64

340  (è
	`__swab64
((
u64
è
y
);

341 #–ià
BITS_PER_LONG
 == 32

342  (è
	`__swab32
((
u32
è
y
);

344 #”rÜ 
BITS_PER_LONG
 
nÙ
 
defšed


346 
	}
}

348 
	$g’”ic_fšd_Ãxt_Ë_b™
(cÚ¡ *
addr
, 

349 
size
, 
off£t
)

351 cÚ¡ *
p
 = 
addr
 + 
	`BITOP_WORD
(
off£t
);

352 
»suÉ
 = 
off£t
 & ~(
BITS_PER_LONG
 - 1);

353 
tmp
;

355 ià(
off£t
 >ğ
size
)

356  
size
;

357 
size
 -ğ
»suÉ
;

358 
off£t
 &ğ(
BITS_PER_LONG
 - 1UL);

359 ià(
off£t
) {

360 
tmp
 = 
	`ext2_swabp
(
p
++);

361 
tmp
 &ğ(~0UL << 
off£t
);

362 ià(
size
 < 
BITS_PER_LONG
)

363 
found_fœ¡
;

364 ià(
tmp
)

365 
found_middË
;

366 
size
 -ğ
BITS_PER_LONG
;

367 
»suÉ
 +ğ
BITS_PER_LONG
;

370 
size
 & ~(
BITS_PER_LONG
 - 1)) {

371 
tmp
 = *(
p
++);

372 ià(
tmp
)

373 
found_middË_sw­
;

374 
»suÉ
 +ğ
BITS_PER_LONG
;

375 
size
 -ğ
BITS_PER_LONG
;

377 ià(!
size
)

378  
»suÉ
;

379 
tmp
 = 
	`ext2_swabp
(
p
);

380 
found_fœ¡
:

381 
tmp
 &ğ(~0UL >> (
BITS_PER_LONG
 - 
size
));

382 ià(
tmp
 == 0UL)

383  
»suÉ
 + 
size
;

384 
found_middË
:

385  
»suÉ
 + 
	`__ffs
(
tmp
);

387 
found_middË_sw­
:

388  
»suÉ
 + 
	`__ffs
(
	`ext2_swab
(
tmp
));

389 
	}
}

395 
	$shªnÚ_fšd_fœ¡_b™_Ë
(cÚ¡ *
addr
, 
size
)

397 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 38)

398  
	`fšd_Ãxt_b™_Ë
(
addr
, 
size
, 0);

400  
	`g’”ic_fšd_Ãxt_Ë_b™
(
addr
, 
size
, 0);

402 
	}
}

404 
	$shªnÚ_fšd_fœ¡_b™
(cÚ¡ *
addr
, 
size
)

406  
	`fšd_Ãxt_b™
(
addr
, 
size
, 0);

407 
	}
}

409 
	$shªnÚ_fšd_Ãxt_b™_Ë
(cÚ¡ *
addr
, 
size
,

410 
off£t
)

412 #ià
LINUX_VERSION_CODE
 > 
	`KERNEL_VERSION
(2, 6, 38)

413  
	`fšd_Ãxt_b™_Ë
(
addr
, 
size
, 
off£t
);

415  
	`g’”ic_fšd_Ãxt_Ë_b™
(
addr
, 
size
, 
off£t
);

417 
	}
}

419 
	$shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
Ä
, *
addr
)

421  
	`‹¡_ªd_ş—r_b™
(
Ä
 ^ 
BITOP_LE_MAGIC
, 
addr
);

422 
	}
}

424 
	$shªnÚ_£t_b™_Ë
(
Ä
, *
addr
)

426 
	`£t_b™
(
Ä
 ^ 
BITOP_LE_MAGIC
, 
addr
);

427 
	}
}

429 
	$shªnÚ_‹¡_b™_Ë
(
Ä
, cÚ¡ *
addr
)

431  
	`‹¡_b™
(
Ä
 ^ 
BITOP_LE_MAGIC
, 
addr
);

432 
	}
}

434 
	$shªnÚ_‹¡_ªd_£t_b™
(
Ä
, vŞ©*
addr
)

436  
	`‹¡_ªd_£t_b™
(
Ä
, 
addr
);

437 
	}
}

439 
	$shªnÚ_‹¡_ªd_ş—r_b™
(
Ä
, vŞ©*
addr
)

441  
	`‹¡_ªd_ş—r_b™
(
Ä
, 
addr
);

442 
	}
}

444 
	$shªnÚ_‹¡_b™
(
Ä
, cÚ¡ vŞ©*
addr
)

446  
	`‹¡_b™
(
Ä
, 
addr
);

447 
	}
}

449 
	$shªnÚ_£t_b™
(
Ä
, *
addr
)

451 
	`£t_b™
(
Ä
, 
addr
);

452 
	}
}

454 
	$shªnÚ_ş—r_b™
(
Ä
, *
addr
)

456 
	`ş—r_b™
(
Ä
, 
addr
);

457 
	}
}

461 
	$__shªnÚ_b™m­_xÜ
(*
d¡
, cÚ¡ *
b™m­1
, cÚ¡ *
b™m­2
, 
b™s
)

463 
	`__b™m­_xÜ
(
d¡
, 
b™m­1
, 
b™m­2
, 
b™s
);

464 
	}
}

466 
	$__shªnÚ_b™m­_weight
(cÚ¡ *
b™m­
, 
b™s
)

468  
	`__b™m­_weight
(
b™m­
, 
b™s
);

469 
	}
}

474 
u32
 
	$shªnÚ_¿w_»adl
(cÚ¡ vŞ©
__iomem
 *
addr
)

476  
	`__¿w_»adl
(
addr
);

477 
	}
}

479 
	$shªnÚ_¿w_wr™–
(
u32
 
v®ue
, vŞ©
__iomem
 *
addr
)

481 
	`__¿w_wr™–
(
v®ue
, 
addr
);

482 
	}
}

484 
u32
 
	$shªnÚ_»adl
(cÚ¡ vŞ©
__iomem
 *
addr
)

486  
	`»adl
(
addr
);

487 
	}
}

489 
u32
 
	$shªnÚ_iÜ—d32
(
__iomem
 *
addr
)

491  
	`iÜ—d32
(
addr
);

492 
	}
}

494 
	$shªnÚ_wr™–
(
u32
 
v®ue
, vŞ©
__iomem
 *
addr
)

496 
	`wr™–
(
v®ue
, 
addr
);

497 
	}
}

499 
	$shªnÚ_iowr™e32
(
u32
 
v®ue
, 
__iomem
 *
addr
)

501 
	`iowr™e32
(
v®ue
, 
addr
);

502 
	}
}

504 
u16
 
	$shªnÚ_mem_»adw
(vŞ©*
addr
)

506  
	`__Ë16_to_ıu
(*(
u16
 *)
addr
);

507 
	}
}

509 
	$shªnÚ_mem_wr™ew
(
u16
 
v®ue
, *
addr
)

511 *(
u16
 *)
addr
 = 
	`__ıu_to_Ë16
(
v®ue
);

512 
	}
}

514 
	$shªnÚ_ıu_to_Ë16s
(*
addr
)

516 
	`__ıu_to_Ë16s
(
addr
);

517 
	}
}

519 
u32
 
	$shªnÚ_mem_»adl
(vŞ©*
addr
)

521  
	`__Ë32_to_ıu
(*(
u32
 *)
addr
);

522 
	}
}

524 
	$shªnÚ_mem_wr™–
(
u32
 
v®ue
, *
addr
)

526 *(
u32
 *)
addr
 = 
	`__ıu_to_Ë32
(
v®ue
);

527 
	}
}

529 
	$shªnÚ_ıu_to_Ë32s
(*
addr
)

531 
	`__ıu_to_Ë32s
(
addr
);

532 
	}
}

534 
u32
 
	$shªnÚ_ıu_to_be32
(
u32
 
v®
)

536  
	`__ıu_to_be32
(
v®
);

537 
	}
}

539 
	$shªnÚ_ıu_to_Ë64s
(*
addr
)

541 
	`__ıu_to_Ë64s
(
addr
);

542 
	}
}

544 
u64
 
	$shªnÚ_ıu_to_be64
(
u64
 
v®
)

546  
	`__ıu_to_be64
(
v®
);

547 
	}
}

549 
u64
 
	$shªnÚ_mem_»adq
(vŞ©*
addr
)

551  
	`__Ë64_to_ıu
(*(
u64
 *)
addr
);

552 
	}
}

554 
	$shªnÚ_mem_wr™eq
(
u64
 
v®ue
, *
addr
)

556 *(
u64
 *)
addr
 = 
	`__ıu_to_Ë64
(
v®ue
);

557 
	}
}

559 
__iomem
 *
	$shªnÚ_iÜem­
(
shªnÚ_phys_addr_t
 
off£t
, 
size
)

561  
	`iÜem­
(
off£t
, 
size
);

562 
	}
}

564 
	$shªnÚ_iounm­
(vŞ©
__iomem
 *
addr
)

566 
	`iounm­
(
addr
);

567 
	}
}

569 
	$shªnÚ_memıy_äomio
(*
de¡
, *
sourû
, 
couÁ
)

571 
	`memıy_äomio
(
de¡
, 
sourû
, 
couÁ
);

572 
	}
}

575 
	$shªnÚ_cİy_äom_u£r
(*
to
, cÚ¡ 
__u£r
 * 
äom
, 
n
)

577  
	`cİy_äom_u£r
(
to
, 
äom
, 
n
);

578 
	}
}

580 
	$shªnÚ_cİy_to_u£r
(
__u£r
 *
to
,

581 cÚ¡ *
äom
, 
n
)

583  
	`cİy_to_u£r
(
to
, 
äom
, 
n
);

584 
	}
}

587 
	$shªnÚ_ä“_·ge
(
addr
)

589 
	`ä“_·ge
(
addr
);

590 
	}
}

592 
	$__shªnÚ_g‘_ä“_·ge
(
gå_t
 
gå
)

594  
	`__g‘_ä“_·ge
(
gå
);

595 
	}
}

598 *
	$shªnÚ_·ge_add»ss
(
shªnÚ_·ge
 *
·ge
)

600  
	`·ge_add»ss
((
·ge
 *)page);

601 
	}
}

604 *
	$shªnÚ_vz®loc
(
size
)

606 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 36)

607  
	`vz®loc
(
size
);

609 *
addr
 = 
	`vm®loc
(
size
);

610 ià(
addr
)

611 
	`mem£t
(
addr
, 0, 
size
);

613  
addr
;

615 
	}
}

617 *
	$shªnÚ_vm®loc
(
size
)

619  
	`vm®loc
(
size
);

620 
	}
}

622 *
	$__shªnÚ_vm®loc
(
size
, 
shªnÚ_gå_t
 
gå_mask
, 
shªnÚ_pg´Ù_t
 
´Ù
)

624  
	`__vm®loc
(
size
, 
gå_mask
, *((
pg´Ù_t
 *)&
´Ù
));

625 
	}
}

627 
	$shªnÚ_vä“
(*
addr
)

629 
	`vä“
(
addr
);

630 
	}
}

632 *
	$shªnÚ_vœt_to_·ge
(cÚ¡ *
addr
)

634  
	`vœt_to_·ge
(
addr
);

635 
	}
}

638 
shªnÚ_kmem_ÿche_t
 *
shªnÚ_kmem_ÿche_ü—‹
(cÚ¡ *
Çme
, 
size_t
 
size
, size_ˆ
®ign
,

639 
æags
, (*
ùÜ
)(*))

641 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 27)

643  
	`kmem_ÿche_ü—‹
(
Çme
, 
size
, 
®ign
, 
æags
, 
ùÜ
);

647  
	`kmem_ÿche_ü—‹
(
Çme
, 
size
, 
®ign
, 
æags
, ((*)(*, 
kmem_ÿche
 *, ))
ùÜ
, 
NULL
);

650 
	}
}

652 
	$shªnÚ_kmem_ÿche_de¡roy
(
shªnÚ_kmem_ÿche_t
 *
ÿch•
)

654 
	`kmem_ÿche_de¡roy
((
kmem_ÿche
 *)
ÿch•
);

655 
	}
}

657 *
	$shªnÚ_kz®loc
(
size_t
 
size
, 
shªnÚ_gå_t
 
æags
)

659  
	`kz®loc
(
size
, 
æags
);

660 
	}
}

662 *
	$shªnÚ_km®loc
(
size_t
 
size
, 
shªnÚ_gå_t
 
æags
)

664  
	`km®loc
(
size
, 
æags
);

665 
	}
}

667 
	$shªnÚ_kä“
(cÚ¡ *
p
)

669 
	`kä“
(
p
);

670 
	}
}

673 
shªnÚ_mempoŞ_t
 *
	$shªnÚ_mempoŞ_ü—‹_km®loc_poŞ
(
mš_Ä
, 
size_t
 
size
)

675  
	`mempoŞ_ü—‹_km®loc_poŞ
(
mš_Ä
, 
size
);

676 
	}
}

678 
shªnÚ_mempoŞ_t
 *
	$shªnÚ_mempoŞ_ü—‹_¦ab_poŞ
(
mš_Ä
, 
shªnÚ_kmem_ÿche_t
 *
kc
)

680  
	`mempoŞ_ü—‹_¦ab_poŞ
(
mš_Ä
, (
kmem_ÿche
 *)
kc
);

681 
	}
}

683 
	$shªnÚ_mempoŞ_de¡roy
(
shªnÚ_mempoŞ_t
 *
poŞ
)

685 
	`mempoŞ_de¡roy
((
mempoŞ_t
 *)
poŞ
);

686 
	}
}

688 * 
	$shªnÚ_mempoŞ_®loc
(
shªnÚ_mempoŞ_t
 *
poŞ
, 
shªnÚ_gå_t
 
gå_mask
)

690  
	`mempoŞ_®loc
((
mempoŞ_t
 *)
poŞ
, 
gå_mask
);

691 
	}
}

693 
	$shªnÚ_mempoŞ_ä“
(*
–em’t
, 
shªnÚ_mempoŞ_t
 *
poŞ
)

695 
	`mempoŞ_ä“
(
–em’t
, (
mempoŞ_t
 *)
poŞ
);

696 
	}
}

698 
	$g‘_mempoŞ_couÁ
(
shªnÚ_mempoŞ_t
 *
poŞ
)

700  ((
mempoŞ_t
 *)
poŞ
)->
cu¼_Ä
;

701 
	}
}

708 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)

709 *
	$kva¥rštf
(
gå_t
 
gå
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

711 
Ën
;

712 *
p
;

713 
va_li¡
 
aq
;

715 
	`va_cİy
(
aq
, 
­
);

716 
Ën
 = 
	`v¢´štf
(
NULL
, 0, 
fmt
, 
aq
);

717 
	`va_’d
(
aq
);

719 
p
 = 
	`km®loc
(
Ën
+1, 
gå
);

720 ià(!
p
)

721  
NULL
;

723 
	`v¢´štf
(
p
, 
Ën
+1, 
fmt
, 
­
);

725  
p
;

726 
	}
}

730 *
	$shªnÚ_ka¥rštf
(
shªnÚ_gå_t
 
gå
, cÚ¡ *
fmt
, ...)

732 
va_li¡
 
­
;

733 *
p
;

735 
	`va_¡¬t
(
­
, 
fmt
);

736 
p
 = 
	`kva¥rštf
(
gå
, 
fmt
, 
­
);

737 
	`va_’d
(
­
);

739  
p
;

740 
	}
}

742 
size_t
 
	$shªnÚ_¡ºËn
(cÚ¡ *
s
, 
size_t
 
couÁ
)

744  
	`¡ºËn
(
s
, 
couÁ
);

745 
	}
}

747 
	$shªnÚ_¥rštf
(*
buf
, cÚ¡ *
fmt
, ...)

749 
va_li¡
 
¬gs
;

750 
i
;

752 
	`va_¡¬t
(
¬gs
, 
fmt
);

753 
i
 = 
	`v¢´štf
(
buf
, 
INT_MAX
, 
fmt
, 
¬gs
);

754 
	`va_’d
(
¬gs
);

756  
i
;

757 
	}
}

759 
	$shªnÚ_¢´štf
(*
buf
, 
size_t
 
size
, cÚ¡ *
fmt
, ...)

761 
va_li¡
 
¬gs
;

762 
i
;

764 
	`va_¡¬t
(
¬gs
, 
fmt
);

765 
i
 = 
	`v¢´štf
(
buf
, 
size
, 
fmt
, 
¬gs
);

766 
	`va_’d
(
¬gs
);

768  
i
;

769 
	}
}

771 
	$shªnÚ_sim¶e_¡¹Ş
(cÚ¡ *
ı
, **
’dp
, 
ba£
)

773  
	`sim¶e_¡¹Ş
(
ı
, 
’dp
, 
ba£
);

774 
	}
}

776 
	$shªnÚ_dump_¡ack
()

778 
	`dump_¡ack
();

779 
	}
}

781 
	$shªnÚ_´štk_¿‹lim™
()

783  
	`´štk_¿‹lim™
();

784 
	}
}

787 *
	$shªnÚ_mem£t
(*
s
, 
c
, 
size_t
 
n
)

789  
	`mem£t
(
s
, 
c
, 
n
);

790 
	}
}

792 *
	$shªnÚ_memıy
(*
de¡
, cÚ¡ *
¤c
, 
size_t
 
couÁ
)

794  
	`memıy
(
de¡
, 
¤c
 ,
couÁ
);

795 
	}
}

797 
	$shªnÚ_memcmp
(cÚ¡ *
cs
, cÚ¡ *
ù
, 
size_t
 
couÁ
)

799  
	`memcmp
(
cs
, 
ù
, 
couÁ
);

800 
	}
}

803 
asmlškage
 
	$shªnÚ_´štk
(cÚ¡ *
fmt
, ...)

805 
va_li¡
 
¬gs
;

806 
r
;

808 
	`va_¡¬t
(
¬gs
, 
fmt
);

809 #ià!
	`defšed
(
__VMKLNX__
)

810 
r
 = 
	`v´štk
(
fmt
, 
¬gs
);

812 
va_li¡
 
¬gs_cİy
;

814 
	`va_cİy
(
¬gs_cİy
, 
¬gs
);

815 
	`vmk_vLogNoLev–
(
VMK_LOG_URGENCY_NORMAL
, 
fmt
, 
¬gs
);

816 
r
 = 
	`vmk_V¢´štf
(
NULL
, 0, 
fmt
, 
¬gs_cİy
);

818 
	`va_’d
(
¬gs_cİy
);

820 
	`va_’d
(
¬gs
);

822  
r
;

823 
	}
}

826 
	$g‘_num_Úlše_ıus
()

828  
	`num_Úlše_ıus
();

829 
	}
}

831 
	$shªnÚ_hweight_lÚg
(
w
)

833  
	`hweight_lÚg
(
w
);

834 
	}
}

836 
	$shªnÚ_hweight32
(
w
)

838  
	`hweight32
(
w
);

839 
	}
}

841 
	$shªnÚ_g‘_couÁ_Üd”
(
couÁ
)

843  
	`g‘_couÁ_Üd”
(
couÁ
);

844 
	}
}

847 
	gshªnÚ_pm_qos_v®ue
 = 1;

848 
	gshªnÚ_pm_qos_di§bË
 = 0;

849 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 2, 0)

851 
	~<lšux/pm_qos.h
>

852 
	$shªnÚ_pm_qos_add_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
v®ue
)

854 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

857 *
l
 = 
	`kz®loc
((
pm_qos_»que¡
), 
GFP_SHANNON
);

859 ià(*
l
 =ğ
NULL
)

862 
	`pm_qos_add_»que¡
((
pm_qos_»que¡
 *)(*
l
), 
qos
, 
v®ue
);

864 
	}
}

866 
	$shªnÚ_pm_qos_upd©e_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
Ãw_v®ue
)

868 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

871 ià(*
l
 !ğ
NULL
)

872 
	`pm_qos_upd©e_»que¡
((
pm_qos_»que¡
 *)(*
l
), 
Ãw_v®ue
);

874 
	}
}

876 
	$shªnÚ_pm_qos_»move_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
)

878 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

881 ià(*
l
 !ğ
NULL
) {

882 
	`pm_qos_»move_»que¡
((
pm_qos_»que¡
 *)(*
l
));

883 
	`kä“
(*
l
);

884 *
l
 = 
NULL
;

886 
	}
}

888 
	$shªnÚ_pm_qos_is_»quœed
(
qos
)

890 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

893  (
	`pm_qos_»que¡
(
qos
è=ğ
shªnÚ_pm_qos_v®ue
);

894 
	}
}

897 #–ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 36)

899 
	~<lšux/pm_qos_·¿ms.h
>

900 
	$shªnÚ_pm_qos_add_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
v®ue
)

902 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

905 *
l
 = 
	`kz®loc
((
pm_qos_»que¡_li¡
), 
GFP_SHANNON
);

907 ià(*
l
 =ğ
NULL
)

910 
	`pm_qos_add_»que¡
((
pm_qos_»que¡_li¡
 *)(*
l
), 
qos
, 
v®ue
);

912 
	}
}

914 
	$shªnÚ_pm_qos_upd©e_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
Ãw_v®ue
)

916 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

919 ià(*
l
 !ğ
NULL
)

920 
	`pm_qos_upd©e_»que¡
((
pm_qos_»que¡_li¡
 *)(*
l
), 
Ãw_v®ue
);

923 
	}
}

925 
	$shªnÚ_pm_qos_»move_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
)

927 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

930 ià(*
l
 !ğ
NULL
) {

931 
	`pm_qos_»move_»que¡
((
pm_qos_»que¡_li¡
 *)(*
l
));

932 
	`kä“
(*
l
);

933 *
l
 = 
NULL
;

935 
	}
}

937 
	$shªnÚ_pm_qos_is_»quœed
(
qos
)

939 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

942  (
	`pm_qos_»que¡
(
qos
è=ğ
shªnÚ_pm_qos_v®ue
);

943 
	}
}

945 #–ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 35)

947 
	~<lšux/pm_qos_·¿ms.h
>

948 
	$shªnÚ_pm_qos_add_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
v®ue
)

950 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

953 *
l
 = (
pm_qos_»que¡_li¡
 *)
	`pm_qos_add_»que¡
(
qos
, 
v®ue
);

955 
	}
}

957 
	$shªnÚ_pm_qos_upd©e_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
Ãw_v®ue
)

959 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

962 ià(*
l
 !ğ
NULL
)

963 
	`pm_qos_upd©e_»que¡
((
pm_qos_»que¡_li¡
 *)(*
l
), 
Ãw_v®ue
);

965 
	}
}

967 
	$shªnÚ_pm_qos_»move_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
)

969 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

972 ià(*
l
 !ğ
NULL
) {

973 
	`pm_qos_»move_»que¡
((
pm_qos_»que¡_li¡
 *)(*
l
));

974 *
l
 = 
NULL
;

976 
	}
}

978 
	$shªnÚ_pm_qos_is_»quœed
(
qos
)

980 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

983  (
	`pm_qos_»que¡
(
qos
è=ğ
shªnÚ_pm_qos_v®ue
);

984 
	}
}

986 #–ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 31)

988 
	~<lšux/pm_qos_·¿ms.h
>

989 
	$shªnÚ_pm_qos_add_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
v®ue
)

991 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

994  
	`pm_qos_add_»quœem’t
(
qos
, 
Çme
, 
v®ue
);

995 
	}
}

997 
	$shªnÚ_pm_qos_upd©e_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
Ãw_v®ue
)

999 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

1002  
	`pm_qos_upd©e_»quœem’t
(
qos
, 
Çme
, 
Ãw_v®ue
);

1003 
	}
}

1005 
	$shªnÚ_pm_qos_»move_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
)

1007 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

1010 
	`pm_qos_»move_»quœem’t
(
qos
, 
Çme
);

1011 
	}
}

1013 
	$shªnÚ_pm_qos_is_»quœed
(
qos
)

1015 ià(
	`uÆik–y
(
shªnÚ_pm_qos_di§bË
))

1018  (
	`pm_qos_»quœem’t
(
qos
è=ğ
shªnÚ_pm_qos_v®ue
);

1019 
	}
}

1023 
	$shªnÚ_pm_qos_add_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
v®ue
)

1026 
	}
}

1028 
	$shªnÚ_pm_qos_upd©e_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
Ãw_v®ue
)

1031 
	}
}

1033 
	$shªnÚ_pm_qos_»move_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
)

1035 
	}
}

1037 
	$shªnÚ_pm_qos_is_»quœed
(
qos
)

1040 
	}
}

1045 *
	$SHANNON_ERR_PTR
(
”rÜ
)

1047  
	`ERR_PTR
(
”rÜ
);

1048 
	}
}

1050 
	$SHANNON_IS_ERR
(cÚ¡ *
±r
)

1052  
	`IS_ERR
(
±r
);

1053 
	}
}

1055 
	$SHANNON_PTR_ERR
(cÚ¡ *
±r
)

1057  
	`PTR_ERR
(
±r
);

1058 
	}
}

1060 
	$SHANNON_IS_ERR_OR_NULL
(cÚ¡ *
±r
)

1062  !
±r
 || 
	`IS_ERR_VALUE
(()ptr);

1063 
	}
}

1066 
size_t
 
	$shªnÚ_¡¾’
(cÚ¡ *
s
)

1068  
	`¡¾’
(
s
);

1069 
	}
}

1072 
	$shªnÚ_g‘_¿ndom_by‹s
(*
buf
, 
by‹s
)

1074 
	`g‘_¿ndom_by‹s
(
buf
, 
by‹s
);

1075 
	}
}

1078 
	$shªnÚ_´eãtch
(*
addr
)

1080 
	`´eãtch
(
addr
);

1081 
	}
}

1083 
	$shªnÚ_´eãtchw
(*
addr
)

1085 
	`´eãtchw
(
addr
);

1086 
	}
}

1088 
	$shªnÚ_¥š_lock_´eãtch
(*
addr
)

1090 
	`¥š_lock_´eãtch
(
addr
);

1091 
	}
}

1093 
	sshªnÚ_¿‹lim™_¡©e
 {

1094 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 33)

1095 
¿w_¥šlock_t
 
	mlock
;

1097 
¥šlock_t
 
	mlock
;

1100 
	mš‹rv®
;

1101 
	mbur¡
;

1102 
	m´š‹d
;

1103 
	mmis£d
;

1104 
	mbegš
;

1107 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 33)

1109 
	#DEFINE_SHANNON_RATELIMIT_STATE
(
Çme
, 
š‹rv®_š™
, 
bur¡_š™
) \

1111 
shªnÚ_¿‹lim™_¡©e
 
Çme
 = { \

1112 .
lock
 = 
	`__RAW_SPIN_LOCK_UNLOCKED
(
Çme
.lock), \

1113 .
š‹rv®
 = 
š‹rv®_š™
, \

1114 .
bur¡
 = 
bur¡_š™
, \

1115 }

	)

1118 
	#DEFINE_SHANNON_RATELIMIT_STATE
(
Çme
, 
š‹rv®_š™
, 
bur¡_š™
) \

1120 
shªnÚ_¿‹lim™_¡©e
 
Çme
 = { \

1121 .
lock
 = 
	`__SPIN_LOCK_UNLOCKED
(
Çme
.lock), \

1122 .
š‹rv®
 = 
š‹rv®_š™
, \

1123 .
bur¡
 = 
bur¡_š™
, \

1124 }

	)

1126 
DEFINE_SHANNON_RATELIMIT_STATE
(
shªnÚ_rs
, 
SHANNON_DEFAULT_RATELIMIT_INTERVAL
, 
SHANNON_DEFAULT_RATELIMIT_BURST
);

1127 
DEFINE_SHANNON_RATELIMIT_STATE
(
»cov”_rs
, 
SHANNON_DEFAULT_RECOVER_RATELIMIT_INTERVAL
, 
SHANNON_DEFAULT_RECOVER_RATELIMIT_BURST
);

1129 
šlše
 
	$shªnÚ_¿‹lim™
(
shªnÚ_¿‹lim™_¡©e
 *
rs
, cÚ¡ *
func
)

1131 
æags
;

1132 
»t
;

1134 ià(!
rs
->
š‹rv®
)

1143 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 33)

1144 ià(!
	`¿w_¥š_Œylock_œq§ve
(&
rs
->
lock
, 
æags
))

1146 ià(!
	`¥š_Œylock_œq§ve
(&
rs
->
lock
, 
æags
))

1150 ià(!
rs
->
begš
)

1151 
rs
->
begš
 = 
jiff›s
;

1153 ià(
	`time_aá”
(
jiff›s
, 
rs
->
begš
 +„s->
š‹rv®
)) {

1154 ià(
rs
->
mis£d
)

1155 
	`´štk
(
KERN_ERR
 "shn_log: %s: %d callbacks suppressed\n",

1156 
func
, 
rs
->
mis£d
);

1157 
rs
->
begš
 = 0;

1158 
rs
->
´š‹d
 = 0;

1159 
rs
->
mis£d
 = 0;

1161 ià(
rs
->
bur¡
 &&„s->bur¡ >„s->
´š‹d
) {

1162 
rs
->
´š‹d
++;

1163 
»t
 = 1;

1165 
rs
->
mis£d
++;

1166 
»t
 = 0;

1168 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 33)

1169 
	`¿w_¥š_uÆock_œq»¡Üe
(&
rs
->
lock
, 
æags
);

1171 
	`¥š_uÆock_œq»¡Üe
(&
rs
->
lock
, 
æags
);

1174  
»t
;

1175 
	}
}

1177 
asmlškage
 
	$shªnÚ_´štk_¿‹lim™ed
(cÚ¡ *
fmt
, ...)

1179 
va_li¡
 
¬gs
;

1180 
r
;

1182 ià(
	`shªnÚ_¿‹lim™
(&
shªnÚ_rs
, 
__func__
)) {

1183 
	`va_¡¬t
(
¬gs
, 
fmt
);

1184 #ià!
	`defšed
(
__VMKLNX__
)

1185 
r
 = 
	`v´štk
(
fmt
, 
¬gs
);

1187 
va_li¡
 
¬gs_cİy
;

1189 
	`va_cİy
(
¬gs_cİy
, 
¬gs
);

1190 
	`vmk_vLogNoLev–
(
VMK_LOG_URGENCY_NORMAL
, 
fmt
, 
¬gs
);

1191 
r
 = 
	`vmk_V¢´štf
(
NULL
, 0, 
fmt
, 
¬gs_cİy
);

1193 
	`va_’d
(
¬gs_cİy
);

1195 
	`va_’d
(
¬gs
);

1197  
r
;

1200 
	}
}

1202 
asmlškage
 
	$shªnÚ_»cov”_´štk_¿‹lim™ed
(cÚ¡ *
fmt
, ...)

1204 
va_li¡
 
¬gs
;

1205 
r
;

1207 ià(
	`shªnÚ_¿‹lim™
(&
»cov”_rs
, 
__func__
)) {

1208 
	`va_¡¬t
(
¬gs
, 
fmt
);

1209 #ià!
	`defšed
(
__VMKLNX__
)

1210 
r
 = 
	`v´štk
(
fmt
, 
¬gs
);

1212 
va_li¡
 
¬gs_cİy
;

1214 
	`va_cİy
(
¬gs_cİy
, 
¬gs
);

1215 
	`vmk_vLogNoLev–
(
VMK_LOG_URGENCY_NORMAL
, 
fmt
, 
¬gs
);

1216 
r
 = 
	`vmk_V¢´štf
(
NULL
, 0, 
fmt
, 
¬gs_cİy
);

1218 
	`va_’d
(
¬gs_cİy
);

1220 
	`va_’d
(
¬gs
);

1222  
r
;

1225 
	}
}

	@shannon_kcore.h

1 #iâdeà
__SHANNON_KCORE_H


2 
	#__SHANNON_KCORE_H


	)

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/gå.h
>

16 
	~<lšux/”ºo.h
>

17 
	~<lšux/ioùl.h
>

18 
	~<lšux/highmem.h
>

20 
	#RESERVE_MEM
(
by‹s
è
mem
[by‹s] 
	`__©Œibu‹__
 ((
	`®igÃd
(8)))

	)

22 
	#SHANNON_DEFAULT_RATELIMIT_INTERVAL
 (5 * 
HZ
)

	)

23 
	#SHANNON_DEFAULT_RATELIMIT_BURST
 500

	)

24 
	#SHANNON_DEFAULT_RECOVER_RATELIMIT_INTERVAL
 (5 * 
HZ
)

	)

25 
	#SHANNON_DEFAULT_RECOVER_RATELIMIT_BURST
 1000

	)

30 
	s__shªnÚ_¥šlock
 {

32 
RESERVE_MEM
(128);

35 
	s__shªnÚ_rwlock
 {

36 
RESERVE_MEM
(128);

39 
__shªnÚ_¥šlock
 
	tshªnÚ_¥šlock_t
;

40 
__shªnÚ_rwlock
 
	tshªnÚ_rwlock_t
;

42 #ifdeà
CONFIG_PROVE_LOCKING


44 
	#shªnÚ_¥š_lock_š™
(
_lock
) \

46 
	`¥š_lock_š™
((
¥šlock_t
 *)
_lock
); \

47 } 0)

	)

49 
	#shªnÚ_rwlock_š™
(
_lock
) \

51 
	`rwlock_š™
((
rwlock_t
 *)
_lock
); \

52 } 0)

	)

54 
	#shªnÚ_¥š_lock
(
lock
è
	`¥š_lock
((
¥šlock_t
 *)Öock))

	)

55 
	#shªnÚ_¥š_lock_bh
(
lock
è
	`¥š_lock_bh
((
¥šlock_t
 *)Öock))

	)

56 
	#shªnÚ_¥š_lock_œq
(
lock
è
	`¥š_lock_œq
((
¥šlock_t
 *)Öock))

	)

57 
	#shªnÚ_¥š_uÆock
(
lock
è
	`¥š_uÆock
((
¥šlock_t
 *)Öock))

	)

58 
	#shªnÚ_¥š_uÆock_bh
(
lock
è
	`¥š_uÆock_bh
((
¥šlock_t
 *)Öock))

	)

59 
	#shªnÚ_¥š_uÆock_œq
(
lock
è
	`¥š_uÆock_œq
((
¥šlock_t
 *)Öock))

	)

60 
	#shªnÚ_¥š_Œylock
(
lock
è
	`¥š_Œylock
((
¥šlock_t
 *)Öock))

	)

62 
	#shªnÚ_»ad_lock
(
lock
è
	`»ad_lock
((
rwlock_t
 *)Öock))

	)

63 
	#shªnÚ_»ad_lock_bh
(
lock
è
	`»ad_lock_bh
((
rwlock_t
 *)Öock))

	)

64 
	#shªnÚ_»ad_lock_œq
(
lock
è
	`»ad_lock_œq
((
rwlock_t
 *)Öock))

	)

65 
	#shªnÚ_»ad_uÆock
(
lock
è
	`»ad_uÆock
((
rwlock_t
 *)Öock))

	)

66 
	#shªnÚ_»ad_uÆock_bh
(
lock
è
	`»ad_uÆock_bh
((
rwlock_t
 *)Öock))

	)

67 
	#shªnÚ_»ad_uÆock_œq
(
lock
è
	`»ad_uÆock_œq
((
rwlock_t
 *)Öock))

	)

68 
	#shªnÚ_»ad_Œylock
(
lock
è
	`»ad_Œylock
((
rwlock_t
 *)Öock))

	)

70 
	#shªnÚ_wr™e_lock
(
lock
è
	`wr™e_lock
((
rwlock_t
 *)Öock))

	)

71 
	#shªnÚ_wr™e_lock_bh
(
lock
è
	`wr™e_lock_bh
((
rwlock_t
 *)Öock))

	)

72 
	#shªnÚ_wr™e_lock_œq
(
lock
è
	`wr™e_lock_œq
((
rwlock_t
 *)Öock))

	)

73 
	#shªnÚ_wr™e_uÆock
(
lock
è
	`wr™e_uÆock
((
rwlock_t
 *)Öock))

	)

74 
	#shªnÚ_wr™e_uÆock_bh
(
lock
è
	`wr™e_uÆock_bh
((
rwlock_t
 *)Öock))

	)

75 
	#shªnÚ_wr™e_uÆock_œq
(
lock
è
	`wr™e_uÆock_œq
((
rwlock_t
 *)Öock))

	)

76 
	#shªnÚ_wr™e_Œylock
(
lock
è
	`wr™e_Œylock
((
rwlock_t
 *)Öock))

	)

80 
shªnÚ_¥š_lock_š™
(
shªnÚ_¥šlock_t
 *
lock
);

81 
shªnÚ_¥š_lock
(
shªnÚ_¥šlock_t
 *
lock
);

82 
shªnÚ_¥š_lock_bh
(
shªnÚ_¥šlock_t
 *
lock
);

83 
shªnÚ_¥š_lock_œq
(
shªnÚ_¥šlock_t
 *
lock
);

84 
shªnÚ_¥š_uÆock
(
shªnÚ_¥šlock_t
 *
lock
);

85 
shªnÚ_¥š_uÆock_bh
(
shªnÚ_¥šlock_t
 *
lock
);

86 
shªnÚ_¥š_uÆock_œq
(
shªnÚ_¥šlock_t
 *
lock
);

87 
shªnÚ_¥š_Œylock
(
shªnÚ_¥šlock_t
 *
lock
);

88 
shªnÚ_¥š_Œylock_œq
(
shªnÚ_¥šlock_t
 *
lock
);

90 
shªnÚ_rwlock_š™
(
shªnÚ_rwlock_t
 *
lock
);

91 
shªnÚ_»ad_lock
(
shªnÚ_rwlock_t
 *
lock
);

92 
shªnÚ_»ad_lock_bh
(
shªnÚ_rwlock_t
 *
lock
);

93 
shªnÚ_»ad_lock_œq
(
shªnÚ_rwlock_t
 *
lock
);

94 
shªnÚ_»ad_uÆock
(
shªnÚ_rwlock_t
 *
lock
);

95 
shªnÚ_»ad_uÆock_bh
(
shªnÚ_rwlock_t
 *
lock
);

96 
shªnÚ_»ad_uÆock_œq
(
shªnÚ_rwlock_t
 *
lock
);

97 
shªnÚ_»ad_Œylock
(
shªnÚ_rwlock_t
 *
lock
);

98 
shªnÚ_wr™e_lock
(
shªnÚ_rwlock_t
 *
lock
);

99 
shªnÚ_wr™e_lock_bh
(
shªnÚ_rwlock_t
 *
lock
);

100 
shªnÚ_wr™e_lock_œq
(
shªnÚ_rwlock_t
 *
lock
);

101 
shªnÚ_wr™e_uÆock
(
shªnÚ_rwlock_t
 *
lock
);

102 
shªnÚ_wr™e_uÆock_bh
(
shªnÚ_rwlock_t
 *
lock
);

103 
shªnÚ_wr™e_uÆock_œq
(
shªnÚ_rwlock_t
 *
lock
);

104 
shªnÚ_wr™e_Œylock
(
shªnÚ_rwlock_t
 *
lock
);

107 
shªnÚ_¥š_lock_œq§ve
(
shªnÚ_¥šlock_t
 *
lock
);

108 
shªnÚ_¥š_uÆock_œq»¡Üe
(
shªnÚ_¥šlock_t
 *
lock
, 
æags
);

113 
	s__shªnÚ_£m­hÜe
 {

115 
RESERVE_MEM
(256);

118 
__shªnÚ_£m­hÜe
 
	tshªnÚ_mu‹x_t
;

120 #ifdeà
CONFIG_PROVE_LOCKING


122 
	#shªnÚ_mu‹x_š™
(
_lock
) \

124 
	`mu‹x_š™
((
mu‹x
 *)
_lock
); \

125 } 0)

	)

127 
	#shªnÚ_mu‹x_lock
(
lock
è
	`mu‹x_lock
((
mu‹x
 *)Öock))

	)

128 
	#shªnÚ_mu‹x_Œylock
(
lock
è
	`mu‹x_Œylock
((
mu‹x
 *)Öock))

	)

129 
	#shªnÚ_mu‹x_uÆock
(
lock
è
	`mu‹x_uÆock
((
mu‹x
 *)Öock))

	)

133 
shªnÚ_mu‹x_š™
(
shªnÚ_mu‹x_t
 *
lock
);

134 
shªnÚ_mu‹x_lock
(
shªnÚ_mu‹x_t
 *
lock
);

135 
shªnÚ_mu‹x_uÆock
(
shªnÚ_mu‹x_t
 *
lock
);

136 
shªnÚ_mu‹x_Œylock
(
shªnÚ_mu‹x_t
 *
lock
);

141 
	s__shªnÚ_©omic
 {

143 
RESERVE_MEM
(());

146 
__shªnÚ_©omic
 
	tshªnÚ_©omic_t
;

147 
__shªnÚ_©omic
 
	tshªnÚ_©omic64_t
;

149 
shªnÚ_©omic_£t
(
shªnÚ_©omic_t
 *
v
, 
i
);

150 
shªnÚ_©omic_add
(
i
, 
shªnÚ_©omic_t
 *
v
);

151 
shªnÚ_©omic_sub
(
i
, 
shªnÚ_©omic_t
 *
v
);

152 
shªnÚ_©omic_dec
(
shªnÚ_©omic_t
 *
v
);

153 
shªnÚ_©omic_šc
(
shªnÚ_©omic_t
 *
v
);

154 
shªnÚ_©omic_»ad
(cÚ¡ 
shªnÚ_©omic_t
 *
v
);

155 
shªnÚ_©omic_dec_ªd_‹¡
(
shªnÚ_©omic_t
 *
v
);

156 
shªnÚ_©omic_šc_ªd_‹¡
(
shªnÚ_©omic_t
 *
v
);

157 
shªnÚ_©omic64_šc_»tuº
(
shªnÚ_©omic64_t
 *
v
);

158 
shªnÚ_©omic_dec_»tuº
(
shªnÚ_©omic_t
 *
v
);

161 
shªnÚ_©omic64_£t
(
shªnÚ_©omic64_t
 *
v
, 
i
);

162 
shªnÚ_©omic64_add
(
i
, 
shªnÚ_©omic64_t
 *
v
);

163 
shªnÚ_©omic64_sub
(
i
, 
shªnÚ_©omic64_t
 *
v
);

164 
shªnÚ_©omic64_dec
(
shªnÚ_©omic64_t
 *
v
);

165 
shªnÚ_©omic64_šc
(
shªnÚ_©omic64_t
 *
v
);

166 
shªnÚ_©omic64_»ad
(cÚ¡ 
shªnÚ_©omic64_t
 *
v
);

167 
shªnÚ_©omic64_dec_ªd_‹¡
(
shªnÚ_©omic64_t
 *
v
);

168 
shªnÚ_©omic64_šc_ªd_‹¡
(
shªnÚ_©omic64_t
 *
v
);

172 
shªnÚ_fšd_fœ¡_z”o_b™
(cÚ¡ *
addr
, 
size
);

173 
shªnÚ_fšd_fœ¡_b™_Ë
(cÚ¡ *
addr
, 
size
);

174 
shªnÚ_fšd_fœ¡_b™
(cÚ¡ *
addr
, 
size
);

175 
shªnÚ_fšd_Ãxt_b™_Ë
(cÚ¡ *
addr
, 
size
, 
off£t
);

176 
	#shªnÚ_fÜ_—ch_£t_b™_Ë
(
b™
, 
addr
, 
size
) \

177 (
b™
èğ
	`shªnÚ_fšd_fœ¡_b™_Ë
((
addr
), (
size
)); \

178 (
b™
è< (
size
); \

179 (
b™
èğ
	`shªnÚ_fšd_Ãxt_b™_Ë
((
addr
), (
size
), (b™è+ 1))

	)

180 
shªnÚ_‹¡_ªd_£t_b™
(
Ä
, vŞ©*
addr
);

181 
shªnÚ_‹¡_ªd_ş—r_b™
(
Ä
, vŞ©*
addr
);

182 
shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
Ä
, *
addr
);

183 
shªnÚ_‹¡_b™
(
Ä
, cÚ¡ vŞ©*
addr
);

184 
shªnÚ_‹¡_b™_Ë
(
Ä
, cÚ¡ *
addr
);

185 
shªnÚ_£t_b™
(
Ä
, *
addr
);

186 
shªnÚ_£t_b™_Ë
(
Ä
, *
addr
);

187 
shªnÚ_ş—r_b™
(
Ä
, *
addr
);

191 
__shªnÚ_b™m­_xÜ
(*
d¡
, cÚ¡ *
b™m­1
, cÚ¡ *
b™m­2
, 
b™s
);

192 
__shªnÚ_b™m­_weight
(cÚ¡ *
b™m­
, 
b™s
);

193 
shªnÚ_hweight_lÚg
(
w
);

194 
shªnÚ_hweight32
(
w
);

195 
shªnÚ_g‘_couÁ_Üd”
(
couÁ
);

199 #iâdeà
__iomem


200 
	#__iomem


	)

203 #iâdeà
__u£r


204 
	#__u£r


	)

207 #iâdeà
__b™wi£__


208 
	#__b™wi£__


	)

211 
	sshªnÚ_pg´Ù
 { 
	mpg´Ù
; } 
	tshªnÚ_pg´Ù_t
;

212 
	#SHANNON_PAGE_KERNEL
 (*((
shªnÚ_pg´Ù_t
 *è&
PAGE_KERNEL
))

	)

214 
	t__b™wi£__
 
	tshªnÚ_gå_t
;

215 
	t__b™wi£__
 
	tshªnÚ_fmode_t
;

216 
	tshªnÚ_loff_t
;

217 
	tshªnÚ_size_t
;

218 
	tshªnÚ_ssize_t
;

219 
	tshªnÚ_mode_t
;

221 
u64
 
	tshªnÚ_phys_addr_t
;

222 
u64
 
	tshªnÚ_»sourû_size_t
;

223 
dma_addr_t
 
	tshªnÚ_dma_addr_t
;

226 
u32
 
shªnÚ_¿w_»adl
(cÚ¡ vŞ©
__iomem
 *
addr
);

227 
shªnÚ_¿w_wr™–
(
u32
 
v®ue
, vŞ©
__iomem
 *
addr
);

228 
u32
 
shªnÚ_»adl
(cÚ¡ vŞ©
__iomem
 *
addr
);

229 
u32
 
shªnÚ_iÜ—d32
(
__iomem
 *
addr
);

230 
shªnÚ_wr™–
(
u32
 
v®ue
, vŞ©
__iomem
 *
addr
);

231 
shªnÚ_iowr™e32
(
u32
 
v®ue
, 
__iomem
 *
addr
);

232 
u16
 
shªnÚ_mem_»adw
(vŞ©*
addr
);

233 
shªnÚ_mem_wr™ew
(
u16
 
v®ue
, *
addr
);

234 
shªnÚ_ıu_to_Ë16s
(*
addr
);

235 
u32
 
shªnÚ_mem_»adl
(vŞ©*
addr
);

236 
shªnÚ_mem_wr™–
(
u32
 
v®ue
, *
addr
);

237 
shªnÚ_ıu_to_Ë32s
(*
addr
);

238 
u32
 
shªnÚ_ıu_to_be32
(u32 
v®
);

239 
shªnÚ_ıu_to_Ë64s
(*
addr
);

240 
u64
 
shªnÚ_ıu_to_be64
(u64 
v®
);

241 
u64
 
shªnÚ_mem_»adq
(vŞ©*
addr
);

242 
shªnÚ_mem_wr™eq
(
u64
, *
addr
);

243 
__iomem
 *
shªnÚ_iÜem­
(
shªnÚ_phys_addr_t
 
off£t
, 
size
);

244 
shªnÚ_iounm­
(vŞ©
__iomem
 *
addr
);

245 
shªnÚ_memıy_äomio
(*
de¡
, *
sourû
, 
couÁ
);

248 
shªnÚ_cİy_äom_u£r
(*
to
, cÚ¡ 
__u£r
 * 
äom
, 
n
);

249 
shªnÚ_cİy_to_u£r
(
__u£r
 *
to
, cÚ¡ *
äom
, 
n
);

252 
shªnÚ_ä“_·ge
(
addr
);

253 
__shªnÚ_g‘_ä“_·ge
(
shªnÚ_gå_t
 
gå
);

256 
	tshªnÚ_·ge
;

257 *
shªnÚ_·ge_add»ss
(
shªnÚ_·ge
 *
·ge
);

258 *
shªnÚ_vœt_to_·ge
(cÚ¡ *
addr
);

261 *
shªnÚ_vz®loc
(
size
);

262 *
shªnÚ_vm®loc
(
size
);

263 
shªnÚ_vä“
(*
addr
);

266 
	tshªnÚ_kmem_ÿche_t
;

268 
shªnÚ_kmem_ÿche_t
 *
shªnÚ_kmem_ÿche_ü—‹
(cÚ¡ *, 
size_t
, size_t, , (*)(*));

269 
	`shªnÚ_kmem_ÿche_de¡roy
(
shªnÚ_kmem_ÿche_t
 *
ÿch•
);

270 *
	`shªnÚ_kz®loc
(
size_t
 
size
, 
shªnÚ_gå_t
 
æags
);

271 *
	`shªnÚ_km®loc
(
size_t
 
size
, 
shªnÚ_gå_t
 
æags
);

272 *
	`__shªnÚ_vm®loc
(
size
, 
shªnÚ_gå_t
 
gå_mask
, 
shªnÚ_pg´Ù_t
 
´Ù
);

273 
	`shªnÚ_kä“
(const *);

276 
	#GFP_SHANNON
 
GFP_NOIO


	)

277 
	tshªnÚ_mempoŞ_t
;

279 
shªnÚ_mempoŞ_t
 *
	`shªnÚ_mempoŞ_ü—‹_km®loc_poŞ
(
mš_Ä
, 
size_t
 
size
);

280 
shªnÚ_mempoŞ_t
 *
	`shªnÚ_mempoŞ_ü—‹_¦ab_poŞ
(
mš_Ä
, 
shªnÚ_kmem_ÿche_t
 *
kc
);

281 
	`shªnÚ_mempoŞ_de¡roy
(
shªnÚ_mempoŞ_t
 *
poŞ
);

282 *
	`shªnÚ_mempoŞ_®loc
(
shªnÚ_mempoŞ_t
 *
poŞ
, 
shªnÚ_gå_t
 
gå_mask
);

283 
	`shªnÚ_mempoŞ_ä“
(*
–em’t
, 
shªnÚ_mempoŞ_t
 *
poŞ
);

284 
	`g‘_mempoŞ_couÁ
(
shªnÚ_mempoŞ_t
 *
poŞ
);

289 *
	`shªnÚ_mem£t
(*
s
, 
c
, 
size_t
 
n
);

290 *
	`shªnÚ_memıy
(*
de¡
, cÚ¡ *
¤c
, 
size_t
 
couÁ
);

291 
	`shªnÚ_memcmp
(cÚ¡ *
cs
, cÚ¡ *
ù
, 
size_t
 
couÁ
);

292 
size_t
 
	`shªnÚ_¡ºËn
(cÚ¡ *
s
, size_ˆ
couÁ
);

295 #iâdeà
KERN_ERR


296 
	#KERN_EMERG
 "<0>"

	)

297 
	#KERN_ALERT
 "<1>"

	)

298 
	#KERN_CRIT
 "<2>"

	)

299 
	#KERN_ERR
 "<3>"

	)

300 
	#KERN_WARNING
 "<4>"

	)

301 
	#KERN_NOTICE
 "<5>"

	)

302 
	#KERN_INFO
 "<6>"

	)

303 
	#KERN_DEBUG
 "<7>"

	)

305 
	`shªnÚ_´štk
(cÚ¡ *
fmt
, ...);

306 
	`shªnÚ_´štk_¿‹lim™ed
(cÚ¡ *
fmt
, ...);

307 
	`shªnÚ_»cov”_´štk_¿‹lim™ed
(cÚ¡ *
fmt
, ...);

308 
shªnÚ_debug_Ëv–
;

309 
	#shªnÚ_dbg
(
Ëv–
, 
fÜm©
, 
¬g
...) \

311 ià(
Ëv–
 <ğ
shªnÚ_debug_Ëv–
) \

312 
	`shªnÚ_´štk
(
KERN_ERR
 "shn_dbg: %s(): " 
fÜm©
, 
__func__
, ##
¬g
); \

313 
	}
} 0)

	)

315 
	#debugs0
Ğ... ) 
	`shªnÚ_dbg
(0, 
__VA_ARGS__
 )

	)

316 
	#debugs1
Ğ... ) 
	`shªnÚ_dbg
(1, 
__VA_ARGS__
 )

	)

317 
	#debugs2
Ğ... ) 
	`shªnÚ_dbg
(2, 
__VA_ARGS__
 )

	)

318 
	#debugs3
Ğ... ) 
	`shªnÚ_dbg
(3, 
__VA_ARGS__
 )

	)

319 
	#debugs4
Ğ... ) 
	`shªnÚ_dbg
(4, 
__VA_ARGS__
 )

	)

321 
	#shªnÚ_šfo
(
fÜm©
, 
¬g
...) \

322 
	`shªnÚ_´štk_¿‹lim™ed
(
KERN_ERR
 "shn_šfo: " 
fÜm©
, ##
¬g
)

	)

323 
	#shªnÚ_»cov”_šfo
(
fÜm©
, 
¬g
...) \

324 
	`shªnÚ_»cov”_´štk_¿‹lim™ed
(
KERN_ERR
 "shn_šfo: " 
fÜm©
, ##
¬g
)

	)

325 
	#shªnÚ_log
(
fÜm©
, 
¬g
...) \

326 
	`shªnÚ_´štk_¿‹lim™ed
(
KERN_ERR
 "shn_log: " 
fÜm©
, ##
¬g
)

	)

327 
	#shªnÚ_w¬n
(
fÜm©
, 
¬g
...) \

328 
	`shªnÚ_´štk_¿‹lim™ed
(
KERN_ERR
 "shn_w¬n: %s(): " 
fÜm©
, 
__func__
, ##
¬g
)

	)

329 
	#shªnÚ_®¬m
(
fÜm©
, 
¬g
...) \

330 
	`shªnÚ_´štk
(
KERN_ERR
 "shn_®¬m: %s(): " 
fÜm©
, 
__func__
, ##
¬g
)

	)

331 
	#shªnÚ_”r
(
fÜm©
, 
¬g
...) \

332 
	`shªnÚ_´štk
(
KERN_ERR
 "shn_”r: %s(): " 
fÜm©
, 
__func__
, ##
¬g
)

	)

333 
	#shªnÚ_»cov”_”r
(
fÜm©
, 
¬g
...) \

334 
	`shªnÚ_»cov”_´štk_¿‹lim™ed
(
KERN_ERR
 "shn_”r: %s(): " 
fÜm©
, 
__func__
, ##
¬g
)

	)

335 
	#shªnÚ_çl
(
fÜm©
, 
¬g
...) \

336 
	`shªnÚ_´štk
(
KERN_ERR
 "shn_çl: %s(): " 
fÜm©
, 
__func__
, ##
¬g
)

	)

339 *
shªnÚ_ka¥rštf
(
shªnÚ_gå_t
 
gå
, cÚ¡ *
fmt
, ...);

340 
shªnÚ_¥rštf
(* 
buf
, cÚ¡ * 
fmt
, ...);

341 
shªnÚ_¢´štf
(* 
buf
, 
size_t
 
size
, cÚ¡ * 
fmt
, ...);

342 
shªnÚ_dump_¡ack
();

343 
shªnÚ_sim¶e_¡¹Ş
(cÚ¡ *
ı
, **
’dp
, 
ba£
);

344 
shªnÚ_´štk_¿‹lim™
();

347 
g‘_num_Úlše_ıus
();

350 
	#SHANNON_PM_QOS_CPU_DMA_LATENCY
 1

	)

351 
	#SHANNON_PM_QOS_DEFAULT_VALUE
 -1

	)

353 *
	tshªnÚ_pm_qos_»que¡_t
;

355 
shªnÚ_pm_qos_add_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
v®ue
);

356 
shªnÚ_pm_qos_upd©e_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
, 
s32
 
Ãw_v®ue
);

357 
shªnÚ_pm_qos_»move_»quœem’t
(
shªnÚ_pm_qos_»que¡_t
 *
l
, 
qos
, *
Çme
);

358 
shªnÚ_pm_qos_is_»quœed
(
qos
);

361 *
SHANNON_ERR_PTR
(
”rÜ
);

362 
SHANNON_IS_ERR
(cÚ¡ *
±r
);

363 
SHANNON_PTR_ERR
(cÚ¡ *
±r
);

364 
SHANNON_IS_ERR_OR_NULL
(cÚ¡ *
±r
);

367 
size_t
 
shªnÚ_¡¾’
(cÚ¡ *
s
);

370 
shªnÚ_g‘_¿ndom_by‹s
(*
buf
, 
by‹s
);

373 
shªnÚ_´eãtch
(*
addr
);

374 
shªnÚ_´eãtchw
(*
addr
);

375 
shªnÚ_¥š_lock_´eãtch
(*
addr
);

380 
	tshªnÚ_deviû_t
;

381 
	tshªnÚ_pci_dev_t
;

382 
	tshªnÚ_pci_deviû_id_t
;

383 
	tshªnÚ_msix_’Œy_t
;

385 #ifdeà
CONFIG_X86


386 
	#shªnÚ_b¬r›r
(è
asm
 vŞ©e("mãnû":::"memÜy")

	)

388 
	#shªnÚ_b¬r›r
(è
	`b¬r›r
()

	)

	@shannon_list.h

1 #iâdeà
__SHANNON_LIST_H


2 
	#__SHANNON_LIST_H


	)

4 
	sshªnÚ_li¡_h—d
 {

5 
shªnÚ_li¡_h—d
 *
	mÃxt
, *
	m´ev
;

8 
	#SHANNON_LIST_HEAD_INIT
(
Çme
è{ &Òame), &Òameè}

	)

10 
šlše
 
	$SHANNON_INIT_LIST_HEAD
(
shªnÚ_li¡_h—d
 *
li¡
)

12 
li¡
->
Ãxt
 =†ist;

13 
li¡
->
´ev
 =†ist;

14 
	}
}

17 
šlše
 
	$__shªnÚ_li¡_add
(
shªnÚ_li¡_h—d
 *
Ãw
,

18 
shªnÚ_li¡_h—d
 *
´ev
,

19 
shªnÚ_li¡_h—d
 *
Ãxt
)

21 
Ãxt
->
´ev
 = 
Ãw
;

22 
Ãw
->
Ãxt
 =‚ext;

23 
Ãw
->
´ev
 =…rev;

24 
´ev
->
Ãxt
 = 
Ãw
;

25 
	}
}

28 
šlše
 
	$shªnÚ_li¡_add
(
shªnÚ_li¡_h—d
 *
Ãw
, shªnÚ_li¡_h—d *
h—d
)

30 
	`__shªnÚ_li¡_add
(
Ãw
, 
h—d
, h—d->
Ãxt
);

31 
	}
}

34 
šlše
 
	$shªnÚ_li¡_add_
(
shªnÚ_li¡_h—d
 *
Ãw
, shªnÚ_li¡_h—d *
h—d
)

36 
	`__shªnÚ_li¡_add
(
Ãw
, 
h—d
->
´ev
, head);

37 
	}
}

39 
šlše
 
	$__shªnÚ_li¡_d–
(
shªnÚ_li¡_h—d
 * 
´ev
, shªnÚ_li¡_h—d * 
Ãxt
)

41 
Ãxt
->
´ev
 =…rev;

42 
´ev
->
Ãxt
 =‚ext;

43 
	}
}

45 
šlše
 
	$__shªnÚ_li¡_d–_’Œy
(
shªnÚ_li¡_h—d
 *
’Œy
)

47 
	`__shªnÚ_li¡_d–
(
’Œy
->
´ev
,ƒÁry->
Ãxt
);

48 
	}
}

50 
šlše
 
	$shªnÚ_li¡_d–
(
shªnÚ_li¡_h—d
 *
’Œy
)

52 
	`__shªnÚ_li¡_d–
(
’Œy
->
´ev
,ƒÁry->
Ãxt
);

53 
	`SHANNON_INIT_LIST_HEAD
(
’Œy
);

54 
	}
}

56 
šlše
 
	$shªnÚ_li¡_d–_š™
(
shªnÚ_li¡_h—d
 *
’Œy
)

58 
	`__shªnÚ_li¡_d–_’Œy
(
’Œy
);

59 
	`SHANNON_INIT_LIST_HEAD
(
’Œy
);

60 
	}
}

62 
šlše
 
	$shªnÚ_li¡_em±y
(cÚ¡ 
shªnÚ_li¡_h—d
 *
h—d
)

64  
h—d
->
Ãxt
 == head;

65 
	}
}

67 
šlše
 
	$shªnÚ_li¡_em±y_ÿ»ful
(cÚ¡ 
shªnÚ_li¡_h—d
 *
h—d
)

69 
shªnÚ_li¡_h—d
 *
Ãxt
 = 
h—d
->next;

70  (
Ãxt
 =ğ
h—d
è&& (Ãxˆ=ğh—d->
´ev
);

71 
	}
}

74 
	#shªnÚ_li¡_’Œy
(
±r
, 
ty³
, 
memb”
) \

75 
	`cÚš”_of
(
±r
, 
ty³
, 
memb”
)

	)

77 
	#shªnÚ_li¡_fœ¡_’Œy
(
±r
, 
ty³
, 
memb”
) \

78 
	`shªnÚ_li¡_’Œy
((
±r
)->
Ãxt
, 
ty³
, 
memb”
)

	)

80 
	#shªnÚ_li¡_fÜ_—ch
(
pos
, 
h—d
) \

81 
pos
 = (
h—d
)->
Ãxt
;…o !ğ(h—d);…o ğpos->Ãxt)

	)

83 
	#shªnÚ_li¡_fÜ_—ch_’Œy
(
pos
, 
h—d
, 
memb”
) \

84 
pos
 = 
	`shªnÚ_li¡_’Œy
((
h—d
)->
Ãxt
, 
	`ty³of
(*pos), 
memb”
); \

85 &
pos
->
memb”
 !ğ(
h—d
); \

86 
pos
 = 
	`shªnÚ_li¡_’Œy
Õos->
memb”
.
Ãxt
, 
	`ty³of
(*pos), memb”))

	)

88 
	#shªnÚ_li¡_fÜ_—ch_’Œy_»v”£
(
pos
, 
h—d
, 
memb”
) \

89 
pos
 = 
	`shªnÚ_li¡_’Œy
((
h—d
)->
´ev
, 
	`ty³of
(*pos), 
memb”
); \

90 &
pos
->
memb”
 !ğ(
h—d
); \

91 
pos
 = 
	`shªnÚ_li¡_’Œy
Õos->
memb”
.
´ev
, 
	`ty³of
(*pos), memb”))

	)

93 
	#shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
pos
, 
n
, 
h—d
, 
memb”
) \

94 
pos
 = 
	`shªnÚ_li¡_’Œy
((
h—d
)->
Ãxt
, 
	`ty³of
(*pos), 
memb”
), \

95 
n
 = 
	`shªnÚ_li¡_’Œy
(
pos
->
memb”
.
Ãxt
, 
	`ty³of
(*pos), member); \

96 &
pos
->
memb”
 !ğ(
h—d
); \

97 
pos
 = 
n
,‚ = 
	`shªnÚ_li¡_’Œy
Ò->
memb”
.
Ãxt
, 
	`ty³of
(*n), memb”))

	)

	@shannon_main.c

12 
	~"shªnÚ_»gs.h
"

13 
	~"shªnÚ.h
"

14 
	~"shªnÚ_ioùl.h
"

16 
	#SHANNON_MINORS
 64

	)

18 
	gshªnÚ_majÜ
;

19 
	gshªnÚ_auto_©ch
 = 1;

20 
	gshªnÚ_bufãr_wr™e
 = 0;

21 
	gshªnÚ_di§bË_š‹rv–_»äesh_mbr
 = 0;

22 
	gshªnÚ_Ãv”_hªg
 = 0;

23 
	gshªnÚ_high_³rfÜmªû
 = 0;

24 
	gshªnÚ_š™_‹mp
 = 
INIT_STATE
;

25 
	gshªnÚ_do_pci_»£t
 = 0;

26 
	gshªnÚ_pŞl_times
 = 8;

27 
	gshªnÚ_do_¢­»ad
 = 1;

28 
	gshªnÚ_memblock_´—Îoc
 = 0;

29 
	gshªnÚ_max_commªd_timeout
 = 10;

30 
	gshªnÚ_fÜû_»şaim_aùiveblock
 = 1;

31 
	gshªnÚ_dyÇmic_œq_d–ay
 = 1;

32 
	gshªnÚ_lßd_»adÚly
 = 0;

34 
	gecc_fÜû_£cÚd_»que¡
 = 0;

35 
	gshªnÚ_ov”Ïp_wr™e
 = 0;

37 
shªnÚ_memblock_poŞ
 
	gm­_bË_poŞ
;

38 
shªnÚ_memblock_poŞ
 
	g‹mp_bË_poŞ
;

39 
	gdeviû_b™m­
;

40 
shªnÚ_¥šlock_t
 
	gdeviû_b™m­_lock
;

41 
	gshªnÚ_debug_Ëv–
 = 0;

42 
	gshªnÚ_£ùÜ_size
 = 0;

43 
	gshªnÚ_fÜû_rw
 = 0;

44 
	gshªnÚ_u£_¹_comp_th»ad
 = 0;

45 
	gshªnÚ_v’dÜ_cmd
 = 1;

46 
	gshªnÚ_´eãtch_’abË
 = 1;

47 
shªnÚ_pm_qos_v®ue
;

49 
has_dma_d–ay
;

51 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

52 
u64
 
	gemu_š‹¼u±_veùÜ
 = 0;

53 
	gemu_di§bË_œq
 = 0;

54 
DEFINE_SPINLOCK
(
emu_št_lock
);

56 
sk_¡ruù
 *
	g´eš™_emu_th»ad
;

59 
	gaùive_blk_¡©e
[2] = {
HOT_ACTIVE_BLOCK
, 
COLD_ACTIVE_BLOCK
};

60 
	gÏ¡_blk_¡©e
[2] = {
LAST_HOT_BLOCK
, 
LAST_COLD_BLOCK
};

61 
	gÃxt_blk_¡©e
[2] = {
NEXT_HOT_BLOCK
, 
NEXT_COLD_BLOCK
};

62 
	gu£d_blk_¡©e
[2] = {
HOT_BLOCK_LIST
, 
COLD_BLOCK_LIST
};

63 
	gwr™e_h—d
[2] = {
HOT_HEAD
, 
COLD_HEAD
};

64 
u8
 
	glba_ty³
[2] = {
SHORT_LBA
, 
LONG_LBA
};

65 
u64
 
	gšv®id_lba
[2] = {
INVALID_LBA
, 
LONG_INVALID_LBA
};

66 
u64
 
	gšv®id_m‘ad©a
[2] = {(
INVALID_LBA
 | (
SHORT_LBA
 << 
DATATYPE_SHIFT
)), \

67 (
LONG_INVALID_LBA
 | (
LONG_LBA
 << 
DATATYPE_SHIFT
))};

69 
shªnÚ_kmem_ÿche_t
 *
	gshªnÚ_»q_¦ab
;

70 
shªnÚ_kmem_ÿche_t
 *
	gshªnÚ_bio_¦ab
;

71 
shªnÚ_mempoŞ_t
 *
	gshªnÚ_»q_poŞ
;

72 
shªnÚ_mempoŞ_t
 *
	gshªnÚ_bio_poŞ
;

73 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


74 
shªnÚ_li¡_h—d
 
	gout¡ªdšg_»qs_li¡
;

75 
shªnÚ_¥šlock_t
 
	gout¡ªdšg_»qs_li¡_lock
;

76 
shªnÚ_li¡_h—d
 
	gout¡ªdšg_sbios_li¡
;

77 
shªnÚ_¥šlock_t
 
	gout¡ªdšg_sbios_li¡_lock
;

80 
	~"shªnÚ_miüocode.c
"

81 
	#GENERAL_CFG
(
t_addr
, 
t_v®ue
è{.
v®id
 = 
FEATURE_VALID_MASK
, .
addr
 = (t_addr), .
cmd
 = 0xEF, .
£cÚd¬y_cmd
 = 0, .
misc
 = 0, .
nby‹
 = 1, \

82 .
d©a
[0] = (
t_v®ue
è& 0xFF}

	)

83 
	#GENERAL_CFG_2
(
t_addr
, 
t_v®ue
è{.
v®id
 = 
FEATURE_VALID_MASK
, .
addr
 = (t_addr), .
cmd
 = 0xEF, .
£cÚd¬y_cmd
 = 0, .
misc
 = 0, .
nby‹
 = 2, \

84 .
d©a
[0] = (
t_v®ue
è& 0xFF, .d©a[1] = (t_v®u>> 8è& 0xFF}

	)

85 
	#GENERAL_CFG_3
(
t_addr
, 
t_v®ue
è{.
v®id
 = 
FEATURE_VALID_MASK
, .
addr
 = (t_addr), .
cmd
 = 0xEF, .
£cÚd¬y_cmd
 = 0, .
misc
 = 0, .
nby‹
 = 3, \

86 .
d©a
[0] = (
t_v®ue
è& 0xFF, .d©a[1] = (t_v®u>> 8è& 0xFF, .d©a[2] = (t_v®u>> 16è& 0xFF}

	)

87 
	#GENERAL_CFG_4
(
t_addr
, 
t_v®ue
è{.
v®id
 = 
FEATURE_VALID_MASK
, .
addr
 = (t_addr), .
cmd
 = 0xEF, .
£cÚd¬y_cmd
 = 0, .
misc
 = 0, .
nby‹
 = 4, \

88 .
d©a
[0] = (
t_v®ue
è& 0xFF, .d©a[1] = (t_v®u>> 8è& 0xFF, .d©a[2] = (t_v®u>> 16è& 0xFF, .d©a[3] = (t_v®u>> 24è& 0xFF}

	)

89 
	#GENERAL_CFG_INVALID
 {.
v®id
 = 
FEATURE_INVALID
}

	)

90 
	#g‘_ã©u»_cfg_v®id
(
_cfg
è((_cfg)->
v®id
 & 
FEATURE_VALID_MASK
)

	)

91 
	#g‘_ã©u»_cfg_®l_´io
(
_cfg
è((_cfg)->
v®id
 & 
FEATURE_PRIORITY_MASK
)

	)

92 
	#£t_ã©u»_cfg_®l_´io
(
_cfg
) { \

93 if((
_cfg
)->
v®id
 & 
FEATURE_VALID_MASK
) \

94 (
_cfg
)->
v®id
 |ğ
FEATURE_PRIORITY_MASK
; \

95 }

	)

96 
	#ş—n_ã©u»_cfg_®l_´io
(
_cfg
è((_cfg)->
v®id
 &ğ~
FEATURE_PRIORITY_MASK
)

	)

99 
u64
 
	mæashid
;

101 
	#ONFI_ASYNC_MODE
 0

	)

102 
	#TOGGLE_MODE
 1

	)

103 
	#ONFI_SYNC_MODE
 3

	)

104 
	mifmode
;

105 
	mov”drive
;

107 
	#FREQ_NORMAL
 0

	)

108 
	#FREQ_TURBO
 1

	)

109 
	mäeq_mode
;

111 
	mmiüocode_Ëngth
;

112 
u32
 *
	mmiüocode_bË
;

113 
	msh¬ed_·ges
;

114 
ã©u»_cfg
 
	mã©u»_cfg_li¡
[
FEATURE_CFG_LIST_SIZE
];

115 } 
	gsuµÜ‹d_ids
[] = {

118 {0x1a9cb05a82c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 0, 
NULL
, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

120 {0x000004882c, 
ONFI_SYNC_MODE
, 0, 
FREQ_TURBO
, 0, 
NULL
, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

122 {0x04a53c64642c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

124 {0x04a53û5842c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

126 {0xa9cb05a82c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 0, 
NULL
, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

128 {0xa53c64842c, 
ONFI_SYNC_MODE
, 0, 
FREQ_TURBO
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

130 {0x04a93c64842c, 
ONFI_SYNC_MODE
, 0, 
FREQ_TURBO
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

132 {0x04a93û5a42c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

133 {0xa53û5a42c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

135 {0xa954e5a42c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

137 {0xa95464842c, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
miüÚ_19_miüocode_bË
), miüÚ_19_miüocode_bË, 6, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

142 {0xa94b248889, 
ONFI_SYNC_MODE
, 0, 
FREQ_TURBO
, 0, 
NULL
, 3, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

144 {0xa9cb25a889, 
ONFI_SYNC_MODE
, 0, 
FREQ_NORMAL
, 0, 
NULL
, 3, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x00), 
GENERAL_CFG_INVALID
}},

147 {0x000010d«c, 
ONFI_SYNC_MODE
, 2, 
FREQ_NORMAL
, 0, 
NULL
, 3, {
GENERAL_CFG
(0x01, 0x15), GENERAL_CFG(0x10, 0x02), 
GENERAL_CFG_INVALID
}},

149 {0x1«cc46c7«51«c, 
TOGGLE_MODE
, 4, 
FREQ_NORMAL
, 0, 
NULL
, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x04), 
GENERAL_CFG_INVALID
}},

152 {0x0408d77a93953a98, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
toshiba_19_miüocode_bË
),oshiba_19_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

153 {0x0c08d77a93953a98, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
toshiba_19_miüocode_bË
),oshiba_19_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

155 {0x0408d07a93953a98, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
toshiba_a19_miüocode_bË
),oshiba_a19_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

157 {0x0408d07e93a53c98, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
toshiba_a19_128gb_miüocode_bË
),oshiba_a19_128gb_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

159 {0x0408d7769394de98, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
toshiba_19_miüocode_bË
),oshiba_19_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

161 {0x0408d0769394de98, 
TOGGLE_MODE
, 6, 
FREQ_TURBO
, 
ARRAY_SIZE
(
toshiba_a19_miüocode_bË
),oshiba_a19_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

163 {0x0408d17693943a98, 
TOGGLE_MODE
, 6, 
FREQ_TURBO
, 
ARRAY_SIZE
(
toshiba_15_miüocode_bË
),oshiba_15_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

165 {0x0408d17a93953c98, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
toshiba_15_miüocode_bË
),oshiba_15_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

167 {0x040A517693943a45, 
TOGGLE_MODE
, 6, 
FREQ_TURBO
, 
ARRAY_SIZE
(
§ndisk_15_miüocode_bË
), sªdisk_15_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

169 {0x040A517a93953c45, 
TOGGLE_MODE
, 6, 
FREQ_NORMAL
, 
ARRAY_SIZE
(
§ndisk_15_miüocode_bË
), sªdisk_15_miüocode_bË, 3, {
GENERAL_CFG
(0x80, 0x00), GENERAL_CFG(0x10, 0x06), 
GENERAL_CFG_INVALID
}},

172 
	$dev_is_8639_w™h_§ndisk
(
shªnÚ_dev
 *
sdev
)

174 ià(((
sdev
->
æashid
 == 0x040A517693943a45) || (sdev->flashid == 0x040A517a93953c45)) && \

175 
	`dev_is_8639
(
sdev
->
pci_dev
))

179 
	}
}

181 
	$phy_lun_to_logiÿl_lun_0
(
shªnÚ_dev
 *
sdev
, 
phy_lun
)

183 
lun_id
, 
lun£t_id
, 
chªÃl_id
;

185 
chªÃl_id
 = 
phy_lun
 / 
sdev
->
max_lun£t_š_chªÃl
 / sdev->
max_lun_š_lun£t
;

186 
lun_id
 = 
phy_lun
 % 
sdev
->
max_lun_š_lun£t
;

187 
lun£t_id
 = 
phy_lun
 / 
sdev
->
max_lun_š_lun£t
 % sdev->
max_lun£t_š_chªÃl
;

189  
chªÃl_id
 + 
lun£t_id
 * 
sdev
->
cfg_chªÃls
 * sdev->
cfg_lun_š_lun£t
 + 
lun_id
 * sdev->cfg_channels;

190 
	}
}

192 
	$logiÿl_lun_to_phy_lun_0
(
shªnÚ_dev
 *
sdev
, 
logiÿl_lun
)

194 
lun_id
, 
lun£t_id
, 
chªÃl_id
;

196 
chªÃl_id
 = 
logiÿl_lun
 % 
sdev
->
cfg_chªÃls
;

197 
lun_id
 = (
logiÿl_lun
 / 
sdev
->
cfg_chªÃls
è% sdev->
cfg_lun_š_lun£t
;

198 
lun£t_id
 = (
logiÿl_lun
 / 
sdev
->
cfg_chªÃls
è/ sdev->
cfg_lun_š_lun£t
;

200  
chªÃl_id
 * 
sdev
->
max_lun£t_š_chªÃl
 * sdev->
max_lun_š_lun£t
 + 
lun£t_id
 * sdev->max_lun_š_lun£ˆ+ 
lun_id
;

201 
	}
}

203 
	$phy_lun_to_logiÿl_lun_1
(
shªnÚ_dev
 *
sdev
, 
phy_lun
)

205 
lun_id
, 
lun£t_id
, 
chªÃl_id
;

207 
chªÃl_id
 = 
phy_lun
 / 
sdev
->
max_lun£t_š_chªÃl
 / sdev->
max_lun_š_lun£t
;

208 
lun_id
 = 
phy_lun
 % 
sdev
->
max_lun_š_lun£t
;

209 
lun£t_id
 = 
phy_lun
 / 
sdev
->
max_lun_š_lun£t
 % sdev->
max_lun£t_š_chªÃl
;

211  
chªÃl_id
 + 
lun£t_id
 * 
sdev
->
cfg_chªÃls
 + 
lun_id
 * sdev->cfg_chªÃl * sdev->
cfg_lun£t_š_chªÃl
;

212 
	}
}

214 
	$logiÿl_lun_to_phy_lun_1
(
shªnÚ_dev
 *
sdev
, 
logiÿl_lun
)

216 
lun_id
, 
lun£t_id
, 
chªÃl_id
;

218 
chªÃl_id
 = 
logiÿl_lun
 % 
sdev
->
cfg_chªÃls
;

219 
lun£t_id
 = (
logiÿl_lun
 / 
sdev
->
cfg_chªÃls
è% sdev->
cfg_lun£t_š_chªÃl
;

220 
lun_id
 = (
logiÿl_lun
 / 
sdev
->
cfg_chªÃls
è/ sdev->
cfg_lun£t_š_chªÃl
;

222  
chªÃl_id
 * 
sdev
->
max_lun£t_š_chªÃl
 * sdev->
max_lun_š_lun£t
 + 
lun£t_id
 * sdev->max_lun_š_lun£ˆ+ 
lun_id
;

223 
	}
}

225 
	#MAX_LUN_MAP_MODE
 2

	)

226 (*
phy_lun_to_logiÿl_lun
[
MAX_LUN_MAP_MODE
])(
shªnÚ_dev
 *, èğ{
phy_lun_to_logiÿl_lun_0
, 
phy_lun_to_logiÿl_lun_1
};

227 (*
logiÿl_lun_to_phy_lun
[
MAX_LUN_MAP_MODE
])(
shªnÚ_dev
 *, èğ{
logiÿl_lun_to_phy_lun_0
, 
logiÿl_lun_to_phy_lun_1
};

229 *
	$g‘_shªnÚ_dev_äom_li¡
(
shªnÚ_li¡_h—d
 *
li¡
)

231  
	`cÚš”_of
(
li¡
, 
shªnÚ_dev
,†ist);

232 
	}
}

234 *
	$g‘_miscdeviû_äom_shªnÚ_dev
(
shªnÚ_dev
 *
sdev
)

236  &
sdev
->
misc
;

237 
	}
}

239 *
	$®loc_logicb_buf
(
shªnÚ_dev
 *
sdev
, 
gå_t
 
gå_mask
)

241 *
addr
;

242 
»Œy
:

243 
addr
 = 
	`shªnÚ_mempoŞ_®loc
(
sdev
->
logicb_buf_poŞ
, 
gå_mask
|
__GFP_NORETRY
);

244 ià(
	`uÆik–y
(!
addr
)) {

245 
	`shªnÚ_w¬n
("®loÿ‹†ogicb_buàçed! mode=0x%x\n", 
gå_mask
);

246 ià(
gå_mask
 & 
GFP_SHANNON
)

247 
	`shªnÚ_m¦“p
(1);

249 
gå_mask
 |ğ
GFP_ATOMIC
;

250 
»Œy
;

252 
	`shªnÚ_©omic_šc
(&
sdev
->
logicb_buf_couÁ
);

253 
	`shªnÚ_mem£t
(
addr
, 0, 
sdev
->
logicb_size
);

254  
addr
;

255 
	}
}

257 
	$ä“_logicb_buf
(
shªnÚ_dev
 *
sdev
, *
addr
)

259 
	`shªnÚ_©omic_dec
(&
sdev
->
logicb_buf_couÁ
);

260 
	`shªnÚ_mempoŞ_ä“
(
addr
, 
sdev
->
logicb_buf_poŞ
);

261 
	}
}

263 
shªnÚ_»que¡
 *
	$®loc_»q
(
gå_t
 
gå_mask
)

265 
shªnÚ_»que¡
 *
»q
;

266 
»Œy
:

267 
»q
 = 
	`shªnÚ_mempoŞ_®loc
(
shªnÚ_»q_poŞ
, 
gå_mask
);

268 ià(
	`uÆik–y
(!
»q
)) {

269 
	`shªnÚ_w¬n
("®loÿ‹ shªnÚ_»q fa! mode=0x%x\n", 
gå_mask
);

270 
gå_mask
 |ğ
GFP_ATOMIC
;

271 
»Œy
;

273 
	`shªnÚ_mem£t
(
»q
, 0, (*req));

274 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


275 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
debug_li¡
);

276 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

277 
	`shªnÚ_li¡_add_
(&
»q
->
debug_li¡
, &
out¡ªdšg_»qs_li¡
);

278 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

280  
»q
;

281 
	}
}

283 
	$ä“_»q
(
shªnÚ_»que¡
 *
»q
)

285 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


286 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

287 
	`shªnÚ_li¡_d–
(&
»q
->
debug_li¡
);

288 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

290 
	`shªnÚ_mempoŞ_ä“
(
»q
, 
shªnÚ_»q_poŞ
);

291 
	}
}

293 
shªnÚ_bio
 *
	$®loc_sbio
(
gå_t
 
gå_mask
)

295 
shªnÚ_bio
 *
sbio
;

296 
»Œy
:

297 
sbio
 = 
	`shªnÚ_mempoŞ_®loc
(
shªnÚ_bio_poŞ
, 
gå_mask
);

298 ià(
	`uÆik–y
(!
sbio
)) {

299 
	`shªnÚ_w¬n
("®loÿ‹ shªnÚ_biØç! mode=0x%x\n", 
gå_mask
);

300 
gå_mask
 |ğ
GFP_ATOMIC
;

301 
»Œy
;

303 
	`shªnÚ_mem£t
(
sbio
, 0, (*sbio));

304 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 0);

305 
	`SHANNON_INIT_LIST_HEAD
(&
sbio
->
»q_li¡
);

306 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


307 
	`SHANNON_INIT_LIST_HEAD
(&
sbio
->
debug_li¡
);

308 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

309 
	`shªnÚ_li¡_add_
(&
sbio
->
debug_li¡
, &
out¡ªdšg_sbios_li¡
);

310 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

312  
sbio
;

313 
	}
}

315 
	$ä“_sbio
(
shªnÚ_bio
 *
sbio
)

317 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


318 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

319 
	`shªnÚ_li¡_d–
(&
sbio
->
debug_li¡
);

320 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

322 
	`shªnÚ_mempoŞ_ä“
(
sbio
, 
shªnÚ_bio_poŞ
);

323 
	}
}

325 
	$»cÜd_Ï‹ncy
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
)

327 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
»cÜd_Ï‹ncy_lock
);

328 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

329 ià(
sbio
->
Ï‹ncy
 > 
sdisk
->
max_bio_wr™e_Ï‹ncy
)

330 
sdisk
->
max_bio_wr™e_Ï‹ncy
 = 
sbio
->
Ï‹ncy
;

332 ià(
sbio
->
Ï‹ncy
 > 
sdisk
->
max_bio_»ad_Ï‹ncy
)

333 
sdisk
->
max_bio_»ad_Ï‹ncy
 = 
sbio
->
Ï‹ncy
;

335 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
»cÜd_Ï‹ncy_lock
);

336 
	}
}

338 
u64
 
	$g‘_shªnÚ_dev_£ùÜs
(
shªnÚ_dev
 *
dev
)

340  
dev
->
sdisk
.
£ùÜs
;

341 
	}
}

343 
	$sh_šü—£_u£rs
(
shªnÚ_dev
 *
dev
)

345 ià(
	`uÆik–y
(
dev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
)) {

346 
	`shªnÚ_”r
("FaedØİ’ Dœeù-IO PCIFÏsh /dev/% (¡©e=ERROR),…Ëa£„efÜm©.\n", 
dev
->
sdisk
.
disk_Çme
);

347  -
EBUSY
;

350 
	`shªnÚ_©omic_šc
(&
dev
->
u£rs
);

351 
	`shªnÚ_b¬r›r
();

353 
	}
}

355 
	$sdev_®loc_dummy_·ge
(
shªnÚ_dev
 *
sdev
)

357 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

358 
sdev
->
dummy_·ge
 = 
	`shªnÚ_km®loc
(sdev->
Çnd_·ge_size
, 
GFP_SHANNON
);

359 
sdev
->
dummy_dma_·ge
 = (
dma_addr_t
)sdev->
dummy_·ge
;

361 
sdev
->
dummy_·ge
 = 
	`shªnÚ_pci_®loc_cÚsi¡’t
(sdev->
pci_dev
, sdev->
Çnd_·ge_size
, &sdev->
dummy_dma_·ge
);

364 ià(!
sdev
->
dummy_·ge
) {

365 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for dummy_page.\n");

368 
	`shªnÚ_mem£t
(
sdev
->
dummy_·ge
, 0, sdev->
Çnd_·ge_size
);

371 
	}
}

373 
	$sdev_ä“_dummy_·ge
(
shªnÚ_dev
 *
sdev
)

375 #ià
	`defšed
(
CONFIG_SHANNON_EMU
)||defšed(
CONFIG_SHANNON_EMU_MODULE
)

376 ià(
sdev
->
dummy_·ge
)

377 
	`shªnÚ_kä“
(
sdev
->
dummy_·ge
);

379 ià(
sdev
->
dummy_·ge
)

380 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, sdev->
Çnd_·ge_size
, sdev->
dummy_·ge
, sdev->
dummy_dma_·ge
);

382 
	}
}

384 
	$ä“_miüocode_¬¿y
(
shªnÚ_dev
 *
sdev
)

386 
i
;

388 
i
 = 0; i < 
MICROCODE_ARRAY_SIZE
; i++) {

389 ià((
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 & 
MICROCODE_VALID_MASK
) && \

390 (
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 & 
MICROCODE_FROM_NOR_MASK
)) {

391 ià(
sdev
->
miüocode_¬¿y
[
i
].
bË
 !ğ
NULL
) {

392 
	`shªnÚ_kä“
(
sdev
->
miüocode_¬¿y
[
i
].
bË
);

393 
sdev
->
miüocode_¬¿y
[
i
].
bË
 = 
NULL
;

395 
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 = 
MICROCODE_INVALID
;

398 
	}
}

400 
	$sh_deü—£_u£rs
(
shªnÚ_dev
 *
dev
)

402 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
dev
->
u£rs
)) {

403 
	`shªnÚ_¥š_lock_bh
(&
deviû_b™m­_lock
);

404 
	`shªnÚ_ş—r_b™
(
dev
->
drive_no
, &
deviû_b™m­
);

405 
	`shªnÚ_li¡_d–
(&
dev
->
li¡
);

406 
	`shªnÚ_¥š_uÆock_bh
(&
deviû_b™m­_lock
);

408 ià(
dev
->
nÜ_mbr_¡©us
 & 
MICROCODE_FROM_NORFLASH
)

409 
	`ä“_miüocode_¬¿y
(
dev
);

410 ià(
dev
->
£ùÜs_codewÜd_addr
) {

411 
	`shªnÚ_kä“
(
dev
->
£ùÜs_codewÜd_addr
);

412 
dev
->
£ùÜs_codewÜd_addr
 = 
NULL
;

414 
	`shªnÚ_kä“
(
dev
);

418 
	}
}

420 
	$upd©e_lun£t_sq_h—d
(
shªnÚ_lun£t
 *
lun£t
)

422 ià(
lun£t
->
sq_h—d
 !ğlun£t->
sq_hw_h—d
) {

423 
	`shªnÚ_¥š_lock_bh
(&
lun£t
->
lun_b¬_lock
);

424 
	`shªnÚ_£t_b™
(
lun£t
->
šdex
,†un£t->
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
);

425 
lun£t
->
sq_hw_h—d
 =†un£t->
sq_h—d
;

426 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

427 
	`shªnÚ_wake_up
(&
lun£t
->
emu_wa™
);

429 
	`wr™e_»g_§ã
(
lun£t
->
sdev
,†un£t->
sq_h—d
, &lun£t->
lun_b¬
->sq_head);

431 
	`shªnÚ_¥š_uÆock_bh
(&
lun£t
->
lun_b¬_lock
);

433 
	}
}

439 
	$®loc_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
couÁ
)

441 
»t
 = -
EBUSY
;

442 
cq_
 = 
lun£t
->cq_tail;

446 ià(
cq_
 =ğ
lun£t
->
sq_h—d_tmp
) {

447 
»t
 = 
lun£t
->
sq_h—d_tmp
;

448 
lun£t
->
sq_h—d_tmp
 = (lun£t->sq_h—d_tm°+ (
couÁ
 << 3)è% 
QUEUE_SIZE
;

449 
out
;

452 ià(((
cq_
 + 
QUEUE_SIZE
è- 
lun£t
->
sq_h—d_tmp
è% QUEUE_SIZE <ğ(
couÁ
 << 3)) {

453 
out
;

455 
»t
 = 
lun£t
->
sq_h—d_tmp
;

456 
lun£t
->
sq_h—d_tmp
 = (lun£t->sq_h—d_tm°+ (
couÁ
 << 3)è% 
QUEUE_SIZE
;

457 
out
;

459 
out
:

460  
»t
;

461 
	}
}

463 
	#COMP_QUEUE_FILL
 0xFAFAFAFAFAFAFAFAUL

	)

464 
	$ş—r_commªd_queue
(
u64
 *
addr
, 
off£t
, 
couÁ
, u64 
v®ue
)

466 
i
;

467 
u64
 *
cmd
;

469 
i
 = 0; i < 
couÁ
; i++) {

470 
cmd
 = 
addr
 + (
off£t
 >> 3);

471 *
cmd
 = 
v®ue
;

472 
off£t
 += 8;

473 ià(
off£t
 =ğ
QUEUE_SIZE
)

474 
off£t
 = 0;

476 
	}
}

483 
	$®loc_cmd_¦“·bË
(
shªnÚ_lun£t
 *
lun£t
, 
couÁ
)

485 
cmd_off£t
;

487 
	`shªnÚ_wa™_ev’t
(
lun£t
->
wa™_cmd_pos
, (
cmd_off£t
 = 
	`®loc_cmd
Öun£t, 
couÁ
)) >= 0);

488 ià(
	`uÆik–y
(
cmd_off£t
 < 0))

489  -
EINTR
;

490 
	`ş—r_commªd_queue
((
u64
 *)
lun£t
->
sq_addr
, 
cmd_off£t
, 
couÁ
, 0);

491 ià(
has_dma_d–ay
)

492 
	`ş—r_commªd_queue
((
u64
 *)
lun£t
->
cq_addr
, 
cmd_off£t
, 
couÁ
, 
COMP_QUEUE_FILL
);

494  
cmd_off£t
;

495 
	}
}

498 *
	$cmd_queue_šc
(*
pošt
, 
couÁ
)

500 
__u64
 
¡¬t
 = (__u64)
pošt
;

502  (*)((
¡¬t
 & ~(
QUEUE_SIZE
-1)è| ((¡¬ˆ+ (
couÁ
<<3))&(QUEUE_SIZE - 1)));

503 
	}
}

505 
shªnÚ_»que¡
 *
	$fšd_lun_pba
(
shªnÚ_li¡_h—d
 *
queue_h—d
, 
logicb_t
 
lun_pba
)

507 
shªnÚ_»que¡
 *
»q
;

509 ià(
	`shªnÚ_li¡_em±y
(
queue_h—d
))

510  
NULL
;

512 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, 
queue_h—d
, 
chunk_li¡
) {

513 ià(
»q
->
pba
.
lun_pba
 ==†un_pba)

514  
»q
;

515 ià(
»q
->
pba
.
lun_pba
 >†un_pba)

516  
NULL
;

518  
NULL
;

519 
	}
}

521 
	$ÿlcuÏ‹_µa_¡ruù
(
shªnÚ_dev
 *
sdev
)

523 ià(
sdev
->
mbr
.
µa_·ge_width
 || sdev->mbr.
µa_¶ªe_width
) {

524 
sdev
->
µa_·ge_width
 = sdev->
mbr
.ppa_page_width;

525 
sdev
->
µa_¶ªe_width
 = sdev->
mbr
.ppa_plane_width;

527 
sdev
->
µa_·ge_width
 = 
	`shªnÚ_g‘_couÁ_Üd”
(sdev->
·ges_š_eblock
);

528 
sdev
->
µa_¶ªe_width
 = 
	`shªnÚ_g‘_couÁ_Üd”
(sdev->
¶ªes
);

531 
sdev
->
µa_·ge_shiá
 = 0;

532 
sdev
->
µa_¶ªe_shiá
 = sdev->
µa_·ge_width
;

533 
sdev
->
µa_block_shiá
 = sdev->
µa_·ge_width
 + sdev->
µa_¶ªe_width
;

535 
sdev
->
µa_block_width
 = 24 - sdev->
µa_block_shiá
;

537 ià((
sdev
->
µa_·ge_width
 < 0è|| (sdev->
µa_¶ªe_width
 < 0è|| (sdev->
µa_block_width
 < 0))

541 
	}
}

543 
šlše
 
u32
 
	$cÚv”t_µa
(
shªnÚ_dev
 *
sdev
, 
u32
 
µa
)

545 
u32
 
cmd_µa
, 
block
, 
¶ªe
, 
·ge
;

547 
block
 = 
µa
 / 
sdev
->
·ges_š_eblock
 / sdev->
¶ªes
;

548 
¶ªe
 = (
µa
 / 
sdev
->
·ges_š_eblock
è% sdev->
¶ªes
;

549 
·ge
 = 
µa
 % 
sdev
->
·ges_š_eblock
;

551 
cmd_µa
 = 
	`cmd_·¹
(
block
, 
sdev
->
µa_block_width
, sdev->
µa_block_shiá
);

552 
cmd_µa
 |ğ
	`cmd_·¹
(
¶ªe
, 
sdev
->
µa_¶ªe_width
, sdev->
µa_¶ªe_shiá
);

553 
cmd_µa
 |ğ
	`cmd_·¹
(
·ge
, 
sdev
->
µa_·ge_width
, sdev->
µa_·ge_shiá
);

555  
cmd_µa
;

556 
	}
}

558 
u32
 
	$make_cmd_dwÜd1
(
shªnÚ_dev
 *
sdev
, 
u32
 
µa
, u32 
phy_lun
)

560 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

561  
	`cmd_·¹
(
	`cÚv”t_µa
(
sdev
, 
µa
), 24, 0è| cmd_·¹(
phy_lun
, 8, 24);

563  
	`cmd_·¹
(
µa
, 24, 0è| cmd_·¹(
phy_lun
, 8, 24);

564 
	}
}

566 #ifdeà
SHANNON_USE_WRITE_BUFFER


567 
u32
 
	$make_buf_cmd_dwÜd1
(
shªnÚ_dev
 *
sdev
, 
u32
 
µa
, 
logicbs
, 
±es
)

569 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

570  
	`cmd_·¹
(
	`cÚv”t_µa
(
sdev
, 
µa
), 24, 0è| cmd_·¹(
logicbs
, 4, 24è| cmd_·¹(
±es
, 4, 28);

572  
	`cmd_·¹
(
µa
, 24, 0è| cmd_·¹(
logicbs
, 4, 24è| cmd_·¹(
±es
, 4, 28);

573 
	}
}

576 
u32
 
	$g‘_cmd_µa
(
shªnÚ_dev
 *
sdev
, 
u32
 *
dwÜd1
)

578 
u32
 
block
, 
¶ªe
, 
·ge
;

579 
u32
 
dwÜd
;

581 
dwÜd
 = 
	`shªnÚ_mem_»adl
(
dwÜd1
);

582 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

583 
block
 = (
dwÜd
 >> (
sdev
->
µa_·ge_width
 + sdev->
µa_¶ªe_width
)è& ((1 << sdev->
µa_block_width
) - 1);

584 ià(
sdev
->
µa_¶ªe_width
)

585 
¶ªe
 = (
dwÜd
 >> 
sdev
->
µa_·ge_width
è& ((1 << sdev->
µa_¶ªe_width
) - 1);

587 
¶ªe
 = 0;

588 
·ge
 = 
dwÜd
 & ((1 << 
sdev
->
µa_·ge_width
) - 1);

590  
sdev
->
·ges_š_siblšg_eblock
 * 
block
 + sdev->
·ges_š_eblock
 * 
¶ªe
 + 
·ge
;

592  (
dwÜd
 & ((1UL << 24) - 1));

593 
	}
}

595 
	$shªnÚ_ÿched_»ad
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_li¡_h—d
 *
queue_h—d
, 
h—d
, 
¢­_»ad
)

597 
shªnÚ_»que¡
 *
´ev
 = 
NULL
, *
»q
 = NULL, *
fœ¡
;

598 
shªnÚ_dev
 * 
sdev
 = 
lun£t
->sdev;

599 
shªnÚ_ÿched_»ad_cmd
 *
»ad
;

600 
shªnÚ_lun
 *
lun
;

601 
shªnÚ_sb
 *
sb
;

602 
shªnÚ_li¡_h—d
 
tmp_li¡
;

603 
cmd_off£t
, 
cmdid
;

604 
couÁ
, 
logicbs
, 
exŒa_±e
;

605 
dummy_»ad
 = 0;

606 
u64
 *
±e
;

608 
	`SHANNON_INIT_LIST_HEAD
(&
tmp_li¡
);

609 
logicbs
 = 0;

610 
exŒa_±e
 = 0;

612 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(
queue_h—d
, 
shªnÚ_»que¡
, 
chunk_li¡
);

613 
fœ¡
 = 
»q
;

614 
lun
 = 
sdev
->lun[
fœ¡
->
pba
.lun];

615 
sb
 = 
sdev
->
sbs
 + 
fœ¡
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

616 
sb
->
»ad_couÁ
[
fœ¡
->
pba
.
lun
]++;

617 ià(
sb
->
»ad_couÁ
[
fœ¡
->
pba
.
lun
] > sb->
max_»ad_couÁ
) {

622 
sb
->
max_»ad_couÁ
 = sb->
»ad_couÁ
[
fœ¡
->
pba
.
lun
];

623 ià(((
sb
->
¡©e
 =ğ
HOT_ACTIVE_BLOCK
è|| (sb->¡©=ğ
COLD_ACTIVE_BLOCK
)) && \

624 (
sb
->
max_»ad_couÁ
 > 
sdev
->
İ’_block_»ad_di¡urb_th»shŞd
) && \

625 (
sdev
->
š™_dÚe
 >ğ
STAGE9_DONE
) && \

626 (
sb
->
fl_sb
 =ğ0è&& (
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
)) {

627 
sb
->
fl_sb
 = 1;

628 #ifdeà
SHANNON_USE_WRITE_BUFFER


629 ià(
sb
->
¡©e
 =ğ
HOT_ACTIVE_BLOCK
) {

630 ià(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
fl_chunk_tim”
[
HOT_INDEX
]))

631 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
HOT_INDEX
));

632 } ià(
sb
->
¡©e
 =ğ
COLD_ACTIVE_BLOCK
) {

633 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


634 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

636 ià(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
fl_chunk_tim”
[
COLD_INDEX
]))

637 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
COLD_INDEX
));

643 
	`shªnÚ_li¡_d–_š™
(&
»q
->
chunk_li¡
);

644 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
tmp_li¡
);

645 
logicbs
++;

646 ià(
	`is_dummy»ad_»q
(
»q
))

647 
dummy_»ad
++;

648 ià(
»q
->
dma_add»ss_2
)

649 
exŒa_±e
++;

650 
´ev
 = 
»q
;

651 
»q
 = 
	`fšd_lun_pba
(
queue_h—d
, 
´ev
->
pba
.
lun_pba
 + 1);

652 } 
»q
 && (
logicbs
 < 8));

654 
couÁ
 = 1 + 
logicbs
 + 
exŒa_±e
;

655 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

656 ià(
cmd_off£t
 < 0) {

657 
	`shªnÚ_”r
("we‡re killed.\n");

658 
	`BUG
();

661 
cmdid
 = 
cmd_off£t
 >> 3;

662 
»ad
 = (
shªnÚ_ÿched_»ad_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

663 #ifdeà
SHANNON_USE_WRITE_BUFFER


664 ià(!
	`shªnÚ_li¡_em±y
(
queue_h—d
))

665 
»ad
->
İcode
 = 
sh_cmd_»ad
;

667 
»ad
->
İcode
 = 
sh_cmd_»ad_’d
;

669 
»ad
->
İcode
 = 
sh_cmd_»ad
;

671 
»ad
->
by‹1
 = 
	`make_»ad_cmd_by‹1
(
logicbs
 - 1, 
exŒa_±e
);

672 
»ad
->
h—d
 = (h—d & 
MULTI_PLANES_MASK
è| ((
dummy_»ad
 =ğ
logicbs
è? 
DUMMY_READ_MASK
 : 0x0);

673 
»ad
->
fœ¡_logicb
 = 
fœ¡
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
;

674 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
fœ¡
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
, 
lun
->
phy_lun_num
), &
»ad
->
dwÜd1
);

675 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

676 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

677 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

679 
±e
 = 
	`cmd_queue_šc
(
»ad
, 1);

680 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
tmp_li¡
));

681 !
	`shªnÚ_li¡_em±y
(&
tmp_li¡
)) {

682 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
tmp_li¡
, 
shªnÚ_»que¡
, 
li¡
);

683 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

684 
»q
->
¡©e
 = 
REQ_CMD_QUEUE
;

685 ià(
¢­_»ad
)

686 
	`£t_¢­»ad_»q
(
»q
);

688 
	`ş—n_¢­»ad_»q
(
»q
);

689 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

690 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss
, 
±e
);

691 
±e
 = 
	`cmd_queue_šc
(pte, 1);

692 ià(
»q
->
dma_add»ss_2
) {

693 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss_2
, 
±e
);

694 
±e
 = 
	`cmd_queue_šc
(pte, 1);

699 
	}
}

701 
	$b–Úg_to_bad_lun
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
)

703 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
´eq
->
pba
.lun];

704 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + 
´eq
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

706 ià(
sb
->
sb_šdex
 < 
sdev
->
mbr_eblocks
/sdev->
¶ªes
)

708 ià(
lun
->
bad
)

710 #ifdeà
CONFIG_READ_SKIP_BAD_BLOCKS


711 ià(
	`is_bad_lun
(
sb
, 
lun
->
lun_num
))

715 
	}
}

717 
	$shªnÚ_´e_»ad_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
, shªnÚ_»que¡ *
Ï¡_»q
, 
h—d
)

719 
shªnÚ_cmd
 *
´e_»ad
;

720 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

721 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

722 
cmd_off£t
, 
cmdid
;

724 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
h—d
 ? 
sdev
->
¶ªes
 : 1);

725 ià(
cmd_off£t
 < 0) {

726 
	`shªnÚ_”r
("we‡re killed.\n");

727 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

728 
	`BUG
();

731 
cmdid
 = 
cmd_off£t
 >> 3;

733 
´e_»ad
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

734 
´e_»ad
->
İcode
 = 
sh_cmd_´e_»ad
;

735 
´e_»ad
->
logicbs
 = 0;

736 
´e_»ad
->
h—d
 = h—d & 
MULTI_PLANES_MASK
;

737 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
, 
lun
->
phy_lun_num
), &
´e_»ad
->
dwÜd1
);

738 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 8;

739 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

740 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

742 
cmd_off£t
 = (cmd_off£ˆ+ 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
)%
QUEUE_SIZE
;

743 
cmdid
 = 
cmd_off£t
 >> 3;

745 ià(
h—d
) {

746 
	`BUG_ON
(
Ï¡_»q
 =ğ
NULL
);

747 
´e_»ad
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

748 
´e_»ad
->
İcode
 = 
sh_cmd_´e_»ad
;

749 
´e_»ad
->
logicbs
 = 0;

750 
´e_»ad
->
h—d
 = h—d & 
MULTI_PLANES_MASK
;

751 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
Ï¡_»q
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
, 
lun
->
phy_lun_num
), &
´e_»ad
->
dwÜd1
);

752 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 8;

753 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

754 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

756 
	}
}

758 
shªnÚ_ç¡_»ad_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
);

759 
hªdË_»ad_”rÜ
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
);

760 
hªdË_wr™e_”rÜ
(
shªnÚ_dev
 *
dev
, 
shªnÚ_sb
 *
sb
, 
shªnÚ_cmd_šfo
 *
šfo
);

761 
	$__shªnÚ_»ad_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

763 
shªnÚ_»que¡
 *
p
;

764 
h—d
;

765 
»t
 = 0;

766 
¶ªes
 = 0;

767 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

768 
shªnÚ_li¡_h—d
 
queue_h—d
;

770 ià(
	`uÆik–y
(
	`b–Úg_to_bad_lun
(
sdev
, 
»q
))) {

771 !
	`shªnÚ_li¡_em±y
(&
»q
->
chunk_li¡
)) {

772 
p
 = 
	`shªnÚ_li¡_’Œy
(
»q
->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

773 
	`shªnÚ_li¡_d–_š™
(&
»q
->
chunk_li¡
);

774 
»q
->
»»ad
 = (Ôeq->»»ad & ~
REREAD_NUM_MASK
è| 
sdev
->
»Œy_times_Ú_”rÜ
);

775 
»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

776 ià(
»q
->
£nd”
 =ğ
FROM_PERIOD_READ
)

777 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

779 
	`hªdË_»ad_”rÜ
(
sdev
, 
»q
);

780 
»q
 = 
p
;

782 
»q
->
»»ad
 = (Ôeq->»»ad & ~
REREAD_NUM_MASK
è| 
sdev
->
»Œy_times_Ú_”rÜ
);

783 
»q
->
_ecc
 = 
SH_SOFT_ERR_2
;

784 ià(
»q
->
£nd”
 =ğ
FROM_PERIOD_READ
)

785 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

787 
	`hªdË_»ad_”rÜ
(
sdev
, 
»q
);

791 
p
 = 
	`shªnÚ_li¡_’Œy
(
»q
->
chunk_li¡
.
´ev
, 
shªnÚ_»que¡
, chunk_list);

792 ià(
»q
->
pba
.
lun_pba
/
sdev
->
logicbs_š_·ge
 !ğ
p
->pba.lun_pba/sdev->logicbs_in_page) {

793 
h—d
 = (1 << 
MULTI_PLANES_SHIFT
);

794 
¶ªes
 = 
sdev
->planes;

796 
h—d
 = 0;

797 
¶ªes
 = 1;

800 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

801 
»t
 = 
	`do_¢­_»ad
(
lun£t
, 
»q
, 
¶ªes
);

802 
	`SHANNON_INIT_LIST_HEAD
(&
queue_h—d
);

803 
	`shªnÚ_li¡_add_
(&
queue_h—d
, &
»q
->
chunk_li¡
);

805 ià(
sdev
->
ç¡_»ad_’abË
)

806 
	`shªnÚ_ç¡_»ad_cmd
(
lun£t
, 
»q
);

808 ià(!
»t
) {

809 
	`BUG_ON
((
sdev
->
lun
[
»q
->
pba
.lun]->
û
->
ã©u»_æags
 & 
SNAPREAD_ENABLE_MASK
));

810 ià(
h—d
)

811 
	`shªnÚ_´e_»ad_cmd
(
lun£t
, 
»q
, 
p
, 
h—d
);

813 
	`shªnÚ_´e_»ad_cmd
(
lun£t
, 
»q
, 
NULL
, 
h—d
);

815 
	`BUG_ON
((
sdev
->
lun
[
»q
->
pba
.lun]->
û
->
ã©u»_æags
 & 
SNAPREAD_ENABLE_MASK
) == 0);

818 
	`shªnÚ_ÿched_»ad
(
lun£t
, &
queue_h—d
, 
h—d
, 
»t
);

819 } !
	`shªnÚ_li¡_em±y
(&
queue_h—d
));

821 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

822 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

823 
	}
}

825 
šlše
 
	$shªnÚ_»ad_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

827 
	`__shªnÚ_»ad_cmd
(
lun£t
, 
»q
);

828 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

829 
	}
}

831 
	$shªnÚ_´efix_no_İ_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
, 
fÜ_·r™y
)

833 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

834 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

835 
shªnÚ_sb
 *
sb
 = &
sdev
->
sbs
[
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
];

836 
sub_group
 *
group
 = &
sb
->sub_group[
lun
->
lun_num
/
sdev
->
max_luns_š_group
];

837 
shªnÚ_cmd
 *
no_İ
;

838 
phy_lun
 = 
lun
->
phy_lun_num
;

839 
cmd_off£t
, 
cmdid
;

840 
couÁ
 = 1;

842 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

843 ià(
cmd_off£t
 < 0) {

844 
	`shªnÚ_”r
("we‡re killed.\n");

845 
	`BUG
();

848 
cmdid
 = 
cmd_off£t
 >> 3;

849 
no_İ
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

850 
no_İ
->
İcode
 = 
sh_cmd_no_İ
;

851 
no_İ
->
h—d
 = 
»q
->head;

853 
fÜ_·r™y
) {

855 
no_İ
->
¿id_¡re
 = 0xC0 | (
group
->
phy_šdex
 & 0x0F);

858 
no_İ
->
¿id_¡re
 = 0x60 | (
group
->
phy_šdex
 & 0x0F);

861 
no_İ
->
¿id_¡re
 = 0x40 | (
group
->
phy_šdex
 & 0x0F);

863 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
lun£t
->
sdev
, 
»q
->
pba
.
lun_pba
/lun£t->sdev->
logicbs_š_·ge
, 
phy_lun
), &
no_İ
->
dwÜd1
);

865 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

866 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

867 
lun£t
->
cmd_šfo
[
cmdid
].
lun_pba
 = 
»q
->
pba
.lun_pba;

868 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

869 
	}
}

872 
	$__shªnÚ_advªûd_»ad_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
fœ¡
)

874 
shªnÚ_»que¡
 *
»q
, *
Ãxt
;

875 
shªnÚ_ÿched_»ad_cmd
 *
»ad
;

876 
shªnÚ_cmd
 *
no_İ
;

877 
cmd_off£t
, 
cmdid
;

878 
»ad_cmd_couÁ
, 
logicbs
 = 0, 
exŒa_±e
 = 0;

879 
u64
 *
±e
;

880 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

881 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
fœ¡
->
pba
.lun];

882 
dummy_»ad
 = 0;

884 
»q
 = 
fœ¡
;

886 
logicbs
++;

887 ià(
	`is_dummy»ad_»q
(
»q
))

888 
dummy_»ad
++;

889 ià(
»q
->
dma_add»ss_2
)

890 
exŒa_±e
++;

891 
»q
 = 
	`shªnÚ_li¡_’Œy
Ôeq->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

892 } 
»q
 !ğ
fœ¡
);

894 
»ad_cmd_couÁ
 = 1 + 
logicbs
 + 
exŒa_±e
;

895 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

896 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
»ad_cmd_couÁ
);

898 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
»ad_cmd_couÁ
 + 1);

899 ià(
cmd_off£t
 < 0) {

900 
	`shªnÚ_”r
("we‡re killed.\n");

901 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

902 
	`BUG
();

905 
cmdid
 = 
cmd_off£t
 >> 3;

906 
»ad
 = (
shªnÚ_ÿched_»ad_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

907 
»ad
->
İcode
 = 
sh_cmd_advªûd_»ad
;

908 
»ad
->
by‹1
 = 
	`make_»ad_cmd_by‹1
(
logicbs
 - 1, 
exŒa_±e
);

909 
»ad
->
h—d
 = (
dummy_»ad
 =ğ
logicbs
è? 
DUMMY_READ_MASK
 : 0x0;

910 
»ad
->
fœ¡_logicb
 = 
fœ¡
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
;

911 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
fœ¡
->
pba
.
lun_pba
 / sdev->
logicbs_š_·ge
, 
lun
->
phy_lun_num
), &
»ad
->
dwÜd1
);

913 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
»ad_cmd_couÁ
 << 3;

914 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

915 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

917 
Ãxt
 = 
fœ¡
;

918 
±e
 = 
	`cmd_queue_šc
(
»ad
, 1);

920 
»q
 = 
Ãxt
;

921 
Ãxt
 = 
	`shªnÚ_li¡_’Œy
(
»q
->
chunk_li¡
.Ãxt, 
shªnÚ_»que¡
, chunk_list);

922 
	`ş—n_¢­»ad_»q
(
»q
);

923 
	`shªnÚ_li¡_d–_š™
(&
»q
->
chunk_li¡
);

924 
»q
->
¡©e
 = 
REQ_CMD_QUEUE
;

925 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

926 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss
, 
±e
);

927 
±e
 = 
	`cmd_queue_šc
(pte, 1);

928 ià(
»q
->
dma_add»ss_2
) {

929 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss_2
, 
±e
);

930 
±e
 = 
	`cmd_queue_šc
(pte, 1);

932 } 
»q
 !ğ
Ãxt
);

934 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

936 
no_İ
 = (
shªnÚ_cmd
 *)
±e
;

937 
cmdid
 = 
no_İ
 - 
lun£t
->
sq_addr
;

938 
no_İ
->
İcode
 = 
sh_cmd_no_İ
;

939 
no_İ
->
h—d
 = 0;

942 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 0, 
lun
->
phy_lun_num
), &
no_İ
->
dwÜd1
);

943 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 8;

944 
lun£t
->
cmd_šfo
[
cmdid
].
lun_pba
 = 
fœ¡
->
pba
.lun_pba;

945 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

946 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

949 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

950 
	}
}

952 
šlše
 
	$shªnÚ_advªûd_»ad
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

954 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

955 ià(
lun£t
->
sdev
->
¢­_»ad_’abË
 && 
	`shªnÚ_dev_is_g5
(lunset->sdev))

956 
	`¢­_»ad_di§bË
(
lun£t
,†un£t->
sdev
->
lun
[
»q
->
pba
.lun], 0, 1);

957 ià(
lun£t
->
sdev
->
´efix_no_İ_cmd
)

958 
	`shªnÚ_´efix_no_İ_cmd
(
lun£t
, 
»q
, 2);

959 
	`__shªnÚ_advªûd_»ad_cmd
(
lun£t
, 
»q
);

960 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

961 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

962 
	}
}

964 
	$shªnÚ_no_İ_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
phy_lun
, 
logicb_t
 
lun_pba
)

966 
shªnÚ_cmd
 *
no_İ
;

967 
cmd_off£t
, 
cmdid
;

968 
couÁ
 = 1;

970 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

971 ià(
cmd_off£t
 < 0) {

972 
	`shªnÚ_”r
("we‡re killed.\n");

973 
	`BUG
();

976 
cmdid
 = 
cmd_off£t
 >> 3;

977 
no_İ
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

978 
no_İ
->
İcode
 = 
sh_cmd_no_İ
;

979 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
lun£t
->
sdev
, 
lun_pba
/lun£t->sdev->
logicbs_š_·ge
, 
phy_lun
), &
no_İ
->
dwÜd1
);

981 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

982 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

983 
lun£t
->
cmd_šfo
[
cmdid
].
lun_pba
 =†un_pba;

984 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

985 
	}
}

987 
shªnÚ_»que¡
 *
	$shªnÚ_wr™e_Úe_·ge
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
fœ¡
, *
Ï¡_cmdid
)

989 
shªnÚ_wr™e_cmd
 *
wr™e
;

990 
cmd_off£t
, 
cmdid
;

991 
shªnÚ_»que¡
 *
»q
, *
Ãxt
 = 
NULL
;

992 
i
, 
couÁ
, 
exŒa_±e
 = 0;

993 
u64
 *
±e
;

994 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

995 
shªnÚ_sb
 *
sb
 = &
sdev
->
sbs
[
fœ¡
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
];

996 
sub_group
 *
group
 = &
sb
->sub_group[
fœ¡
->
pba
.
lun
/
sdev
->
max_luns_š_group
];

997 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
fœ¡
->
pba
.lun];

999 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_·ge
, &sdev->
š_cmd_queue_wr™es
);

1000 
	`shªnÚ_©omic_add
(
sdev
->
logicbs_š_·ge
, &
sb
->
unfšished_wr™es
);

1002 
»q
 = 
fœ¡
;

1003 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

1004 ià(
»q
->
dma_add»ss_2
)

1005 
exŒa_±e
++;

1006 
»q
 = 
	`shªnÚ_li¡_’Œy
Ôeq->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

1009 
couÁ
 = 1 + 
sdev
->
logicbs_š_·ge
 * 2 + 
exŒa_±e
;

1010 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

1011 ià(
cmd_off£t
 < 0) {

1012 
	`shªnÚ_”r
("we‡re killed.\n");

1013 
	`BUG
();

1014  
NULL
;

1016 
cmdid
 = 
cmd_off£t
 >> 3;

1017 *
Ï¡_cmdid
 = 
cmdid
;

1019 
wr™e
 = (
shªnÚ_wr™e_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

1020 
wr™e
->
İcode
 = 
sh_cmd_wr™e
;

1021 
wr™e
->
exŒa_±e
 =ƒxtra_pte;

1022 
wr™e
->
¿id_¡re
 = 
group
->
phy_šdex
;

1023 
wr™e
->
h—d
 = 
fœ¡
->head;

1024 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
fœ¡
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
, 
lun
->
phy_lun_num
), &
wr™e
->
dwÜd1
);

1026 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 
couÁ
 << 3;

1027 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

1028 
lun£t
->
cmd_šfo
[
cmdid
].
logicbs
 = 
sdev
->
logicbs_š_·ge
;

1029 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1031 
»q
 = 
fœ¡
;

1032 
±e
 = 
	`cmd_queue_šc
(
wr™e
, 1);

1033 
i
 = 0; i < 
sdev
->
logicbs_š_·ge
; i++) {

1034 
	`BUG_ON
(
»q
 =ğ
NULL
);

1035 
»q
->
¡©e
 = 
REQ_CMD_QUEUE
;

1036 
Ãxt
 = 
	`shªnÚ_li¡_’Œy
(
»q
->
chunk_li¡
.Ãxt, 
shªnÚ_»que¡
, chunk_list);

1037 ià((
Ãxt
 =ğ
»q
è|| (Ãxˆ=ğ
fœ¡
))

1038 
Ãxt
 = 
NULL
;

1039 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss
, 
±e
);

1040 
±e
 = 
	`cmd_queue_šc
(pte, 1);

1041 ià(
»q
->
dma_add»ss_2
) {

1042 
	`shªnÚ_mem_wr™eq
(
»q
->
dma_add»ss_2
, 
±e
);

1043 
±e
 = 
	`cmd_queue_šc
(pte, 1);

1045 
	`shªnÚ_mem_wr™eq
(
»q
->
_m‘ad©a
, 
±e
);

1046 
±e
 = 
	`cmd_queue_šc
(pte, 1);

1047 
»q
 = 
Ãxt
;

1049  
Ãxt
;

1050 
	}
}

1052 
	$__shªnÚ_wr™e_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1054 
shªnÚ_lun
 *
lun
 = 
NULL
;

1055 
logicb_t
 
lun_pba
 = 0;

1056 
shªnÚ_»que¡
 *
p
, *
Ãxt
;

1057 
i
, 
Ï¡_cmdid
 = 0, 
h—d
 = 
»q
->head;

1059 ià(
h—d
 & 
NO_POLL_MASK
) {

1060 
lun
 = 
lun£t
->
sdev
->lun[
»q
->
pba
.lun];

1061 
lun_pba
 = 
»q
->
pba
.lun_pba;

1064 
p
 = 
»q
;

1065 
i
 = 0; i < 
lun£t
->
sdev
->
¶ªes
; i++) {

1066 
p
 = 
	`shªnÚ_wr™e_Úe_·ge
(
lun£t
,…, &
Ï¡_cmdid
);

1067 ià(!
p
)

1071 
p
 = 
»q
;

1072 
i
 = 0; i < 
lun£t
->
sdev
->
logicbs_š_·ge
 *†un£t->sdev->
¶ªes
; i++) {

1073 
Ãxt
 = 
	`shªnÚ_li¡_’Œy
(
p
->
chunk_li¡
.Ãxt, 
shªnÚ_»que¡
, chunk_list);

1074 
	`shªnÚ_li¡_add_
(&
p
->
li¡
, &
lun£t
->
cmd_šfo
[
Ï¡_cmdid
].
»q_li¡
);

1075 ià(
	`shªnÚ_li¡_em±y
(&
p
->
chunk_li¡
)) {

1076 
	`shªnÚ_li¡_d–_š™
(&
p
->
chunk_li¡
);

1079 
	`shªnÚ_li¡_d–_š™
(&
p
->
chunk_li¡
);

1080 
p
 = 
Ãxt
;

1084 ià(
h—d
 & 
NO_POLL_MASK
)

1085 
	`shªnÚ_no_İ_cmd
(
lun£t
, 
lun
->
phy_lun_num
, 
lun_pba
);

1087 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

1088 
	}
}

1090 
	$shªnÚ_wr™e_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1092 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

1093 ià(
lun£t
->
sdev
->
´efix_no_İ_cmd
)

1094 
	`shªnÚ_´efix_no_İ_cmd
(
lun£t
, 
»q
, 0);

1095 
	`__shªnÚ_wr™e_cmd
(
lun£t
, 
»q
);

1096 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1097 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

1098 
	}
}

1100 
	$__shªnÚ_”a£_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
, 
muÉi_¶ªe
)

1102 
shªnÚ_cmd
 *
”a£
;

1103 
cmd_off£t
, 
cmdid
;

1104 
shªnÚ_»que¡
 *
p
;

1105 
shªnÚ_lun
 *
lun
 = 
lun£t
->
sdev
->lun[
»q
->
pba
.lun];

1107 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 1);

1108 ià(
cmd_off£t
 < 0) {

1109 
	`shªnÚ_”r
("we‡re killed.\n");

1110 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1111 
	`BUG
();

1114 
cmdid
 = 
cmd_off£t
 >> 3;

1116 
”a£
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

1117 
”a£
->
İcode
 = 
sh_cmd_”a£
;

1118 ià(
muÉi_¶ªe
 && !
lun£t
->
sdev
->
p£udo_¶ªe
)

1119 
”a£
->
h—d
 = (1 << 
MULTI_PLANES_SHIFT
);

1121 
”a£
->
h—d
 = 0;

1122 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
lun£t
->
sdev
, 
»q
->
µa
, 
lun
->
phy_lun_num
), &
”a£
->
dwÜd1
);

1124 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 1 << 3;

1125 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

1127 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1128 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1130 !
	`shªnÚ_li¡_em±y
(&
»q
->
chunk_li¡
)) {

1131 
p
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
»q
->
chunk_li¡
, 
shªnÚ_»que¡
, chunk_list);

1132 
	`shªnÚ_li¡_d–_š™
(&
p
->
chunk_li¡
);

1134 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 1);

1135 
	`BUG_ON
(
cmd_off£t
 < 0);

1136 
cmdid
 = 
cmd_off£t
 >> 3;

1137 
”a£
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

1138 
”a£
->
İcode
 = 
sh_cmd_”a£
;

1139 ià(
muÉi_¶ªe
 && !
lun£t
->
sdev
->
p£udo_¶ªe
)

1140 
”a£
->
h—d
 = (1 << 
MULTI_PLANES_SHIFT
);

1142 
”a£
->
h—d
 = 0;

1143 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
lun£t
->
sdev
, 
p
->
µa
, 
lun
->
phy_lun_num
), &
”a£
->
dwÜd1
);

1145 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 1 << 3;

1146 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

1147 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1148 
	`shªnÚ_li¡_add_
(&
p
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1151 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

1153 
	}
}

1155 
šlše
 
	$shªnÚ_”a£_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1157 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

1158 
	`__shªnÚ_”a£_cmd
(
lun£t
, 
»q
,†un£t->
sdev
->
¶ªes
 - 1);

1159 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1160 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

1161 
	}
}

1163 
	$__shªnÚ_·r™y_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1165 
shªnÚ_cmd
 *
·r™y
;

1166 
cmd_off£t
, 
cmdid
;

1167 
shªnÚ_»que¡
 *
p
;

1168 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

1169 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

1170 
shªnÚ_sb
 *
sb
 = &
sdev
->
sbs
[
»q
->
µa
/(sdev->
·ges_š_eblock
 * sdev->
¶ªes
)];

1171 
sub_group
 *
group
 = &
sb
->sub_group[
lun
->
lun_num
/
sdev
->
max_luns_š_group
];

1172 
couÁ
 = 
lun£t
->
sdev
->
¶ªes
;

1174 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 
couÁ
);

1175 ià(
cmd_off£t
 < 0) {

1176 
	`shªnÚ_”r
("we‡re killed.\n");

1177 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1178 
	`BUG
();

1181 
cmdid
 = 
cmd_off£t
 >> 3;

1182 
·r™y
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

1183 
·r™y
->
İcode
 = 
sh_cmd_·r™y
;

1184 
·r™y
->
¿id_¡re
 = 
group
->
phy_šdex
;

1185 
·r™y
->
h—d
 = 
»q
->h—d & ~
NO_POLL_MASK
;

1186 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
»q
->
µa
, 
lun
->
phy_lun_num
), &
·r™y
->
dwÜd1
);

1187 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 1 << 3;

1188 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

1190 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1191 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1193 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
»q
->
chunk_li¡
è&& (
lun£t
->
sdev
->
¶ªes
 != 1));

1195 !
	`shªnÚ_li¡_em±y
(&
»q
->
chunk_li¡
)) {

1196 
p
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
»q
->
chunk_li¡
, 
shªnÚ_»que¡
, chunk_list);

1197 
	`shªnÚ_li¡_d–_š™
(&
p
->
chunk_li¡
);

1199 
cmd_off£t
 = (cmd_off£ˆ+ 8)%
QUEUE_SIZE
;

1200 
cmdid
 = 
cmd_off£t
 >> 3;

1202 
·r™y
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

1203 
·r™y
->
İcode
 = 
sh_cmd_·r™y
;

1204 
·r™y
->
¿id_¡re
 = 
group
->
phy_šdex
;

1205 
·r™y
->
h—d
 = 
p
->h—d & ~
NO_POLL_MASK
;

1206 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
p
->
µa
, 
lun
->
phy_lun_num
), &
·r™y
->
dwÜd1
);

1208 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 1 << 3;

1209 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

1210 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1211 
	`shªnÚ_li¡_add_
(&
p
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1214 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

1216 
	}
}

1218 
	$shªnÚ_·r™y_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1220 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

1221 ià(
lun£t
->
sdev
->
´efix_no_İ_cmd
)

1222 
	`shªnÚ_´efix_no_İ_cmd
(
lun£t
, 
»q
, 1);

1223 
	`__shªnÚ_·r™y_cmd
(
lun£t
, 
»q
);

1224 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1225 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

1226 
	}
}

1228 
	$__shªnÚ_·r™y_š™_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1230 
shªnÚ_cmd
 *
·r™y_š™
;

1231 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

1232 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

1233 
shªnÚ_sb
 *
sb
 = &
sdev
->
sbs
[
»q
->
µa
/(sdev->
·ges_š_eblock
 * sdev->
¶ªes
)];

1234 
sub_group
 *
group
 = &
sb
->sub_group[
lun
->
lun_num
/
sdev
->
max_luns_š_group
];

1235 
cmd_off£t
, 
cmdid
;

1237 
	`shªnÚ_mu‹x_lock
(&
lun£t
->
sq_£m
);

1238 
cmd_off£t
 = 
	`®loc_cmd_¦“·bË
(
lun£t
, 1);

1239 ià(
cmd_off£t
 < 0) {

1240 
	`shªnÚ_”r
("we‡re killed.\n");

1241 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1242 
	`BUG
();

1245 
cmdid
 = 
cmd_off£t
 >> 3;

1246 
·r™y_š™
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

1247 
·r™y_š™
->
İcode
 = 
sh_cmd_·r™y_š™
;

1248 
·r™y_š™
->
d©a_luns
 = 
»q
->data_luns;

1249 
·r™y_š™
->
¿id_¡re
 = 
group
->
phy_šdex
;

1250 
·r™y_š™
->
h—d
 = 
»q
->head;

1251 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
sdev
, 
»q
->
µa
, 
lun
->
phy_lun_num
), &
·r™y_š™
->
dwÜd1
);

1252 
lun£t
->
cmd_šfo
[
cmdid
].
cmd_Ën
 = 1 << 3;

1253 
lun£t
->
cmd_šfo
[
cmdid
].
Ï¡_aùive_time
 = 
	`g‘_jiff›s
();

1255 
	`SHANNON_INIT_LIST_HEAD
(&
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1256 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
lun£t
->
cmd_šfo
[
cmdid
].
»q_li¡
);

1258 
lun£t
->
sq_h—d
 =†un£t->
sq_h—d_tmp
;

1259 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
sq_£m
);

1261 
	}
}

1263 
šlše
 
	$shªnÚ_·r™y_š™_cmd
(
shªnÚ_lun£t
 *
lun£t
, 
shªnÚ_»que¡
 *
»q
)

1265 
	`__shªnÚ_·r™y_š™_cmd
(
lun£t
, 
»q
);

1266 
	`upd©e_lun£t_sq_h—d
(
lun£t
);

1267 
	}
}

1269 
shªnÚ_»que¡
 *
	$make_·r™y_»q
(
shªnÚ_sb
 *
sb
, 
·r™y_lun
, 
shªnÚ_»que¡
 *
wr™e
)

1271 
shªnÚ_»que¡
 *
»q
, *
·r™y
;

1272 
¶ªe
;

1273 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

1274 
µa
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
wr™e
->
pba
.
lun_pba
/sdev->
logicbs_š_·ge
);

1276 
·r™y
 = 
	`®loc_»q
(
GFP_SHANNON
);

1277 
	`£t_»q_debug_g
(
·r™y
, 
WRITE_PARITY_TAG
, 0);

1278 
·r™y
->
İcode
 = 
sh_cmd_·r™y
;

1279 
·r™y
->
h—d
 = 
wr™e
->head;

1280 
·r™y
->
pba
.
lun
 = 
·r™y_lun
;

1281 
·r™y
->
µa
 =…pa;

1282 
·r™y
->
pba
.
lun_pba
 = 
µa
 * 
sdev
->
logicbs_š_·ge
;

1283 
	`SHANNON_INIT_LIST_HEAD
(&
·r™y
->
chunk_li¡
);

1285 
¶ªe
 = 1;

1286 
¶ªe
 < 
sdev
->
¶ªes
) {

1287 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

1288 
	`£t_»q_debug_g
(
»q
, 
WRITE_PARITY_TAG
, 
¶ªe
);

1289 
»q
->
İcode
 = 
sh_cmd_·r™y
;

1290 
»q
->
h—d
 = 
wr™e
->head;

1291 
»q
->
pba
.
lun
 = 
·r™y_lun
;

1292 
»q
->
µa
 =…· + 
sdev
->
·ges_š_eblock
 * 
¶ªe
;

1293 
»q
->
pba
.
lun_pba
 =„eq->
µa
 * 
sdev
->
logicbs_š_·ge
;

1294 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
·r™y
->chunk_list);

1295 
¶ªe
++;

1297  
·r™y
;

1298 
	}
}

1300 
	$deü—£_£nd”_¡©i¡ics
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

1302 #ifdeà
CONFIG_SHANNON_STATISTICS


1303 ià(
»q
->
»»ad
 == 0) {

1304 ià(
»q
->
£nd”
 =ğ
FROM_GC
)

1305 
	`shªnÚ_©omic_dec
(&
sdev
->
äom_gc
);

1306 ià(
»q
->
£nd”
 =ğ
FROM_HOST
)

1307 
	`shªnÚ_©omic_dec
(&
sdev
->
äom_ho¡
);

1310 
	}
}

1312 
	$fl_aùive_blk_timeout
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

1314 
shªnÚ_sb
 *
sb
 = 
sdev
->
aùive_blk
[
h—d_šdex
];

1316 ià((
	`shªnÚ_jiff›s_to_m£cs
(
	`g‘_jiff›s
(è- 
sdev
->
aùive_blk_¡¬t_jiff›s
[
h—d_šdex
]è/ 1000è>ğ
FILL_FIRST_SB_TIME_EXPIRE
) {

1317 ià(
sb
 && ((sb->
¡©e
 =ğ
HOT_ACTIVE_BLOCK
è|| (sb->¡©=ğ
COLD_ACTIVE_BLOCK
)) && \

1318 (
sdev
->
š™_dÚe
 >ğ
STAGE9_DONE
è&& (
sb
->
fl_sb
 =ğ0è&& (sdev->
acûss_mode
 !ğ
SHN_MODE_READONLY
)) {

1319 
sb
->
fl_sb
 = 1;

1320 #ifdeà
SHANNON_USE_WRITE_BUFFER


1321 ià(
sdev
->
mbr
.
max_k“p_”a£d_hours
 || 
sb
->
wr_off£t
) {

1322 ià(
sb
->
¡©e
 =ğ
HOT_ACTIVE_BLOCK
) {

1323 ià(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
fl_chunk_tim”
[
HOT_INDEX
]))

1324 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
HOT_INDEX
));

1325 } ià(
sb
->
¡©e
 =ğ
COLD_ACTIVE_BLOCK
) {

1326 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


1327 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

1329 ià(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
fl_chunk_tim”
[
COLD_INDEX
]))

1330 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
COLD_INDEX
));

1336 
	}
}

1338 
	$fl_cŞd_aùive_blk_tim”_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

1340 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
fl_sb_tim”
[
COLD_INDEX
]);

1342 
	`fl_aùive_blk_timeout
(
sdev
, 
COLD_INDEX
);

1343 
	}
}

1345 
	$fl_hÙ_aùive_blk_tim”_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

1347 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
fl_sb_tim”
[
HOT_INDEX
]);

1349 
	`fl_aùive_blk_timeout
(
sdev
, 
HOT_INDEX
);

1350 
	}
}

1352 
	$mod_fl_sb_tim”
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
shªnÚ_sb
 *
sb
)

1354 (*
â
)(
shªnÚ_tim”_li¡
 *èğ
NULL
;

1355 ià(
h—d_šdex
 =ğ
HOT_INDEX
)

1356 
â
 = 
fl_hÙ_aùive_blk_tim”_timeout
;

1357 ià(
h—d_šdex
 =ğ
COLD_INDEX
)

1358 
â
 = 
fl_cŞd_aùive_blk_tim”_timeout
;

1360 
	`BUG_ON
(1);

1362 ià(
	`shªnÚ_tim”_has_funùiÚ
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
])) {

1363 
	`shªnÚ_mod_tim”
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
], 
	`g‘_jiff›s
(è+ 
	`g‘_HZ
(è* 
FILL_SB_TIME_EXPIRE
);

1364 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
], 
â
);

1366 ià(
sdev
->
aùive_blk
[
h—d_šdex
]->
wr_off£t
) {

1367 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
], 
â
);

1368 
	`shªnÚ_mod_tim”
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
], 
	`g‘_jiff›s
(è+ 
	`g‘_HZ
(è* 
FILL_FIRST_SB_TIME_EXPIRE
);

1370 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
], 
â
);

1371 
	`shªnÚ_mod_tim”
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
], 
	`g‘_jiff›s
(è+ 
	`g‘_HZ
(è* 
FILL_SB_TIME_EXPIRE
);

1374 
	}
}

1376 
	$sw™ch_to_Ãxt_sb
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_sb
 *
sb
, 
h—d
)

1378 
shªnÚ_»que¡
 *
»q
;

1379 
·r™y_lun
, 
wa™
 = 0;

1380 
h—d_šdex
 = 
h—d
 & 
HEAD_INDEX_MASK
;

1382 
	`uÆik–y
(
sb
->
Ãxt_sb
 =ğ
INVALID_SB_INDEX
)) {

1383 
	`shªnÚ_w¬n
("Ãxˆ% block i šv®id, sb=%d.\n", 
h—d_šdex
 ? "cŞd" : "hÙ", 
sb
->
sb_šdex
);

1384 
sb
->
Ãxt_sb
 = 
	`g‘_Ãxt_sb
(
sdev
, 
h—d_šdex
);

1385 ià(
	`uÆik–y
(
sb
->
Ãxt_sb
 =ğ
INVALID_SB_INDEX
))

1386 
	`shªnÚ_m¦“p
(10);

1390 
sdev
->
sbs
[
sb
->
Ãxt_sb
].
¡©e
 !ğ(
h—d_šdex
 ? 
NEXT_COLD_BLOCK
 : 
NEXT_HOT_BLOCK
)) {

1391 ià((
wa™
 % 1000) == 0) {

1392 
	`shªnÚ_w¬n
("wait for‚ext %s sb become‡vailable,‚ext_sb=%d, state=%s\n",

1393 
h—d_šdex
 ? "cŞd" : "hÙ", 
sb
->
Ãxt_sb
, 
	`¡©e_Çme
(
sdev
->
sbs
[sb->Ãxt_sb].
¡©e
));

1394 
wa™
 = 0;

1396 
wa™
++;

1397 
	`shªnÚ_m¦“p
(10);

1401 
	`upd©e_•og_h—d
(
sdev
, 
sb
);

1402 
	`wr™e_•og
(
sdev
, 
sb
, 
h—d
);

1404 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


1405 
	`shªnÚ_mem£t
((
u64
 *)
sdev
->
çke_twš_rd_bad_luÅba
 + ((
h—d_šdex
 == 0) ? 0 :

1406 (()
sdev
->
lun_couÁ
 * sdev->
logicbs_š_siblšg_eblock
/64)),

1407 0, 
sdev
->
lun_couÁ
 * sdev->
logicbs_š_siblšg_eblock
/8);

1408 
	`upd©e_çke_·‰”n
(
sdev
, 
sb
->
Ãxt_sb
, 
h—d_šdex
);

1410 
sdev
->
wr_sb
[
h—d_šdex
] = 
sb
->
Ãxt_sb
;

1411 
sdev
->
aùive_blk_¡¬t_jiff›s
[
h—d_šdex
] = 
	`g‘_jiff›s
();

1412 
sdev
->
aùive_blk
[
h—d_šdex
] = &sdev->
sbs
[
sb
->
Ãxt_sb
];

1413 
sdev
->
aùive_blk
[
h—d_šdex
]->
¡©e
 = 
aùive_blk_¡©e
[head_index];

1414 
sdev
->
wr_group
[
h—d_šdex
] = 0;

1415 
sdev
->
lun_š_group
[
h—d_šdex
] = 0;

1416 
sdev
->
wr_lun_off£t
[
h—d_šdex
] = sdev->
aùive_blk
[h—d_šdex]->
sub_group
[0].
fœ¡_lun_off£t
;

1417 
sdev
->
wr_chunk
[
h—d_šdex
] = 0;

1418 
sdev
->
wr_¶ªe
[
h—d_šdex
] = 0;

1419 
sdev
->
wr_·ge
[
h—d_šdex
] = 0;

1420 
sdev
->
wr_logicb
[
h—d_šdex
] = 0;

1421 
	`debugs1
("sb_šdex=%d, h—d_šdex=%d,‚ext_sb=%d.\n", 
sb
->
sb_šdex
, 
h—d_šdex
, sb->
Ãxt_sb
);

1424 ià(
	`uÆik–y
(
sdev
->
·r™y_š™_dÚe
[
h—d_šdex
] == 0)) {

1425 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
·r™y_š™_dÚe_ev’t
[
h—d_šdex
], sdev->
·r™y_š™_dÚe
[head_index] == 1);

1427 
sdev
->
·r™y_š™_dÚe
[
h—d_šdex
] = 0;

1429 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

1430 
	`£t_»q_debug_g
(
»q
, 
PARITY_INIT_TAG
, 0);

1431 
»q
->
İcode
 = 
sh_cmd_·r™y_š™
;

1432 
»q
->
h—d
 = head;

1433 
»q
->
µa
 = 
sb
->
Ãxt_sb
 * 
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
;

1434 
»q
->
d©a_luns
 = 
sdev
->
aùive_blk
[
h—d_šdex
]->
mš_d©a_luns
;

1435 
·r™y_lun
 = 
	`g‘_·r™y_lun
(&
sdev
->
aùive_blk
[
h—d_šdex
]->
sub_group
[0]);

1436 
»q
->
pba
.
lun
 = 
·r™y_lun
;

1437 
»q
->
pba
.
lun_pba
 =„eq->
µa
 * 
sdev
->
logicbs_š_·ge
;

1438 
	`shªnÚ_·r™y_š™_cmd
(
sdev
->
lun
[
·r™y_lun
]->
lun£t
, 
»q
);

1440 
	`mod_fl_sb_tim”
(
sdev
, 
h—d_šdex
, sdev->
aùive_blk
[head_index]);

1441 
	}
}

1443 
	$wr™e_chunk_to_æash
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
)

1445 
h—d
 = 
´eq
->head;

1446 
shªnÚ_»que¡
 *
»q
, *
·r™y
 = 
NULL
;

1447 
shªnÚ_sb
 *
sb
;

1448 
sub_group
 *
group
;

1450 ià(!
	`wr™e_chunk_is_v®id
(
´eq
, 
sdev
)) {

1451 
	`shªnÚ_”r
("lun=%d,†un_pba=0x%x.\n", 
´eq
->
pba
.
lun
,…»q->pba.
lun_pba
);

1452 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
´eq
->
chunk_li¡
, chunk_list) {

1453 
	`shªnÚ_”r
("lun=%d,†un_pba=0x%x.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

1456 
	`BUG_ON
(!
	`wr™e_chunk_is_v®id
(
´eq
, 
sdev
));

1457 
sb
 = 
sdev
->
sbs
 + 
´eq
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1459 
group
 = &
sb
->
sub_group
[
´eq
->
pba
.
lun
/
sdev
->
max_luns_š_group
];

1460 ià(
sdev
->
¿id5_suµÜ‹d
 && (sdev->
lun_š_group
[
´eq
->
h—d
 & 
HEAD_INDEX_MASK
] =ğ0è&& (
sb
->
sb_šdex
 >ğsdev->
mbr_eblocks
/sdev->
¶ªes
))

1461 
·r™y
 = 
	`make_·r™y_»q
(
sb
, 
	`g‘_·r™y_lun
(
group
), 
´eq
);

1463 
	`shªnÚ_wr™e_cmd
(
sdev
->
lun
[
´eq
->
pba
.lun]->
lun£t
,…req);

1465 ià(
·r™y
) {

1466 
	`shªnÚ_·r™y_cmd
(
sdev
->
lun
[
	`g‘_·r™y_lun
(
group
)]->
lun£t
, 
·r™y
);

1467 
·r™y
 = 
NULL
;

1470 ià(
	`uÆik–y
(
	`is_fœ¡_•og_pba
(
sb
, sb->
wr_off£t
))) {

1471 
	`sw™ch_to_Ãxt_sb
(
sdev
, 
sb
, 
h—d
);

1473 
	}
}

1475 
	$shªnÚ_pick_wr™e_æash_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, 
h—d_šdex
)

1477 ià(
sdev
->
chunk_»q
[
h—d_šdex
] =ğ
NULL
) {

1478 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

1479 
sdev
->
chunk_»q
[
h—d_šdex
] = 
»q
;

1481 
	`shªnÚ_li¡_add_
(&
»q
->
chunk_li¡
, &
sdev
->
chunk_»q
[
h—d_šdex
]->chunk_list);

1483 
sdev
->
chunk_»qút
[
h—d_šdex
]++;

1484 ià(
sdev
->
chunk_»qút
[
h—d_šdex
] =ğsdev->
logicbs_š_chunk
) {

1485 
	`wr™e_chunk_to_æash
(
sdev
, sdev->
chunk_»q
[
h—d_šdex
]);

1486 
sdev
->
chunk_»q
[
h—d_šdex
] = 
NULL
;

1487 
sdev
->
chunk_»qút
[
h—d_šdex
] = 0;

1490 
sdev
->
dœeù_wr™e_couÁ”
++;

1491 
	}
}

1493 #ifdeà
SHANNON_USE_WRITE_BUFFER


1494 
	$is_fœ¡_pba_š_chunk
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

1496 
eblk
;

1498 ià(
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
)

1500 
eblk
 = 
»q
->
pba
.
lun_pba
/(
sdev
->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
);

1501 ià(
eblk
 % 
sdev
->
¶ªes
)

1505 
	}
}

1507 
bufq_Œaffic_jam
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
);

1508 
bufq_Œaffic_low”
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
);

1509 
shªnÚ_pick_wr™e_buf_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

1511 
	$should_dœeù_wr™e
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, 
h—d_šdex
)

1513 ià(
shªnÚ_bufãr_wr™e
)

1515 ià(
»q
->
sbio
 =ğ
NULL
)

1517 ià(
»q
->
sbio
->
wr™e_m‘hod
 =ğ
BUFFER_WRITE
)

1519 ià(
»q
->
sbio
->
wr™e_m‘hod
 =ğ
DIRECT_WRITE
)

1527 ià(
	`bufq_Œaffic_jam
(
sdev
, 
h—d_šdex
)) {

1528 
»q
->
sbio
->
wr™e_m‘hod
 = 
DIRECT_WRITE
;

1531 
»q
->
sbio
->
wr™e_m‘hod
 = 
BUFFER_WRITE
;

1534 
	}
}

1537 
	$move_to_Ãxt_ov”Ïp_¶ªe
(
shªnÚ_dev
 *
dev
)

1539 
shªnÚ_ov”Ïp
 *
Ş
 = 
dev
->
ov”Ïp
;

1541 ià(
Ş
->
wr_¶ªe
 =ğ
dev
->
¶ªes
 - 1) {

1542 
Ş
->
wr_¶ªe
 = -1;

1544 
Ş
->
wr_¶ªe
++;

1546 
	}
}

1548 
	$move_to_Ãxt_ov”Ïp_·ge
(
shªnÚ_dev
 *
dev
)

1550 
shªnÚ_ov”Ïp
 *
Ş
 = 
dev
->
ov”Ïp
;

1552 
	`move_to_Ãxt_ov”Ïp_¶ªe
(
dev
);

1553 
Ş
->
wr_·ge
 = (Ş->
wr_¶ªe
 * 
dev
->
·ges_š_eblock
 + ol->
wr_chunk
);

1554 
	}
}

1556 
	$®loc_ov”Ïp_lun_pba
(
shªnÚ_dev
 *
sdev
, 
lun_pba
 *
pba
)

1558 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + sdev->
mbr
.
ov”Ïp_sblk
;

1559 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

1560 
logicb_t
 
eblk_pba
;

1562 ià(
	`uÆik–y
(
Ş
->
wr_¶ªe
 == -1)) {

1563 
	`shªnÚ_”r
("%s:ƒxûed ov”Ï°pb¨lim™.\n", 
sdev
->
sdisk
.
disk_Çme
);

1564 
	`BUG
();

1568 
eblk_pba
 = 
Ş
->
wr_·ge
 * 
sdev
->
logicbs_š_·ge
 + ol->
wr_logicb
;

1569 
pba
->
lun_pba
 = 
sdev
->
mbr
.
ov”Ïp_sblk
 * sdev->
logicbs_š_siblšg_eblock
 + 
eblk_pba
;

1570 
pba
->
lun
 = 
Ş
->
wr_lun
;

1572 
	`shªnÚ_©omic_šc
(&
sb
->
š_wr™e_logicbs
);

1574 
Ş
->
wr_logicb
++;

1575 ià(
Ş
->
wr_logicb
 =ğ
sdev
->
logicbs_š_·ge
) {

1576 
	`move_to_Ãxt_ov”Ïp_·ge
(
sdev
);

1577 
Ş
->
wr_logicb
 = 0;

1580 
	}
}

1582 
shªnÚ_pick_¿w_wr™e_buf_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

1583 
	$__shªnÚ_wr™e_ov”Ïp_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
, 
ov”wr™e
)

1585 ià(
	`uÆik–y
(!
ov”wr™e
))

1586 
	`®loc_ov”Ïp_lun_pba
(
sdev
, &
´eq
->
pba
);

1588 
´eq
->
pba
 = 
sdev
->
ov”Ïp
->pba;

1590 
	`shªnÚ_pick_¿w_wr™e_buf_»que¡
(
sdev
, 
´eq
);

1591 
	}
}

1593 
	$shªnÚ_wr™e_ov”Ïp_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
, 
ov”wr™e
)

1595 
´eq
->
_m‘ad©a
 = (((
u64
í»q->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
) | \

1596 (((
u64
)
´eq
->
ns_id
 & 
NS_ID_MASK
è<< 
NS_ID_SHIFT
) | \

1597 (((
u64
)
´eq
->
ns_£q_num
 & 
NS_SEQ_NUM_MASK
è<< 
NS_SEQ_NUM_SHIFT
) | \

1598 (
´eq
->
lba
 & 
LONG_LBA_MASK
);

1600 
	`__shªnÚ_wr™e_ov”Ïp_»que¡
(
sdev
, 
´eq
, 
ov”wr™e
);

1601 
	}
}

1603 
šlše
 
	$__shªnÚ_pick_wr™e_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
)

1605 
h—d_šdex
 = 
´eq
->
h—d
 & 
HEAD_INDEX_MASK
;

1607 
	`®loc_lun_pba
(
sdev
, 
´eq
->
_m‘ad©a
,…»q->
h—d
, &´eq->
pba
);

1608 
	`deü—£_£nd”_¡©i¡ics
(
sdev
, 
´eq
);

1610 #ifdeà
SHANNON_USE_WRITE_BUFFER


1611 ià(
	`is_fœ¡_pba_š_chunk
(
sdev
, 
´eq
)) {

1612 
sdev
->
chunk_¡¬t_jiff›s
[
h—d_šdex
] = 
	`g‘_jiff›s
();

1613 ià(
	`should_dœeù_wr™e
(
sdev
, 
´eq
, 
h—d_šdex
))

1614 
	`shªnÚ_pick_wr™e_æash_»que¡
(
sdev
, 
´eq
, 
h—d_šdex
);

1616 
	`shªnÚ_pick_wr™e_buf_»que¡
(
sdev
, 
´eq
);

1618 ià(
sdev
->
chunk_»qút
[
h—d_šdex
] == 0)

1619 
	`shªnÚ_pick_wr™e_buf_»que¡
(
sdev
, 
´eq
);

1621 
	`shªnÚ_pick_wr™e_æash_»que¡
(
sdev
, 
´eq
, 
h—d_šdex
);

1624 
	`shªnÚ_pick_wr™e_æash_»que¡
(
sdev
, 
´eq
, 
h—d_šdex
);

1626 
	}
}

1628 
	$shªnÚ_pick_wr™e_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
)

1630 
h—d_šdex
 = 
´eq
->
h—d
 & 
HEAD_INDEX_MASK
;

1632 ià(
	`uÆik–y
((
h—d_šdex
 =ğ
MBR_INDEX
è|| (
sdev
->
š™_dÚe
 < 
STAGE_RECOVER_ACTIVE_DONE
))) {

1633 
	`shªnÚ_wr™e_cmd
(
sdev
->
lun
[
´eq
->
pba
.lun]->
lun£t
,…req);

1637 
´eq
->
_m‘ad©a
 = (((
u64
í»q->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
) | \

1638 (((
u64
)
´eq
->
ns_id
 & 
NS_ID_MASK
è<< 
NS_ID_SHIFT
) | \

1639 (((
u64
)
´eq
->
ns_£q_num
 & 
NS_SEQ_NUM_MASK
è<< 
NS_SEQ_NUM_SHIFT
) | \

1640 (
´eq
->
lba
 & 
LONG_LBA_MASK
);

1642 
	`__shªnÚ_pick_wr™e_»que¡
(
sdev
, 
´eq
);

1643 
	}
}

1645 
	$shªnÚ_pick_wr™e_m‘ad©a_»que¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
)

1647 
	`__shªnÚ_pick_wr™e_»que¡
(
sdev
, 
´eq
);

1648 
	}
}

1650 *
	$İcode_Çme
(
shªnÚ_İcode
 
İcode
)

1652 
İcode
) {

1653 
sh_cmd_´e_»ad
:

1655 
sh_cmd_»ad
:

1657 
sh_cmd_wr™e
:

1659 
sh_cmd_”a£
:

1661 
sh_cmd_·r™y
:

1663 
sh_cmd_·r™y_š™
:

1669 
	}
}

1671 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


1672 
	$d•th_to_šdex
(
d•th
)

1674 
šdex
 = 0;

1676 
d•th
 = depth >> 3;

1677 
d•th
) {

1678 
d•th
 = depth >> 1;

1679 
šdex
++;

1681  
šdex
;

1682 
	}
}

1685 
	$ho¡_»q_queue_Ëngth
(
shªnÚ_dev
 *
sdev
)

1687  
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[0]) + shannon_atomic_read(&sdev->write_reqs[1]) + shannon_atomic_read(&sdev->write_reqs[2]);

1688 
	}
}

1690 
	$lun£t_»q_queue_is_em±y
(
shªnÚ_lun£t
 *
lun£t
)

1692 ià(!
	`shªnÚ_li¡_em±y
(&
lun£t
->
»q_queue
))

1696 
	}
}

1698 
	$®l_lun£t_»q_queue_is_em±y
(
shªnÚ_dev
 *
sdev
)

1700 
i
;

1701 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

1702 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
lun£ts
[
i
].
»q_queue
))

1705 
	}
}

1707 
	$®l_»q_queue_is_em±y
(
shªnÚ_dev
 *
sdev
)

1709  
	`ho¡_»q_queue_is_em±y
(
sdev
è&& 
	`gc_wr™e_queue_is_em±y
(sdev);

1710 
	}
}

1712 
	$gc_wr™e_queue_is_em±y
(
shªnÚ_dev
 *
sdev
)

1714  
	`shªnÚ_li¡_em±y
(&
sdev
->
gc_wr™e_queue
);

1715 
	}
}

1717 
	$ho¡_»q_queue_is_em±y
(
shªnÚ_dev
 *
sdev
)

1719  
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[0]) && shannon_list_empty(&sdev->req_queue[1]) && shannon_list_empty(&sdev->req_queue[2]);

1720 
	}
}

1722 
shªnÚ_»ad_buf_cmd
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
);

1723 
put_chunk_»q_to_buf
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
, 
h—d_šdex
);

1725 
	$»ad_ov”Ïp_d©a_ÿÎback
(
shªnÚ_bio
 *
sbio
)

1727 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

1728 
shªnÚ_»que¡
 *
»q
;

1729 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

1730 
shªnÚ_sb
 *
sb
 = 
sdev
->
sbs
 + sdev->
mbr
.
ov”Ïp_sblk
;

1732 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1733 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

1734 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

1735 
»q
->
¡©e
 = 
REQ_CALLBACK
;

1736 
	`BUG_ON
(
sb
->
sb_šdex
 !ğ
»q
->
pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
);

1738 
	`BUG_ON
(
»q
->
»»ad
 & 
RAID_READ_MASK
);

1739 
	`BUG_ON
(
Ş
->
_m‘ad©a
 !ğ
»q
->_metadata);

1741 
Ş
->
ov”Ïp_wr™eback
 = 0;

1742 
	`shªnÚ_b¬r›r
();

1743 
	`shªnÚ_wake_up
(&
sdev
->
ov”Ïp
->
wa™_ov”Ïp_ev’t
);

1744 
	}
}

1746 
	$»ad_ov”Ïp_d©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
)

1748 
	`£t_sbio_debug_g
(
sbio
, 
OVERLAP_WRITE_BACK_TAG
);

1749 
sbio
->
vœt_addr
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

1750 
sbio
->
logicbs
 = 1;

1751 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

1752 
sbio
->
ÿÎback
 = 
»ad_ov”Ïp_d©a_ÿÎback
;

1753 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

1754 
sbio
->
d©a
 = 
sdev
;

1755 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_FROMDEVICE
);

1756 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

1757 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

1758 
	`BUG
();

1759 
out
;

1762 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 0);

1763 
»q
->
İcode
 = 
sh_cmd_»ad
;

1764 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

1765 
»q
->
lba
 = 
sdev
->
ov”Ïp
->
_m‘ad©a
 & 
LONG_LBA_MASK
;

1766 
»q
->
_m‘ad©a
 = 
sdev
->
ov”Ïp
->_metadata;

1767 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

1768 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

1769 
»q
->
£q_num
 = 
MAX_SEQ_NUM
;

1770 
»q
->
pba
 = 
sdev
->
ov”Ïp
->pba;

1771 
»q
->
sbio
 = sbio;

1772 
»q
->
£nd”
 = 
FROM_OVERLAP
;

1773 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
bio_li¡
);

1774 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

1775 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

1776 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1791 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[
»q
->
pba
.lun],„eq);

1793 
	`lun£t_pick_»que¡
(
sdev
->
lun
[
»q
->
pba
.lun]->
lun£t
, 1);

1797 
out
:

1798 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

1799 
sbio
->
vœt_addr
 = 
NULL
;

1800  -
EIO
;

1801 
	}
}

1803 
	$wr™e_ov”Ïp_d©a_ÿÎback
(
shªnÚ_bio
 *
sbio
)

1805 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

1806 
shªnÚ_sb
 *
sb
;

1807 
shªnÚ_»que¡
 *
»q
;

1808 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

1809 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

1810 
shªnÚ_poŞ
 *
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

1811 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

1813 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

1814 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
sbio
->
»q_li¡
));

1815 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, 
shªnÚ_»que¡
, 
bio_li¡
);

1816 
»q
->
¡©e
 = 
REQ_CALLBACK
;

1818 ià(
¥oŞ
) {

1819 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

1820 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

1821 
	`shªnÚ_šfo
("%s():‚ame¥aû‚s_id=%d mighˆb»moved ju¡‚ow.\n", 
__func__
, 
»q
->
ns_id
);

1822 
out
;

1824 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

1825 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

1826 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

1827 
out
;

1829 
sdisk
 = &
ns
->sdisk;

1830 
	`BUG_ON
(
sdev
->
mbr
.
sdev_id
 =ğ0 && 
»q
->
lba
 =ğ
šv®id_lba
[sdev->
lba_fÜm©
]);

1833 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

1834 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

1835 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

1836 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

1837 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

1838 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

1840 
	`shªnÚ_šfo
("sbio->¡¬t_£ùÜ=0x%lx, sbio->¡©us=0x%x.\n", 
sbio
->
¡¬t_£ùÜ
, sbio->
¡©us
);

1842 
	`shªnÚ_©omic_sub
(1, &
sb
->
š_wr™e_logicbs
);

1844 
out
:

1845 
Ş
->
ov”Ïp_wr™eback
 = 0;

1846 
	`shªnÚ_b¬r›r
();

1847 
	`shªnÚ_wake_up
(&
Ş
->
wa™_ov”Ïp_ev’t
);

1849 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

1850 
	}
}

1852 
	$wr™e_ov”Ïp_d©a
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
, 
shªnÚ_»que¡
 *
»q
)

1854 
	`£t_sbio_debug_g
(
sbio
, 
OVERLAP_WRITE_BACK_TAG
);

1855 
sbio
->
logicbs
 = 1;

1856 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 1);

1857 
sbio
->
ÿÎback
 = 
wr™e_ov”Ïp_d©a_ÿÎback
;

1858 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

1859 
sbio
->
d©a
 = 
sdev
;

1860 
sbio
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, sbio->
vœt_addr
, sdev->
logicb_size
, 
SHANNON_DMA_TODEVICE
);

1861 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
sbio
->
dma_add»ss
)) {

1862 
	`shªnÚ_”r
("shannon_dma_map_singleƒrror.\n");

1863 
	`BUG
();

1864 
out
;

1867 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 0);

1868 
»q
->
İcode
 = 
sh_cmd_wr™e
;

1869 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

1870 
»q
->
vœt_addr
 = 
sbio
->virt_addr;

1871 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

1872 
»q
->
dma_add»ss
 = 
sbio
->dma_address;

1873 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

1874 
»q
->
sbio
 = sbio;

1875 
»q
->
£nd”
 = 
FROM_OVERLAP
;

1876 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

1878 
»q
->
sbio
->
wr™e_m‘hod
 = 
BUFFER_WRITE
;

1879 
	`BUG_ON
(
sdev
->
chunk_»qút
[
»q
->
h—d
 & 
HEAD_INDEX_MASK
] != 0);

1881 
	`shªnÚ_pick_wr™e_»que¡
(
sdev
, 
»q
);

1884 
out
:

1885 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

1886 
sbio
->
vœt_addr
 = 
NULL
;

1887  -
EIO
;

1888 
	}
}

1890 
	$wr™e_back_ov”Ïp_d©a
(
shªnÚ_dev
 *
sdev
)

1892 
»t
 = 0;

1893 
shªnÚ_bio
 *
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

1894 
shªnÚ_»que¡
 *
ov”Ïp_»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

1895 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

1896 
h—d_šdex
 = (
Ş
->
h—d
 & 
HEAD_INDEX_MASK
);

1898 
Ş
->
ov”Ïp_wr™eback
 = 1;

1899 ià(
	`uÆik–y
(
	`»ad_ov”Ïp_d©a
(
sdev
, 
sbio
, 
ov”Ïp_»q
) < 0)) {

1900 
	`shªnÚ_”r
("%s:„ead back overlap†baƒrror,†ba=%lu,†un=%d,†un_pba=%d.\n", \

1901 
sdev
->
sdisk
.
disk_Çme
, 
ov”Ïp_»q
->
lba
, 
Ş
->
pba
.
lun
, ol->pba.
lun_pba
);

1902 
»t
 = -1;

1903 
out
;

1905 
	`shªnÚ_wa™_ev’t
(
Ş
->
wa™_ov”Ïp_ev’t
, ol->
ov”Ïp_wr™eback
 == 0);

1906 ià(
sdev
->
chunk_»qút
[
h—d_šdex
]) {

1908 
vaÿncy
 = (
sdev
->
¶ªes
 - sdev->
wr_¶ªe
[
h—d_šdex
]è* sdev->
logicbs_š_·ge
 - sdev->
wr_logicb
[head_index];

1909 
	`BUG_ON
(
sdev
->
chunk_»qút
[
h—d_šdex
] >ğsdev->
logicbs_š_chunk
);

1910 
vaÿncy
) {

1911 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
h—d_šdex
]);

1912 
vaÿncy
--;

1916 
Ş
->
ov”Ïp_wr™eback
 = 1;

1917 
ov”Ïp_»q
->
h—d
 = 
Ş
->head;

1918 
ov”Ïp_»q
->
sbio
->
wr™e_m‘hod
 = 
BUFFER_WRITE
;

1919 ià(
	`wr™e_ov”Ïp_d©a
(
sdev
, 
sbio
, 
ov”Ïp_»q
) < 0) {

1920 
	`shªnÚ_”r
("%s: write back overlap†baƒrror,†ba=%lu,†un=%d,†un_pba=%d.\n", \

1921 
sdev
->
sdisk
.
disk_Çme
, 
ov”Ïp_»q
->
lba
, ov”Ïp_»q->
pba
.
lun
, ov”Ïp_»q->pba.
lun_pba
);

1922 
»t
 = -1;

1923 
out
;

1925 
	`shªnÚ_wa™_ev’t
(
Ş
->
wa™_ov”Ïp_ev’t
, ol->
ov”Ïp_wr™eback
 == 0);

1927 
out
:

1928 ià(
sbio
->
vœt_addr
)

1929 
	`ä“_logicb_buf
(
sdev
, 
sbio
->
vœt_addr
);

1930 
	`ä“_»q
(
ov”Ïp_»q
);

1931 
	`ä“_sbio
(
sbio
);

1932  
»t
;

1933 
	}
}

1935 
	$shªnÚ_wr™e_»que¡_š_ov”Ïp_mode
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
´eq
)

1937 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

1938 
h—d_šdex
 = 
´eq
->
h—d
 & 
HEAD_INDEX_MASK
;

1940 
	`BUG_ON
(!
sdev
->
ov”Ïp_wr™e
);

1942 ià(
	`uÆik–y
((
h—d_šdex
 =ğ
MBR_INDEX
è|| (
sdev
->
š™_dÚe
 < 
STAGE_RECOVER_ACTIVE_DONE
))) {

1943 
	`shªnÚ_wr™e_cmd
(
sdev
->
lun
[
´eq
->
pba
.lun]->
lun£t
,…req);

1947 
´eq
->
_m‘ad©a
 = (((
u64
í»q->
d©©y³
 & 
DATATYPE_MASK
è<< 
DATATYPE_SHIFT
) | \

1948 (((
u64
)
´eq
->
ns_id
 & 
NS_ID_MASK
è<< 
NS_ID_SHIFT
) | \

1949 (((
u64
)
´eq
->
ns_£q_num
 & 
NS_SEQ_NUM_MASK
è<< 
NS_SEQ_NUM_SHIFT
) | \

1950 (
´eq
->
lba
 & 
LONG_LBA_MASK
);

1952 ià(
´eq
->
£nd”
 =ğ
FROM_GC
)

1953 
	`shªnÚ_pick_wr™e_m‘ad©a_»que¡
(
sdev
, 
´eq
);

1955 ià(
	`uÆik–y
(
Ş
->
cİy_”r
)) {

1956 
	`BUG_ON
(
Ş
->
_m‘ad©a
 =ğ
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
]);

1958 ià(
	`wr™e_back_ov”Ïp_d©a
(
sdev
) == 0) {

1959 
Ş
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
];

1960 
Ş
->
cİy_”r
 = 0;

1961 } ià(
Ş
->
_m‘ad©a
 =ğ
´eq
->_metadata) {

1962 
	`__shªnÚ_wr™e_ov”Ïp_»que¡
(
sdev
, 
´eq
, 1);

1963 
Ş
->
cİy_”r
 = 0;

1967 ià(
´eq
->
sbio
->
ov”Ïp
) {

1968 ià(
´eq
->
šdex
 == 0) {

1969 ià((
Ş
->
_m‘ad©a
 !ğ
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
]è&& (Ş->_m‘ad©¨!ğ
´eq
->_metadata)) {

1970 ià(
	`uÆik–y
(
	`wr™e_back_ov”Ïp_d©a
(
sdev
) < 0))

1971 
Ş
->
cİy_”r
 = 1;

1973 ià(
	`uÆik–y
(
Ş
->
cİy_”r
))

1974 
Ş
->
cİy_”r
 = 0;

1975 
Ş
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
];

1977 } ià(
Ş
->
_m‘ad©a
 =ğ
´eq
->_metadata) {

1978 
	`BUG_ON
(
Ş
->
h—d
 !ğ
´eq
->head);

1979 
Ş
->
h™_couÁ
++;

1980 
Ş
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
];

1982 ià(
sdev
->
chunk_»qút
[
h—d_šdex
]) {

1984 
vaÿncy
 = (
sdev
->
¶ªes
 - sdev->
wr_¶ªe
[
h—d_šdex
]è* sdev->
logicbs_š_·ge
 - sdev->
wr_logicb
[head_index];

1985 
	`BUG_ON
(
sdev
->
chunk_»qút
[
h—d_šdex
] >ğsdev->
logicbs_š_chunk
);

1986 
vaÿncy
) {

1987 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
h—d_šdex
]);

1988 
vaÿncy
--;

1991 
´eq
->
sbio
->
wr™e_m‘hod
 = 
BUFFER_WRITE
;

1994 ià(
´eq
->
šdex
 =ğÕ»q->
sbio
->
logicbs
 - 1è&& (
	`lik–y
(!
Ş
->
cİy_”r
))) {

1995 
Ş
->
_m‘ad©a
 = 
´eq
->_metadata;

1996 
Ş
->
h—d
 = 
´eq
->head;

1997 
´eq
->
Üig_h—d
 =…»q->
h—d
;

1999 
´eq
->
h—d
 = 
OVERLAP_HEAD
;

2000 
	`__shªnÚ_wr™e_ov”Ïp_»que¡
(
sdev
, 
´eq
, 1);

2002 
	`shªnÚ_pick_wr™e_m‘ad©a_»que¡
(
sdev
, 
´eq
);

2005 ià(
Ş
->
_m‘ad©a
 !ğ
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
]) {

2006 ià(
	`uÆik–y
(
	`wr™e_back_ov”Ïp_d©a
(
sdev
) < 0)) {

2007 
Ş
->
cİy_”r
 = 1;

2009 ià(
	`uÆik–y
(
Ş
->
cİy_”r
))

2010 
Ş
->
cİy_”r
 = 0;

2012 
	`£nd_dummy_ov”Ïp_»q
(
sdev
, 1);

2013 
Ş
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
];

2017 ià(
	`uÆik–y
(
Ş
->
cİy_”r
è&& (Ş->
_m‘ad©a
 =ğ
´eq
->_metadata)) {

2018 
	`__shªnÚ_wr™e_ov”Ïp_»que¡
(
sdev
, 
´eq
, 1);

2019 
Ş
->
cİy_”r
 = 0;

2021 
	`shªnÚ_pick_wr™e_m‘ad©a_»que¡
(
sdev
, 
´eq
);

2024 
	}
}

2026 #ifdeà
SHANNON_USE_WRITE_BUFFER


2027 
šlše
 
	$chunk_timeout
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

2029 ià(
sdev
->
chunk_¡¬t_jiff›s
[
h—d_šdex
])

2030  ((
	`g‘_jiff›s
(è- 
sdev
->
chunk_¡¬t_jiff›s
[
h—d_šdex
]è>ğsdev->
fl_chunk_tim”_expœe
);

2032 
	}
}

2035 
šlše
 
shªnÚ_»que¡
 *
	$pick_ho¡_wr™e_»q
(
shªnÚ_dev
 *
sdev
)

2037 
shªnÚ_»que¡
 *
´eq
 = 
NULL
;

2038 
i
;

2040 
i
 = 
PRIORITY_LEVELS
 - 1; i >=0; i--) {

2041 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[
i
]))

2043 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[
i
]) > 1) {

2044 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
»q_queue
[
i
], 
shªnÚ_»que¡
, 
li¡
);

2045 ià(
´eq
->
İcode
 =ğ
sh_cmd_wr™e
)

2046 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2048 
´eq
 = 
NULL
;

2050 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

2051 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
»q_queue
[
i
], 
shªnÚ_»que¡
, 
li¡
);

2052 ià(
´eq
->
İcode
 =ğ
sh_cmd_wr™e
)

2053 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2055 
´eq
 = 
NULL
;

2056 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

2058 ià(
´eq
)

2059 
	`shªnÚ_©omic_dec
(&
sdev
->
wr™e_»qs
[
i
]);

2062  
´eq
;

2063 
	}
}

2065 
šlše
 
shªnÚ_»que¡
 *
	$pick_äom_»q_queue
(
shªnÚ_dev
 *
sdev
)

2067 
shªnÚ_»que¡
 *
´eq
 = 
NULL
;

2068 
i
;

2070 
i
 = 
PRIORITY_LEVELS
 - 1; i >=0; i--) {

2071 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[
i
]))

2073 ià(
sdev
->
h¬d_queue_lim™
 && (
i
 =ğ0è&& (
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
) > sdev->hard_queue_limit))

2075 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[
i
]) > 1) {

2076 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
»q_queue
[
i
], 
shªnÚ_»que¡
, 
li¡
);

2077 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2079 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

2080 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
»q_queue
[
i
], 
shªnÚ_»que¡
, 
li¡
);

2081 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2082 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

2084 ià(
´eq
->
İcode
 =ğ
sh_cmd_wr™e
)

2085 
	`shªnÚ_©omic_dec
(&
sdev
->
wr™e_»qs
[
i
]);

2088  
´eq
;

2089 
	}
}

2091 
šlše
 
shªnÚ_»que¡
 *
	$pick_äom_gc_wr™e_queue
(
shªnÚ_dev
 *
sdev
)

2093 
shªnÚ_»que¡
 *
´eq
 = 
NULL
;

2095 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
gc_wr™e_queue
))

2096 
out
;

2097 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
gc_wr™e_»qs
) > 1) {

2098 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
gc_wr™e_queue
, 
shªnÚ_»que¡
, 
li¡
);

2099 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2101 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
gc_wr™e_queue_lock
);

2102 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
gc_wr™e_queue
, 
shªnÚ_»que¡
, 
li¡
);

2103 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2104 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_wr™e_queue_lock
);

2106 
	`shªnÚ_©omic_dec
(&
sdev
->
gc_wr™e_»qs
);

2107 
out
:

2108  
´eq
;

2109 
	}
}

2111 
shªnÚ_»que¡
 *
	$pick_Ãxt_»que¡
(
shªnÚ_dev
 *
sdev
)

2113 
shªnÚ_»que¡
 *
´eq
;

2114 
picked
 = 1;

2115 
agaš
:

2116 ià((
sdev
->
ho¡_wr™es
 =ğ0è&& (sdev->
gc_wr™es
 == 0)) {

2117 
times
;

2118 
gc_wr™es
;

2119 
sdev
->
ho¡_wr™es
 = sdev->
logicbs_š_chunk
;

2120 ià(
	`gc_wr™e_queue_is_em±y
(
sdev
))

2121 
sdev
->
gc_wr™es
 = 0;

2123 
times
 = (
sdev
->
gc_çùÜ
 + 
GC_DIVIDE_FACTOR
 - 1)/GC_DIVIDE_FACTOR;

2124 
gc_wr™es
 = 
sdev
->
ho¡_wr™es
 * 
times
;

2125 
sdev
->
gc_wr™es
 = (gc_wr™e < sdev->
logicbs_š_chunk
) ? sdev->logicbs_in_chunk : gc_writes;

2127 
picked
 = 0;

2129 ià(
sdev
->
ho¡_wr™es
) {

2130 
´eq
 = 
	`pick_äom_»q_queue
(
sdev
);

2131 ià(
´eq
) {

2132 
sdev
->
ho¡_wr™es
--;

2133  
´eq
;

2135 
sdev
->
ho¡_wr™es
 = 0;

2137 
´eq
 = 
	`pick_äom_gc_wr™e_queue
(
sdev
);

2138 ià(
´eq
) {

2139 
sdev
->
gc_wr™es
--;

2140  
´eq
;

2142 
sdev
->
gc_wr™es
 = 0;

2143 ià(!
	`®l_»q_queue_is_em±y
(
sdev
è&& (
picked
 != 0))

2144 
agaš
;

2146  
NULL
;

2148 
	}
}

2150 
	$pick_ho¡_»q_to_fl_chunk
(
shªnÚ_dev
 *
sdev
)

2152 
shªnÚ_»que¡
 *
´eq
;

2153 
couÁ
 = 0;

2154 
h—d_šdex
;

2156 ià(
	`ho¡_»q_queue_is_em±y
(
sdev
))

2159 
sdev
->
chunk_»qút
[
HOT_INDEX
] && (
couÁ
 < (sdev->
logicbs_š_chunk
 * 2))) {

2160 
´eq
 = 
NULL
;

2161 
´eq
 = 
	`pick_ho¡_wr™e_»q
(
sdev
);

2162 ià(
´eq
 =ğ
NULL
)

2165 
couÁ
++;

2166 ià(
	`is_wa™_pick_»q
(
´eq
))

2167 
	`hªdË_wa™_pick_»q
(
sdev
, 
´eq
);

2168 
h—d_šdex
 = 
´eq
->
h—d
 & 
HEAD_INDEX_MASK
;

2169 if(
´eq
->
£nd”
 =ğ
FROM_HOST
) {

2170 
sdev
->
ho¡_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

2171 } ià(
´eq
->
£nd”
 =ğ
FROM_GC
) {

2172 ià(
	`pba_is_šv®id
(
sdev
, 
´eq
->
Şd_pba
.
lun
,…»q->Şd_pba.
lun_pba
)) {

2173 
	`gc_wr™e_ÿnûl
(
sdev
, 
´eq
);

2177 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

2179 
	`shªnÚ_pick_wr™e_»que¡
(
sdev
, 
´eq
);

2181 ià(
	`ho¡_»q_queue_Ëngth
(
sdev
è< 
REQ_QUEUE_THRESHOLD_L
)

2182 
sdev
->
š_block_¡©e
 = 0;

2183 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[1]è< 
REQ_QUEUE_THRESHOLD_L
) {

2184 ià(
sdev
->
š_block_¡©e
 > 1)

2185 
sdev
->
š_block_¡©e
 = 1;

2188 ià((
sdev
->
š_block_¡©e
 < 2è&& 
	`shªnÚ_wa™queue_aùive
(&sdev->
lim™_»q_queue
[1]))

2189 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

2191 ià((
sdev
->
š_block_¡©e
 < 1è&& 
	`shªnÚ_wa™queue_aùive
(&sdev->
lim™_»q_queue
[0]))

2192 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

2194 
	}
}

2196 
	$__shªnÚ_pick_»que¡
(
shªnÚ_dev
 *
sdev
, 
lim™
)

2198 
shªnÚ_lun
 *
lun
;

2199 
shªnÚ_»que¡
 *
fœ¡_rd_»q
 = 
NULL
, *
´eq
 = NULL, *
»q
;

2200 
rd_chunk
 = 0, 
chunk
, 
rd_·ge
 = 0, 
·ge
, 
rd_»qs
 = 0;

2201 
i
, 
h—d_šdex
;

2202 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


2203 
d•th
, 
šdex
;

2205 #iâdeà
SHANNON_USE_WRITE_BUFFER


2206 
fœ¡_wr™e
[2];

2207 
fœ¡_wr™e
[
HOT_INDEX
] = 0;

2208 
fœ¡_wr™e
[
COLD_INDEX
] = 0;

2211 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


2212 
shªnÚ_lun£t
 *
lun£t
;

2213 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

2214 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

2215 
lun£t
 = &
sdev
->
lun£ts
[
i
];

2216 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 
	`»ad_»g_§ã
(sdev, &sdev->lun£ts[i].
lun_b¬
->
cq_h—d
);

2218 
d•th
 = (
sdev
->
lun£ts
[
i
].
sq_h—d
 + 
QUEUE_SIZE
 - sdev->lun£ts[i].
cq_hw_h—d
) % QUEUE_SIZE;

2219 
šdex
 = 
	`d•th_to_šdex
(
d•th
);

2220 
sdev
->
lun£ts
[
i
].
pick_sq_d•th
[
šdex
]++;

2221 
d•th
 = (
sdev
->
lun£ts
[
i
].
sq_h—d
 + 
QUEUE_SIZE
 - sdev->lun£ts[i].
cq_
) % QUEUE_SIZE;

2222 
šdex
 = 
	`d•th_to_šdex
(
d•th
);

2223 
sdev
->
lun£ts
[
i
].
pick_scq_d•th
[
šdex
]++;

2228 ià(
lim™
 == 0)

2230 
lim™
--;

2232 
´eq
 = 
NULL
;

2233 ià(
sdev
->
cmd_queue_wr™es_lim™
 && (
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
) > sdev->cmd_queue_writes_limit))

2236 
´eq
 = 
	`pick_Ãxt_»que¡
(
sdev
);

2237 ià(
´eq
 =ğ
NULL
)

2240 
´eq
->
¡©e
 = 
REQ_PICKED
;

2241 ià(
	`is_wa™_pick_»q
(
´eq
))

2242 
	`hªdË_wa™_pick_»q
(
sdev
, 
´eq
);

2243 
´eq
->
İcode
) {

2244 
sh_cmd_advªûd_»ad
:

2245 
sdev
->
tÙ®_»ad_£ùÜs
++;

2246 #ifdeà
SHANNON_USE_WRITE_BUFFER


2247 ià(
	`‹¡_pba_š_bufq
(
sdev
, 
´eq
->
pba
.
lun
,…»q->pba.
lun_pba
)) {

2248 ià(
	`shªnÚ_»ad_buf_cmd
(
sdev
, 
´eq
) == 0)

2252 
lun
 = 
sdev
->lun[
´eq
->
pba
.lun];

2253 ià(
sdev
->
advªûd_»ad_¡©e
 & 
UPDATING_MICROCODE_MASK
) {

2254 ià(
	`add_adv_»ad_»que¡_li¡_
(
sdev
, 
´eq
) > 0) {

2256 
	`shªnÚ_©omic_šc
(&
sdev
->
š_cmd_queue_adv_»ads
);

2257 
	`shªnÚ_advªûd_»ad
(
lun
->
lun£t
, 
´eq
);

2259 
sdev
->
tÙ®_»ad_£ùÜs
--;

2261 
	`shªnÚ_©omic_šc
(&
sdev
->
š_cmd_queue_adv_»ads
);

2262 
	`shªnÚ_advªûd_»ad
(
lun
->
lun£t
, 
´eq
);

2266 
sh_cmd_»ad
:

2267 
sdev
->
tÙ®_»ad_£ùÜs
++;

2268 #ifdeà
SHANNON_USE_WRITE_BUFFER


2269 ià(
	`‹¡_pba_š_bufq
(
sdev
, 
´eq
->
pba
.
lun
,…»q->pba.
lun_pba
)) {

2270 ià(
	`shªnÚ_»ad_buf_cmd
(
sdev
, 
´eq
) == 0)

2275 ià(
fœ¡_rd_»q
 =ğ
NULL
) {

2276 
	`SHANNON_INIT_LIST_HEAD
(&
´eq
->
chunk_li¡
);

2277 
fœ¡_rd_»q
 = 
´eq
;

2278 
rd_»qs
 = 1;

2279 
rd_·ge
 = 
´eq
->
pba
.
lun_pba
/
sdev
->
logicbs_š_·ge
;

2280 
rd_chunk
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
rd_·ge
);

2282 
·ge
 = 
´eq
->
pba
.
lun_pba
/
sdev
->
logicbs_š_·ge
;

2283 
chunk
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
·ge
);

2284 ià((
sdev
->
p£udo_¶ªe
 && ((
·ge
 !ğ
rd_·ge
è|| (
´eq
->
pba
.
lun
 !ğ
fœ¡_rd_»q
->pba.lunè|| (
rd_»qs
 >ğsdev->
logicbs_š_·ge
))) || \

2285 ((
chunk
 !ğ
rd_chunk
è|| (
´eq
->
pba
.
lun
 !ğ
fœ¡_rd_»q
->pba.lunè|| (
rd_»qs
 >ğ
sdev
->
logicbs_š_chunk
))) {

2286 
lun
 = 
sdev
->lun[
fœ¡_rd_»q
->
pba
.lun];

2287 
	`shªnÚ_»ad_cmd
(
lun
->
lun£t
, 
fœ¡_rd_»q
);

2289 
	`SHANNON_INIT_LIST_HEAD
(&
´eq
->
chunk_li¡
);

2290 
fœ¡_rd_»q
 = 
´eq
;

2291 
rd_»qs
 = 1;

2292 
rd_·ge
 = 
·ge
;

2293 
rd_chunk
 = 
chunk
;

2296 ià(
´eq
->
pba
.
lun_pba
 < 
fœ¡_rd_»q
->pba.lun_pba) {

2297 
	`shªnÚ_li¡_add_
(&
´eq
->
chunk_li¡
, &
fœ¡_rd_»q
->chunk_list);

2298 
fœ¡_rd_»q
 = 
´eq
;

2300 
	`shªnÚ_li¡_fÜ_—ch_’Œy_»v”£
(
»q
, &
fœ¡_rd_»q
->
chunk_li¡
, chunk_list) {

2301 ià(
»q
->
pba
.
lun_pba
 < 
´eq
->pba.lun_pba)

2304 
	`shªnÚ_li¡_add
(&
´eq
->
chunk_li¡
, &
»q
->chunk_list);

2306 
rd_»qs
++;

2310 
sh_cmd_wr™e
:

2311 
h—d_šdex
 = 
´eq
->
h—d
 & 
HEAD_INDEX_MASK
;

2312 if(
´eq
->
£nd”
 =ğ
FROM_HOST
) {

2313 
sdev
->
ho¡_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

2314 ià(
sdev
->
©omic_wr™e
 && (
	`g‘_»q_šdex
(
´eq
) == 0)) {

2315 
vaÿncy
 = (
sdev
->
¶ªes
 - sdev->
wr_¶ªe
[
h—d_šdex
]è* sdev->
logicbs_š_·ge
 - sdev->
wr_logicb
[head_index];

2316 ià((
vaÿncy
 < 
sdev
->
logicbs_š_chunk
è&& (vaÿncy < 
´eq
->
sbio
->
logicbs
)) {

2317 
vaÿncy
) {

2318 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
h—d_šdex
]);

2319 
vaÿncy
--;

2323 } ià(
´eq
->
£nd”
 =ğ
FROM_GC
) {

2324 ià(
	`pba_is_šv®id
(
sdev
, 
´eq
->
Şd_pba
.
lun
,…»q->Şd_pba.
lun_pba
)) {

2325 
	`gc_wr™e_ÿnûl
(
sdev
, 
´eq
);

2329 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

2330 #iâdeà
SHANNON_USE_WRITE_BUFFER


2331 ià(
fœ¡_wr™e
[
h—d_šdex
] == 0) {

2332 
fœ¡_wr™e
[
h—d_šdex
] = 1;

2333 ià(
h—d_šdex
 =ğ
HOT_INDEX
)

2334 
	`__shªnÚ_ÿnûl_d–ayed_wÜk
(&
sdev
->
hÙ_d–ayed_·d
);

2336 
	`__shªnÚ_ÿnûl_d–ayed_wÜk
(&
sdev
->
cŞd_d–ayed_·d
);

2340 ià(
sdev
->
ov”Ïp_wr™e
)

2341 
	`shªnÚ_wr™e_»que¡_š_ov”Ïp_mode
(
sdev
, 
´eq
);

2343 
	`shªnÚ_pick_wr™e_»que¡
(
sdev
, 
´eq
);

2345 ià(
	`ho¡_»q_queue_Ëngth
(
sdev
è< 
REQ_QUEUE_THRESHOLD_L
)

2346 
sdev
->
š_block_¡©e
 = 0;

2347 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[1]è< 
REQ_QUEUE_THRESHOLD_L
) {

2348 ià(
sdev
->
š_block_¡©e
 > 1)

2349 
sdev
->
š_block_¡©e
 = 1;

2352 ià((
sdev
->
š_block_¡©e
 < 2è&& 
	`shªnÚ_wa™queue_aùive
(&sdev->
lim™_»q_queue
[1]))

2353 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

2355 ià((
sdev
->
š_block_¡©e
 < 1è&& 
	`shªnÚ_wa™queue_aùive
(&sdev->
lim™_»q_queue
[0]))

2356 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

2359 
sh_cmd_”a£
:

2360 
lun
 = 
sdev
->lun[
´eq
->
pba
.lun];

2361 
	`shªnÚ_”a£_cmd
(
lun
->
lun£t
, 
´eq
);

2364 
sh_cmd_·r™y
:

2365 
lun
 = 
sdev
->lun[
´eq
->
pba
.lun];

2366 
	`shªnÚ_·r™y_cmd
(
lun
->
lun£t
, 
´eq
);

2369 
sh_cmd_·r™y_š™
:

2370 
lun
 = 
sdev
->lun[
´eq
->
pba
.lun];

2371 
	`shªnÚ_·r™y_š™_cmd
(
lun
->
lun£t
, 
´eq
);

2375 
	`shªnÚ_w¬n
("UnknowÀİcode=0x%x.\n", 
´eq
->
İcode
);

2376 
	`shªnÚ_w¬n
("lba=%ld,†un=%d,†un_pba=%d.\n", 
´eq
->
lba
,…»q->
pba
.
lun
,…»q->pba.
lun_pba
);

2381 ià(
fœ¡_rd_»q
) {

2382 
lun
 = 
sdev
->lun[
fœ¡_rd_»q
->
pba
.lun];

2383 
	`shªnÚ_»ad_cmd
(
lun
->
lun£t
, 
fœ¡_rd_»q
);

2384 
fœ¡_rd_»q
 = 
NULL
;

2387 #ifdeà
SHANNON_USE_WRITE_BUFFER


2388 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

2389 ià(
sdev
->
chunk_»qút
[
i
] && !
	`bufq_Œaffic_jam
(sdev, i)) {

2390 
	`put_chunk_»q_to_buf
(
sdev
, sdev->
chunk_»q
[
i
], i);

2391 
sdev
->
chunk_»q
[
i
] = 
NULL
;

2392 
sdev
->
chunk_»qút
[
i
] = 0;

2395 ià(
	`chunk_timeout
(
sdev
, 
i
è&& (sdev->
chunk_»qút
[i] == 0)) {

2396 
vaÿncy
 = (
sdev
->
¶ªes
 - sdev->
wr_¶ªe
[
i
]è* sdev->
logicbs_š_·ge
 - sdev->
wr_logicb
[i];

2397 ià(
vaÿncy
 && (vaÿncy < 
sdev
->
logicbs_š_chunk
)) {

2398 
vaÿncy
) {

2399 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

2400 
sdev
->
fl_İ’_chunk_logicbs
++;

2401 
sdev
->
tÙ®_wr™e_£ùÜs
 +ğsdev->
£ùÜs_š_logicb
;

2402 
vaÿncy
--;

2409 ià(
sdev
->
chunk_»qút
[
HOT_INDEX
] && (sdev->
š™_dÚe
 >ğ
STAGE9_DONE
è&& !sdev->
©omic_wr™e
 && !sdev->
ov”Ïp_wr™e
)

2410 
	`pick_ho¡_»q_to_fl_chunk
(
sdev
);

2412 #iâdeà
SHANNON_USE_WRITE_BUFFER


2413 ià(
sdev
->
chunk_»q
[
HOT_INDEX
])

2414 
	`shªnÚ_queue_d–ayed_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
hÙ_d–ayed_·d
, 5);

2415 ià(
sdev
->
u£_du®_h—d
) {

2416 ià(
sdev
->
chunk_»q
[
COLD_INDEX
])

2417 
	`shªnÚ_queue_d–ayed_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
cŞd_d–ayed_·d
, 10);

2420 
	}
}

2422 
šlše
 
	$check_h¬d_queue_lim™
(
shªnÚ_dev
 *
sdev
)

2424 ià(
sdev
->
h¬d_queue_lim™
) {

2425 ià((!
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[0]è&& (
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
è< sdev->
h¬d_queue_lim™
)) || \

2426 !
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[1]è|| !shªnÚ_li¡_em±y(&sdev->»q_queue[2]è|| !shªnÚ_li¡_em±y(&sdev->
gc_wr™e_queue
))

2428 } ià(!
	`®l_»q_queue_is_em±y
(
sdev
)) {

2433 
	}
}

2435 
šlše
 
	$Ãed_queue_pick_wÜk
(
shªnÚ_dev
 *
sdev
)

2437 
i
;

2439 #ifdeà
SHANNON_USE_WRITE_BUFFER


2440 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

2441 ià(
sdev
->
chunk_»q
[
i
] && 
	`bufq_Œaffic_low”
(sdev, i))

2446 ià(
sdev
->
cmd_queue_wr™es_lim™
) {

2447 ià((
	`shªnÚ_©omic_»ad
(&
sdev
->
š_cmd_queue_wr™es
è>ğ
	`GET_CMD_QUEUE_WRITES_THRESHOLD_L
(sdev)))

2451  
	`check_h¬d_queue_lim™
(
sdev
);

2452 
	}
}

2454 
	$shªnÚ_pick_»que¡
(
shªnÚ_dev
 *
sdev
, 
lim™
)

2456 ià(
	`shªnÚ_mu‹x_Œylock
(&
sdev
->
pick_£m
) == 0)

2457  -
EBUSY
;

2458 
	`__shªnÚ_pick_»que¡
(
sdev
, 
lim™
);

2459 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

2461 ià(
	`Ãed_queue_pick_wÜk
(
sdev
))

2462 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

2464 
	}
}

2466 
	$show_pick_£m_š_debugfs
(
shªnÚ_dev
 *
sdev
)

2468 ià(
	`shªnÚ_mu‹x_Œylock
(&
sdev
->
pick_£m
) == 0)

2470 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

2472 
	`shªnÚ_log
("%s(): queue_wÜk iÀdebugfs.\n", 
__func__
);

2473 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

2475 
	}
}

2477 
	$lun£t_pick_»que¡
(
shªnÚ_lun£t
 *
lun£t
, 
lim™
)

2479 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

2480 
shªnÚ_»que¡
 *
fœ¡_rd_»q
 = 
NULL
, *
´eq
 = NULL, *
»q
;

2481 
rd_chunk
 = 0, 
chunk
, 
rd_·ge
 = 0, 
·ge
, 
rd_»qs
 = 0;

2483 ià(
	`shªnÚ_mu‹x_Œylock
(&
lun£t
->
lun_pick_£m
) == 0)

2484  -
EBUSY
;

2487 !
	`shªnÚ_li¡_em±y
(&
lun£t
->
»q_queue
)) {

2488 ià(
lim™
 == 0)

2490 
lim™
--;

2491 
	`shªnÚ_¥š_lock_bh
(&
lun£t
->
»q_queue_lock
);

2492 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
lun£t
->
»q_queue
, 
shªnÚ_»que¡
, 
li¡
);

2493 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

2494 
´eq
->
¡©e
 = 
REQ_PICKED
;

2495 
	`shªnÚ_¥š_uÆock_bh
(&
lun£t
->
»q_queue_lock
);

2497 
´eq
->
İcode
) {

2498 
sh_cmd_advªûd_»ad
:

2499 
sdev
->
tÙ®_»ad_£ùÜs
++;

2500 #ifdeà
SHANNON_USE_WRITE_BUFFER


2501 ià(
	`‹¡_pba_š_bufq
(
sdev
, 
´eq
->
pba
.
lun
,…»q->pba.
lun_pba
)) {

2502 ià(
	`shªnÚ_»ad_buf_cmd
(
sdev
, 
´eq
) == 0)

2506 ià(
sdev
->
advªûd_»ad_¡©e
 & 
UPDATING_MICROCODE_MASK
) {

2507 ià(
	`add_adv_»ad_»que¡_li¡_
(
sdev
, 
´eq
) > 0) {

2509 
	`shªnÚ_©omic_šc
(&
sdev
->
š_cmd_queue_adv_»ads
);

2510 
	`shªnÚ_advªûd_»ad
(
lun£t
, 
´eq
);

2512 
sdev
->
tÙ®_»ad_£ùÜs
--;

2514 
	`shªnÚ_©omic_šc
(&
sdev
->
š_cmd_queue_adv_»ads
);

2515 
	`shªnÚ_advªûd_»ad
(
lun£t
, 
´eq
);

2519 
sh_cmd_»ad
:

2520 ià(
´eq
->
£nd”
 =ğ
FROM_HOST
)

2521 
lun£t
->
ho¡_»ad_£ùÜs
 +ğ
sdev
->
£ùÜs_š_logicb
;

2522 
sdev
->
tÙ®_»ad_£ùÜs
++;

2523 #ifdeà
SHANNON_USE_WRITE_BUFFER


2524 ià(
	`‹¡_pba_š_bufq
(
sdev
, 
´eq
->
pba
.
lun
,…»q->pba.
lun_pba
)) {

2525 ià(
	`shªnÚ_»ad_buf_cmd
(
sdev
, 
´eq
) == 0)

2529 ià(
fœ¡_rd_»q
 =ğ
NULL
) {

2530 
	`SHANNON_INIT_LIST_HEAD
(&
´eq
->
chunk_li¡
);

2531 
fœ¡_rd_»q
 = 
´eq
;

2532 
rd_»qs
 = 1;

2533 
rd_·ge
 = 
´eq
->
pba
.
lun_pba
/
sdev
->
logicbs_š_·ge
;

2534 
rd_chunk
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
rd_·ge
);

2536 
·ge
 = 
´eq
->
pba
.
lun_pba
/
sdev
->
logicbs_š_·ge
;

2537 
chunk
 = 
	`g‘_·ge_š_fœ¡_¶ªe
(
sdev
, 
·ge
);

2538 ià((
sdev
->
p£udo_¶ªe
 && ((
·ge
 !ğ
rd_·ge
è|| (
´eq
->
pba
.
lun
 !ğ
fœ¡_rd_»q
->pba.lunè|| (
rd_»qs
 >ğsdev->
logicbs_š_·ge
))) || \

2539 ((
chunk
 !ğ
rd_chunk
è|| (
´eq
->
pba
.
lun
 !ğ
fœ¡_rd_»q
->pba.lunè|| (
rd_»qs
 >ğ
sdev
->
logicbs_š_chunk
))) {

2540 
	`shªnÚ_»ad_cmd
(
lun£t
, 
fœ¡_rd_»q
);

2542 
	`SHANNON_INIT_LIST_HEAD
(&
´eq
->
chunk_li¡
);

2543 
fœ¡_rd_»q
 = 
´eq
;

2544 
rd_»qs
 = 1;

2545 
rd_·ge
 = 
·ge
;

2546 
rd_chunk
 = 
chunk
;

2549 ià(
´eq
->
pba
.
lun_pba
 < 
fœ¡_rd_»q
->pba.lun_pba) {

2550 
	`shªnÚ_li¡_add_
(&
´eq
->
chunk_li¡
, &
fœ¡_rd_»q
->chunk_list);

2551 
fœ¡_rd_»q
 = 
´eq
;

2553 
	`shªnÚ_li¡_fÜ_—ch_’Œy_»v”£
(
»q
, &
fœ¡_rd_»q
->
chunk_li¡
, chunk_list) {

2554 ià(
»q
->
pba
.
lun_pba
 < 
´eq
->pba.lun_pba)

2557 
	`shªnÚ_li¡_add
(&
´eq
->
chunk_li¡
, &
»q
->chunk_list);

2559 
rd_»qs
++;

2564 
sh_cmd_wr™e
:

2565 
	`BUG_ON
(
sdev
->
lun
[
´eq
->
pba
.lun]->
lun£t
 !=†unset);

2566 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

2567 
	`BUG_ON
(
´eq
->
h—d
 !ğ
MBR_HEAD
);

2568 
	`BUG_ON
(
´eq
->
pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
 >ğsdev->
mbr_eblocks
/sdev->
¶ªes
);

2570 
	`shªnÚ_wr™e_cmd
(
lun£t
, 
´eq
);

2573 
sh_cmd_”a£
:

2574 
	`shªnÚ_”a£_cmd
(
lun£t
, 
´eq
);

2578 
	`shªnÚ_w¬n
("UnknowÀİcode=0x%x.\n", 
´eq
->
İcode
);

2579 
	`shªnÚ_w¬n
("lba=%ld,†un=%d,†un_pba=%d.\n", 
´eq
->
lba
,…»q->
pba
.
lun
,…»q->pba.
lun_pba
);

2585 ià(
fœ¡_rd_»q
) {

2586 
	`shªnÚ_»ad_cmd
(
lun£t
, 
fœ¡_rd_»q
);

2587 
fœ¡_rd_»q
 = 
NULL
;

2589 
	`shªnÚ_mu‹x_uÆock
(&
lun£t
->
lun_pick_£m
);

2591 ià(!
	`shªnÚ_li¡_em±y
(&
lun£t
->
»q_queue
)) {

2592 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &
lun£t
->
subm™_wÜk
);

2596 
	}
}

2598 
shªnÚ_subm™_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
);

2600 
	$shªnÚ_lun£t_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

2602 
shªnÚ_lun£t
 *
lun£t
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_lun£t, 
subm™_wÜk
);

2603 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

2604 
i
, 
»t
, 
couÁ
;

2606 
	`lun£t_pick_»que¡
(
lun£t
, 
sdev
->
logicbs_š_chunk
);

2608 
couÁ
 = 0;

2609 
»t
 = 0;

2610 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

2611 
lun£t
 = &
sdev
->
lun£ts
[
i
];

2612 ià(!
	`shªnÚ_li¡_em±y
(&
lun£t
->
»q_queue
)) {

2613 
»t
 = 
	`lun£t_pick_»que¡
(
lun£t
, 
sdev
->
logicbs_š_chunk
);

2614 ià(
»t
 == 1)

2615 
couÁ
++;

2618 } 
couÁ
);

2619 
	}
}

2621 
	$shªnÚ_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

2623 
shªnÚ_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, shannon_dev, work);

2625 
__echo_š
;

2626 
	`shªnÚ_pick_»que¡
(
dev
, 0xffffffff);

2627 
	}
}

2630 
	$shªnÚ_disÿrd
(
shªnÚ_dev
 *
sdev
, 
logicb64_t
 
¡¬t_lba
,†ogicb64_ˆ
’d_lba
)

2632 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

2633 
i
, 
sb_šdex
;

2634 
logicb64_t
 
lba
;

2635 
lun_pba
 
Şd_pba
;

2637 
	`debugs1
("¡¬t_lba=%Îd, couÁ=%Îd.\n", 
¡¬t_lba
, 
’d_lba
 - start_lba);

2638 ià(
¡¬t_lba
 >ğ
’d_lba
)

2641 
i
 = 0; i < 
LOCK_COUNT
; i++) {

2642 
lba
 = 
¡¬t_lba
 + 
i
;

2643 ià(
lba
 >ğ
’d_lba
)

2645 
	`Ímt_lock
(
sdev
, 
sdisk
, 
lba
);

2647 
	`g‘_lun_pba_äom_lba
(
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

2648 ià((
Şd_pba
.
lun_pba
 !ğ0x03ffffffè&& !
	`‹¡_wr™e_š_´oûss
(
sdev
, &old_pba)) {

2649 
sb_šdex
 = 
Şd_pba
.
lun_pba
 / 
sdev
->
logicbs_š_siblšg_eblock
;

2650 ià(
sdev
->
u£_du®_h—d
) {

2651 ià((
sb_šdex
 !ğ
sdev
->
wr_sb
[
HOT_INDEX
]è&& (sb_šdex !ğsdev->wr_sb[
COLD_INDEX
])) {

2652 
	`upd©e_m­pšg_bË
(
sdisk
, 
lba
, 0x3ff, 0x03ffffff);

2653 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

2656 ià(
sb_šdex
 !ğ
sdev
->
wr_sb
[
HOT_INDEX
]) {

2657 
	`upd©e_m­pšg_bË
(
sdisk
, 
lba
, 0x3ff, 0x03ffffff);

2658 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

2662 
lba
 +ğ
LOCK_COUNT
;

2663 } 
lba
 < 
’d_lba
);

2664 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
lba
);

2666 
	}
}

2668 
	$shªnÚ_³riod_»ad_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

2670 
shªnÚ_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
³riod_»ad_wÜk
);

2671 
shªnÚ_sb
 *
sb
 = 
NULL
;

2672 
»t
 = -1;

2674 ià(!
	`ÿn_³riod_»ad
(
dev
))

2675 
di§bË_³riod_»ad
;

2676 
sb
 = 
	`g‘_³riod_»ad_sb
(
dev
);

2677 ià(
sb
) {

2678 ià(!
	`is_aùive_blk
(
sb
)) {

2679 ià(
sb
->
£q_num
 > 
dev
->
³riod_»ad
.
mš_£q_num
)

2680 
dev
->
³riod_»ad
.
mš_£q_num
 = 
sb
->
£q_num
;

2681 ià(
dev
->
³riod_»ad
.
max_£q_num
 == ~0x0)

2682 
dev
->
³riod_»ad
.
max_£q_num
 = dev->
£qu’û_numb”
 - 1;

2684 
	`shªnÚ_©omic_šc
(&
sb
->
š_³riod_»ad
);

2685 
»t
 = 
	`³riod_»ad_sb
(
dev
, 
sb
);

2686 ià(
»t
)

2687 
	`shªnÚ_©omic_dec
(&
sb
->
š_³riod_»ad
);

2690 
dev
->
³riod_»ad
.
mš_£q_num
 = 0x0;

2691 
dev
->
³riod_»ad
.
max_£q_num
 = ~0x0;

2692 
	`sbs_ş—n_³riod_»ad_dÚe
(
dev
);

2695 
	`do_Ãxt_³riod_»ad
(
dev
);

2698 
di§bË_³riod_»ad
:

2699 
dev
->
³riod_»ad
.
¡©e
 = 
PERIOD_READ_DISABLE
;

2700 
	`sbs_ş—n_³riod_»ad_dÚe
(
dev
);

2701 
	}
}

2703 
	$³riod_»ad_tim”_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

2705 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
³riod_»ad_tim”
);

2707 ià(
	`ÿn_³riod_»ad
(
sdev
))

2708 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_³riod_»ad_wq
, &sdev->
³riod_»ad_wÜk
);

2710 
sdev
->
³riod_»ad
.
¡©e
 = 
PERIOD_READ_DISABLE
;

2711 
	}
}

2713 
upd©e_d©a_š_dummy_·ge
(
shªnÚ_dev
 *
sdev
);

2714 #ifdeà
SHANNON_USE_WRITE_BUFFER


2716 
šlše
 
	$d–_fl_chunk_tim”
(
shªnÚ_dev
 *
sdev
, 
fl_h—d
)

2718 
i
;

2720 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

2721 ià(
fl_h—d
 & (1 << 
i
))

2722 
	`shªnÚ_d–_tim”
(&
sdev
->
fl_chunk_tim”
[
i
]);

2724 
	}
}

2726 
šlše
 
u64
 
	$g‘_fl_chunk_timeout
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

2728 
shªnÚ_sb
 *
sb
 = 
sdev
->
aùive_blk
[
h—d_šdex
];

2730 ià(
sb
 && sb->
fl_sb
)

2731  
	`g‘_jiff›s
(è+ 
	`g‘_HZ
() * 2 / 1000;

2733  
	`g‘_jiff›s
(è+ 
	`g‘_HZ
(è* 
sdev
->
fl_chunk_tim”_expœe
 / 1000;

2734 
	}
}

2736 
	$mod_fl_chunk_tim”
(
shªnÚ_dev
 *
sdev
, 
fl_h—d
)

2738 #iâdeà
CONFIG_SHANNON_PLVERIFY


2739 
i
;

2741 ià((
sdev
->
sdisk
.
ex™
 =ğ0è&& (sdev->
acûss_mode
 !ğ
SHN_MODE_READONLY
)) {

2742 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

2743 ià(
fl_h—d
 & (1 << 
i
))

2744 
	`shªnÚ_mod_tim”
(&
sdev
->
fl_chunk_tim”
[
i
], 
	`g‘_fl_chunk_timeout
(sdev, i));

2748 
	}
}

2750 
šlše
 
	$chunk_Ãed_fl
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

2752 ià(
sdev
->
aùive_blk
[
h—d_šdex
]->
fl_sb
) {

2754 ià((
sdev
->
wr_·ge
[
h—d_šdex
] != 0) || \

2755 (
sdev
->
wr_group
[
h—d_šdex
] != 0) || \

2756 (
sdev
->
lun_š_group
[
h—d_šdex
] != 0) || \

2757 (
sdev
->
wr_¶ªe
[
h—d_šdex
] != 0) || \

2758 (
sdev
->
wr_logicb
[
h—d_šdex
] != 0))

2762 ià((
sdev
->
wr_group
[
h—d_šdex
] != 0) || \

2763 (
sdev
->
lun_š_group
[
h—d_šdex
] != 0) || \

2764 (
sdev
->
wr_¶ªe
[
h—d_šdex
] != 0) || \

2765 (
sdev
->
wr_logicb
[
h—d_šdex
] != 0))

2770 
	}
}

2772 
	$·d_wr™e_chunk_ÿÎback
(
shªnÚ_bio
 *
sbio
)

2774 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

2775 
h—d_šdex
 = ()
sbio
->
d©a2
;

2776 
shªnÚ_»que¡
 *
»q
, *
tmp
;

2777 
shªnÚ_sb
 *
sb
;

2779 ià(
h—d_šdex
 >= 2) {

2780 
	`debugs0
("h—d_šdex=%d.\n", 
h—d_šdex
);

2781 
	`BUG
();

2784 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

2785 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

2786 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

2787 
	`ä“_»q
(
»q
);

2788 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

2790 
	`ä“_sbio
(
sbio
);

2792 ià(
sdev
->
aùive_blk
[
h—d_šdex
]->
fl_sb
) {

2793 
	`b®ªû_gc
(
sdev
, sdev->
logicbs_š_chunk
);

2795 ià((
sdev
->
wr_·ge
[
h—d_šdex
] != 0) || \

2796 (
sdev
->
wr_group
[
h—d_šdex
] != 0) || \

2797 (
sdev
->
lun_š_group
[
h—d_šdex
] != 0) || \

2798 (
sdev
->
wr_¶ªe
[
h—d_šdex
] != 0) || \

2799 (
sdev
->
wr_logicb
[
h—d_šdex
] != 0))

2800 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
h—d_šdex
));

2803 ià((
sdev
->
wr_group
[
h—d_šdex
] != 0) || \

2804 (
sdev
->
lun_š_group
[
h—d_šdex
] != 0) || \

2805 (
sdev
->
wr_¶ªe
[
h—d_šdex
] != 0) || \

2806 (
sdev
->
wr_logicb
[
h—d_šdex
] != 0))

2807 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
h—d_šdex
));

2809 
	}
}

2811 
	$·d_bufãr_wr™e_chunk
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
)

2813 
shªnÚ_»que¡
 *
»q
;

2814 
shªnÚ_bio
 *
sbio
;

2815 
d–
 = 0, 
´iÜ™y
 = 1;

2817 ià(
	`uÆik–y
(
sdev
->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)))

2820 ià(
sdev
->
sdisk
.
š_»cÚfig
) {

2821 
	`mod_fl_chunk_tim”
(
sdev
, (1 << 
h—d_šdex
));

2825 
	`debugs1
("enter: head_index=%d, wr_plane=%d, wr_logicb=%d.\n",

2826 
h—d_šdex
, 
sdev
->
wr_¶ªe
[h—d_šdex], sdev->
wr_logicb
[head_index]);

2827 ià(
	`chunk_Ãed_fl
(
sdev
, 
h—d_šdex
))

2828 
d–
 = (
sdev
->
¶ªes
 - sdev->
wr_¶ªe
[
h—d_šdex
]è* sdev->
logicbs_š_·ge
 - sdev->
wr_logicb
[head_index];

2829 ià((
d–
 <ğ0è|| (d– > 
sdev
->
logicbs_š_chunk
))

2832 
sbio
 = 
	`®loc_sbio
(
GFP_NOWAIT
);

2833 
	`£t_sbio_debug_g
(
sbio
, 
FILL_BUFFER_WRITE_CHUNK_TAG
);

2834 
sbio
->
ÿÎback
 = 
·d_wr™e_chunk_ÿÎback
;

2835 
sbio
->
d©a
 = 
sdev
;

2836 
sbio
->
d©a2
 = (*)()
h—d_šdex
;

2837 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

2838 
sbio
->
logicbs
 = 
d–
;

2839 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

2840 
	`debugs1
("h—d_šdex=%d, d–=%d.\n", 
h—d_šdex
, 
d–
);

2841 
	`upd©e_d©a_š_dummy_·ge
(
sdev
);

2842 
d–
) {

2843 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

2844 
	`£t_»q_debug_g
(
»q
, 
FILL_BUFFER_WRITE_CHUNK_TAG
, 
d–
);

2845 
»q
->
İcode
 = 
sh_cmd_wr™e
;

2846 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

2847 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

2848 
»q
->
h—d
 = 
wr™e_h—d
[
h—d_šdex
];

2849 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

2850 
»q
->
dma_add»ss
 = 
sdev
->
dummy_dma_·ge
;

2851 
»q
->
vœt_addr
 = 
sdev
->
dummy_·ge
;

2852 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

2853 
»q
->
sbio
 = sbio;

2854 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

2855 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 
´iÜ™y
);

2856 
d–
--;

2857 
sdev
->
fl_İ’_chunk_logicbs
++;

2859 
	`debugs1
("exit: head_index=%d, wr_plane=%d, wr_logicb=%d.\n",

2860 
h—d_šdex
, 
sdev
->
wr_¶ªe
[h—d_šdex], sdev->
wr_logicb
[head_index]);

2862 
	}
}

2864 
	$hÙ_fl_chunk_tim”_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

2866 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
fl_chunk_tim”
[
HOT_INDEX
]);

2867 
»t
;

2869 
»t
 = 
	`·d_bufãr_wr™e_chunk
(
sdev
, 
HOT_INDEX
);

2870 ià(
»t
)

2871 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

2872 
	}
}

2874 
	$cŞd_fl_chunk_tim”_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

2876 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
fl_chunk_tim”
[
COLD_INDEX
]);

2877 
»t
;

2879 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


2880 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

2882 
»t
 = 
	`·d_bufãr_wr™e_chunk
(
sdev
, 
COLD_INDEX
);

2883 ià(
»t
)

2884 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

2885 
	}
}

2889 
šlše
 
	$d–_fl_chunk_tim”
(
shªnÚ_dev
 *
sdev
, 
fl_h—d
)

2892 
	}
}

2894 
	$mod_fl_chunk_tim”
(
shªnÚ_dev
 *
sdev
, 
fl_h—d
)

2897 
	}
}

2900 
	$·d_hÙ_dummy_»q
(
shªnÚ_dev
 *
sdev
)

2902 
shªnÚ_»que¡
 *
»q
;

2903 
d–
, 
´iÜ™y
 = 1;

2905 ià(
sdev
->
sdisk
.
š_»cÚfig
)

2910 ià(
sdev
->
chunk_»q
[
HOT_INDEX
] =ğ
NULL
)

2915 
	`upd©e_d©a_š_dummy_·ge
(
sdev
);

2916 
d–
 = 
sdev
->
logicbs_š_chunk
 - sdev->
chunk_»qút
[
HOT_INDEX
];

2917 
d–
) {

2918 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

2919 
	`£t_»q_debug_g
(
»q
, 
HOT_TIMER_FN_TAG
, 0);

2920 
»q
->
İcode
 = 
sh_cmd_wr™e
;

2921 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

2922 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

2923 
»q
->
h—d
 = 
HOT_HEAD
;

2924 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

2925 
»q
->
dma_add»ss
 = 
sdev
->
dummy_dma_·ge
;

2926 
»q
->
vœt_addr
 = 
sdev
->
dummy_·ge
;

2927 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

2928 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 
´iÜ™y
);

2929 
d–
--;

2932 
	}
}

2935 
	$·d_cŞd_dummy_»q
(
shªnÚ_dev
 *
sdev
)

2937 
shªnÚ_»que¡
 *
»q
;

2938 
d–
, 
´iÜ™y
 = 1;

2940 ià(
sdev
->
sdisk
.
š_»cÚfig
)

2943 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


2944 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

2947 ià(
sdev
->
chunk_»q
[
COLD_INDEX
] =ğ
NULL
)

2952 
	`upd©e_d©a_š_dummy_·ge
(
sdev
);

2953 
d–
 = 
sdev
->
logicbs_š_chunk
 - sdev->
chunk_»qút
[
COLD_INDEX
];

2954 
d–
) {

2955 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

2956 
	`£t_»q_debug_g
(
»q
, 
COLD_TIMER_FN_TAG
, 0);

2957 
»q
->
İcode
 = 
sh_cmd_wr™e
;

2958 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

2959 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

2960 
»q
->
h—d
 = 
COLD_HEAD
;

2961 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

2962 
»q
->
dma_add»ss
 = 
sdev
->
dummy_dma_·ge
;

2963 
»q
->
vœt_addr
 = 
sdev
->
dummy_·ge
;

2964 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

2965 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 
´iÜ™y
);

2966 
d–
--;

2969 
	}
}

2971 
	$hÙ_·d_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

2973 
shªnÚ_dev
 *
dev
 = 
	`cÚš”_of
((
shªnÚ_d–ayed_wÜk
 *)
wÜk
, shªnÚ_dev, 
hÙ_d–ayed_·d
);

2975 ià(
	`·d_hÙ_dummy_»q
(
dev
))

2976 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
wÜk
);

2977 
	}
}

2979 
	$cŞd_·d_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

2981 
shªnÚ_dev
 *
dev
 = 
	`cÚš”_of
((
shªnÚ_d–ayed_wÜk
 *)
wÜk
, shªnÚ_dev, 
cŞd_d–ayed_·d
);

2983 ià(
	`·d_cŞd_dummy_»q
(
dev
))

2984 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
wÜk
);

2985 
	}
}

2988 
	$shªnÚ_pm_qos_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

2990 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
pm_qos_wÜk
);

2992 ià(
	`shªnÚ_bio_š_æight
(
sdev
) == 0)

2993 
	`shªnÚ_pm_qos_upd©e_»quœem’t
(&
sdev
->
pm_qos_l
, 
SHANNON_PM_QOS_CPU_DMA_LATENCY
, sdev->
sdisk
.
disk_Çme
, 
SHANNON_PM_QOS_DEFAULT_VALUE
);

2994 
	}
}

2998 
	$ho¡_g‘_h—d_ªd_£t_pba_bË
(
shªnÚ_dev
 *
dev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio_t
 *
bio
, 
shªnÚ_»que¡
 *
»q
)

3000 
h—d_šdex
;

3001 
shªnÚ_sb
 *
Şd_sb
;

3003 #ifdeà
CONFIG_SHANNON_PLVERIFY


3004 ià(
dev
->
¶ù¾
 & 0x01) {

3005 ià(((
__u8
 *)
»q
->
vœt_addr
)[0] & 0x01) {

3006 
»q
->
h—d
 = 
HOT_HEAD
;

3010 
»q
->
h—d
 = 
COLD_HEAD
;

3015 ià(!
dev
->
¥oŞ
 && dev->
´iÜ™ize_wr™e
 && 
bio
) {

3016 ià(
	`shªnÚ_bio_æagged
(
bio
, 
BIO_RW_PRIO
))

3017 
»q
->
h—d
 = 
HOT_HEAD
;

3019 
»q
->
h—d
 = 
COLD_HEAD
;

3020 ià(
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
Şd_pba
, 
NULL
, 
sdisk
) < 0)

3022 
END
;

3025 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
Şd_pba
, 
NULL
, 
sdisk
);

3026 ià(
»q
->
Şd_pba
.
lun_pba
 == 0x03ffffff) {

3027 
»q
->
h—d
 = (
shªnÚ_š™_‹mp
 > 
HIGHEST_COLD_STATE
è? 
HOT_HEAD
 : 
COLD_HEAD
;

3031 
Şd_sb
 = 
dev
->
sbs
 + 
»q
->
Şd_pba
.
lun_pba
/dev->
logicbs_š_siblšg_eblock
;

3032 
»q
->
h—d
 = (
shªnÚ_š™_‹mp
 > 
HIGHEST_COLD_STATE
è? 
HOT_HEAD
 : 
COLD_HEAD
;

3035 ià(
	`‹¡_wr™e_š_´oûss
(
dev
, &
»q
->
Şd_pba
)) {

3036 
h—d_šdex
 = 
	`g‘_pba_Ãxt_h—d
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
);

3037 
»q
->
h—d
 = (
h—d_šdex
 =ğ
HOT_INDEX
è? 
HOT_HEAD
 : 
COLD_HEAD
;

3038 
END
;

3042 ià(
Şd_sb
->
sb_šdex
 =ğ
dev
->
wr_sb
[
HOT_INDEX
])

3043 
»q
->
h—d
 = 
HOT_HEAD
;

3044 ià(
dev
->
u£_du®_h—d
) {

3045 ià(
Şd_sb
->
sb_šdex
 =ğ
dev
->
wr_sb
[
COLD_INDEX
])

3046 
»q
->
h—d
 = 
COLD_HEAD
;

3049 
END
:

3050 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


3051 
	`BUG_ON
((!
dev
->
u£_du®_h—d
è&& (
»q
->
h—d
 =ğ
COLD_HEAD
));

3053 
	`£t_pba_Ãxt_h—d
(
dev
, 
»q
->
Şd_pba
.
lun
,„eq->Şd_pba.
lun_pba
,„eq->
h—d
);

3054 
	`£t_ho¡_wr™e_¡©e
(
dev
, &
»q
->
Şd_pba
);

3055 
	}
}

3057 
	$g‘_wr_off£t
(
shªnÚ_sb
 *
sb
, 
lun
, 
logicb_t
 
lun_pba_off£t
)

3059 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

3060 
logicbs_š_·r™y_group
 = 
sdev
->
logicbs_š_chunk
 * sdev->
max_luns_š_group
;

3061 
logicbs_š_·ge_¡re
 = 
logicbs_š_·r™y_group
 * 
sdev
->
max_avaabË_groups
;

3062 
group_šdex
 = 
lun
/
sdev
->
max_luns_š_group
;

3063 
sub_group
 *
group
 = &
sb
->sub_group[
group_šdex
];

3064 
chunk
 = (
lun_pba_off£t
 % 
sdev
->
logicbs_š_eblock
)/sdev->
logicbs_š_·ge
;

3065 
¶ªe
 = 
lun_pba_off£t
 / 
sdev
->
logicbs_š_eblock
;

3066 
lun_off£t
 = (
lun
 + 
sdev
->
max_luns_š_group
 - 
	`fœ¡_lun
(
group
)) % sdev->max_luns_in_group;

3068  
logicbs_š_·ge_¡re
 * 
chunk
 + \

3069 
logicbs_š_·r™y_group
 * 
group
->
phy_šdex
 + \

3070 
sdev
->
logicbs_š_chunk
 * 
lun_off£t
 + \

3071 
sdev
->
logicbs_š_·ge
 * 
¶ªe
 + \

3072 
lun_pba_off£t
%
sdev
->
logicbs_š_·ge
;

3073 
	}
}

3075 
	$com·»_lun_pba
(
shªnÚ_dev
 *
sdev
, 
lun_pba
 *
pba1
, lun_pb¨*
pba2
)

3077 
shªnÚ_sb
 *
sb1
, *
sb2
;

3078 
sb_off£t1
, 
sb_off£t2
;

3080 
sb1
 = 
sdev
->
sbs
 + 
pba1
->
lun_pba
 / sdev->
logicbs_š_siblšg_eblock
;

3081 
sb2
 = 
sdev
->
sbs
 + 
pba2
->
lun_pba
 / sdev->
logicbs_š_siblšg_eblock
;

3083 ià(
sb1
->
sb_šdex
 =ğ
sb2
->sb_index) {

3084 
sb_off£t1
 = 
	`g‘_wr_off£t
(
sb1
, 
pba1
->
lun
,…ba1->
lun_pba
 % 
sdev
->
logicbs_š_siblšg_eblock
);

3085 
sb_off£t2
 = 
	`g‘_wr_off£t
(
sb2
, 
pba2
->
lun
,…ba2->
lun_pba
 % 
sdev
->
logicbs_š_siblšg_eblock
);

3086  
sb_off£t1
 - 
sb_off£t2
;

3087 } ià(
sb1
->
£q_num
 > 
sb2
->seq_num)

3091 
	}
}

3093 
	$fs_bio_»ad_ÿÎback
(
shªnÚ_bio
 *
sbio
)

3095 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

3096 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

3097 
shªnÚ_»que¡
 *
»q
, *
tmp
;

3099 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


3100 
	`shªnÚ_©omic_dec
(&
sdev
->
»ad_bios
);

3102 
	`shªnÚ_dma_unm­_sg
(
sdev
->
pci_dev
, 
sbio
->
sg
, sbio->
u£d_sg_couÁ
, sbio->
dma_dœ
);

3103 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

3104 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

3105 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

3106 
fœ¡_size
 = 
sdev
->
logicb_size
 - (()
»q
->
vœt_addr
 & (sdev->logicb_size - 1));

3107 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
fœ¡_size
);

3108 ià(
fœ¡_size
 < 
sdev
->
logicb_size
)

3109 
	`shªnÚ_memıy
(
»q
->
vœt_addr_2
,„eq->
»cov”_buf
 + 
fœ¡_size
, 
sdev
->
logicb_size
 - first_size);

3110 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

3112 ià(
	`uÆik–y
(
sbio
->
¡©us
))

3113 
	`shªnÚ_”r
("lba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n",

3114 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

3115 
	`ä“_»q
(
»q
);

3118 
	`shªnÚ_com¶‘e_fs_io
(
sdisk
->
ho¡d©a
, sdisk->
gd
, 
sbio
);

3119 ià(
sbio
->
sg_couÁ
)

3120 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

3122 
sbio
->
Ï‹ncy
 = ((
	`g‘_jiff›s
(è- sbio->
¡¬t_time
è* 1000è/ 
	`g‘_HZ
();

3123 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
)

3124 
	`»cÜd_Ï‹ncy
(
sdisk
, 
sbio
);

3125 
	`ä“_sbio
(
sbio
);

3126 
	}
}

3129 
	$wr™e_»que¡_dÚe
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
)

3131 
lun_pba
 
Şd_pba
;

3133 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

3136 ià(
Şd_pba
.
lun_pba
 != 0x03ffffff) {

3137 ià(
sdev
->
ov”Ïp_wr™e
) {

3138 ià(
	`pba_is_equ®
(&
»q
->
pba
, &
sdev
->
ov”Ïp
->pba)) {

3139 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

3140 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

3141 ià(!
	`pba_is_equ®
(&
Şd_pba
, &
sdev
->
ov”Ïp
->
pba
))

3142 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

3144 
	`shªnÚ_©omic_dec
(&(
sdev
->
sbs
 + 
Şd_pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
)->
v®id_·ges
);

3145 
	`£t_ho¡_wr™e_¡©e
(
sdev
, &
»q
->
pba
);

3146 
	`£t_pba_Ãxt_h—d
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
Üig_h—d
);

3147 
	`BUG_ON
(
	`‹¡_gc_wr™e_¡©e
(
sdev
, &
»q
->
pba
è|| 
	`‹¡_gc_»ad_¡©e
(sdev, &req->pba));

3149 } ià(
	`pba_is_equ®
(&
Şd_pba
, &
sdev
->
ov”Ïp
->
pba
)) {

3150 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

3151 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

3152 
	`shªnÚ_©omic_dec
(&(
sdev
->
sbs
 + 
Şd_pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
)->
v®id_·ges
);

3156 ià(
	`com·»_lun_pba
(
sdev
, &
»q
->
pba
, &
Şd_pba
) > 0) {

3157 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

3158 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

3159 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

3162 
	`debugs1
("new_sb=%d,†un=%d,†un_pba=%d, old_sb=%d,†un=%d,†un_pba=%d.\n",

3163 
»q
->
pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
,„eq->pba.
lun
,„eq->pba.lun_pba,

3164 
Şd_pba
.
lun_pba
/
sdev
->
logicbs_š_siblšg_eblock
, old_pba.
lun
, old_pba.lun_pba);

3165 
	`£t_ho¡_wr™e_šv®id
(
sdev
, &
»q
->
pba
);

3168 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

3169 
	`upd©e_m­pšg_bË
(
sdisk
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
);

3170 ià(
sdev
->
¥oŞ
)

3171 
	`shªnÚ_©omic64_šc
(&
sdev
->
¥oŞ
->
u£d_logicbs
);

3173 ià(
sdev
->
ov”Ïp_wr™e
) {

3174 ià(
	`pba_is_equ®
(&
»q
->
pba
, &
sdev
->
ov”Ïp
->pba)) {

3175 
	`£t_ho¡_wr™e_¡©e
(
sdev
, &
»q
->
pba
);

3176 
	`£t_pba_Ãxt_h—d
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
Üig_h—d
);

3177 
	`BUG_ON
(
	`‹¡_gc_wr™e_¡©e
(
sdev
, &
»q
->
pba
è|| 
	`‹¡_gc_»ad_¡©e
(sdev, &req->pba));

3181 
	}
}

3183 
	$fs_bio_wr™e_ÿÎback
(
shªnÚ_bio
 *
sbio
)

3185 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
d©a
;

3186 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

3187 
shªnÚ_»que¡
 *
»q
, *
tmp
;

3188 
shªnÚ_sb
 *
sb
 = 
NULL
, *
Ï¡_sb
 = NULL;

3189 
logicbs
 = 0;

3191 
__echo_š
;

3192 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


3193 
	`shªnÚ_©omic_dec
(&
sdev
->
wr™e_bios
);

3195 
	`shªnÚ_dma_unm­_sg
(
sdev
->
pci_dev
, 
sbio
->
sg
, sbio->
u£d_sg_couÁ
, sbio->
dma_dœ
);

3196 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

3197 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

3198 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

3199 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

3200 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

3201 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

3202 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

3203 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

3205 
	`shªnÚ_šfo
("sbio->¡¬t_£ùÜ=0x%lx, sbio->¡©us=0x%x.\n", 
sbio
->
¡¬t_£ùÜ
, sbio->
¡©us
);

3206 ià((
Ï¡_sb
 =ğ
NULL
è|| (Ï¡_sb =ğ
sb
))

3207 
logicbs
++;

3209 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

3210 
logicbs
 = 1;

3212 
Ï¡_sb
 = 
sb
;

3214 
	`ä“_»q
(
»q
);

3217 ià(
logicbs
)

3218 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

3219 
	`shªnÚ_©omic_sub
(
sbio
->
logicbs
, &
sdev
->
š_æight_wr™es
);

3221 
	`shªnÚ_com¶‘e_fs_io
(
sdisk
->
ho¡d©a
, sdisk->
gd
, 
sbio
);

3222 ià(
sbio
->
sg_couÁ
)

3223 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

3225 
sbio
->
Ï‹ncy
 = ((
	`g‘_jiff›s
(è- sbio->
¡¬t_time
è* 1000è/ 
	`g‘_HZ
();

3226 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
)

3227 
	`»cÜd_Ï‹ncy
(
sdisk
, 
sbio
);

3229 
	`ä“_sbio
(
sbio
);

3230 
	}
}

3232 
	$sbio_ÿÎback_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3234 
shªnÚ_bio
 *
sbio
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_bio, 
cb_wÜk
);

3235 
sbio
->
	`ÿÎback
(sbio);

3236 
	}
}

3238 
	$sbio_»Ëa£
(
shªnÚ_dev
 *
dev
, 
shªnÚ_bio
 *
sbio
)

3240 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
sbio
->
u£r_couÁ
) == 0);

3242 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
sbio
->
u£r_couÁ
)) {

3243 
	`BUG_ON
(
sbio
->
ÿÎback
 =ğ
NULL
);

3244 ià(
	`uÆik–y
(
sbio
->
may_¦“p_š_ÿÎback
 == 99)) {

3245 
shªnÚ_sb
 *
sb
 = (shªnÚ_sb *)
sbio
->
d©a
;

3246 
	`shªnÚ_š™_wÜk
(&
sbio
->
cb_wÜk
, 
sbio_ÿÎback_sk
);

3247 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_ÿÎback_wq
[
sb
->
sb_šdex
 % dev->
ÿÎback_Ä_wq
], &
sbio
->
cb_wÜk
);

3248 } ià(
	`uÆik–y
(
sbio
->
may_¦“p_š_ÿÎback
 == 3)) {

3249 
	`shªnÚ_š™_wÜk
(&
sbio
->
cb_wÜk
, 
sbio_ÿÎback_sk
);

3250 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_ÿÎback_wq
[2], &
sbio
->
cb_wÜk
);

3251 } ià(
	`uÆik–y
(
sbio
->
may_¦“p_š_ÿÎback
)) {

3252 
	`shªnÚ_š™_wÜk
(&
sbio
->
cb_wÜk
, 
sbio_ÿÎback_sk
);

3253 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_ÿÎback_wq
[0], &
sbio
->
cb_wÜk
);

3255 
sbio
->
	`ÿÎback
(sbio);

3257 
	}
}

3259 
	$add_»que¡_queue__w™hout_lock
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
, 
´iÜ™y
)

3261 
»q
->
¡©e
 = 
REQ_IN_QUEUE
;

3262 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
dev
->
»q_queue
[
´iÜ™y
]);

3263 
	}
}

3265 
	$add_»que¡_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
, 
´iÜ™y
)

3267 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»q_queue_lock
[
´iÜ™y
]);

3268 
»q
->
¡©e
 = 
REQ_IN_QUEUE
;

3269 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
dev
->
»q_queue
[
´iÜ™y
]);

3270 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»q_queue_lock
[
´iÜ™y
]);

3271 
	}
}

3273 
	$add_wr™e_»q_to_»que¡_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
, 
´iÜ™y
)

3275 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»q_queue_lock
[
´iÜ™y
]);

3276 
»q
->
¡©e
 = 
REQ_IN_QUEUE
;

3277 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
dev
->
»q_queue
[
´iÜ™y
]);

3278 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»q_queue_lock
[
´iÜ™y
]);

3280 
	`shªnÚ_©omic_šc
(&
dev
->
wr™e_»qs
[
´iÜ™y
]);

3281 
	}
}

3283 
	$add_»q_to_gc_wr™e_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_»que¡
 *
»q
)

3285 
	`shªnÚ_¥š_lock_bh
(&
dev
->
gc_wr™e_queue_lock
);

3286 
»q
->
¡©e
 = 
REQ_IN_QUEUE
;

3287 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
dev
->
gc_wr™e_queue
);

3288 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
gc_wr™e_queue_lock
);

3290 
	`shªnÚ_©omic_šc
(&
dev
->
gc_wr™e_»qs
);

3291 
	}
}

3293 
	$add_wr™e_li¡_to_»que¡_queue_
(
shªnÚ_dev
 *
dev
, 
shªnÚ_li¡_h—d
 *
wr™e_li¡
, 
u32
 
»qs
, 
´iÜ™y
)

3295 
shªnÚ_li¡_h—d
 *
´ev
;

3297 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»q_queue_lock
[
´iÜ™y
]);

3298 
´ev
 = 
dev
->
»q_queue
[
´iÜ™y
].prev;

3299 
wr™e_li¡
->
Ãxt
->
´ev
 =…rev;

3300 
´ev
->
Ãxt
 = 
wr™e_li¡
->next;

3301 
wr™e_li¡
->
´ev
->
Ãxt
 = &
dev
->
»q_queue
[
´iÜ™y
];

3302 
dev
->
»q_queue
[
´iÜ™y
].
´ev
 = 
wr™e_li¡
->prev;

3303 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»q_queue_lock
[
´iÜ™y
]);

3305 
	`shªnÚ_©omic_add
(
»qs
, &
dev
->
wr™e_»qs
[
´iÜ™y
]);

3306 
	}
}

3308 
	$add_lun_»que¡_queue_
(
shªnÚ_lun
 *
lun
, 
shªnÚ_»que¡
 *
»q
)

3310 
	`shªnÚ_¥š_lock_bh
(&
lun
->
lun£t
->
»q_queue_lock
);

3311 
»q
->
¡©e
 = 
REQ_IN_QUEUE
;

3312 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
lun
->
lun£t
->
»q_queue
);

3313 
	`shªnÚ_¥š_uÆock_bh
(&
lun
->
lun£t
->
»q_queue_lock
);

3314 
	}
}

3316 
	$add_adv_»ad_»que¡_li¡_
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

3318 
»t
 = 0;

3320 
	`shªnÚ_¥š_lock
(&
sdev
->
adv_»ad_li¡_lock
);

3321 ià(!(
sdev
->
advªûd_»ad_¡©e
 & 
UPDATING_MICROCODE_MASK
)) {

3322 
»t
 = 1;

3323 
out
;

3325 
»q
->
¡©e
 = 
REQ_IN_ADV_READ_LIST
;

3326 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
sdev
->
adv_»ad_li¡
);

3327 
out
:

3328 
	`shªnÚ_¥š_uÆock
(&
sdev
->
adv_»ad_li¡_lock
);

3329  
»t
;

3330 
	}
}

3332 
	$put_adv_»ad_li¡_to_»q_queue
(
shªnÚ_dev
 *
sdev
)

3334 
shªnÚ_»que¡
 *
»q
, *
tmp
;

3335 
shªnÚ_poŞ
 *
¥oŞ
;

3336 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

3337 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

3338 
shªnÚ_sb
 *
sb
;

3339 
»t
;

3341 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sdev
->
adv_»ad_li¡
, 
li¡
) {

3342 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

3344 ià(!
	`lÚg_lba_is_šv®id
(
»q
->
lba
)) {

3345 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

3346 ià(
¥oŞ
) {

3347 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

3348 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

3349 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

3350 
	`BUG
();

3352 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

3353 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

3354 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

3355 
	`BUG
();

3357 
sdisk
 = &
ns
->sdisk;

3360 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

3361 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, 
NULL
, 
sdisk
);

3362 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

3363 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

3364 ià(
»t
 < 0) {

3365 
	`shªnÚ_log
("%s:†b¨%x may bdisÿrded. Ju¡ ignÜ™.\n", 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
lba
);

3366 
»q
->
¡©e
 = 
REQ_DONE
;

3367 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

3370 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

3371 
»q
->
£q_num
 = 
sb
->seq_num;

3374 
»q
->
_ecc
 = 0;

3375 
»q
->
_m‘ad©a
 = 0;

3376 
	`add_»que¡_queue_
(
sdev
, 
»q
, 1);

3378 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

3379 
	}
}

3381 
	$mod_gc_tim”
(
shªnÚ_dev
 *
sdev
, 
expœes
)

3383 ià(
sdev
->
sdisk
.
ex™
 == 0)

3384 
	`shªnÚ_mod_tim”
(&
sdev
->
gc_tim”
, 
expœes
);

3385 
	}
}

3387 
	$shªnÚ_deãr_tim”
(
shªnÚ_dev
 *
sdev
, 
expœes
)

3389 
	`mod_gc_tim”
(
sdev
, 
	`g‘_jiff›s
(è+ 
expœes
);

3390 
sdev
->
gc_sk_lim™
 = sdev->
lun_couÁ
;

3391 
	}
}

3393 
	$Œigg”_»şaim_wa™_cİy_li¡
(
shªnÚ_dev
 *
sdev
)

3395 
	`mod_gc_tim”
(
sdev
, 
	`g‘_jiff›s
(è+ 
	`g‘_HZ
());

3396 
	}
}

3398 
	$shªnÚ_gc_tim”_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3400 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
gc_tim”_wÜk
);

3402 ià(
sdev
->
sdisk
.
ex™
 || (sdev->
acûss_mode
 =ğ
SHN_MODE_READONLY
) || \

3403 
sdev
->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
))

3406 
	`debugs1
("gc_sk_lim™=%d.\n", 
sdev
->
gc_sk_lim™
);

3407 
	`subm™_gc_»ad
(
sdev
, sdev->
gc_sk_lim™
);

3409 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
exŒa_»qs_lock
);

3410 
sdev
->
exŒa_»qs
 = 0;

3411 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
exŒa_»qs_lock
);

3413 ià((
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
) || \

3414 !
	`shªnÚ_li¡_em±y
(&
sdev
->
wa™_cİy
è|| sdev->
this_sb
 || \

3415 !
	`shªnÚ_li¡_em±y
(&
sdev
->
”r_blks
è|| sdev->
this_”r_sb
) {

3416 ià(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
gc_tim”
))

3417 
	`mod_gc_tim”
(
sdev
, 
	`g‘_jiff›s
(è+ 
	`g‘_HZ
()/10);

3418 
sdev
->
gc_sk_lim™
 = (sdev->gc_task_limit + 10) * 2;

3419 ià(
sdev
->
gc_sk_lim™
 > 10000)

3420 
sdev
->
gc_sk_lim™
 = 10000;

3422 
	}
}

3424 
	$gc_thrÙe_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

3426 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
gc_tim”
);

3428 
	`shªnÚ_queue_wÜk
(
sdev
->
gc_tim”_wq
, &sdev->
gc_tim”_wÜk
);

3429 
	}
}

3431 
	$b®ªû_gc_timeout
(
shªnÚ_tim”_li¡
 *
tim”
)

3433 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
b®ªû_gc_tim”
);

3435 
	`debugs4
("%s, waku°wa™ b®ªû gøev’t.\n", 
__func__
);

3436 
	`shªnÚ_wake_up
(&
sdev
->
wa™_pick_ev’t
);

3438 ià(!(
sdev
->
sdisk
.
ex™
 || sdev->
¶ug_out
))

3439 
	`shªnÚ_mod_tim”
(&
sdev
->
b®ªû_gc_tim”
, 
	`g‘_jiff›s
(è+ 
BALANCE_GC_TIMEOUT
 * 
	`g‘_HZ
());

3440 
	}
}

3442 
	$hªdË_wa™_pick_»q
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
)

3444 
	`BUG_ON
(
»q
->
sbio
 =ğ
NULL
);

3445 
	`shªnÚ_ş—r_b™
(
sdev
->
mbr
.
sdev_id
, &
»q
->
sbio
->
wa™_dev_pick_mask
);

3446 
	`ş—r_wa™_pick_b™
(
»q
);

3447 
	`shªnÚ_b¬r›r
();

3448 
	`shªnÚ_wake_up
(&
sdev
->
wa™_pick_ev’t
);

3449 
	}
}

3452 
šlše
 
	$check_¶ugout
(
shªnÚ_dev
 *
sdev
)

3454 ià(
sdev
->
hÙ_¶uggabË
 == 0)

3455 
sdev
->
¶ug_out
 = 0;

3457 
sdev
->
¶ug_out
 = !
	`shªnÚ_g‘_ad­‹r_¡©us
(sdev->
pci_dev
);

3459  
sdev
->
¶ug_out
;

3460 
	}
}

3462 
	#WATCHDOG_SECONDS
 30

	)

3463 
	#BOOT_WATCHDOG_SECONDS
 2

	)

3465 
	$¡¬t_w©chdog_tim”
(
shªnÚ_dev
 *
sdev
, 
š‹rv®
)

3467 
sdev
->
w©chdog_¡İ
 = 0;

3468 
	`shªnÚ_b¬r›r
();

3469 
	`shªnÚ_add_tim”
(&
sdev
->
w©chdog_tim”
, 
	`g‘_jiff›s
(è+ 
š‹rv®
 * 
	`g‘_HZ
());

3470 
	}
}

3472 
	$¡İ_w©chdog_tim”
(
shªnÚ_dev
 *
sdev
)

3474 
sdev
->
w©chdog_¡İ
 = 1;

3475 
	`shªnÚ_b¬r›r
();

3476 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
w©chdog_tim”
);

3477 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
misc_wq
);

3478 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
w©chdog_tim”
);

3479 
	}
}

3481 
	$¡¬t_´št_Ï‹ncy_tim”
(
shªnÚ_disk
 *
sdisk
)

3483 
	`shªnÚ_mod_tim”
(&
sdisk
->
´št_Ï‹ncy_tim”
, 
	`g‘_jiff›s
(è+ sdisk->
´št_Ï‹ncy_š‹rv®
 * 
	`g‘_HZ
());

3484 
	}
}

3486 
	$¡İ_´št_Ï‹ncy_tim”
(
shªnÚ_disk
 *
sdisk
)

3488 
	`shªnÚ_d–_tim”_sync
(&
sdisk
->
´št_Ï‹ncy_tim”
);

3489 
	}
}

3491 
»äesh_mbr_fÜ_sdev_sync
(
shªnÚ_dev
 *
sdev
);

3493 
	$shªnÚ_»äesh_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3495 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
»äesh_wÜk
);

3497 ià(
sdev
->
ho¡_acûss_blocked
)

3498 
	`shªnÚ_šfo
("%s: ho¡_acûss_blocked, skhi »äeshask.\n", 
sdev
->
cdev_Çme
);

3499 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

3500 
	`»äesh_mbr_g5
(
sdev
, 0);

3502 
	`»äesh_mbr_fÜ_sdev_sync
(
sdev
);

3503 
	}
}

3505 
	#SHANNON_COMMAND_TIMEOUT
 30000

	)

3507 
	s³ndšg_mask
 {

3508 
u32
 
	mu32_mask
[
MAX_MSIX_INTERRUPTS
];

3511 
__hªdË_lun£t
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun£t
 *
lun£t
, 
š_wq
, 
»ad_cq_h—d
);

3512 
__hªdË_bufq
(
shªnÚ_dev
 *
sdev
, 
h—d_šdex
, 
»ad_cq_h—d
);

3513 
__hªdË_bufq_ack_š‹¼u±
(
shªnÚ_dev
 *
sdev
, 
»ad_cq_h—d
);

3514 
	$hªdË_³ndšg_commªd_queue_g5
(
shªnÚ_dev
 *
sdev
, 
³ndšg_mask
 *pending_mask)

3516 
i
, 
’Œy
;

3517 
¡¬t
, 
’d
;

3518 
shªnÚ_lun£t
 *
lun£t
;

3519 
»Œy
, 
max_»Œy_times
 = 5000;

3520 
veùÜ
;

3521 
Ï¡_aùive_time
, 
cu¼_time
;

3523 
’Œy
 = 0;ƒÁry < 
MAX_MSIX_INTERRUPTS
;ƒntry++) {

3524 ià(
³ndšg_mask
->
u32_mask
[
’Œy
] == 0)

3527 ià(
sdev
->
¶ug_out
)

3531 
veùÜ
 = 
	`shªnÚ_pci_g‘_msix_veùÜ
(
sdev
->
msix_d©a
, 
’Œy
, sdev->
max_œq_šdex
 + 1);

3532 
	`shªnÚ_di§bË_œq
(
veùÜ
);

3535 
»Œy
 = 0;

3536 
sdev
->
š_œq
[
’Œy
] && (++
»Œy
 <ğ
max_»Œy_times
))

3537 
	`shªnÚ_m¦“p
(1);

3538 ià(
»Œy
 > 
max_»Œy_times
) {

3539 
	`shªnÚ_šfo
("%s: wa™ sdev->š_œq=%dimeout.\n", 
sdev
->
sdisk
.
disk_Çme
, sdev->
š_œq
[
’Œy
]);

3540 
	`shªnÚ_’abË_œq
(
veùÜ
);

3548 
sdev
->
u32_veùÜs
[
’Œy
] = 
	`»ad_¿w_»g_§ã
(sdev, &sdev->
š‹¼u±_b¬
[entry]);

3550 #ifdeà
SHANNON_USE_WRITE_BUFFER


3551 ià(
’Œy
 =ğ
sdev
->
max_œq_šdex
) {

3552 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

3553 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
šŒ_big_shiá
[
i
], (*)
³ndšg_mask
)) {

3554 ià(
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d
[i]) {

3555 
Ï¡_aùive_time
 = 
sdev
->
cmd_šfo
[
i
][sdev->
bufq_cq_
[i] >> 3].last_active_time;

3556 
cu¼_time
 = 
	`g‘_jiff›s
();

3557 ià((
Ï¡_aùive_time
 !ğ0è&& (
cu¼_time
 >†ast_active_time) && \

3558 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è> 
SHANNON_COMMAND_TIMEOUT
) && \

3559 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è< 
SHANNON_COMMAND_TIMEOUT
 * 5)) {

3560 
	`shªnÚ_®¬m
("%s: bufq command mightimeout, head_index=%d, cq_tail=0x%x, cq_head=0x%x, sq_head=0x%x, "

3562 
sdev
->
sdisk
.
disk_Çme
, 
i
, sdev->
bufq_cq_
[i], sdev->
bufq_cq_h—d
[i], \

3563 
sdev
->
bufq_sq_h—d
[
i
], 
Ï¡_aùive_time
, 
cu¼_time
, 
	`shªnÚ_jiff›s_to_m£cs
(curr_time-last_active_time), \

3564 ((
shªnÚ_cmd
 *)
sdev
->
bufq_sq_addr
[
i
] + (sdev->
bufq_cq_
[i] >> 3))->
İcode
);

3566 
	`__hªdË_bufq
(
sdev
, 
i
, 1);

3567 
	`debugs0
("%s:‡fter„ead cq_head, head_index=%d, cq_tail=0x%x, cq_head=0x%x, sq_head=0x%x.\n", \

3568 
sdev
->
sdisk
.
disk_Çme
, 
i
, sdev->
bufq_cq_
[i], sdev->
bufq_cq_h—d
[i], sdev->
bufq_sq_h—d
[i]);

3573 ià(
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d
[i])

3574 
	`__hªdË_bufq
(
sdev
, 
i
, 0);

3578 
	`__hªdË_bufq_ack_š‹¼u±
(
sdev
, 1);

3582 
¡¬t
 = 
’Œy
 * 32;

3583 ià(
¡¬t
 < 
sdev
->
lun£t_couÁ
) {

3584 
’d
 = (
¡¬t
 + 32è< 
sdev
->
lun£t_couÁ
 ? (start + 32) : sdev->lunset_count;

3585 
i
 = 
¡¬t
; i < 
’d
; i++) {

3586 
lun£t
 = &
sdev
->
lun£ts
[
i
];

3587 ià(
	`shªnÚ_‹¡_b™
(
lun£t
->
šdex
, (*)
³ndšg_mask
)) {

3588 
»Œy
 = 0;

3589 
	`shªnÚ_©omic_»ad
(&
lun£t
->
š_wq
è&& (++
»Œy
 <ğ
max_»Œy_times
))

3590 
	`shªnÚ_m¦“p
(1);

3591 ià(
»Œy
 > 
max_»Œy_times
) {

3592 
	`shªnÚ_šfo
("%s: wa™ fÜ†un£t=%d in_wqimeout.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
);

3596 ià(
lun£t
->
cq__tmp
 !ğlun£t->
sq_h—d
) {

3597 
Ï¡_aùive_time
 = 
lun£t
->
cmd_šfo
[lun£t->
cq__tmp
 >> 3].last_active_time;

3598 
cu¼_time
 = 
	`g‘_jiff›s
();

3599 ià((
Ï¡_aùive_time
 !ğ0è&& (
cu¼_time
 >†ast_active_time) && \

3600 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è> 
SHANNON_COMMAND_TIMEOUT
) && \

3601 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è< 
SHANNON_COMMAND_TIMEOUT
 * 5)) {

3602 
	`shªnÚ_®¬m
("%s: command mightimeout,†unset=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, cq_head=0x%x, sq_head=0x%x, "

3604 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
,†un£t->
cq_
,†un£t->
cq__tmp
,†un£t->
cq_h—d
,†un£t->
sq_h—d
, \

3605 
Ï¡_aùive_time
, 
cu¼_time
, 
	`shªnÚ_jiff›s_to_m£cs
(curr_time -†ast_active_time), \

3606 ((
shªnÚ_cmd
 *)
lun£t
->
sq_addr
 + (lun£t->
cq__tmp
 >> 3))->
İcode
);

3608 
	`__hªdË_lun£t
(
sdev
, 
lun£t
, 0, 1);

3609 
	`debugs0
("%s:‡fter„ead cq_head,†unset=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, cq_head=0x%x, sq_head=0x%x.\n", \

3610 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
,†un£t->
cq_
,†un£t->
cq__tmp
,†un£t->
cq_h—d
,†un£t->
sq_h—d
);

3615 ià(
lun£t
->
cq__tmp
 !ğlun£t->
sq_h—d
) {

3616 
	`shªnÚ_©omic_šc
(&
lun£t
->
š_wq
);

3617 ià(
	`shªnÚ_queue_wÜk
(
sdev
->
hªdË_lun_wq
[
i
 % sdev->
shªnÚ_Ä_wq
], &
lun£t
->
comp_wÜk
) == 0)

3618 
	`shªnÚ_©omic_dec
(&
lun£t
->
š_wq
);

3623 
sdev
->
u32_veùÜs
[
’Œy
] = 0;

3624 
	`shªnÚ_b¬r›r
();

3625 
	`wr™e_»g_§ã
(
sdev
, 0, &sdev->
š‹¼u±_b¬
[
’Œy
]);

3626 
	`shªnÚ_’abË_œq
(
veùÜ
);

3630 
	}
}

3632 
u32
 
»³©_»ad_cq_h—d
(
shªnÚ_dev
 *
sdev
, cÚ¡ vŞ©
__iomem
 *
addr
);

3633 
»ad_bufq_š‹¼u±_veùÜ
(
shªnÚ_dev
 *
sdev
);

3634 
»ad_Ùh”_š‹¼u±_veùÜ
(
shªnÚ_dev
 *
sdev
);

3635 
shªnÚ_ş—r_š‹¼u±
(
shªnÚ_dev
 *
sdev
);

3636 
	$hªdË_³ndšg_commªd_queue
(
shªnÚ_dev
 *
sdev
, 
³ndšg_mask
 *pending_mask)

3638 
i
;

3639 
shªnÚ_lun£t
 *
lun£t
;

3640 
»Œy
, 
max_»Œy_times
 = 5000;

3641 
Ï¡_aùive_time
, 
cu¼_time
;

3643 ià(!
	`__shªnÚ_b™m­_weight
(
³ndšg_mask
, (*pending_mask) * 8))

3646 ià(
sdev
->
¶ug_out
)

3649 
	`shªnÚ_di§bË_œq
(
	`g‘_pci_œq_num
(
sdev
->
pci_dev
));

3651 
»Œy
 = 0;

3652 
sdev
->
š_œq
[0] && (++
»Œy
 <ğ
max_»Œy_times
))

3653 
	`shªnÚ_m¦“p
(1);

3654 ià(
»Œy
 > 
max_»Œy_times
) {

3655 
	`shªnÚ_šfo
("%s: wa™ sdev->š_œq=%dimeout.\n", 
sdev
->
sdisk
.
disk_Çme
, sdev->
š_œq
[0]);

3656 
	`shªnÚ_’abË_œq
(
	`g‘_pci_œq_num
(
sdev
->
pci_dev
));

3660 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

3661 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

3663 #ifdeà
SHANNON_USE_WRITE_BUFFER


3664 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

3665 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
šŒ_big_shiá
[
i
], (*)
³ndšg_mask
)) {

3666 ià(
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d
[i]) {

3667 
Ï¡_aùive_time
 = 
sdev
->
cmd_šfo
[
i
][sdev->
bufq_cq_
[i] >> 3].last_active_time;

3668 
cu¼_time
 = 
	`g‘_jiff›s
();

3669 ià((
Ï¡_aùive_time
 !ğ0è&& (
cu¼_time
 >†ast_active_time) && \

3670 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è> 
SHANNON_COMMAND_TIMEOUT
) && \

3671 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è< 
SHANNON_COMMAND_TIMEOUT
) * 5) {

3672 
	`shªnÚ_®¬m
("%s: bufq command mightimeout, head_index=%d, cq_tail=0x%x, cq_head=0x%x, sq_head=0x%x, "

3674 
sdev
->
sdisk
.
disk_Çme
, 
i
, sdev->
bufq_cq_
[i], sdev->
bufq_cq_h—d
[i], sdev->
bufq_sq_h—d
[i], \

3675 
Ï¡_aùive_time
, 
cu¼_time
, 
	`shªnÚ_jiff›s_to_m£cs
(curr_time-last_active_time), \

3676 ((
shªnÚ_cmd
 *)
sdev
->
bufq_sq_addr
[
i
] + (sdev->
bufq_cq_
[i] >> 3))->
İcode
);

3677 
	`__hªdË_bufq
(
sdev
, 
i
, 1);

3678 
	`debugs0
("%s:‡fter„ead cq_head, head_index=%d, cq_tail=0x%x, cq_head=0x%x, sq_head=0x%x.\n", \

3679 
sdev
->
sdisk
.
disk_Çme
, 
i
, sdev->
bufq_cq_
[i], sdev->
bufq_cq_h—d
[i], sdev->
bufq_sq_h—d
[i]);

3684 ià(
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d
[i])

3685 
	`__hªdË_bufq
(
sdev
, 
i
, 0);

3688 
	`__hªdË_bufq_ack_š‹¼u±
(
sdev
, 1);

3691 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

3692 
lun£t
 = &
sdev
->
lun£ts
[
i
];

3693 ià(
	`shªnÚ_‹¡_b™
(
lun£t
->
šdex
, (*)
³ndšg_mask
)) {

3694 
»Œy
 = 0;

3695 
	`shªnÚ_©omic_»ad
(&
lun£t
->
š_wq
è&& (++
»Œy
 <ğ
max_»Œy_times
))

3696 
	`shªnÚ_m¦“p
(1);

3697 ià(
»Œy
 > 
max_»Œy_times
) {

3698 
	`shªnÚ_šfo
("%s: wa™ fÜ†un£t=%d in_wqimeout.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
);

3702 ià(
lun£t
->
cq__tmp
 !ğlun£t->
sq_h—d
) {

3703 
Ï¡_aùive_time
 = 
lun£t
->
cmd_šfo
[lun£t->
cq__tmp
 >> 3].last_active_time;

3704 
cu¼_time
 = 
	`g‘_jiff›s
();

3705 ià((
Ï¡_aùive_time
 !ğ0è&& (
cu¼_time
 >†ast_active_time) && \

3706 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è> 
SHANNON_COMMAND_TIMEOUT
) && \

3707 (
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è< 
SHANNON_COMMAND_TIMEOUT
 * 5)) {

3708 
	`shªnÚ_®¬m
("%s: command mightimeout,†unset=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, cq_head=0x%x, sq_head=0x%x, "

3710 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
,†un£t->
cq_
,†un£t->
cq__tmp
,†un£t->
cq_h—d
,†un£t->
sq_h—d
, \

3711 
Ï¡_aùive_time
, 
cu¼_time
, 
	`shªnÚ_jiff›s_to_m£cs
(curr_time -†ast_active_time), \

3712 ((
shªnÚ_cmd
 *)
lun£t
->
sq_addr
 + (lun£t->
cq__tmp
 >> 3))->
İcode
);

3714 
	`__hªdË_lun£t
(
sdev
, 
lun£t
, 0, 1);

3715 
	`debugs0
("%s:‡fter„ead cq_head,†unset=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, cq_head=0x%x, sq_head=0x%x.\n", \

3716 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
,†un£t->
cq_
,†un£t->
cq__tmp
,†un£t->
cq_h—d
,†un£t->
sq_h—d
);

3721 ià(
lun£t
->
cq__tmp
 !ğlun£t->
sq_h—d
) {

3722 
	`shªnÚ_©omic_šc
(&
lun£t
->
š_wq
);

3723 ià(
	`shªnÚ_queue_wÜk
(
sdev
->
hªdË_lun_wq
[
i
 % sdev->
shªnÚ_Ä_wq
], &
lun£t
->
comp_wÜk
) == 0)

3724 
	`shªnÚ_©omic_dec
(&
lun£t
->
š_wq
);

3728 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

3729 
	`shªnÚ_b¬r›r
();

3730 
	`wr™e_»g_§ã
(
sdev
, 0, &sdev->
š‹¼u±_b¬
[0]);

3731 
	`shªnÚ_’abË_œq
(
	`g‘_pci_œq_num
(
sdev
->
pci_dev
));

3734 
	}
}

3736 
	$check_³ndšg_commªd_queue
(
shªnÚ_dev
 *
sdev
)

3738 
i
, 
sk
;

3739 
shªnÚ_lun£t
 *
lun£t
;

3740 
³ndšg_mask
…ending_mask;

3741 
__u32
 
cq_
, 
hw_cq_h—d
, 
hw_sq_h—d
;

3742 
Ï¡_aùive_time
, 
cu¼_time
;

3744 
	`shªnÚ_mem£t
(&
³ndšg_mask
, 0, (pending_mask));

3747 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

3748 
lun£t
 = &
sdev
->
lun£ts
[
i
];

3749 
sk
 = 0;

3750 ià(
lun£t
->
cq__tmp
 !ğlun£t->
sq_h—d
) {

3751 
cq_
 = 
lun£t
->
cq__tmp
;

3752 
Ï¡_aùive_time
 = 
lun£t
->
cmd_šfo
[
cq_
 >> 3].last_active_time;

3753 ià(
Ï¡_aùive_time
 == 0)

3755 
cu¼_time
 = 
	`g‘_jiff›s
();

3756 ià(
Ï¡_aùive_time
 >ğ
cu¼_time
)

3758 ià(
	`uÆik–y
(
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è>ğ
SHANNON_COMMAND_TIMEOUT
)) {

3759 ià((
cq_
 !ğ
lun£t
->
cq__tmp
è|| (
Ï¡_aùive_time
 !ğlun£t->
cmd_šfo
[cq_tail >> 3].last_active_time) || \

3760 (
lun£t
->
cq__tmp
 =ğlun£t->
sq_h—d
))

3763 
hw_cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &
lun£t
->
lun_b¬
->
cq_h—d
);

3764 ià(
	`uÆik–y
(
hw_cq_h—d
 > 
QUEUE_SIZE
)) {

3765 ià(
sdev
->
¶ug_out
)

3767 
hw_cq_h—d
 = 
	`»³©_»ad_cq_h—d
(
sdev
, &
lun£t
->
lun_b¬
->
cq_h—d
);

3768 ià(
hw_cq_h—d
 > 
QUEUE_SIZE
)

3771 ià(
lun£t
->
cq__tmp
 =ğ
hw_cq_h—d
)

3772 
sk
 = 1;

3774 
hw_sq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &
lun£t
->
lun_b¬
->
sq_h—d
);

3775 ià(
	`uÆik–y
(
hw_sq_h—d
 !ğ
lun£t
->
sq_hw_h—d
)) {

3776 
	`shªnÚ_¥š_lock_bh
(&
lun£t
->
lun_b¬_lock
);

3777 
hw_sq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &
lun£t
->
lun_b¬
->
sq_h—d
);

3778 ià(
hw_sq_h—d
 !ğ
lun£t
->
sq_hw_h—d
) {

3779 
sk
 = 1;

3780 
	`shªnÚ_®¬m
("%s:†unset=%d, hw_sq_head=0x%x,„ead from hardware is 0x%x.\n", \

3781 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
,†un£t->
sq_hw_h—d
, 
hw_sq_h—d
);

3782 } ià(
hw_cq_h—d
 =ğ
hw_sq_h—d
)

3783 
sk
 = 1;

3784 
	`shªnÚ_¥š_uÆock_bh
(&
lun£t
->
lun_b¬_lock
);

3787 ià(
	`lik–y
(
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è<ğ
SHANNON_COMMAND_TIMEOUT
 * 5)) {

3788 
	`shªnÚ_®¬m
("%s:†unset=%d, cq_tail_tmp=0x%x, cq_tail=0x%x, cq_head=0x%x, sq_head=0x%x, hw_cq_head=0x%x,†ast_active_time=%lu, "

3789 "Üigš® cq_=0x%x,†a¡_aùive_time=%lu, cu¼_time=%lu,imeout=%ums.\n", 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
, \

3790 
lun£t
->
cq__tmp
,†un£t->
cq_
,†un£t->
cq_h—d
,†un£t->
sq_h—d
, 
hw_cq_h—d
,†un£t->
cmd_šfo
[cq_ >> 3].
Ï¡_aùive_time
, \

3791 
cq_
, 
Ï¡_aùive_time
, 
cu¼_time
, 
	`shªnÚ_jiff›s_to_m£cs
(curr_time-last_active_time));

3793 ià(
sk
)

3795 
	`shªnÚ_£t_b™
(
lun£t
->
šdex
, (*)&
³ndšg_mask
);

3800 #ifdeà
SHANNON_USE_WRITE_BUFFER


3802 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

3803 
sk
 = 0;

3804 ià(
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d
[i]) {

3805 
cq_
 = 
sdev
->
bufq_cq_
[
i
];

3806 
Ï¡_aùive_time
 = 
sdev
->
cmd_šfo
[
i
][
cq_
 >> 3].last_active_time;

3807 ià(
Ï¡_aùive_time
 == 0)

3809 
cu¼_time
 = 
	`g‘_jiff›s
();

3810 ià(
Ï¡_aùive_time
 >ğ
cu¼_time
)

3812 ià(
	`uÆik–y
(
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è>ğ
SHANNON_COMMAND_TIMEOUT
)) {

3813 ià((
cq_
 !ğ
sdev
->
bufq_cq_
[
i
]è|| (
Ï¡_aùive_time
 !ğsdev->
cmd_šfo
[i][cq_tail >> 3].last_active_time) || \

3814 (
sdev
->
bufq_cq_
[
i
] =ğsdev->
bufq_sq_h—d
[i]))

3817 
hw_cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
bufq_b¬
[
i
]->
cq_h—d
);

3818 ià(
	`uÆik–y
(
hw_cq_h—d
 > 
QUEUE_SIZE
)) {

3819 ià(
sdev
->
¶ug_out
)

3821 
hw_cq_h—d
 = 
	`»³©_»ad_cq_h—d
(
sdev
, &sdev->
bufq_b¬
[
i
]->
cq_h—d
);

3822 ià(
hw_cq_h—d
 > 
QUEUE_SIZE
)

3825 ià(
sdev
->
bufq_cq_
[
i
] =ğ
hw_cq_h—d
)

3826 
sk
 = 1;

3828 
hw_sq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
bufq_b¬
[
i
]->
sq_h—d
);

3829 ià(
	`uÆik–y
(
hw_sq_h—d
 !ğ
sdev
->
bufq_sq_hw_h—d
[
i
])) {

3830 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
bufq_b¬_lock
[
i
]);

3831 
hw_sq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
bufq_b¬
[
i
]->
sq_h—d
);

3832 ià(
hw_sq_h—d
 !ğ
sdev
->
bufq_sq_hw_h—d
[
i
]) {

3833 
sk
 = 1;

3834 
	`shªnÚ_®¬m
("%s: bufq=%d, hw_sq_head=0x%x,„ead from hardware is 0x%x.\n", \

3835 
sdev
->
sdisk
.
disk_Çme
, 
i
, sdev->
bufq_sq_hw_h—d
, 
hw_sq_h—d
);

3836 } ià(
hw_cq_h—d
 =ğ
hw_sq_h—d
)

3837 
sk
 = 1;

3838 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
bufq_b¬_lock
[
i
]);

3841 ià(
	`lik–y
(
	`shªnÚ_jiff›s_to_m£cs
(
cu¼_time
 - 
Ï¡_aùive_time
è<ğ
SHANNON_COMMAND_TIMEOUT
 * 5)) {

3842 
	`shªnÚ_®¬m
("%s: head_index=%d, cq_tail=0x%x, cq_head=0x%x, sq_head=0x%x, hw_cq_head=0x%x,†ast_active_time=%lu, "

3843 "Üigš® cq_=0x%x,†a¡_aùive_time=%lu, cu¼_time=%lu,imeout=%ums.\n", 
sdev
->
sdisk
.
disk_Çme
, 
i
, \

3844 
sdev
->
bufq_cq_
[
i
], sdev->
bufq_cq_h—d
[i], sdev->
bufq_sq_h—d
[i], 
hw_cq_h—d
, sdev->
cmd_šfo
[i][
cq_
 >> 3].
Ï¡_aùive_time
, \

3845 
cq_
, 
Ï¡_aùive_time
, 
cu¼_time
, 
	`shªnÚ_jiff›s_to_m£cs
(curr_time-last_active_time));

3847 ià(
sk
)

3849 
	`shªnÚ_£t_b™
(
sdev
->
šŒ_big_shiá
[
i
], (*)&
³ndšg_mask
);

3855 ià(!
	`__shªnÚ_b™m­_weight
(&
³ndšg_mask
, (pending_mask) * 8))

3858 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

3859 
	`hªdË_³ndšg_commªd_queue_g5
(
sdev
, &
³ndšg_mask
);

3861 
	`hªdË_³ndšg_commªd_queue
(
sdev
, &
³ndšg_mask
);

3864 
	}
}

3866 
	$shªnÚ_w©chdog_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

3868 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
w©chdog_wÜk
);

3869 
ofæše
 = 0, 
š_æight
 = 0;

3870 
__u32
 
£u
;

3872 ià(
sdev
->
sdisk
.
ex™
)

3875 ià(
sdev
->
š™_dÚe
 < 
STAGE9_DONE
) {

3877 
	`check_¶ugout
(
sdev
);

3878 ià(
sdev
->
¶ug_out
)

3879 
	`shªnÚ_scheduË_wÜk
(&
sdev
->
¶ugout_wÜk
);

3881 
	`¡¬t_w©chdog_tim”
(
sdev
, 
BOOT_WATCHDOG_SECONDS
);

3885 
š_æight
 = 
	`shªnÚ_bio_š_æight
(
sdev
);

3887 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

3888 ià(
sdev
->
‹m³¿tu»_št
 >ğsdev->
‹m³¿tu»_w¬nšg_th»shŞd
)

3889 
	`shªnÚ_w¬n
("%s: cÚŒŞË¸‹m³¿tu»: %d,…Ëa£ inü—£ you¸BIOS fª s³ed s‘tšg.\n", 
sdev
->
sdisk
.
disk_Çme
, sdev->
‹m³¿tu»_št
);

3892 ià((!
	`shªnÚ_dev_is_g5_ff§
(
sdev
)è&& ((sdev->
¡©e
 & 
SHN_STATE_MASK
è!ğ
SHN_STATE_RECONFIG
)) {

3893 
£u
 = 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 
SH_SEU_OFFSET
);

3894 ià(
£u
 == ~0) {

3895 
	`shªnÚ_”r
("£u=0x%x, s‘ s‹Ø”rÜ!\n", 
£u
);

3896 
sdev
->
¡©e
 |ğ
SHN_STATE_ERROR_BIT
;

3899 ià(
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
) {

3900 
	`shªnÚ_”r
("sdev->¡©e=0x%lx.\n", 
sdev
->
¡©e
);

3901 
ofæše
 = 1;

3902 
EXIT
;

3904 ià((!
	`shªnÚ_dev_is_g5_ff§
(
sdev
)è&& (sdev->
»cÚfig_suµÜt
 =ğ0è&& 
	`»ad_£u_šfo
(sdev)) {

3905 
	`shªnÚ_”r
("This card doesn't support seu„econfig! Please update you firmware.\n");

3906 
EXIT
;

3909 
	`check_³ndšg_commªd_queue
(
sdev
);

3911 
EXIT
:

3912 ià(
ofæše
)

3913 
	`com¶‘e_³ndšg_»que¡
(
sdev
);

3915 ià((
ofæše
 =ğ0è&& (
sdev
->
sdisk
.
ex™
 =ğ0è&& (sdev->
w©chdog_¡İ
 == 0))

3916 
	`¡¬t_w©chdog_tim”
(
sdev
, 
WATCHDOG_SECONDS
);

3918 
š_æight
 +ğ
	`shªnÚ_bio_š_æight
(
sdev
);

3919 ià((
sdev
->
sdisk
.
ex™
 =ğ0è&& (
š_æight
 == 0))

3920 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
pm_qos_wÜk
);

3921 
	}
}

3923 
	$w©chdog_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
)

3925 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
w©chdog_tim”
);

3927 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
w©chdog_wÜk
);

3928 
	}
}

3930 
	$__´št_Ï‹ncy_funùiÚ
(
shªnÚ_disk
 *
sdisk
)

3933 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
) {

3934 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
»cÜd_Ï‹ncy_lock
);

3935 
	`shªnÚ_šfo
("%s: interval=%ds max_bio_latency R %d ms, W %d ms\n",

3936 
sdisk
->
disk_Çme
, sdisk->
´št_Ï‹ncy_š‹rv®
,

3937 
sdisk
->
max_bio_»ad_Ï‹ncy
, sdisk->
max_bio_wr™e_Ï‹ncy
);

3938 
sdisk
->
max_bio_»ad_Ï‹ncy
 = 0;

3939 
sdisk
->
max_bio_wr™e_Ï‹ncy
 = 0;

3940 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
»cÜd_Ï‹ncy_lock
);

3941 ià(
sdisk
->
©ched
 =ğ
SHN_DISK_ATTACHED
)

3942 
	`¡¬t_´št_Ï‹ncy_tim”
(
sdisk
);

3944 
	}
}

3946 
	$ns_´št_Ï‹ncy_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
)

3948 
shªnÚ_dev
 *
ns
 = 
	`äom_tim”
Òs, 
tim”
, 
sdisk
.
´št_Ï‹ncy_tim”
);

3949 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

3951 
	`__´št_Ï‹ncy_funùiÚ
(
sdisk
);

3952 
	}
}

3954 
	$´št_Ï‹ncy_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
)

3956 
shªnÚ_dev
 *
sdev
 = 
	`äom_tim”
(sdev, 
tim”
, 
sdisk
.
´št_Ï‹ncy_tim”
);

3957 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

3959 
	`__´št_Ï‹ncy_funùiÚ
(
sdisk
);

3960 
	}
}

3962 
	$shªnÚ_subm™_®igÃd_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
)

3964 
logicbs
, 
i
, 
»t
;

3965 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

3966 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

3967 
shªnÚ_sb
 *
sb
 = 
NULL
;

3968 
shªnÚ_sg_li¡_t
 *
sg
;

3969 
u64
 
¡¬t_£ùÜ
;

3970 
lun_logicbs
 = 0, 
š_ÿche_logicbs
 = 0;

3972 
logicbs
 = 
sbio
->
bio_size
 >> 
sdev
->
logicb_shiá
;

3974 
sbio
->
logicbs
 =†ogicbs;

3975 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
logicbs
);

3976 
sbio
->
logicbs
 =†ogicbs;

3978 ià(
	`shªnÚ_dma_m­_sg
(
sdev
->
pci_dev
, 
sbio
->
sg
, sbio->
u£d_sg_couÁ
, sbio->
dma_dœ
) == 0) {

3979 
	`shªnÚ_w¬n
("dma_map_sg failed!\n");

3980 
	`shªnÚ_dump_¡ack
();

3981  -
ENOMEM
;

3984 ià(!
	`shªnÚ_pm_qos_is_»quœed
(
SHANNON_PM_QOS_CPU_DMA_LATENCY
)) {

3985 
	`shªnÚ_pm_qos_upd©e_»quœem’t
(&
sdev
->
pm_qos_l
, 
SHANNON_PM_QOS_CPU_DMA_LATENCY
, sdev->
sdisk
.
disk_Çme
, 
shªnÚ_pm_qos_v®ue
);

3988 ià(
	`shªnÚ_tim”_³ndšg
(&
sdev
->
gc_tim”
))

3989 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 10);

3991 
¡¬t_£ùÜ
 = 
sbio
->start_sector;

3992 
sg
 = 
sbio
->sg;

3993 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
) {

3994 
lun_pba
†un_pba;

3995 
Ï¡_lun
 = -1;

3996 
fœ¡_size
, 
Ï¡_size
 = 0, 
š_ÿche
;

3997 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


3998 
	`shªnÚ_©omic_šc
(&
sdev
->
»ad_bios
);

4000 
sbio
->
ÿÎback
 = 
fs_bio_»ad_ÿÎback
;

4001 
sbio
->
d©a
 = 
sdev
;

4002 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

4004 
i
 = 0; i < 
logicbs
; i++) {

4005 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

4006 #ifdeà
CONFIG_SHANNON_DEBUG


4007 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 
i
);

4009 
»q
->
£nd”
 = 
FROM_HOST
;

4010 
»q
->
sbio
 = sbio;

4011 
	`£t_»q_šdex
(
»q
, 
i
);

4012 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

4013 
»q
->
İcode
 = 
sh_cmd_»ad
;

4014 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

4015 
»q
->
lba
 = (
¡¬t_£ùÜ
 >> (
sdev
->
logicb_shiá
 - 9)è+ 
i
;

4016 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4017 
»q
->
vœt_addr
 = 
	`shªnÚ_sg_vœt
(
sg
);

4018 
»q
->
dma_add»ss
 = 
	`shªnÚ_sg_dma_add»ss
(
sg
);

4019 
fœ¡_size
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

4020 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

4021 ià(()
»q
->
vœt_addr
 & (»q->
Ëngth
 - 1)) {

4022 
»q
->
vœt_addr_2
 = 
	`shªnÚ_sg_vœt
(
sg
);

4023 
»q
->
dma_add»ss_2
 = 
	`shªnÚ_sg_dma_add»ss
(
sg
);

4024 
Ï¡_size
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

4025 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

4026 
	`BUG_ON
((
fœ¡_size
 + 
Ï¡_size
è!ğ
sdev
->
logicb_size
);

4028 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

4029 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
lun_pba
, &
š_ÿche
, 
sdisk
);

4030 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

4031 ià(
»t
 < 0) {

4032 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0, 
fœ¡_size
);

4033 ià(
»q
->
vœt_addr_2
)

4034 
	`shªnÚ_mem£t
(
»q
->
vœt_addr_2
, 0, 
Ï¡_size
);

4035 
»q
->
¡©e
 = 
REQ_DONE
;

4036 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

4038 } ià(
š_ÿche
) {

4039 ià(
	`add_»q_to_´eãtch_li¡
(
sdisk
, 
»q
)) {

4040 
š_ÿche_logicbs
++;

4044 
	`šü—£_ÿche_miss
(
sdisk
, 
»q
);

4045 
»q
->
pba
.
lun_pba
 =†un_pba.lun_pba;

4046 
»q
->
pba
.
lun
 = 
lun_pba
.lun;

4047 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

4048 
»q
->
£q_num
 = 
sb
->seq_num;

4049 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

4052 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[
lun_pba
.lun], 
»q
);

4053 ià((
Ï¡_lun
 >ğ0è&& (Ï¡_luÀ!ğ
lun_pba
.
lun
)) {

4054 
	`lun£t_pick_»que¡
(
sdev
->
lun
[
Ï¡_lun
]->
lun£t
, 
lun_logicbs
);

4055 
lun_logicbs
 = 0;

4057 
Ï¡_lun
 = 
lun_pba
.
lun
;

4058 
lun_logicbs
++;

4060 ià(
Ï¡_lun
 >= 0)

4061 
	`lun£t_pick_»que¡
(
sdev
->
lun
[
Ï¡_lun
]->
lun£t
, 
lun_logicbs
);

4062 ià(
š_ÿche_logicbs
)

4063 
	`shªnÚ_wake_up_´oûss
(
sdev
->
´eãtch_th»ad
);

4064 } ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

4065 
shªnÚ_li¡_h—d
 
wr™e_li¡
;

4066 
fl_h—d
 = 0;

4067 
´iÜ™y
 = ((
sbio
->
logicbs
 < 4è&& 
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[2])) ? 2 : 1;

4068 
¡ack_size
;

4070 
¡ack_size
 = (()&¡ack_sizeè& (
THREAD_SIZE
-1);

4071 
¡ack_size
 = 
THREAD_SIZE
 - stack_size;

4073 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


4074 
	`shªnÚ_©omic_šc
(&
sdev
->
wr™e_bios
);

4076 
sbio
->
ÿÎback
 = 
fs_bio_wr™e_ÿÎback
;

4077 
sbio
->
d©a
 = 
sdev
;

4078 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

4080 ià(
sdev
->
ä“_blkút
 < 
GC_THRESHOLD_N3
) {

4081 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
block_ho¡_wr
, (sdev->
sdisk
.
ex™
 || (sdev->
ä“_blkút
 >ğ
GC_THRESHOLD_N3
)));

4083 ià((
sdev
->
š_block_¡©e
 < 2è&& (
	`shªnÚ_©omic_»ad
(&sdev->
wr™e_»qs
[1]è>ğ
REQ_QUEUE_THRESHOLD_H
))

4084 
sdev
->
š_block_¡©e
 = 2;

4085 ià(
sdev
->
š_block_¡©e
 == 2) {

4086 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
lim™_»q_queue
[1], \

4087 (
sdev
->
sdisk
.
ex™
 || (sdev->
š_block_¡©e
 < 2è|| (
	`shªnÚ_©omic_»ad
(&sdev->
wr™e_»qs
[1]è< 
REQ_QUEUE_THRESHOLD_L
)));

4089 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
)) {

4090 
	`shªnÚ_w¬n
("the disk is‡bsent!\n");

4091 
	`shªnÚ_dma_unm­_sg
(
sdev
->
pci_dev
, 
sbio
->
sg
, sbio->
u£d_sg_couÁ
, sbio->
dma_dœ
);

4092  -
EIO
;

4094 #ifdeà
CONFIG_SHANNON_STATISTICS


4095 
	`shªnÚ_©omic_add
(
logicbs
, &
sdev
->
äom_ho¡
);

4097 
	`SHANNON_INIT_LIST_HEAD
(&
wr™e_li¡
);

4098 
i
 = 0; i < 
logicbs
; i++) {

4099 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

4100 #ifdeà
CONFIG_SHANNON_DEBUG


4101 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 
i
);

4103 
»q
->
£nd”
 = 
FROM_HOST
;

4104 
»q
->
sbio
 = sbio;

4105 
	`£t_»q_šdex
(
»q
, 
i
);

4106 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

4107 
»q
->
İcode
 = 
sh_cmd_wr™e
;

4108 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

4109 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

4110 
»q
->
lba
 = (
¡¬t_£ùÜ
 >> (
sdev
->
logicb_shiá
 - 9)è+ 
i
;

4111 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4112 
»q
->
vœt_addr
 = 
	`shªnÚ_sg_vœt
(
sg
);

4113 
»q
->
dma_add»ss
 = 
	`shªnÚ_sg_dma_add»ss
(
sg
);

4114 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

4115 ià(()
»q
->
vœt_addr
 & (»q->
Ëngth
 - 1)) {

4116 
»q
->
vœt_addr_2
 = 
	`shªnÚ_sg_vœt
(
sg
);

4117 
»q
->
dma_add»ss_2
 = 
	`shªnÚ_sg_dma_add»ss
(
sg
);

4118 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

4120 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

4121 
	`ho¡_g‘_h—d_ªd_£t_pba_bË
(
sdev
, 
sdisk
, 
sbio
->
bio
, 
»q
);

4122 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

4123 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

4124 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
wr™e_li¡
);

4125 ià((
»q
->
h—d
 & 
HEAD_INDEX_MASK
è=ğ
HOT_INDEX
)

4126 
fl_h—d
 |ğ1 << 
HOT_INDEX
;

4128 #ifdeà
CONFIG_SINGLE_HEAD_VERIFY


4129 
	`BUG_ON
(!
sdev
->
u£_du®_h—d
);

4131 
fl_h—d
 |ğ1 << 
COLD_INDEX
;

4134 ià(
sdev
->
ov”Ïp_wr™e
) {

4135 ià(((
fl_h—d
 & (1 << 
HOT_INDEX
)è=ğfl_h—dè&& 
sbio
->
logicbs
 == 2)

4136 
sbio
->
ov”Ïp
 = 1;

4138 
	`add_wr™e_li¡_to_»que¡_queue_
(
sdev
, &
wr™e_li¡
, 
logicbs
, 
´iÜ™y
);

4139 
	`shªnÚ_©omic_add
(
logicbs
, &
sdev
->
š_æight_wr™es
);

4140 ià(
¡ack_size
 > 4096)

4141 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4143 
	`shªnÚ_pick_»que¡
(
sdev
, 
logicbs
);

4144 
	`b®ªû_gc
(
sdev
, 
logicbs
);

4145 
	`mod_fl_chunk_tim”
(
sdev
, 
fl_h—d
);

4148 ià((
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
è|| sdev->
”r_blkút
)

4149 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 4);

4152 
	}
}

4154 
	~"shªnÚ_512.c
"

4156 
	$upd©e_d©a_š_dummy_·ge
(
shªnÚ_dev
 *
sdev
)

4158 
shªnÚ_sm¬t
 *
sm¬t
 = (shªnÚ_sm¬ˆ*)
sdev
->
dummy_·ge
;

4165 ià((
sm¬t
->
dummy_couÁ
 % 63) == 0) {

4166 
sm¬t
->
¿ndom_num
 = 
	`g‘_jiff›s
() & 0xffffffff;

4167 ià(
sm¬t
->
¿ndom_num
 == 0)

4168 
sm¬t
->
¿ndom_num
 = 1;

4170 
sm¬t
->
¿ndom_num
 = smart->random_num << 1;

4171 
sm¬t
->
dummy_couÁ
++;

4173 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

4174 
	`shªnÚ_mem_wr™eq
(
sdev
->
pow”_Ú_£cÚds
, &
sm¬t
->power_on_seconds);

4175 
	`shªnÚ_mem_wr™eq
(
sdev
->
pow”_cyşe_couÁ
, &
sm¬t
->power_cycle_count);

4176 
	`shªnÚ_mem_wr™eq
(
sdev
->
ho¡_wr™e_£ùÜs
, &
sm¬t
->host_write_sectors);

4177 
	`shªnÚ_mem_wr™eq
(
sdev
->
tÙ®_wr™e_£ùÜs
, &
sm¬t
->total_write_sectors);

4178 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_have_»ad_£ùÜs
(sdev);

4179 
	`shªnÚ_mem_wr™eq
(
sdev
->
ho¡_»ad_£ùÜs
, &
sm¬t
->host_read_sectors);

4180 
	`shªnÚ_mem_wr™eq
(
sdev
->
£qu’û_numb”
, &
sm¬t
->sequence_number);

4181 
	`shªnÚ_mem_wr™eq
(
MAGICBEAN
, &
sm¬t
->
ÿ·c™y
);

4182 
	`shªnÚ_mem_wr™–
(
MAGICBEAN
, &
sm¬t
->
‹m³¿tu»_št
);

4183 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

4184 
	`shªnÚ_mem_wr™–
(
sdev
->
‹m³¿tu»_št_max
, &
sm¬t
->temperature_int_max);

4185 
	`shªnÚ_mem_wr™–
(
sdev
->
‹m³¿tu»_bßrd_max
, &
sm¬t
->temperature_board_max);

4186 
	`shªnÚ_mem_wr™–
(
sdev
->
‹m³¿tu»_æash_max
, &
sm¬t
->temperature_flash_max);

4187 
	`shªnÚ_mem_wr™–
(
sdev
->
vŞge_št_max
, &
sm¬t
->voltage_int_max);

4188 
	`shªnÚ_mem_wr™–
(
sdev
->
vŞge_aux_max
, &
sm¬t
->voltage_aux_max);

4189 
	`shªnÚ_mem_wr™–
(
sdev
->
£u_üc_”rÜ
 + sdev->
£u_üc_”rÜ_hi¡Üy
, &
sm¬t
->seu_crc_error_history);

4190 
	`shªnÚ_mem_wr™–
(
sdev
->
£u_ecc_”rÜ
 + sdev->
£u_ecc_”rÜ_hi¡Üy
, &
sm¬t
->seu_ecc_error_history);

4191 
	`shªnÚ_mem_wr™–
(
sdev
->
gc_sbs
, &
sm¬t
->gc_sbs);

4192 
	`shªnÚ_mem_wr™–
(
sdev
->
”r_»cov”ed_sbs
, &
sm¬t
->err_recovered_sbs);

4193 
	`shªnÚ_mem_wr™–
(
sdev
->
wl_sbs
, &
sm¬t
->wl_sbs);

4194 
	`shªnÚ_mem_wr™–
(
sdev
->
d©a_»‹ÁiÚ_sbs
, &
sm¬t
->data_retention_sbs);

4195 
	`shªnÚ_mem_wr™–
(
sdev
->
»ad_di¡urb_sbs
, &
sm¬t
->read_disturb_sbs);

4196 
	`shªnÚ_mem_wr™–
(
sdev
->
”a£_b®ªû_sbs
, &
sm¬t
->erase_balance_sbs);

4197 
	`shªnÚ_mem_wr™–
(
sdev
->
ecc_çu»_sbs
, &
sm¬t
->ecc_failure_sbs);

4198 
	}
}

4200 
shªnÚ_g’disk_t
 *
	$g‘_g’disk_äom_sdev
(
shªnÚ_dev
 *
sdev
)

4202  
sdev
->
sdisk
.
gd
;

4203 
	}
}

4205 
	$g‘_logicb_size
(
shªnÚ_dev
 *
sdev
)

4207  
sdev
->
logicb_size
;

4208 
	}
}

4210 
	$g‘_logicb_shiá
(
shªnÚ_dev
 *
sdev
)

4212  
sdev
->
logicb_shiá
;

4213 
	}
}

4215 
shªnÚ_disk
 *
	$g‘_shªnÚ_disk_äom_sdev
(
shªnÚ_dev
 *
sdev
)

4217  &
sdev
->
sdisk
;

4218 
	}
}

4220 
	$shªnÚ_check_avaab™y
(
shªnÚ_dev
 *
sdev
)

4222 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
))

4225 ià(
	`uÆik–y
(
sdev
->
ho¡_acûss_blocked
))

4228 ià(
	`uÆik–y
(
sdev
->
¡©e
 & 
SHN_STATE_ERROR_BIT
))

4231 ià(
	`uÆik–y
((
sdev
->
š™_dÚe
 >ğ
STAGE9_DONE
è&& (sdev->
¡©e
 & 
SHN_STATE_DETACHED
)))

4234 ià(
	`uÆik–y
(
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
è> 
MAX_IN_GC_LOGICBS
)) {

4235 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
)

4236 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 10);

4238 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
è> 
MAX_IN_GC_LOGICBS
)

4239 
	`shªnÚ_m¦“p
(1);

4242 ià(
	`uÆik–y
(
sdev
->
big_lock
))

4243 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
big_lock_ev’t
, sdev->
big_lock
 == 0);

4246 
	}
}

4248 
	$shªnÚ_disk_»adÚly
(
shªnÚ_dev
 *
sdev
)

4250 ià(
	`uÆik–y
(
sdev
->
acûss_mode
 =ğ
SHN_MODE_READONLY
))

4254 
	}
}

4257 
	$__shªnÚ_subm™_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
)

4259 
»t
;

4261 ià((
sbio
->
fœ¡_size
 =ğ0è&& ((sbio->
bio_size
 & (
sdev
->
logicb_size
 - 1)è=ğ0è&& !sbio->
has_hŞe
)

4262 
»t
 = 
	`shªnÚ_subm™_®igÃd_bio
(
sdev
, 
sbio
);

4264 
»t
 = 
	`shªnÚ_subm™_nÚ®igÃd_bio
(
sdev
, 
sbio
, sbio->
fœ¡_size
);

4266  
»t
;

4267 
	}
}

4269 
	#BW_THROTTLE_INTERVAL
 10

	)

4270 
	$shªnÚ_subm™_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
)

4272 
u64
 
max_wr™e_bw
 = 
sdev
->max_write_bw;

4274 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
) {

4275 
	`´eãtch_check
(
sdev
, 
sbio
);

4277 ià((
max_wr™e_bw
è&& (
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) &&

4278 (!(
sdev
->
mbr
.
ã©u»_æags
 & 
LIMIT_BW_WHEN_DISKFULL
è|| sdev->
ä“_blkút
 < 100)) {

4279 
	`shªnÚ_©omic64_add
(
sbio
->
bio_size
, &
sdev
->
wr™e_bw
);

4280 ià(
	`shªnÚ_©omic64_»ad
(&
sdev
->
wr™e_bw
è>ğ
max_wr™e_bw
/(1000/
BW_THROTTLE_INTERVAL
)) {

4281 
	`shªnÚ_mu‹x_lock
(&
sdev
->
thrÙe_wr™e_bw_£m
);

4282 ià(
	`shªnÚ_©omic64_»ad
(&
sdev
->
wr™e_bw
è> 
max_wr™e_bw
/(1000/
BW_THROTTLE_INTERVAL
)) {

4283 
u32
 
time
 = 
	`shªnÚ_jiff›s_to_m£cs
(
	`g‘_jiff›s
());

4284 
	`shªnÚ_©omic64_£t
(&
sdev
->
wr™e_bw
, 0);

4285 ià((
time
 - 
sdev
->
thrÙe_wr™e_bw_time_¡amp
è>ğ
BW_THROTTLE_INTERVAL
) {

4286 
sdev
->
thrÙe_wr™e_bw_time_¡amp
 = 
time
;

4288 
	`shªnÚ_m¦“p
(
sdev
->
thrÙe_wr™e_bw_time_¡amp
 + 
BW_THROTTLE_INTERVAL
 - 
time
 - 1);

4289 
sdev
->
thrÙe_wr™e_bw_time_¡amp
 = 
	`shªnÚ_jiff›s_to_m£cs
(
	`g‘_jiff›s
());

4292 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
thrÙe_wr™e_bw_£m
);

4293 
	`shªnÚ_©omic64_add
(
sbio
->
bio_size
, &
sdev
->
wr™e_bw
);

4297  
	`__shªnÚ_subm™_bio
(
sdev
, 
sbio
);

4298 
	}
}

4300 
	$»cov”_d©a_äom_dummy_·ge
(
shªnÚ_dev
 *
sdev
, *
addr
)

4302 
shªnÚ_sm¬t
 *
sm¬t
 = (shªnÚ_sm¬ˆ*)
addr
;

4304 ià(
	`shªnÚ_mem_»adq
(&
sm¬t
->
ÿ·c™y
è=ğ
MAGICBEAN
 && 
	`shªnÚ_mem_»adl
(&sm¬t->
‹m³¿tu»_št
) == MAGICBEAN) {

4305 ià(
sdev
->
pow”_Ú_£cÚds
 < (
	`shªnÚ_mem_»adq
(&
sm¬t
->power_on_seconds) + 1)) {

4306 
sdev
->
pow”_Ú_£cÚds
 = 
	`shªnÚ_mem_»adq
(&
sm¬t
->power_on_seconds);

4307 ià(
sdev
->
pow”_Ú_£cÚds_hi¡Üy
 < sdev->
pow”_Ú_£cÚds
)

4308 
sdev
->
pow”_Ú_£cÚds_hi¡Üy
 = sdev->
pow”_Ú_£cÚds
;

4310 ià(
sdev
->
pow”_cyşe_couÁ
 < (
	`shªnÚ_mem_»adq
(&
sm¬t
->power_cycle_count) + 1))

4311 
sdev
->
pow”_cyşe_couÁ
 = 
	`shªnÚ_mem_»adq
(&
sm¬t
->power_cycle_count);

4312 ià(
sdev
->
ho¡_wr™e_£ùÜs
 < (
	`shªnÚ_mem_»adq
(&
sm¬t
->host_write_sectors) + 1))

4313 
sdev
->
ho¡_wr™e_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
sm¬t
->host_write_sectors);

4314 ià(
sdev
->
tÙ®_wr™e_£ùÜs
 < (
	`shªnÚ_mem_»adq
(&
sm¬t
->total_write_sectors) + 1))

4315 
sdev
->
tÙ®_wr™e_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
sm¬t
->total_write_sectors);

4316 ià(
sdev
->
ho¡_»ad_£ùÜs_hi¡Üy
 < (
	`shªnÚ_mem_»adq
(&
sm¬t
->
ho¡_»ad_£ùÜs
) + 1))

4317 
sdev
->
ho¡_»ad_£ùÜs_hi¡Üy
 = 
	`shªnÚ_mem_»adq
(&
sm¬t
->
ho¡_»ad_£ùÜs
);

4318 ià(
sdev
->
pow”_Ú_£q_num
 < (
	`shªnÚ_mem_»adq
(&
sm¬t
->
£qu’û_numb”
) + 1))

4319 
sdev
->
pow”_Ú_£q_num
 = 
	`shªnÚ_mem_»adq
(&
sm¬t
->
£qu’û_numb”
);

4320 ià(
sdev
->
‹m³¿tu»_št_max
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->temperature_int_max) + 1))

4321 
sdev
->
‹m³¿tu»_št_max
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->temperature_int_max);

4322 ià(
sdev
->
‹m³¿tu»_bßrd_max
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->temperature_board_max) + 1))

4323 
sdev
->
‹m³¿tu»_bßrd_max
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->temperature_board_max);

4324 ià(
sdev
->
‹m³¿tu»_æash_max
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->temperature_flash_max) + 1))

4325 
sdev
->
‹m³¿tu»_æash_max
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->temperature_flash_max);

4326 ià(
sdev
->
vŞge_št_max
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->voltage_int_max) + 1))

4327 
sdev
->
vŞge_št_max
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->voltage_int_max);

4328 ià(
sdev
->
vŞge_aux_max
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->voltage_aux_max) + 1))

4329 
sdev
->
vŞge_aux_max
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->voltage_aux_max);

4330 ià(
sdev
->
£u_üc_”rÜ_hi¡Üy
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->seu_crc_error_history) + 1))

4331 
sdev
->
£u_üc_”rÜ_hi¡Üy
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->seu_crc_error_history);

4332 ià(
sdev
->
£u_ecc_”rÜ_hi¡Üy
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->seu_ecc_error_history) + 1))

4333 
sdev
->
£u_ecc_”rÜ_hi¡Üy
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->seu_ecc_error_history);

4334 ià(
sdev
->
gc_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->gc_sbs) + 1))

4335 
sdev
->
gc_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->gc_sbs);

4336 ià(
sdev
->
”r_»cov”ed_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->err_recovered_sbs) + 1))

4337 
sdev
->
”r_»cov”ed_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->err_recovered_sbs);

4338 ià(
sdev
->
wl_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->wl_sbs) + 1))

4339 
sdev
->
wl_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->wl_sbs);

4340 ià(
sdev
->
d©a_»‹ÁiÚ_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->data_retention_sbs) + 1))

4341 
sdev
->
d©a_»‹ÁiÚ_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->data_retention_sbs);

4342 ià(
sdev
->
»ad_di¡urb_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->read_disturb_sbs) + 1))

4343 
sdev
->
»ad_di¡urb_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->read_disturb_sbs);

4344 ià(
sdev
->
”a£_b®ªû_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->erase_balance_sbs) + 1))

4345 
sdev
->
”a£_b®ªû_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->erase_balance_sbs);

4346 ià(
sdev
->
ecc_çu»_sbs
 < (
	`shªnÚ_mem_»adl
(&
sm¬t
->ecc_failure_sbs) + 1))

4347 
sdev
->
ecc_çu»_sbs
 = 
	`shªnÚ_mem_»adl
(&
sm¬t
->ecc_failure_sbs);

4349 
	}
}

4352 
	$£nd_dummy_ov”Ïp_»q
(
shªnÚ_dev
 *
sdev
, 
ov”wr™e
)

4354 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

4356 
	`upd©e_d©a_š_dummy_·ge
(
sdev
);

4357 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

4358 
	`£t_»q_debug_g
(
»q
, 
DUMMY_CHUNK_TAG
, 0);

4359 
»q
->
İcode
 = 
sh_cmd_wr™e
;

4360 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

4361 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

4362 
»q
->
h—d
 = 
OVERLAP_HEAD
;

4363 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

4364 
»q
->
dma_add»ss
 = 
sdev
->
dummy_dma_·ge
;

4365 
»q
->
vœt_addr
 = 
sdev
->
dummy_·ge
;

4366 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4367 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

4368 
	`shªnÚ_wr™e_ov”Ïp_»que¡
(
sdev
, 
»q
, 
ov”wr™e
);

4369 
	}
}

4371 
	$£nd_dummy_»q
(
shªnÚ_dev
 *
sdev
, 
h—d
)

4373 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

4375 
	`upd©e_d©a_š_dummy_·ge
(
sdev
);

4376 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

4377 
	`£t_»q_debug_g
(
»q
, 
DUMMY_CHUNK_TAG
, 0);

4378 
»q
->
İcode
 = 
sh_cmd_wr™e
;

4379 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

4380 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

4381 
»q
->
h—d
 = head;

4382 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

4383 
»q
->
dma_add»ss
 = 
sdev
->
dummy_dma_·ge
;

4384 
»q
->
vœt_addr
 = 
sdev
->
dummy_·ge
;

4385 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

4386 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

4387 
	`shªnÚ_pick_wr™e_»que¡
(
sdev
, 
»q
);

4388 
	}
}

4390 
	$®l_cmd_queue_is_em±y
(
shªnÚ_dev
 *
sdev
)

4392 
shªnÚ_lun£t
 *
lun£t
;

4393 
i
;

4394 
u32
 
h—d_tÙ®
, 
_tÙ®
;

4395 #ifdeà
SHANNON_USE_WRITE_BUFFER


4396 
u32
 
ack_cq_h—d1
, 
ack_cq_h—d2
;

4399 
h—d_tÙ®
 = 0;

4400 
_tÙ®
 = 0;

4401 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

4402 
lun£t
 = &
sdev
->
lun£ts
[
i
];

4403 
h—d_tÙ®
 +ğ
lun£t
->
sq_h—d_tmp
;

4404 ià(
lun£t
->
sq_h—d_tmp
 !ğlun£t->
cq_
)

4407 #ifdeà
SHANNON_USE_WRITE_BUFFER


4408 
h—d_tÙ®
 +ğ
sdev
->
bufq_sq_h—d_tmp
[0];

4409 ià(
sdev
->
bufq_sq_h—d_tmp
[0] !ğsdev->
bufq_cq_
[0])

4411 
h—d_tÙ®
 +ğ
sdev
->
bufq_sq_h—d_tmp
[1];

4412 ià(
sdev
->
bufq_sq_h—d_tmp
[1] !ğsdev->
bufq_cq_
[1])

4416 
	`shªnÚ_b¬r›r
();

4417 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

4418 
lun£t
 = &
sdev
->
lun£ts
[
i
];

4419 
_tÙ®
 +ğ
lun£t
->
cq_
;

4421 #ifdeà
SHANNON_USE_WRITE_BUFFER


4422 
_tÙ®
 +ğ
sdev
->
bufq_cq_
[0];

4423 
_tÙ®
 +ğ
sdev
->
bufq_cq_
[1];

4425 ià(
h—d_tÙ®
 !ğ
_tÙ®
)

4428 #ifdeà
SHANNON_USE_WRITE_BUFFER


4429 
ack_cq_h—d1
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
bufq_ack_b¬
->
cq_h—d
);

4431 
	`shªnÚ_m¦“p
(3);

4433 
ack_cq_h—d2
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
bufq_ack_b¬
->
cq_h—d
);

4435 ià(
ack_cq_h—d1
 !ğ
ack_cq_h—d2
)

4440 
	}
}

4443 
	$pick_»£nd_li¡
(
shªnÚ_dev
 *
sdev
)

4445 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

4447 !
	`shªnÚ_li¡_em±y
(&
sdev
->
»£nd_li¡
)) {

4448 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»£nd_li¡_lock
);

4449 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
»£nd_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4450 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

4451 
sdev
->
»£nd_logicbs
--;

4452 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»£nd_li¡_lock
);

4453 
	`shªnÚ_pick_wr™e_»que¡
(
sdev
, 
»q
);

4455 
	}
}

4457 
	$decom´ess_m‘ad©a
(
shªnÚ_»que¡
 *
»q
)

4459 
u64
 
lba
;

4460 
u16
 
ns_id
, 
ns_£q_num
, 
d©©y³
;

4462 
lba
 = 
»q
->
_m‘ad©a
 & 
LONG_LBA_MASK
;

4463 
ns_id
 = (
»q
->
_m‘ad©a
 >> 
NS_ID_SHIFT
è& 
NS_ID_MASK
;

4464 
ns_£q_num
 = (
»q
->
_m‘ad©a
 >> 
NS_SEQ_NUM_SHIFT
è& 
NS_SEQ_NUM_MASK
;

4465 
d©©y³
 = (
»q
->
_m‘ad©a
 >> 
DATATYPE_SHIFT
è& 
DATATYPE_MASK
;

4467 ià(
	`lÚg_lba_is_šv®id
(
»q
->
lba
)) {

4468 
»q
->
lba
 =†ba;

4469 
»q
->
ns_id
 =‚s_id;

4470 
»q
->
ns_£q_num
 =‚s_seq_num;

4471 
»q
->
d©©y³
 = datatype;

4472 } ià((
»q
->
lba
 !ğlbaè|| (»q->
ns_id
 !=‚s_id) || \

4473 (
»q
->
ns_£q_num
 !=‚s_seq_num)) {

4474 
	`debugs0
("metadata=0x%lx,†ba=0x%lx,‚s_id=%d,‚s_seq_num=%d, datatype=%d.\n",

4475 
»q
->
_m‘ad©a
, 
lba
, 
ns_id
, 
ns_£q_num
, 
d©©y³
);

4476 
	`debugs0
("value in„eq:†ba=0x%lx,‚s_id=%d,‚s_seq_num=%d, datatype=%d,ag=0x%lx.\n",

4477 
»q
->
lba
,„eq->
ns_id
,„eq->
ns_£q_num
,„eq->
d©©y³
,„eq->
g
);

4482 
	}
}

4484 
	~"shªnÚ_bufãr.c
"

4485 
	~"shªnÚ_”r_šjeùiÚ.c
"

4487 
	$lun_šü—£_cmd_timeout
(
shªnÚ_dev
 *
sdev
, 
u32
 
phy_lun
)

4489 
u32
 
logiÿl_lun
 = 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
phy_lun
);

4490 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
logiÿl_lun
];

4492 
lun
->
commªd_timeout_út
++;

4493 ià((
lun
->
commªd_timeout_út
 > 
shªnÚ_max_commªd_timeout
è&& !lun->
bad
) {

4494 
	`shªnÚ_log
("thnumb” oàluÀ%d commªdimeouˆmÜthª %d, m¬k†uÀbad.\n", 
lun
->
lun_num
,†un->
commªd_timeout_út
);

4495 
	`£t_Ãw_bad_lun
(
sdev
, 
lun
);

4496 
	`m¬k_sb_”r_fÜ_bad_lun
(
sdev
, 
lun
);

4497 
	`move_blks_to_”r_blks_li¡
(
sdev
);

4498 
	`check_”r_blkút_šc
(
sdev
);

4500 
	}
}

4502 
	$check_comp_queue
(
shªnÚ_cmd
 *
cmd
)

4504 
cmd
->
İcode
) {

4505 
sh_cmd_»g_wr™e
:

4506 
sh_cmd_»g_»ad
:

4507 
sh_cmd_»£t
:

4509 
sh_cmd_no_İ
:

4510 ià(
cmd
->
h—d
 & 
NO_COMPLETION_WRITE_MASK
)

4515 
	}
}

4517 
u32
 
	$»³©_»ad_cq_h—d
(
shªnÚ_dev
 *
sdev
, cÚ¡ vŞ©
__iomem
 *
addr
)

4519 
»Œy
 = 0;

4520 
u32
 
v®ue
;

4522 
	`shªnÚ_šfo
("enter.\n");

4524 
v®ue
 = 
	`»ad_»g_§ã
(
sdev
, 
addr
);

4525 
»Œy
++;

4526 } (
v®ue
 > 
QUEUE_SIZE
è&& (
»Œy
 < 50));

4527 
	`shªnÚ_šfo
("cq_h—d=0x%x.\n", 
v®ue
);

4528  
v®ue
;

4529 
	}
}

4531 
	$__hªdË_lun£t
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun£t
 *
lun£t
, 
š_wq
, 
»ad_cq_h—d
)

4533 
shªnÚ_sb
 *
sb
;

4534 
shªnÚ_cmd
 *
cmd
;

4535 
shªnÚ_ÿched_»ad_cmd
 *
»ad
;

4536 
shªnÚ_cmd_šfo
 *
šfo
;

4537 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

4538 
shªnÚ_lun
 *
lun
 = 
NULL
;

4539 
sub_group
 *
group
;

4540 
i
, 
logicbs
, 
cmdid
, 
cmd_Ën
, 
¶ªe
, 
logiÿl_lun
;

4541 
»Œy
, 
has_´og»ss
 = 0;

4542 
__u8
 
¡©us
;

4543 
__u8
 *
ecc
;

4544 
__u32
 
‹mp_sq_h—d
;

4545 
u64
 *
m‘ad©a
;

4546 
u64
 
¿w_cm¶
;

4547 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4548 
h—d
;

4555 
	`BUG_ON
(
š_wq
 ^ (!!
	`shªnÚ_©omic_»ad
(&
lun£t
->in_wq)));

4556 ià(
	`uÆik–y
(
sdev
->
¶ug_out
))

4557 
EXIT
;

4559 ià(
	`uÆik–y
(
»ad_cq_h—d
)) {

4560 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

4561 
lun£t
->
cq_hw_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->
cq_h—d
);

4563 ià(
	`uÆik–y
(
lun£t
->
cq_hw_h—d
 > 
QUEUE_SIZE
)) {

4564 
sdev
->
¶ug_out
 = 
	`check_¶ugout
(sdev);

4565 ià(
sdev
->
¶ug_out
)

4566 
EXIT
;

4567 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

4568 
lun£t
->
cq_hw_h—d
 = 
	`»³©_»ad_cq_h—d
(
sdev
, &lun£t->
lun_b¬
->
cq_h—d
);

4570 ià(
lun£t
->
cq_hw_h—d
 > 
QUEUE_SIZE
) {

4571 
	`shªnÚ_”r
("lun£t=%d, cq_hw_h—d=0x%x.\n", 
lun£t
->
šdex
,†un£t->
cq_hw_h—d
);

4572 
sdev
->
¡©e
 |ğ
SHN_STATE_ERROR_BIT
;

4573 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
w©chdog_wÜk
);

4574 
EXIT
;

4578 
lun£t
->
cq_h—d
 =†un£t->
cq_hw_h—d
;

4580 #ifdeà
CONFIG_SHANNON_DEBUG


4581 
lun£t
->
queue_d•th
[(Öun£t->
sq_hw_h—d
 + 
QUEUE_SIZE
 -†un£t->
cq_
)%QUEUE_SIZE)/(248)]++;

4582 
lun£t
->
cmd_queue_d•th
[(Öun£t->
sq_hw_h—d
 + 
QUEUE_SIZE
 -†un£t->
cq_hw_h—d
)%QUEUE_SIZE)/(248)]++;

4583 
lun£t
->
comp_queue_d•th
[(Öun£t->
cq_hw_h—d
 + 
QUEUE_SIZE
 -†un£t->
cq_
)%QUEUE_SIZE)/(248)]++;

4586 #ifdeà
CONFIG_SHANNON_DEBUG


4587 
lun£t
->
queue_d•th
[(Öun£t->
sq_hw_h—d
 + 
QUEUE_SIZE
 -†un£t->
cq_
)%QUEUE_SIZE)/(248)]++;

4591 
‹mp_sq_h—d
 = 
lun£t
->
sq_h—d
;

4593 ià(
	`lik–y
(!
»ad_cq_h—d
)) {

4594 
cmdid
 = 
lun£t
->
cq__tmp
 >> 3;

4595 
cmd
 = 
lun£t
->
sq_addr
 + 
cmdid
;

4597 ià(
lun£t
->
cq__tmp
 =ğ
‹mp_sq_h—d
)

4599 
¿w_cm¶
 = *((
u64
 *)
lun£t
->
cq_addr
 + 
cmdid
);

4601 ià(
	`check_comp_queue
(
cmd
è&& (
¿w_cm¶
 =ğ
COMP_QUEUE_FILL
))

4604 ià(
lun£t
->
cq_
 =ğlun£t->
cq_h—d
) {

4606 ià(
lun£t
->
cq__tmp
 !ğlun£t->
cq_
)

4607 
lun£t
->
cq__tmp
 =†un£t->
cq_
;

4611 
cmdid
 = 
lun£t
->
cq_
 >> 3;

4612 
cmd
 = 
lun£t
->
sq_addr
 + 
cmdid
;

4613 ià(
lun£t
->
cq_
 !ğlun£t->
cq__tmp
) {

4614 ià(
	`check_comp_queue
(
cmd
)) {

4615 
	`shªnÚ_”r
("%s: Software BUG: corrupted command queue status for†unset=%d, cq_tail=0x%x, "

4617 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
,†un£t->
cq_
,†un£t->
cq__tmp
, \

4618 
lun£t
->
cq_h—d
,†un£t->
sq_h—d
, 
cmd
->
İcode
);

4619 
	`BUG
();

4623 ià(
	`check_comp_queue
(
cmd
)) {

4624 
¿w_cm¶
 = *((
u64
 *)
lun£t
->
cq_addr
 + 
cmdid
);

4625 ià(
¿w_cm¶
 =ğ
COMP_QUEUE_FILL
)

4626 
	`shªnÚ_®¬m
("%s:†unset=%d, cqƒrror: opcode=0x%x, sq_head=0x%x, cq_tail=0x%x, cq_tail_tmp=0x%x, cq_head=0x%x.\n",

4627 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
, 
cmd
->
İcode
,†un£t->
sq_h—d
,†un£t->
cq_
, \

4628 
lun£t
->
cq__tmp
,†un£t->
cq_h—d
);

4632 
šfo
 = &
lun£t
->
cmd_šfo
[
cmdid
];

4633 
¡©us
 = *((
__u8
 *)(
lun£t
->
cq_addr
 + (lun£t->
cq__tmp
>>3)));

4634 ià(
šfo
->
cmd_Ën
 == 0) {

4635 
	`shªnÚ_”r
("Wrong command format: %s:…hy_lun=%d,…pa=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, status=0x%x.\n",

4636 
	`İcode_Çme
(
cmd
->
İcode
), 
	`g‘_cmd_phy_lun
(
sdev
, 
lun£t
->
šdex
, &cmd->
dwÜd1
),

4637 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
), 
lun£t
->
cq_
,†un£t->
cq__tmp
, 
¡©us
);

4638 
	`BUG
();

4640 
cmd
->
İcode
) {

4641 
sh_cmd_»£t
:

4643 
sh_cmd_´e_»ad
:

4644 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4645 
logiÿl_lun
 = 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
));

4646 ià(
	`is_çke_cmd_timeout_lun
(
sdev
, 
logiÿl_lun
)) {

4647 
	`debugs1
("### T¿°š fakcommªdimeouˆlun:†un=%d\n", 
»q
->
pba
.
lun
);

4648 
¡©us
 = 0xFE;

4651 ià(
¡©us
 == 0xff) {

4653 
	`shªnÚ_log
("%s:…re-read command may‚ot work:…hy_lun=%d,…pa=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, status=0x%x.\n",

4654 
sdev
->
sdisk
.
disk_Çme
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
),

4655 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
), 
lun£t
->
cq_
,†un£t->
cq__tmp
, 
¡©us
);

4656 } ià(
	`check_cmd_timeout
(
¡©us
)) {

4657 
	`shªnÚ_w¬n
("%s:…re-readimeout,†unset=%d,…hy_lun=%d,†un=%d, sb=%d.\n",

4658 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
, 
	`g‘_cmd_phy_lun
(sdev,†un£t->šdex, &
cmd
->
dwÜd1
),

4659 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
)),

4660 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
)/sdev->
·ges_š_siblšg_eblock
);

4661 
	`lun_šü—£_cmd_timeout
(
sdev
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
));

4664 
sh_cmd_advªûd_»ad
:

4666 ià(
	`lik–y
(!
»ad_cq_h—d
)) {

4667 
lun£t
->
cq_hw_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->
cq_h—d
);

4668 
lun£t
->
cq_h—d
 =†un£t->
cq_hw_h—d
;

4669 ià(
lun£t
->
cq_h—d
 =ğlun£t->
cq__tmp
)

4670 
EXIT
;

4672 
sh_cmd_»ad
:

4673 
sh_cmd_»ad_’d
:

4674 
ecc
 = (
__u8
 *)(
lun£t
->
cq_addr
 + (lun£t->
cq__tmp
>>3));

4675 
m‘ad©a
 = 
	`cmd_queue_šc
(
ecc
, 1);

4676 
»ad
 = (
shªnÚ_ÿched_»ad_cmd
 *)
cmd
;

4677 
logicbs
 = 
	`g‘_»ad_cmd_logicbs
(
»ad
->
by‹1
) + 1;

4678 
i
=0; i<
logicbs
; i++) {

4679 ià(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

4680 
	`shªnÚ_”r
("req_list isƒmpty! i=%d,†unset=%d, sq_head=%x, cq_tail=0x%x, cq_tail_tmp=%x.\n",

4681 
i
, 
lun£t
->
šdex
,†un£t->
sq_h—d
,†un£t->
cq_
,†un£t->
cq__tmp
);

4682 
	`BUG
();

4684 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4685 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

4686 
»q
->
_ecc
 = 
ecc
[
i
];

4687 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4688 ià(
sdev
->
mªu®_»ad_”r
) {

4689 
	`m¬k_çke_rd_bad_luÅba
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

4690 
sdev
->
mªu®_»ad_”r
 = 0;

4692 ià(
	`is_çke_rd_bad_luÅba
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
) ||

4693 (
	`»q_is_š_aùive_chunks_¿nge
(
sdev
, 
»q
, &
h—d
) &&

4694 
	`is_çke_twš_rd_bad_luÅba
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
, 
h—d
 & 
HEAD_INDEX_MASK
))) {

4695 
	`debugs1
("### Trap in fake„ead bad†unpba:†un=%d blk=%d…age=%d sector=%d\n",

4696 
»q
->
pba
.
lun
,

4697 (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è/ sdev->
·ges_š_eblock
,

4698 (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
,

4699 
»q
->
pba
.
lun_pba
 % 
sdev
->
logicbs_š_·ge
);

4700 
»q
->
_ecc
 = 
SH_FAKE_ERR
;

4701 
	`shªnÚ_mem_wr™eq
(0x123456782468ABCD, 
m‘ad©a
);

4702 
	`shªnÚ_mem_wr™eq
(0x87654321ABCD2468, 
»q
->
vœt_addr
);

4705 ià(
	`lik–y
(
has_dma_d–ay
)) {

4706 ià(!((
cmd
->
İcode
 =ğ
sh_cmd_advªûd_»ad
è&& (
»q
->
_ecc
 >ğ
SH_FAKE_ERR
))) {

4707 
»Œy
 = 0;

4708 
	`shªnÚ_mem_»adq
(
m‘ad©a
è=ğ
COMP_QUEUE_FILL
) {

4709 
»Œy
++;

4710 
sdev
->
»ad_pŞl_»Œy
++;

4711 ià(
»Œy
 > 
DMA_REORDER_RETRY_COUNT
) {

4712 
	`shªnÚ_®¬m
("%s:†unset=%d, DMA metadata opcode=0x%X, metadata=%llX, "

4714 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
, 
cmd
->
İcode
, 
»q
->
_m‘ad©a
, \

4715 
lun£t
->
cq_
,†un£t->
cq__tmp
,†un£t->
sq_h—d
,†un£t->
cq_h—d
);

4718 
	`shªnÚ_b¬r›r
();

4719 
	`shªnÚ_ud–ay
(2);

4723 
»q
->
_m‘ad©a
 = 
	`shªnÚ_mem_»adq
(
m‘ad©a
);

4724 
	`BUG_ON
(
»q
->
sbio
 =ğ
NULL
);

4725 
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

4726 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

4727 ià(
»q
->
İcode
 =ğ
sh_cmd_advªûd_»ad
)

4728 
	`shªnÚ_©omic_dec
(&
sdev
->
š_cmd_queue_adv_»ads
);

4730 ià(
»q
->
_ecc
 !ğ
SH_FRESH_ERASED
 &&„eq->_ecø> 
sb
->
max_ecc
)

4731 
sb
->
max_ecc
 = 
»q
->
_ecc
;

4732 ià(
»q
->
_ecc
 =ğ
SH_FRESH_ERASED
) {

4733 ià(
	`uÆik–y
((!
	`lÚg_lba_is_šv®id
(
»q
->
lba
)è|| (
sb
->
¡©e
 =ğ
IN_GC_BLOCK
))){

4734 
	`shªnÚ_©omic_šc
(&
sdev
->
ecc_çu»_times
);

4735 ià(
»q
->
İcode
 =ğ
sh_cmd_advªûd_»ad
)

4736 
	`shªnÚ_©omic_šc
(&
lun
->
adv_»ad_çu»_times
);

4738 
	`shªnÚ_©omic_šc
(&
lun
->
ecc_çu»_times
);

4739 
	`hªdË_»ad_”rÜ
(
sdev
, 
»q
);

4741 
»q
->
sbio
->
¡©us
 |ğ
HAVE_BLANK_SECTOR
;

4742 
»q
->
¡©e
 = 
REQ_DONE
;

4743 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

4745 } ià(
»q
->
_ecc
 >ğ
SH_FAKE_ERR
) {

4746 ià(
»q
->
_ecc
 == 0xFC)

4747 
	`shªnÚ_©omic_šc
(&
sdev
->
ecc_fc_¡©i¡ics
);

4748 
	`shªnÚ_©omic_šc
(&
sdev
->
ecc_çu»_times
);

4749 ià(
»q
->
İcode
 =ğ
sh_cmd_advªûd_»ad
) {

4750 
	`shªnÚ_©omic_šc
(&
lun
->
adv_»ad_çu»_times
);

4752 
	`shªnÚ_©omic_šc
(&
lun
->
ecc_çu»_times
);

4753 ià(!
	`is_aùive_blk
(
sb
)) {

4755 
sb
->
ecc_çu»_times
[
»q
->
pba
.
lun
]++;

4756 ià(
sb
->
ecc_çu»_times
[
»q
->
pba
.
lun
] > sb->
max_lun_ecc_çu»_times
)

4757 
sb
->
max_lun_ecc_çu»_times
 = sb->
ecc_çu»_times
[
»q
->
pba
.
lun
];

4760 
	`hªdË_»ad_”rÜ
(
sdev
, 
»q
);

4762 ià(
	`decom´ess_m‘ad©a
(
»q
)) {

4763 
shªnÚ_sb
 *
tmp_sb
 = (
sdev
)->
sbs
 + (
»q
)->
pba
.
lun_pba
/(sdev)->
logicbs_š_siblšg_eblock
;

4764 ià(
	`is_¢­»ad_»q
(
»q
))

4765 
	`shªnÚ_©omic_šc
(&
sdev
->
¢­_»ad_mism©ch
);

4766 
	`shªnÚ_w¬n
("%s:†ba‡nd metadata don't match.†un=%d,†un_pba=%d, seq_num=0x%lx,†ba=0x%lx, metadata=0x%lx, sb=%d, state=%d, sb->seq_num=0x%lx.\n",

4767 (
sdev
)->
sdisk
.
disk_Çme
, (
»q
)->
pba
.
lun
, (»q)->pba.
lun_pba
, (»q)->
£q_num
, (»q)->
lba
, ()Ôeq)->
_m‘ad©a
,

4768 
tmp_sb
->
sb_šdex
,mp_sb->
¡©e
,mp_sb->
£q_num
);

4769 
	`hªdË_»ad_”rÜ
(
sdev
, 
»q
);

4771 
sdev
->
ecc_¡©i¡ics
[
»q
->
_ecc
 > sdev->
ecc_cÜ»ùiÚ_pow”
 ? sdev->ecc_correction_power :„eq->_ecc]++;

4772 ià(
»q
->
İcode
 =ğ
sh_cmd_advªûd_»ad
)

4773 
lun
->
adv_»ad_ecc_¡©i¡ics
[
»q
->
_ecc
 > 
sdev
->
ecc_cÜ»ùiÚ_pow”
 ? sdev->ecc_correction_power :„eq->_ecc]++;

4775 
lun
->
ecc_¡©i¡ics
[
»q
->
_ecc
 > 
sdev
->
ecc_cÜ»ùiÚ_pow”
 ? sdev->ecc_correction_power :„eq->_ecc]++;

4776 
»q
->
sbio
->
cÜ»ùed_b™s
 +ğ
ecc
[
i
];

4777 
»q
->
¡©e
 = 
REQ_DONE
;

4778 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

4781 
m‘ad©a
 = 
	`cmd_queue_šc
(metadata, 1);

4785 
sh_cmd_wr™e
:

4786 
	`shªnÚ_©omic_sub
(
sdev
->
logicbs_š_·ge
, &sdev->
š_cmd_queue_wr™es
);

4787 ià(
sdev
->
cmd_queue_wr™es_lim™
 && 
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
è< 
	`GET_CMD_QUEUE_WRITES_THRESHOLD_L
(sdev)) {

4788 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

4789 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4791 ià(
sdev
->
h¬d_queue_lim™
 && (
	`shªnÚ_©omic_»ad
(&sdev->
š_cmd_queue_wr™es
) < sdev->hard_queue_limit)) {

4792 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

4793 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

4795 ià(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
))

4797 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4798 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
 / sdev->
logicbs_š_siblšg_eblock
;

4799 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4800 ià(!(
cmd
->
h—d
 & 
NO_POLL_MASK
è&& 
	`is_çke_wr_bad_luÅ·
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
/sdev->
logicbs_š_·ge
)) {

4801 
	`debugs1
("### Trap in fake‚ormal write bad†unppa:†un=%d blk=%d…age=%d\n",

4802 
»q
->
pba
.
lun
,

4803 (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è/ sdev->
·ges_š_eblock
,

4804 (
»q
->
pba
.
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
);

4805 
¡©us
 = 0xEF;

4809 
	`shªnÚ_©omic_sub
(
sdev
->
logicbs_š_chunk
, &
sb
->
unfšished_wr™es
);

4810 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& 
	`check_¡©us
(
¡©us
)) {

4811 ià(
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
) {

4813 
¶ªe
 = (
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
)/sdev->
·ges_š_eblock
è% sdev->
¶ªes
;

4814 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
)) {

4815 
	`shªnÚ_log
("%s: mark write block:†un=%d,…hy_lun=%d, sb_index=%d,…pa=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, status=0x%x.\n",

4816 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
), 
sb
->
sb_šdex
,

4817 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
), 
lun£t
->
cq_
,†un£t->
cq__tmp
, 
¡©us
);

4818 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
);

4820 
	`hªdË_wr™e_”rÜ
(
sdev
, 
sb
, 
NULL
);

4824 
	`sb_m¬k_bad_lun
(
sb
, 
»q
->
pba
.
lun
);

4825 
	`add_bad_eblk_to_lun_bbt
(
sdev
->
lun
[
»q
->
pba
.lun], 
	`g‘_cmd_µa
(sdev, &
cmd
->
dwÜd1
)/sdev->
·ges_š_eblock
);

4828 !
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

4829 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4830 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

4832 ià(
»q
->
sbio
) {

4833 
»q
->
¡©e
 = 
REQ_DONE
;

4834 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

4836 
	`ä“_»q
(
»q
);

4837 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

4841 
sh_cmd_no_İ
:

4842 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4843 ià(
sdev
->
mªu®_wr™e_”r
) {

4844 
	`m¬k_çke_wr_bad_luÅ·
(
sdev
, 
phy_lun_to_logiÿl_lun
[sdev->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
)),

4845 
šfo
->
lun_pba
/
sdev
->
logicbs_š_·ge
);

4846 
sdev
->
mªu®_wr™e_”r
 = 0;

4848 ià(
	`is_çke_wr_bad_luÅ·
(
sdev
, 
phy_lun_to_logiÿl_lun
[sdev->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
)),

4849 
šfo
->
lun_pba
/
sdev
->
logicbs_š_·ge
)) {

4850 
	`debugs1
("### Trap in fake‚opoll write bad†unppa:†un=%d blk=%d…age=%d\n",

4851 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
)),

4852 (
šfo
->
lun_pba
 / 
sdev
->
logicbs_š_·ge
è/ sdev->
·ges_š_eblock
,

4853 (
šfo
->
lun_pba
 / 
sdev
->
logicbs_š_·ge
è% sdev->
·ges_š_eblock
);

4854 
¡©us
 = 0xEF;

4855 } ià(
	`is_çke_cmd_timeout_lun
(
sdev
, 
phy_lun_to_logiÿl_lun
[sdev->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
)))) {

4856 
	`debugs1
("### T¿°š fakcommªdimeouˆlun:†un=%d\n", 
»q
->
pba
.
lun
);

4857 
¡©us
 = 0xFE;

4860 ià(
cmd
->
h—d
 & 
NO_COMPLETION_WRITE_MASK
)

4862 
sb
 = 
sdev
->
sbs
 + 
šfo
->
lun_pba
 / sdev->
logicbs_š_siblšg_eblock
;

4863 
logiÿl_lun
 = 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
));

4864 ià(
	`check_cmd_timeout
(
¡©us
)) {

4865 
	`shªnÚ_w¬n
("%s:‚o_opimeout, sb=%d,†unset=%d,…hy_lun=%d,†un=%d,†un_pba=%d.\n",

4866 
sdev
->
sdisk
.
disk_Çme
, 
sb
->
sb_šdex
, 
lun£t
->
šdex
, 
	`g‘_cmd_phy_lun
(sdev,†un£t->šdex, &
cmd
->
dwÜd1
), 
logiÿl_lun
, 
šfo
->
lun_pba
);

4867 
	`lun_šü—£_cmd_timeout
(
sdev
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
));

4869 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& (
	`g‘_cmd_µa
(sdev, &
cmd
->
dwÜd1
è!ğ(0x03fffffà/ sdev->
logicbs_š_·ge
)è&& 
	`check_¡©us
(
¡©us
)) {

4870 ià(
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
) {

4871 
¶ªe
 = 0;…ÏÃ < 
sdev
->
¶ªes
;…lane++) {

4872 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
logiÿl_lun
, 
¶ªe
)) {

4873 
	`shªnÚ_log
("%s: mark‚opoll-write block:†un=%d,…hy_lun=%d, sb_index=%d,…pa=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, status=0x%x.\n",

4874 
sdev
->
sdisk
.
disk_Çme
, 
logiÿl_lun
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
),

4875 
sb
->
sb_šdex
, 
šfo
->
lun_pba
/
sdev
->
logicbs_š_·ge
, 
lun£t
->
cq_
,†un£t->
cq__tmp
, 
¡©us
);

4876 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
logiÿl_lun
, 
¶ªe
);

4879 ià(
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
è!ğ(0x03fffffà/ sdev->
logicbs_š_·ge
))

4880 
	`hªdË_wr™e_”rÜ
(
sdev
, 
sb
, 
NULL
);

4883 
	`sb_m¬k_bad_lun
(
sb
, 
logiÿl_lun
);

4884 
	`add_bad_eblk_to_lun_bbt
(
sdev
->
lun
[
logiÿl_lun
], (
šfo
->
lun_pba
/sdev->
logicbs_š_·ge
)/sdev->
·ges_š_eblock
);

4889 
sh_cmd_”a£
:

4891 !
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

4892 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4893 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4894 ià(
	`is_çke_cmd_timeout_lun
(
sdev
, 
»q
->
pba
.
lun
)) {

4895 
	`debugs1
("### T¿°š fakcommªdimeouˆlun:†un=%d\n", 
»q
->
pba
.
lun
);

4896 
¡©us
 = 0xFE;

4897 } ià(
	`is_çke_”_bad_block
(
sdev
, 
»q
->
pba
.
lun
,„eq->
µa
/sdev->
·ges_š_eblock
)) {

4898 
	`debugs1
("### T¿°š fak”a£ bad block:†un=%d block=%d\n", 
»q
->
pba
.
lun
,„eq->
µa
/
sdev
->
·ges_š_eblock
);

4899 
¡©us
 = 0xEF;

4902 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

4903 ià(
»q
->
sbio
) {

4904 ià(
	`check_¡©us
(
¡©us
è|| 
	`check_cmd_timeout
(status)) {

4905 
sb
 = 
sdev
->
sbs
 + 
»q
->
µa
/(sdev->
·ges_š_eblock
 * sdev->
¶ªes
);

4906 ià(
	`check_cmd_timeout
(
¡©us
)) {

4907 
	`shªnÚ_w¬n
("%s:ƒraseimeout:†unset=%d,…hy_lun=%d,†un=%d, sb=%d.\n",

4908 
sdev
->
sdisk
.
disk_Çme
, 
lun£t
->
šdex
, 
	`g‘_cmd_µa
(sdev, &
cmd
->
dwÜd1
), 
»q
->
pba
.
lun
, 
sb
->
sb_šdex
);

4909 
	`lun_šü—£_cmd_timeout
(
sdev
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
));

4911 
	`shªnÚ_log
("%s: markƒrase block:†un=%d,…hy_lun=%d, sb_index=%d,…pa=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, status=0x%x.\n",

4912 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
pba
.
lun
, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
), 
sb
->
sb_šdex
,

4913 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
), 
lun£t
->
cq_
,†un£t->
cq__tmp
, 
¡©us
);

4914 ià(
	`shªnÚ_‹¡_ªd_£t_b™
(
ERROR_SB_SHIFT
, &
sb
->
»şaim_kšd
) == 0) {

4915 ià(
sb
->
sb_šdex
 >ğ
sdev
->
mbr_eblocks
/sdev->
¶ªes
)

4916 
	`shªnÚ_©omic_šc
(&
sdev
->
³ndšg_”r_blks
);

4919 
¶ªe
 = (
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
)/sdev->
·ges_š_eblock
è% sdev->
¶ªes
;

4920 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
»q
->
pba
.
lun
, 
¶ªe
);

4923 
»q
->
¡©e
 = 
REQ_DONE
;

4924 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

4928 
sh_cmd_·r™y_š™
:

4929 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
));

4930 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4931 
	`shªnÚ_li¡_d–
(&
»q
->
li¡
);

4932 
	`ä“_»q
(
»q
);

4933 
sdev
->
·r™y_š™_dÚe
[
cmd
->
h—d
 & 
HEAD_INDEX_MASK
] = 1;

4934 
	`shªnÚ_wake_up
(&
sdev
->
·r™y_š™_dÚe_ev’t
[
cmd
->
h—d
 & 
HEAD_INDEX_MASK
]);

4936 
sh_cmd_·r™y
:

4937 
logiÿl_lun
 = 
phy_lun_to_logiÿl_lun
[
sdev
->
mbr
.
lun_m­_mode
](sdev, 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
));

4938 
sb
 = 
sdev
->
sbs
 + 
	`g‘_cmd_µa
(sdev, &
cmd
->
dwÜd1
)/(sdev->
·ges_š_eblock
 * sdev->
¶ªes
);

4939 
group
 = &
sb
->
sub_group
[
logiÿl_lun
/
sdev
->
max_luns_š_group
];

4940 
	`BUG_ON
(
	`g‘_cmd_phy_lun
(
sdev
, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
è!ğsdev->
lun
[
	`g‘_·r™y_lun
(
group
)]->
phy_lun_num
);

4941 #ifdeà
CONFIG_SHANNON_FLASH_ERR_VERIFY


4942 ià(
	`is_çke_wr_bad_luÅ·
(
sdev
, 
	`g‘_·r™y_lun
(
group
), 
	`g‘_cmd_µa
(sdev, &
cmd
->
dwÜd1
))) {

4943 
	`debugs1
("### Trap in fake…arity write bad†unppa:†un=%d blk=%d…age=%d\n",

4944 
	`g‘_·r™y_lun
(
group
), 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
è/ sdev->
·ges_š_eblock
, get_cmd_ppa(sdev, &cmd->dword1) % sdev->pages_in_eblock);

4945 
¡©us
 = 0xEF;

4948 ià((
sdev
->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
è&& 
	`check_¡©us
(
¡©us
)) {

4949 
¶ªe
 = (
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
)/sdev->
·ges_š_eblock
è% sdev->
¶ªes
;

4950 ià(!
	`is_”rÜ_lun
(
sdev
, 
sb
, 
	`g‘_·r™y_lun
(
group
), 
¶ªe
)) {

4951 
	`shªnÚ_log
("%s: mark…arity-write block:†un=%d,…hy_lun=%d, sb_index=%d,…pa=%d, cq_tail=0x%x, cq_tail_tmp=0x%x, status=0x%x.\n",

4952 
sdev
->
sdisk
.
disk_Çme
, 
	`g‘_·r™y_lun
(
group
), 
	`g‘_cmd_phy_lun
(sdev, 
lun£t
->
šdex
, &
cmd
->
dwÜd1
), 
sb
->
sb_šdex
,

4953 
	`g‘_cmd_µa
(
sdev
, &
cmd
->
dwÜd1
), 
lun£t
->
cq_
,†un£t->
cq__tmp
, 
¡©us
);

4954 
	`sb_m¬k_”rÜ_lun
(
sdev
, 
sb
, 
	`g‘_·r™y_lun
(
group
), 
¶ªe
);

4956 
	`hªdË_wr™e_”rÜ
(
sdev
, 
sb
, 
NULL
);

4958 
	`BUG_ON
(
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
));

4959 !
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

4960 
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

4961 
	`shªnÚ_li¡_d–
(&
»q
->
li¡
);

4962 
	`ä“_»q
(
»q
);

4965 
sh_cmd_»g_wr™e
:

4967 
sh_cmd_»g_»ad
:

4970 
	`shªnÚ_”r
("uÄecognized commªd code. 0x%x!\n", 
cmd
->
İcode
);

4972 
šfo
->
Ï¡_aùive_time
 = 0;

4973 
cmd_Ën
 = 
šfo
->cmd_len;

4974 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


4976 ià(
	`lik–y
(!
»ad_cq_h—d
)) {

4981 ià(
	`check_comp_queue
(
cmd
)) {

4982 ià((
lun£t
->
cq__tmp
 + 
cmd_Ën
è<ğ
QUEUE_SIZE
) {

4983 
	`shªnÚ_mem£t
(
cmd
, 0x“, 
cmd_Ën
);

4985 
	`shªnÚ_mem£t
(
cmd
, 0x“, 
QUEUE_SIZE
 - 
lun£t
->
cq__tmp
);

4986 
	`shªnÚ_mem£t
(
lun£t
->
sq_addr
, 0x“,†un£t->
cq__tmp
 + 
cmd_Ën
 - 
QUEUE_SIZE
);

4990 ià((
lun£t
->
cq_
 + 
cmd_Ën
è<ğ
QUEUE_SIZE
) {

4991 
	`shªnÚ_mem£t
(
cmd
, 0x“, 
cmd_Ën
);

4993 
	`shªnÚ_mem£t
(
cmd
, 0x“, 
QUEUE_SIZE
 - 
lun£t
->
cq_
);

4994 
	`shªnÚ_mem£t
(
lun£t
->
sq_addr
, 0x“,†un£t->
cq_
 + 
cmd_Ën
 - 
QUEUE_SIZE
);

4999 ià(
	`lik–y
(!
»ad_cq_h—d
)) {

5000 
lun£t
->
cq__tmp
 = (lun£t->cq__tm°+ 
cmd_Ën
)%
QUEUE_SIZE
;

5001 ià(
	`check_comp_queue
(
cmd
))

5002 
lun£t
->
cq_
 =†un£t->
cq__tmp
;

5004 
lun£t
->
cq_
 = (lun£t->cq_ + 
cmd_Ën
)%
QUEUE_SIZE
;

5006 
lun£t
->
cq__tmp
 =†un£t->
cq_
;

5008 
	`shªnÚ_b¬r›r
();

5009 ià(
	`shªnÚ_wa™queue_aùive
(&
lun£t
->
wa™_cmd_pos
))

5010 
	`shªnÚ_wake_up
(&
lun£t
->
wa™_cmd_pos
);

5011 ià(!
has_´og»ss
)

5012 
has_´og»ss
 = 1;

5015 ià(
	`lik–y
(
»ad_cq_h—d
 == 0)) {

5017 
lun£t
->
cq_h—d
 =†un£t->
cq_
;

5019 ià(
lun£t
->
cq_
 =ğlun£t->
sq_h—d
) {

5020 
	`shªnÚ_¥š_lock_bh
(&
lun£t
->
lun_b¬_lock
);

5021 ià(
lun£t
->
cq_
 =ğlun£t->
sq_h—d
)

5022 
	`shªnÚ_ş—r_b™
(
lun£t
->
šdex
, 
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
);

5023 
	`shªnÚ_¥š_uÆock_bh
(&
lun£t
->
lun_b¬_lock
);

5026 ià(
has_´og»ss
)

5027 
lun£t
->
hªg
 = 0;

5029 
EXIT
:

5030 
	`BUG_ON
(
š_wq
 ^ (!!
	`shªnÚ_©omic_»ad
(&
lun£t
->in_wq)));

5031 ià(
š_wq
)

5032 
	`shªnÚ_©omic_dec
(&
lun£t
->
š_wq
);

5033 
	}
}

5036 
	$hªdË_lun£t
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_lun£t
 *
lun£t
, 
š_wq
)

5038 
	`__hªdË_lun£t
(
sdev
, 
lun£t
, 
š_wq
, 0);

5039 
	}
}

5041 
	$hªdË_lun£t_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

5043 
shªnÚ_lun£t
 *
lun£t
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_lun£t, 
comp_wÜk
);

5044 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

5045 
	`hªdË_lun£t
(
sdev
, 
lun£t
, 1);

5046 
	`shªnÚ_cÚd_»sched
();

5047 
	}
}

5049 
	$»ad_bufq_š‹¼u±_veùÜ
(
shªnÚ_dev
 *
sdev
)

5051 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

5053 
	`¥š_lock_bh
(&
emu_št_lock
);

5054 
sdev
->
š‹¼u±_veù
[0] = 
emu_š‹¼u±_veùÜ
;

5055 
emu_š‹¼u±_veùÜ
 = 0;

5056 
	`¥š_uÆock_bh
(&
emu_št_lock
);

5058 
šdex
 = 
sdev
->
šŒ_big_shiá
[
HOT_INDEX
]/32;

5060 
sdev
->
u32_veùÜs
[
šdex
] |ğ
	`»ad_¿w_»g_§ã
(sdev, &sdev->
š‹¼u±_b¬
[index]);

5062 
	}
}

5064 
u64
 
	gu64_to_u32_mask
[2] = {0x00000000FFFFFFFFul, 0xFFFFFFFF00000000ul};

5065 
	$»ad_Ùh”_š‹¼u±_veùÜ
(
shªnÚ_dev
 *
sdev
)

5067 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

5068 
i
, 
šdex
 = 
sdev
->
šŒ_big_shiá
[
HOT_INDEX
]/32;

5070 
i
 = 0; i <ğ
sdev
->
bufq_ack_šŒ_shiá
/32; i++) {

5071 ià(
i
 !ğ
šdex
) {

5073 ià((
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
[
i
/2] & 
u64_to_u32_mask
[i%2]è|| (sdev->
pŞl
[0] < 
shªnÚ_pŞl_times
))

5074 
sdev
->
u32_veùÜs
[
i
] |ğ
	`»ad_¿w_»g_§ã
(sdev, &sdev->
š‹¼u±_b¬
[i]);

5078 
	}
}

5080 
	$shªnÚ_š‹¼u±_weight
(
shªnÚ_dev
 *
sdev
)

5082  
	`shªnÚ_hweight_lÚg
(
sdev
->
š‹¼u±_veù
[0]) + \

5083 
	`shªnÚ_hweight_lÚg
(
sdev
->
š‹¼u±_veù
[1]) + \

5084 
	`shªnÚ_hweight_lÚg
(
sdev
->
š‹¼u±_veù
[2]) + \

5085 
	`shªnÚ_hweight_lÚg
(
sdev
->
š‹¼u±_veù
[3]);

5087 
	}
}

5089 
	$shªnÚ_no_š‹¼u±
(
shªnÚ_dev
 *
sdev
)

5091 ià(
sdev
->
š‹¼u±_veù
[0] || sdev->interrupt_vect[1] || sdev->interrupt_vect[2] || sdev->interrupt_vect[3])

5095 
	}
}

5097 
	$shªnÚ_ş—r_š‹¼u±
(
shªnÚ_dev
 *
sdev
)

5099 
sdev
->
š‹¼u±_veù
[0] = 0;

5100 
sdev
->
š‹¼u±_veù
[1] = 0;

5101 
sdev
->
š‹¼u±_veù
[2] = 0;

5102 
sdev
->
š‹¼u±_veù
[3] = 0;

5103 
	}
}

5105 
	$shªnÚ_š_œq
(
shªnÚ_dev
 *
sdev
)

5107 
i
;

5109 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

5110 ià(
sdev
->
š_œq
[
i
])

5114 
	}
}

5116 
	$shªnÚ_pŞlšg
(
shªnÚ_dev
 *
sdev
)

5118 
i
;

5120 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

5121 ià(
sdev
->
pŞl
[
i
])

5125 
	}
}

5127 
	$wr™e_š‹¼u±_veùÜ
(
shªnÚ_dev
 *
sdev
, 
dwÜd_šdex
)

5129 ià(
dwÜd_šdex
 < 0)

5130 
dwÜd_šdex
 = 0;

5131 
sdev
->
š_œq
[
dwÜd_šdex
] = 0;

5132 
	`shªnÚ_b¬r›r
();

5133 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

5134 
	`wr™e_»g_§ã
(
sdev
, 0, &sdev->
š‹¼u±_b¬
[
dwÜd_šdex
]);

5136 
	`¥š_lock_bh
(&
emu_št_lock
);

5137 
emu_di§bË_œq
 = 0;

5138 ià(
emu_š‹¼u±_veùÜ
) {

5139 
emu_di§bË_œq
 = 1;

5140 
	`shªnÚ_skËt_scheduË
(&
sdev
->
comp_skËt
);

5142 
	`¥š_uÆock_bh
(&
emu_št_lock
);

5144 
	}
}

5146 #undeà
SHANNON_COMPLETION_REPOLL_IN_TASKLET


5149 
	$com¶‘iÚ_pŞl
(
shªnÚ_dev
 *
dev
)

5151 
i
, 
b™s
, 
»t
 = 0;

5153 
	`»ad_bufq_š‹¼u±_veùÜ
(
dev
);

5154 ià(
	`uÆik–y
(
dev
->
¶ug_out
 || (dev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)))

5157 ià((
dev
->
š™_dÚe
 >ğ
STAGE9_DONE
è&& 
	`shªnÚ_‹¡_ªd_ş—r_b™_Ë
(dev->
£u_šŒ_shiá
, dev->
š‹¼u±_veù
)) {

5158 
u32
 
£u
 = 
	`»ad_»g_§ã
(
dev
, (u32 *)dev->
b¬
 + 
SH_SEU_OFFSET
);

5159 ià(
£u
 == 0)

5160 
	`shªnÚ_w¬n
("%s:£u i mi¤•Ü‹d!.\n", 
dev
->
sdisk
.
disk_Çme
);

5162 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_wq
, &dev->
»cÚfig_wÜk
);

5165 #ifdeà
SHANNON_USE_WRITE_BUFFER


5166 
i
 = 0; i < 
dev
->
h—d_couÁ
; i++) {

5167 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
dev
->
šŒ_big_shiá
[
i
], dev->
š‹¼u±_veù
)) {

5168 
	`hªdË_bufq
(
dev
, 
i
);

5169 
»t
++;

5172 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™_Ë
(
dev
->
bufq_ack_šŒ_shiá
, dev->
š‹¼u±_veù
)) {

5173 
	`hªdË_bufq_ack_š‹¼u±
(
dev
);

5174 
»t
++;

5178 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
dev
);

5179 ià(
	`uÆik–y
(
dev
->
¶ug_out
))

5182 ià(
	`shªnÚ_no_š‹¼u±
(
dev
))

5183  
»t
;

5184 #ifdeà
SHANNON_USE_WRITE_BUFFER


5186 
	`upd©e_bufq_lim™
(
dev
);

5189 
b™s
 = 
	`shªnÚ_š‹¼u±_weight
(
dev
);

5190 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

5191 ià(
	`shªnÚ_‹¡_b™_Ë
(
dev
->
lun£ts
[
i
].
šdex
, dev->
š‹¼u±_veù
)) {

5192 #ifdeà
SHANNON_COMPLETION_REPOLL_IN_TASKLET


5193 
	`hªdË_lun£t
(
dev
, dev->
lun£ts
 + 
i
, 0);

5195 ià(!
	`shªnÚ_š_soáœq
(è&& (
b™s
 <ğ1è&& (
	`shªnÚ_©omic_»ad
(&
dev
->
lun£ts
[
i
].
š_wq
) == 0))

5196 
	`hªdË_lun£t
(
dev
, dev->
lun£ts
 + 
i
, 0);

5198 
	`shªnÚ_©omic_šc
(&
dev
->
lun£ts
[
i
].
š_wq
);

5199 ià(
	`shªnÚ_queue_wÜk
(
dev
->
hªdË_lun_wq
[
i
 % dev->
shªnÚ_Ä_wq
], &dev->
lun£ts
[i].
comp_wÜk
) == 0)

5200 
	`shªnÚ_©omic_dec
(&
dev
->
lun£ts
[
i
].
š_wq
);

5203 
b™s
--;

5207 
	`shªnÚ_ş—r_š‹¼u±
(
dev
);

5210 
	}
}

5212 
	$hªdË_com¶‘iÚ_skËt_g4
(
shªnÚ_š‹¼u±_¬g
 *
š‹r_¬g
)

5214 
shªnÚ_dev
 *
dev
 = 
š‹r_¬g
->
sdev
;

5215 
dwÜd_šdex
 = 0;

5217 #ifdeà
SHANNON_COMPLETION_REPOLL_IN_TASKLET


5218 
	`com¶‘iÚ_pŞl
(
dev
));

5220 
	`wr™e_š‹¼u±_veùÜ
(
dev
, 
dwÜd_šdex
);

5222 
pŞl_»t
;

5223 
dev
->
pŞl
[
dwÜd_šdex
] = 
shªnÚ_pŞl_times
;

5224 
pŞl_»t
 = 
	`com¶‘iÚ_pŞl
(
dev
);

5225 ià(
	`uÆik–y
(
dev
->
¶ug_out
)) {

5226 
dev
->
pŞl
[
dwÜd_šdex
] = 0;

5227 
dev
->
š_œq
[
dwÜd_šdex
] = 0;

5228 
	`shªnÚ_b¬r›r
();

5232 ià(
	`lik–y
(
pŞl_»t
)) {

5233 ià(!
shªnÚ_u£_¹_comp_th»ad
)

5234 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_comp_wq
, &
š‹r_¬g
->
»pŞl_wÜk
);

5236 
	`shªnÚ_¹_queue_wÜk
(
dev
->
shªnÚ_¹_comp_wq
, &
š‹r_¬g
->
¹_»pŞl_wÜk
);

5239 
dev
->
pŞl
[
dwÜd_šdex
] = 0;

5240 
	`wr™e_š‹¼u±_veùÜ
(
dev
, 
dwÜd_šdex
);

5243 
	}
}

5245 
	$shªnÚ_¹_»pŞl_sk
(
shªnÚ_¹_wÜk_¡ruù
 *
¹wÜk
)

5247 
shªnÚ_š‹¼u±_¬g
 *
š‹r_¬g
 = 
	`cÚš”_of
(
¹wÜk
, shªnÚ_š‹¼u±_¬g, 
¹_»pŞl_wÜk
);

5248 
shªnÚ_dev
 *
dev
 = 
š‹r_¬g
->
sdev
;

5249 
¡©us
, 
dwÜd_šdex
 = 
š‹r_¬g
->dword_index < 0 ? 0 : inter_arg->dword_index;

5251 ià(
	`shªnÚ_dev_is_g5
(
dev
))

5252 
¡©us
 = 
	`com¶‘iÚ_pŞl_g5
(
dev
, 
dwÜd_šdex
);

5254 
¡©us
 = 
	`com¶‘iÚ_pŞl
(
dev
);

5256 ià(
¡©us
 > 0)

5257 
dev
->
pŞl
[
dwÜd_šdex
] = 
shªnÚ_pŞl_times
;

5259 
dev
->
pŞl
[
dwÜd_šdex
]--;

5261 ià(
	`uÆik–y
(
dev
->
¶ug_out
)) {

5262 
dev
->
pŞl
[
dwÜd_šdex
] = 0;

5263 
dev
->
š_œq
[
dwÜd_šdex
] = 0;

5264 
	`shªnÚ_b¬r›r
();

5268 ià(
dev
->
pŞl
[
dwÜd_šdex
]) {

5269 
	`shªnÚ_¹_queue_wÜk
(
dev
->
shªnÚ_¹_comp_wq
, &
š‹r_¬g
->
¹_»pŞl_wÜk
);

5270 
	`shªnÚ_scheduË
();

5275 
	`wr™e_š‹¼u±_veùÜ
(
dev
, 
dwÜd_šdex
);

5276 
	}
}

5278 
	$shªnÚ_»pŞl_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

5280 
shªnÚ_š‹¼u±_¬g
 *
š‹r_¬g
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_š‹¼u±_¬g, 
»pŞl_wÜk
);

5281 
shªnÚ_dev
 *
dev
 = 
š‹r_¬g
->
sdev
;

5282 
¡©us
, 
dwÜd_šdex
 = 
š‹r_¬g
->dword_index < 0 ? 0 : inter_arg->dword_index;

5284 ià(
	`shªnÚ_dev_is_g5
(
dev
))

5285 
¡©us
 = 
	`com¶‘iÚ_pŞl_g5
(
dev
, 
dwÜd_šdex
);

5287 
¡©us
 = 
	`com¶‘iÚ_pŞl
(
dev
);

5289 ià(
¡©us
 > 0)

5290 
dev
->
pŞl
[
dwÜd_šdex
] = 
shªnÚ_pŞl_times
;

5292 
dev
->
pŞl
[
dwÜd_šdex
]--;

5294 ià(
	`uÆik–y
(
dev
->
¶ug_out
)) {

5295 
dev
->
pŞl
[
dwÜd_šdex
] = 0;

5296 
dev
->
š_œq
[
dwÜd_šdex
] = 0;

5297 
	`shªnÚ_b¬r›r
();

5301 ià(
dev
->
pŞl
[
dwÜd_šdex
]) {

5302 
	`shªnÚ_queue_wÜk
(
dev
->
shªnÚ_comp_wq
, &
š‹r_¬g
->
»pŞl_wÜk
);

5303 
	`shªnÚ_scheduË
();

5308 
	`wr™e_š‹¼u±_veùÜ
(
dev
, 
dwÜd_šdex
);

5309 
	}
}

5311 
	$com¶‘iÚ_skËt
(
d©a
)

5313 
shªnÚ_š‹¼u±_¬g
 *
š‹r_¬g
 = (shªnÚ_š‹¼u±_¬g*)
d©a
;

5315 ià(
	`shªnÚ_dev_is_g5
(
š‹r_¬g
->
sdev
))

5316 
	`hªdË_com¶‘iÚ_skËt_g5
(
š‹r_¬g
);

5318 
	`hªdË_com¶‘iÚ_skËt_g4
(
š‹r_¬g
);

5319 
	}
}

5321 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

5322 
	~"shªnÚ_åga_emu.c
"

5325 
	$shªnÚ_š‹¼u±
(
œq
, *
d©a
)

5327 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
d©a
;

5328 
’Œy
;

5330 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

5331 
’Œy
 = 
	`shªnÚ_pci_g‘_msix_’Œy
(
sdev
->
msix_d©a
, 
œq
, 
MAX_MSIX_INTERRUPTS
);

5332 ià(
’Œy
 =ğ
MAX_MSIX_INTERRUPTS
)

5333  
SHANNON_IRQ_HANDLED
;

5335 
’Œy
 = 0;

5337 ià(
	`uÆik–y
((
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_RECONFIG


5338 || (
sdev
->
¡©e
 & 
SHN_STATE_MASK
è=ğ
SHN_STATE_RESET
))

5339  
SHANNON_IRQ_HANDLED
;

5340 ià(
sdev
->
š_œq
[
’Œy
] == 1) {

5342  
SHANNON_IRQ_HANDLED
;

5344 
sdev
->
š_œq
[
’Œy
] = 1;

5345 
	`shªnÚ_skËt_scheduË
(&
sdev
->
comp_skËt
[
’Œy
]);

5346  
SHANNON_IRQ_HANDLED
;

5347 
	}
}

5349 #ià
defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

5350 
u32
 
	$»ad32
(
u32
 *
addr
)

5352  *
addr
;

5353 
	}
}

5355 
	$wr™e32
(
u32
 
v®ue
, u32 *
addr
)

5357 *
addr
 = 
v®ue
;

5358 
	}
}

5360 
u32
 
	$»ad32
(cÚ¡ vŞ©
__iomem
 *
addr
)

5362  
	`shªnÚ_»adl
(
addr
);

5363 
	}
}

5365 
	$wr™e32
(
u32
 
v®ue
, vŞ©
__iomem
 *
addr
)

5367 
	`shªnÚ_wr™–
(
v®ue
, 
addr
);

5368 
	}
}

5371 
	$»vi£_mbr_fÜ_com·tib™y
(
shªnÚ_mbr
 *
mbr
)

5373 
i
;

5375 
i
 = 0; i < 
BAD_LUN_MAP_ARRAY_SIZE
; i++) {

5376 ià(
mbr
->
bad_phy_lun_m­
[
i
] != ~0)

5379 ià(
i
 =ğ
BAD_LUN_MAP_ARRAY_SIZE
) {

5380 
i
 = 0; i < 
BAD_LUN_MAP_ARRAY_SIZE
; i++)

5381 
mbr
->
bad_phy_lun_m­
[
i
] = 0;

5384 
	`shªnÚ_mem£t
(
mbr
->
»£rved
, 0, 
	`ARRAY_SIZE
(mbr->reserved));

5385 ià(
shªnÚ_high_³rfÜmªû
) {

5386 
	`shªnÚ_šfo
("interrupt_delay=0x%x, dma_max_read_limit=0x%x, clk=0x%x, max_outstanding_bios=0x%x.\n",

5387 
mbr
->
š‹¼u±_d–ay
, mbr->
dma_max_»ad_lim™
,

5388 
mbr
->
şk
, mbr->
max_out¡ªdšg_bios
);

5389 
mbr
->
š‹¼u±_d–ay
 = 1;

5390 
mbr
->
dma_max_»ad_lim™
 = 0;

5391 
mbr
->
şk
 = 0;

5392 
mbr
->
max_out¡ªdšg_bios
 = 0;

5395 ià(
mbr
->
mbr_upd©e
 == 0xffffffff)

5396 
mbr
->
mbr_upd©e
 = 0;

5397 
	}
}

5399 
	$cİy_mbr_to_memÜy
(
shªnÚ_mbr
 *
to
, shªnÚ_mb¸*
äom
)

5401 
i
;

5403 
	`shªnÚ_memıy
(
to
->
id
, 
äom
->id, 
MBR_ID_SIZE
);

5404 
to
->
mbr_fÜm©_v”siÚ
 = 
	`shªnÚ_mem_»adq
(&
äom
->mbr_format_version);

5405 
to
->
h¬dw¬e_v”siÚ
 = 
	`shªnÚ_mem_»adq
(&
äom
->hardware_version);

5406 
to
->
soáw¬e_v”siÚ
 = 
	`shªnÚ_mem_»adq
(&
äom
->software_version);

5407 
to
->
Çnd_mªuçùu»
 = 
	`shªnÚ_mem_»adq
(&
äom
->nand_manufacture);

5408 
to
->
Çnd_id
 = 
	`shªnÚ_mem_»adq
(&
äom
->nand_id);

5409 
to
->
ÿ·c™y
 = 
	`shªnÚ_mem_»adq
(&
äom
->capacity);

5411 
to
->
lun_amouÁ
 = 
	`shªnÚ_mem_»adl
(&
äom
->lun_amount);

5412 
to
->
eblocks_š_lun
 = 
	`shªnÚ_mem_»adl
(&
äom
->eblocks_in_lun);

5413 
to
->
·ges_š_eblock
 = 
	`shªnÚ_mem_»adl
(&
äom
->pages_in_eblock);

5414 
to
->
Çnd_·ge_shiá
 = 
	`shªnÚ_mem_»adl
(&
äom
->nand_page_shift);

5415 
to
->
oob_size
 = 
	`shªnÚ_mem_»adl
(&
äom
->oob_size);

5416 
to
->
logicb_shiá
 = 
	`shªnÚ_mem_»adl
(&
äom
->logicb_shift);

5417 
to
->
¶ªe_Üd”
 = 
	`shªnÚ_mem_»adl
(&
äom
->plane_order);

5418 
to
->
cfg_chªÃls
 = 
	`shªnÚ_mem_»adl
(&
äom
->cfg_channels);

5419 
to
->
cfg_lun£t_š_chªÃl
 = 
	`shªnÚ_mem_»adl
(&
äom
->cfg_lunset_in_channel);

5420 
to
->
cfg_lun_š_lun£t
 = 
	`shªnÚ_mem_»adl
(&
äom
->cfg_lun_in_lunset);

5422 
to
->
š™_hÙ_sblk
 = 
	`shªnÚ_mem_»adl
(&
äom
->init_hot_sblk);

5423 
to
->
š™_cŞd_sblk
 = 
	`shªnÚ_mem_»adl
(&
äom
->init_cold_sblk);

5425 
to
->
š‹¼u±_d–ay
 = 
	`shªnÚ_mem_»adw
(&
äom
->interrupt_delay);

5426 
to
->
ecc_codewÜds_š_logicb
 = 
äom
->ecc_codewords_in_logicb;

5427 
to
->
ecc_cÜ»ùiÚ_pow”
 = 
äom
->ecc_correction_power;

5428 
to
->
hi¡Üy_”a£_couÁ
 = 
	`shªnÚ_mem_»adl
(&
äom
->history_erase_count);

5430 
to
->
pow”_cyşe_couÁ
 = 
	`shªnÚ_mem_»adq
(&
äom
->power_cycle_count);

5431 
to
->
pow”_Ú_£cÚds
 = 
	`shªnÚ_mem_»adq
(&
äom
->power_on_seconds);

5432 
to
->
ho¡_wr™e_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
äom
->host_write_sectors);

5433 
to
->
tÙ®_wr™e_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
äom
->total_write_sectors);

5434 
to
->
ho¡_»ad_£ùÜs
 = 
	`shªnÚ_mem_»adq
(&
äom
->host_read_sectors);

5436 
to
->
æash_drvmode
 = 
	`shªnÚ_mem_»adl
(&
äom
->flash_drvmode);

5437 
to
->
luns_³r_û_mask
 = 
äom
->luns_per_ce_mask;

5438 
to
->
lun_m­_mode
 = 
äom
->lun_map_mode;

5439 
to
->
¿id_¡res
 = 
	`shªnÚ_mem_»adw
(&
äom
->raid_stripes);

5441 
i
 = 0; i < 
BAD_LUN_MAP_ARRAY_SIZE
; i++)

5442 
to
->
bad_phy_lun_m­
[
i
] = 
	`shªnÚ_mem_»adq
(&
äom
->bad_phy_lun_map[i]);

5443 
to
->
max_·ges_š_eblock
 = 
	`shªnÚ_mem_»adl
(&
äom
->max_pages_in_eblock);

5444 
to
->
u£r_logicb_shiá
 = 
	`shªnÚ_mem_»adl
(&
äom
->user_logicb_shift);

5446 
to
->
ã©u»_æags
 = 
	`shªnÚ_mem_»adq
(&
äom
->feature_flags);

5447 
to
->
pow”_budg‘
 = 
äom
->power_budget;

5448 
to
->
dma_max_»ad_lim™
 = 
äom
->dma_max_read_limit;

5449 
to
->
şk
 = 
	`shªnÚ_mem_»adw
(&
äom
->clk);

5450 
to
->
max_out¡ªdšg_bios
 = 
	`shªnÚ_mem_»adl
(&
äom
->max_outstanding_bios);

5452 
to
->
mbr_upd©e
 = 
	`shªnÚ_mem_»adl
(&
äom
->mbr_update);

5454 
to
->
‹mp_th»shŞd1
 = 
äom
->temp_threshold1;

5455 
to
->
‹mp_ü™iÿl_th»shŞd1
 = 
äom
->temp_critical_threshold1;

5456 
to
->
‹mp_th»shŞd2
 = 
äom
->temp_threshold2;

5457 
to
->
‹mp_ü™iÿl_th»shŞd2
 = 
äom
->temp_critical_threshold2;

5459 
to
->
poŞ_w©”m¬k
 = 
	`shªnÚ_mem_»adq
(&
äom
->pool_watermark);

5460 
to
->
sdev_couÁ
 = 
	`shªnÚ_mem_»adw
(&
äom
->sdev_count);

5461 
to
->
sdev_id
 = 
	`shªnÚ_mem_»adw
(&
äom
->sdev_id);

5463 
to
->
sh¬ed_·ges
 = 
	`shªnÚ_mem_»adw
(&
äom
->shared_pages);

5464 
to
->
p£udo_¶ªe
 = 
äom
->pseudo_plane;

5465 
to
->
¶ªe_couÁ
 = 
äom
->plane_count;

5466 
to
->
³riod_»ad_³riod
 = 
	`shªnÚ_mem_»adl
(&
äom
->period_read_period);

5467 
to
->
³riod_»ad_µa
 = 
	`shªnÚ_mem_»adl
(&
äom
->period_read_ppa);

5468 
to
->
dummy_wÜdlše
 = 
	`shªnÚ_mem_»adl
(&
äom
->dummy_wordline);

5469 
to
->
max_k“p_”a£d_hours
 = 
	`shªnÚ_mem_»adw
(&
äom
->max_keep_erased_hours);

5470 
to
->
»ad_»Œy
 = 
	`shªnÚ_mem_»adw
(&
äom
->read_retry);

5471 
to
->
ecc_çu»_¿‹_th»shŞd
 = 
	`shªnÚ_mem_»adw
(&
äom
->ecc_failure_rate_threshold);

5472 
to
->
max_wr™e_bw
 = 
	`shªnÚ_mem_»adw
(&
äom
->max_write_bw);

5473 
to
->
d©a_»‹ÁiÚ_š‹rv®
 = 
	`shªnÚ_mem_»adw
(&
äom
->data_retention_interval);

5474 
to
->
ıs_v”siÚ
 = 
	`shªnÚ_mem_»adw
(&
äom
->cps_version);

5475 
to
->
³_cyşe
 = 
	`shªnÚ_mem_»adw
(&
äom
->pe_cycle);

5477 
to
->
ov”Ïp_sblk
 = 
	`shªnÚ_mem_»adl
(&
äom
->overlap_sblk);

5478 
	}
}

5480 
	$g‘_lun_commÚ_šfo
(
shªnÚ_dev
 *
dev
, 
shªnÚ_mbr
 *
mbr
, 
lun£t_šdex
)

5482 
shªnÚ_lun£t
 *
lun£t
;

5483 
shªnÚ_cmd
 *
´e_»ad
, *
»ad
, *
no_İ
;

5484 
cmdid
;

5485 *
buf
;

5486 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

5487 
shªnÚ_dma_addr_t
 
dma_buf
;

5489 
u8
 
ecc
;

5490 
u64
 
m‘ad©a
, *
±e
;

5491 
loİ
, 
»t
 = -1, 
»Œ›s
 = 0;

5493 
lun£t
 = &
dev
->
lun£ts
[
lun£t_šdex
];

5495 
buf
 = 
	`shªnÚ_kz®loc
(4096, 
GFP_SHANNON
);

5496 ià(
buf
 =ğ
NULL
) {

5497 
	`shªnÚ_”r
("Allocate memory failed!\n");

5498  -
ENOMEM
;

5500 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

5501 
dma_buf
 = 
	`shªnÚ_dma_m­_sšgË
(
dev
->
pci_dev
, 
buf
, 4096, 
SHANNON_DMA_FROMDEVICE
);

5504 
»Œy
:

5507 
lun£t
->
cq_
 =†un£t->
cq_h—d
;

5508 
lun£t
->
cq__tmp
 =†un£t->
cq_h—d
;

5510 
cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

5511 
´e_»ad
 = (
shªnÚ_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

5512 
´e_»ad
->
İcode
 = 
sh_cmd_´e_»ad
;

5513 
´e_»ad
->
logicbs
 = 0;

5514 
´e_»ad
->
h—d
 = 0;

5515 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
dev
, 0, 
lun£t_šdex
 * dev->
max_lun_š_lun£t
), &
´e_»ad
->
dwÜd1
);

5516 
lun£t
->
sq_h—d
 += 8;

5518 
»ad
 = 
	`cmd_queue_šc
(
´e_»ad
, 1);

5519 ià(
»Œ›s
 && (
dev
->
advªûd_»ad_¡©e
 & 
ADV_READ_SUPPORT_MASK
))

5520 
»ad
->
İcode
 = 
sh_cmd_advªûd_»ad
;

5522 
»ad
->
İcode
 = 
sh_cmd_»ad
;

5523 
»ad
->
logicbs
 = 0;

5524 
»ad
->
fœ¡_logicb
 = 0;

5525 
»ad
->
h—d
 = 0;

5526 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
dev
, 
	`g‘_cmd_µa
(dev, &
´e_»ad
->
dwÜd1
), 
lun£t_šdex
 * dev->
max_lun_š_lun£t
), &
»ad
->dword1);

5528 
±e
 = 
	`cmd_queue_šc
(
»ad
, 1);

5529 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

5530 *
±e
 = ()
buf
;

5532 
	`shªnÚ_mem_wr™eq
(
dma_buf
, 
±e
);

5534 
lun£t
->
sq_h—d
 += 16;

5536 ià(
»Œ›s
 && (
dev
->
advªûd_»ad_¡©e
 & 
ADV_READ_SUPPORT_MASK
)) {

5537 
no_İ
 = 
	`cmd_queue_šc
(
»ad
, 2);

5538 
no_İ
->
İcode
 = 
sh_cmd_no_İ
;

5539 
no_İ
->
h—d
 = 0;

5540 
	`shªnÚ_mem_wr™–
(
	`make_cmd_dwÜd1
(
dev
, 0, 
lun£t_šdex
 * dev->
max_lun_š_lun£t
), &
no_İ
->
dwÜd1
);

5541 
lun£t
->
sq_h—d
 += 8;

5544 
	`wr™e_»g_§ã
(
dev
, 
lun£t
->
sq_h—d
, &lun£t->
lun_b¬
->sq_head);

5545 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

5546 
	`shªnÚ_wake_up_´oûss
(
´eš™_emu_th»ad
);

5549 
loİ
 = 0;

5551 
	`shªnÚ_m¦“p
(100);

5552 
lun£t
->
cq_h—d
 = 
	`»ad_»g_§ã
(
dev
, &lun£t->
lun_b¬
->cq_head);

5553 
	`debugs2
("cq_h—d=%x.\n", 
lun£t
->
cq_h—d
);

5554 
loİ
++;

5556 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

5557 
lun£t
->
sq_h—d
 = 
	`»ad_»g_§ã
(
dev
, &lun£t->
lun_b¬
->sq_head);

5558 
	`debugs3
("sq_h—d=%x.\n", 
lun£t
->
sq_h—d
);

5559 
	`debugs3
("¡©us=0x%x.\n", 
	`»ad_»g_§ã
(
dev
, &
lun£t
->
lun_b¬
->
lun_¡©us
));

5560 
	`debugs3
("sq_addr=0x%lx, cq_addr=0x%lx.\n", ()
lun£t
->
sq_addr
, (îun£t->
cq_addr
);

5561 
	`debugs3
("lun_£ùiÚ=0x%lx.\n", ()
lun£t
->
lun_b¬
);

5563 ià((
loİ
 % 100) == 99)

5564 
	`shªnÚ_log
("%s(): sq_head=0x%x, cq_head=0x%x,†un_status=0x%x",

5565 
__func__
, 
lun£t
->
sq_h—d
,†un£t->
cq_h—d
, 
	`»ad_»g_§ã
(
dev
, &lun£t->
lun_b¬
->
lun_¡©us
));

5567 } 
lun£t
->
sq_h—d
 !ğlun£t->
cq_h—d
);

5569 
ecc
 = *(
u8
 *)(
lun£t
->
cq_addr
 + (lun£t->
cq_
 >> 3) + 1);

5570 
m‘ad©a
 = 
	`shªnÚ_mem_»adq
(
lun£t
->
cq_addr
 + (lun£t->
cq_
 >> 3) + 2);

5572 ià((
ecc
 >ğ
SH_FAKE_ERR
è|| (
m‘ad©a
 !ğ
MBR_WATERMARK
)) {

5573 ià(
»Œ›s
) {

5574 
	`debugs1
("ecc=%d, m‘ad©a=0x%Îx.\n", 
ecc
, 
m‘ad©a
);

5575 
out
;

5577 
»Œ›s
++;

5578 
»Œy
;

5581 
»t
 = 0;

5583 
out
:

5584 
lun£t
->
cq_
 =†un£t->
cq_h—d
;

5585 
lun£t
->
cq__tmp
 =†un£t->
cq_h—d
;

5586 
lun£t
->
sq_h—d_tmp
 =†un£t->
sq_h—d
;

5587 
lun£t
->
sq_hw_h—d
 =†un£t->
sq_h—d
;

5588 
lun£t
->
cq_hw_h—d
 =†un£t->
sq_h—d
;

5590 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

5591 
	`shªnÚ_dma_unm­_sšgË
(
dev
->
pci_dev
, 
dma_buf
, 4096, 
SHANNON_DMA_FROMDEVICE
);

5593 
	`shªnÚ_mem£t
(
mbr
, 0, (
shªnÚ_mbr
));

5594 
	`cİy_mbr_to_memÜy
(
mbr
, 
buf
);

5595 
	`»vi£_mbr_fÜ_com·tib™y
(
mbr
);

5597 
	`shªnÚ_kä“
(
buf
);

5598  
»t
;

5599 
	}
}

5601 
	$ª®yze_mbr_šfo
(
shªnÚ_dev
 *
dev
, 
shªnÚ_mbr
 *
mbr
)

5603 
i
;

5605 
	`shªnÚ_memıy
(&
dev
->
mbr
, mbr, (
shªnÚ_mbr
));

5608 
dev
->
sdev_id
 = dev->
mbr
.sdev_id;

5609 
dev
->
sdisk
.
£ùÜs
 = dev->
mbr
.
ÿ·c™y
;

5610 
dev
->
lun_couÁ
 = dev->
mbr
.
lun_amouÁ
;

5611 
dev
->
p£udo_¶ªe
 = dev->
mbr
.pseudo_plane;

5612 ià(
dev
->
mbr
.
¶ªe_couÁ
)

5613 
dev
->
¶ªes
 = dev->
mbr
.
¶ªe_couÁ
;

5615 
dev
->
¶ªes
 = 1 << dev->
mbr
.
¶ªe_Üd”
;

5616 
dev
->
su¥icious_bad_lun_šdiÿtÜ
 = dev->
¶ªes
 * 3;

5617 ià(
dev
->
mbr
.
sh¬ed_·ges
)

5618 
dev
->
sh¬ed_·ges
 = dev->
mbr
.shared_pages;

5619 ià(
dev
->
mbr
.
dummy_wÜdlše
)

5620 
dev
->
dummy_wÜdlše
 = dev->
mbr
.dummy_wordline;

5621 ià(
dev
->
mbr
.
p£udo_¶ªe
)

5622 
dev
->
eblocks_š_lun
 = dev->
mbr
.eblocks_š_luÀ* dev->
¶ªes
;

5624 
dev
->
eblocks_š_lun
 = dev->
mbr
.eblocks_in_lun;

5625 
dev
->
·ges_š_eblock
 = dev->
mbr
.pages_in_eblock;

5626 
dev
->
Çnd_·ge_shiá
 = dev->
mbr
.nand_page_shift;

5627 
dev
->
oob_size
 = dev->
mbr
.oob_size;

5628 
dev
->
logicb_shiá
 = dev->
mbr
.logicb_shift;

5629 
dev
->
max_wr™e_bw
 = 1024*1024ULL * dev->
mbr
.max_write_bw;

5630 ià(
dev
->
u£r_logicb_shiá
 == 0) {

5631 
dev
->
u£r_logicb_shiá
 = dev->
mbr
.user_logicb_shift;

5632 ià((
dev
->
u£r_logicb_shiá
 == 0) || (dev->user_logicb_shift == 0xffffffff)) {

5633 
dev
->
u£r_logicb_shiá
 = dev->
logicb_shiá
;

5634 
dev
->
mbr
.
u£r_logicb_shiá
 = dev->user_logicb_shift;

5635 
dev
->
mbr
.
u£r_logicb_shiá
 = dev->user_logicb_shift;

5638 
dev
->
¶ªe_Üd”
 = dev->
mbr
.plane_order;

5639 ià((
dev
->
mbr
.
š‹¼u±_d–ay
 == 0) || (dev->mbr.interrupt_delay == 0xffff))

5640 
dev
->
š‹¼u±_d–ay
 = 1;

5642 
dev
->
š‹¼u±_d–ay
 = dev->
mbr
.interrupt_delay;

5644 
dev
->
cfg_chªÃls
 = dev->
mbr
.cfg_channels;

5645 
dev
->
cfg_lun£t_š_chªÃl
 = dev->
mbr
.cfg_lunset_in_channel;

5646 
dev
->
cfg_lun_š_lun£t
 = dev->
mbr
.cfg_lun_in_lunset;

5647 
dev
->
v”y_š™Ÿl_sblk
[
HOT_INDEX
] = dev->
mbr
.
š™_hÙ_sblk
;

5648 
dev
->
v”y_š™Ÿl_sblk
[
COLD_INDEX
] = dev->
mbr
.
š™_cŞd_sblk
;

5649 ià((
dev
->
mbr
.
pow”_Ú_£cÚds
 + 1) == 0)

5650 
dev
->
pow”_Ú_£cÚds
 = 0;

5652 
dev
->
pow”_Ú_£cÚds
 = dev->
mbr
.power_on_seconds;

5653 ià((
dev
->
mbr
.
pow”_cyşe_couÁ
 + 1) == 0)

5654 
dev
->
pow”_cyşe_couÁ
 = 0;

5656 
dev
->
pow”_cyşe_couÁ
 = dev->
mbr
.power_cycle_count;

5657 ià((
dev
->
mbr
.
ho¡_wr™e_£ùÜs
 + 1) == 0)

5658 
dev
->
ho¡_wr™e_£ùÜs
 = 0;

5660 
dev
->
ho¡_wr™e_£ùÜs
 = dev->
mbr
.host_write_sectors;

5661 ià((
dev
->
mbr
.
tÙ®_wr™e_£ùÜs
 + 1) == 0)

5662 
dev
->
tÙ®_wr™e_£ùÜs
 = 0;

5664 
dev
->
tÙ®_wr™e_£ùÜs
 = dev->
mbr
.total_write_sectors;

5665 ià((
dev
->
mbr
.
ho¡_»ad_£ùÜs
 + 1) == 0)

5666 
dev
->
ho¡_»ad_£ùÜs_hi¡Üy
 = 0;

5668 
dev
->
ho¡_»ad_£ùÜs_hi¡Üy
 = dev->
mbr
.
ho¡_»ad_£ùÜs
;

5669 
dev
->
·r™y_groups
 = (dev->
mbr
.
¿id_¡res
 == 0)?1:dev->mbr.raid_stripes;

5670 ià(
dev
->
mbr
.
ã©u»_æags
 == ~0)

5671 
dev
->
mbr
.
ã©u»_æags
 = 0;

5672 
dev
->
´iÜ™ize_wr™e
 = dev->
mbr
.
ã©u»_æags
 & 
PRIORITIZE_WRITE
;

5673 
dev
->
©omic_wr™e
 = dev->
mbr
.
ã©u»_æags
 & 
ATOMIC_WRITE
;

5674 
dev
->
lba_fÜm©
 = !!(dev->
mbr
.
ã©u»_æags
 & 
BIG_EPILOG
);

5675 
dev
->
com·ù_•og
 = !!(dev->
mbr
.
ã©u»_æags
 & 
COMPACT_EPILOG
);

5676 
dev
->
¢­_»ad_’abË
 = !!(dev->
mbr
.
ã©u»_æags
 & 
SNAP_READ_ENABLE
);

5677 
dev
->
ov”Ïp_wr™e
 = !!(dev->
mbr
.
ã©u»_æags
 & 
OVERLAP_WRITE
);

5678 
dev
->
ç¡_»ad_’abË
 = !!(dev->
mbr
.
ã©u»_æags
 & 
FAST_READ_ENABLE
);

5680 ià(
dev
->
mbr
.
³riod_»ad_³riod
 != 0)

5681 
dev
->
³riod_»ad
.
³riod
 = dev->
mbr
.
³riod_»ad_³riod
;

5682 ià(
dev
->
mbr
.
³riod_»ad_µa
 < (dev->
·ges_š_eblock
 * dev->
¶ªes
))

5683 
dev
->
³riod_»ad
.
µa
 = dev->
mbr
.
³riod_»ad_µa
;

5685 
dev
->
»Œy_times_Ú_”rÜ
 = ((dev->
mbr
.
»ad_»Œy
 & 
REREAD_NUM_MASK
è> 
REREAD_TIMES_ON_ERROR
) ?

5686 (
dev
->
mbr
.
»ad_»Œy
 & 
REREAD_NUM_MASK
è: 
REREAD_TIMES_ON_ERROR
;

5688 
dev
->
ecc_çu»_¿‹_th»shŞd
 = dev->
mbr
.ecc_failure_rate_threshold ?

5689 
dev
->
mbr
.
ecc_çu»_¿‹_th»shŞd
 : 
ECC_FAILURE_RATE_THRESHOLD
;

5691 
dev
->
d©a_»‹ÁiÚ_š‹rv®
 = dev->
mbr
.data_retention_interval ?

5692 
dev
->
mbr
.
d©a_»‹ÁiÚ_š‹rv®
 : 
DEFAULT_DATA_RETENTION_INTERVAL
;

5694 
dev
->
æash_³_th»shŞd
 = dev->
mbr
.
³_cyşe
 ?

5695 
dev
->
mbr
.
³_cyşe
 : 
FLASH_PE_COUNT_SPEC
;

5697 
	`debugs1
("ÿ·c™y=%Îu.\n", 
dev
->
sdisk
.
£ùÜs
);

5698 
	`debugs1
("lun_couÁ=%d.\n", 
dev
->
lun_couÁ
);

5699 
	`debugs1
("eblocks_š_lun=%d.\n", 
dev
->
eblocks_š_lun
);

5700 
	`debugs1
("·ges_š_eblock=%d.\n", 
dev
->
·ges_š_eblock
);

5701 
	`debugs1
("Çnd_·ge_shiá=%d.\n", 
dev
->
Çnd_·ge_shiá
);

5702 
	`debugs1
("oob_size=%d.\n", 
dev
->
oob_size
);

5703 
	`debugs1
("logicb_shiá=%d.\n", 
dev
->
logicb_shiá
);

5704 
	`debugs1
("u£r_logicb_shiá=%d.\n", 
dev
->
u£r_logicb_shiá
);

5705 
	`debugs1
("¶ªe_Üd”=%d.\n", 
dev
->
¶ªe_Üd”
);

5706 
	`debugs1
("š‹¼u±_d–ay=%d.\n", 
dev
->
š‹¼u±_d–ay
);

5707 
	`debugs1
("cÚfig_chªÃls=%d.\n", 
dev
->
cfg_chªÃls
);

5708 
	`debugs1
("cÚfig_lun£t_š_chªÃl=%d.\n", 
dev
->
cfg_lun£t_š_chªÃl
);

5709 
	`debugs1
("cÚfig_lun_š_lun£t=%d.\n", 
dev
->
cfg_lun_š_lun£t
);

5710 
	`debugs1
("š™_hÙ_sblk=%d.\n", 
dev
->
v”y_š™Ÿl_sblk
[
HOT_INDEX
]);

5711 
	`debugs1
("š™_cŞd_sblk=%d.\n", 
dev
->
v”y_š™Ÿl_sblk
[
COLD_INDEX
]);

5712 
	`debugs1
("max_wr™e_bw=%u\n", 
dev
->
max_wr™e_bw
);

5713 
i
 = 0; i < 
BAD_LUN_MAP_ARRAY_SIZE
; i++)

5714 
	`debugs1
("bad_phy_lun_m­[%d]=0x%Îx\n", 
i
, 
dev
->
mbr
.
bad_phy_lun_m­
[i]);

5715 
	}
}

5717 
	$check_commÚ_šfo
(
shªnÚ_dev
 *
sdev
)

5719 
max_lun_couÁ
;

5721 ià(
sdev
->
mbr
.
mbr_fÜm©_v”siÚ
 > 
CURRENT_MBR_FORMAT_VERSION
) {

5722 
	`shªnÚ_”r
("New hardware is NOT supported,…lease update your driver!\n");

5726 ià((
sdev
->
cfg_chªÃls
 < 1è|| (sdev->cfg_chªÃl > sdev->
max_chªÃls
)) {

5727 
	`shªnÚ_”r
("WrÚg cfg_chªÃls=%d.\n", 
sdev
->
cfg_chªÃls
);

5731 ià((
sdev
->
cfg_lun£t_š_chªÃl
 < 1è|| (sdev->cfg_lun£t_š_chªÃÈ> sdev->
max_lun£t_š_chªÃl
)) {

5732 
	`shªnÚ_”r
("WrÚg cfg_lun£t_š_chªÃl=%d.\n", 
sdev
->
cfg_lun£t_š_chªÃl
);

5736 ià((
sdev
->
cfg_lun_š_lun£t
 < 1è|| (sdev->cfg_lun_š_lun£ˆ> sdev->
max_lun_š_lun£t
)) {

5737 
	`shªnÚ_”r
("WrÚg cfg_lun_š_lun£t=%d.\n", 
sdev
->
cfg_lun_š_lun£t
);

5742 
max_lun_couÁ
 = 
	`mš
(
MAX_LUN_COUNT
, (
sdev
->
cfg_lun_š_lun£t
 * sdev->
cfg_lun£t_š_chªÃl
 * sdev->
cfg_chªÃls
));

5743 ià((
sdev
->
lun_couÁ
 > 
max_lun_couÁ
) || (sdev->lun_count < 4)) {

5744 
	`shªnÚ_”r
("we only support†un count between 4‡nd 512 inhis version.\n");

5749 ià((
sdev
->
sdisk
.
£ùÜs
 > ((
u64
)sdev->
lun_couÁ
 * sdev->
eblocks_š_lun
 * sdev->
·ges_š_eblock
 * sdev->
logicbs_š_·ge
 * (sdev->
logicb_size
 >> 9))) \

5750 || (
sdev
->
sdisk
.
£ùÜs
 == 0) || ((sdev->sdisk.sectors & 0x7) != 0)) {

5751 
	`shªnÚ_”r
("wrÚg disk c­ac™y iÀmbr. c­ac™y=%ld seùÜs.\n", ()
sdev
->
sdisk
.
£ùÜs
);

5755 ià(
sdev
->
mbr
.
lun_m­_mode
 >ğ
MAX_LUN_MAP_MODE
) {

5756 
	`shªnÚ_”r
("WrÚg†un_m­_mode=%u.\n", 
sdev
->
mbr
.
lun_m­_mode
);

5760 ià(
sdev
->
mbr
.
dma_max_»ad_lim™
 != 0xff && sdev->mbr.dma_max_read_limit > 6) {

5761 
	`shªnÚ_”r
("WrÚg dma_max_»ad_lim™=%d.\n", 
sdev
->
mbr
.
dma_max_»ad_lim™
);

5766 
	}
}

5768 
	#READ_MBR_COUNT
 4

	)

5769 
	$g‘_Ï‹¡_mbr
(
shªnÚ_dev
 *
sdev
)

5771 
shªnÚ_mbr
 *
mbrs
;

5772 
i
, 
j
, 
Ï‹¡_šdex
, 
»t
 = -1;

5773 
u32
 
max_upd©e
;

5775 
mbrs
 = 
	`shªnÚ_km®loc
((*mbrsè* 
READ_MBR_COUNT
, 
GFP_SHANNON
);

5776 ià(
mbrs
 =ğ
NULL
) {

5777 
	`shªnÚ_”r
("can‚ot‡llocate memory for„eading mbr.\n");

5778  -
ENOMEM
;

5780 
j
 = 0;

5781 
i
 = 0; i < 
MBR_MAX_TRY
; i++) {

5782 
»t
 = 
	`g‘_lun_commÚ_šfo
(
sdev
, 
mbrs
 + 
j
, 
i
);

5783 ià(
»t
 == 0) {

5784 
j
++;

5785 ià(
j
 =ğ
READ_MBR_COUNT
)

5789 ià(
j
 < 
READ_MBR_COUNT
) {

5790 
	`shªnÚ_šfo
("%s: g‘ %d‡vaabË mb¸šfÜm©iÚ.\n", 
sdev
->
sdisk
.
disk_Çme
, 
j
);

5791 
	`shªnÚ_kä“
(
mbrs
);

5795 
Ï‹¡_šdex
 = 0;

5796 
max_upd©e
 = 
mbrs
[0].
mbr_upd©e
;

5797 
	`debugs1
("šdex=0, mbr_upd©e=%d.\n", 
mbrs
[0].
mbr_upd©e
);

5798 
j
 = 1; j < 
READ_MBR_COUNT
; j++) {

5799 
	`debugs1
("šdex=%d, mbr_upd©e=%d.\n", 
j
, 
mbrs
[j].
mbr_upd©e
);

5800 ià(
mbrs
[
j
].
mbr_upd©e
 > 
max_upd©e
) {

5801 
max_upd©e
 = 
mbrs
[
j
].
mbr_upd©e
;

5802 
Ï‹¡_šdex
 = 
j
;

5805 
	`shªnÚ_šfo
("g‘ mb¸šfÜm©iÚ sucûssfuÎy. max_upd©e=%d.\n", 
max_upd©e
);

5806 
	`ª®yze_mbr_šfo
(
sdev
, 
mbrs
 + 
Ï‹¡_šdex
);

5807 
	`shªnÚ_kä“
(
mbrs
);

5809 
	}
}

5811 
	$d‘eù_commÚ_šfo
(
shªnÚ_dev
 *
dev
)

5813 
»t
;

5815 
»t
 = 
	`g‘_Ï‹¡_mbr
(
dev
);

5816 ià(
»t
 =ğ0 ||„‘ =ğ-
ENOMEM
)

5817  
»t
;

5819 
	`shªnÚ_šfo
("retryo„ead mbr in 4k mode.\n");

5820 
dev
->
logicb_shiá
 = 12;

5821 
dev
->
¶ªe_Üd”
 = 0;

5822 
dev
->
·r™y_groups
 = 1;

5823 
dev
->
Çnd_·ge_shiá
 = 13;

5824 
dev
->
·ges_š_eblock
 = 16;

5825 
dev
->
¶ªes
 = 1 << dev->
¶ªe_Üd”
;

5826 
	`ÿlcuÏ‹_glob®_v¬ŸbË
(
dev
);

5827 
	`š™_glob®_cÚfig_»gs
(
dev
);

5829 ià(
	`g‘_Ï‹¡_mbr
(
dev
) == 0)

5832 
	`shªnÚ_”r
("%s: cª‚Ù„—d MBR infÜm©iÚ. Iàyou‡» usšg‡‚ew h¬dw¬e,…Ëa£ upd©you¸driv” v”siÚ!\n", 
dev
->
sdisk
.
disk_Çme
);

5834 
	}
}

5836 
	$g‘_lun_æashid
(
shªnÚ_dev
 *
dev
, 
shªnÚ_lun_b¬
 
__iomem
 *
lun_£ùiÚ
, 
phy_lun
, 
check_id
)

5838 
shªnÚ_cmd
 *
sq_addr
;

5839 vŞ©
shªnÚ_cmd
 *
cq_addr
;

5840 
shªnÚ_»gi¡”_cmd
 *
»adid
;

5841 
shªnÚ_dma_addr_t
 
sq_dma_addr
, 
cq_dma_addr
;

5842 
u32
 
sq_h—d
, 
cq_h—d
, 
cq_
;

5843 
cmdid
;

5844 
i
 = 0, 
»t
 = -1;

5845 
u64
 
id
;

5847 
sq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, &
sq_dma_addr
, 
GFP_SHANNON
);

5848 ià(
sq_addr
 =ğ
NULL
)

5849  
»t
;

5850 
cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, &
cq_dma_addr
, 
GFP_SHANNON
);

5851 ià(
cq_addr
 =ğ
NULL
) {

5852 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)
sq_addr
, 
sq_dma_addr
);

5853  
»t
;

5856 
	`debugs2
("sq_dma_addrğ0x%Îx.\n", 
sq_dma_addr
);

5857 
	`debugs2
("cq_dma_addrğ0x%Îx.\n", 
cq_dma_addr
);

5859 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

5860 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

5861 
	`wr™e32
((
u32
)(()
sq_addr
 & 0xffffffff), &
lun_£ùiÚ
->
sq_dma_addr0
);

5862 
	`wr™e32
((
u32
)(()
sq_addr
 >> 32), &
lun_£ùiÚ
->
sq_dma_addr1
);

5863 
	`wr™e32
((
u32
)(()
cq_addr
 & 0xffffffff), &
lun_£ùiÚ
->
cq_dma_addr0
);

5864 
	`wr™e32
((
u32
)(()
cq_addr
 >> 32), &
lun_£ùiÚ
->
cq_dma_addr1
);

5866 
	`wr™e32
((
u32
)(
sq_dma_addr
 & 0xffffffff), &
lun_£ùiÚ
->
sq_dma_addr0
);

5867 
	`wr™e32
(((
dma_addr_t
è> 4è? (
u32
)(
sq_dma_addr
 >> 32è: 0, &
lun_£ùiÚ
->
sq_dma_addr1
);

5868 
	`wr™e32
((
u32
)(
cq_dma_addr
 & 0xffffffff), &
lun_£ùiÚ
->
cq_dma_addr0
);

5869 
	`wr™e32
(((
dma_addr_t
è> 4è? (
u32
)(
cq_dma_addr
 >> 32è: 0, &
lun_£ùiÚ
->
cq_dma_addr1
);

5871 
sq_h—d
 = 
	`»ad32
(&
lun_£ùiÚ
->sq_head);

5872 
cq_h—d
 = 
	`»ad32
(&
lun_£ùiÚ
->cq_head);

5873 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

5875 
cq_
 = 
cq_h—d
;

5877 
cmdid
 = 
sq_h—d
 >> 3;

5878 
»adid
 = (
shªnÚ_»gi¡”_cmd
 *)(
sq_addr
 + 
cmdid
);

5879 
»adid
->
İcode
 = 
sh_cmd_»g_»ad
;

5880 
»adid
->
æash_»g
.
æash_addr
 = 0;

5881 
»adid
->
æash_»g
.
by‹s
 = 8;

5882 
»adid
->
æash_»g
.
æash_cmd
 = 0x90;

5883 
»adid
->
æash_»g
.
phy_lun
 =…hy_lun;

5884 
sq_h—d
 += 8;

5885 
	`wr™e_»g_§ã
(
dev
, 
sq_h—d
, &
lun_£ùiÚ
->sq_head);

5888 
	`shªnÚ_m¦“p
(2);

5889 
cq_h—d
 = 
	`»ad_»g_§ã
(
dev
, &
lun_£ùiÚ
->cq_head);

5890 
	`debugs3
("sq_h—d=%d.\n", 
sq_h—d
);

5891 
	`debugs3
("cq_h—d=%d.\n", 
cq_h—d
);

5892 
	`debugs3
("¡©us=0x%x.\n", 
	`»ad_»g_§ã
(
dev
, &
lun_£ùiÚ
->
lun_¡©us
));

5893 
	`debugs3
("sq_addr=0x%lx, cq_addr=0x%lx.\n", ()
sq_addr
, ()
cq_addr
);

5894 
	`debugs3
("lun_£ùiÚ=0x%lx.\n", ()
lun_£ùiÚ
);

5895 } 
sq_h—d
 !ğ
cq_h—d
);

5897 
id
 = 
	`shªnÚ_mem_»adq
(
cq_addr
 + (
cq_
>>3));

5898 
cq_
 = 
cq_h—d
;

5900 ià(!
	`shªnÚ_dev_is_g5
(
dev
)) {

5901 ià(!
check_id
)

5902 
dev
->
ifmode
 = -1;

5903 
i
 = 0; i < 
	`ARRAY_SIZE
(
suµÜ‹d_ids
); i++) {

5904 ià(
suµÜ‹d_ids
[
i
].
æashid
 =ğ
id
) {

5905 
dev
->
ifmode
 = 
suµÜ‹d_ids
[
i
].ifmode;

5906 
dev
->
ov”drive
 = 
suµÜ‹d_ids
[
i
].overdrive;

5907 
dev
->
äeq_mode
 = 
suµÜ‹d_ids
[
i
].freq_mode;

5908 
dev
->
miüocode_¬¿y
[0].
bË
 = 
suµÜ‹d_ids
[
i
].
miüocode_bË
;

5909 
dev
->
miüocode_¬¿y
[0].
miüocode_Ëngth
 = 
suµÜ‹d_ids
[
i
].microcode_length;

5910 
dev
->
miüocode_¬¿y
[0].
¡¬t_»g
 = 
SH_ADVANCED_READ_OFFSET
;

5911 
dev
->
miüocode_¬¿y
[0].
¡©e
 = 
MICROCODE_VALID_MASK
;

5912 
dev
->
sh¬ed_·ges
 = 
suµÜ‹d_ids
[
i
].shared_pages;

5913 
	`shªnÚ_memıy
(
dev
->
ã©u»_cfg_li¡
, 
suµÜ‹d_ids
[
i
].feature_cfg_list, (supported_ids[i].feature_cfg_list));

5918 ià(
i
 =ğ
	`ARRAY_SIZE
(
suµÜ‹d_ids
))

5919 
	`shªnÚ_”r
("%s: PËa£ upd©you driv” v”siÚØsuµÜˆthÃw fÏshid=0x%16.16Îx,…hy_lun=%d.\n", 
dev
->
sdisk
.
disk_Çme
, 
id
, 
phy_lun
);

5922 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)
sq_addr
, 
sq_dma_addr
);

5923 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)
cq_addr
, 
cq_dma_addr
);

5925 ià(
check_id
) {

5926 ià(
dev
->
æashid
 !ğ
id
) {

5927 
	`shªnÚ_”r
("Inv®id ID:…yh_lun=%d, id=0x%Îx.\n", 
phy_lun
, 
id
);

5933 
dev
->
æashid
 = 
id
;

5934 
	`debugs1
("æash id=0x%16.16Îx, ifmode=%d, ov”drive=%d, f»q_mode=%d.\n", 
id
, 
dev
->
ifmode
, dev->
ov”drive
, dev->
äeq_mode
);

5936 ià(
	`shªnÚ_dev_is_g5
(
dev
è|| (dev->
ifmode
 != -1))

5940 
	}
}

5942 
	$d‘eù_æashid
(
shªnÚ_dev
 *
dev
, 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
)

5944 
lun£t
, 
phy_lun
, 
»t
 = -1;

5946 ià(
dev
->
nÜ_mbr_¡©us
 & 
READ_FROM_NORFLASH
)

5948 
lun£t
 = 0;†un£ˆ< 
MBR_MAX_TRY
;†unset++) {

5949 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

5950 
phy_lun
 = 
lun£t
 * 
dev
->
max_lun_š_lun£t
;…hy_lun < (lunset + 1) * dev->max_lun_in_lunset;…hy_lun++) {

5951 ià(!
	`shªnÚ_‹¡_b™
(
phy_lun
, (*)
dev
->
mbr
.
bad_phy_lun_m­
))

5954 ià(
phy_lun
 =ğ(
lun£t
 + 1è* 
dev
->
max_lun_š_lun£t
)

5957 
phy_lun
 = 
lun£t
 * 
dev
->
max_lun_š_lun£t
;

5958 
»t
 = 
	`g‘_lun_æashid
(
dev
, 
lun_£ùiÚ
 + 
lun£t
, 
phy_lun
, 0);

5959 ià(
»t
 == 0)

5963 ià(
	`shªnÚ_dev_is_g5
(
dev
è&& (
»t
 == 0)) {

5964 
dev
->
šv®id_æashids
 = (*)
	`shªnÚ_kz®loc
((*è* dev->
lun_couÁ
, 
GFP_SHANNON
);

5965 ià(!
dev
->
šv®id_æashids
) {

5966 
	`shªnÚ_”r
("Allocate memory failed when check‡ll flashid.\n");

5967 
»t
 = -1;

5968 
out
;

5970 
lun£t
 = 0;†un£ˆ< 
dev
->
lun£t_couÁ
;†unset++) {

5971 
phy_lun
 = 
lun£t
 * 
dev
->
max_lun_š_lun£t
;…hy_lun < (lunset + 1) * dev->max_lun_in_lunset;…hy_lun++) {

5972 ià(!
	`shªnÚ_‹¡_b™
(
phy_lun
, (*)
dev
->
mbr
.
bad_phy_lun_m­
)) {

5973 ià(
	`g‘_lun_æashid
(
dev
, 
lun_£ùiÚ
 + 
lun£t
, 
phy_lun
, 1) < 0)

5974 
dev
->
šv®id_æashids
[
phy_lun_to_logiÿl_lun
[dev->
mbr
.
lun_m­_mode
](dev, 
phy_lun
)] = 1;

5980 
out
:

5981  
»t
;

5982 
	}
}

5984 
	$£t_‹m³¿tu»_£nsÜ_th»shŞds
(
shªnÚ_dev
 *
dev
)

5986 
u32
 
th»shŞd
;

5987 
u8
 
‹mp_th»shŞd1
 = 0xff, 
‹mp_ü™iÿl_th»shŞd1
 = 0xff;

5988 
u8
 
‹mp_th»shŞd2
 = 0xff, 
‹mp_ü™iÿl_th»shŞd2
 = 0xff;

5990 ià(
dev
->
mbr
.
‹mp_th»shŞd1
 > 0 && dev->mbr.temp_threshold1 != 0xff &&

5991 
dev
->
mbr
.
‹mp_ü™iÿl_th»shŞd1
 > dev->mbr.
‹mp_th»shŞd1
) {

5992 
‹mp_th»shŞd1
 = 
dev
->
mbr
.temp_threshold1;

5993 
‹mp_ü™iÿl_th»shŞd1
 = 
dev
->
mbr
.temp_critical_threshold1;

5996 ià(
dev
->
mbr
.
‹mp_th»shŞd2
 > 0 && dev->mbr.temp_threshold2 != 0xff &&

5997 
dev
->
mbr
.
‹mp_ü™iÿl_th»shŞd2
 > dev->mbr.
‹mp_th»shŞd2
) {

5998 
‹mp_th»shŞd2
 = 
dev
->
mbr
.temp_threshold2;

5999 
‹mp_ü™iÿl_th»shŞd2
 = 
dev
->
mbr
.temp_critical_threshold2;

6001 
‹mp_th»shŞd2
 = 
TEMP_INNER_THRESHOLD
;

6002 
‹mp_ü™iÿl_th»shŞd2
 = 
TEMP_INNER_CRITICAL_THRESHOLD
;

6005 ià(
‹mp_th»shŞd1
 == 0xff)

6006 
th»shŞd
 = 
TEMP_AUX1_THRESHOLD
 | (
TEMP_AUX2_THRESHOLD
 << 8è| (
TEMP_BOARD_THRESHOLD
 << 16);

6008 
th»shŞd
 = 
‹mp_th»shŞd1
 | (temp_threshold1 << 8) | (temp_threshold1 << 16);

6009 
	`wr™e_»g_§ã
(
dev
, 
th»shŞd
, (
u32
 *)dev->
b¬
 + 
SH_EXT_TEMP_THRESHOLD_OFFSET
);

6011 ià(
‹mp_ü™iÿl_th»shŞd1
 == 0xff)

6012 
th»shŞd
 = 
TEMP_AUX1_CRITICAL_THRESHOLD
 | (
TEMP_AUX2_CRITICAL_THRESHOLD
 << 8è| (
TEMP_BOARD_CRITICAL_THRESHOLD
 << 16);

6014 
th»shŞd
 = 
‹mp_ü™iÿl_th»shŞd1
 | (temp_critical_threshold1 << 8) | (temp_critical_threshold1 << 16);

6015 
	`wr™e_»g_§ã
(
dev
, 
th»shŞd
, (
u32
 *)dev->
b¬
 + 
SH_EXT_TEMP_CRITICAL_THRESHOLD_OFFSET
);

6017 
th»shŞd
 = (((
‹mp_th»shŞd2
 + 273è* 1024 * 1000 / 503975è& 
SH_TEMP_MASK
) | \

6018 ((((
‹mp_ü™iÿl_th»shŞd2
 + 273è* 1024 * 1000 / 503975è& 
SH_TEMP_MASK
) << 16);

6019 
	`wr™e_»g_§ã
(
dev
, 
th»shŞd
, (
u32
 *)dev->
b¬
 + 
SH_INNER_TEMP_THRESHOLD_OFFSET
);

6020 
	}
}

6022 
	$š™_glob®_cÚfig_»gs_fÜ_æashid
(
shªnÚ_dev
 *
dev
)

6024 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6025 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
RESET
, 1);

6026 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6027 
	`shªnÚ_m¦“p
(1);

6029 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6030 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
RESET
, 0);

6033 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, 
ONFI_ASYNC_MODE
);

6034 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
CMD_CYCLE
, 4);

6035 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
SECTORS_IN_PAGE
, 0x0e);

6036 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
PAGES_IN_BLOCK
, 0x03);

6039 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
SECTOR_SIZE
, dev->
logicb_size
/512);

6040 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
ECC_CODEWORDS
, 1);

6041 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
FULL_SECTOR_SIZE
, dev->
ecc_codewÜd_size
);

6044 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
·ge
, 
PLANE_MASK
, 0);

6045 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
·ge
, 
FULL_PAGE_SIZE
, 0x2058);

6048 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
¿id_šfo
, 
RAID_ENABLE
, 0);

6049 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
¿id_šfo
, 
SECTORS_IN_CHUNK
, 0x0e);

6050 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
¿id_šfo
, 
CHUNK_SIZE
, 0x0e);

6053 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
ecc
, 
ECC_BYPASS
, 0);

6054 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
ecc
, 
ECC_CODEWORD_SIZE
, dev->
ecc_codewÜd_size
);

6055 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6056 
	}
}

6059 
	$£t_şk
(
shªnÚ_dev
 *
sdev
, 
u16
 
v®ue
)

6061 ià((
v®ue
 != 0) && (value != 0xffff)) {

6062 
u16
 
şk
 = 
v®ue
 - 1;

6063 
	`shªnÚ_šfo
("%s: clk = %d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
şk
);

6064 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

6065 
	`shªnÚ_iowr™e32
(0, (
u32
 *)
sdev
->
b¬
 + 
SH_DEBUG_DCM_OFFSET
);

6066 
	`shªnÚ_iowr™e32
((1 << 31è| 
şk
, (
u32
 *)
sdev
->
b¬
 + 
SH_DEBUG_DCM_OFFSET
);

6067 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

6068 
	`shªnÚ_m¦“p
(1);

6070 
	}
}

6072 
	$š™_glob®_cÚfig_»gs
(
shªnÚ_dev
 *
dev
)

6074 ià(
	`dev_is_8639_w™h_§ndisk
(
dev
)) {

6075 
	`£t_şk
(
dev
, 
CLK_166M
 + 1);

6076 } ià(
dev
->
mbr
.
şk
 == 0) {

6077 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6078 
	`shªnÚ_iowr™e32
(0, (
u32
 *)
dev
->
b¬
 + 
SH_DCM_FREQ_OFFSET
);

6079 
	`shªnÚ_iowr™e32
((1 << 31è| 
dev
->
äeq_mode
, (
u32
 *)dev->
b¬
 + 
SH_DCM_FREQ_OFFSET
);

6080 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6081 
	`shªnÚ_m¦“p
(1);

6083 
	`£t_şk
(
dev
, dev->
mbr
.
şk
);

6086 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6088 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, dev->
ifmode
);

6090 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
LED
, 
YELLOW_DARK
|
GREEN_FLASHING
);

6091 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
CMD_CYCLE
, 4);

6092 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
SECTORS_IN_PAGE
, dev->
logicbs_š_·ge
 - 1);

6093 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
æash
, 
PAGES_IN_BLOCK
, (dev->
·ges_š_eblock
 < 64)?0:(dev->pages_in_eblock/64 - 1));

6096 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
SECTOR_SIZE
, dev->
logicb_size
/512);

6097 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
ECC_CODEWORDS
, dev->
ecc_codewÜds_š_logicb
);

6098 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
FULL_SECTOR_SIZE
, dev->
fuÎ_£ùÜ_size
);

6101 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
·ge
, 
PLANE_MASK
, ((dev->
¶ªes
 - 1è* dev->
·ges_š_eblock
) >> 6);

6102 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
·ge
, 
LUN_ADDR_MASK
, dev->
mbr
.
luns_³r_û_mask
);

6103 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
·ge
, 
FULL_PAGE_SIZE
, dev->
fuÎ_·ge_size
);

6106 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
¿id_šfo
, 
RAID_ENABLE
, dev->
¿id5_suµÜ‹d
);

6107 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
¿id_šfo
, 
SECTORS_IN_CHUNK
, dev->
logicbs_š_chunk
 - 1);

6108 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
¿id_šfo
, 
CHUNK_SIZE
, (dev->
logicb_size
 * dev->
logicbs_š_chunk
)/512 - 1);

6111 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
ecc
, 
ECC_BYPASS
, dev->
ecc_by·ss
);

6113 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
ecc
, 
ECC_FORCE_SECOND
, 
ecc_fÜû_£cÚd_»que¡
);

6114 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
ecc
, 
ECC_CODEWORD_SIZE
, dev->
ecc_codewÜd_size
);

6117 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
misc
, 
INT_DELAY
, dev->
š‹¼u±_d–ay
);

6119 ià((
dev
->
mbr
.
pow”_budg‘
 != 0) && (dev->mbr.power_budget != 0xff)) {

6120 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6121 
	`shªnÚ_šfo
("%s:…ow”_budg‘=0x%x.\n", 
dev
->
sdisk
.
disk_Çme
, dev->
mbr
.
pow”_budg‘
);

6122 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6123 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
misc
, 
POWER_BUDGET
, dev->
mbr
.
pow”_budg‘
);

6125 ià((
dev
->
mbr
.
dma_max_»ad_lim™
 != 0) && (dev->mbr.dma_max_read_limit != 0xff)) {

6126 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6127 
	`shªnÚ_šfo
("%s: dma_max_»ad_lim™=0x%x.\n", 
dev
->
sdisk
.
disk_Çme
, dev->
mbr
.
dma_max_»ad_lim™
);

6128 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6129 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
süambËr_mask
, 
DMA_MAX_READ
, dev->
mbr
.
dma_max_»ad_lim™
 - 1);

6135 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6137 
	`£t_‹m³¿tu»_£nsÜ_th»shŞds
(
dev
);

6138 
	}
}

6140 
	$£t_avaabË_¿id_¡res
(
shªnÚ_dev
 *
sdev
)

6142 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

6143 
groups_š_¡re
 = 
sdev
->
max_avaabË_groups
;

6145 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

6146 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
¿id_šfo
, 
RAID_STRIPES
, sdev->
max_avaabË_groups
 - 1);

6147 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

6149 
	}
}

6151 
	$dump_b¬_¥aû
(
shªnÚ_dev
 *
dev
)

6153 
u32
 
ÿp
, 
¿id
, 
ecc
, 
buf_šfo
, 
dÇ_low
, 
dÇ_high
, 
æash
, 
logicb
, 
·ge
, 
¿id_šfo
, 
g_ecc
;

6156 
	`debugs4
("Aá” m­pšg: dev->b¬=0x%lx.\n", ()
dev
->
b¬
);

6157 
	`debugs4
("dev->š‹¼u±_b¬=0x%lx.\n", ()
dev
->
š‹¼u±_b¬
);

6158 
	`debugs4
("dev->glob®_b¬=0x%lx.\n", ()
dev
->
glob®_b¬
);

6206 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6207 
ÿp
 = 
	`shªnÚ_»adl
(&
dev
->
b¬
->cap);

6208 
¿id
 = 
	`shªnÚ_»adl
(&
dev
->
b¬
->raid);

6209 
ecc
 = 
	`shªnÚ_»adl
(&
dev
->
b¬
->ecc);

6210 
buf_šfo
 = 
	`shªnÚ_»adl
(&
dev
->
b¬
->
wr™e_buf_šfo
);

6211 
dÇ_low
 = 
	`shªnÚ_»adl
(&
dev
->
b¬
->dna_low);

6212 
dÇ_high
 = 
	`shªnÚ_»adl
(&
dev
->
b¬
->dna_high);

6213 
æash
 = 
	`shªnÚ_»adl
(&
dev
->
glob®_b¬
->flash);

6214 
logicb
 = 
	`shªnÚ_»adl
(&
dev
->
glob®_b¬
->logicb);

6215 
·ge
 = 
	`shªnÚ_»adl
(&
dev
->
glob®_b¬
->page);

6216 
¿id_šfo
 = 
	`shªnÚ_»adl
(&
dev
->
glob®_b¬
->raid_info);

6217 
g_ecc
 = 
	`shªnÚ_»adl
(&
dev
->
glob®_b¬
->
ecc
);

6219 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6220 
	`debugs4
("\nRead by„eadl......\n");

6221 
	`debugs4
("ÿp=0x%x.\n", 
ÿp
);

6222 
	`debugs4
("¿id=0x%x.\n", 
¿id
);

6223 
	`debugs4
("ecc=0x%x.\n", 
ecc
);

6224 
	`debugs4
("wr™e_buf_šfo=0x%x.\n", 
buf_šfo
);

6225 
	`debugs4
("dÇ_low=0x%x.\n", 
dÇ_low
);

6226 
	`debugs4
("dÇ_high=0x%x.\n", 
dÇ_high
);

6227 
	`debugs4
("æash=0x%x.\n", 
æash
);

6228 
	`debugs4
("logicb=0x%x.\n", 
logicb
);

6229 
	`debugs4
("·ge=0x%x.\n", 
·ge
);

6230 
	`debugs4
("¿id_šfo=0x%x.\n", 
¿id_šfo
);

6231 
	`debugs4
("ecc=0x%x.\n", 
g_ecc
);

6233 
	}
}

6235 #ià!
defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

6236 
	$»£t_®l_lun£t
(
shªnÚ_dev
 *
dev
, 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
)

6238 
shªnÚ_cmd
 *
sq_addr
;

6239 
shªnÚ_cmd
 *
no_İ
;

6240 vŞ©
shªnÚ_cmd
 *
cq_addr
;

6241 
shªnÚ_»gi¡”_cmd
 *
»£t
;

6242 
shªnÚ_dma_addr_t
 
sq_dma_addr
, 
cq_dma_addr
;

6243 
u32
 
sq_h—d
, 
cq_h—d
, 
cq_
;

6244 
cmdid
;

6245 
i
, 
j
, 
k
, 
»t
 = -1;

6246 
»£t_time
 = 0;

6248 
sq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, &
sq_dma_addr
, 
GFP_SHANNON
);

6249 ià(
sq_addr
 =ğ
NULL
)

6250  
»t
;

6251 
cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, &
cq_dma_addr
, 
GFP_SHANNON
);

6252 ià(
cq_addr
 =ğ
NULL
) {

6253 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)
sq_addr
, 
sq_dma_addr
);

6254  
»t
;

6257 
	`debugs2
("sq_dma_addrğ0x%Îx.\n", 
sq_dma_addr
);

6258 
	`debugs2
("cq_dma_addrğ0x%Îx.\n", 
cq_dma_addr
);

6260 
»do_®l_lun£ts_»£t
:

6261 
i
 = 0; i < 
dev
->
max_lun_š_lun£t
; i+=dev->
max_lun_š_û
) {

6262 
j
 = 0; j < 
dev
->
max_chªÃls
 * dev->
max_lun£t_š_chªÃl
; j++) {

6263 
shªnÚ_lun_b¬
 *
this_£ùiÚ
 = 
lun_£ùiÚ
 + 
j
;

6264 
k
 = 0; k < 
dev
->
max_lun_š_û
; k++) {

6265 ià(!
	`shªnÚ_‹¡_b™
(
j
 * 
dev
->
max_lun_š_lun£t
 + 
i
 + 
k
, (*)dev->
mbr
.
bad_phy_lun_m­
))

6268 ià(
k
 >ğ
dev
->
max_lun_š_û
)

6270 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6271 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

6272 
	`wr™e32
((
u32
)(()
sq_addr
 & 0xffffffff), &
this_£ùiÚ
->
sq_dma_addr0
);

6273 
	`wr™e32
((
u32
)(()
sq_addr
 >> 32), &
this_£ùiÚ
->
sq_dma_addr1
);

6274 
	`wr™e32
((
u32
)(()
cq_addr
 & 0xffffffff), &
this_£ùiÚ
->
cq_dma_addr0
);

6275 
	`wr™e32
((
u32
)(()
cq_addr
 >> 32), &
this_£ùiÚ
->
cq_dma_addr1
);

6277 
	`wr™e32
((
u32
)(
sq_dma_addr
 & 0xffffffff), &
this_£ùiÚ
->
sq_dma_addr0
);

6278 
	`wr™e32
(((
dma_addr_t
è> 4è? (
u32
)(
sq_dma_addr
 >> 32è: 0, &
this_£ùiÚ
->
sq_dma_addr1
);

6279 
	`wr™e32
((
u32
)(
cq_dma_addr
 & 0xffffffff), &
this_£ùiÚ
->
cq_dma_addr0
);

6280 
	`wr™e32
(((
dma_addr_t
è> 4è? (
u32
)(
cq_dma_addr
 >> 32è: 0, &
this_£ùiÚ
->
cq_dma_addr1
);

6282 
sq_h—d
 = 
	`»ad32
(&
this_£ùiÚ
->sq_head);

6283 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6284 
cmdid
 = 
sq_h—d
 >> 3;

6285 
»£t
 = (
shªnÚ_»gi¡”_cmd
 *)(
sq_addr
 + 
cmdid
);

6286 
»£t
->
İcode
 = (
dev
->
h¬dw¬e_v”siÚ
 >ğ5è? 
sh_cmd_»g_wr™e
 : 
sh_cmd_»£t
;

6287 
»£t
->
£cÚd¬y_cmd
 = 0;

6288 
»£t
->
d©a_by‹
 = 0;

6289 
»£t
->
h—d
 = 0;

6290 
»£t
->
æash_»g
.
æash_addr
 = 0;

6291 
»£t
->
æash_»g
.
by‹s
 = 0;

6292 
»£t
->
æash_»g
.
æash_cmd
 = 0xFF;

6293 
»£t
->
æash_»g
.
phy_lun
 = 
j
 * 
dev
->
max_lun_š_lun£t
 + 
i
 + 
k
;

6294 
sq_h—d
 = (sq_h—d + 8è% 
QUEUE_SIZE
;

6296 
	`wr™e_»g_§ã
(
dev
, 
sq_h—d
, &
this_£ùiÚ
->sq_head);

6298 
cq_h—d
 = 
	`»ad_»g_§ã
(
dev
, &
this_£ùiÚ
->cq_head);

6299 iàĞ
sq_h—d
 !ğ
cq_h—d
) {

6300 
	`shªnÚ_m¦“p
(2);

6302 } 
sq_h—d
 !ğ
cq_h—d
);

6303 
cq_
 = 
cq_h—d
;

6304 
	`debugs2
("»£‰šg†un£ˆ%d†uÀ%d, sq_h—d‡nd cq_h—d‡» %d, %d\n", 
j
, 
i
, 
sq_h—d
, 
cq_h—d
);

6306 
	`shªnÚ_m¦“p
(10);

6308 
j
 = 0; j < 
dev
->
max_chªÃls
 * dev->
max_lun£t_š_chªÃl
; j++) {

6309 
shªnÚ_lun_b¬
 *
this_£ùiÚ
 = 
lun_£ùiÚ
 + 
j
;

6310 
k
 = 0; k < 
dev
->
max_lun_š_û
; k++) {

6311 ià(!
	`shªnÚ_‹¡_b™
(
j
 * 
dev
->
max_lun_š_lun£t
 + 
i
 + 
k
, (*)dev->
mbr
.
bad_phy_lun_m­
))

6314 ià(
k
 >ğ
dev
->
max_lun_š_û
)

6316 
sq_h—d
 = 
	`»ad_»g_§ã
(
dev
, &
this_£ùiÚ
->sq_head);

6317 
cmdid
 = 
sq_h—d
 >> 3;

6318 
no_İ
 = (
shªnÚ_cmd
*)(
sq_addr
 + 
cmdid
);

6319 
no_İ
->
İcode
 = 
sh_cmd_no_İ
;

6320 
no_İ
->
logicbs
 = 0;

6321 
no_İ
->
¿id_¡re
 = 0;

6322 
no_İ
->
h—d
 = 0;

6323 
no_İ
->
dwÜd1
 = ((
j
 * 
dev
->
max_lun_š_lun£t
 + 
i
 + 
k
) & 0xff) << 24;

6324 
sq_h—d
 = (sq_h—d + 8è% 
QUEUE_SIZE
;

6326 
	`wr™e_»g_§ã
(
dev
, 
sq_h—d
, &
this_£ùiÚ
->sq_head);

6328 
cq_h—d
 = 
	`»ad_»g_§ã
(
dev
, &
this_£ùiÚ
->cq_head);

6329 iàĞ
sq_h—d
 !ğ
cq_h—d
) {

6330 
	`shªnÚ_m¦“p
(2);

6332 } 
sq_h—d
 !ğ
cq_h—d
);

6333 
cq_
 = 
cq_h—d
;

6336 ià(++
»£t_time
 < 2)

6337 
»do_®l_lun£ts_»£t
;

6339 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)
sq_addr
, 
sq_dma_addr
);

6340 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)
cq_addr
, 
cq_dma_addr
);

6341 
	`shªnÚ_m¦“p
(100);

6343 
	}
}

6345 
	$lun_£t_ã©u»_g’”®
(
shªnÚ_dev
 *
sdev
, 
u32
 
æash_addr
, u32 
v®ue
)

6347 
shªnÚ_lun£t
 *
lun£t
;

6348 
shªnÚ_»gi¡”_cmd
 *
£t_ã©u»
;

6349 
cmdid
;

6350 
u64
 *
d©a
;

6351 
i
, 
j
;

6353 
j
 = 0; j < 
sdev
->
max_lun_š_lun£t
; j++) {

6354 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

6355 
lun£t
 = &
sdev
->
lun£ts
[
i
];

6356 
cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

6357 
£t_ã©u»
 = (
shªnÚ_»gi¡”_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

6358 
£t_ã©u»
->
İcode
 = 
sh_cmd_»g_wr™e
;

6359 
£t_ã©u»
->
æash_»g
.
æash_addr
 = flash_addr;

6360 
£t_ã©u»
->
æash_»g
.
by‹s
 = 4;

6361 
£t_ã©u»
->
æash_»g
.
æash_cmd
 = 0xEF;

6362 
£t_ã©u»
->
æash_»g
.
phy_lun
 = 
lun£t
->
šdex
 * 
sdev
->
max_lun_š_lun£t
 + 
j
;

6363 
d©a
 = 
	`cmd_queue_šc
(
£t_ã©u»
, 1);

6364 
	`shªnÚ_mem_wr™eq
(
v®ue
, 
d©a
);

6365 
lun£t
->
sq_h—d
 = (lun£t->sq_h—d + 16è% 
QUEUE_SIZE
;

6366 
	`wr™e_»g_§ã
(
sdev
, 
lun£t
->
sq_h—d
, &lun£t->
lun_b¬
->sq_head);

6368 
	`shªnÚ_m¦“p
(5);

6370 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

6371 
lun£t
 = &
sdev
->
lun£ts
[
i
];

6372 
lun£t
->
cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->cq_head);

6373 
lun£t
->
sq_h—d
 !ğlun£t->
cq_h—d
) {

6374 
	`shªnÚ_m¦“p
(1);

6375 
lun£t
->
cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->cq_head);

6377 
lun£t
->
cq_
 =†un£t->
cq_h—d
;

6378 
lun£t
->
cq__tmp
 =†un£t->
cq_h—d
;

6379 
lun£t
->
sq_h—d_tmp
 =†un£t->
sq_h—d
;

6380 
lun£t
->
sq_hw_h—d
 =†un£t->
sq_h—d
;

6381 
lun£t
->
cq_hw_h—d
 =†un£t->
cq_h—d
;

6384 
	}
}

6397 
	$lun_£t_ã©u»_ov”_drive
(
shªnÚ_dev
 *
sdev
, 
u32
 
drive_¡»ngh
)

6399 
	`lun_£t_ã©u»_g’”®
(
sdev
, 0x10, 
drive_¡»ngh
);

6400 
	}
}

6402 
	$lun_£t_ã©u»_odt
(
shªnÚ_dev
 *
sdev
)

6404 
	`lun_£t_ã©u»_g’”®
(
sdev
, 0x02, 0x10);

6405 
	}
}

6407 
	$check_ã©u»_cfg_li¡
(
shªnÚ_dev
 *
sdev
)

6409 
i
;

6410 
»t
 = 0;

6411 
ã©u»_cfg
 *
li¡
 = 
sdev
->
ã©u»_cfg_li¡
;

6413 
	`BUG_ON
(
li¡
 =ğ
NULL
);

6414 
i
 = 0; i < 
FEATURE_CFG_LIST_SIZE
; i++) {

6415 ià((
	`g‘_ã©u»_cfg_v®id
(
li¡
è=ğ0è&& (
	`g‘_ã©u»_cfg_®l_´io
(list) != 0)) {

6416 
»t
 = -1;

6417 
	`shªnÚ_”r
("ã©u» cfg %d i šv®id, buˆ™ ha ´iÜ™y.\n", 
i
);

6420 ià((
	`g‘_ã©u»_cfg_v®id
(
li¡
è!ğ0è&& (
	`g‘_ã©u»_cfg_®l_´io
(list) == 0)) {

6421 
»t
 = -1;

6422 
	`shªnÚ_”r
("ã©u» cfg %d i v®id, buˆ™ dÛ¢`ˆhav´iÜ™y.\n", 
i
);

6425 
li¡
++;

6428  
»t
;

6429 
	}
}

6431 
	$lun_£t_®l_ã©u»
(
shªnÚ_dev
 *
sdev
)

6433 
i
;

6434 
ã©u»_cfg
 *
li¡
 = 
sdev
->
ã©u»_cfg_li¡
;

6436 
	`BUG_ON
(
li¡
 =ğ
NULL
);

6437 
i
 = 0; i < 
FEATURE_CFG_LIST_SIZE
; i++) {

6438 ià(
li¡
->
v®id
 =ğ
FEATURE_INVALID
)

6441 
	`debugs1
("%s: s‘ v®u0x%xØadd¸0x%x\n", 
__func__
, 
li¡
->
d©a
[0],†i¡->
addr
);

6443 
	`lun_£t_ã©u»_g’”®_g4
(
sdev
, 
li¡
);

6444 
li¡
++;

6447 
	}
}

6449 
	$»bud_®l_ã©u»_cfg
(
shªnÚ_dev
 *
sdev
)

6451 
i
;

6453 
i
 = 0; i < 
FEATURE_CFG_LIST_SIZE
; i++) {

6454 ià(
	`g‘_ã©u»_cfg_v®id
(&
sdev
->
ã©u»_cfg_li¡
[
i
])) {

6455 ià(
	`g‘_ã©u»_cfg_®l_´io
(&
sdev
->
ã©u»_cfg_li¡
[
i
]) == 0)

6456 
	`£t_ã©u»_cfg_®l_´io
(&
sdev
->
ã©u»_cfg_li¡
[
i
]);

6458 ià(
	`g‘_ã©u»_cfg_®l_´io
(&
sdev
->
ã©u»_cfg_li¡
[
i
]) != 0)

6459 
	`ş—n_ã©u»_cfg_®l_´io
(&
sdev
->
ã©u»_cfg_li¡
[
i
]);

6463 
	}
}

6465 
šlše
 
	$g‘_ã©u»_cfg_´io
(
ã©u»_cfg
 *
cfg
, 
´io
)

6467 
u8
 
mask
;

6469 
´io
) {

6471 
mask
 = 
FEATURE_PRIO_0_MASK
;

6474 
mask
 = 
FEATURE_PRIO_1_MASK
;

6477 
mask
 = 0;

6481  
cfg
->
v®id
 & 
mask
;

6482 
	}
}

6484 
	$lun_£t_®l_ã©u»_w™h_´io
(
shªnÚ_dev
 *
sdev
, 
´io
)

6486 
i
;

6487 
ã©u»_cfg
 *
li¡
 = 
sdev
->
ã©u»_cfg_li¡
;

6489 
	`BUG_ON
(
li¡
 =ğ
NULL
);

6490 
i
 = 0; i < 
FEATURE_CFG_LIST_SIZE
; i++) {

6491 ià(
li¡
->
v®id
 =ğ
FEATURE_INVALID
)

6493 ià(
	`g‘_ã©u»_cfg_´io
(
li¡
, 
´io
)){

6494 
	`debugs1
("%s:…riØ%d, s‘ v®u0x%xØadd¸0x%x\n", 
__func__
, 
´io
, 
li¡
->
d©a
[0],†i¡->
addr
);

6496 
	`lun_£t_ã©u»_g’”®_g4
(
sdev
, 
li¡
);

6498 
li¡
++;

6501 
	}
}

6503 
	$is_v®id_id
(
shªnÚ_dev
 *
sdev
, 
u64
 
id
)

6505 
i
;

6506 ià(
sdev
->
nÜ_mbr_¡©us
 & 
READ_FROM_NORFLASH
)

6507  (
sdev
->
æashid
 =ğ
id
);

6509 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

6510  (
sdev
->
æashid
 =ğ
id
);

6512 
i
 = 0; i < 
	`ARRAY_SIZE
(
suµÜ‹d_ids
); i++) {

6513 ià((
suµÜ‹d_ids
[
i
].
æashid
 & 0xffffffè=ğ(
id
 & 0xffffff))

6517 
	}
}

6519 
	$lun_»ad_id
(
shªnÚ_lun
 *
lun
)

6521 
shªnÚ_lun£t
 *
lun£t
 = 
lun
->lunset;

6522 
shªnÚ_dev
 *
sdev
 = 
lun£t
->sdev;

6523 
shªnÚ_»gi¡”_cmd
 *
»adid
;

6524 
cmdid
;

6525 
u64
 
id
;

6527 
cmdid
 = 
lun£t
->
sq_h—d
 >> 3;

6528 
»adid
 = (
shªnÚ_»gi¡”_cmd
 *)(
lun£t
->
sq_addr
 + 
cmdid
);

6529 
»adid
->
İcode
 = 
sh_cmd_»g_»ad
;

6530 
»adid
->
æash_»g
.
æash_addr
 = 0;

6531 
»adid
->
æash_»g
.
by‹s
 = 8;

6532 
»adid
->
æash_»g
.
æash_cmd
 = 0x90;

6533 
»adid
->
æash_»g
.
phy_lun
 = 
lun
->
phy_lun_num
;

6534 
lun£t
->
sq_h—d
 += 8;

6535 
	`wr™e_»g_§ã
(
sdev
, 
lun£t
->
sq_h—d
, &lun£t->
lun_b¬
->sq_head);

6537 
	`shªnÚ_m¦“p
(2);

6538 
lun£t
->
cq_h—d
 = 
	`»ad_»g_§ã
(
sdev
, &lun£t->
lun_b¬
->cq_head);

6539 } 
lun£t
->
sq_h—d
 !ğlun£t->
cq_h—d
);

6540 
	`debugs3
("sq_h—d=%d, cq_h—d=%d, cq_=%d\n", 
lun£t
->
sq_h—d
,†un£t->
cq_h—d
,†un£t->
cq_
);

6541 
id
 = 
	`shªnÚ_mem_»adq
(
lun£t
->
cq_addr
 + (lun£t->
cq_
>>3));

6542 
	`debugs3
("lun=%d, id=0x%Îx,†un_¡©us=0x%x.\n", 
lun
->
lun_num
, 
id
, 
	`»ad_»g_§ã
(
sdev
, &
lun£t
->
lun_b¬
->
lun_¡©us
));

6543 
lun£t
->
cq_
 =†un£t->
cq_h—d
;

6544 
lun£t
->
cq__tmp
 =†un£t->
cq_h—d
;

6546 
lun£t
->
sq_h—d_tmp
 =†un£t->
sq_h—d
;

6547 
lun£t
->
sq_hw_h—d
 =†un£t->
sq_h—d
;

6548 
lun£t
->
cq_hw_h—d
 =†un£t->
cq_h—d
;

6550 ià(
	`is_v®id_id
(
sdev
, 
id
))

6553 
	`shªnÚ_”r
("Inv®id ID:†un=%d, id=0x%Îx,†un_¡©us=0x%x.\n", 
lun
->
lun_num
, 
id
, 
	`»ad_»g_§ã
(
sdev
, &
lun£t
->
lun_b¬
->
lun_¡©us
));

6554  -
EIO
;

6556 
	}
}

6559 
	$shªnÚ_bio_š_æight
(
shªnÚ_dev
 *
sdev
)

6561 ià(
shªnÚ_scsi_mode
)

6562  
	`shªnÚ_scsi_disk_š_æight
(
sdev
->
sdisk
.
ho¡d©a
);

6563 ià(
sdev
->
sdisk
.
gd
)

6564  
	`shªnÚ_disk_š_æight
(
sdev
->
sdisk
.
gd
);

6567 
	}
}

6569 
	$g‘_ÿche_»ad_£ùÜs
(
shªnÚ_´eãtch
 *
´eãtch
)

6571 
i
, 
j
;

6572 
shªnÚ_ÿche_lše
 *
ÿche_lše
;

6573 
u64
 
ÿche_»ad_£ùÜs
 = 0;

6575 ià(
´eãtch
->
ÿche_lše
) {

6576 
i
 = 0; i < 
´eãtch
->
ÿche_lšes
; i++) {

6577 
ÿche_lše
 = &
´eãtch
->ÿche_lše[
i
];

6578 ià(
ÿche_lše
) {

6579 
j
 = 0; j < 
ÿche_lše
->
¦Ù_couÁ
; j++)

6580 
ÿche_»ad_£ùÜs
 +ğ
ÿche_lše
->
¦Ù
[
j
].
ho¡_»ad_£ùÜs
;

6585  
ÿche_»ad_£ùÜs
;

6586 
	}
}

6588 
	$shªnÚ_have_»ad_£ùÜs
(
shªnÚ_dev
 *
sdev
)

6590 
i
;

6591 
u64
 
ho¡_»ad_£ùÜs
 = 0;

6592 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

6593 
ho¡_»ad_£ùÜs
 +ğ
sdev
->
lun£ts
[
i
].host_read_sectors;

6595 
ho¡_»ad_£ùÜs
 +ğ
	`g‘_ÿche_»ad_£ùÜs
(&
sdev
->
sdisk
.
´eãtch
);

6596  
ho¡_»ad_£ùÜs
;

6597 
	}
}

6599 
	$shªnÚ_have_»ad_ios
(
shªnÚ_dev
 *
sdev
)

6601 ià(
shªnÚ_scsi_mode
)

6602  
	`shªnÚ_scsi_ios
(
sdev
->
sdisk
.
ho¡d©a
, 0);

6604  
	`shªnÚ_»ad_ios
(
sdev
->
sdisk
.
gd
);

6605 
	}
}

6607 
	$shªnÚ_have_wr™‹n_ios
(
shªnÚ_dev
 *
sdev
)

6609 ià(
shªnÚ_scsi_mode
)

6610  
	`shªnÚ_scsi_ios
(
sdev
->
sdisk
.
ho¡d©a
, 1);

6612  
	`shªnÚ_wr™e_ios
(
sdev
->
sdisk
.
gd
);

6613 
	}
}

6615 
	$shªnÚ_have_»ad_m£cs
(
shªnÚ_dev
 *
sdev
)

6617 ià(
shªnÚ_scsi_mode
)

6618  
	`shªnÚ_scsi_m£cs
(
sdev
->
sdisk
.
ho¡d©a
, 0);

6620  
	`shªnÚ_»ad_m£cs
(
sdev
->
sdisk
.
gd
);

6621 
	}
}

6623 
	$shªnÚ_have_wr™‹n_m£cs
(
shªnÚ_dev
 *
sdev
)

6625 ià(
shªnÚ_scsi_mode
)

6626  
	`shªnÚ_scsi_m£cs
(
sdev
->
sdisk
.
ho¡d©a
, 1);

6628  
	`shªnÚ_wr™e_m£cs
(
sdev
->
sdisk
.
gd
);

6629 
	}
}

6632 
	$upd©e_pow”_Ú_£cÚds
(
shªnÚ_dev
 *
sdev
)

6634 
jiff›s_d–
;

6636 
jiff›s_d–
 = ()
	`g‘_jiff›s
(è- ()(
sdev
->
pow”_Ú_jiff›s
);

6637 
sdev
->
pow”_Ú_£cÚds
 = 
jiff›s_d–
 / 
	`g‘_HZ
(è+ sdev->
pow”_Ú_£cÚds_hi¡Üy
;

6639 ià(!
shªnÚ_di§bË_š‹rv–_»äesh_mbr
 && (0 =ğ
sdev
->
ho¡_acûss_blocked
è&& ((sdev->
pow”_Ú_£cÚds
 / 
MBR_REFRESH_INTERVAL
è!ğsdev->
»äesh_£qu’û
)) {

6640 
	`shªnÚ_queue_wÜk
(
sdev
->
»äesh_wq
, &sdev->
»äesh_wÜk
);

6641 
sdev
->
»äesh_£qu’û
 = sdev->
pow”_Ú_£cÚds
 / 
MBR_REFRESH_INTERVAL
;

6642 
	`shªnÚ_šfo
("»äesh_£qu’û=%d.\n", 
sdev
->
»äesh_£qu’û
);

6646 
	}
}

6648 
	$upd©e_io_¡©i¡ics
(
shªnÚ_dev
 *
sdev
)

6650 
u64
 
ho¡_wr™e_ios_Ï¡
;

6651 
u64
 
ho¡_wr™e_m£cs_Ï¡
;

6652 
u64
 
ho¡_»ad_ios_Ï¡
;

6653 
u64
 
ho¡_»ad_m£cs_Ï¡
;

6654 
jiff›s_d–
;

6655 
u£c_–­£d
 = 0;

6656 
æags
;

6658 
æags
 = 
	`shªnÚ_¥š_lock_œq§ve
(&
sdev
->
io_¡©i¡ics_lock
);

6660 
jiff›s_d–
 = ()
	`g‘_jiff›s
(è- ()
sdev
->
Ï¡_jiff›s
;

6661 
u£c_–­£d
 = 
	`shªnÚ_jiff›s_to_u£cs
(
jiff›s_d–
);

6662 ià(
u£c_–­£d
 < 300000) {

6663 
	`shªnÚ_¥š_uÆock_œq»¡Üe
(&
sdev
->
io_¡©i¡ics_lock
, 
æags
);

6666 
sdev
->
Ï¡_jiff›s
 = 
	`g‘_jiff›s
();

6669 
ho¡_wr™e_ios_Ï¡
 = 
sdev
->
ho¡_wr™e_ios
;

6670 
ho¡_wr™e_m£cs_Ï¡
 = 
sdev
->
ho¡_wr™e_m£cs
;

6672 
ho¡_»ad_ios_Ï¡
 = 
sdev
->
ho¡_»ad_ios
;

6673 
ho¡_»ad_m£cs_Ï¡
 = 
sdev
->
ho¡_»ad_m£cs
;

6676 
sdev
->
ho¡_wr™e_ios
 = 
	`shªnÚ_have_wr™‹n_ios
(sdev);

6677 
sdev
->
ho¡_wr™e_m£cs
 = 
	`shªnÚ_have_wr™‹n_m£cs
(sdev);

6679 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_have_»ad_£ùÜs
(sdev);

6680 
sdev
->
ho¡_»ad_ios
 = 
	`shªnÚ_have_»ad_ios
(sdev);

6681 
sdev
->
ho¡_»ad_m£cs
 = 
	`shªnÚ_have_»ad_m£cs
(sdev);

6684 
sdev
->
ho¡_wr™e_bªdwidth
 = (sdev->
ho¡_wr™e_£ùÜs
 - sdev->
ho¡_wr™e_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6685 
sdev
->
ho¡_wr™e_iİs
 = (sdev->
ho¡_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
è* 1000000 / 
u£c_–­£d
;

6686 
sdev
->
ho¡_wr™e_Ï‹ncy
 = (sdev->
ho¡_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
) ? \

6687 (
sdev
->
ho¡_wr™e_m£cs
 - 
ho¡_wr™e_m£cs_Ï¡
è* 1000 / (sdev->
ho¡_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
) : 0;

6688 
sdev
->
tÙ®_»ad_bªdwidth
 = (sdev->
tÙ®_»ad_£ùÜs
 - sdev->
tÙ®_»ad_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6689 
sdev
->
tÙ®_wr™e_bªdwidth
 = (sdev->
tÙ®_wr™e_£ùÜs
 - sdev->
tÙ®_wr™e_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6690 
sdev
->
ho¡_»ad_bªdwidth
 = (sdev->
ho¡_»ad_£ùÜs
 - sdev->
ho¡_»ad_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6691 
sdev
->
ho¡_»ad_iİs
 = (sdev->
ho¡_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
è* 1000000 / 
u£c_–­£d
;

6692 
sdev
->
ho¡_»ad_Ï‹ncy
 = (sdev->
ho¡_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
) ? \

6693 (
sdev
->
ho¡_»ad_m£cs
 - 
ho¡_»ad_m£cs_Ï¡
è* 1000 / (sdev->
ho¡_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
) : 0;

6694 
sdev
->
wr™e_am¶if›r
 = (sdev->
ho¡_wr™e_£ùÜs
 - sdev->
ho¡_wr™e_£ùÜs_Ï¡
) ? \

6695 (
sdev
->
tÙ®_wr™e_£ùÜs
 - sdev->
tÙ®_wr™e_£ùÜs_Ï¡
è* 100 / (sdev->
ho¡_wr™e_£ùÜs
 - sdev->
ho¡_wr™e_£ùÜs_Ï¡
) : 100;

6697 
sdev
->
bufãr_wr™e_³rûÁ
 = (sdev->
bufãr_wr™e_couÁ”
 - sdev->
bufãr_wr™e_couÁ”_Ï¡
) * 100 \

6698 / (
sdev
->
bufãr_wr™e_couÁ”
 + sdev->
dœeù_wr™e_couÁ”
 - sdev->
bufãr_wr™e_couÁ”_Ï¡
 - sdev->
dœeù_wr™e_couÁ”_Ï¡
 + 1);

6700 
sdev
->
gc_bªdwidth
 = (sdev->
tÙ®_gc_logicbs
 * sdev->
£ùÜs_š_logicb
 - sdev->
tÙ®_gc_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6701 
sdev
->
wl_bªdwidth
 = (sdev->
tÙ®_wl_logicbs
 * sdev->
£ùÜs_š_logicb
 - sdev->
tÙ®_wl_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6702 
sdev
->
”r_»cov”_bªdwidth
 = (sdev->
tÙ®_”r_»cov”_logicbs
 * sdev->
£ùÜs_š_logicb
 - sdev->
tÙ®_”r_»cov”_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

6705 ià(
sdev
->
ho¡_wr™e_£ùÜs
)

6706 
sdev
->
wr™e_am¶if›r_liãtime
 = sdev->
tÙ®_wr™e_£ùÜs
 * 100 / sdev->
ho¡_wr™e_£ùÜs
;

6708 
sdev
->
wr™e_am¶if›r_liãtime
 = 100;

6711 
sdev
->
ho¡_wr™e_£ùÜs_Ï¡
 = sdev->
ho¡_wr™e_£ùÜs
;

6712 
sdev
->
tÙ®_»ad_£ùÜs_Ï¡
 = sdev->
tÙ®_»ad_£ùÜs
;

6713 
sdev
->
tÙ®_wr™e_£ùÜs_Ï¡
 = sdev->
tÙ®_wr™e_£ùÜs
;

6714 
sdev
->
ho¡_»ad_£ùÜs_Ï¡
 = sdev->
ho¡_»ad_£ùÜs
;

6715 
sdev
->
dœeù_wr™e_couÁ”_Ï¡
 = sdev->
dœeù_wr™e_couÁ”
;

6716 
sdev
->
bufãr_wr™e_couÁ”_Ï¡
 = sdev->
bufãr_wr™e_couÁ”
;

6717 
sdev
->
tÙ®_gc_£ùÜs_Ï¡
 = sdev->
tÙ®_gc_logicbs
 * sdev->
£ùÜs_š_logicb
;

6718 
sdev
->
tÙ®_wl_£ùÜs_Ï¡
 = sdev->
tÙ®_wl_logicbs
 * sdev->
£ùÜs_š_logicb
;

6719 
sdev
->
tÙ®_”r_»cov”_£ùÜs_Ï¡
 = sdev->
tÙ®_”r_»cov”_logicbs
 * sdev->
£ùÜs_š_logicb
;

6721 
	`shªnÚ_¥š_uÆock_œq»¡Üe
(&
sdev
->
io_¡©i¡ics_lock
, 
æags
);

6724 
	}
}

6726 
u32
 
	$»ad_£u_šfo
(
shªnÚ_dev
 *
dev
)

6728 
u32
 
code
;

6729 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

6730 
code
 = 0;

6731 
dev
->
£u_üc_”rÜ
 = 0;

6732 
dev
->
£u_ecc_”rÜ
 = 0;

6734 
code
 = 
	`»ad_»g_§ã
(
dev
, (
u32
 *)dev->
b¬
 + 
SH_SEU_OFFSET
);

6735 
dev
->
£u_üc_”rÜ
 = 
code
 >> 
SH_SEU_CRC_ERROR_SHIFT
;

6736 
dev
->
£u_ecc_”rÜ
 = 
code
 & 
SH_SEU_ECC_ERROR_MASK
;

6738 ià(
code
 =ğ(
u32
)~0)

6739 
	`check_¶ugout
(
dev
);

6742 ià((
dev
->
»cÚfig_suµÜt
 =ğ0è&& dev->
£u_üc_”rÜ
) {

6743 ià(
dev
->
¶ug_out
 == 0) {

6744 
	`shªnÚ_šfo
("%s(): seu„egi¡”=0x%x.\n", 
__func__
, 
code
);

6745 
	`wr™e_»g_§ã
(
dev
, 0x80000000, (
u32
 *)dev->
b¬
 + 
SH_ICAP_OFFSET
);

6746 
	`shªnÚ_”r
("%s: %scorrectable SEUƒrrors bits=%d!he server haso be„ebooted!\n\n",

6747 
dev
->
sdisk
.
disk_Çme
, dev->
£u_üc_”rÜ
?"un":"", dev->
£u_ecc_”rÜ
);

6748 
	`shªnÚ_£t_b™
(
SHN_REASON_SEU_ERROR
, &
dev
->
»adÚly_»asÚ
);

6749 
	`upd©e_acûss_mode
(
dev
);

6754 
	}
}

6756 
	$upd©e_vŞge_‹m³¿tu»
(
shªnÚ_dev
 *
dev
)

6758 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

6759 
dev
->
‹m³¿tu»_št
 = 50;

6760 
dev
->
‹m³¿tu»_št_max
 = 50;

6761 
dev
->
‹m³¿tu»_aux1
 = 50;

6762 
dev
->
‹m³¿tu»_aux2
 = 50;

6763 
dev
->
‹m³¿tu»_æash
 = 50;

6764 
dev
->
‹m³¿tu»_æash_max
 = 50;

6765 
dev
->
‹m³¿tu»_bßrd
 = 50;

6766 
dev
->
‹m³¿tu»_bßrd_max
 = 50;

6767 
dev
->
vŞge_št
 = 888;

6768 
dev
->
vŞge_št_max
 = 888;

6769 
dev
->
vŞge_aux
 = 2345;

6770 
dev
->
vŞge_aux_max
 = 2345;

6772 
code
, 
‹x
, 
‹mp
;

6774 ià(
	`shªnÚ_dev_is_g5_ff§
(
dev
)) {

6775 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6776 
dev
->
‹m³¿tu»_št
 = (
	`shªnÚ_»ad_»g
((
u32
 *)dev->
b¬
 + 
SH_INTERN_TEMP_OFFSET
, 
CURRENT_TEMP
) * 127 - 3680) / 100;

6777 
dev
->
‹m³¿tu»_št_max
 = (
	`shªnÚ_»ad_»g
((
u32
 *)dev->
b¬
 + 
SH_INTERN_TEMP_OFFSET
, 
MAX_TEMP
) * 127 - 3680) / 100;

6778 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6779 
dev
->
vŞge_št
 = 0;

6780 
dev
->
vŞge_št_max
 = 0;

6781 
dev
->
vŞge_aux
 = 0;

6782 
dev
->
vŞge_aux_max
 = 0;

6784 
code
 = 
	`»ad_»g_§ã
(
dev
, (
u32
 *)dev->
b¬
 + 
SH_VCC_TEMP_OFFSET
);

6785 ià((
code
 & 
SH_TEMP_MASK
) != SH_TEMP_MASK)

6786 
dev
->
‹m³¿tu»_št
 = ()((
code
 & 
SH_TEMP_MASK
) * 503975 / (1024 * 1000) -273);

6787 ià(
dev
->
‹m³¿tu»_št
 > dev->
‹m³¿tu»_št_max
)

6788 
dev
->
‹m³¿tu»_št_max
 = dev->
‹m³¿tu»_št
;

6790 ià((
code
 & 
SH_VCCINT_MASK
) != SH_VCCINT_MASK)

6791 
dev
->
vŞge_št
 = ((
code
 & 
SH_VCCINT_MASK
è>> 
SH_VCCINT_SHIFT
) * 1000 * 3 / 1024;

6792 ià(
dev
->
vŞge_št
 > dev->
vŞge_št_max
)

6793 
dev
->
vŞge_št_max
 = dev->
vŞge_št
;

6795 ià((
code
 & 
SH_VCCAUX_MASK
) != SH_VCCAUX_MASK)

6796 
dev
->
vŞge_aux
 = ((
code
 & 
SH_VCCAUX_MASK
è>> 
SH_VCCAUX_SHIFT
) * 1000 * 3 / 1024;

6797 ià(
dev
->
vŞge_aux
 > dev->
vŞge_aux_max
)

6798 
dev
->
vŞge_aux_max
 = dev->
vŞge_aux
;

6801 
code
 = 
	`»ad_»g_§ã
(
dev
, (
u32
 *)dev->
b¬
 + 
SH_TEMP_AUX1_OFFSET
);

6802 
‹x
 = ()((
code
 >> 
SH_EXTERNAL_TEMP_SHIFT
è& 
SH_EXTERNAL_TEMP_MASK
);

6803 ià(
‹x
 !ğ
SH_EXTERNAL_TEMP_MASK
)

6804 
dev
->
‹m³¿tu»_aux1
 = 
‹x
;

6805 
code
 = 
	`»ad_»g_§ã
(
dev
, (
u32
 *)dev->
b¬
 + 
SH_TEMP_AUX2_OFFSET
);

6806 
‹x
 = ()((
code
 >> 
SH_EXTERNAL_TEMP_SHIFT
è& 
SH_EXTERNAL_TEMP_MASK
);

6807 ià(
‹x
 !ğ
SH_EXTERNAL_TEMP_MASK
)

6808 
dev
->
‹m³¿tu»_aux2
 = 
‹x
;

6809 ià(
dev
->
pci_šfo
.
deviû_id
 == 0x1275) {

6810 
‹mp
 = 
dev
->
‹m³¿tu»_aux1
 + dev->
‹m³¿tu»_aux2
;

6812 ià(!
dev
->
‹m³¿tu»_aux1
 || !dev->
‹m³¿tu»_aux2
)

6813 
‹mp
 = 
dev
->
‹m³¿tu»_aux1
 + dev->
‹m³¿tu»_aux2
;

6815 
‹mp
 = (
dev
->
‹m³¿tu»_aux1
 + dev->
‹m³¿tu»_aux2
) / 2;

6817 ià(
‹mp
 < 100)

6818 
dev
->
‹m³¿tu»_æash
 = 
‹mp
;

6819 ià(
dev
->
‹m³¿tu»_æash
 > dev->
‹m³¿tu»_æash_max
)

6820 
dev
->
‹m³¿tu»_æash_max
 = dev->
‹m³¿tu»_æash
;

6822 ià(
dev
->
pci_šfo
.
deviû_id
 != 0x1275) {

6823 
code
 = 
	`»ad_»g_§ã
(
dev
, (
u32
 *)dev->
b¬
 + 
SH_TEMP_BOARD_OFFSET
);

6824 
‹x
 = ()((
code
 >> 
SH_EXTERNAL_TEMP_SHIFT
è& 
SH_EXTERNAL_TEMP_MASK
);

6825 ià(
‹x
 !ğ
SH_EXTERNAL_TEMP_MASK
)

6826 
‹mp
 = 
‹x
;

6829 ià(
‹mp
 < 100)

6830 
dev
->
‹m³¿tu»_bßrd
 = 
‹mp
;

6831 ià(
dev
->
‹m³¿tu»_bßrd
 > dev->
‹m³¿tu»_bßrd_max
)

6832 
dev
->
‹m³¿tu»_bßrd_max
 = dev->
‹m³¿tu»_bßrd
;

6836 
	}
}

6843 
	$g‘_ecc_codewÜd_size
(
shªnÚ_dev
 *
dev
)

6845 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

6846 ià((
dev
->
logicb_size
 =ğ4096è&& (dev->
ecc_codewÜds_š_logicb
 == 8))

6847 
dev
->
ecc_codewÜd_size
 = 540;

6848 ià((
dev
->
logicb_size
 =ğ4096è&& (dev->
ecc_codewÜds_š_logicb
 == 5))

6849 
dev
->
ecc_codewÜd_size
 = 848;

6850 ià((
dev
->
logicb_size
 =ğ512è&& (dev->
ecc_codewÜds_š_logicb
 == 1))

6851 
dev
->
ecc_codewÜd_size
 = 552;

6852 ià((
dev
->
logicb_size
 =ğ512è&& (dev->
ecc_codewÜds_š_logicb
 == 2))

6853 
dev
->
ecc_codewÜd_size
 = 289;

6855 
	`shªnÚ_”r
("unrecognized†ogicb_size=%d,ƒcc_codewords_in_logicb=%d.\n", \

6856 
dev
->
logicb_size
, dev->
ecc_codewÜds_š_logicb
);

6858 
	`shªnÚ_¥š_lock_bh
(&
dev
->
»gs_İ_lock
);

6859 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
SECTOR_SIZE
, dev->
logicb_size
/512);

6860 
	`shªnÚ_£t_»g
(&
dev
->
glob®_b¬
->
logicb
, 
ECC_CODEWORDS
, dev->
ecc_codewÜds_š_logicb
);

6861 
	`shªnÚ_¥š_uÆock_bh
(&
dev
->
»gs_İ_lock
);

6863 
dev
->
ecc_codewÜd_size
 = 
	`»ad_»g_§ã
(dev, &dev->
glob®_b¬
->
ecc
) >> 16;

6864 
	`debugs1
("ecc_codewÜd_sizeğ%d.\n", 
dev
->
ecc_codewÜd_size
);

6866 
	}
}

6868 
	$g‘_ecc_codewÜds_š_logicb
(
shªnÚ_dev
 *
sdev
)

6870 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

6871 
sdev
->
ecc_codewÜds_š_logicb
 = 5;

6874 
u32
 
ecc_ÿp
;

6876 
ecc_ÿp
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
b¬
->
ecc
);

6877 (
ecc_ÿp
 >> 8) & 0x000000ff) {

6879 
sdev
->
ecc_codewÜds_š_logicb
 = 8;

6882 
sdev
->
ecc_codewÜds_š_logicb
 = 5;

6885 ià(
sdev
->
æashid
 == 0xa954e5a42c || sdev->flashid == 0xa95464842c)

6886 
sdev
->
ecc_codewÜds_š_logicb
 = 4;

6888 
sdev
->
ecc_codewÜds_š_logicb
 = 3;

6891 
	`shªnÚ_”r
("uÄecognizedƒcøÿ·b™y 0x%x.\n", 
ecc_ÿp
);

6896 
	}
}

6898 
	$£t_h—d_couÁ
(
shªnÚ_dev
 *
sdev
)

6900 ià(
sdev
->
©omic_wr™e
 || sdev->
´iÜ™ize_wr™e
 || (sdev->
mbr
.
ã©u»_æags
 & 
SINGLE_HEAD_ENABLE
))

6901 
sdev
->
u£_du®_h—d
 = 0;

6903 
sdev
->
u£_du®_h—d
 = 1;

6905 ià(
sdev
->
u£_du®_h—d
)

6906 
sdev
->
h—d_couÁ
 = 2;

6908 
sdev
->
h—d_couÁ
 = 1;

6909 
	}
}

6911 
	$ÿlcuÏ‹_glob®_v¬ŸbË
(
shªnÚ_dev
 *
dev
)

6913 
i
;

6915 
dev
->
u£r_logicb_size
 = 1 << dev->
u£r_logicb_shiá
;

6916 
dev
->
logicb_size
 = 1 << dev->
logicb_shiá
;

6917 
dev
->
£ùÜs_š_logicb
 = dev->
logicb_size
 >> 9;

6918 
dev
->
Çnd_·ge_size
 = 1 << dev->
Çnd_·ge_shiá
;

6920 ià(
	`shªnÚ_dev_is_g5
(
dev
)) {

6921 
dev
->
logicbs_š_·ge
 = dev->
Çnd_·ge_size
 / dev->
logicb_size
;

6922 
	`ÿlcuÏ‹_µa_¡ruù
(
dev
);

6923 ià(
dev
->
¢­_»ad_’abË
) {

6924 ià(
dev
->
£ùÜs_codewÜd_addr
) {

6925 
	`shªnÚ_kä“
(
dev
->
£ùÜs_codewÜd_addr
);

6926 
dev
->
£ùÜs_codewÜd_addr
 = 
NULL
;

6928 
dev
->
£ùÜs_codewÜd_addr
 = 
	`shªnÚ_kz®loc
((è* dev->
logicbs_š_·ge
, 
GFP_SHANNON
);

6929 ià(!
dev
->
£ùÜs_codewÜd_addr
) {

6930 
	`shªnÚ_”r
("alloc sectors codeword‡ddr failed.\n");

6934 
i
 = 0; i < 
dev
->
logicbs_š_·ge
; i++) {

6935 
dev
->
£ùÜs_codewÜd_addr
[
i
] = 
	`g‘_codewÜd_addr
(dev, i);

6936 
	`debugs1
("£ùÜs_codewÜd_addr[%d] = 0x%x,‚£ùÜs=%d.", 
i
, 
dev
->
£ùÜs_codewÜd_addr
[i], 
	`g‘_£ùÜs_couÁ
(dev, i));

6940 ià(!(
dev
->
nÜ_mbr_¡©us
 & 
READ_FROM_NORFLASH
è|| (dev->
ecc_codewÜds_š_logicb
 == 0))

6941 
	`g‘_ecc_codewÜds_š_logicb
(
dev
);

6942 
	`g‘_ecc_codewÜd_size
(
dev
);

6943 
	`BUG_ON
(
dev
->
ecc_codewÜds_š_logicb
 > 1023);

6944 ià(
dev
->
ecc_by·ss
)

6945 
dev
->
fuÎ_£ùÜ_size
 = dev->
logicb_size
 + 
META_LEN
;

6947 
dev
->
fuÎ_£ùÜ_size
 = dev->
ecc_codewÜd_size
 * dev->
ecc_codewÜds_š_logicb
;

6948 
dev
->
logicbs_š_·ge
 = (dev->
Çnd_·ge_size
 + dev->
oob_size
)/dev->
fuÎ_£ùÜ_size
;

6950 
dev
->
sb_couÁ
 = dev->
eblocks_š_lun
/dev->
¶ªes
;

6952 
dev
->
fuÎ_·ge_size
 = dev->
fuÎ_£ùÜ_size
 * dev->
logicbs_š_·ge
;

6954 
dev
->
logicbs_š_chunk
 = dev->
logicbs_š_·ge
 * dev->
¶ªes
;

6955 
dev
->
logicbs_š_eblock
 = dev->
logicbs_š_·ge
 * dev->
·ges_š_eblock
;

6956 
dev
->
logicbs_š_·ge_¡re
 = dev->
logicbs_š_chunk
 * dev->
lun_couÁ
;

6957 
dev
->
·ges_š_siblšg_eblock
 = dev->
·ges_š_eblock
 * dev->
¶ªes
;

6958 
dev
->
logicbs_š_siblšg_eblock
 = dev->
·ges_š_siblšg_eblock
 * dev->
logicbs_š_·ge
;

6960 
dev
->
Çnd_·ge_ÿ·c™y
 = dev->
logicb_size
 * dev->
logicbs_š_·ge
;

6962 
dev
->
šŒ_big_shiá
[
HOT_INDEX
] = dev->
max_chªÃls
 * dev->
max_lun£t_š_chªÃl
 + HOT_INDEX;

6963 
dev
->
šŒ_big_shiá
[
COLD_INDEX
] = dev->
max_chªÃls
 * dev->
max_lun£t_š_chªÃl
 + COLD_INDEX;

6964 
dev
->
bufq_ack_šŒ_shiá
 = dev->
max_chªÃls
 * dev->
max_lun£t_š_chªÃl
 + 2;

6965 ià(!
	`shªnÚ_dev_is_g5_ff§
(
dev
))

6966 
dev
->
£u_šŒ_shiá
 = dev->
max_chªÃls
 * dev->
max_lun£t_š_chªÃl
 + 3;

6967 
dev
->
max_luns_š_group
 = dev->
lun_couÁ
/dev->
·r™y_groups
;

6969 
	`£t_h—d_couÁ
(
dev
);

6972 
	}
}

6975 
	$ş—r_©omic_´iÜ™ize_wr™e
(
shªnÚ_dev
 *
sdev
)

6977 
sdev
->
mbr
.
ã©u»_æags
 &ğ~
PRIORITIZE_WRITE
;

6978 
sdev
->
mbr
.
ã©u»_æags
 &ğ~
ATOMIC_WRITE
;

6979 
sdev
->
©omic_wr™e
 = 0;

6980 
sdev
->
´iÜ™ize_wr™e
 = 0;

6982 
	`£t_h—d_couÁ
(
sdev
);

6983 
	}
}

6985 
	$ÿlcuÏ‹_physiÿl_ÿ·c™y
(
shªnÚ_dev
 *
dev
)

6987 
i
 = 0;

6988 
shªnÚ_sb
 *
sb
;

6989 
max_£ùÜs
 = 0;

6991 
i
 = 
dev
->
mbr_eblocks
/dev->
¶ªes
; i < dev->
sb_couÁ
; i++) {

6992 ià(
dev
->
sbs
[
i
].
¡©e
 !ğ
DISCARDED_BLOCK
) {

6993 
sb
 = 
dev
->
sbs
 + 
i
;

6994 
max_£ùÜs
 +ğ
sb
->
mš_d©a_luns
 * 
dev
->
max_avaabË_groups
 * dev->
logicbs_š_siblšg_eblock
 - sb->
logicbs_š_•og
;

6997 
max_£ùÜs
 -ğ
GC_THROTTLE_BAR
 * 
dev
->
max_avaabË_luns
 * dev->
logicbs_š_siblšg_eblock
;

6998 
max_£ùÜs
 *ğ
dev
->
logicb_size
 >> 9;

6999 
	`debugs4
("physiÿÈÿ·c™yğ%lu (š k”ÃÈ£ùÜ).\n", 
max_£ùÜs
);

7001  
max_£ùÜs
;

7003 
	}
}

7005 
	$ÿlcuÏ‹_ov”´ovisiÚ_¿‹
(
shªnÚ_dev
 *
sdev
)

7007 
sdev
->
max_£ùÜs
 = 
	`ÿlcuÏ‹_physiÿl_ÿ·c™y
(sdev);

7008 
sdev
->
ov”´ovisiÚ_¿‹
 = 10000 - sdev->
sdisk
.
£ùÜs
 * 10000 / sdev->
max_£ùÜs
;

7009  
sdev
->
ov”´ovisiÚ_¿‹
;

7010 
	}
}

7012 cÚ¡ *
	$´št_acûss_mode
(
acûss_mode
)

7014 
acûss_mode
)

7016 
SHN_MODE_READWRITE
:

7018 
SHN_MODE_REDUCED_WRITE
:

7020 
SHN_MODE_READONLY
:

7025 
	}
}

7029 
	$upd©e_acûss_mode
(
shªnÚ_dev
 *
dev
)

7031 ià(
dev
->
»adÚly_»asÚ
) {

7032 ià(
shªnÚ_fÜû_rw
) {

7033 
dev
->
acûss_mode
 = 
SHN_MODE_READWRITE
;

7034 
	`shªnÚ_šfo
("%s: iÀ»adÚly modbuˆshªnÚ_fÜû_rwğ%d, s‘ disk„w.\n", 
dev
->
cdev_Çme
, 
shªnÚ_fÜû_rw
);

7036 
dev
->
acûss_mode
 = 
SHN_MODE_READONLY
;

7037 } ià(
dev
->
»duûd_wr™e_»asÚ
)

7038 
dev
->
acûss_mode
 = 
SHN_MODE_REDUCED_WRITE
;

7040 
dev
->
acûss_mode
 = 
SHN_MODE_READWRITE
;

7042 ià(
dev
->
¥oŞ
)

7043 
	`¥oŞ_upd©e_acûss_mode
(
dev
->
¥oŞ
);

7045 ià(
dev
->
sdisk
.
gd
) {

7046 ià(
dev
->
acûss_mode
 =ğ
SHN_MODE_READONLY
) {

7047 
	`shªnÚ_£t_disk_ro
(
dev
->
sdisk
.
gd
, 1);

7049 
	`shªnÚ_£t_disk_ro
(
dev
->
sdisk
.
gd
, 0);

7052 
	`shªnÚ_šfo
("%s: %s,„eadonly_reason= %x,„educed_write_reason= %x.\n",

7053 
dev
->
cdev_Çme
, 
	`´št_acûss_mode
(dev->
acûss_mode
), dev->
»adÚly_»asÚ
, dev->
»duûd_wr™e_»asÚ
);

7054  
dev
->
acûss_mode
;

7055 
	}
}

7057 
	$upd©e_acûss_mode_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

7059 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
acûss_mode_wÜk
);

7060 
	`upd©e_acûss_mode
(
sdev
);

7061 
	}
}

7063 
	$shªnÚ_š™_blk_queue
(
shªnÚ_dev
 *
sdev
)

7065 ià(
sdev
->
sdisk
.
queue
)

7067 
sdev
->
sdisk
.
queue
 = 
	`shªnÚ_ü—‹_blkqueue
(sdev, &sdev->sdisk.
queue_lock
, 0);

7068 ià(
sdev
->
sdisk
.
queue
 =ğ
NULL
)

7069  -
ENOMEM
;

7071 
sdev
->
majÜ
 = 
shªnÚ_majÜ
;

7072 
	`shªnÚ_Œim_£‰šg
(
sdev
->
sdisk
.
queue
);

7073 
	`shªnÚ_rÙ©iÚ®_£‰šg
(
sdev
->
sdisk
.
queue
);

7074 
	`shªnÚ_blk_queue_max_hw_£ùÜs
(
sdev
->
sdisk
.
queue
, 
SHN_BLK_DEF_MAX_SECTORS
);

7075 
	`shªnÚ_blk_queue_block_size
(
sdev
->
sdisk
.
queue
, sdev->
u£r_logicb_size
, sdev->
logicb_size
);

7076 
	`shªnÚ_blk_queue_io_mš
(
sdev
->
sdisk
.
queue
, sdev->
logicb_size
);

7077 
	`shªnÚ_blk_queue_io_İt
(
sdev
->
sdisk
.
queue
, sdev->
logicb_size
 * sdev->
logicbs_š_chunk
);

7080 
	}
}

7083 
	$shªnÚ_©ch_sdev
(
shªnÚ_dev
 *
dev
)

7086 ià(
dev
->
sdisk
.
gd
) {

7087 
	`shªnÚ_”r
("g’disk /dev/% ®»adyƒxi¡s.\n", 
dev
->
sdisk
.
disk_Çme
);

7091 
dev
->
sdisk
.
gd
 = 
	`shªnÚ_®loc_disk
(
SHANNON_MINORS
);

7092 ià(!
dev
->
sdisk
.
gd
) {

7093 
	`shªnÚ_”r
("%s:‡Îoc_disk faed.\n", 
dev
->
sdisk
.
disk_Çme
);

7098 
	`shªnÚ_š™_g’disk
(
dev
->
sdisk
.
gd
, dev->sdisk.
disk_Çme
, dev->
majÜ
, 
SHANNON_MINORS
, dev->
drive_no
 * SHANNON_MINORS, dev->sdisk.
queue
, dev);

7099 
	`shªnÚ_£t_ÿ·c™y
(
dev
->
sdisk
.
gd
, dev->sdisk.
£ùÜs
);

7100 ià(
dev
->
ho¡_»ad_£ùÜs
 > dev->
ho¡_»ad_£ùÜs_hi¡Üy
)

7101 
dev
->
ho¡_»ad_£ùÜs_hi¡Üy
 = dev->
ho¡_»ad_£ùÜs
;

7102 
	`shªnÚ_add_disk
(
dev
->
sdisk
.
gd
);

7104 ià(
	`shªnÚ_sysfs_lšk
(&
dev
->
sysfs_kobj
)) {

7105 
	`shªnÚ_”r
("%s:†šk kobjeùØsysf çed.\n", 
dev
->
sdisk
.
disk_Çme
);

7106 
	`shªnÚ_d‘ach
(
dev
);

7109 
	`debugs1
("%s: sysf objeù†šk dÚe.\n", 
dev
->
sdisk
.
disk_Çme
);

7110 
dev
->
sysfs_š™_dÚe
 = 
SYSFS_LINK_DONE
;

7112 
dev
->
h¬d_queue_lim™
 = 0;

7113 
dev
->
cmd_queue_wr™es_lim™
 = 
	`DEFAULT_CMD_QUEUE_WRITES_THRESHOLD_H
(dev);

7115 
	`shªnÚ_šfo
("A‰ached Dœeù-IO PCIFÏsh /dev/% a block deviû /dev/%s:\n", 
dev
->
cdev_Çme
, dev->
sdisk
.
disk_Çme
);

7116 
	`shªnÚ_šfo
("sector size:†ogical %d /…hysical %d, capacity: %d GB, overprovision: %d.%d%%.\n", \

7117 
dev
->
u£r_logicb_size
, dev->
logicb_size
, ()(dev->
sdisk
.
£ùÜs
 * 512 / 1000000000), dev->
ov”´ovisiÚ_¿‹
 / 100, dev->overprovision_rate % 100);

7119 
	}
}

7121 
	$shªnÚ_©ch
(
shªnÚ_dev
 *
sdev
)

7123 
»t
;

7124 
sdev
->
ov”´ovisiÚ_¿‹
 = 
	`ÿlcuÏ‹_ov”´ovisiÚ_¿‹
(sdev);

7125 ià(
sdev
->
ov”´ovisiÚ_¿‹
 <= 0) {

7126 
	`shªnÚ_”r
("%s:„equested capacity %llu is beyond…hysical capability %llu.\n",

7127 
sdev
->
sdisk
.
disk_Çme
, sdev->sdisk.
£ùÜs
, sdev->
max_£ùÜs
);

7130 ià(
sdev
->
ov”´ovisiÚ_¿‹
 < 
SHN_OVERPROVISION_THRESHOLD
) {

7131 
	`shªnÚ_w¬n
("%s: overprovision is belowhreshold %d%% dueo dynamic bad block, set disk„eadonly.\n",

7132 
sdev
->
sdisk
.
disk_Çme
, 
SHN_OVERPROVISION_THRESHOLD
);

7133 
	`shªnÚ_£t_b™
(
SHN_REASON_LOW_OVERPROVISION
, &
sdev
->
»adÚly_»asÚ
);

7136 
	`shªnÚ_š™_blk_queue
(
sdev
);

7138 ià(
shªnÚ_scsi_mode
)

7139 
»t
 = 
	`shªnÚ_©ch_scsi
(
sdev
->
sdisk
.
ho¡d©a
, sdev->
pci_dev
);

7141 
»t
 = 
	`shªnÚ_©ch_sdev
(
sdev
);

7142 ià(
»t
)

7143  
»t
;

7144 
sdev
->
¡©e
 = (sdev->¡©& 
SHN_STATE_ERROR_BIT
è| 
SHN_STATE_ATTACHED
;

7145 
sdev
->
sdisk
.
©ched
 = 
SHN_DISK_ATTACHED
;

7146 
	`upd©e_acûss_mode
(
sdev
);

7148 ià(
sdev
->
sdisk
.
´št_Ï‹ncy_š‹rv®
)

7149 
	`¡¬t_´št_Ï‹ncy_tim”
(&
sdev
->
sdisk
);

7153 
	}
}

7155 
	$shªnÚ_d‘ach
(
shªnÚ_dev
 *
dev
)

7157 
dev
->
sdisk
.
©ched
 = 
SHN_DISK_DETACHED
;

7158 
	`¡İ_´št_Ï‹ncy_tim”
(&
dev
->
sdisk
);

7159 ià(
shªnÚ_scsi_mode
)

7160 
	`shªnÚ_d‘ach_scsi
(
dev
->
sdisk
.
ho¡d©a
);

7162 ià(
dev
->
sdisk
.
gd
) {

7163 ià(
dev
->
ho¡_»ad_£ùÜs
 > dev->
ho¡_»ad_£ùÜs_hi¡Üy
)

7164 
dev
->
ho¡_»ad_£ùÜs_hi¡Üy
 = dev->
ho¡_»ad_£ùÜs
;

7166 ià(
dev
->
sysfs_š™_dÚe
 =ğ
SYSFS_LINK_DONE
) {

7167 
	`shªnÚ_sysfs_uÆšk
(&
dev
->
sysfs_kobj
);

7168 
dev
->
sysfs_š™_dÚe
 = 
SYSFS_INIT_DONE
;

7170 
	`shªnÚ_d–_g’disk
(
dev
->
sdisk
.
gd
);

7171 
	`shªnÚ_put_disk
(
dev
->
sdisk
.
gd
);

7172 
dev
->
sdisk
.
gd
 = 
NULL
;

7173 
	`shªnÚ_šfo
("D‘ached Dœeù-IO PCIFÏsh /dev/% äom OS.\n", 
dev
->
sdisk
.
disk_Çme
);

7175 ià(
dev
->
sdisk
.
queue
) {

7176 
	`shªnÚ_blk_ş—nup_queue
(
dev
->
sdisk
.
queue
);

7177 
dev
->
sdisk
.
queue
 = 
NULL
;

7181 
dev
->
¡©e
 = (dev->¡©& 
SHN_STATE_ERROR_BIT
è| 
SHN_STATE_DETACHED
;

7183 
	}
}

7185 
	$check_the_d©e
()

7187 
shªnÚ_timev®
 
tv
;

7188 
tmp
;

7192 
	`shªnÚ_do_g‘timeofday
(&
tv
);

7194 
tmp
 = 
tv
.
tv_£c
 / 31566;

7197  (
tmp
 < 44000)?0:-1;

7198 
	}
}

7200 
	$®loc_lun£ts_¡ruùu»
(
shªnÚ_dev
 *
sdev
)

7202 
i
 = 0, 
j
 = 0;

7204 
shªnÚ_pci_dev_t
 *
pdev
 = 
sdev
->
pci_dev
;

7206 
sdev
->
lun£ts
 = 
	`shªnÚ_vm®loc
((
shªnÚ_lun£t
è* sdev->
lun£t_couÁ
);

7207 ià(!
sdev
->
lun£ts
) {

7208 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for LUN_SET.\n");

7211 
	`shªnÚ_mem£t
(
sdev
->
lun£ts
, 0x00, (
shªnÚ_lun£t
è* sdev->
lun£t_couÁ
);

7213 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

7214 
sdev
->
lun£ts
[
i
].
šdex
 = i;

7215 
sdev
->
lun£ts
[
i
].sdev = sdev;

7216 
sdev
->
lun£ts
[
i
].
sq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(
pdev
, 
QUEUE_SIZE
,

7217 &
sdev
->
lun£ts
[
i
].
sq_dma_addr
, 
GFP_SHANNON
);

7218 ià(
sdev
->
lun£ts
[
i
].
sq_addr
 =ğ
NULL
)

7220 
sdev
->
lun£ts
[
i
].
cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(
pdev
, 
QUEUE_SIZE
,

7221 &
sdev
->
lun£ts
[
i
].
cq_dma_addr
, 
GFP_SHANNON
);

7222 ià(
sdev
->
lun£ts
[
i
].
cq_addr
 =ğ
NULL
)

7224 
sdev
->
lun£ts
[
i
].
lun£t_ûs
 = 
	`shªnÚ_kz®loc
((
shªnÚ_û
è* sdev->
max_û_š_lun£t
, 
GFP_SHANNON
);

7225 ià(!
sdev
->
lun£ts
[
i
].
lun£t_ûs
) {

7226 
	`shªnÚ_”r
("ÿÂÙ‡Îoø’ough memÜy fÜ†un£t(%dèCE.\n", 
i
);

7229 
j
 = 0; j < 
sdev
->
max_û_š_lun£t
; j++) {

7230 
sdev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
šdex_š_lun£t
 = j;

7231 
sdev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
ã©u»_æags
 = 0;

7232 
sdev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
lun£t
 = &sdev->lunsets[i];

7233 
sdev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
luns
 = 
	`shªnÚ_kz®loc
((
shªnÚ_lun
 *è* sdev->
max_lun_š_û
, 
GFP_SHANNON
);

7234 ià(!
sdev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
luns
) {

7235 
	`shªnÚ_”r
("ÿÂÙ‡Îoø’ough memÜy fÜ†un£t(%dèCE(%d).\n", 
i
, 
j
);

7239 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
lun£ts
[
i
].
wa™_cmd_pos
);

7241 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

7242 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
lun£ts
[
i
].
emu_wa™
);

7243 
sdev
->
lun£ts
[
i
].
emu_th»ad
 = 
	`shªnÚ_kth»ad_run
(
emuÏtÜ_th»ad
, &sdev->lunsets[i], "shannon_emu%d", i);

7244 ià(
	`SHANNON_IS_ERR
(
sdev
->
lun£ts
[
i
].
emu_th»ad
)) {

7245 
	`shªnÚ_”r
("createƒmulatorhread failed!\n");

7246  
	`SHANNON_PTR_ERR
(
sdev
->
lun£ts
[
i
].
emu_th»ad
);

7248 
sdev
->
lun£ts
[
i
].
sq_h—d
 = 0;

7250 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

7251 
sdev
->
lun£ts
[
i
].
lun_b¬
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * i));

7252 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
sq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr0
);

7253 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
sq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr1
);

7254 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
cq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr0
);

7255 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
cq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr1
);

7257 
sdev
->
lun£ts
[
i
].
sq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
sq_h—d
);

7258 
sdev
->
lun£ts
[
i
].
sq_h—d
 = sdev->lun£ts[i].
sq_hw_h—d
;

7259 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
cq_h—d
);

7260 
sdev
->
lun£ts
[
i
].
cq_h—d
 = sdev->lun£ts[i].
cq_hw_h—d
;

7261 
sdev
->
lun£ts
[
i
].
cq_
 = sdev->lun£ts[i].
cq_h—d
;

7262 
sdev
->
lun£ts
[
i
].
cq__tmp
 = sdev->lun£ts[i].
cq_h—d
;

7263 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

7265 
sdev
->
lun£ts
[
i
].
sq_h—d_tmp
 = sdev->lun£ts[i].
sq_h—d
;

7266 
	`shªnÚ_mu‹x_š™
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

7267 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
lun£ts
[
i
].
lun_b¬_lock
);

7268 
	`shªnÚ_mu‹x_š™
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

7269 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
lun£ts
[
i
].
»q_queue
);

7270 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
lun£ts
[
i
].
»q_queue_lock
);

7271 
	`shªnÚ_š™_wÜk
(&
sdev
->
lun£ts
[
i
].
comp_wÜk
, 
hªdË_lun£t_sk
);

7272 
	`shªnÚ_š™_wÜk
(&
sdev
->
lun£ts
[
i
].
subm™_wÜk
, 
shªnÚ_lun£t_sk
);

7273 
	`shªnÚ_©omic_£t
(&
sdev
->
lun£ts
[
i
].
š_wq
, 0);

7275 
j
 = 0; j < 512; j++) {

7276 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
lun£ts
[
i
].
cmd_šfo
[
j
].
»q_li¡
);

7277 
sdev
->
lun£ts
[
i
].
cmd_šfo
[
j
].
cmd_Ën
 = 8;

7282 
	}
}

7284 
	$»Ëa£_lun£ts_¡ruùu»
(
shªnÚ_dev
 *
dev
)

7286 
i
, 
j
;

7288 ià(
dev
->
lun£ts
) {

7289 
i
 = 0; i < 
dev
->
lun£t_couÁ
; i++) {

7290 #ià
	`defšed
(
CONFIG_SHANNON_EMU
)||defšed(
CONFIG_SHANNON_EMU_MODULE
)

7291 ià(!
	`SHANNON_IS_ERR_OR_NULL
(
dev
->
lun£ts
[
i
].
emu_th»ad
))

7292 
	`shªnÚ_kth»ad_¡İ
(
dev
->
lun£ts
[
i
].
emu_th»ad
);

7294 ià(
dev
->
lun£ts
[
i
].
sq_addr
)

7295 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)dev->
lun£ts
[
i
].
sq_addr
, dev->lun£ts[i].
sq_dma_addr
);

7296 ià(
dev
->
lun£ts
[
i
].
cq_addr
)

7297 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
dev
->
pci_dev
, 
QUEUE_SIZE
, (*)dev->
lun£ts
[
i
].
cq_addr
, dev->lun£ts[i].
cq_dma_addr
);

7298 ià(
dev
->
lun£ts
[
i
].
lun£t_ûs
) {

7299 
j
 = 0; j < 
dev
->
max_û_š_lun£t
; j++) {

7300 ià(
dev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
luns
)

7301 
	`shªnÚ_kä“
(
dev
->
lun£ts
[
i
].
lun£t_ûs
[
j
].
luns
);

7303 
	`shªnÚ_kä“
(
dev
->
lun£ts
[
i
].
lun£t_ûs
);

7306 
	`shªnÚ_vä“
(
dev
->
lun£ts
);

7308 
	}
}

7310 
	$®loc_lun_¡ruùu»
(
shªnÚ_dev
 *
sdev
)

7312 
i
 = 0;

7314 
sdev
->
lun
 = 
	`shªnÚ_kz®loc
((
shªnÚ_lun
 *è* sdev->
lun_couÁ
, 
GFP_SHANNON
);

7315 ià(!
sdev
->
lun
) {

7316 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for LUN.\n");

7319 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

7320 
sdev
->
lun
[
i
] = 
	`shªnÚ_kz®loc
((
shªnÚ_lun
), 
GFP_SHANNON
);

7321 ià(!
sdev
->
lun
[
i
]) {

7322 
	`shªnÚ_”r
("ÿÂÙ‡Îoÿ‹ƒnough memÜy fÜ LUN[%d].\n", 
i
);

7325 
sdev
->
lun
[
i
]->
bbt
 = 
	`shªnÚ_km®loc
(
LUN_BBT_SIZE
, 
GFP_SHANNON
);

7326 ià(!
sdev
->
lun
[
i
]->
bbt
) {

7327 
	`shªnÚ_”r
("ÿÂÙ‡Îoÿ‹ƒnough memÜy fÜ†un_bbˆ[lun=%d].\n", 
i
);

7330 
	`shªnÚ_©omic_£t
(&
sdev
->
lun
[
i
]->
ava_d©a_sbs
, sdev->
sb_couÁ
 - sdev->
mbr_eblocks
/sdev->
¶ªes
);

7331 
	`debugs1
("i=%d,‡va_d©a_sbs=%d.\n", 
i
, 
	`shªnÚ_©omic_»ad
(&
sdev
->
lun
[i]->
ava_d©a_sbs
));

7332 
	`shªnÚ_©omic_£t
(&
sdev
->
lun
[
i
]->
ecc_çu»_times
, 0);

7333 
	`shªnÚ_©omic_£t
(&
sdev
->
lun
[
i
]->
adv_»ad_çu»_times
, 0);

7334 
	`shªnÚ_©omic_£t
(&
sdev
->
lun
[
i
]->
dyÇmic_bad_blkút
, 0);

7336 
	`shªnÚ_mem£t
(
sdev
->
lun
[
i
]->
bbt
, 0xFF, 
LUN_BBT_SIZE
);

7337 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
lun
[
i
]->
bbt_lock
);

7338 
	`shªnÚ_©omic_£t
(&
sdev
->
lun
[
i
]->
Ãxt_em±y_·ge
, 0);

7339 
	`shªnÚ_mu‹x_š™
(&
sdev
->
lun
[
i
]->
»äesh_£m
);

7340 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
lun
[
i
]->
»äesh_Úe_mbr_eblk_dÚe_ev’t
);

7341 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
lun
[
i
]->
upd©e_poŞ_šfo_dÚe_ev’t
);

7343 
sdev
->
lun
[
i
]->sdev = sdev;

7344 
sdev
->
lun
[
i
]->
lun_num
 = i;

7345 
sdev
->
lun
[
i
]->
phy_lun_num
 = 
logiÿl_lun_to_phy_lun
[sdev->
mbr
.
lun_m­_mode
](sdev, i);

7346 
sdev
->
lun
[
i
]->
lun£t
 = &sdev->
lun£ts
[sdev->lun[i]->
phy_lun_num
 / sdev->
max_lun_š_lun£t
];

7347 
sdev
->
lun
[
i
]->
û
 = &sdev->lun[i]->
lun£t
->
lun£t_ûs
[(sdev->lun[i]->
phy_lun_num
 / sdev->
max_lun_š_û
è% sdev->
max_û_š_lun£t
];

7348 
sdev
->
lun
[
i
]->
û
->
luns
[sdev->lun[i]->
phy_lun_num
 % sdev->
max_lun_š_û
] = sdev->lun[i];

7350 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

7351 
sdev
->
lun
[
i
]->
emu_lun
 = &
emu_luns
[sdev->lun[i]->
phy_lun_num
];

7352 
emu_luns
[
sdev
->
lun
[
i
]->
phy_lun_num
].
logiÿl_lun
 = i;

7353 
	`shªnÚ_šfo
("%s(): Lun=%dƒmuÏtÜ†un×dd»ss=0x%lx).\n", 
__func__
, 
i
, ()
sdev
->
lun
[i]->
emu_lun
);

7355 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

7356 ià(
sdev
->
šv®id_æashids
[
i
])

7357 
sdev
->
lun
[
i
]->
bad
 = 1;

7359 ià(!
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
)) {

7360 ià(
	`lun_»ad_id
(
sdev
->
lun
[
i
]) < 0) {

7361 
sdev
->
lun
[
i
]->
bad
 = 1;

7362 
	`shªnÚ_w¬n
("lun_read_id failed.†un=%d,…hy_lun_num=%d.",

7363 
i
, 
sdev
->
lun
[i]->
phy_lun_num
);

7366 
	`debugs1
("lun=%d,…hy_lun_num=%d i physiÿÎy bad.\n", 
i
, 
sdev
->
lun
[i]->
phy_lun_num
);

7370 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
lun
[
i
]->
check_lock
);

7371 
sdev
->
lun
[
i
]->
commªd_timeout_út
 = 0;

7372 
sdev
->
lun
[
i
]->
”r_checkšg
 = 0;

7373 
sdev
->
lun
[
i
]->
su¥icious_bad_lun
 = 0;

7374 
	`shªnÚ_©omic_£t
(&
sdev
->
lun
[
i
]->
”r_blocks
, 0);

7375 
	`shªnÚ_š™_wÜk
(&
sdev
->
lun
[
i
]->
”r_checkšg_wÜk
, 
shªnÚ_lun_”r_checkšg_sk
);

7376 
	`shªnÚ_š™_wÜk
(&
sdev
->
lun
[
i
]->
»ad_su¥icious_bad_lun_wÜk
, 
»ad_su¥icious_bad_lun_sk
);

7379 
sdev
->
pba_bË_size
 = 
	`SHN_PAGE_ALIGN
((sdev->
logicbs_š_·ge
 * sdev->
·ges_š_eblock
 * sdev->
eblocks_š_lun
 * 
PBA_ENTRY_LEN
 + 8)/8);

7380 
	`debugs4
("pba_bË_size=%d.\n", 
sdev
->
pba_bË_size
);

7381 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

7382 
shªnÚ_lun
 *
lun
 = 
sdev
->lun[
i
];

7383 ià(
	`shªnÚ_‹¡_b™
(
lun
->
phy_lun_num
, (*)
sdev
->
mbr
.
bad_phy_lun_m­
))

7385 
sdev
->
lun
[
i
]->
pba_bË
 = 
	`shªnÚ_vm®loc
(sdev->
pba_bË_size
);

7386 ià(!
sdev
->
lun
[
i
]->
pba_bË
) {

7387 
	`shªnÚ_”r
("ÿÂÙ‡Îoÿ‹ƒnough memÜy fÜ…ba_bË [lun=%d].\n", 
i
);

7390 
	`shªnÚ_mem£t
(
sdev
->
lun
[
i
]->
pba_bË
, 
ALL_STALE
, sdev->
pba_bË_size
);

7394 
	}
}

7396 
	$»Ëa£_lun_¡ruùu»
(
shªnÚ_dev
 *
dev
)

7398 
i
;

7400 ià(
dev
->
lun
) {

7401 
i
 = 0; i < 
dev
->
lun_couÁ
; i++) {

7402 ià(
dev
->
lun
[
i
]) {

7403 ià(
dev
->
lun
[
i
]->
pba_bË
)

7404 
	`shªnÚ_vä“
(
dev
->
lun
[
i
]->
pba_bË
);

7405 ià(
dev
->
lun
[
i
]->
bbt
)

7406 
	`shªnÚ_kä“
(
dev
->
lun
[
i
]->
bbt
);

7407 
	`shªnÚ_kä“
(
dev
->
lun
[
i
]);

7410 
	`shªnÚ_kä“
(
dev
->
lun
);

7412 
	}
}

7414 
	#MAX_CALLBACK_WQ_COUNT
 12

	)

7415 
	#SINGLE_WQ_COUNT
 9

	)

7416 
	$®loc_wÜkqueues
(
shªnÚ_dev
 *
dev
)

7418 
i
 = 0, 
num
 = 0;

7419 *
wq
;

7421 
dev
->
shªnÚ_Ä_wq
 = 
	`mš_t
(, 2, 
	`g‘_num_Úlše_ıus
()/2);

7422 ià(
dev
->
shªnÚ_Ä_wq
 == 0)

7423 
dev
->
shªnÚ_Ä_wq
 = 1;

7424 
dev
->
ÿÎback_Ä_wq
 = (
	`g‘_num_Úlše_ıus
(è> 
MAX_CALLBACK_WQ_COUNT
) ? MAX_CALLBACK_WQ_COUNT : get_num_online_cpus();

7425 ià(
dev
->
ÿÎback_Ä_wq
 < 4)

7426 
dev
->
ÿÎback_Ä_wq
 = 4;

7428 
dev
->
wÜkqueue_couÁ
 = 
SINGLE_WQ_COUNT
 + dev->
shªnÚ_Ä_wq
 + dev->
ÿÎback_Ä_wq
;

7429 
dev
->
wÜkqueue_Çme
 = 
	`shªnÚ_kz®loc
((*è* dev->
wÜkqueue_couÁ
, 
GFP_SHANNON
);

7431 ià(
dev
->
wÜkqueue_Çme
 =ğ
NULL
) {

7432 
	`shªnÚ_w¬n
("allocate workqueue_name failed!\n");

7436 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_comp_wq%c", 'a' + dev->
drive_no
);

7437 ià(
shªnÚ_u£_¹_comp_th»ad
)

7438 
wq
 = 
dev
->
shªnÚ_¹_comp_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_¹_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7440 
wq
 = 
dev
->
shªnÚ_comp_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]) ;

7441 ià(
wq
 =ğ
NULL
) {

7442 
	`shªnÚ_w¬n
("create shannon completion workqueue failed!\n");

7445 
num
++;

7447 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_wq%c", 'a' + dev->
drive_no
);

7448 
dev
->
shªnÚ_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7449 ià(
dev
->
shªnÚ_wq
 =ğ
NULL
) {

7450 
	`shªnÚ_w¬n
("create shannon workqueue failed!\n");

7453 
num
++;

7455 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_»ad_wq%c", 'a' + dev->
drive_no
);

7456 
dev
->
shªnÚ_»ad_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7457 ià(
dev
->
shªnÚ_»ad_wq
 =ğ
NULL
) {

7458 
	`shªnÚ_w¬n
("create shannon„ead workqueue failed!\n");

7461 
num
++;

7463 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_³riod_»ad_wq%c", 'a' + dev->
drive_no
);

7464 
dev
->
shªnÚ_³riod_»ad_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7465 ià(
dev
->
shªnÚ_³riod_»ad_wq
 =ğ
NULL
) {

7466 
	`shªnÚ_w¬n
("create shannon„ead workqueue failed!\n");

7469 
num
++;

7471 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_misc_wq%c", 'a' + dev->
drive_no
);

7472 
dev
->
misc_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7473 ià(
dev
->
misc_wq
 =ğ
NULL
) {

7474 
	`shªnÚ_w¬n
("create shannon watchdog workqueue failed!\n");

7477 
num
++;

7479 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_»äesh_wq%c", 'a' + dev->
drive_no
);

7480 
dev
->
»äesh_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7481 ià(
dev
->
»äesh_wq
 =ğ
NULL
) {

7482 
	`shªnÚ_w¬n
("create shannon„efresh workqueue failed!\n");

7485 
num
++;

7487 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_»ad_”r_wq%c", 'a' + dev->
drive_no
);

7488 
dev
->
»ad_”r_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7489 ià(
dev
->
»ad_”r_wq
 =ğ
NULL
) {

7490 
	`shªnÚ_w¬n
("create shannon„ead_err workqueue failed!\n");

7493 
num
++;

7495 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_gc_wq%c", 'a' + dev->
drive_no
);

7496 
dev
->
gc_tim”_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7497 ià(
dev
->
gc_tim”_wq
 =ğ
NULL
) {

7498 
	`shªnÚ_w¬n
("create shannon gc_timer workqueue failed!\n");

7501 
num
++;

7503 
dev
->
wÜkqueue_Çme
[
num
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_wl_wq%c", 'a' + dev->
drive_no
);

7504 
dev
->
wl_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
]);

7505 ià(
dev
->
wl_wq
 =ğ
NULL
) {

7506 
	`shªnÚ_w¬n
("create shannon wear†eveling workqueue failed!\n");

7509 
num
++;

7511 
	`BUG_ON
(
num
 !ğ
SINGLE_WQ_COUNT
);

7512 
dev
->
hªdË_lun_wq
 = 
	`shªnÚ_km®loc
((
shªnÚ_wÜkqueue_¡ruù_t
 *è* dev->
shªnÚ_Ä_wq
, 
GFP_SHANNON
);

7513 ià(
dev
->
hªdË_lun_wq
 =ğ
NULL
) {

7514 
	`shªnÚ_w¬n
("allocate handle_lun_wq failed!\n");

7517 
i
 = 0; i < 
dev
->
shªnÚ_Ä_wq
; i++) {

7518 
dev
->
wÜkqueue_Çme
[
num
 + 
i
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_hªdË_lun%c/%d", 'a' + dev->
drive_no
, i);

7519 
dev
->
hªdË_lun_wq
[
i
] = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
 + i]);

7520 ià(
dev
->
hªdË_lun_wq
[
i
] =ğ
NULL
) {

7521 
	`shªnÚ_w¬n
("create handle_lun workqueue failed!\n");

7526 
dev
->
shªnÚ_ÿÎback_wq
 = 
	`shªnÚ_km®loc
((
shªnÚ_wÜkqueue_¡ruù_t
 *è* dev->
ÿÎback_Ä_wq
, 
GFP_SHANNON
);

7527 ià(
dev
->
shªnÚ_ÿÎback_wq
 =ğ
NULL
) {

7528 
	`shªnÚ_w¬n
("allocate shannon_callback_wq failed!\n");

7531 
i
 = 0; i < 
dev
->
ÿÎback_Ä_wq
; i++) {

7532 
dev
->
wÜkqueue_Çme
[
num
 + dev->
shªnÚ_Ä_wq
 + 
i
] = 
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_ÿÎback%c/%d", 'a' + dev->
drive_no
, i);

7533 
dev
->
shªnÚ_ÿÎback_wq
[
i
] = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(dev->
wÜkqueue_Çme
[
num
 + dev->
shªnÚ_Ä_wq
 + i]);

7534 ià(
dev
->
shªnÚ_ÿÎback_wq
[
i
] =ğ
NULL
) {

7535 
	`shªnÚ_w¬n
("create shannon callback workqueue failed!\n");

7541 
	}
}

7543 
	$»Ëa£_wÜkqueues
(
shªnÚ_dev
 *
dev
)

7545 
i
;

7547 ià(
dev
->
wl_wq
)

7548 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
wl_wq
);

7549 ià(
dev
->
gc_tim”_wq
)

7550 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
gc_tim”_wq
);

7551 ià(
dev
->
»ad_”r_wq
)

7552 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
»ad_”r_wq
);

7553 ià(
dev
->
»äesh_wq
)

7554 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
»äesh_wq
);

7555 ià(
dev
->
misc_wq
)

7556 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
misc_wq
);

7557 ià(
dev
->
shªnÚ_»ad_wq
)

7558 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
shªnÚ_»ad_wq
);

7559 ià(
dev
->
shªnÚ_wq
)

7560 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
shªnÚ_wq
);

7561 ià(
dev
->
shªnÚ_³riod_»ad_wq
)

7562 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
shªnÚ_³riod_»ad_wq
);

7563 ià(
dev
->
hªdË_lun_wq
) {

7564 
i
 = 0; i < 
dev
->
shªnÚ_Ä_wq
; i++) {

7565 ià(
dev
->
hªdË_lun_wq
[
i
])

7566 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
hªdË_lun_wq
[
i
]);

7568 
	`shªnÚ_kä“
(
dev
->
hªdË_lun_wq
);

7570 ià(
dev
->
shªnÚ_comp_wq
)

7571 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
shªnÚ_comp_wq
);

7572 ià(
dev
->
shªnÚ_¹_comp_wq
)

7573 
	`shªnÚ_de¡roy_¹_wÜkqueue
(
dev
->
shªnÚ_¹_comp_wq
);

7574 ià(
dev
->
shªnÚ_ÿÎback_wq
) {

7575 
i
 = 0; i < 
dev
->
ÿÎback_Ä_wq
; i++) {

7576 ià(
dev
->
shªnÚ_ÿÎback_wq
[
i
])

7577 
	`shªnÚ_de¡roy_wÜkqueue
(
dev
->
shªnÚ_ÿÎback_wq
[
i
]);

7579 
	`shªnÚ_kä“
(
dev
->
shªnÚ_ÿÎback_wq
);

7582 ià(
dev
->
wÜkqueue_Çme
) {

7583 
i
 = 0; i < 
dev
->
wÜkqueue_couÁ
; i++)

7584 ià(
dev
->
wÜkqueue_Çme
[
i
])

7585 
	`shªnÚ_kä“
(
dev
->
wÜkqueue_Çme
[
i
]);

7586 
	`shªnÚ_kä“
(
dev
->
wÜkqueue_Çme
);

7588 
	}
}

7590 #ià!
defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

7591 
	~"shªnÚ_dÇ.c
"

7592 
	$check_deviû_dÇ
(
shªnÚ_dev
 *
sdev
)

7594 
u64
 
dÇ_low
, 
dÇ_high
, 
shªnÚ_sum
;

7595 
u32
 
’coded_dÇ
;

7597 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

7598 
dÇ_low
 = 
	`shªnÚ_»adl
(&
sdev
->
b¬
->dna_low);

7599 
dÇ_high
 = 
	`shªnÚ_»adl
(&
sdev
->
b¬
->dna_high);

7600 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

7602 
sdev
->
dÇ
 = (
dÇ_high
 << 32è| 
dÇ_low
;

7603 
	`debugs2
("dÇ=0x%lx.\n", ()
sdev
->
dÇ
);

7604 
shªnÚ_sum
 = 
	`shªnÚ_’code
(
sdev
->
dÇ
);

7607 
’coded_dÇ
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
b¬
->encoded_dna);

7608 ià((
shªnÚ_sum
 & 0xffffffffè=ğ
’coded_dÇ
)

7612 
	}
}

7615 
	$check_u£r_logicb_size
(
shªnÚ_dev
 *
sdev
)

7617 
	`debugs1
("shªnÚ_£ùÜ_size=%d.\n", 
shªnÚ_£ùÜ_size
);

7618 
sdev
->
u£r_logicb_size
 = 
shªnÚ_£ùÜ_size
;

7619 
shªnÚ_£ùÜ_size
) {

7623 
sdev
->
u£r_logicb_shiá
 = 9;

7626 
sdev
->
u£r_logicb_shiá
 = 10;

7629 
sdev
->
u£r_logicb_shiá
 = 11;

7632 
sdev
->
u£r_logicb_shiá
 = 12;

7635 
	`shªnÚ_w¬n
("UnknowÀshªnÚ_£ùÜ_size=%d!\n", 
shªnÚ_£ùÜ_size
);

7637 
sdev
->
u£r_logicb_size
 = 0;

7639 
	}
}

7641 
	~"shªnÚ_nÜ.c
"

7642 cÚ¡ *
	$lšk¥“d_¡r
(
code
)

7644 
code
)

7655 
	}
}

7657 
	$fÜge_shªnÚ_udid
(
shªnÚ_dev
 *
sdev
)

7659 
off£t
 = 0, 
i
 = 0;

7661 
	`shªnÚ_mem£t
(
sdev
->
udid
, 0x0, 36);

7663 
off£t
 +ğ
	`shªnÚ_¢´štf
(
sdev
->
udid
, 10, "1CB0%04X-", sdev->
pci_šfo
.
deviû_id
);

7665 
off£t
 +ğ
	`shªnÚ_¢´štf
(
sdev
->
udid
 + off£t, 10, "%04X%04X-", sdev->
pci_šfo
.
subsy¡em_v’dÜ_id
,sdev->…ci_šfo.
subsy¡em_deviû_id
);

7667 ià(
sdev
->
has_£rviû_g
) {

7669 ià(
	`shªnÚ_¡¾’
(
sdev
->
£rviû_g
) == 14) {

7670 
off£t
 +ğ
	`shªnÚ_¢´štf
(
sdev
->
udid
 + off£t, 4, "0%02X", sdev->
£rviû_g
[1]);

7671 
	`shªnÚ_memıy
(
sdev
->
udid
 + 
off£t
, sdev->
£rviû_g
 + 2, 5);

7672 
off£t
 += 5;

7673 
off£t
 +ğ
	`shªnÚ_¢´štf
(
sdev
->
udid
 + off£t, 4, "-%02X", sdev->
£rviû_g
[7]);

7674 
	`shªnÚ_memıy
(
sdev
->
udid
 + 
off£t
, sdev->
£rviû_g
 + 8, 6);

7675 
off£t
 += 6;

7677 
i
 = 0; i < 16; i++) {

7678 iàĞ
i
 == 8) {

7679 
sdev
->
udid
[
off£t
 + 
i
] = '-';

7680 
off£t
 += 1;

7683 ià(
sdev
->
£rviû_g
[
i
] == 0)

7684 
sdev
->
udid
[
off£t
 + 
i
] = '0';

7685 ià((
sdev
->
£rviû_g
[
i
] >= '0') && (sdev->service_tag[i] <= '9'))

7686 
sdev
->
udid
[
off£t
 + 
i
] = sdev->
£rviû_g
[i];

7688 
sdev
->
udid
[
off£t
 + 
i
] = 'A' + (sdev->
£rviû_g
[i] - 'A') % 6;

7690 
off£t
 += 16;

7692 
sdev
->
udid
[
off£t
] = 0;

7694 
off£t
 +ğ
	`shªnÚ_¢´štf
(
sdev
->
udid
 + off£t, 10, "%08X-", sdev->
dÇ
 & 0xffffffffUL);

7695 
off£t
 +ğ
	`shªnÚ_¢´štf
(
sdev
->
udid
 + off£t, 9, "%08X", sdev->
dÇ
 >> 32);

7696 
sdev
->
udid
[
off£t
] = 0;

7698 
	`BUG_ON
(
off£t
 >ğ(
sdev
->
udid
));

7699 
	}
}

7701 
	$shªnÚ_dev_pci_š™Ÿlize
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_pci_dev_t
 *
pdev
)

7703 
»sourû_size_t
 
ba£_addr
;

7704 
Ëngth
;

7705 
	#MAX_RESET_TIME
 5

	)

7706 
»£t_out
 = 
MAX_RESET_TIME
;

7707 
max_lškwidth
 = 0;

7708 
shªnÚ_pci_šfo
 
¦Ù_šfo
 = {0};

7710 
sdev
->
pci_dev
 = 
pdev
;

7713 
	`g‘_pci_šfo
(
sdev
->
pci_dev
, &sdev->
pci_šfo
);

7716 
	`g‘_pci_šfo
(
	`shªnÚ_pci_g‘_¦Ù
(
sdev
->
pci_dev
, sdev->
pci_šfo
.
devâ
), &
¦Ù_šfo
);

7718 
max_lškwidth
 = 
	`mš_t
(, 
	`shªnÚ_pci_g‘_max_lškwidth
(&
¦Ù_šfo
), shªnÚ_pci_g‘_max_lškwidth(&
sdev
->
pci_šfo
));

7719 (
»£t_out
--è&& (
	`shªnÚ_pci_g‘_cur_lškwidth
(&
sdev
->
pci_šfo
è< 
max_lškwidth
è&& 
shªnÚ_do_pci_»£t
) {

7720 
	`shªnÚ_šfo
("%2.2x:%2.2x.%1.1x: current device†ink width(%d) don`t match max†ink width(%d),ry„eset...%d\n",

7721 
sdev
->
pci_šfo
.
pci_bus_numb”
, sdev->pci_šfo.
pci_¦Ù_numb”
, sdev->pci_šfo.
pci_func_numb”
,

7722 
	`shªnÚ_pci_g‘_cur_lškwidth
(&
sdev
->
pci_šfo
),

7723 
max_lškwidth
,

7724 
MAX_RESET_TIME
 - 
»£t_out
);

7729 ià(
	`shªnÚ_pci_»£t_funùiÚ
(
sdev
->
pci_dev
) == 1)

7731 
	`shªnÚ_m¦“p
(500);

7732 
	`g‘_pci_šfo
(
sdev
->
pci_dev
, &sdev->
pci_šfo
);

7735 
	`shªnÚ_£t_max_·ylßd_size
(
pdev
);

7736 
	`shªnÚ_di§bË_cÜ»ùabË_«r
(
pdev
);

7737 
sdev
->
hÙ_¶uggabË
 = 
	`check_hÙ_¶uggabË
(
pdev
);

7739 ià(
	`shªnÚ_pci_’abË_deviû
(
pdev
))

7741 
	`shªnÚ_pci_£t_ma¡”
(
pdev
);

7742 ià(
	`shªnÚ_pci_»que¡_»giÚ
(
pdev
, 0, "shannon"))

7743 
di§bË
;

7745 ià(
	`shªnÚ_pc›_£t_»adrq
(
pdev
, 4096))

7746 
	`shªnÚ_log
("cannot set„ead_request_size.\n");

7748 
ba£_addr
 = 
	`shªnÚ_pci_»sourû_¡¬t
(
pdev
, 0);

7749 ià(
	`uÆik–y
(!
ba£_addr
)) {

7750 
»Ëa£
;

7753 
Ëngth
 = 
	`shªnÚ_pci_»sourû_Ën
(
pdev
, 0);

7755 
	`debugs3
("BAR0 ba£_addr=0x%Îx,†’gth=%ld.\n", 
ba£_addr
, 
Ëngth
);

7757 
sdev
->
b¬
 = 
	`shªnÚ_iÜem­
(
ba£_addr
, 
Ëngth
);

7758 ià(
	`uÆik–y
(!
sdev
->
b¬
)) {

7759 
	`shªnÚ_”r
("can't map MMIO.\n");

7760 
»Ëa£
;

7763 
sdev
->
š‹¼u±_b¬
 = (
u32
 *)sdev->
b¬
 + 128;

7764 
sdev
->
glob®_b¬
 = (glob®_b¬ *)((
u32
 *)sdev->
b¬
 + 192);

7766 ià(
	`shªnÚ_dma_£t_mask
(
pdev
, 
	`SHANNON_DMA_BIT_MASK
(64)) < 0)

7767 
	`shªnÚ_log
("cannot dma_set_mask(64).\n");

7768 #ifdeà
CONFIG_SHANNON_DMA_QUEUE_64BIT


7769 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

7770 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
DMA_QUEUE_64BIT
, 1);

7771 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

7773 ià(
	`shªnÚ_dma_£t_coh”’t_mask
(
pdev
, 
	`SHANNON_DMA_BIT_MASK
(32)) < 0)

7774 
	`shªnÚ_log
("cannot dma_set_coherent_mask(32).\n");

7778 
»Ëa£
:

7779 
	`shªnÚ_pci_»Ëa£_»giÚs
(
pdev
);

7780 
di§bË
:

7781 
	`shªnÚ_pci_di§bË_deviû
(
pdev
);

7783 
	}
}

7785 
	$shªnÚ_dev_pci_deš™Ÿlize
(
shªnÚ_dev
 *
sdev
)

7787 
	`shªnÚ_iounm­
(
sdev
->
b¬
);

7788 
	`shªnÚ_pci_»Ëa£_»giÚs
(
sdev
->
pci_dev
);

7789 
	`shªnÚ_pci_di§bË_deviû
(
sdev
->
pci_dev
);

7790 
	}
}

7792 
shªnÚ_»cÚfig_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

7793 
shªnÚ_»£t_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

7794 
shªnÚ_upd©e_miüocode_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

7795 
shªnÚ_¶ugout_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

7796 
shªnÚ_ejeù_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

7798 
	$š™_miüocode_¬¿y
(
shªnÚ_dev
 *
sdev
)

7800 
i
;

7802 
i
 = 0; i < 
MICROCODE_ARRAY_SIZE
; i++) {

7803 
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 = 
MICROCODE_INVALID
;

7804 
sdev
->
miüocode_¬¿y
[
i
].
³_cyşe
 = 0;

7805 
sdev
->
miüocode_¬¿y
[
i
].
¡¬t_»g
 = -1;

7806 
sdev
->
miüocode_¬¿y
[
i
].
miüocode_Ëngth
 = 0;

7807 
sdev
->
miüocode_¬¿y
[
i
].
bË
 = 
NULL
;

7809 
	}
}

7812 
	$sdev_š™Ÿlize_v¬ŸbËs
(
shªnÚ_dev
 *
sdev
)

7814 
i
 = 0, 
j
 = 0;

7816 
sdev
->
gc_wr™es
 = 0;

7817 
sdev
->
ho¡_wr™es
 = 0;

7818 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
»£nd_li¡
);

7819 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
»£nd_li¡_lock
);

7821 
sdev
->
·r™y_š™_dÚe
[0] = 1;

7822 
sdev
->
·r™y_š™_dÚe
[1] = 1;

7823 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
·r™y_š™_dÚe_ev’t
[0]);

7824 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
·r™y_š™_dÚe_ev’t
[1]);

7826 
	`š™_miüocode_¬¿y
(
sdev
);

7827 
	`shªnÚ_©omic_£t
(&
sdev
->
disÿrded_blkút
, 0);

7828 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
ä“_blocks
);

7829 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
ä“_blocks_lock
);

7830 
sdev
->
ä“_blkút
 = 0;

7831 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
u£d_blocks
[
HOT_INDEX
]);

7832 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
u£d_blocks_lock
[
HOT_INDEX
]);

7833 
sdev
->
u£d_blkút
[
HOT_INDEX
] = 0;

7834 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
u£d_blocks
[
COLD_INDEX
]);

7835 
sdev
->
u£d_blkút
[
COLD_INDEX
] = 0;

7836 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
u£d_blocks_lock
[
COLD_INDEX
]);

7837 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_”a£d
);

7838 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
wa™_”a£d_lock
);

7839 
sdev
->
wa™_”a£d_blkút
 = 0;

7840 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_cİy
);

7841 
sdev
->
wa™_cİy_blkút
 = 0;

7842 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
wa™_cİy_lock
);

7843 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
cİy_”r_blocks
);

7844 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
cİy_”r_lock
);

7845 
sdev
->
cİy_”r_blkút
 = 0;

7846 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
»cov”_”r_blocks
);

7847 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
»cov”_”r_lock
);

7848 
sdev
->
»cov”_”r_blkút
 = 0;

7850 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
”r_blks
);

7851 
sdev
->
”r_blkút
 = 0;

7852 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
”r_blks_lock
);

7853 
	`shªnÚ_©omic_£t
(&
sdev
->
³ndšg_”r_blks
, 0);

7854 
sdev
->
»cov”_¿‹
 = 100;

7855 
sdev
->
this_”r_sb
 = 
NULL
;

7856 
sdev
->
this_”r_¡re
 = 0;

7858 
sdev
->
»ad_”r_msg_Ëv–
 = 
ONE_MSG_PER_BLK
;

7860 
	`shªnÚ_mem£t
(
sdev
->
”r_check_b™m­
, 0, 
LUN_BITMAP_LEN
);

7861 
sdev
->
”r_check_debug
 = 0;

7862 
sdev
->
su¥icious_bad_lun_šdiÿtÜ
 = 3;

7864 
i
 = 0; i < 
PRIORITY_LEVELS
; i++) {

7865 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
»q_queue
[
i
]);

7866 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
»q_queue_lock
[
i
]);

7867 
	`shªnÚ_©omic_£t
(&
sdev
->
wr™e_»qs
[
i
], 0);

7869 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
gc_wr™e_queue
);

7870 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
gc_wr™e_queue_lock
);

7871 
	`shªnÚ_©omic_£t
(&
sdev
->
gc_wr™e_»qs
, 0);

7873 
	`shªnÚ_©omic_£t
(&
sdev
->
wr™e_»qs_fÜ_gc
, 0);

7874 
	`shªnÚ_mu‹x_š™
(&
sdev
->
¡©e_£m
);

7875 
	`shªnÚ_mu‹x_š™
(&
sdev
->
¶ug_out_£m
);

7876 
	`shªnÚ_mu‹x_š™
(&
sdev
->
modify_mbr_£m
);

7877 
	`shªnÚ_©omic_£t
(&
sdev
->
š_æight_wr™es
, 0);

7878 
	`shªnÚ_©omic_£t
(&
sdev
->
š_cmd_queue_wr™es
, 0);

7879 
	`shªnÚ_©omic_£t
(&
sdev
->
gc_š_æight
, 0);

7880 
	`shªnÚ_©omic_£t
(&
sdev
->
š_cmd_queue_adv_»ads
, 0);

7881 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
adv_»ad_li¡
);

7882 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
adv_»ad_li¡_lock
);

7884 #ifdeà
CONFIG_SHANNON_VERBOSE_DEBUG


7885 
	`shªnÚ_©omic_£t
(&
sdev
->
»ad_bios
, 0);

7886 
	`shªnÚ_©omic_£t
(&
sdev
->
wr™e_bios
, 0);

7888 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
lim™_»q_queue
[0]);

7889 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
lim™_»q_queue
[1]);

7890 #ifdeà
CONFIG_SHANNON_STATISTICS


7891 
	`shªnÚ_©omic_£t
(&
sdev
->
äom_ho¡
, 0);

7892 
	`shªnÚ_©omic_£t
(&
sdev
->
äom_gc
, 0);

7895 
sdev
->
¢­_»ad_’abË
 = 0;

7896 
	`shªnÚ_©omic64_£t
(&
sdev
->
¢­_»ad_couÁ”
, 0);

7897 
	`shªnÚ_©omic_£t
(&
sdev
->
¢­_»ad_mism©ch
, 0);

7898 
sdev
->
³riod_»ad
.
¡©e
 = 
PERIOD_READ_DISABLE
;

7899 
sdev
->
³riod_»ad
.
³riod
 = 0;

7900 
sdev
->
³riod_»ad
.
µa
 = ~0x0;

7901 
sdev
->
³riod_»ad
.
mš_£q_num
 = 0x0;

7902 
sdev
->
³riod_»ad
.
max_£q_num
 = ~0x0;

7903 
sdev
->
³riod_»ad
.
blkút
 = 0;

7904 
sdev
->
³riod_»ad
.
aùive_dÚe
[0] = 0;

7905 
sdev
->
³riod_»ad
.
aùive_dÚe
[1] = 0;

7906 
sdev
->
³riod_»ad
.
Ï¡_blk_dÚe
[0] = 0;

7907 
sdev
->
³riod_»ad
.
Ï¡_blk_dÚe
[1] = 0;

7908 
	`shªnÚ_š™_wÜk
(&
sdev
->
³riod_»ad_wÜk
, 
shªnÚ_³riod_»ad_sk
);

7909 
	`shªnÚ_š™_tim”
(&
sdev
->
³riod_»ad_tim”
);

7910 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
³riod_»ad_tim”
, 
³riod_»ad_tim”_timeout
);

7912 
sdev
->
gc_çùÜ
 = 
GC_DIVIDE_FACTOR
;

7913 
sdev
->
hÙ_block_»şaim_´iÜ™y
 = 95;

7914 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
»gs_İ_lock
);

7915 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
this_sb_lock
);

7916 
sdev
->
this_sb
 = 
NULL
;

7917 
sdev
->
this_·ge_¡re
 = 0;

7918 
sdev
->
this_lun
 = 0;

7919 
	`shªnÚ_š™_tim”
(&
sdev
->
gc_tim”
);

7920 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
gc_tim”
, 
gc_thrÙe_timeout
);

7921 
	`shªnÚ_š™_wÜk
(&
sdev
->
gc_tim”_wÜk
, 
shªnÚ_gc_tim”_sk
);

7922 
	`shªnÚ_š™_tim”
(&
sdev
->
b®ªû_gc_tim”
);

7923 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
b®ªû_gc_tim”
, 
b®ªû_gc_timeout
);

7924 
	`shªnÚ_š™_wÜk
(&
sdev
->
»äesh_wÜk
, 
shªnÚ_»äesh_sk
);

7925 
sdev
->
‹m³¿tu»_w¬nšg_th»shŞd
 = 79;

7926 
	`shªnÚ_š™_tim”
(&
sdev
->
w©chdog_tim”
);

7927 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
w©chdog_tim”
, 
w©chdog_funùiÚ
);

7928 
	`shªnÚ_š™_wÜk
(&
sdev
->
w©chdog_wÜk
, 
shªnÚ_w©chdog_sk
);

7929 
sdev
->
sdisk
.
´št_Ï‹ncy_š‹rv®
 = 0;

7930 
	`shªnÚ_š™_tim”
(&
sdev
->
sdisk
.
´št_Ï‹ncy_tim”
);

7931 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
sdisk
.
´št_Ï‹ncy_tim”
, 
´št_Ï‹ncy_funùiÚ
);

7932 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
sdisk
.
»cÜd_Ï‹ncy_lock
);

7933 
	`shªnÚ_š™_wÜk
(&
sdev
->
acûss_mode_wÜk
, 
upd©e_acûss_mode_sk
);

7934 
	`shªnÚ_š™_wÜk
(&
sdev
->
pm_qos_wÜk
, 
shªnÚ_pm_qos_sk
);

7935 
	`shªnÚ_š™_wÜk
(&
sdev
->
wÜk
, 
shªnÚ_sk
);

7936 
	`shªnÚ_š™_wÜk
(&
sdev
->
¶ugout_wÜk
, 
shªnÚ_¶ugout_sk
);

7937 
	`shªnÚ_š™_wÜk
(&
sdev
->
»cÚfig_wÜk
, 
shªnÚ_»cÚfig_sk
);

7938 
	`shªnÚ_š™_wÜk
(&
sdev
->
»£t_wÜk
, 
shªnÚ_»£t_sk
);

7939 
	`shªnÚ_š™_wÜk
(&
sdev
->
upd©e_miüocode_wÜk
, 
shªnÚ_upd©e_miüocode_sk
);

7940 
	`shªnÚ_š™_d–ayed_wÜk
(&
sdev
->
ejeù_wÜk
, 
shªnÚ_ejeù_sk
);

7941 
	`shªnÚ_mu‹x_š™
(&
sdev
->
pick_£m
);

7942 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
block_ho¡_wr
);

7943 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
wa™_ä“_blk
);

7944 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
big_lock_ev’t
);

7945 
	`shªnÚ_©omic_£t
(&
sdev
->
¡©ic_bad_blkút
, 0);

7946 
	`shªnÚ_©omic_£t
(&
sdev
->
dyÇmic_bad_blkút
, 0);

7947 
	`shªnÚ_©omic_£t
(&
sdev
->
ecc_çu»_times
, 0);

7948 
	`shªnÚ_©omic_£t
(&
sdev
->
ecc_fc_¡©i¡ics
, 0);

7949 
	`shªnÚ_©omic_£t
(&
sdev
->
š_gc_blkút
, 0);

7950 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
gc_¡©e_lock
);

7951 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
gc_»qs_lock
);

7952 
	`shªnÚ_©omic_£t
(&
sdev
->
š_gc_logicbs
, 0);

7953 
	`shªnÚ_©omic_£t
(&
sdev
->
gc_th»ads
, 0);

7954 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
wa™_pick_ev’t
);

7956 
	`shªnÚ_©omic_£t
(&
sdev
->
š_”a£_blkút
, 0);

7957 
	`shªnÚ_©omic_£t
(&
sdev
->
š_wl_blkút
, 0);

7958 
	`shªnÚ_š™_wÜk
(&
sdev
->
wl_fšd_sb_wÜk
, 
shªnÚ_wl_sk
);

7959 
	`shªnÚ_š™_wÜk
(&
sdev
->
wl_»ad_wÜk
, 
shªnÚ_wl_»ad_sk
);

7960 
sdev
->
wl_»asÚ
 = 0;

7961 
sdev
->
Ãxt_wl_»asÚ
 = 0;

7962 
sdev
->
wl_this_sb
 = 
NULL
;

7963 
	`shªnÚ_©omic_£t
(&
sdev
->
š_wl_logicbs
, 0);

7964 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_wl_li¡
);

7965 
sdev
->
wa™_wl_blkút
 = 0;

7966 
	`shªnÚ_©omic_£t
(&
sdev
->
š_wl_blkút
, 0);

7967 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
wa™_wl_lock
);

7968 
	`shªnÚ_š™_tim”
(&
sdev
->
d©a_»‹ÁiÚ_tim”
);

7969 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
d©a_»‹ÁiÚ_tim”
, 
d©a_»‹ÁiÚ_tim”_sk
);

7970 
	`shªnÚ_š™_tim”
(&
sdev
->
wl_tim”
);

7971 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
wl_tim”
, 
wl_tim”_sk
);

7972 
sdev
->
œq_d–ay
.irq_delay = 5;

7973 
	`shªnÚ_š™_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

7974 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
upd©e_œq_d–ay_timeout
);

7975 
	`shªnÚ_š™_wÜk
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_wÜk
, 
upd©e_œq_d–ay_sk
);

7976 
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_š‹rv®
 = 
DEFAULT_UPDATE_IRQ_DELAY_TIMEOUT
;

7977 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
DEFAULT_ENABLE_DYNAMIC_IRQ_DELAY
;

7978 
sdev
->
œq_d–ay
.
çùÜ
 = 
DEFAULT_IRQ_DELAY_FACTOR
;

7979 
sdev
->
œq_d–ay
.
mš_œq_d–ay
 = 
DEFAULT_MIN_IRQ_DELAY
;

7980 
sdev
->
œq_d–ay
.
max_œq_d–ay
 = 
DEFAULT_MAX_IRQ_DELAY
;

7981 
sdev
->
œq_d–ay
.
wr™e_Ï‹ncy_divide
 = 
DEFAULT_HOST_WRITE_LAT_DIVIDE
;

7982 
sdev
->
œq_d–ay
.
»ad_Ï‹ncy_divide
 = 
DEFAULT_HOST_READ_LAT_DIVIDE
;

7983 
sdev
->
œq_d–ay
.
wr™e_th»shŞd_çùÜ
 = 
DEFAULT_HOST_WRITE_THRESHOLD_FACTOR
;

7984 
sdev
->
œq_d–ay
.
»ad_th»shŞd_çùÜ
 = 
DEFAULT_HOST_READ_THRESHOLD_FACTOR
;

7985 
sdev
->
œq_d–ay
.
ho¡_wr™e_ios_Ï¡
 = 0;

7986 
sdev
->
œq_d–ay
.
ho¡_wr™e_m£cs_Ï¡
 = 0;

7987 
sdev
->
œq_d–ay
.
ho¡_»ad_ios_Ï¡
 = 0;

7988 
sdev
->
œq_d–ay
.
ho¡_»ad_m£cs_Ï¡
 = 0;

7989 
sdev
->
wl_tim”_š‹rv®
 = 
WL_TIMER_INTERVAL
;

7990 
sdev
->
»ad_di¡urb_th»shŞd
 = 1000000;

7991 
sdev
->
İ’_block_»ad_di¡urb_th»shŞd
 = 300000;

7992 
sdev
->
max_š_wl_logicbs
 = 10;

7993 
sdev
->
cu¼’t_max_š_wl_logicbs
 = 10;

7994 
sdev
->
wl_max_”a£_couÁ
 = 3000;

7995 
sdev
->
wl_”a£_couÁ_d–
[0] = 300;

7996 
sdev
->
wl_”a£_couÁ_d–
[1] = 200;

7997 
sdev
->
buf_»ad_çed
 = 0;

7999 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
io_¡©i¡ics_lock
);

8000 
sdev
->
exŒa_»qs
 = 0;

8001 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
exŒa_»qs_lock
);

8002 
	`shªnÚ_©omic_£t
(&
sdev
->
logicb_buf_couÁ
, 0);

8003 
	`shªnÚ_©omic_£t
(&
sdev
->
”a£_dÚe
, 0);

8004 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
”a£_dÚe_ev’t
);

8005 
	`shªnÚ_©omic_£t
(&
sdev
->
»äesh_mbr_dÚe
, 0);

8006 
	`shªnÚ_©omic_£t
(&
sdev
->
»äesh_mbr_couÁ
, 0);

8007 
sdev
->
sdisk
.
nÚ®igÃd_bios
 = 0;

8008 
sdev
->
sdisk
.
nÚ®igÃd_»qs
 = 0;

8009 
sdev
->
sdisk
.
®igÃd_»qs
 = 0;

8010 
i
 = 0; i < 2; i++) {

8011 
j
 = 0; j < 
RMW_LIST_COUNT
; j++) {

8012 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
sdisk
.
rmw_li¡_lock
[
i
][
j
]);

8013 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
sdisk
.
rmw_li¡
[
i
][
j
]);

8016 
	`shªnÚ_©omic_£t
(&
sdev
->
u£rs
, 1);

8017 
sdev
->
bufãr_wr™e_couÁ”
 = 0;

8018 
sdev
->
dœeù_wr™e_couÁ”
 = 0;

8019 
sdev
->
tÙ®_»ad_£ùÜs
 = 0;

8020 
sdev
->
tÙ®_»ad_£ùÜs_Ï¡
 = 0;

8021 
sdev
->
tÙ®_»ad_bªdwidth
 = 0;

8022 
sdev
->
tÙ®_gc_logicbs
 = 0;

8023 
sdev
->
tÙ®_gc_£ùÜs_Ï¡
 = 0;

8024 
sdev
->
tÙ®_wl_logicbs
 = 0;

8025 
sdev
->
tÙ®_wl_£ùÜs_Ï¡
 = 0;

8026 
sdev
->
tÙ®_”r_»cov”_logicbs
 = 0;

8027 
sdev
->
tÙ®_”r_»cov”_£ùÜs_Ï¡
 = 0;

8029 
sdev
->
gc_sbs
 = 0;

8030 
sdev
->
”r_»cov”ed_sbs
 = 0;

8031 
sdev
->
wl_sbs
 = 0;

8032 
sdev
->
d©a_»‹ÁiÚ_sbs
 = 0;

8033 
sdev
->
»ad_di¡urb_sbs
 = 0;

8034 
sdev
->
”a£_b®ªû_sbs
 = 0;

8035 
sdev
->
ecc_çu»_sbs
 = 0;

8036 
sdev
->
£ùÜs_codewÜd_addr
 = 
NULL
;

8038 
sdev
->
cu¼’t_miüocode_šdex
 = -1;

8039 
sdev
->
sdisk
.
ex™
 = 0;

8040 
sdev
->
sdisk
.
š_»cÚfig
 = 0;

8041 
sdev
->
¶ug_out
 = 0;

8042 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

8043 
sdev
->
š_œq
[
i
] = 0;

8044 #ifdeà
CONFIG_SHANNON_DEBUG


8045 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
gc_¡©e_li¡
);

8046 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
gc_¡©e_li¡_lock
);

8048 
sdev
->
sdisk
.
´iÜ™y
 = 1;

8049 
sdev
->
sdisk
.
©ched
 = 
SHN_DISK_DETACHED
;

8050 
sdev
->
¡©e
 = 
SHN_STATE_DETACHED
;

8052 
	`shªnÚ_mu‹x_š™
(&
sdev
->
wr™e_bbt_£m
);

8053 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
fuÎ_nÜ_block_li¡
);

8054 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
u£d_nÜ_block_li¡
);

8055 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
ä“_nÜ_block_li¡
);

8056 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wa™_”a£_nÜ_block_li¡
);

8057 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
”a£_”r_nÜ_block_li¡
);

8058 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
wr™e_”r_nÜ_block_li¡
);

8059 
	`shªnÚ_mu‹x_š™
(&
sdev
->
thrÙe_wr™e_bw_£m
);

8060 
	`shªnÚ_©omic_£t
(&
sdev
->
wr™e_bw
, 0);

8061 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
”a£_dummy_dÚe_ev’t
);

8062 
	`shªnÚ_©omic_£t
(&
sdev
->
”a£_dummy_dÚe
, 0);

8063 
	}
}

8065 
	$sdev_»ad_h¬dw¬e_cÚfig
(
shªnÚ_dev
 *
sdev
)

8067 
u32
 
ÿ·b™y
;

8068 
u32
 
ecc_ÿp
;

8070 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

8071 
sdev
->
fœmw¬e_v”siÚ
 = 
	`shªnÚ_»adl
(&sdev->
b¬
->firmware_version);

8072 
sdev
->
fœmw¬e_g
 = 
	`shªnÚ_»adl
(&sdev->
b¬
->firmware_tag);

8073 
ÿ·b™y
 = 
	`shªnÚ_»adl
(&
sdev
->
b¬
->
ÿp
);

8074 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

8075 
sdev
->
h¬dw¬e_v”siÚ
 = 
ÿ·b™y
 & 0xFF;

8076 
sdev
->
max_lun_š_û
 = ((
ÿ·b™y
 >> 12) & 0xF) + 1;

8077 
sdev
->
max_chªÃls
 = (
ÿ·b™y
 >> 16) & 0xFF;

8078 
sdev
->
max_lun£t_š_chªÃl
 = (
ÿ·b™y
 >> 24) & 0xF;

8079 
sdev
->
max_lun_š_lun£t
 = ((
ÿ·b™y
 >> 28) & 0xF) + 1;

8080 
sdev
->
max_lun_š_chªÃl
 = sdev->
max_lun_š_lun£t
 * sdev->
max_lun£t_š_chªÃl
;

8081 
sdev
->
lun£t_couÁ
 = sdev->
max_lun£t_š_chªÃl
 * sdev->
max_chªÃls
;

8082 
sdev
->
max_û_š_lun£t
 = sdev->
max_lun_š_lun£t
 / sdev->
max_lun_š_û
;

8084 
	`shªnÚ_šfo
("´obšg % © %2.2x:%2.2x.%1.1x:\n", 
sdev
->
cdev_Çme
, sdev->
pci_šfo
.
pci_bus_numb”
, sdev->pci_šfo.
pci_¦Ù_numb”
, sdev->pci_šfo.
pci_func_numb”
);

8085 
	`shªnÚ_šfo
("%s: v’dÜ id: 1cb0, deviû id: %4.4x\n", 
sdev
->
cdev_Çme
, sdev->
pci_šfo
.
deviû_id
);

8086 
	`shªnÚ_šfo
("%s:†nkÿp: % x %d\n", 
sdev
->
cdev_Çme
, 
	`lšk¥“d_¡r
(sdev->
pci_šfo
.
Êkÿp
 & 0xf), (sdev->pci_info.lnkcap >> 4) & 0x3f);

8087 
	`shªnÚ_šfo
("%s:†nk¡a: % x %d\n", 
sdev
->
cdev_Çme
, 
	`lšk¥“d_¡r
(sdev->
pci_šfo
.
Êk¡a
 & 0xf), (sdev->pci_info.lnksta >> 4) & 0x3f);

8088 ià(
sdev
->
fœmw¬e_v”siÚ
)

8089 
	`shªnÚ_šfo
("%s: fœmw¬v”siÚ: %u.%u.%u\n", 
sdev
->
cdev_Çme
,

8090 (
sdev
->
fœmw¬e_v”siÚ
 & 0x0000ffff) >> 12, ((sdev->firmware_version & 0x0000ffff) >> 8) & 0xf, ((sdev->firmware_version & 0x0000ffff) >> 4) & 0xf);

8092 
	`shªnÚ_šfo
("%s: fœmw¬v”siÚ: 3.2.8\n", 
sdev
->
cdev_Çme
);

8093 
	`shªnÚ_šfo
("%s: fœmw¬bud: %8.8x\n", 
sdev
->
cdev_Çme
, sdev->
fœmw¬e_g
);

8094 ià(
SHANNON_FIX_VERSION_CODE
)

8095 
	`shªnÚ_šfo
("%s: driv” v”siÚ: %d.%d.%d.%d\n", 
sdev
->
cdev_Çme
, 
	`SHANNON_VERSION_MAJOR
(
SHANNON_VERSION_CODE
),

8096 
	`SHANNON_VERSION_MINOR
(
SHANNON_VERSION_CODE
), 
	`SHANNON_VERSION_RELEASE
(SHANNON_VERSION_CODE), 
SHANNON_FIX_VERSION_CODE
);

8098 
	`shªnÚ_šfo
("%s: driv” v”siÚ: %d.%d.%d\n", 
sdev
->
cdev_Çme
, 
	`SHANNON_VERSION_MAJOR
(
SHANNON_VERSION_CODE
),

8099 
	`SHANNON_VERSION_MINOR
(
SHANNON_VERSION_CODE
), 
	`SHANNON_VERSION_RELEASE
(SHANNON_VERSION_CODE));

8101 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

8102 
ecc_ÿp
 = 
	`»ad_»g_§ã
(
sdev
, &sdev->
b¬
->
ecc
);

8103 (
ecc_ÿp
 >> 8) & 0x000000ff) {

8105 
sdev
->
ecc_cÜ»ùiÚ_pow”
 = 16;

8108 
sdev
->
ecc_cÜ»ùiÚ_pow”
 = 35;

8111 
sdev
->
ecc_cÜ»ùiÚ_pow”
 = 58;

8114 
	`shªnÚ_”r
("uÄecognizedƒcøÿ·b™y 0x%x.\n", 
ecc_ÿp
);

8119 
	`shªnÚ_šfo
("%s: geom‘ry: %dx%dx%d\n", 
sdev
->
cdev_Çme
, sdev->
max_chªÃls
, sdev->
max_lun£t_š_chªÃl
, sdev->
max_lun_š_lun£t
);

8121 ià(
	`check_deviû_dÇ
(
sdev
) < 0) {

8122 
	`shªnÚ_”r
("Wrong device information.\n");

8126 
	`shªnÚ_šfo
("%s: CÚŒŞË¸dÇ: %16.16Îx\n", 
sdev
->
cdev_Çme
, sdev->
dÇ
);

8128 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

8129 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

8130 
sdev
->
nÜæash
.
pc›_phy_addr
 = 
	`shªnÚ_»ad_»g
((
u32
 *)sdev->
b¬
 + 
SH_G5_FPGA_NORFLASH_OFFSET
, 
G5_FPGA_NORFLASH
);

8131 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

8132 
sdev
->
»cÚfig_suµÜt
 = 
	`shªnÚ_dev_is_g5_åga
(sdev) ? 1 : 0;

8134 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

8135 
sdev
->
»cÚfig_suµÜt
 = 
	`shªnÚ_»ad_»g
((
u32
 *)sdev->
b¬
 + 
SH_RECONFIG_STATUS_OFFSET
, 
RECONFIG_SUPPORT
);

8136 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

8138 
	`shªnÚ_šfo
("%s: CÚŒŞË¸»cÚfig % suµÜ‹d!\n", 
sdev
->
cdev_Çme
, sdev->
»cÚfig_suµÜt
?"is":"is‚ot");

8140 ià(
	`shªnÚ_š™_nÜæash
(
sdev
)) {

8141 
	`shªnÚ_”r
("failedo get NOR flash organization.\n");

8144 ià(
	`shªnÚ_dev_is_g5
(
sdev
è&& (sdev->
nÜæash
.
pc›_phy_addr
 != 0)) {

8146 
sdev
->
nÜæash
.
pc›_phy_addr
 = sdev->nÜæash.
size_šby‹s
 - 1 * 1024 * 1024;

8148 
	`»ad_nÜæash_šfo
(
sdev
);

8149 
	`shªnÚ_šfo
("%s: mod–: %s, s”viûag: %s\n", 
sdev
->
cdev_Çme
, sdev->
mod–_id
, sdev->
£rviû_g
);

8151 
	`fÜge_shªnÚ_udid
(
sdev
);

8152 
	`shªnÚ_šfo
("%s: udid: %s.\n", 
sdev
->
cdev_Çme
, sdev->
udid
);

8155 
	}
}

8157 
	$ş—r_ªd_di§bË_š‹¼u±
(
shªnÚ_dev
 *
sdev
)

8160 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

8161 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

8162 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

8163 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

8164 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

8165 
	}
}

8167 
	$shªnÚ_š™_h¬dw¬e
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_pci_dev_t
 *
pdev
)

8169 ià(
	`shªnÚ_dev_pci_š™Ÿlize
(
sdev
, 
pdev
)) {

8170 
	`shªnÚ_”r
("failedo initialize…ci device.\n");

8171 ià(!
shªnÚ_scsi_mode
)

8172 
	`shªnÚ_pci_£t_drvd©a
(
pdev
, 
NULL
);

8176 ià(
	`sdev_»ad_h¬dw¬e_cÚfig
(
sdev
)) {

8177 
	`shªnÚ_”r
("failedo„ead hardware configuration.\n");

8178 
pci_deš™
;

8181 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

8182 ià(
	`shªnÚ_š™_h¬dw¬e_g5
(
sdev
, 
pdev
) < 0)

8183 
pci_deš™
;

8185 ià(
	`shªnÚ_š™_h¬dw¬e_g4
(
sdev
, 
pdev
) < 0)

8186 
pci_deš™
;

8188 
	`shªnÚ_šfo
("%s: HAL v”siÚ: %d, T: %d\n", 
sdev
->
cdev_Çme
, sdev->
h¬dw¬e_v”siÚ
, sdev->
ecc_cÜ»ùiÚ_pow”
);

8192 
pci_deš™
:

8193 
	`shªnÚ_dev_pci_deš™Ÿlize
(
sdev
);

8194 ià(!
shªnÚ_scsi_mode
)

8195 
	`shªnÚ_pci_£t_drvd©a
(
pdev
, 
NULL
);

8198 
	}
}

8200 
	$shªnÚ_cdevs_š™
(
shªnÚ_dev
 *
sdev
)

8202 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


8203 ià(
	`•og_cdev_š™
(
sdev
))

8206 ià(
	`pba_bË_cdev_š™
(
sdev
, sdev->
pba_bË_size
))

8208 ià(
	`commªd_cdev_š™
(
sdev
))

8210 ià(
	`com¶‘iÚ_cdev_š™
(
sdev
))

8214 
	}
}

8216 
	$®loc_üc_bË
(
shªnÚ_dev
 *
sdev
)

8218 
u32
 *
bË
, 
pŞynomŸl
 = 0xEDB88320;

8219 
i
, 
j
;

8221 
sdev
->
üc_bË
 = (
u32
 *)
	`shªnÚ_km®loc
((u32è* 
CRC32_TABLE_SIZE
, 
GFP_SHANNON
);

8222 ià(!
sdev
->
üc_bË
) {

8223 
	`shªnÚ_”r
("Alloc crcable failed.\n");

8226 
bË
 = 
sdev
->
üc_bË
;

8228 
i
 = 0; i < 
CRC32_TABLE_SIZE
; i++) {

8229 
j
 = 0, 
bË
[
i
] = i; j < 8; j++)

8230 
bË
[
i
] = (bË[i] >> 1è^ (ÑabË[i] & 1è? 
pŞynomŸl
 : 0);

8234 
	}
}

8236 
	$check_m¬ked_bad_luns
(
shªnÚ_dev
 *
sdev
)

8238 
i
;

8239 
”r_luns
 = 0, 
upd©e_mbr
 = 0;

8241 ià(
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
) {

8242 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

8243 ià(
sdev
->
lun
[
i
]->
bad
) {

8244 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
) && \

8245 (
upd©e_mbr
 == 0))

8246 
upd©e_mbr
 = 1;

8248 
”r_luns
 += 1;

8249 
	`m¬k_sb_”r_fÜ_bad_lun
(
sdev
, sdev->
lun
[
i
]);

8253 ià(
”r_luns
) {

8254 
	`move_blks_to_”r_blks_li¡
(
sdev
);

8255 
	`check_”r_blkút_šc
(
sdev
);

8257 } ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

8258 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

8259 ià(
sdev
->
lun
[
i
]->
bad
) {

8260 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
)) {

8261 
upd©e_mbr
 = 1;

8268 ià(
upd©e_mbr
) {

8269 
	`shªnÚ_queue_wÜk
(
sdev
->
»äesh_wq
, &sdev->
»äesh_wÜk
);

8270 
sdev
->
»äesh_£qu’û
 = sdev->
pow”_Ú_£cÚds
 / 
MBR_REFRESH_INTERVAL
;

8271 
	`shªnÚ_šfo
("%s:»äesh_£qu’û=%d.\n", 
sdev
->
sdisk
.
disk_Çme
, sdev->
»äesh_£qu’û
);

8273 
	}
}

8275 
	~"shªnÚ_m­_bË.c
"

8276 
	$shªnÚ_´obe
(
shªnÚ_pci_dev_t
 *
pdev
, cÚ¡ 
shªnÚ_pci_deviû_id_t
 *
id
, 
shªnÚ_scsi_´iv©e
 *
ho¡d©a
)

8278 
»suÉ
 = -
ENOMEM
;

8279 
shªnÚ_dev
 *
sdev
;

8280 
i
, 
h—d_šdex
;

8282 
sdev
 = 
	`shªnÚ_kz®loc
((*sdev), 
GFP_SHANNON
);

8283 ià(!
sdev
)

8284  -
ENOMEM
;

8285 
	`sdev_š™Ÿlize_v¬ŸbËs
(
sdev
);

8287 ià(
shªnÚ_scsi_mode
) {

8288 
sdev
->
sdisk
.
ho¡d©a
 = hostdata;

8289 
ho¡d©a
->
sdev
 = sdev;

8291 
	`shªnÚ_pci_£t_drvd©a
(
pdev
, 
sdev
);

8292 
sdev
->
node
 = 
	`shªnÚ_pci_g‘_node
(
pdev
);

8293 
	`shªnÚ_¥š_lock_bh
(&
deviû_b™m­_lock
);

8294 
sdev
->
drive_no
 = 
	`shªnÚ_fšd_fœ¡_z”o_b™
(&
deviû_b™m­
, 
MAX_DEVICE_NO
);

8295 ià(
sdev
->
drive_no
 =ğ
MAX_DEVICE_NO
) {

8296 
	`shªnÚ_”r
("Úly suµÜˆ%d deviûs.\n", 
MAX_DEVICE_NO
);

8297 
	`shªnÚ_¥š_uÆock_bh
(&
deviû_b™m­_lock
);

8298 
	`shªnÚ_kä“
(
sdev
);

8299  -
EIO
;

8301 
	`SHANNON_INIT_LIST_HEAD
(&
sdev
->
li¡
);

8302 
	`shªnÚ_li¡_add
(&
sdev
->
li¡
, &
shªnÚ_dev_li¡
);

8303 
	`shªnÚ_£t_b™
(
sdev
->
drive_no
, &
deviû_b™m­
);

8304 
	`shªnÚ_¥š_uÆock_bh
(&
deviû_b™m­_lock
);

8305 
	`shªnÚ_¢´štf
 (
sdev
->
cdev_Çme
, 16, "sù%c", 'a' + sdev->
drive_no
);

8306 
	`shªnÚ_¢´štf
 (
sdev
->
sdisk
.
disk_Çme
, 16, "df%c", 'a' + sdev->
drive_no
);

8308 
	`shªnÚ_pm_qos_add_»quœem’t
(&
sdev
->
pm_qos_l
, 
SHANNON_PM_QOS_CPU_DMA_LATENCY
, sdev->
sdisk
.
disk_Çme
, 
SHANNON_PM_QOS_DEFAULT_VALUE
);

8310 ià(
	`®loc_üc_bË
(
sdev
) < 0) {

8311 
	`shªnÚ_”r
("%s: in™ crøbË faed.\n", 
sdev
->
sdisk
.
disk_Çme
);

8312 
ä“
;

8315 ià(
	`®loc_wÜkqueues
(
sdev
))

8316 
ä“
;

8318 
»suÉ
 = 
	`shªnÚ_š™_h¬dw¬e
(
sdev
, 
pdev
);

8319 ià(
»suÉ
)

8320 
ä“
;

8322 
sdev
->
š™_dÚe
 = 
STAGE_INIT_HARDWARE_DONE
;

8324 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
£qu’û_numb”_lock
);

8325 
sdev
->
£qu’û_numb”
 = 1;

8326 
sdev
->
¿id5_suµÜ‹d
 = 
RAID5_SUPPORTED
;

8327 
sdev
->
rÙ©e_·r™y
 = 
ROTATE_PARITY
;

8328 
sdev
->
ecc_by·ss
 = 
ECC_BYPASS
;

8330 
sdev
->
ho¡_acûss_blocked
 = 0;

8331 
	`shªnÚ_©omic_£t
(&
sdev
->
aùive_wa™_¡©us
, 
IDLE
);

8332 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
aùive_wa™_ev’t
);

8333 
	`shªnÚ_©omic_£t
(&
sdev
->
wa™_blk
, -1);

8334 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
wa™_blk_dÚe_ev’t
);

8335 
	`shªnÚ_©omic_£t
(&
sdev
->
»cov”_dÚe
, 0);

8336 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
»cov”_dÚe_ev’t
);

8338 
	`ÿlcuÏ‹_glob®_v¬ŸbË
(
sdev
);

8340 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

8341 
	`shªnÚ_kth»ad_¡İ
(
´eš™_emu_th»ad
);

8344 ià(
	`check_commÚ_šfo
(
sdev
) < 0) {

8345 
	`shªnÚ_”r
("Wrong MBR data.\n");

8346 
»suÉ
 = -19;

8347 
pci_deš™
;

8350 ià(
	`sdev_®loc_dummy_·ge
(
sdev
)) {

8351 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for dummy_page.\n");

8352 
pci_deš™
;

8355 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

8356 
	`š™_åga_emu_v¬ŸbËs
(
sdev
);

8358 
	`®loc_bufãr_queue
(
sdev
);

8360 
»suÉ
 = 
	`®loc_lun_¡ruùu»
(
sdev
);

8361 ià(
»suÉ
) {

8362 
	`shªnÚ_”r
("cannot‡llocate†un structure.\n");

8363 
vä“
;

8366 ià(
	`check_the_d©e
() < 0) {

8367 
	`shªnÚ_”r
("This ishe‡lpha version. Please contact Shannon Systems forhe†atest version.\n");

8368 
»suÉ
 = -40;

8369 
vä“
;

8372 #ià
	`defšed
(
CONFIG_SHANNON_EMU
è|| defšed(
CONFIG_SHANNON_EMU_MODULE
)

8373 
i
=0; i<
emu_lun_amouÁ
; i++) {

8374 
emu_luns
[
i
].
logicb_size
 = 
sdev
->logicb_size;

8375 
emu_luns
[
i
].
logicb_shiá
 = 
sdev
->logicb_shift;

8376 
emu_luns
[
i
].
logicbs_š_·ge
 = 
sdev
->logicbs_in_page;

8379 ià(!
	`shªnÚ_dev_is_g5
(
sdev
))

8380 
	`š™_glob®_cÚfig_»gs
(
sdev
);

8381 
	`dump_b¬_¥aû
(
sdev
);

8384 
sdev
->
logicb_buf_poŞ
 = 
	`shªnÚ_mempoŞ_ü—‹_km®loc_poŞ
(4096, sdev->
logicb_size
);

8385 ià(!
sdev
->
logicb_buf_poŞ
) {

8386 
	`shªnÚ_”r
("Allocate shannon†ogicb_buf_pool failed.\n");

8387 
vä“
;

8389 
sdev
->
•og_·ge_poŞ
 = 
	`shªnÚ_mempoŞ_ü—‹_km®loc_poŞ
(1, sdev->
logicb_size
);

8390 ià(!
sdev
->
•og_·ge_poŞ
) {

8391 
	`shªnÚ_”r
("Allocate shannonƒpilog_page_pool failed.\n");

8392 
vä“
;

8395 ià(
sdev
->
mbr
.
poŞ_w©”m¬k
) {

8396 
»suÉ
 = 
	`š™_sdev_š_poŞ
(
sdev
);

8397 ià(
»suÉ
) {

8398 
	`shªnÚ_”r
("Device init failed.\n");

8399 
vä“
;

8402 
»suÉ
 = 
	`shªnÚ_®loc_m­_bË
(&
sdev
->
sdisk
, sdev->sdisk.
£ùÜs
, sdev->
logicb_shiá
);

8403 ià(
»suÉ
) {

8404 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for map_table!\n");

8405 
vä“
;

8407 
	`shªnÚ_š™_blk_queue
(
sdev
);

8410 ià(
shªnÚ_memblock_´—Îoc
 != -1) {

8411 
	`shªnÚ_queue_wÜk
(
m­_bË_poŞ
.
memblock_wq
, &m­_bË_poŞ.
®loc_wÜk
);

8412 
	`shªnÚ_queue_wÜk
(
‹mp_bË_poŞ
.
memblock_wq
, &‹mp_bË_poŞ.
®loc_wÜk
);

8415 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

8416 ià(
	`®loc_bbt_nÜ_¡ruùu»
(
sdev
) != 0) {

8417 
	`shªnÚ_”r
("allocate‚or blocks for bbt failed.\n");

8418 
ä“_debug
;

8422 ià(
	`shªnÚ_cdevs_š™
(
sdev
))

8423 
ä“_debug
;

8426 
	`ş—r_ªd_di§bË_š‹¼u±
(
sdev
);

8428 
	`shªnÚ_’abË_œq
(
	`g‘_pci_œq_num
(
sdev
->
pci_dev
));

8430 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

8431 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

8432 
	`wr™e_š‹¼u±_veùÜ
(
sdev
, 
i
);

8433 
»suÉ
 = 
	`chªge_š‹¼u±_što_msix_mode
(
pdev
, 
sdev
);

8435 
	`wr™e_š‹¼u±_veùÜ
(
sdev
, 0);

8436 
»suÉ
 = 
	`chªge_š‹¼u±_što_msi_mode
(
pdev
, 
sdev
);

8438 ià(
»suÉ
 < 0)

8439 
ä“_debug
;

8441 
sdev
->
chunk_»q
[
HOT_INDEX
] = 
NULL
;

8442 
sdev
->
chunk_»qút
[
HOT_INDEX
] = 0;

8443 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
chunk_»q_lock
[
HOT_INDEX
]);

8444 
	`shªnÚ_š™_tim”
(&
sdev
->
fl_sb_tim”
[0]);

8445 #ifdeà
SHANNON_USE_WRITE_BUFFER


8446 
sdev
->
fl_chunk_tim”_expœe
 = 250;

8447 
	`shªnÚ_š™_tim”
(&
sdev
->
fl_chunk_tim”
[0]);

8448 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
fl_chunk_tim”
[
HOT_INDEX
], 
hÙ_fl_chunk_tim”_timeout
);

8450 
	`shªnÚ_š™_d–ayed_wÜk
(&
sdev
->
hÙ_d–ayed_·d
, 
hÙ_·d_sk
);

8452 
sdev
->
chunk_»q
[
COLD_INDEX
] = 
NULL
;

8453 
sdev
->
chunk_»qút
[
COLD_INDEX
] = 0;

8454 
	`shªnÚ_¥š_lock_š™
(&
sdev
->
chunk_»q_lock
[
COLD_INDEX
]);

8455 
	`shªnÚ_š™_tim”
(&
sdev
->
fl_sb_tim”
[1]);

8456 #ifdeà
SHANNON_USE_WRITE_BUFFER


8457 
	`shªnÚ_š™_tim”
(&
sdev
->
fl_chunk_tim”
[1]);

8458 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdev
->
fl_chunk_tim”
[
COLD_INDEX
], 
cŞd_fl_chunk_tim”_timeout
);

8460 
	`shªnÚ_š™_d–ayed_wÜk
(&
sdev
->
cŞd_d–ayed_·d
, 
cŞd_·d_sk
);

8463 ià(
	`š™_”r_šjeùiÚ
(
sdev
) < 0) {

8464 
»suÉ
 = -75;

8465 
”r_šjeùiÚ
;

8468 ià(
shªnÚ_ov”Ïp_wr™e
 && !
	`shªnÚ_dev_is_g5
(
sdev
)) {

8469 
	`shªnÚ_”r
("this device does‚ot support overlap write.\n");

8470 
shªnÚ_ov”Ïp_wr™e
 = 0;

8471 } ià(
sdev
->
ov”Ïp_wr™e
 || 
shªnÚ_ov”Ïp_wr™e
) {

8472 
sdev
->
ov”Ïp
 = 
	`shªnÚ_km®loc
((
shªnÚ_ov”Ïp
), 
GFP_SHANNON
);

8473 ià(
sdev
->
ov”Ïp
 =ğ
NULL
) {

8474 
	`shªnÚ_”r
("failedo‡llocate memory for overlap.\n");

8475 
ä“_œq
;

8477 
	`shªnÚ_mem£t
(
sdev
->
ov”Ïp
, 0, (
shªnÚ_ov”Ïp
));

8478 
	`shªnÚ_š™_wa™queue_h—d
(&
sdev
->
ov”Ïp
->
wa™_ov”Ïp_ev’t
);

8479 
sdev
->
ov”Ïp
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[sdev->
lba_fÜm©
];

8480 
sdev
->
ov”Ïp
->
bufãd_m‘ad©a
 = 
šv®id_m‘ad©a
[sdev->
lba_fÜm©
];

8483 ià(
	`shªnÚ_debugfs_š™
(
sdev
) < 0) {

8484 
»suÉ
 = -75;

8485 
debugfs_ş—nup
;

8488 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

8489 
	`¡¬t_w©chdog_tim”
(
sdev
, 
BOOT_WATCHDOG_SECONDS
);

8492 ià(
sdev
->
¢­_»ad_’abË
 && 
	`shªnÚ_dev_is_g5
(sdev)) {

8493 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

8494 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
))

8496 
	`¢­_»ad_di§bË
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i], 1, 0);

8497 
	`shªnÚ_pŞlšg_cmd
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i]->
phy_lun_num
, 0, 0, 0);

8501 ià(
shªnÚ_lßd_»adÚly
)

8502 
	`shªnÚ_£t_b™
(
SHN_REASON_USER_REQUESTED
, &
sdev
->
»adÚly_»asÚ
);

8504 ià(
	`bud_d©a_¡ruù
(
sdev
) != 0) {

8505 
	`shªnÚ_”r
("cannont finish„ecoveryo build data struct.\n");

8506 
»suÉ
 = -90;

8507 
ä“_œq
;

8509 
sdev
->
pow”_cyşe_couÁ
++;

8510 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
;

8512 ià(
	`should_upd©e_miüocode
(
sdev
))

8513 
	`wr™e_advªûd_»ad_miüocode
(
sdev
, 
	`g‘_upd©e_miüocode
(sdev));

8515 
	`upd©e_acûss_mode
(
sdev
);

8516 
	`check_m¬ked_bad_luns
(
sdev
);

8517 ià(
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
) {

8518 ià(
shªnÚ_´eãtch_’abË
)

8519 
	`shªnÚ_´eãtch_š™
(&
sdev
->
sdisk
.
´eãtch
, sdev->
logicb_size
);

8521 
sdev
->
gc_th»ad
 = 
	`shªnÚ_kth»ad_run
(
gc_th»ad_â
, sdev, "shn_gc_th»ad%c", 'a' + sdev->
drive_no
);

8522 ià(
	`SHANNON_IS_ERR
(
sdev
->
gc_th»ad
)) {

8523 
	`shªnÚ_”r
("create garbage collectionhread failed!\n");

8524 
»suÉ
 = 
	`SHANNON_PTR_ERR
(
sdev
->
gc_th»ad
);

8525 
ä“_œq
;

8528 
sdev
->
»cov”_th»ad
 = 
	`shªnÚ_kth»ad_run
(
»cov”_th»ad_â
, sdev, "shn_»cov”/%c", 'a' + sdev->
drive_no
);

8529 ià(
	`SHANNON_IS_ERR
(
sdev
->
»cov”_th»ad
)) {

8530 
	`shªnÚ_”r
("create„ecoverhread failed!\n");

8531 
»suÉ
 = 
	`SHANNON_PTR_ERR
(
sdev
->
»cov”_th»ad
);

8532 
kl_kth»ad
;

8535 ià(
shªnÚ_´eãtch_’abË
) {

8536 
sdev
->
´eãtch_th»ad
 = 
	`shªnÚ_kth»ad_run
(
´eãtch_th»ad_â
, sdev, "shn_´eãtch/%c", 'a' + sdev->
drive_no
);

8537 ià(
	`SHANNON_IS_ERR
(
sdev
->
´eãtch_th»ad
)) {

8538 
	`shªnÚ_”r
("create…refetchhread failed!\n");

8539 
	`£t_´eãtch_di§bË
(&
sdev
->
sdisk
.
´eãtch
);

8540 
sdev
->
´eãtch_th»ad
 = 
NULL
;

8542 
	`shªnÚ_£t_node_ıus_®lowed
(
sdev
->
´eãtch_th»ad
, sdev->
node
);

8545 
	`shªnÚ_add_tim”
(&
sdev
->
d©a_»‹ÁiÚ_tim”
, 
	`g‘_jiff›s
(è+ sdev->
d©a_»‹ÁiÚ_š‹rv®
 * 
	`g‘_HZ
());

8546 
	`shªnÚ_add_tim”
(&
sdev
->
wl_tim”
, 
	`g‘_jiff›s
(è+ sdev->
wl_tim”_š‹rv®
 * 
	`g‘_HZ
());

8547 
h—d_šdex
 = 0; h—d_šdex < 
sdev
->
h—d_couÁ
; head_index++)

8548 
	`mod_fl_sb_tim”
(
sdev
, 
h—d_šdex
, sdev->
aùive_blk
[head_index]);

8552 ià(
sdev
->
pow”_Ú_£cÚds
 > 1892160000) {

8554 
	`shªnÚ_log
("reset uncorrect…ower_on_seconds %ldo %ld.\n",

8555 
sdev
->
pow”_Ú_£cÚds
, 
MBR_REFRESH_INTERVAL
);

8556 
sdev
->
pow”_Ú_£cÚds
 = 
MBR_REFRESH_INTERVAL
;

8558 
sdev
->
pow”_Ú_£cÚds_hi¡Üy
 = sdev->
pow”_Ú_£cÚds
;

8559 
sdev
->
»äesh_£qu’û
 = sdev->
pow”_Ú_£cÚds
 / 
MBR_REFRESH_INTERVAL
;

8561 
	`»š™_³riod_»ad
(
sdev
);

8562 
	`³riod_»ad_’abË
(
sdev
);

8564 ià(
	`shªnÚ_ü—‹_miscdeviû
(&
sdev
->
misc
, sdev->
cdev_Çme
, 
NULL
, 
FOR_SDEV
)) {

8565 
	`shªnÚ_”r
("çedØ»gi¡” cÚŒŞ miscdeviû %s.\n", 
sdev
->
cdev_Çme
);

8566 
»suÉ
 = -95;

8567 
kl_kth»ad
;

8570 
sdev
->
hwmÚ_dev
 = 
	`shªnÚ_hwmÚ_š™
(sdev->
pci_dev
);

8571 ià(
	`SHANNON_IS_ERR_OR_NULL
(
sdev
->
hwmÚ_dev
)) {

8573 
	`shªnÚ_log
("%s: cªnÙ in™ŸlizhwmÚ deviûs, movÚ.\n", 
sdev
->
cdev_Çme
);

8576 ià(
	`shªnÚ_sysfs_š™
(&
sdev
->
sysfs_kobj
)) {

8577 
	`shªnÚ_”r
("%s:‡dd kobjeùØsysf çed.\n", 
sdev
->
sdisk
.
disk_Çme
);

8578 
»suÉ
 = -99;

8579 
d–_cdev
;

8581 
	`debugs1
("%s: sysf objeù in™ dÚe.\n", 
sdev
->
sdisk
.
disk_Çme
);

8582 
sdev
->
sysfs_š™_dÚe
 = 
SYSFS_INIT_DONE
;

8585 ià(
shªnÚ_auto_©ch
) {

8586 ià(
sdev
->
¥oŞ
) {

8587 ià(
sdev
->
¥oŞ
->
Úlše_sdev_couÁ
 =ğsdev->¥oŞ->
sdev_couÁ
) {

8588 ià(
	`shªnÚ_poŞ_©ch
(
sdev
->
¥oŞ
)) {

8589 
	`shªnÚ_”r
("attach spool failed\n");

8593 ià(
	`shªnÚ_©ch
(
sdev
)) {

8594 
	`shªnÚ_”r
("attach failed\n");

8600 
	`upd©e_io_¡©i¡ics
(
sdev
);

8601 ià(
	`shªnÚ_dev_is_g5
(
sdev
è&& 
shªnÚ_dyÇmic_œq_d–ay
 && sdev->
œq_d–ay
.
dyÇmic_œq_d–ay
)

8602 
	`shªnÚ_add_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`g‘_jiff›s
(è+ 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
));

8604 
	`shªnÚ_šfo
("Probed Dœeù-IO PCIFÏsh /dev/%s: mod–: %s, sn: %s\n", 
sdev
->
cdev_Çme
, sdev->
mod–_id
, sdev->
£rviû_g
);

8606 
sdev
->
š™_dÚe
 = 
STAGE9_DONE
;

8609 
d–_cdev
:

8610 
	`shªnÚ_hwmÚ_ex™
(
pdev
, 
sdev
->
hwmÚ_dev
);

8611 
	`shªnÚ_de¡roy_miscdeviû
(&
sdev
->
misc
);

8612 
kl_kth»ad
:

8613 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
wl_tim”
);

8614 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
d©a_»‹ÁiÚ_tim”
);

8615 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

8616 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_sb_tim”
[
i
]);

8617 #ifdeà
SHANNON_USE_WRITE_BUFFER


8618 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_chunk_tim”
[
i
]);

8622 
	`³riod_»ad_di§bË
(
sdev
);

8623 ià(
sdev
->
´eãtch_th»ad
) {

8624 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
´eãtch_th»ad
);

8625 
sdev
->
´eãtch_th»ad
 = 
NULL
;

8627 ià(
sdev
->
»cov”_th»ad
) {

8628 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
»cov”_th»ad
);

8629 
sdev
->
»cov”_th»ad
 = 
NULL
;

8631 ià(
sdev
->
gc_th»ad
) {

8632 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
gc_th»ad
);

8633 
sdev
->
gc_th»ad
 = 
NULL
;

8635 
ä“_œq
:

8636 
sdev
->
š™_dÚe
 = 
STAGE9_DONE
;

8637 
	`¡İ_w©chdog_tim”
(
sdev
);

8639 
	`shªnÚ_mu‹x_lock
(&
sdev
->
¶ug_out_£m
);

8640 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¶ug_out_£m
);

8642 
	`»Ëa£_aùive_blocks_•og
(
sdev
);

8643 
	`»Ëa£_blocks_gc_¡©e
(
sdev
);

8644 
	`shªnÚ_»Ëa£_•ogs
(
sdev
);

8646 ià(
sdev
->
ov”Ïp
)

8647 
	`shªnÚ_kä“
(
sdev
->
ov”Ïp
);

8648 ià(
sdev
->
»ad_couÁ
)

8649 
	`shªnÚ_vä“
(
sdev
->
»ad_couÁ
);

8650 ià(
sdev
->
sub_groups
)

8651 
	`shªnÚ_vä“
(
sdev
->
sub_groups
);

8652 ià(
sdev
->
sbs
)

8653 
	`shªnÚ_vä“
(
sdev
->
sbs
);

8654 
debugfs_ş—nup
:

8655 
	`shªnÚ_debugfs_ş—nup
(
sdev
);

8656 
”r_šjeùiÚ
:

8657 
	`»Ëa£_”r_šjeùiÚ
(
sdev
);

8658 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

8659 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

8660 
	`shªnÚ_di§bË_msix
(
pdev
, 
sdev
);

8662 
	`shªnÚ_di§bË_msi
(
pdev
, 
sdev
);

8663 
ä“_debug
:

8665 
	`com¶‘iÚ_cdev_»Ëa£
(
sdev
);

8666 
	`commªd_cdev_»Ëa£
(
sdev
);

8667 
	`pba_bË_cdev_»Ëa£
(
sdev
);

8668 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


8669 
	`•og_cdev_ex™
(
sdev
);

8671 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

8672 
	`»Ëa£_bbt_nÜ_¡ruùu»
(
sdev
);

8673 
vä“
:

8675 ià(
sdev
->
¥oŞ
)

8676 
	`»Ëa£_poŞ_¡ruù
(
sdev
->
¥oŞ
);

8678 
	`shªnÚ_m­_bË_ä“
(&
sdev
->
sdisk
);

8680 ià(
sdev
->
•og_·ge_poŞ
)

8681 
	`shªnÚ_mempoŞ_de¡roy
(
sdev
->
•og_·ge_poŞ
);

8682 ià(
sdev
->
logicb_buf_poŞ
)

8683 
	`shªnÚ_mempoŞ_de¡roy
(
sdev
->
logicb_buf_poŞ
);

8685 
	`»Ëa£_lun_¡ruùu»
(
sdev
);

8686 
	`»Ëa£_bufãr_queue
(
sdev
);

8688 #ià
	`defšed
(
CONFIG_SHANNON_EMU
)||defšed(
CONFIG_SHANNON_EMU_MODULE
)

8689 
	`ä“_åga_emu_v¬ŸbËs
(
sdev
);

8691 
	`sdev_ä“_dummy_·ge
(
sdev
);

8692 
pci_deš™
:

8693 
	`»Ëa£_lun£ts_¡ruùu»
(
sdev
);

8695 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

8696 
	`shªnÚ_dev_pci_deš™Ÿlize
(
sdev
);

8697 ià(
shªnÚ_scsi_mode
 == 0)

8698 
	`shªnÚ_pci_£t_drvd©a
(
pdev
, 
NULL
);

8700 
ä“
:

8701 ià(
sdev
->
šv®id_æashids
)

8702 
	`shªnÚ_kä“
(
sdev
->
šv®id_æashids
);

8703 ià(
sdev
->
sdisk
.
queue
)

8704 
	`shªnÚ_blk_ş—nup_queue
(
sdev
->
sdisk
.
queue
);

8705 
	`»Ëa£_wÜkqueues
(
sdev
);

8706 ià(
sdev
->
drive_no
 !ğ
MAX_DEVICE_NO
) {

8707 
	`shªnÚ_¥š_lock_bh
(&
deviû_b™m­_lock
);

8708 
	`shªnÚ_ş—r_b™
(
sdev
->
drive_no
, &
deviû_b™m­
);

8709 
	`shªnÚ_li¡_d–
(&
sdev
->
li¡
);

8710 
	`shªnÚ_¥š_uÆock_bh
(&
deviû_b™m­_lock
);

8712 
	`shªnÚ_pm_qos_»move_»quœem’t
(&
sdev
->
pm_qos_l
, 
SHANNON_PM_QOS_CPU_DMA_LATENCY
, sdev->
sdisk
.
disk_Çme
);

8713 ià(
sdev
->
nÜ_mbr_¡©us
 & 
MICROCODE_FROM_NORFLASH
) {

8714 
	`ä“_miüocode_¬¿y
(
sdev
);

8716 ià(
sdev
->
üc_bË
)

8717 
	`shªnÚ_kä“
(
sdev
->
üc_bË
);

8718 
	`shªnÚ_kä“
(
sdev
);

8719 
	`shªnÚ_”r
("´obçed!„esuÉ=%d.\n", 
»suÉ
);

8720  
»suÉ
;

8721 
	}
}

8723 #ifdeà
SHANNON_USE_WRITE_BUFFER


8724 
	$»Ëa£_chunk_»q
(
shªnÚ_dev
 *
sdev
è{
	}
}

8727 
	$»Ëa£_chunk_»q
(
shªnÚ_dev
 *
sdev
)

8729 
h—d_šdex
;

8730 
shªnÚ_»que¡
 *
»q
, *
tmp
;

8731 
shªnÚ_sb
 *
sb
;

8733 
h—d_šdex
 = 0; h—d_šdex < 
sdev
->
h—d_couÁ
; head_index++) {

8734 ià(
sdev
->
chunk_»q
[
h—d_šdex
]) {

8735 
tmp
 = 
sdev
->
chunk_»q
[
h—d_šdex
];

8736 
sb
 = 
sdev
->
sbs
 + 
tmp
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

8738 
»q
 = 
tmp
;

8739 
tmp
 = 
	`shªnÚ_li¡_’Œy
(
»q
->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

8740 
	`shªnÚ_li¡_d–_š™
(&
»q
->
chunk_li¡
);

8741 
sdev
->
chunk_»qút
[
h—d_šdex
]--;

8742 ià(
»q
->
sbio
) {

8743 
»q
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

8744 
»q
->
¡©e
 = 
REQ_DONE
;

8745 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

8747 
	`ä“_»q
(
»q
);

8748 
	`shªnÚ_©omic_dec
(&
sb
->
š_wr™e_logicbs
);

8750 } 
»q
 !ğ
tmp
);

8751 
sdev
->
chunk_»q
[
h—d_šdex
] = 
NULL
;

8754 
	}
}

8757 
šlše
 
	$shªnÚ_æush_ÿÎback_wq
(
shªnÚ_dev
 *
sdev
)

8759 
i
;

8760 
i
 = 0; i < 
sdev
->
ÿÎback_Ä_wq
; i++) {

8761 ià(
sdev
->
shªnÚ_ÿÎback_wq
[
i
])

8762 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
shªnÚ_ÿÎback_wq
[
i
]);

8764 
	}
}

8766 
	$__d¿š_commªd_queue
(
shªnÚ_dev
 *
sdev
)

8768 
i
, 
j
, 
h—d_šdex
;

8770 
j
 = 0; j < 5; j++) {

8772 
	`³riod_»ad_di§bË
(
sdev
);

8773 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
gc_tim”_wq
);

8774 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
wl_wq
);

8775 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
»ad_”r_wq
);

8776 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
»äesh_wq
);

8777 ià(
sdev
->
shªnÚ_comp_wq
)

8778 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
shªnÚ_comp_wq
);

8779 ià(
sdev
->
shªnÚ_¹_comp_wq
)

8780 
	`shªnÚ_æush_¹_wÜkqueue
(
sdev
->
shªnÚ_¹_comp_wq
);

8781 
i
 = 0; i < 
sdev
->
shªnÚ_Ä_wq
; i++)

8782 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
hªdË_lun_wq
[
i
]);

8783 
	`shªnÚ_æush_ÿÎback_wq
(
sdev
);

8784 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
shªnÚ_»ad_wq
);

8785 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
shªnÚ_wq
);

8786 
	`shªnÚ_pick_»que¡
(
sdev
, 0xffffffff);

8787 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

8788 
	`lun£t_pick_»que¡
(&
sdev
->
lun£ts
[
i
], 0xffffffff);

8789 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
gc_tim”
);

8790 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
b®ªû_gc_tim”
);

8791 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
wl_tim”
);

8792 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
d©a_»‹ÁiÚ_tim”
);

8793 
h—d_šdex
 = 0; h—d_šdex < 
sdev
->
h—d_couÁ
; head_index++) {

8794 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_sb_tim”
[
h—d_šdex
]);

8795 #ifdeà
SHANNON_USE_WRITE_BUFFER


8796 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_chunk_tim”
[
h—d_šdex
]);

8799 
	`shªnÚ_m¦“p
(5);

8800 } !
	`®l_cmd_queue_is_em±y
(
sdev
è|| !
	`®l_»q_queue_is_em±y
(sdev) || \

8801 !
	`®l_lun£t_»q_queue_is_em±y
(
sdev
) ||

8802 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
));

8804 
	}
}

8806 
	gshªnÚ_fl_lšes
 = 5;

8808 
	$d¿š_commªd_queue
(
shªnÚ_dev
 *
sdev
, 
fl_·ge_¡re
)

8810 
i
, 
lše
, 
Şd_sb
;

8812 ià(
sdev
->
¶ug_out
)

8814 
sdev
->
¡İ_®l
 = 1;

8815 #iâdeà
SHANNON_USE_WRITE_BUFFER


8816 ià(
sdev
->
chunk_»q
[
HOT_INDEX
])

8817 
	`shªnÚ_ÿnûl_d–ayed_wÜk
(&
sdev
->
hÙ_d–ayed_·d
);

8818 ià(
sdev
->
u£_du®_h—d
) {

8819 ià(
sdev
->
chunk_»q
[
COLD_INDEX
])

8820 
	`shªnÚ_ÿnûl_d–ayed_wÜk
(&
sdev
->
cŞd_d–ayed_·d
);

8823 
	`__d¿š_commªd_queue
(
sdev
);

8825 ià(
fl_·ge_¡re
 && (
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
)) {

8826 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

8827 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

8828 
Şd_sb
 = 
sdev
->
wr_sb
[
i
];

8829 
lše
 = 0;†š< 
shªnÚ_fl_lšes
;†ine++) {

8830 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

8832 (
sdev
->
wr_logicb
[
i
] !ğ0è|| (sdev->
wr_¶ªe
[i] != 0))

8833 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

8835 (
sdev
->
lun_š_group
[
i
] !ğ0è|| (sdev->
wr_group
[i] != 0))

8836 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

8837 ià(
sdev
->
wr_sb
[
i
] !ğ
Şd_sb
)

8841 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

8843 
	`»Ëa£_chunk_»q
(
sdev
);

8845 
	`__d¿š_commªd_queue
(
sdev
);

8847 ià(
sdev
->
¢­_»ad_’abË
 && 
	`shªnÚ_dev_is_g5
(sdev)) {

8848 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

8849 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
))

8851 
	`¢­_»ad_di§bË
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i], 1, 0);

8852 
	`shªnÚ_pŞlšg_cmd
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i]->
phy_lun_num
, 0, 0, 0);

8855 
	`__d¿š_commªd_queue
(
sdev
);

8856 
sdev
->
¡İ_®l
 = 0;

8857 
	`debugs1
("HOT: sb=%d,†un=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

8858 
sdev
->
wr_sb
[0], sdev->
wr_lun_off£t
[0], sdev->
wr_chunk
[0], sdev->
wr_¶ªe
[0], sdev->
wr_·ge
[0], sdev->
wr_logicb
[0]);

8859 
	`debugs1
("COLD: sb=%d,†un=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

8860 
sdev
->
wr_sb
[1], sdev->
wr_lun_off£t
[1], sdev->
wr_chunk
[1], sdev->
wr_¶ªe
[1], sdev->
wr_·ge
[1], sdev->
wr_logicb
[1]);

8861 
	}
}

8863 
	$com¶‘e_³ndšg_»que¡
(
shªnÚ_dev
 *
sdev
)

8865 
shªnÚ_»que¡
 *
´eq
;

8866 
shªnÚ_lun£t
 *
lun£t
;

8867 
shªnÚ_cmd_šfo
 *
šfo
;

8868 
i
, 
cmdid
, 
»Œ›s
 = 0;

8870 ià(
	`shªnÚ_mu‹x_Œylock
(&
sdev
->
¶ug_out_£m
) == 0)

8873 
»Œy
:

8874 
	`shªnÚ_pŞlšg
(
sdev
)) {

8875 
	`shªnÚ_šfo
("wait…olling...\n");

8876 
	`shªnÚ_m¦“p
(3);

8878 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

8879 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

8880 
	`shªnÚ_wake_up
(&
sdev
->
block_ho¡_wr
);

8882 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
gc_wr™e_queue
è&& 
	`shªnÚ_mu‹x_Œylock
(&sdev->
pick_£m
)) {

8884 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
gc_wr™e_queue_lock
);

8885 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
gc_wr™e_queue
)) {

8886 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_wr™e_queue_lock
);

8889 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
gc_wr™e_queue
, 
shªnÚ_»que¡
, 
li¡
);

8890 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

8891 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
gc_wr™e_queue_lock
);

8892 
	`shªnÚ_©omic_dec
(&
sdev
->
gc_wr™e_»qs
);

8893 ià(
´eq
->
sbio
) {

8894 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

8895 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

8896 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

8897 
´eq
->
¡©e
 = 
REQ_DONE
;

8898 ià(
	`is_wa™_pick_»q
(
´eq
))

8899 
	`hªdË_wa™_pick_»q
(
sdev
, 
´eq
);

8900 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

8902 
	`ä“_»q
(
´eq
);

8904 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

8907 
i
 = 
PRIORITY_LEVELS
 - 1; i >= 0; i--) {

8908 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[
i
]è&& 
	`shªnÚ_mu‹x_Œylock
(&sdev->
pick_£m
)) {

8910 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

8911 ià(
	`shªnÚ_li¡_em±y
(&
sdev
->
»q_queue
[
i
])) {

8912 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

8915 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sdev
->
»q_queue
[
i
], 
shªnÚ_»que¡
, 
li¡
);

8916 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

8917 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»q_queue_lock
[
i
]);

8918 ià(
´eq
->
İcode
 =ğ
sh_cmd_wr™e
) {

8919 
	`shªnÚ_©omic_dec
(&
sdev
->
wr™e_»qs
[
i
]);

8921 ià(
	`ho¡_»q_queue_Ëngth
(
sdev
è< 
REQ_QUEUE_THRESHOLD_L
)

8922 
sdev
->
š_block_¡©e
 = 0;

8923 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
wr™e_»qs
[1]è< 
REQ_QUEUE_THRESHOLD_L
) {

8924 ià(
sdev
->
š_block_¡©e
 > 1)

8925 
sdev
->
š_block_¡©e
 = 1;

8928 ià((
sdev
->
š_block_¡©e
 < 2è&& 
	`shªnÚ_wa™queue_aùive
(&sdev->
lim™_»q_queue
[1]))

8929 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

8931 ià((
sdev
->
š_block_¡©e
 < 1è&& 
	`shªnÚ_wa™queue_aùive
(&sdev->
lim™_»q_queue
[0]))

8932 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

8934 ià(
´eq
->
sbio
) {

8935 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

8936 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

8937 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

8938 
´eq
->
¡©e
 = 
REQ_DONE
;

8939 ià(
	`is_wa™_pick_»q
(
´eq
))

8940 
	`hªdË_wa™_pick_»q
(
sdev
, 
´eq
);

8941 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

8943 
	`ä“_»q
(
´eq
);

8945 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

8949 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

8950 
lun£t
 = &
sdev
->
lun£ts
[
i
];

8951 ià(!
	`shªnÚ_li¡_em±y
(&
lun£t
->
»q_queue
)) {

8953 
	`shªnÚ_¥š_lock_bh
(&
lun£t
->
»q_queue_lock
);

8954 ià(
	`shªnÚ_li¡_em±y
(&
lun£t
->
»q_queue
)) {

8955 
	`shªnÚ_¥š_uÆock_bh
(&
lun£t
->
»q_queue_lock
);

8958 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
lun£t
->
»q_queue
, 
shªnÚ_»que¡
, 
li¡
);

8959 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

8960 
	`shªnÚ_¥š_uÆock_bh
(&
lun£t
->
»q_queue_lock
);

8961 ià(
´eq
->
sbio
) {

8962 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

8963 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

8964 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

8965 
´eq
->
¡©e
 = 
REQ_DONE
;

8966 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

8968 
	`ä“_»q
(
´eq
);

8973 
	`shªnÚ_m¦“p
(5);

8974 ià(
sdev
->
shªnÚ_comp_wq
)

8975 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
shªnÚ_comp_wq
);

8976 ià(
sdev
->
shªnÚ_¹_comp_wq
)

8977 
	`shªnÚ_æush_¹_wÜkqueue
(
sdev
->
shªnÚ_¹_comp_wq
);

8978 
i
 = 0; i < 
sdev
->
shªnÚ_Ä_wq
; i++)

8979 
	`shªnÚ_æush_wÜkqueue
(
sdev
->
hªdË_lun_wq
[
i
]);

8981 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

8982 
lun£t
 = &
sdev
->
lun£ts
[
i
];

8983 
	`shªnÚ_©omic_»ad
(&
lun£t
->
š_wq
))

8984 
	`shªnÚ_m¦“p
(1);

8986 
lun£t
->
cq_
 !ğlun£t->
sq_h—d
) {

8987 
cmdid
 = 
lun£t
->
cq_
 >> 3;

8988 
šfo
 = &
lun£t
->
cmd_šfo
[
cmdid
];

8989 !
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

8990 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

8991 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

8992 ià(
´eq
->
sbio
) {

8993 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

8994 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

8995 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

8996 
´eq
->
¡©e
 = 
REQ_DONE
;

8997 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

8999 
	`ä“_»q
(
´eq
);

9001 
lun£t
->
cq_
 = (lun£t->cq_ + 
šfo
->
cmd_Ën
è% 
QUEUE_SIZE
;

9002 
lun£t
->
cq__tmp
 =†un£t->
cq_
;

9003 
	`shªnÚ_wake_up
(&
lun£t
->
wa™_cmd_pos
);

9005 ià(
lun£t
->
cq_
 !ğlun£t->
sq_h—d_tmp
)

9006 
	`shªnÚ_m¦“p
(1);

9007 } 
lun£t
->
cq_
 !ğlun£t->
sq_h—d_tmp
);

9010 #ifdeà
SHANNON_USE_WRITE_BUFFER


9011 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

9013 
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d
[i]) {

9014 
cmdid
 = 
sdev
->
bufq_cq_
[
i
] >> 3;

9015 
šfo
 = &
sdev
->
cmd_šfo
[
i
][
cmdid
];

9016 !
	`shªnÚ_li¡_em±y
(&
šfo
->
»q_li¡
)) {

9017 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
šfo
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

9018 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

9019 ià(
´eq
->
sbio
) {

9020 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

9021 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

9022 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

9023 
´eq
->
¡©e
 = 
REQ_DONE
;

9024 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

9026 
	`ä“_»q
(
´eq
);

9028 
sdev
->
bufq_cq_
[
i
] = (sdev->bufq_cq_[i] + 
šfo
->
cmd_Ën
è% 
QUEUE_SIZE
;

9029 
	`shªnÚ_wake_up
(&
sdev
->
bufq_wa™_cmd_pos
[
i
]);

9031 ià(
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d_tmp
[i])

9032 
	`shªnÚ_m¦“p
(1);

9033 } 
sdev
->
bufq_cq_
[
i
] !ğsdev->
bufq_sq_h—d_tmp
[i]);

9037 ià(
	`shªnÚ_mu‹x_Œylock
(&
sdev
->
pick_£m
) == 0)

9038 
out
;

9040 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

9041 ià(
sdev
->
chunk_»q
[
i
]) {

9042 
j
, 
Ãeded
;

9044 
	`BUG_ON
(
sdev
->
chunk_»qút
[
i
] =ğsdev->
logicbs_š_chunk
);

9045 
Ãeded
 = 
sdev
->
logicbs_š_chunk
 - sdev->
chunk_»qút
[
i
];

9046 
j
 = 0; j < 
Ãeded
; j++) {

9047 
sdev
->
chunk_»qút
[
i
] > 1) {

9048 
´eq
 = 
	`shªnÚ_li¡_’Œy
(
sdev
->
chunk_»q
[
i
]->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

9049 ià(
´eq
 =ğ
sdev
->
chunk_»q
[
i
])

9050 
sdev
->
chunk_»q
[
i
] = 
NULL
;

9051 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
chunk_li¡
);

9052 
sdev
->
chunk_»qút
[
i
]--;

9053 ià(
´eq
->
sbio
) {

9054 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

9055 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

9056 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

9057 
´eq
->
¡©e
 = 
REQ_DONE
;

9058 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

9060 
	`ä“_»q
(
´eq
);

9063 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

9066 
sdev
->
chunk_»qút
[
i
]) {

9067 
´eq
 = 
	`shªnÚ_li¡_’Œy
(
sdev
->
chunk_»q
[
i
]->
chunk_li¡
.
Ãxt
, 
shªnÚ_»que¡
, chunk_list);

9068 ià(
´eq
 =ğ
sdev
->
chunk_»q
[
i
])

9069 
sdev
->
chunk_»q
[
i
] = 
NULL
;

9070 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
chunk_li¡
);

9071 
sdev
->
chunk_»qút
[
i
]--;

9072 ià(
´eq
->
sbio
) {

9073 ià(
´eq
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

9074 
´eq
->
_ecc
 = 
SH_SOFT_ERR_1
;

9075 
´eq
->
sbio
->
¡©us
 |ğ
HAVE_ERROR_SECTOR
;

9076 
´eq
->
¡©e
 = 
REQ_DONE
;

9077 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

9079 
	`ä“_»q
(
´eq
);

9081 
	`BUG_ON
((
sdev
->
chunk_»q
[
i
] !ğ
NULL
è|| (sdev->
chunk_»qút
[i] != 0));

9084 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

9086 
out
:

9087 ià(
	`shªnÚ_bio_š_æight
(
sdev
)) {

9088 
	`shªnÚ_šfo
("biØi š_æight, gÙØ»Œy!„‘r›s=%d.\n", 
»Œ›s
);

9089 
»Œ›s
++;

9090 
	`shªnÚ_m¦“p
(5);

9091 ià(
»Œ›s
 < 1000)

9092 
»Œy
;

9094 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
¶ug_out_£m
);

9095 
	}
}

9097 
	$wr™eback_ov”Ïp_pba
(
shªnÚ_dev
 *
sdev
)

9099 
vaÿncy
;

9100 
shªnÚ_ov”Ïp
 *
Ş
 = 
sdev
->
ov”Ïp
;

9103 ià(
Ş
->
_m‘ad©a
 !ğ
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
]) {

9104 
	`wr™e_back_ov”Ïp_d©a
(
sdev
);

9105 
Ş
->
_m‘ad©a
 = 
šv®id_m‘ad©a
[
sdev
->
lba_fÜm©
];

9106 
	`£nd_dummy_ov”Ïp_»q
(
sdev
, 1);

9110 
vaÿncy
 = (
sdev
->
¶ªes
 - 
Ş
->
wr_¶ªe
è* sdev->
logicbs_š_·ge
 - ol->
wr_logicb
;

9111 
	`BUG_ON
(
vaÿncy
 >ğ
sdev
->
logicbs_š_chunk
 || vacancy < 0);

9112 
vaÿncy
) {

9113 
	`£nd_dummy_ov”Ïp_»q
(
sdev
, 0);

9114 
vaÿncy
--;

9117 
	`debugs1
("overlap: wr_chunk=%d, wr_page=%d, wr_logicb=%d, wr_plane=%d, wr_lun=%d.\n", \

9118 
Ş
->
wr_chunk
, ol->
wr_·ge
, ol->
wr_logicb
, ol->
wr_¶ªe
, ol->
wr_lun
);

9120 
	}
}

9122 
	$__shªnÚ_»move
(
shªnÚ_dev
 *
sdev
)

9124 
i
;

9125 
shªnÚ_pci_dev_t
 *
pdev
 = 
sdev
->
pci_dev
;

9127 
	`shªnÚ_bio_š_æight
(
sdev
)) {

9128 ià(
sdev
->
¶ug_out
)

9129 
	`com¶‘e_³ndšg_»que¡
(
sdev
);

9130 
	`shªnÚ_m¦“p
(50);

9133 ià(
sdev
->
¥oŞ
)

9134 
	`shªnÚ_poŞ_d‘ach
(
sdev
->
¥oŞ
);

9136 
	`shªnÚ_d‘ach
(
sdev
);

9137 ià(
sdev
->
sysfs_š™_dÚe
 =ğ
SYSFS_INIT_DONE
)

9138 
	`shªnÚ_sysfs_ex™
(&
sdev
->
sysfs_kobj
);

9140 
	`shªnÚ_pm_qos_»move_»quœem’t
(&
sdev
->
pm_qos_l
, 
SHANNON_PM_QOS_CPU_DMA_LATENCY
, sdev->
sdisk
.
disk_Çme
);

9141 
	`¡İ_w©chdog_tim”
(
sdev
);

9142 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
gc_tim”
);

9143 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
b®ªû_gc_tim”
);

9144 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
wl_tim”
);

9145 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
d©a_»‹ÁiÚ_tim”
);

9146 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

9147 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_sb_tim”
[
i
]);

9148 #ifdeà
SHANNON_USE_WRITE_BUFFER


9149 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
fl_chunk_tim”
[
i
]);

9152 ià(
sdev
->
¶ug_out
 || (sdev->
¡©e
 & 
SHN_STATE_ERROR_BIT
)) {

9154 
	`com¶‘e_³ndšg_»que¡
(
sdev
);

9155 
	`shªnÚ_m¦“p
(50);

9156 } !
	`®l_cmd_queue_is_em±y
(
sdev
è|| !
	`®l_»q_queue_is_em±y
(sdev) || \

9157 !
	`®l_lun£t_»q_queue_is_em±y
(
sdev
) || \

9158 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_gc_logicbs
));

9160 ià(
sdev
->
ov”Ïp_wr™e
 && sdev->
»adÚly_»asÚ
 == 0) {

9161 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

9162 
	`wr™eback_ov”Ïp_pba
(
sdev
);

9163 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

9165 
	`d¿š_commªd_queue
(
sdev
, 1);

9168 
	`shªnÚ_š_œq
(
sdev
))

9169 
	`shªnÚ_m¦“p
(1);

9171 
	`debug_´št
("HOT: sb=%d,†un=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

9172 
sdev
->
wr_sb
[0], sdev->
wr_lun_off£t
[0], sdev->
wr_chunk
[0], sdev->
wr_¶ªe
[0], sdev->
wr_·ge
[0], sdev->
wr_logicb
[0]);

9173 
	`debug_´št
("COLD: sb=%d,†un=%d, chunk=%d,…lane=%d,…age=%d,†ogicb=%d.\n",

9174 
sdev
->
wr_sb
[1], sdev->
wr_lun_off£t
[1], sdev->
wr_chunk
[1], sdev->
wr_¶ªe
[1], sdev->
wr_·ge
[1], sdev->
wr_logicb
[1]);

9175 
	`shªnÚ_hwmÚ_ex™
(
pdev
, 
sdev
->
hwmÚ_dev
);

9176 
	`shªnÚ_de¡roy_miscdeviû
(&
sdev
->
misc
);

9178 
	`shªnÚ_´eãtch_de¡roy
(&
sdev
->
sdisk
.
´eãtch
);

9179 
	`»Ëa£_aùive_blocks_•og
(
sdev
);

9180 
	`»Ëa£_blocks_gc_¡©e
(
sdev
);

9181 
	`shªnÚ_»Ëa£_•ogs
(
sdev
);

9182 
	`shªnÚ_vä“
(
sdev
->
»ad_couÁ
);

9183 
	`shªnÚ_vä“
(
sdev
->
sub_groups
);

9184 
	`shªnÚ_vä“
(
sdev
->
sbs
);

9185 
	`shªnÚ_debugfs_ş—nup
(
sdev
);

9186 
	`»Ëa£_”r_šjeùiÚ
(
sdev
);

9188 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

9189 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

9190 
	`shªnÚ_di§bË_msix
(
pdev
, 
sdev
);

9192 
	`shªnÚ_di§bË_msi
(
pdev
, 
sdev
);

9195 
	`com¶‘iÚ_cdev_»Ëa£
(
sdev
);

9196 
	`commªd_cdev_»Ëa£
(
sdev
);

9197 
	`pba_bË_cdev_»Ëa£
(
sdev
);

9198 #ifdeà
CONFIG_SHANNON_EPILOG_CDEV


9199 
	`•og_cdev_ex™
(
sdev
);

9202 ià(
sdev
->
ov”Ïp
)

9203 
	`shªnÚ_kä“
(
sdev
->
ov”Ïp
);

9205 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

9206 
	`»Ëa£_bbt_nÜ_¡ruùu»
(
sdev
);

9208 ià(
sdev
->
¥oŞ
) {

9209 
	`»Ëa£_sdev_m­_bË
(
sdev
);

9210 
	`»Ëa£_poŞ_¡ruù
(
sdev
->
¥oŞ
);

9212 
	`shªnÚ_m­_bË_ä“
(&
sdev
->
sdisk
);

9214 ià(
sdev
->
•og_·ge_poŞ
)

9215 
	`shªnÚ_mempoŞ_de¡roy
(
sdev
->
•og_·ge_poŞ
);

9216 ià(
sdev
->
logicb_buf_poŞ
)

9217 
	`shªnÚ_mempoŞ_de¡roy
(
sdev
->
logicb_buf_poŞ
);

9219 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

9220 
	`»Ëa£_lun_¡ruùu»
(
sdev
);

9221 
	`»Ëa£_bufãr_queue
(
sdev
);

9224 
	`sdev_ä“_dummy_·ge
(
sdev
);

9225 #ià!
	`defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

9226 
	`shªnÚ_dev_pci_deš™Ÿlize
(
sdev
);

9229 
	`»Ëa£_lun£ts_¡ruùu»
(
sdev
);

9231 ià(
sdev
->
šv®id_æashids
)

9232 
	`shªnÚ_kä“
(
sdev
->
šv®id_æashids
);

9233 ià(
sdev
->
sdisk
.
queue
)

9234 
	`shªnÚ_blk_ş—nup_queue
(
sdev
->
sdisk
.
queue
);

9235 
	`»Ëa£_wÜkqueues
(
sdev
);

9236 ià(
sdev
->
üc_bË
)

9237 
	`shªnÚ_kä“
(
sdev
->
üc_bË
);

9238 
	`sh_deü—£_u£rs
(
sdev
);

9239 
	}
}

9241 
	$shªnÚ_¶ugout_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

9243 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
¶ugout_wÜk
);

9247 ià(
sdev
->
sdisk
.
ex™
)

9251 
	`com¶‘e_³ndšg_»que¡
(
sdev
);

9252 } 
sdev
->
š™_dÚe
 < 
STAGE9_DONE
);

9253 
	}
}

9255 
	$shªnÚ_ejeù_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

9257 
shªnÚ_d–ayed_wÜk
 *
ejeù_wÜk
 = 
	`g‘_d–ayed_wÜk
(
wÜk
);

9258 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
ejeù_wÜk
, shannon_dev,ƒject_work);

9259 
	`shªnÚ_di§bË_¦Ù
(
sdev
->
pci_dev
);

9260 
	}
}

9262 
	$shªnÚ_»move
(
shªnÚ_dev
 *
d©a
, 
shªnÚ_pci_dev_t
 *
pdev
)

9264 
shªnÚ_dev
 *
sdev
;

9266 ià(
shªnÚ_scsi_mode
)

9267 
sdev
 = 
d©a
;

9269 
sdev
 = 
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

9271 ià((
sdev
 =ğ
NULL
è|| (sdev->
sdisk
.
ex™
 == 1))

9273 
sdev
->
sdisk
.
ex™
 = 1;

9274 ià(
sdev
->
¥oŞ
)

9275 
sdev
->
¥oŞ
->
ex™
 = 1;

9276 
	`check_¶ugout
(
sdev
);

9278 ià(
sdev
->
´eãtch_th»ad
) {

9279 
	`£t_´eãtch_di§bË
(&
sdev
->
sdisk
.
´eãtch
);

9280 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
´eãtch_th»ad
);

9281 
sdev
->
´eãtch_th»ad
 = 
NULL
;

9283 ià(
sdev
->
»cov”_th»ad
) {

9284 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
»cov”_th»ad
);

9285 
sdev
->
»cov”_th»ad
 = 
NULL
;

9287 ià(
sdev
->
gc_th»ad
) {

9288 
	`shªnÚ_kth»ad_¡İ
(
sdev
->
gc_th»ad
);

9289 
sdev
->
gc_th»ad
 = 
NULL
;

9292 
	`__shªnÚ_»move
(
sdev
);

9293 ià(
shªnÚ_scsi_mode
 == 0)

9294 
	`shªnÚ_pci_£t_drvd©a
(
pdev
, 
NULL
);

9295 
	}
}

9297 
	$shªnÚ_®loc_mempoŞ
()

9299 
shªnÚ_»q_¦ab
 = 
	`shªnÚ_kmem_ÿche_ü—‹
("shannon_req_cache",

9300 (
shªnÚ_»que¡
), 0, 
SHN_SLAB_HWCACHE_ALIGN
, 
NULL
);

9301 ià(!
shªnÚ_»q_¦ab
) {

9302 
	`shªnÚ_”r
("cannot init‡ shannon_req slab.\n");

9305 
shªnÚ_bio_¦ab
 = 
	`shªnÚ_kmem_ÿche_ü—‹
("shannon_bio_cache",

9306 (
shªnÚ_bio
), 0, 
SHN_SLAB_HWCACHE_ALIGN
, 
NULL
);

9307 ià(!
shªnÚ_bio_¦ab
) {

9308 
	`shªnÚ_”r
("cannot init‡ shannon_bio slab.\n");

9309 
ä“_»q_¦ab
;

9311 
shªnÚ_»q_poŞ
 = 
	`shªnÚ_mempoŞ_ü—‹_¦ab_poŞ
(8192, 
shªnÚ_»q_¦ab
);

9312 ià(!
shªnÚ_»q_poŞ
) {

9313 
	`shªnÚ_”r
("cannot init‡ shannon_req…ool.\n");

9314 
ä“_bio_¦ab
;

9316 
shªnÚ_bio_poŞ
 = 
	`shªnÚ_mempoŞ_ü—‹_¦ab_poŞ
(4096, 
shªnÚ_bio_¦ab
);

9317 ià(!
shªnÚ_bio_poŞ
) {

9318 
	`shªnÚ_”r
("cannot init‡ shannon_bio…ool.\n");

9319 
ä“_»q_poŞ
;

9321 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


9322 
	`SHANNON_INIT_LIST_HEAD
(&
out¡ªdšg_»qs_li¡
);

9323 
	`shªnÚ_¥š_lock_š™
(&
out¡ªdšg_»qs_li¡_lock
);

9324 
	`SHANNON_INIT_LIST_HEAD
(&
out¡ªdšg_sbios_li¡
);

9325 
	`shªnÚ_¥š_lock_š™
(&
out¡ªdšg_sbios_li¡_lock
);

9330 
ä“_»q_poŞ
:

9331 
	`shªnÚ_mempoŞ_de¡roy
(
shªnÚ_»q_poŞ
);

9332 
ä“_bio_¦ab
:

9333 
	`shªnÚ_kmem_ÿche_de¡roy
(
shªnÚ_bio_¦ab
);

9334 
ä“_»q_¦ab
:

9335 
	`shªnÚ_kmem_ÿche_de¡roy
(
shªnÚ_»q_¦ab
);

9338 
	}
}

9340 
	$shªnÚ_ä“_mempoŞ
()

9342 #ifdeà
CONFIG_SHANNON_DEBUG_REQS


9343 
shªnÚ_»que¡
 *
»q
;

9344 
shªnÚ_bio
 *
sbio
;

9346 ià(
	`uÆik–y
(!
	`shªnÚ_li¡_em±y
(&
out¡ªdšg_sbios_li¡
))) {

9347 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

9348 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sbio
, &
out¡ªdšg_sbios_li¡
, 
debug_li¡
)

9349 
	`shªnÚ_šfo
("sbio->g=0x%lx.\n", 
sbio
->
g
);

9350 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_sbios_li¡_lock
);

9352 ià(
	`uÆik–y
(!
	`shªnÚ_li¡_em±y
(&
out¡ªdšg_»qs_li¡
))) {

9353 
	`shªnÚ_¥š_lock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

9354 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
»q
, &
out¡ªdšg_»qs_li¡
, 
debug_li¡
)

9355 
	`shªnÚ_šfo
("lun=%d,†un_pba=%d,ag=0x%lx.\n", 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
g
);

9356 
	`shªnÚ_¥š_uÆock_bh
(&
out¡ªdšg_»qs_li¡_lock
);

9359 ià(
shªnÚ_bio_poŞ
)

9360 
	`shªnÚ_mempoŞ_de¡roy
(
shªnÚ_bio_poŞ
);

9361 ià(
shªnÚ_»q_poŞ
)

9362 
	`shªnÚ_mempoŞ_de¡roy
(
shªnÚ_»q_poŞ
);

9363 ià(
shªnÚ_bio_¦ab
)

9364 
	`shªnÚ_kmem_ÿche_de¡roy
(
shªnÚ_bio_¦ab
);

9365 ià(
shªnÚ_»q_¦ab
)

9366 
	`shªnÚ_kmem_ÿche_de¡roy
(
shªnÚ_»q_¦ab
);

9367 
	}
}

9369 
	$__shªnÚ_pci_»£t_´•¬e
(
shªnÚ_pci_dev_t
 *
pdev
)

9371 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

9372 
i
;

9374 
	`¡İ_w©chdog_tim”
(
sdev
);

9375 
sdev
->
big_lock
 = 1;

9376 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

9377 ià(
has_dma_d–ay
)

9378 
	`__shªnÚ_pick_»que¡
(
sdev
, 0xffffffff);

9379 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

9380 
	`shªnÚ_mu‹x_lock
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

9382 
	`shªnÚ_šfo
("%s: wa™ commªd queui em±y.\n", 
sdev
->
cdev_Çme
);

9383 !
	`®l_cmd_queue_is_em±y
(
sdev
))

9384 
	`shªnÚ_m¦“p
(1);

9385 
	`shªnÚ_šfo
("%s: commªd queui em±y‚ow.\n", 
sdev
->
cdev_Çme
);

9387 ià(
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
) {

9388 
	`shªnÚ_šfo
("%s: fÈ·g¡re.....\n", 
sdev
->
cdev_Çme
);

9389 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

9390 (
sdev
->
lun_š_group
[
i
] != 0) || \

9391 (
sdev
->
wr_group
[
i
] != 0) || \

9392 (
sdev
->
wr_¶ªe
[
i
] != 0) || \

9393 (
sdev
->
wr_logicb
[
i
] != 0))

9394 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

9399 #ifdeà
SHANNON_USE_WRITE_BUFFER


9400 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[0]);

9401 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[1]);

9403 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

9404 
	`shªnÚ_mu‹x_lock
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

9406 
	`shªnÚ_šfo
("%s: wa™ commªd queui em±y.\n", 
sdev
->
cdev_Çme
);

9407 !
	`®l_cmd_queue_is_em±y
(
sdev
))

9408 
	`shªnÚ_m¦“p
(1);

9411 ià(
sdev
->
¢­_»ad_’abË
 && 
	`shªnÚ_dev_is_g5
(sdev)) {

9412 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

9413 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
))

9415 
	`¢­_»ad_di§bË
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i], 1, 1);

9416 
	`shªnÚ_pŞlšg_cmd
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i]->
phy_lun_num
, 0, 0, 0);

9419 !
	`®l_cmd_queue_is_em±y
(
sdev
))

9420 
	`shªnÚ_m¦“p
(1);

9421 
	`shªnÚ_šfo
("%s: commªd queui em±y‚ow.\n", 
sdev
->
cdev_Çme
);

9424 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

9425 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

9426 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

9427 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

9428 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

9429 
	}
}

9431 
	$__shªnÚ_pci_»£t_fšished
(
shªnÚ_pci_dev_t
 *
pdev
)

9433 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

9434 
i
;

9437 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

9438 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

9439 
	`wr™e_š‹¼u±_veùÜ
(
sdev
, 
i
);

9441 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

9442 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

9443 #ifdeà
SHANNON_USE_WRITE_BUFFER


9444 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[0]);

9445 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[1]);

9447 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

9448 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

9449 ià(!
	`lun£t_»q_queue_is_em±y
(&
sdev
->
lun£ts
[
i
]))

9450 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun£ts
[
i
].
subm™_wÜk
);

9452 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

9453 
sdev
->
big_lock
 = 0;

9454 
	`shªnÚ_wake_up
(&
sdev
->
big_lock_ev’t
);

9455 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

9456 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

9457 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

9458 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

9459 
	`¡¬t_w©chdog_tim”
(
sdev
, 
WATCHDOG_SECONDS
);

9460 
	}
}

9462 
	$lun£t_queue_d•th
(
shªnÚ_lun£t
 *
lun£t
)

9464  (
lun£t
->
sq_h—d_tmp
 + 
QUEUE_SIZE
 -†un£t->
cq_
) % QUEUE_SIZE;

9465 
	}
}

9466 
	~"shªnÚ_sysfs_cÜe.c
"

9467 
	~"shªnÚ_»cÚfig.c
"

9468 
	~"shªnÚ_g4.c
"

9469 
	~"shªnÚ_g5.c
"

	@shannon_map_table.c

10 
	~"shªnÚ.h
"

12 
	#IN_CACHE_BIT
 (4)

	)

13 
	#IN_CACHE_MASK
 (1 << 
IN_CACHE_BIT
)

	)

14 
	#pba_d©a_is_š_ÿche
(
high_pba
è((high_pbaè& 
IN_CACHE_MASK
)

	)

15 
	#__‹mp_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
) ({ \

16 
u64
 
_off£t
 = (
¦Ù
è* (
Ímt
)->
‹mp_bË
.
’Œy_size
; \

17 (((
Ímt
)->
‹mp_bË
.
memblock_li¡
[
_off£t
 >> (Ímt)->‹mp_bË.
memblock_size_shiá
] =ğ
NULL
) ? NULL : \

18 &((
Ímt
)->
‹mp_bË
.
memblock_li¡
[
_off£t
 >> (Ímt)->‹mp_bË.
memblock_size_shiá
][_off£ˆ& (Öpmt)->‹mp_bË.
memblock_size
 - 1)])); \

19 })

	)

21 
	#__m­_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
) ({ \

22 
u64
 
_off£t
 = (
¦Ù
è* (
Ímt
)->
m­_bË
.
’Œy_size
; \

23 (((
Ímt
)->
m­_bË
.
memblock_li¡
[
_off£t
 >> (Ímt)->m­_bË.
memblock_size_shiá
] =ğ
NULL
) ? NULL : \

24 ((
u32
 *)(&((
Ímt
)->
m­_bË
.
memblock_li¡
[
_off£t
 >> (Ímt)->m­_bË.
memblock_size_shiá
][_off£ˆ& (Öpmt)->m­_bË.
memblock_size
 - 1)])))); \

25 })

	)

27 
šlše
 
u32
 
	$g‘_low_pba_äom_m­_bË
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
¦Ù
)

29 
u32
 *
d©a
 = 
	`__m­_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
);

31 ià(
d©a
 =ğ
NULL
)

32  
LPMT_INVALID
;

34  *
d©a
;

35 
	}
}

37 
šlše
 
u8
 
	$g‘_high_pba_äom_‹mp_bË
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
¦Ù
)

40 
u8
 *
d©a
 = 
	`__‹mp_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
);

42 ià(
d©a
 =ğ
NULL
)

43  (
u8
)
LPMT_INVALID
;

45  *
d©a
;

46 
	}
}

48 
	$m­_bË_£t_low_pba
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
¦Ù
, 
u32
 
low_pba
)

50 
u32
 *
pos
 = 
	`__m­_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
);

52 ià(
	`uÆik–y
(
pos
 =ğ
NULL
))

53 
	`BUG_ON
(1);

55 *
pos
 = 
low_pba
;

56 
	}
}

58 
	$m­_bË_£t_high_pba
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
¦Ù
, 
u8
 
high_pba
)

60 
u8
 *
pos
 = 
	`__‹mp_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
);

62 ià(
	`uÆik–y
(
pos
 =ğ
NULL
))

63 
	`BUG_ON
(1);

65 *
pos
 = 
high_pba
;

66 
	}
}

68 
šlše
 
u8
 *
	$__g‘_memblock_äom_ä“li¡
(
shªnÚ_memblock_poŞ
 *
mpoŞ
)

70 
u8
 **
addr
 = 
NULL
;

71 
u8
 *
Ãxt
 = 
NULL
;

73 
	`shªnÚ_¥š_lock
(&
mpoŞ
->
li¡_lock
);

74 
addr
 = (
u8
 **)
mpoŞ
->
ä“_li¡
;

75 ià(
addr
) {

76 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
) == 0);

77 
Ãxt
 = 
addr
[0];

78 ià(
mpoŞ
->
Ï¡
 =ğ(
u8
 *)
addr
)

79 
mpoŞ
->
Ï¡
 = 
Ãxt
;

80 
mpoŞ
->
ä“_li¡
 = 
Ãxt
;

81 
	`shªnÚ_©omic_dec
(&
mpoŞ
->
ä“_út
);

82 
	`mem£t
((
u8
 *)
addr
, 
LPMT_INVALID
, 32);

83 
	`debugs4
("%s: f»e_út=%d,†a¡=0x%lx,‚ew=0x%lx.\n", 
__func__
, 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), mpoŞ->
Ï¡
, (
u8
 *)
addr
);

85 ià(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
) != 0)

86 
	`BUG_ON
(1);

88 
	`shªnÚ_¥š_uÆock
(&
mpoŞ
->
li¡_lock
);

90  (
u8
 *)
addr
;

91 
	}
}

93 
u8
 *
	$g‘_memblock_äom_ä“li¡
(
shªnÚ_memblock_poŞ
 *
mpoŞ
)

95 
u8
 *
addr
 = 
NULL
;

96 
addr
 = 
	`__g‘_memblock_äom_ä“li¡
(
mpoŞ
);

97 ià(
addr
 && (
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
è< shªnÚ_©omic_»ad(&mpoŞ->
mš_th»shŞd
)))

98 
	`shªnÚ_queue_wÜk
(
mpoŞ
->
memblock_wq
, &mpoŞ->
®loc_wÜk
);

99  
addr
;

100 
	}
}

102 
šlše
 
	$__add_to_memblock_ä“li¡
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u8
 *
addr
)

104 
u8
 **
Ï¡
 = 
NULL
;

105 
u8
 **
Ãw
 = (u8 **)
addr
;

107 
	`shªnÚ_mem£t
(
addr
, 
LPMT_INVALID
, 
mpoŞ
->
memblock_size
);

108 
Ãw
[0] = 
NULL
;

109 
	`debugs4
("ä“_út=%d,‡ddr=0x%lx\n", 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), 
addr
);

110 
	`shªnÚ_¥š_lock
(&
mpoŞ
->
li¡_lock
);

111 ià(
mpoŞ
->
ä“_li¡
 =ğ
NULL
)

112 
mpoŞ
->
ä“_li¡
 = 
addr
;

113 ià(
mpoŞ
->
Ï¡
) {

114 
Ï¡
 = (
u8
 **)
mpoŞ
->last;

115 
Ï¡
[0] = 
addr
;

116 
mpoŞ
->
Ï¡
 = 
addr
;

118 
mpoŞ
->
Ï¡
 = 
addr
;

119 
	`shªnÚ_©omic_šc
(&
mpoŞ
->
ä“_út
);

120 
	`shªnÚ_¥š_uÆock
(&
mpoŞ
->
li¡_lock
);

121 
	}
}

123 
	$add_to_memblock_ä“li¡
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u8
 *
addr
)

125 ià((
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
è+ shªnÚ_©omic_»ad(&mpoŞ->
u£d_út
)) \

126 > 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
max_th»shŞd
))

127 
	`shªnÚ_vä“
(
addr
);

129 
	`__add_to_memblock_ä“li¡
(
mpoŞ
, 
addr
);

130 
	}
}

132 
	$__shªnÚ_sÿ‰”_memblock_de¡roy
(
sÿ‰”_memblock
 *
smb
, 
to_ä“li¡
)

134 
šdex
;

136 ià(
smb
 =ğ
NULL
)

139 ià(
smb
->
memblock_li¡
 !ğ
NULL
) {

140 
šdex
 = 0; index < 
smb
->
memblock_couÁ
; index++) {

141 ià(
smb
->
memblock_li¡
[
šdex
]) {

142 ià(
to_ä“li¡
)

143 
	`add_to_memblock_ä“li¡
(
smb
->
mpoŞ
, smb->
memblock_li¡
[
šdex
]);

145 
	`shªnÚ_vä“
(
smb
->
memblock_li¡
[
šdex
]);

146 
smb
->
memblock_li¡
[
šdex
] = 
NULL
;

147 
	`shªnÚ_©omic_dec
(&
smb
->
mpoŞ
->
u£d_út
);

152 
	`debugs4
("%s: f»e_út=%d, u£d_út=%d, mš_th»shŞd=%d, max_th»shŞd=%d.\n", 
__func__
, 
	`shªnÚ_©omic_»ad
(&
smb
->
mpoŞ
->
ä“_út
), \

153 
	`shªnÚ_©omic_»ad
(&
smb
->
mpoŞ
->
u£d_út
), shªnÚ_©omic_»ad(&smb->mpoŞ->
mš_th»shŞd
), shªnÚ_©omic_»ad(&smb->mpoŞ->
max_th»shŞd
));

154 
	}
}

156 
	$shªnÚ_sÿ‰”_memblock_de¡roy
(
sÿ‰”_memblock
 *
smb
, 
to_ä“li¡
)

158 
	`__shªnÚ_sÿ‰”_memblock_de¡roy
(
smb
, 
to_ä“li¡
);

159 
	`shªnÚ_kä“
(
smb
->
memblock_li¡
);

160 
smb
->
tÙ®_size
 = 0;

161 
smb
->
memblock_couÁ
 = 0;

162 
smb
->
memblock_size
 = 0;

163 
smb
->
memblock_li¡
 = 
NULL
;

164 
	}
}

166 
	$shªnÚ_m­_bË_de¡roy
(
m­_bË_¡ruù
 *
Ímt
, 
to_ä“li¡
)

168 
	`shªnÚ_sÿ‰”_memblock_de¡roy
(&
Ímt
->
m­_bË
, 
to_ä“li¡
);

169 
	`shªnÚ_sÿ‰”_memblock_de¡roy
(&
Ímt
->
‹mp_bË
, 
to_ä“li¡
);

170 
	`shªnÚ_mem£t
(
Ímt
->
v®id_logicbs_¬¿y
, 0, (lpmt->valid_logicbs_array));

171 
	}
}

173 
	$shªnÚ_m­_bË_»£t
(
m­_bË_¡ruù
 *
Ímt
, 
to_ä“li¡
)

175 
	`__shªnÚ_sÿ‰”_memblock_de¡roy
(&
Ímt
->
m­_bË
, 
to_ä“li¡
);

176 
	`__shªnÚ_sÿ‰”_memblock_de¡roy
(&
Ímt
->
‹mp_bË
, 
to_ä“li¡
);

177 
	`shªnÚ_mem£t
(
Ímt
->
v®id_logicbs_¬¿y
, 0, (lpmt->valid_logicbs_array));

178 
	}
}

180 
	$shªnÚ_sÿ‰”_memblock_»£t
(
sÿ‰”_memblock
 *
smb
)

182 
šdex
;

183 
u8
 *
memblock_p
 = 
NULL
;

185 
šdex
 = 0; index < 
smb
->
memblock_couÁ
; index++) {

186 
memblock_p
 = 
smb
->
memblock_li¡
[
šdex
];

187 ià(
memblock_p
)

188 
	`shªnÚ_mem£t
(
memblock_p
, 
LPMT_INVALID
, 
smb
->
memblock_size
);

190 
	}
}

192 
šlše
 
	$®loc_Ãw_memblock
(
shªnÚ_memblock_poŞ
 *
mpoŞ
)

194 
u8
 *
addr
 = 
NULL
;

196 
addr
 = 
	`__shªnÚ_vm®loc
(
mpoŞ
->
memblock_size
, 
GFP_NOWAIT
, 
SHANNON_PAGE_KERNEL
);

197 ià(!
addr
)

199 
	`__add_to_memblock_ä“li¡
(
mpoŞ
, 
addr
);

201 
	}
}

203 
	$shªnÚ_memblock_poŞ_add
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
)

205 
i
;

206 
»t
 = 0;

207 
u64
 
size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* 
mpoŞ
->
’Œy_size
);

208 
u32
 
couÁ
 = 
size
 / 
mpoŞ
->
memblock_size
 + ((size % mpool->memblock_size) > 0 ? 1 : 0);

210 ià(
shªnÚ_memblock_´—Îoc
 != 0)

212 
i
 = 0; i < 
couÁ
; i++) {

213 ià(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
è>ğshªnÚ_©omic_»ad(&mpoŞ->
max_th»shŞd
))

215 
»t
 = 
	`®loc_Ãw_memblock
(
mpoŞ
);

216 ià(
»t
)

219 
	`debugs4
("%s: couÁ=%ld, f»e_út=%d, u£d_út=%d, max_th»shŞd=%ld", 
__func__
, 
couÁ
, 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), \

220 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
u£d_út
), shªnÚ_©omic_»ad(&mpoŞ->
max_th»shŞd
));

221 
	}
}

223 
	$shªnÚ_®loc_memblock_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

225 
	#DEFAULT_RETRY
 (10)

	)

226 
»t
 = 0;

227 
times
 = 
DEFAULT_RETRY
;

228 
shªnÚ_memblock_poŞ
 *
mpoŞ
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_memblock_poŞ, 
®loc_wÜk
);

230 ià(
shªnÚ_memblock_´—Îoc
 == -1)

232 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
è< shªnÚ_©omic_»ad(&mpoŞ->
mš_th»shŞd
)) {

233 
»Œy
:

234 
»t
 = 
	`®loc_Ãw_memblock
(
mpoŞ
);

235 ià(
»t
 && 
times
--) {

236 
	`shªnÚ_m¦“p
(10);

237 
»Œy
;

239 ià(
times
 == 0)

240 
	`shªnÚ_m¦“p
(1000);

241 
times
 = 
DEFAULT_RETRY
;

243 
	}
}

245 
šlše
 
	$shªnÚ_š™_sÿ‰”_memblock
(
sÿ‰”_memblock
 *
smb
)

247 
i
;

249 
smb
->
memblock_size
 = 0;

250 
smb
->
memblock_couÁ
 = 0;

251 
smb
->
tÙ®_size
 = 0;

253 
i
 = 0; i < 
MEMBLOCK_LOCK_CNT
; i++)

254 
	`shªnÚ_mu‹x_š™
(&
smb
->
li¡_lock
[
i
]);

255 
	}
}

257 
	$shªnÚ_®loc_sÿ‰”_memblock
(
sÿ‰”_memblock
 *
smb
, 
u64
 
block_size_shiá
, 
u32
 
’Œy_size
, u64 
tÙ®_size
)

259 
šdex
;

261 ià((
smb
 =ğ
NULL
è|| (
tÙ®_size
 =ğ0è|| (
block_size_shiá
 == 0))

265 
	`BUG_ON
(
smb
->
memblock_couÁ
 != 0);

266 
	`BUG_ON
(
smb
->
memblock_li¡
 !ğ
NULL
);

268 ià(
block_size_shiá
 =ğ
MAP_TABLE_MEMBLOCK_SIZE_SHIFT
)

269 
smb
->
mpoŞ
 = &
m­_bË_poŞ
;

270 if(
block_size_shiá
 =ğ
TEMP_TABLE_MEMBLOCK_SIZE_SHIFT
)

271 
smb
->
mpoŞ
 = &
‹mp_bË_poŞ
;

273 
	`BUG_ON
(1);

274 
	`shªnÚ_š™_sÿ‰”_memblock
(
smb
);

275 
smb
->
memblock_size_shiá
 = 
block_size_shiá
;

276 
smb
->
memblock_size
 = 1 << 
block_size_shiá
;

277 
smb
->
’Œy_size
 =ƒntry_size;

278 
smb
->
’Œys_³r_memblock
 = smb->
memblock_size
 / smb->
’Œy_size
;

279 
smb
->
memblock_couÁ
 = 
tÙ®_size
 / smb->
memblock_size
 + ((total_size % smb->memblock_size) > 0 ? 1 : 0);

280 
smb
->
tÙ®_size
 = smb->
memblock_couÁ
 * smb->
memblock_size
;

281 
	`debugs4
("memblock_couÁ=%ld, memblock_size=%lu,Ù®_size=%lu,rue_size=%lu.\n", 
smb
->
memblock_couÁ
, smb->
memblock_size
, smb->
tÙ®_size
,otal_size);

282 
smb
->
memblock_li¡
 = 
	`shªnÚ_km®loc
(smb->
memblock_couÁ
 * (
u8
 *), 
GFP_SHANNON
);

283 ià(
smb
->
memblock_li¡
 =ğ
NULL
)

284 
çed
;

286 
	`shªnÚ_mem£t
(
smb
->
memblock_li¡
, 0, smb->
memblock_couÁ
 * (
u8
 *));

287 ià(
shªnÚ_memblock_´—Îoc
 == -1) {

288 
šdex
 = 0; index < 
smb
->
memblock_couÁ
; index++) {

289 
smb
->
memblock_li¡
[
šdex
] = 
	`shªnÚ_vm®loc
(smb->
memblock_size
);

290 ià(
smb
->
memblock_li¡
[
šdex
] =ğ
NULL
)

291 
®loc_memblock_çed
;

292 
	`shªnÚ_mem£t
(
smb
->
memblock_li¡
[
šdex
], 
LPMT_INVALID
, smb->
memblock_size
);

293 
	`shªnÚ_©omic_šc
(&
smb
->
mpoŞ
->
u£d_út
);

297 
	`debugs4
("%s: f»e_út=%d, mš_th»shŞd=%d, max_th»shŞd=%d.\n", 
__func__
, 
	`shªnÚ_©omic_»ad
(&
smb
->
mpoŞ
->
ä“_út
), \

298 
	`shªnÚ_©omic_»ad
(&
smb
->
mpoŞ
->
mš_th»shŞd
), shªnÚ_©omic_»ad(&smb->mpoŞ->
max_th»shŞd
));

300 
®loc_memblock_çed
:

301 --
šdex
 >= 0) {

302 ià(
smb
->
memblock_li¡
[
šdex
]) {

303 
	`add_to_memblock_ä“li¡
(
smb
->
mpoŞ
, smb->
memblock_li¡
[
šdex
]);

304 
smb
->
memblock_li¡
[
šdex
] = 
NULL
;

305 
	`shªnÚ_©omic_dec
(&
smb
->
mpoŞ
->
u£d_út
);

309 
	`shªnÚ_kä“
(
smb
->
memblock_li¡
);

310 
çed
:

311 
smb
->
tÙ®_size
 = 0;

312 
smb
->
memblock_couÁ
 = 0;

313 
smb
->
memblock_size
 = 0;

314 
smb
->
memblock_li¡
 = 
NULL
;

317 
	}
}

319 
	$check_ªd_®loc_memblock
(
sÿ‰”_memblock
 *
smb
, 
logicb64_t
 
off£t
)

321 
u32
 
li¡_šdex
 = 
off£t
 >> 
smb
->
memblock_size_shiá
;

322 
u8
 *
addr
 = 
NULL
;

324 ià(
	`uÆik–y
(
smb
->
memblock_li¡
[
li¡_šdex
] =ğ
NULL
)) {

325 
	`shªnÚ_mu‹x_lock
(&
smb
->
li¡_lock
[
li¡_šdex
 & (
MEMBLOCK_LOCK_CNT
 - 1)]);

326 ià(
	`lik–y
(
smb
->
memblock_li¡
[
li¡_šdex
] =ğ
NULL
)) {

327 
addr
 = 
	`g‘_memblock_äom_ä“li¡
(
smb
->
mpoŞ
);

328 
	`debugs4
("g‘‡ f»memblock, index=%d,‡ddr=0x%lx.\n", 
li¡_šdex
, 
addr
);

329 ià(
	`uÆik–y
(
addr
 =ğ
NULL
)) {

330 
addr
 = 
	`__shªnÚ_vm®loc
(
smb
->
memblock_size
, 
GFP_NOWAIT
, 
SHANNON_PAGE_KERNEL
);

331 ià(
addr
)

332 
	`shªnÚ_mem£t
(
addr
, 
LPMT_INVALID
, 
smb
->
memblock_size
);

334 ià(
	`lik–y
(
addr
))

335 
	`shªnÚ_©omic_šc
(&
smb
->
mpoŞ
->
u£d_út
);

336 
smb
->
memblock_li¡
[
li¡_šdex
] = 
addr
;

338 
	`shªnÚ_mu‹x_uÆock
(&
smb
->
li¡_lock
[
li¡_šdex
 & (
MEMBLOCK_LOCK_CNT
 - 1)]);

341  (
smb
->
memblock_li¡
[
li¡_šdex
]) ? 0 : -1;

342 
	}
}

344 
	$check_ªd_®loc_m­bË
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
)

346 
»t
 = 0, 
i
;

347 
u64
 
¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(
sdisk
, 
lba
);

349 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

350 ià(!(
sdisk
->
Ímt_¬¿y
[
i
].
¡©e
 & 
MAP_TABLE_VALID_MASK
))

352 
»t
 = 
	`check_ªd_®loc_memblock
(&
sdisk
->
Ímt_¬¿y
[
i
].
m­_bË
, 
¦Ù
 * (
u32
));

353 ià(
»t
)

354 
out
;

356 
»t
 = 
	`check_ªd_®loc_memblock
(&
sdisk
->
Ímt_¬¿y
[
i
].
‹mp_bË
, 
¦Ù
 * (
u8
));

357 ià(
»t
)

358 
out
;

360 
out
:

361 ià(
»t
)

362 
	`shªnÚ_”r
("alloc map_tableƒrror.\n");

363  
»t
;

364 
	}
}

366 
	$check_ªd_®loc_Ímt
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_bio
 *
sbio
, 
logicb_shiá
)

368 
logicb64_t
 
¡¬t_lba
, 
’d_lba
;

369 
š‹rv®
 = 
sdisk
->
Ímt_¬¿y
[0].
m­_bË
.
’Œys_³r_memblock
 > sdisk->Ímt_¬¿y[0].
‹mp_bË
.entrys_per_memblock ? \

370 
sdisk
->
Ímt_¬¿y
[0].
‹mp_bË
.
’Œys_³r_memblock
 : sdisk->Ímt_¬¿y[0].
m­_bË
.entrys_per_memblock;

371 
logicb64_t
 
lba_šdex
;

372 
couÁ
 = 0;

374 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

377 
¡¬t_lba
 = 
sbio
->
¡¬t_£ùÜ
 >> (
logicb_shiá
 - 9);

378 
’d_lba
 = (
sbio
->
¡¬t_£ùÜ
 + (sbio->
bio_size
 >> 9)è>> (
logicb_shiá
 - 9);

379 
lba_šdex
 = 
¡¬t_lba
;

380 
	`BUG_ON
((
’d_lba
 < 
¡¬t_lba
));

381 
couÁ
 = ((
’d_lba
 - 
¡¬t_lba
è/ 
š‹rv®
) + 1;

382 
couÁ
--) {

383 ià(
	`check_ªd_®loc_m­bË
(
sdisk
, 
lba_šdex
))

386 
lba_šdex
 +ğ
š‹rv®
;

389  
	`check_ªd_®loc_m­bË
(
sdisk
, 
’d_lba
);

390 
	}
}

392 
	$shªnÚ_memblock_poŞ_š™
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u32
 
memblock_size_shiá
, u32 
’Œy_size
)

394 
mpoŞ
->
memblock_size
 = 1 << 
memblock_size_shiá
;

395 
mpoŞ
->
’Œy_size
 =ƒntry_size;

396 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
mš_th»shŞd
, 0);

397 ià(
shªnÚ_memblock_´—Îoc
 == 0) {

398 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
mš_th»shŞd
, 
DEFAULT_MIN_THRESHOLD
);

399 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
max_th»shŞd
, 
DEFAULT_MIN_THRESHOLD
);

400 } ià(
shªnÚ_memblock_´—Îoc
 <= -1) {

401 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
mš_th»shŞd
, 0);

402 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
max_th»shŞd
, 0);

404 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
mš_th»shŞd
, 
shªnÚ_memblock_´—Îoc
);

405 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
max_th»shŞd
, 
shªnÚ_memblock_´—Îoc
);

407 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
ä“_út
, 0);

408 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
u£d_út
, 0);

409 
	`shªnÚ_š™_wÜk
(&
mpoŞ
->
®loc_wÜk
, 
shªnÚ_®loc_memblock_sk
);

410 
mpoŞ
->
memblock_wq
 = 
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(
	`shªnÚ_ka¥rštf
(
GFP_SHANNON
, "shn_memblock_wq"));

411 ià(
mpoŞ
->
memblock_wq
 =ğ
NULL
) {

412 
	`shªnÚ_w¬n
("create shannon memblock workqueue failed!\n");

415 
	`shªnÚ_¥š_lock_š™
(&
mpoŞ
->
li¡_lock
);

416 
mpoŞ
->
ä“_li¡
 = 
NULL
;

419 
	}
}

421 
	$shªnÚ_memblock_poŞ_ş—r
(
shªnÚ_memblock_poŞ
 *
mpoŞ
)

423 
u8
 *
addr
;

424 (
addr
 = 
	`__g‘_memblock_äom_ä“li¡
(
mpoŞ
)è!ğ
NULL
)

425 
	`shªnÚ_vä“
(
addr
);

426 
	}
}

428 
	$shªnÚ_memblock_poŞ_de¡roy
(
shªnÚ_memblock_poŞ
 *
mpoŞ
)

430 
	`shªnÚ_æush_wÜkqueue
(
mpoŞ
->
memblock_wq
);

432 
	`shªnÚ_memblock_poŞ_ş—r
(
mpoŞ
);

433 ià(
mpoŞ
->
memblock_wq
)

434 
	`shªnÚ_de¡roy_wÜkqueue
(
mpoŞ
->
memblock_wq
);

435 
	`debugs4
("%s: f»e_út=%d, u£d_út=%d, max_th»shŞd=%ld", 
__func__
, 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), shªnÚ_©omic_»ad(&mpoŞ->
u£d_út
), shªnÚ_©omic_»ad(&mpoŞ->
max_th»shŞd
));

436 
	`BUG_ON
(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
) != 0);

437 
	}
}

439 
	$shªnÚ_memblock_poŞ_šc_maxt
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
)

441 
u64
 
size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* 
mpoŞ
->
’Œy_size
);

442 
u32
 
couÁ
 = 
size
 / 
mpoŞ
->
memblock_size
 + ((size % mpool->memblock_size) > 0 ? 1 : 0);

444 ià(
shªnÚ_memblock_´—Îoc
 != 0)

446 ià(
couÁ
 < 0)

448 ià((~0x0U - 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
max_th»shŞd
)è< 
couÁ
)

449 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
max_th»shŞd
, ~0x0U);

451 
	`shªnÚ_©omic_add
(
couÁ
, &
mpoŞ
->
max_th»shŞd
);

452 
	`debugs4
("%s: couÁ=%ld, f»e_út=%d, u£d_út=%d, max_th»shŞd=%ld", 
__func__
, 
couÁ
, 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), shªnÚ_©omic_»ad(&mpoŞ->
u£d_út
), shªnÚ_©omic_»ad(&mpoŞ->
max_th»shŞd
));

453 
	}
}

455 
	$shªnÚ_memblock_poŞ_dec_maxt
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
)

457 
u8
 *
addr
;

458 
u64
 
size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* 
mpoŞ
->
’Œy_size
);

459 
u32
 
couÁ
 = 
size
 / 
mpoŞ
->
memblock_size
 + ((size % mpool->memblock_size) > 0 ? 1 : 0);

461 ià(
shªnÚ_memblock_´—Îoc
 != 0)

463 ià(
couÁ
 < 0)

465 ià(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
max_th»shŞd
è< 
couÁ
)

466 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
max_th»shŞd
, 0);

468 
	`shªnÚ_©omic_sub
(
couÁ
, &
mpoŞ
->
max_th»shŞd
);

469 (
couÁ
--) > 0) {

470 
addr
 = 
	`__g‘_memblock_äom_ä“li¡
(
mpoŞ
);

471 ià(
addr
 =ğ
NULL
)

473 
	`shªnÚ_vä“
(
addr
);

475 ià(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
è< shªnÚ_©omic_»ad(&mpoŞ->
mš_th»shŞd
))

476 
	`shªnÚ_queue_wÜk
(
mpoŞ
->
memblock_wq
, &mpoŞ->
®loc_wÜk
);

477 
	`debugs4
("%s: couÁ=%ld, f»e_út=%d, u£d_út=%d, max_th»shŞd=%ld", 
__func__
, 
couÁ
, 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), shªnÚ_©omic_»ad(&mpoŞ->
u£d_út
), shªnÚ_©omic_»ad(&mpoŞ->
max_th»shŞd
));

478 
	}
}

480 
	$shªnÚ_memblock_poŞ_dec_maxt_by_út
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u64
 
couÁ
)

482 
u8
 *
addr
;

484 ià(
shªnÚ_memblock_´—Îoc
 != 0)

486 ià(
couÁ
 < 0)

488 ià(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
max_th»shŞd
è< 
couÁ
)

489 
	`shªnÚ_©omic_£t
(&
mpoŞ
->
max_th»shŞd
, 0);

491 
	`shªnÚ_©omic_sub
(
couÁ
, &
mpoŞ
->
max_th»shŞd
);

492 (
couÁ
--) > 0) {

493 
addr
 = 
	`__g‘_memblock_äom_ä“li¡
(
mpoŞ
);

494 ià(
addr
 =ğ
NULL
)

496 
	`shªnÚ_vä“
(
addr
);

498 ià(
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
è< shªnÚ_©omic_»ad(&mpoŞ->
mš_th»shŞd
))

499 
	`shªnÚ_queue_wÜk
(
mpoŞ
->
memblock_wq
, &mpoŞ->
®loc_wÜk
);

500 
	`debugs4
("%s: couÁ=%ld, f»e_út=%d, u£d_út=%d, max_th»shŞd=%ld", 
__func__
, 
couÁ
, 
	`shªnÚ_©omic_»ad
(&
mpoŞ
->
ä“_út
), shªnÚ_©omic_»ad(&mpoŞ->
u£d_út
), shªnÚ_©omic_»ad(&mpoŞ->
max_th»shŞd
));

501 
	}
}

503 
	$shªnÚ_sÿ‰”_memblock_»size
(
sÿ‰”_memblock
 *
smb
, 
u64
 
tÙ®_size
)

505 
u32
 
Şd_couÁ
;

506 
u32
 
Ãw_couÁ
, 
i
;

507 
u8
 **
Şd_mb
;

508 
u8
 **
Ãw_mb
;

510 ià((
tÙ®_size
 <ğ
smb
->tÙ®_sizeè|| (smb->
memblock_couÁ
 =ğ0è|| (smb->
memblock_size
 == 0))

513 
Şd_couÁ
 = 
smb
->
memblock_couÁ
;

514 
Ãw_couÁ
 = 
tÙ®_size
 / 
smb
->
memblock_size
 + ((total_size % smb->memblock_size) > 0 ? 1 : 0);

516 
Şd_mb
 = 
smb
->
memblock_li¡
;

517 
Ãw_mb
 = 
	`shªnÚ_kz®loc
(
Ãw_couÁ
 * (
u8
 *), 
GFP_SHANNON
);

518 ià(
Ãw_mb
 =ğ
NULL
)

521 
i
 = 0; i < 
Ãw_couÁ
; i++) {

522 
Ãw_mb
[
i
] = 
NULL
;

523 ià(
i
 < 
Şd_couÁ
)

524 
Ãw_mb
[
i
] = 
Şd_mb
[i];

525 ià((
Ãw_mb
[
i
] =ğ
NULL
è&& (
shªnÚ_memblock_´—Îoc
 == -1)) {

526 
Ãw_mb
[
i
] = 
	`shªnÚ_vm®loc
(
smb
->
memblock_size
);

527 ià(
Ãw_mb
[
i
] =ğ
NULL
)

528 
®loc_memblock_çed
;

529 
	`shªnÚ_mem£t
(
Ãw_mb
[
i
], 
LPMT_INVALID
, 
smb
->
memblock_size
);

530 
	`shªnÚ_©omic_šc
(&
smb
->
mpoŞ
->
u£d_út
);

534 
smb
->
memblock_li¡
 = 
Ãw_mb
;

535 
	`shªnÚ_b¬r›r
();

536 
smb
->
memblock_couÁ
 = 
Ãw_couÁ
;

537 
smb
->
tÙ®_size
 = smb->
memblock_size
 * smb->
memblock_couÁ
;

538 
	`shªnÚ_m¦“p
(500);

539 
	`shªnÚ_kä“
(
Şd_mb
);

543 
®loc_memblock_çed
:

544 --
i
 >ğ
Şd_couÁ
) {

545 ià(
Ãw_mb
[
i
]) {

546 
	`shªnÚ_vä“
(
Ãw_mb
[
i
]);

547 
	`shªnÚ_©omic_dec
(&
smb
->
mpoŞ
->
u£d_út
);

551 
	`shªnÚ_kä“
(
Ãw_mb
);

553 
	}
}

555 
	$__shªnÚ_m­_bË_»size
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
Ãw_m­_bË_size
, u64 
Ãw_‹mp_bË_size
)

557 
»t
;

559 
»t
 = 
	`shªnÚ_sÿ‰”_memblock_»size
(&
Ímt
->
m­_bË
, 
Ãw_m­_bË_size
);

560 ià(
»t
) {

561 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for map_table!\n");

565 
»t
 = 
	`shªnÚ_sÿ‰”_memblock_»size
(&
Ímt
->
‹mp_bË
, 
Ãw_‹mp_bË_size
);

566 ià(
»t
) {

567 
	`shªnÚ_”r
("cannot‡llocateƒnough memory foremp_table!\n");

571 
Ímt
->
m­_bË_size
 = 
Ãw_m­_bË_size
;

572 
Ímt
->
‹mp_bË_size
 = 
Ãw_‹mp_bË_size
;

574 
	}
}

576 
	$shªnÚ_m­_bË_»size
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
logicb_shiá
)

578 
»t
 = -1;

579 
u64
 
Ãw_tÙ®_m­_bË_size
;

580 
u64
 
Ãw_tÙ®_‹mp_bË_size
;

581 
i
;

584 
Ãw_tÙ®_m­_bË_size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* (
u32
));

585 
	`debugs4
("tÙ®_m­_bË_size=%ld.\n", ()
sdisk
->
tÙ®_m­_bË_size
);

587 
Ãw_tÙ®_‹mp_bË_size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* (
u8
));

588 
	`debugs4
("tÙ®_‹mp_bË_size=%ld.\n", ()
sdisk
->
tÙ®_‹mp_bË_size
);

589 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

590 
»t
 = 
	`__shªnÚ_m­_bË_»size
(&
sdisk
->
Ímt_¬¿y
[
i
],

591 (
Ãw_tÙ®_m­_bË_size
 / 
sdisk
->
sdev_couÁ
) + (new_total_map_table_size % sdisk->sdev_count),

592 (
Ãw_tÙ®_‹mp_bË_size
 / 
sdisk
->
sdev_couÁ
) + (new_total_temp_table_size % sdisk->sdev_count));

593 ià(
»t
) {

594 
	`shªnÚ_”r
("cannot„esize mapable.\n");

595 (--
i
) >= 0) {

596 
	`__shªnÚ_m­_bË_»size
(&
sdisk
->
Ímt_¬¿y
[
i
],

597 (
sdisk
->
tÙ®_m­_bË_size
 / sdisk->
sdev_couÁ
) + sdisk->total_map_table_size % sdisk->sdev_count,

598 (
sdisk
->
tÙ®_‹mp_bË_size
 / sdisk->
sdev_couÁ
) + sdisk->total_temp_table_size % sdisk->sdev_count);

604 
sdisk
->
tÙ®_m­_bË_size
 = 
Ãw_tÙ®_m­_bË_size
;

605 
sdisk
->
tÙ®_‹mp_bË_size
 = 
Ãw_tÙ®_‹mp_bË_size
;

607 
	}
}

609 
	$shªnÚ_m­_bË_di§bË
(
m­_bË_¡ruù
 *
Ímt
)

611 
Ímt
->
¡©e
 &ğ~
MAP_TABLE_VALID_MASK
;

612 
	}
}

614 
	$shªnÚ_m­_bË_’abË
(
m­_bË_¡ruù
 *
Ímt
)

616 
Ímt
->
¡©e
 |ğ
MAP_TABLE_VALID_MASK
;

617 
	}
}

619 
	$shªnÚ_m­_bË_š™
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
m­_bË_size
, u64 
‹mp_bË_size
)

621 
»t
;

623 
»t
 = 
	`shªnÚ_®loc_sÿ‰”_memblock
(&
Ímt
->
m­_bË
, 
MAP_TABLE_MEMBLOCK_SIZE_SHIFT
, 
MAP_TABLE_ENTRY_SIZE
, 
m­_bË_size
);

624 ià(
»t
) {

625 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for map_table!\n");

626 
çed
;

629 
»t
 = 
	`shªnÚ_®loc_sÿ‰”_memblock
(&
Ímt
->
‹mp_bË
, 
TEMP_TABLE_MEMBLOCK_SIZE_SHIFT
, 
TEMP_TABLE_ENTRY_SIZE
, 
‹mp_bË_size
);

630 ià(
»t
) {

631 
	`shªnÚ_”r
("cannot‡llocateƒnough memory foremp_table!\n");

632 
çed
;

634 
	`shªnÚ_m­_bË_di§bË
(
Ímt
);

635 
Ímt
->
m­_bË_size
 = map_table_size;

636 
Ímt
->
‹mp_bË_size
 =emp_table_size;

637 
	`shªnÚ_m­_bË_ş—r
(
Ímt
);

639 
çed
:

641 
	}
}

643 
	$__shªnÚ_®loc_m­_bË
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
logicb_shiá
)

645 
i
;

647 
	`BUG_ON
(
sdisk
->
sdev_couÁ
 <= 0);

648 
	`BUG_ON
(
sdisk
->
¡r_size
 <= 0);

650 
sdisk
->
tÙ®_m­_bË_size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* (
u32
));

651 
	`debugs4
("tÙ®_m­_bË_size=%ld.\n", ()
sdisk
->
tÙ®_m­_bË_size
);

653 
sdisk
->
tÙ®_‹mp_bË_size
 = 
	`SHN_PAGE_ALIGN
((
£ùÜs
 >> (
logicb_shiá
 - 9)è* (
u8
));

654 
	`debugs4
("tÙ®_‹mp_bË_size=%ld.\n", ()
sdisk
->
tÙ®_‹mp_bË_size
);

655 
sdisk
->
Ímt_¬¿y
 = 
	`shªnÚ_kz®loc
((
m­_bË_¡ruù
è* sdisk->
sdev_couÁ
, 
GFP_SHANNON
);

656 ià(!
sdisk
->
Ímt_¬¿y
) {

657 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for†pmt struct.\n");

662 
	`sdisk_m­_bË_lock_š™
(
sdisk
);

663 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

664 ià(
	`shªnÚ_m­_bË_š™
(&
sdisk
->
Ímt_¬¿y
[
i
], sdisk->
tÙ®_m­_bË_size
 / sdisk->
sdev_couÁ
 + sdisk->total_map_table_size % sdisk->sdev_count,

665 
sdisk
->
tÙ®_‹mp_bË_size
 / sdisk->
sdev_couÁ
 + sdisk->total_temp_table_size % sdisk->sdev_count) < 0) {

666 
	`shªnÚ_”r
("Init map_table_struct failed.\n");

671 
	`Ímt_cdev_š™
(
sdisk
);

672 
	`‹mp_bË_cdev_š™
(
sdisk
);

675 
	}
}

677 
	$shªnÚ_®loc_m­_bË
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
)

679 
»t
;

681 ià(
shªnÚ_memblock_´—Îoc
 == 0) {

682 
	`shªnÚ_memblock_poŞ_šc_maxt
(&
m­_bË_poŞ
, 
sdisk
->
£ùÜs
, 
logicb_shiá
);

683 
	`shªnÚ_memblock_poŞ_šc_maxt
(&
‹mp_bË_poŞ
, 
sdisk
->
£ùÜs
, 
logicb_shiá
);

685 
	`shªnÚ_memblock_poŞ_add
(&
m­_bË_poŞ
, 
sdisk
->
£ùÜs
, 
logicb_shiá
);

686 
	`shªnÚ_memblock_poŞ_add
(&
‹mp_bË_poŞ
, 
sdisk
->
£ùÜs
, 
logicb_shiá
);

688 
sdisk
->
sdev_couÁ
 = 1;

689 
sdisk
->
¡r_size_shiá
 = 0;

690 
sdisk
->
¡r_size
 = 1 << sdisk->
¡r_size_shiá
;

691 ià((
»t
 = 
	`__shªnÚ_®loc_m­_bË
(
sdisk
, 
£ùÜs
, 
logicb_shiá
)))

692  
»t
;

695 
	}
}

697 
	$shªnÚ_®loc_m­_bË_ns
(
shªnÚ_disk
 *
sdisk
, 
u64
 
£ùÜs
, 
u32
 
logicb_shiá
, u32 
sdev_couÁ
, u32 
¡r_size_shiá
)

699 
sdisk
->
sdev_couÁ
 = sdev_count;

700 
sdisk
->
¡r_size_shiá
 = strip_size_shift;

701 
sdisk
->
¡r_size
 = 1 << 
¡r_size_shiá
;

702  
	`__shªnÚ_®loc_m­_bË
(
sdisk
, 
£ùÜs
, 
logicb_shiá
);

703 
	}
}

705 
	$__shªnÚ_m­_bË_ä“
(
shªnÚ_disk
 *
sdisk
)

707 
i
;

709 
	`Ímt_cdev_ex™
(
sdisk
);

710 
	`‹mp_bË_cdev_ex™
(
sdisk
);

712 ià(
sdisk
->
Ímt_¬¿y
) {

713 
i
 = 0; i < 
sdisk
->
sdev_couÁ
; i++) {

714 
	`shªnÚ_m­_bË_di§bË
(&
sdisk
->
Ímt_¬¿y
[
i
]);

715 
	`shªnÚ_m­_bË_de¡roy
(&
sdisk
->
Ímt_¬¿y
[
i
], 0);

717 
	`shªnÚ_kä“
(
sdisk
->
Ímt_¬¿y
);

718 
sdisk
->
Ímt_¬¿y
 = 
NULL
;

720 
	}
}

722 
	$shªnÚ_m­_bË_ä“
(
shªnÚ_disk
 *
sdisk
)

724 
	`__shªnÚ_m­_bË_ä“
(
sdisk
);

726 ià(
shªnÚ_memblock_´—Îoc
 == 0) {

727 
	`shªnÚ_memblock_poŞ_dec_maxt_by_út
(&
m­_bË_poŞ
, 
sdisk
->
tÙ®_m­_bË_size
 / m­_bË_poŞ.
memblock_size
 + \

728 ((
sdisk
->
tÙ®_m­_bË_size
 % 
m­_bË_poŞ
.
memblock_size
 > 0) ? 1 : 0));

729 
	`shªnÚ_memblock_poŞ_dec_maxt_by_út
(&
‹mp_bË_poŞ
, 
sdisk
->
tÙ®_‹mp_bË_size
 /emp_bË_poŞ.
memblock_size
 + \

730 ((
sdisk
->
tÙ®_‹mp_bË_size
 % 
‹mp_bË_poŞ
.
memblock_size
 > 0) ? 1 : 0));

732 
	}
}

733 
	$shªnÚ_m­_bË_ä“_ns
(
shªnÚ_disk
 *
sdisk
)

735 
	`__shªnÚ_m­_bË_ä“
(
sdisk
);

736 
	}
}

738 
	$mem£t_m­_bË
(
sÿ‰”_memblock
 *
m­_bË
)

740 
	`shªnÚ_sÿ‰”_memblock_»£t
(
m­_bË
);

741 
	}
}

743 
	$shªnÚ_m­_bË_ş—r
(
m­_bË_¡ruù
 *
Ímt
)

745 
	`mem£t_m­_bË
(&
Ímt
->
m­_bË
);

746 
	`mem£t_m­_bË
(&
Ímt
->
‹mp_bË
);

747 
	`shªnÚ_mem£t
(
Ímt
->
v®id_logicbs_¬¿y
, 0, (lpmt->valid_logicbs_array));

748 
	}
}

750 
	#LPMT_LUN_PBA_MASK
 (0x03ffffffu)

	)

751 
	#INVALID_PBA
 (0x03ffffffu)

	)

752 
	#LUN_PBA_IS_VALID
(
lun_pba
è(Öun_pbaè!ğ
INVALID_PBA
)

	)

757 
	$g‘_lun_pba_äom_lba
(
logicb64_t
 
lba
, 
lun_pba
 *lun_pba, *
š_ÿche
, 
shªnÚ_disk
 *
sdisk
)

759 
u32
 
low_pba
;

760 
u8
 
high_pba
;

761 
m­_bË_¡ruù
 *
Ímt
 = &
sdisk
->
Ímt_¬¿y
[
	`g‘_m­_bË_¡ruù_šdex_äom_lba
(sdisk, 
lba
)];

762 
u64
 
¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(
sdisk
, 
lba
);

763 
low_pba
 = 
	`g‘_low_pba_äom_m­_bË
(
Ímt
, 
¦Ù
);

764 
high_pba
 = 
	`g‘_high_pba_äom_‹mp_bË
(
Ímt
, 
¦Ù
);

766 
lun_pba
->lun_pb¨ğ(
low_pba
 & 
LPMT_LUN_PBA_MASK
);

767 
lun_pba
->
lun
 = ((
high_pba
 & 0xfè<< 6è| ((
low_pba
 >> 26) & 0x3f);

769 ià((
lun_pba
->lun_pb¨& 
LPMT_LUN_PBA_MASK
è=ğ
INVALID_PBA
) {

770 ià(
š_ÿche
)

771 *
š_ÿche
 = 0;

774 ià(
š_ÿche
)

775 *
š_ÿche
 = 
	`pba_d©a_is_š_ÿche
(
high_pba
);

778 
	}
}

780 
	$upd©e_m­pšg_bË
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
, 
u32
 
lun
, u32 
lun_pba
)

782 
u32
 
low_pba
;

783 
m­_bË_¡ruù
 *
Ímt
 = &
sdisk
->
Ímt_¬¿y
[
	`g‘_m­_bË_¡ruù_šdex_äom_lba
(sdisk, 
lba
)];

784 
u64
 
¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(
sdisk
, 
lba
);

785 
low_pba
 = 
	`g‘_low_pba_äom_m­_bË
(
Ímt
, 
¦Ù
);

787 ià(((
low_pba
 & 
LPMT_LUN_PBA_MASK
è=ğ
INVALID_PBA
è&& (
lun_pba
 != INVALID_PBA))

788 
Ímt
->
v®id_logicbs_¬¿y
[
	`g‘_Ímt_lock_šdex
(
¦Ù
)]++;

789 ià(((
low_pba
 & 
LPMT_LUN_PBA_MASK
è!ğ
INVALID_PBA
è&& (
lun_pba
 == INVALID_PBA))

790 
Ímt
->
v®id_logicbs_¬¿y
[
	`g‘_Ímt_lock_šdex
(
¦Ù
)]--;

791 
	`m­_bË_£t_low_pba
(
Ímt
, 
¦Ù
, (((
u32
)
lun
 & 0x3fè<< 26è| 
lun_pba
);

792 
	`m­_bË_£t_high_pba
(
Ímt
, 
¦Ù
, ((
lun
 >> 6è& 0xfè& ~
IN_CACHE_MASK
);

793 
	}
}

795 
u8
 *
	$‹mp_bË_g‘_pos™iÚ
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
¦Ù
)

797  
	`__‹mp_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
);

798 
	}
}

800 
u32
 *
	$m­_bË_g‘_pos™iÚ
(
m­_bË_¡ruù
 *
Ímt
, 
u64
 
¦Ù
)

803  
	`__m­_bË_g‘_pos™iÚ
(
Ímt
, 
¦Ù
);

804 
	}
}

806 
	$sdev_m­_bË_’abË
(
shªnÚ_dev
 *
sdev
)

808 
i
;

809 
shªnÚ_Çme¥aû
 *
ns
;

811 ià(
sdev
->
¥oŞ
) {

812 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

813 
ns
 = 
sdev
->
¥oŞ
->ns[
i
];

814 ià(
ns
 !ğ
NULL
)

815 
	`shªnÚ_m­_bË_’abË
(&
ns
->
sdisk
.
Ímt_¬¿y
[
sdev
->
sdev_id
]);

818 
	`shªnÚ_m­_bË_’abË
(&
sdev
->
sdisk
.
Ímt_¬¿y
[0]);

819 
	}
}

821 
	$£t_lba_d©a_š_ÿche
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
)

823 
m­_bË_¡ruù
 *
Ímt
 = &
sdisk
->
Ímt_¬¿y
[
	`g‘_m­_bË_¡ruù_šdex_äom_lba
(sdisk, 
lba
)];

824 
u64
 
¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(
sdisk
, 
lba
);

825 
u8
 
high_pba
 = 
	`g‘_high_pba_äom_‹mp_bË
(
Ímt
, 
¦Ù
);

827 
	`m­_bË_£t_high_pba
(
Ímt
, 
¦Ù
, 
high_pba
 | 
IN_CACHE_MASK
);

828 
	}
}

830 
	$ş—r_lba_d©a_š_ÿche
(
shªnÚ_disk
 *
sdisk
, 
logicb64_t
 
lba
)

832 
m­_bË_¡ruù
 *
Ímt
 = &
sdisk
->
Ímt_¬¿y
[
	`g‘_m­_bË_¡ruù_šdex_äom_lba
(sdisk, 
lba
)];

833 
u64
 
¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(
sdisk
, 
lba
);

834 
u8
 
high_pba
 = 
	`g‘_high_pba_äom_‹mp_bË
(
Ímt
, 
¦Ù
);

836 
	`m­_bË_£t_high_pba
(
Ímt
, 
¦Ù
, 
high_pba
 & ~
IN_CACHE_MASK
);

837 
	}
}

	@shannon_mbr.h

10 #iâdeà
__SHANNON_MBR_H


11 
	#__SHANNON_MBR_H


	)

13 
	~<lšux/ty³s.h
>

15 
	#MBR_WATERMARK
 0xa5a5a5a5

	)

16 
	#POOL_INFO_METADATA
 0x53535353

	)

17 
	#MBR_LOGICB_SHIFT
 9

	)

19 
	#SHANNON_MBR_SIZE
 512

	)

20 
	#LUN_REFRESH_MBR_THRESHOLD
 100

	)

22 
	#CURRENT_MBR_FORMAT_VERSION
 0x5430

	)

23 
	#MBR_ID_SIZE
 32

	)

24 
	sshªnÚ_mbr
 {

25 
	mid
[
MBR_ID_SIZE
];

26 
__u64
 
	mmbr_fÜm©_v”siÚ
;

27 
__u64
 
	mh¬dw¬e_v”siÚ
;

28 
__u64
 
	msoáw¬e_v”siÚ
;

29 
__u64
 
	mÇnd_mªuçùu»
;

30 
__u64
 
	mÇnd_id
;

31 
__u64
 
	mÿ·c™y
;

33 
__u32
 
	mlun_amouÁ
;

34 
__u32
 
	meblocks_š_lun
;

35 
__u32
 
	m·ges_š_eblock
;

36 
__u32
 
	mÇnd_·ge_shiá
;

37 
__u32
 
	moob_size
;

38 
__u32
 
	mlogicb_shiá
;

39 
__u32
 
	m¶ªe_Üd”
;

40 
__u32
 
	mcfg_chªÃls
;

41 
__u32
 
	mcfg_lun£t_š_chªÃl
;

42 
__u32
 
	mcfg_lun_š_lun£t
;

44 
__u32
 
	mš™_hÙ_sblk
;

45 
__u32
 
	mš™_cŞd_sblk
;

47 
__u16
 
	mš‹¼u±_d–ay
;

48 
__u8
 
	mecc_codewÜds_š_logicb
;

49 
__u8
 
	mecc_cÜ»ùiÚ_pow”
;

50 
__u32
 
	mhi¡Üy_”a£_couÁ
;

52 
__u64
 
	mpow”_cyşe_couÁ
;

53 
__u64
 
	mpow”_Ú_£cÚds
;

54 
__u64
 
	mho¡_wr™e_£ùÜs
;

55 
__u64
 
	mtÙ®_wr™e_£ùÜs
;

56 
__u64
 
	mho¡_»ad_£ùÜs
;

58 
__u32
 
	mæash_drvmode
;

59 
__u8
 
	mluns_³r_û_mask
;

60 
__u8
 
	mlun_m­_mode
;

61 
__u16
 
	m¿id_¡res
;

63 
	#BAD_LUN_MAP_ARRAY_SIZE
 8

	)

64 
__u64
 
	mbad_phy_lun_m­
[
BAD_LUN_MAP_ARRAY_SIZE
];

65 
__u32
 
	mmax_·ges_š_eblock
;

66 
__u32
 
	mu£r_logicb_shiá
;

67 
	#PRIORITIZE_WRITE
 0x0001UL

	)

68 
	#ATOMIC_WRITE
 0x0002UL

	)

69 
	#BIG_EPILOG
 0x0004UL

	)

70 
	#COMPACT_EPILOG
 0x0008UL

	)

71 
	#SNAP_READ_ENABLE
 0x0010UL

	)

72 
	#LIMIT_BW_WHEN_DISKFULL
 0x0020UL

	)

73 
	#VENDOR_MODE_CMD_ENABLE
 0x0040UL

	)

74 
	#SINGLE_HEAD_ENABLE
 0x0080UL

	)

75 
	#SLC_ENABLE
 0x0100UL

	)

76 
	#OVERLAP_WRITE
 0x0200UL

	)

77 
	#FAST_READ_ENABLE
 0x0400UL

	)

78 
__u64
 
	mã©u»_æags
;

79 
__u8
 
	mpow”_budg‘
;

81 
__u8
 
	mdma_max_»ad_lim™
;

82 
	#CLK_200M
 0x5

	)

83 
	#CLK_166M
 0x6

	)

84 
__u16
 
	mşk
;

85 
__u32
 
	mmax_out¡ªdšg_bios
;

87 
__u32
 
	mmbr_upd©e
;

89 
__u8
 
	m‹mp_th»shŞd1
;

90 
__u8
 
	m‹mp_ü™iÿl_th»shŞd1
;

92 
__u8
 
	m‹mp_th»shŞd2
;

93 
__u8
 
	m‹mp_ü™iÿl_th»shŞd2
;

95 
__u64
 
	mpoŞ_w©”m¬k
;

96 
__u16
 
	msdev_id
;

97 
__u16
 
	msdev_couÁ
;

99 
__u16
 
	msh¬ed_·ges
;

100 
__u8
 
	mp£udo_¶ªe
;

101 
__u8
 
	m¶ªe_couÁ
;

103 
__u32
 
	m³riod_»ad_³riod
;

104 
__u32
 
	m³riod_»ad_µa
;

106 
__u32
 
	mdummy_wÜdlše
;

107 
__u16
 
	mmax_k“p_”a£d_hours
;

108 
__u16
 
	m»ad_»Œy
;

109 
__u16
 
	mecc_çu»_¿‹_th»shŞd
;

110 
__u16
 
	mmax_wr™e_bw
;

111 
__u16
 
	md©a_»‹ÁiÚ_š‹rv®
;

112 
__u8
 
	mµa_·ge_width
;

113 
__u8
 
	mµa_¶ªe_width
;

114 
__u32
 
	mıs_v”siÚ
;

116 
__u32
 
	mov”Ïp_sblk
;

117 
__u32
 
	m³_cyşe
;

118 
__u8
 
	m»£rved
[180];

121 
	#SHANNON_NS_NUM
 1000

	)

122 
	#PRIORITY_LEVELS
 3

	)

128 
	#ns_©Œi1_£ùÜs
(
ns_©Œi
è(Òs_©Œi)>>24)

	)

129 
	#ns_©Œi1_max_iİs
(
ns_©Œi
è(Òs_©Œi)&((1UL<<24)-1))

	)

130 
	#make_ns_©Œi1
(
size
, 
max_iİs
è(((size)<<24è| (max_iİs))

	)

138 
	#SEQ_NUM_SHIFT
 0

	)

139 
	#SEQ_NUM_MASK
 0x3FF

	)

140 
	#PRIORITY_SHIFT
 10

	)

141 
	#PRIORITY_MASK
 0xF

	)

142 
	#BLOCKSHIFT_SHIFT
 14

	)

143 
	#BLOCKSHIFT_MASK
 0xF

	)

144 
	#ns_©Œi2_£q_num
(
ns_©Œi2
è((Òs_©Œi2è>> 
SEQ_NUM_SHIFT
è& 
SEQ_NUM_MASK
)

	)

145 
	#ns_©Œi2_´iÜ™y
(
ns_©Œi2
è((Òs_©Œi2è>> 
PRIORITY_SHIFT
è& 
PRIORITY_MASK
)

	)

146 
	#ns_©Œi2_blockshiá
(
ns_©Œi2
è((Òs_©Œi2è>> 
BLOCKSHIFT_SHIFT
è& 
BLOCKSHIFT_MASK
)

	)

147 
	#make_ns_©Œi2
(
´iÜ™y
, 
£q_num
, 
blockshiá
è((((£q_numè& 
SEQ_NUM_MASK
è<< 
SEQ_NUM_SHIFT
) | \

148 (((
´iÜ™y
è& 
PRIORITY_MASK
è<< 
PRIORITY_SHIFT
) | \

149 (((
blockshiá
è& 
BLOCKSHIFT_MASK
è<< 
BLOCKSHIFT_SHIFT
))

	)

151 
	#POOL_INFO_LUNS
 32

	)

153 
	sshªnÚ_poŞ_šfo
 {

154 
__u32
 
	mfÜm©_v”siÚ
;

155 
__u32
 
	mupd©e_couÁ
;

156 
__u16
 
	mcur_ns_£q_num
;

157 
__u16
 
	m·d
[3];

158 
__u64
 
	mavaabË_ÿ·c™y
;

159 
__u64
 
	m»£rved
[29];

160 
__u64
 
	mns_b™m­
[16];

161 
__u64
 
	mns_©Œi1
[
SHANNON_NS_NUM
];

162 
__u32
 
	mns_©Œi2
[
SHANNON_NS_NUM
];

163 
__u32
 
	mns_©Œi3
[
SHANNON_NS_NUM
];

	@shannon_memblock.h

10 #iâdeà
__SHANNON_MEMBLOCK_H


11 
	#__SHANNON_MEMBLOCK_H


	)

13 
	~<lšux/ty³s.h
>

14 
	#MAP_TABLE
 (0x1)

	)

15 
	#TEMP_TABLE
 (0x2)

	)

16 
	#MAP_TABLE_MEMBLOCK_SIZE_SHIFT
 (22)

17 
	#TEMP_TABLE_MEMBLOCK_SIZE_SHIFT
 (20)

18 
	#MAP_TABLE_ENTRY_SIZE
 ((
u32
))

	)

19 
	#TEMP_TABLE_ENTRY_SIZE
 ((
u8
))

	)

22 
	#g‘_¦Ù_äom_Ímt
(
sdisk
, 
lba
) ({ \

23 
u64
 
__¦Ù
; \

24 
u32
 
_¡r_size
 = (
sdisk
)->
¡r_size
 * (sdisk)->
sdev_couÁ
; \

25 ià((
sdisk
)->
sdev_couÁ
 == 1) \

26 
__¦Ù
 = (
lba
); \

27 ià((
_¡r_size
 & (_strip_size - 1)) == 0) \

28 
__¦Ù
 = (((
lba
è>> 
	`fšd_fœ¡_b™
((*)&
_¡r_size
, (
u32
))è<< (
sdisk
)->
¡r_size_shiá
è+ (Öbaè& ((sdisk)->
¡r_size
 - 1)); \

30 
__¦Ù
 = (((((
lba
è/ ((
sdisk
)->
¡r_size
 * (sdisk)->
sdev_couÁ
)è<< (sdisk)->
¡r_size_shiá
)) + ((lba) & ((sdisk)->strip_size - 1))); \

32 
__¦Ù
; \

33 })

	)

34 
	#g‘_lba_äom_Ímt_¦Ù
(
sdev
, 
sdisk
, 
¦Ù
è(((¦Ùè>> (sdisk)->
¡r_size_shiá
è* ((sdisk)->
¡r_size
 * (sdisk)->
sdev_couÁ
) + \

35 ((
¦Ù
è& ((
sdisk
)->
¡r_size
 - 1)è+ (
sdev
)->
sdev_id
 * (sdisk)->¡r_size)

	)

37 
	#LPMT_INVALID
 (~0x0u)

	)

38 
	sshªnÚ_memblock_poŞ
 {

39 
u32
 
	mmemblock_size
;

40 
u32
 
	m’Œy_size
;

41 
	#DEFAULT_MIN_THRESHOLD
 (30)

	)

42 
shªnÚ_©omic_t
 
	mmš_th»shŞd
;

43 
shªnÚ_©omic_t
 
	mmax_th»shŞd
;

44 
shªnÚ_©omic_t
 
	mä“_út
;

45 
shªnÚ_©omic_t
 
	mu£d_út
;

46 
shªnÚ_wÜk_¡ruù
 
	m®loc_wÜk
;

47 
shªnÚ_wÜkqueue_¡ruù_t
 *
	mmemblock_wq
;

49 
shªnÚ_¥šlock_t
 
	mli¡_lock
;

50 
u8
 *
	mÏ¡
;

51 
u8
 *
	mä“_li¡
;

54 
	ssÿ‰”_memblock
 {

55 
u64
 
	mtÙ®_size
;

56 
u64
 
	mmemblock_size
;

57 
u32
 
	mmemblock_size_shiá
;

58 
u32
 
	m’Œy_size
;

59 
u32
 
	m’Œys_³r_memblock
;

60 
u32
 
	mmemblock_couÁ
;

61 
	#MEMBLOCK_LOCK_CNT
 (16)

62 
shªnÚ_mu‹x_t
 
li¡_lock
[
MEMBLOCK_LOCK_CNT
];

	)

64 
u8
 **
	mmemblock_li¡
;

66 
shªnÚ_memblock_poŞ
 *
	mmpoŞ
;

69 
check_ªd_®loc_memblock
(
sÿ‰”_memblock
 *
smb
, 
logicb64_t
 
off£t
);

	@shannon_microcode.c

1 
u32
 
	gmiüÚ_19_miüocode_bË
[] = {

93 
u32
 
	gtoshiba_a19_miüocode_bË
[] = {

282 
u32
 
	gtoshiba_a19_128gb_miüocode_bË
[] = {

471 
u32
 
	gtoshiba_19_miüocode_bË
[] = {

574 
u32
 
	gtoshiba_15_miüocode_bË
[] = {

760 
u32
 
	g§ndisk_15_miüocode_bË
[] = {

1142 
	$wr™e_advªûd_»ad_miüocode
(
shªnÚ_dev
 *
sdev
, 
num
)

1144 
i
;

1145 
u32
 *
bË
 = (u32 *)
sdev
->
miüocode_¬¿y
[
num
].table;

1146 
¬¿y_size
 = 
sdev
->
miüocode_¬¿y
[
num
].
miüocode_Ëngth
;

1148 ià((
num
 < 0è|| (num >ğ
MICROCODE_ARRAY_SIZE
))

1151 
	`BUG_ON
(!(
sdev
->
miüocode_¬¿y
[
num
].
¡©e
 & 
MICROCODE_VALID_MASK
));

1152 
	`BUG_ON
(
sdev
->
miüocode_¬¿y
[
num
].
¡¬t_»g
 == -1);

1153 
	`BUG_ON
((
sdev
->
miüocode_¬¿y
[
num
].
³_cyşe
 =ğ0è&& 
	`shªnÚ_dev_is_g5
(sdev));

1155 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

1157 ià(
sdev
->
miüocode_¬¿y
[
num
].
¡©e
 & 
MICROCODE_IN_USE_MASK
)

1158 
out
;

1160 
	`shªnÚ_šfo
("%s: upd©šg miüocodbË,‡¼ay index=%d.\n", 
sdev
->
cdev_Çme
, 
num
);

1161 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

1162 
i
 = 0; i < 
¬¿y_size
; i++) {

1163 
	`shªnÚ_iowr™e32
(
bË
[
i
], (
u32
 *)
sdev
->
b¬
 + sdev->
miüocode_¬¿y
[
num
].
¡¬t_»g
 + i);

1164 ià(
	`shªnÚ_dev_is_g5
(
sdev
è&& ((
i
 % 8) == 7)) {

1165 ià(
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + sdev->
miüocode_¬¿y
[
num
].
¡¬t_»g
 + 
i
è!ğ
bË
[i])

1169 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

1171 ià(
i
 !ğ
¬¿y_size
) {

1172 
	`shªnÚ_”r
("update microcode failed.\n");

1173 
out
;

1176 
i
 = 0; i < 
MICROCODE_ARRAY_SIZE
; i++) {

1177 ià(
i
 =ğ
num
) {

1178 
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 |ğ
MICROCODE_IN_USE_MASK
;

1179 
sdev
->
cu¼’t_miüocode_šdex
 = 
num
;

1181 
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 &ğ~
MICROCODE_IN_USE_MASK
;

1184 
out
:

1185 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

1186 
	}
}

1188 
	$ş—n_®l_miüocode_u£d_¡©e
(
shªnÚ_dev
 *
sdev
)

1190 
i
;

1192 
sdev
->
cu¼’t_miüocode_šdex
 = -1;

1193 
i
 = 0; i < 
MICROCODE_ARRAY_SIZE
; i++)

1194 
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 &ğ~
MICROCODE_IN_USE_MASK
;

1195 
	}
}

	@shannon_module_init.c

1 
	~<lšux/fs.h
>

2 
	~<lšux/bio.h
>

3 
	~<lšux/š‹¼u±.h
>

4 
	~<lšux/blkdev.h
>

5 
	~<lšux/”ºo.h
>

6 
	~<lšux/g’hd.h
>

7 
	~<lšux/kdev_t.h
>

8 
	~<lšux/kth»ad.h
>

9 
	~<lšux/k”Ãl.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/moduË·¿m.h
>

12 
	~<lšux/pci.h
>

13 
	~<lšux/sched.h
>

14 
	~<lšux/ty³s.h
>

15 
	~<lšux/v”siÚ.h
>

16 
	~<lšux/time.h
>

17 
	~<lšux/com¶‘iÚ.h
>

18 
	~<lšux/¿ndom.h
>

19 
	~<lšux/cdev.h
>

20 
	~<lšux/miscdeviû.h
>

22 
	~<lšux/fú.h
>

23 
	~<lšux/hd»g.h
>

25 
	~<lšux/ıu.h
>

26 
	~<asm/´oûssÜ.h
>

28 
	~"shªnÚ_pÜt.h
"

30 
	#SHANNON_CTRL_MINORS
 64

	)

32 
	gshªnÚ_scsi_mode
 = 0;

33 
moduË_·¿m
(
shªnÚ_scsi_mode
, , 
S_IRUGO
|
S_IWUSR
);

35 
	gshªnÚ_dev
;

36 
	gshªnÚ_memblock_poŞ
;

37 
shªnÚ_memblock_poŞ
 
m­_bË_poŞ
;

38 
shªnÚ_memblock_poŞ
 
‹mp_bË_poŞ
;

39 
shªnÚ_memblock_poŞ_š™
(
shªnÚ_memblock_poŞ
 *
mpoŞ
, 
u32
 
memblock_size
, u32 
’Œy_size
);

40 
shªnÚ_memblock_poŞ_de¡roy
(
shªnÚ_memblock_poŞ
 *
mpoŞ
);

41 
u64
 
g‘_shªnÚ_dev_£ùÜs
(
shªnÚ_dev
 *
dev
);

42 
u64
 
g‘_shªnÚ_ns_£ùÜs
(
shªnÚ_Çme¥aû
 *
ns
);

43 
sh_šü—£_u£rs
(
shªnÚ_dev
 *
dev
);

44 
sh_deü—£_u£rs
(
shªnÚ_dev
 *
dev
);

45 
sh_šü—£_u£rs_ns
(
shªnÚ_Çme¥aû
 *);

46 
sh_deü—£_u£rs_ns
(
shªnÚ_Çme¥aû
 *);

48 
shªnÚ_li¡_h—d
 
	gshªnÚ_dev_li¡
;

49 
shªnÚ_¥šlock_t
 
deviû_b™m­_lock
;

50 
shªnÚ_wÜkqueue_¡ruù_t
 *
	gshªnÚ_³rıu_wq
 = 
NULL
;

52 
shªnÚ_li¡_h—d
 
shªnÚ_poŞ_li¡
;

53 
shªnÚ_mu‹x_t
 
poŞ_£m
;

54 
	gshªnÚ_poŞ
;

55 
shªnÚ_poŞ
 *
¥oŞ_g‘_»ã»nû
(shannon_pool *);

56 
¥oŞ_put_»ã»nû
(
shªnÚ_poŞ
 *);

59 
	$shªnÚ_»v®id©e
(
g’disk
 *
disk
)

61 
shªnÚ_dev
 *
dev
 = 
disk
->
´iv©e_d©a
;

62 
	`£t_ÿ·c™y
(
disk
, 
	`g‘_shªnÚ_dev_£ùÜs
(
dev
));

64 
	}
}

66 
	$shªnÚ_g‘geo
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

68 
shªnÚ_dev
 *
dev
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

75 
geo
->
h—ds
 = 32;

76 
geo
->
£ùÜs
 = 32;

77 
geo
->
cylšd”s
 = 
	`g‘_shªnÚ_dev_£ùÜs
(
dev
è/ (geo->
h—ds
 * geo->
£ùÜs
);

79 
	}
}

81 
	$shªnÚ_»v®id©e_ns
(
g’disk
 *
disk
)

83 
shªnÚ_Çme¥aû
 *
ns
 = 
disk
->
´iv©e_d©a
;

84 
	`£t_ÿ·c™y
(
disk
, 
	`g‘_shªnÚ_ns_£ùÜs
(
ns
));

86 
	}
}

88 
	$shªnÚ_g‘geo_ns
(
block_deviû
 *
bdev
, 
hd_geom‘ry
 *
geo
)

90 
shªnÚ_Çme¥aû
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

97 
geo
->
h—ds
 = 32;

98 
geo
->
£ùÜs
 = 32;

99 
geo
->
cylšd”s
 = 
	`g‘_shªnÚ_ns_£ùÜs
(
ns
è/ (geo->
h—ds
 * geo->
£ùÜs
);

101 
	}
}

103 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 28)

105 
	$shªnÚ_İ’
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

107 
shªnÚ_dev
 *
dev
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

108  
	`sh_šü—£_u£rs
(
dev
);

109 
	}
}

111 
	$shªnÚ_İ’_ns
(
block_deviû
 *
bdev
, 
fmode_t
 
mode
)

113 
shªnÚ_Çme¥aû
 *
ns
 = 
bdev
->
bd_disk
->
´iv©e_d©a
;

114  
	`sh_šü—£_u£rs_ns
(
ns
);

115 
	}
}

117 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 10, 0)

118 
	$shªnÚ_»Ëa£
(
g’disk
 *
gd
, 
fmode_t
 
mode
)

120 
shªnÚ_dev
 *
dev
 = 
gd
->
´iv©e_d©a
;

121 
	`sh_deü—£_u£rs
(
dev
);

122 
	}
}

124 
	$shªnÚ_»Ëa£_ns
(
g’disk
 *
gd
, 
fmode_t
 
mode
)

126 
shªnÚ_Çme¥aû
 *
ns
 = 
gd
->
´iv©e_d©a
;

127 
	`sh_deü—£_u£rs_ns
(
ns
);

128 
	}
}

130 
	$shªnÚ_»Ëa£
(
g’disk
 *
gd
, 
fmode_t
 
mode
)

132 
shªnÚ_dev
 *
dev
 = 
gd
->
´iv©e_d©a
;

133 
	`sh_deü—£_u£rs
(
dev
);

135 
	}
}

137 
	$shªnÚ_»Ëa£_ns
(
g’disk
 *
gd
, 
fmode_t
 
mode
)

139 
shªnÚ_Çme¥aû
 *
ns
 = 
gd
->
´iv©e_d©a
;

140 
	`sh_deü—£_u£rs_ns
(
ns
);

142 
	}
}

145 
block_deviû_İ”©iÚs
 
	gshªnÚ_İs
 = {

146 .
owÃr
 = 
THIS_MODULE
,

147 .
	gg‘geo
 = 
shªnÚ_g‘geo
,

148 .
	g»v®id©e_disk
 = 
shªnÚ_»v®id©e
,

149 .
	gİ’
 = 
shªnÚ_İ’
,

150 .
	g»Ëa£
 = 
shªnÚ_»Ëa£
,

155 
	$shªnÚ_İ’
(
šode
 *šode, 
fe
 *
fp
)

157 
shªnÚ_dev
 *
dev
 = 
šode
->
i_bdev
->
bd_disk
->
´iv©e_d©a
;

158  
	`sh_šü—£_u£rs
(
dev
);

159 
	}
}

161 
	$shªnÚ_İ’_ns
(
šode
 *šode, 
fe
 *
fp
)

163 
shªnÚ_Çme¥aû
 *
ns
 = 
šode
->
i_bdev
->
bd_disk
->
´iv©e_d©a
;

164  
	`sh_šü—£_u£rs_ns
(
ns
);

165 
	}
}

167 
	$shªnÚ_»Ëa£
(
šode
 *šode, 
fe
 *
fp
)

169 
shªnÚ_dev
 *
dev
 = 
šode
->
i_bdev
->
bd_disk
->
´iv©e_d©a
;

170 
	`sh_deü—£_u£rs
(
dev
);

172 
	}
}

174 
	$shªnÚ_»Ëa£_ns
(
šode
 *šode, 
fe
 *
fp
)

176 
shªnÚ_Çme¥aû
 *
ns
 = 
šode
->
i_bdev
->
bd_disk
->
´iv©e_d©a
;

177 
	`sh_deü—£_u£rs_ns
(
ns
);

179 
	}
}

181 
block_deviû_İ”©iÚs
 
	gshªnÚ_İs
 = {

182 .
owÃr
 = 
THIS_MODULE
,

183 .
	gg‘geo
 = 
shªnÚ_g‘geo
,

184 .
	g»v®id©e_disk
 = 
shªnÚ_»v®id©e
,

185 .
	gİ’
 = 
shªnÚ_İ’
,

186 .
	g»Ëa£
 = 
shªnÚ_»Ëa£
,

191 
block_deviû_İ”©iÚs
 
	gshªnÚ_İs_ns
 = {

192 .
owÃr
 = 
THIS_MODULE
,

193 .
	gg‘geo
 = 
shªnÚ_g‘geo_ns
,

194 .
	g»v®id©e_disk
 = 
shªnÚ_»v®id©e_ns
,

195 .
	gİ’
 = 
shªnÚ_İ’_ns
,

196 .
	g»Ëa£
 = 
shªnÚ_»Ëa£_ns
,

200 
	$shªnÚ_ù¾_miscdeviû_İ’
(
šode
 *šode, 
fe
 *
fp
)

202 
shªnÚ_dev
 *
sdev
 = 
NULL
;

203 
mšÜ
 = 
	`imšÜ
(
šode
);

204 
miscdeviû
 *
c
 = 
NULL
;

205 
shªnÚ_li¡_h—d
 *
li¡
;

207 
	`shªnÚ_¥š_lock_bh
(&
deviû_b™m­_lock
);

209 
	`shªnÚ_li¡_fÜ_—ch
(
li¡
, &
shªnÚ_dev_li¡
) {

210 
sdev
 = 
	`g‘_shªnÚ_dev_äom_li¡
(
li¡
);

211 
c
 = (
miscdeviû
 *)
	`g‘_miscdeviû_äom_shªnÚ_dev
(
sdev
);

212 ià(
c
->
mšÜ
 == minor)

216 
	`shªnÚ_¥š_uÆock_bh
(&
deviû_b™m­_lock
);

218 ià((
c
 =ğ
NULL
è|| (c->
mšÜ
 != minor)) {

219 
fp
->
´iv©e_d©a
 = 
NULL
;

220  -
ENODEV
;

222 
fp
->
´iv©e_d©a
 = 
sdev
;

225 
	}
}

227 
	$shªnÚ_ù¾_miscdeviû_»Ëa£
(
šode
 *šode, 
fe
 *
fp
)

230 
	}
}

232 
shªnÚ_ioùl
(
shªnÚ_fe_t
 *
fp
, 
cmd
, 
¬g
);

234 
	$shªnÚ_ioùl_w¿µ”
(
fe
 *
fp
, 
cmd
, 
¬g
)

236  
	`shªnÚ_ioùl
(
fp
, 
cmd
, 
¬g
);

237 
	}
}

239 
fe_İ”©iÚs
 
	gshªnÚ_ù¾_miscdeviû_fİs
 = {

240 .
owÃr
 = 
THIS_MODULE
,

241 .
	gİ’
 = 
shªnÚ_ù¾_miscdeviû_İ’
,

242 .
	g»Ëa£
 = 
shªnÚ_ù¾_miscdeviû_»Ëa£
,

243 .
	guÆocked_ioùl
 = 
shªnÚ_ioùl_w¿µ”
,

247 
	$miscdeviû_š™
(
miscdeviû
 *
md
, *
cdev_Çme
)

249 
	`mem£t
(
md
, 0, (*md));

250 
md
->
mšÜ
 = 
MISC_DYNAMIC_MINOR
;

251 
md
->
Çme
 = 
cdev_Çme
;

252 
md
->
fİs
 = &
shªnÚ_ù¾_miscdeviû_fİs
;

253 
	}
}

255 
	$shªnÚ_poŞ_miscdeviû_İ’
(
šode
 *šode, 
fe
 *
fp
)

257 *
¥oŞ
 = 
NULL
;

258 
mšÜ
 = 
	`imšÜ
(
šode
);

259 
miscdeviû
 *
c
 = 
NULL
;

260 
shªnÚ_li¡_h—d
 *
li¡
;

262 
	`shªnÚ_mu‹x_lock
(&
poŞ_£m
);

263 
	`shªnÚ_li¡_fÜ_—ch
(
li¡
, &
shªnÚ_poŞ_li¡
) {

264 
¥oŞ
 = 
	`g‘_shªnÚ_poŞ_äom_li¡
(
li¡
);

265 
c
 = (
miscdeviû
 *)
	`g‘_miscdeviû_äom_shªnÚ_poŞ
(
¥oŞ
);

266 ià(
c
->
mšÜ
 == minor) {

267 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(spool);

271 
	`shªnÚ_mu‹x_uÆock
(&
poŞ_£m
);

273 ià((
c
 =ğ
NULL
è|| (c->
mšÜ
 != minor)) {

274 
fp
->
´iv©e_d©a
 = 
NULL
;

275  -
ENODEV
;

277 
fp
->
´iv©e_d©a
 = 
¥oŞ
;

280 
	}
}

282 
	$shªnÚ_poŞ_miscdeviû_»Ëa£
(
šode
 *šode, 
fe
 *
fp
)

284 *
¥oŞ
 = 
fp
->
´iv©e_d©a
;

285 
	`¥oŞ_put_»ã»nû
(
¥oŞ
);

287 
	}
}

289 
shªnÚ_poŞ_ioùl
(
shªnÚ_fe_t
 *
fp
, 
cmd
, 
¬g
);

290 
	$shªnÚ_poŞ_ioùl_w¿µ”
(
fe
 *
fp
, 
cmd
, 
¬g
)

292  
	`shªnÚ_poŞ_ioùl
(
fp
, 
cmd
, 
¬g
);

293 
	}
}

295 
fe_İ”©iÚs
 
	gshªnÚ_poŞ_miscdeviû_fİs
 = {

296 .
owÃr
 = 
THIS_MODULE
,

297 .
	gİ’
 = 
shªnÚ_poŞ_miscdeviû_İ’
,

298 .
	g»Ëa£
 = 
shªnÚ_poŞ_miscdeviû_»Ëa£
,

299 .
	guÆocked_ioùl
 = 
shªnÚ_poŞ_ioùl_w¿µ”
,

302 
	$poŞ_miscdeviû_š™
(
miscdeviû
 *
md
, *
cdev_Çme
, *
nod’ame
)

304 
	`mem£t
(
md
, 0, (*md));

305 
md
->
mšÜ
 = 
MISC_DYNAMIC_MINOR
;

306 
md
->
Çme
 = 
cdev_Çme
;

307 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

308 
md
->
nod’ame
 =‚odename;

310 
md
->
fİs
 = &
shªnÚ_poŞ_miscdeviû_fİs
;

311 
	}
}

313 
	$shªnÚ_ü—‹_miscdeviû
(*
misc_dev
, *
cdev_Çme
, *
nod’ame
, 
ty³
)

315 
miscdeviû
 *
misc
 = (miscdeviû *)
misc_dev
;

316 
»t
;

317 #ià
	`defšed
(
__VMKLNX__
)

318 
mšÜ
=254;

321 ià(
ty³
 =ğ
FOR_SDEV
)

322 
	`miscdeviû_š™
(
misc
, 
cdev_Çme
);

324 
	`poŞ_miscdeviû_š™
(
misc
, 
cdev_Çme
, 
nod’ame
);

326 #ià
	`defšed
(
__VMKLNX__
)

329 
misc
->
mšÜ
 = minor--;

331 
»t
 = 
	`misc_»gi¡”
(
misc
);

332 #ià
	`defšed
(
__VMKLNX__
)

334 
»t
 < 0 && 
mšÜ
 > 0);

337  
»t
;

338 
	}
}

340 
	$shªnÚ_de¡roy_miscdeviû
(*
misc_dev
)

342 
miscdeviû
 *
misc
 = (miscdeviû *)
misc_dev
;

344 
	`misc_d”egi¡”
(
misc
);

347 
	}
}

350 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

351 
	#DEFINE_PCI_DEVICE_TABLE
(
_bË
) \

352 cÚ¡ 
pci_deviû_id
 
_bË
[] 
__devš™d©a


	)

355 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4, 8, 0)

356 
	#DEFINE_PCI_DEVICE_TABLE
(
_bË
) \

357 cÚ¡ 
pci_deviû_id
 
_bË
[]

	)

362 
	#PCI_VENDOR_ID_SHANNON
 0x1cb0

	)

364 
pci_deviû_id
 
	gshªnÚ_id_bË
[] = {

365 #ià!
defšed
(
CONFIG_SHANNON_EMU
è&& !defšed(
CONFIG_SHANNON_EMU_MODULE
)

367 { 
PCI_DEVICE
(
PCI_VENDOR_ID_XILINX
, 0x6024), },

368 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x0265), },

369 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x0275), },

370 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x1275), },

371 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x2275), },

372 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x1285), },

373 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x3275), },

374 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x05a5), },

375 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x25a5), },

376 { 
PCI_DEVICE
(
PCI_VENDOR_ID_SHANNON
, 0x35a5), },

378 { 
PCI_DEVICE
(
PCI_VENDOR_ID_NVIDIA
, 0x0774), },

379 { 
PCI_DEVICE
(0x8086, 0x27d8), },

380 { 
PCI_DEVICE
(0x8086, 0x1c20), },

381 { 
PCI_DEVICE
(0x1013, 0x00b8), },

385 
MODULE_DEVICE_TABLE
(
pci
, 
shªnÚ_id_bË
);

387 
shªnÚ_scsi_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
);

388 
shªnÚ_scsi_»move
(
pci_dev
 *
pdev
);

389 
shªnÚ_»move
(*
d©a
, 
shªnÚ_pci_dev_t
 *
pdev
);

390 
shªnÚ_´obe
(
shªnÚ_pci_dev_t
 *
pdev
, cÚ¡ 
shªnÚ_pci_deviû_id_t
 *
id
, 
shªnÚ_scsi_´iv©e
 *
d©a
);

391 
__shªnÚ_pci_»£t_´•¬e
(
shªnÚ_pci_dev_t
 *
pdev
);

392 
__shªnÚ_pci_»£t_fšished
(
shªnÚ_pci_dev_t
 *
pdev
);

394 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 8, 0)

395 
	$shªnÚ_»move_w¿µ”
(
pci_dev
 *
pdev
)

397 
__devex™
 
	$shªnÚ_»move_w¿µ”
(
pci_dev
 *
pdev
)

400 ià(
shªnÚ_scsi_mode
)

401 
	`shªnÚ_scsi_»move
(
pdev
);

403 
	`shªnÚ_»move
(
NULL
, 
pdev
);

404 
	}
}

406 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 8, 0)

407 
	$shªnÚ_´obe_w¿µ”
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

409 
__devš™
 
	$shªnÚ_´obe_w¿µ”
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

412 ià(
shªnÚ_scsi_mode
)

413  
	`shªnÚ_scsi_´obe
(
pdev
, 
id
);

415  
	`shªnÚ_´obe
(
pdev
, 
id
, 
NULL
);

416 
	}
}

418 
	$shªnÚ_pci_»£t_´•¬e
(
pci_dev
 *
pdev
)

420 
	`__shªnÚ_pci_»£t_´•¬e
((
shªnÚ_pci_dev_t
 *)
pdev
);

421 
	}
}

423 
	$shªnÚ_pci_»£t_fšished
(
pci_dev
 *
pdev
)

425 
	`__shªnÚ_pci_»£t_fšished
((
shªnÚ_pci_dev_t
 *)
pdev
);

426 
	}
}

428 
	$shªnÚ_pci_»£t_nÙify
(
pci_dev
 *
pdev
, 
boŞ
 
´•¬e
)

430 ià(
´•¬e
)

431 
	`shªnÚ_pci_»£t_´•¬e
(
pdev
);

433 
	`shªnÚ_pci_»£t_fšished
(
pdev
);

434 
	}
}

436 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4, 13, 0)

437 
pci_”rÜ_hªdËrs
 
	gshªnÚ_pci_”rÜ_hªdËrs
 = {

438 .
»£t_´•¬e
 = 
shªnÚ_pci_»£t_´•¬e
,

439 .
	g»£t_dÚe
 = 
shªnÚ_pci_»£t_fšished
,

441 #–ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 16, 0)

442 
pci_”rÜ_hªdËrs
 
	gshªnÚ_pci_”rÜ_hªdËrs
 = {

443 .
»£t_nÙify
 = 
shªnÚ_pci_»£t_nÙify
,

446 #ifdeà
RHEL_RELEASE_CODE


447 #ià
RHEL_RELEASE_CODE
 >ğ
RHEL_RELEASE_VERSION
(7, 2)

448 
pci_driv”_rh
 
	gshªnÚ_pci_driv”_rh
 = {

449 .
size
 = (
pci_driv”_rh
),

450 .
	g»£t_nÙify
 = 
shªnÚ_pci_»£t_nÙify
,

454 
pci_”rÜ_hªdËrs
 
	gshªnÚ_pci_”rÜ_hªdËrs
 = {
NULL
};

457 
pci_driv”
 
	gshªnÚ_driv”
 = {

458 .
Çme
 = "shannon",

459 .
	gid_bË
 = 
shªnÚ_id_bË
,

460 .
	g´obe
 = 
shªnÚ_´obe_w¿µ”
,

461 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 8, 0)

462 .
	g»move
 = 
shªnÚ_»move_w¿µ”
,

464 .
	g»move
 = 
__devex™_p
(
shªnÚ_»move_w¿µ”
),

466 .
	gshutdown
 = 
shªnÚ_»move_w¿µ”
,

467 .
	g”r_hªdËr
 = &
shªnÚ_pci_”rÜ_hªdËrs
,

468 #ifdeà
RHEL_RELEASE_CODE


469 #ià
RHEL_RELEASE_CODE
 >ğ
RHEL_RELEASE_VERSION
(7, 2)

470 .
	gpci_driv”_rh
 = &
shªnÚ_pci_driv”_rh
,

475 
shªnÚ_kmem_ÿche_t
 *
shªnÚ_»q_¦ab
;

476 
shªnÚ_kmem_ÿche_t
 *
shªnÚ_bio_¦ab
;

477 
shªnÚ_mempoŞ_t
 *
shªnÚ_»q_poŞ
;

478 
shªnÚ_mempoŞ_t
 *
shªnÚ_bio_poŞ
;

481 
shªnÚ_li¡_h—d
 
shªnÚ_poŞ_li¡
;

482 
shªnÚ_mu‹x_t
 
poŞ_£m
;

483 
shªnÚ_majÜ
;

484 
shªnÚ_auto_©ch
;

486 
shªnÚ_£ùÜ_size
;

487 
moduË_·¿m
(
shªnÚ_£ùÜ_size
, , 
S_IRUGO
|
S_IWUSR
);

488 
shªnÚ_debug_Ëv–
;

489 
moduË_·¿m
(
shªnÚ_debug_Ëv–
, , 
S_IRUGO
|
S_IWUSR
);

490 
shªnÚ_fÜû_rw
;

491 
moduË_·¿m
(
shªnÚ_fÜû_rw
, , 
S_IRUGO
|
S_IWUSR
);

492 
moduË_·¿m
(
shªnÚ_majÜ
, , 0);

493 
moduË_·¿m
(
shªnÚ_auto_©ch
, , 0);

494 
shªnÚ_pm_qos_v®ue
;

495 
shªnÚ_pm_qos_di§bË
;

496 
moduË_·¿m
(
shªnÚ_pm_qos_v®ue
, , 
S_IRUGO
|
S_IWUSR
);

497 
moduË_·¿m
(
shªnÚ_pm_qos_di§bË
, , 
S_IRUGO
|
S_IWUSR
);

498 
shªnÚ_u£_iosched
;

499 
moduË_·¿m
(
shªnÚ_u£_iosched
, , 
S_IRUGO
|
S_IWUSR
);

500 
shªnÚ_bufãr_wr™e
;

501 
moduË_·¿m
(
shªnÚ_bufãr_wr™e
, , 
S_IRUGO
|
S_IWUSR
);

502 
shªnÚ_di§bË_š‹rv–_»äesh_mbr
;

503 
moduË_·¿m
(
shªnÚ_di§bË_š‹rv–_»äesh_mbr
, , 
S_IRUGO
|
S_IWUSR
);

504 
shªnÚ_Ãv”_hªg
;

505 
moduË_·¿m
(
shªnÚ_Ãv”_hªg
, , 
S_IRUGO
|
S_IWUSR
);

506 
shªnÚ_high_³rfÜmªû
;

507 
moduË_·¿m
(
shªnÚ_high_³rfÜmªû
, , 
S_IRUGO
|
S_IWUSR
);

508 
shªnÚ_fl_lšes
;

509 
moduË_·¿m
(
shªnÚ_fl_lšes
, , 
S_IRUGO
|
S_IWUSR
);

510 
	gshªnÚ_u£_³rıu_wq
;

511 
moduË_·¿m
(
shªnÚ_u£_³rıu_wq
, , 
S_IRUGO
|
S_IWUSR
);

512 
shªnÚ_š™_‹mp
;

513 
moduË_·¿m
(
shªnÚ_š™_‹mp
, , 
S_IRUGO
|
S_IWUSR
);

514 
shªnÚ_do_pci_»£t
;

515 
moduË_·¿m
(
shªnÚ_do_pci_»£t
, , 
S_IRUGO
|
S_IWUSR
);

516 
shªnÚ_do_¢­»ad
;

517 
moduË_·¿m
(
shªnÚ_do_¢­»ad
, , 
S_IRUGO
|
S_IWUSR
);

518 
shªnÚ_memblock_´—Îoc
;

519 
moduË_·¿m
(
shªnÚ_memblock_´—Îoc
, , 
S_IRUGO
|
S_IWUSR
);

520 
shªnÚ_fÜû_»şaim_aùiveblock
;

521 
moduË_·¿m
(
shªnÚ_fÜû_»şaim_aùiveblock
, , 
S_IRUGO
|
S_IWUSR
);

522 
shªnÚ_lßd_»adÚly
;

523 
moduË_·¿m
(
shªnÚ_lßd_»adÚly
, , 
S_IRUGO
|
S_IWUSR
);

525 
shªnÚ_u£_¹_comp_th»ad
;

526 
moduË_·¿m
(
shªnÚ_u£_¹_comp_th»ad
, , 0);

528 
shªnÚ_v’dÜ_cmd
;

529 
moduË_·¿m
(
shªnÚ_v’dÜ_cmd
, , 
S_IRUGO
|
S_IWUSR
);

531 
shªnÚ_ov”Ïp_wr™e
;

532 
moduË_·¿m
(
shªnÚ_ov”Ïp_wr™e
, , 
S_IRUGO
|
S_IWUSR
);

533 
shªnÚ_dyÇmic_œq_d–ay
;

534 
moduË_·¿m
(
shªnÚ_dyÇmic_œq_d–ay
, , 
S_IRUGO
|
S_IWUSR
);

536 
shªnÚ_®loc_mempoŞ
();

537 
shªnÚ_ä“_mempoŞ
();

539 
	ghas_dma_d–ay
 = 0;

540 
	$check_has_dma_d–ay
()

542 #ifdeà
CONFIG_X86


543 
ıušfo_x86
 *
c
 = 
NULL
;

545 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

546 
c
 = &
	`ıu_d©a
(0);

548 
c
 = &
ıu_d©a
[0];

550 
has_dma_d–ay
 = !(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
);

551 #ifdeà
CONFIG_SHANNON_DMA_REORDER


552 
has_dma_d–ay
 = 1;

555 
	`shªnÚ_šfo
("ıu v’dÜ_id: %s, has_dma_d–ay: %s.\n", 
c
->
x86_v’dÜ_id
, 
has_dma_d–ay
 ? "yes" : "no");

557 #ifdeà
CONFIG_SHANNON_DMA_REORDER


558 
has_dma_d–ay
 = 1;

560 
has_dma_d–ay
 = 0;

565 
	}
}

567 
__š™
 
	$shªnÚ_š™
()

569 
»suÉ
 = -
ENOMEM
;

570 
m­_bË_poŞ
.
memblock_wq
 = 
NULL
;

571 
‹mp_bË_poŞ
.
memblock_wq
 = 
NULL
;

573 ià(
shªnÚ_scsi_mode
) {

574 
shªnÚ_u£_³rıu_wq
 = 1;

575 
shªnÚ_pm_qos_di§bË
 = 1;

578 
	`check_has_dma_d–ay
();

580 
	`shªnÚ_¥š_lock_š™
(&
deviû_b™m­_lock
);

581 
	`SHANNON_INIT_LIST_HEAD
(&
shªnÚ_dev_li¡
);

582 
shªnÚ_majÜ
 = 
	`»gi¡”_blkdev
(shannon_major, "shannon");

583 
	`SHANNON_INIT_LIST_HEAD
(&
shªnÚ_dev_li¡
);

584 
	`SHANNON_INIT_LIST_HEAD
(&
shªnÚ_poŞ_li¡
);

585 
	`shªnÚ_mu‹x_š™
(&
poŞ_£m
);

586 ià(
shªnÚ_u£_³rıu_wq
) {

587 
shªnÚ_³rıu_wq
 = 
	`shªnÚ_ü—‹_wÜkqueue
("shn_percpu_wq");

588 ià(
shªnÚ_³rıu_wq
 =ğ
NULL
) {

589 
	`shªnÚ_”r
("alloc shannon_percpu_wq workqueue failed!\n");

590 
uÄegi¡”_blkdev
;

594 ià(
	`shªnÚ_memblock_poŞ_š™
(&
m­_bË_poŞ
, 
MAP_TABLE_MEMBLOCK_SIZE_SHIFT
, 
MAP_TABLE_ENTRY_SIZE
))

595 
de¡roy_wq
;

596 ià(
	`shªnÚ_memblock_poŞ_š™
(&
‹mp_bË_poŞ
, 
TEMP_TABLE_MEMBLOCK_SIZE_SHIFT
, 
TEMP_TABLE_ENTRY_SIZE
))

597 
de¡roy_wq
;

598 ià(
	`shªnÚ_®loc_mempoŞ
())

599 
de¡roy_wq
;

601 
»suÉ
 = 
	`pci_»gi¡”_driv”
(&
shªnÚ_driv”
);

602 ià(
»suÉ
)

603 
ä“_mempoŞ
;

607 
ä“_mempoŞ
:

608 
	`shªnÚ_ä“_mempoŞ
();

609 
de¡roy_wq
:

610 ià(
shªnÚ_³rıu_wq
)

611 
	`shªnÚ_de¡roy_wÜkqueue
(
shªnÚ_³rıu_wq
);

612 ià(
m­_bË_poŞ
.
memblock_wq
)

613 
	`shªnÚ_de¡roy_wÜkqueue
(
m­_bË_poŞ
.
memblock_wq
);

614 ià(
‹mp_bË_poŞ
.
memblock_wq
)

615 
	`shªnÚ_de¡roy_wÜkqueue
(
‹mp_bË_poŞ
.
memblock_wq
);

616 
uÄegi¡”_blkdev
:

617 
	`uÄegi¡”_blkdev
(
shªnÚ_majÜ
, "shannon");

618  
»suÉ
;

619 
	}
}

621 
__ex™
 
	$shªnÚ_ex™
()

623 
	`pci_uÄegi¡”_driv”
(&
shªnÚ_driv”
);

624 
	`shªnÚ_memblock_poŞ_de¡roy
(&
m­_bË_poŞ
);

625 
	`shªnÚ_memblock_poŞ_de¡roy
(&
‹mp_bË_poŞ
);

626 
	`shªnÚ_ä“_mempoŞ
();

628 ià(
shªnÚ_³rıu_wq
)

629 
	`shªnÚ_de¡roy_wÜkqueue
(
shªnÚ_³rıu_wq
);

630 
	`uÄegi¡”_blkdev
(
shªnÚ_majÜ
, "shannon");

631 
	}
}

633 
MODULE_LICENSE
("GPL");

634 
MODULE_VERSION
("3.2.2.4");

635 
moduË_š™
(
shªnÚ_š™
);

636 
moduË_ex™
(
shªnÚ_ex™
);

	@shannon_nor.c

1 
	snÜæash_šfo
 {

2 
u64
 
	mmagic_numb”
;

3 
	m£rviû_g
[32];

4 
	mmod–_id
[40];

7 
	s·¿m_lšk
 {

8 
u16
 
	m»g_off£t
;

9 
u16
 
	mËngth
;

10 
u32
 
	mp_Ãxt
;

11 
	m·¿m_æag
[32];

12 
u32
 
	mv®ues
[];

17 
	#NORFLASH_ERASE_ADDR
 0x34

	)

18 
	#NORFLASH_ERASE_CTRL
 0x35

	)

20 
	#NORFLASH_WRITE_ADDR
 0x36

	)

21 
	#NORFLASH_WRITE_CTRL
 0x37

	)

23 
	#NORFLASH_READ_ADDR
 0x38

	)

24 
	#NORFLASH_READ_LENGTH
 0x39

	)

25 
	#NORFLASH_READ_CTRL
 0x3a

	)

27 
	#NORFLASH_TIMEOUT
 1000000

28 

	)

32 
	$__u8_Ë2be
(*
buf
, 
couÁ
)

34 
i
, 
k
;

35 
__u8
 
d©a
, 
t
;

37 
i
 = 0; i < 
couÁ
; i++) {

38 
t
 = 0;

39 
d©a
 = ((
__u8
 *)
buf
)[
i
];

41 
k
 = 0; k < 8; k++) {

42 ià(
d©a
 & (1 << 
k
))

43 
t
 |ğ(1 << (7 - 
k
));

46 ((
__u8
 *)
buf
)[
i
] = 
t
;

48 
	}
}

51 
	$shªnÚ_š™_nÜæash
(
shªnÚ_dev
 *
sdev
)

53 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

54 
sdev
->
nÜæash_id
 = 
	`»ad_»g_§ã
(sdev, (
u32
 *)sdev->
b¬
 + 
SH_NORFLASH_ID_OFFSET
);

56 
sdev
->
nÜæash_id
 = 
	`»ad_»g_§ã
(sdev, (
u32
 *)sdev->
b¬
 + 0x32);

57 
	`debugs1
("NOR fÏsh idğ0x%x.\n", 
sdev
->
nÜæash_id
);

59 ià(0x01800119 =ğ
sdev
->
nÜæash_id
 || 0x20100119 == sdev->norflash_id) {

61 
sdev
->
nÜæash
.
blk_couÁ
 = 542;

62 
sdev
->
nÜæash
.
size_šby‹s
 = 510 * 64 * 1024 + 32 * 4 * 1024;

63 
sdev
->
nÜæash
.
£gm’ts
 = 2;

64 
sdev
->
nÜæash
.
buf_addr
 = 0x800;

65 
sdev
->
nÜæash
.
buf_size
 = 256;

66 
sdev
->
nÜæash
.
´iv©e_št
 = 0;

68 
sdev
->
nÜæash
.
£gm’t
[0].
¡¬t_phyaddr
 = 0x0;

69 
sdev
->
nÜæash
.
£gm’t
[0].
’d_phyaddr
 = 0x01FDFFFF;

70 
sdev
->
nÜæash
.
£gm’t
[0].
blk_size
 = 0x10000;

72 
sdev
->
nÜæash
.
£gm’t
[1].
¡¬t_phyaddr
 = 0x01FE0000;

73 
sdev
->
nÜæash
.
£gm’t
[1].
’d_phyaddr
 = 0x01FFFFFF;

74 
sdev
->
nÜæash
.
£gm’t
[1].
blk_size
 = 0x1000;

76 } ià(0x017E2201 =ğ
sdev
->
nÜæash_id
) {

78 
sdev
->
nÜæash
.
blk_couÁ
 = 256;

79 
sdev
->
nÜæash
.
size_šby‹s
 = 256 * 128 * 1024;

80 
sdev
->
nÜæash
.
£gm’ts
 = 1;

81 
sdev
->
nÜæash
.
buf_addr
 = 0x800;

82 
sdev
->
nÜæash
.
buf_size
 = 64;

83 
sdev
->
nÜæash
.
´iv©e_št
 = 1;

85 
sdev
->
nÜæash
.
£gm’t
[0].
¡¬t_phyaddr
 = 0x0;

86 
sdev
->
nÜæash
.
£gm’t
[0].
’d_phyaddr
 = 0x01FFFFFF;

87 
sdev
->
nÜæash
.
£gm’t
[0].
blk_size
 = 0x20000;

89 } ià(0xEF6014FF =ğ
sdev
->
nÜæash_id
 || 0x62161400 == sdev->norflash_id) {

91 
sdev
->
nÜæash
.
blk_couÁ
 = 256;

92 
sdev
->
nÜæash
.
size_šby‹s
 = 256 * 4 * 1024;

93 
sdev
->
nÜæash
.
£gm’ts
 = 1;

94 
sdev
->
nÜæash
.
buf_addr
 = 0x1000;

95 
sdev
->
nÜæash
.
buf_size
 = 4096;

96 
sdev
->
nÜæash
.
´iv©e_št
 = 0;

98 
sdev
->
nÜæash
.
£gm’t
[0].
¡¬t_phyaddr
 = 0x0;

99 
sdev
->
nÜæash
.
£gm’t
[0].
’d_phyaddr
 = 0x0FFFFF;

100 
sdev
->
nÜæash
.
£gm’t
[0].
blk_size
 = 0x1000;

102 } ià(0x0102194D =ğ
sdev
->
nÜæash_id
 || 0x20BB1910 == sdev->norflash_id || 0x20BA1910 == sdev->norflash_id) {

104 
sdev
->
nÜæash
.
blk_couÁ
 = 512;

105 
sdev
->
nÜæash
.
size_šby‹s
 = 512 * 64 * 1024;

106 
sdev
->
nÜæash
.
£gm’ts
 = 1;

107 
sdev
->
nÜæash
.
buf_addr
 = 0x1000;

108 
sdev
->
nÜæash
.
buf_size
 = 4096;

109 
sdev
->
nÜæash
.
´iv©e_št
 = 0;

111 
sdev
->
nÜæash
.
£gm’t
[0].
¡¬t_phyaddr
 = 0x0;

112 
sdev
->
nÜæash
.
£gm’t
[0].
’d_phyaddr
 = 0x1FFFFFF;

113 
sdev
->
nÜæash
.
£gm’t
[0].
blk_size
 = 0x10000;

116 
	`shªnÚ_”r
("wrÚg NOR fÏsh id, 0x%x\n", 
sdev
->
nÜæash_id
);

120 
	`shªnÚ_mu‹x_š™
(&
sdev
->
nÜæash_İs_£m
);

123 
	}
}

125 
	$shªnÚ_nÜæash_”a£
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
, u32 
Ëngth
)

127 
£g
;

128 
u32
 
blk_size
;

129 
»maš
;

132 ià(
phyaddr
 + 
Ëngth
 > 
sdev
->
nÜæash
.
size_šby‹s
) {

133 
	`shªnÚ_”r
("overflow NOR‡ddress!\n");

137 ià(
Ëngth
 == 0) {

138 
	`shªnÚ_”r
("Ëngth %d i šv®id!\n", 
Ëngth
);

142 
£g
 = 0; seg < 
sdev
->
nÜæash
.
£gm’ts
; seg++)

144 ià(
phyaddr
 >ğ
sdev
->
nÜæash
.
£gm’t
[
£g
].
¡¬t_phyaddr
 &&…hyadd¸<ğsdev->nÜæash.£gm’t[£g].
’d_phyaddr
)

147 ià(
£g
 =ğ
sdev
->
nÜæash
.
£gm’ts
) {

148 
	`shªnÚ_”r
("ÿÂÙ fšd NOR segm’ˆtØ”a£,…hyaddr=0x%08x.\n", 
phyaddr
);

152 
blk_size
 = 
sdev
->
nÜæash
.
£gm’t
[
£g
].blk_size;

154 ià(
phyaddr
 % 
blk_size
) {

155 
	`shªnÚ_”r
("phyaddr is‚ot block‡ligned\n");

159 
»maš
 = 
Ëngth
;

160 
sdev
->
nÜæash
.
´og»ss
 = 0;

162 
»maš
 > 0)

165 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

166 ià(
	`shªnÚ_nÜæash_”a£_g5
(
sdev
, 
phyaddr
) < 0)

169 ià(
	`shªnÚ_nÜæash_”a£_g4
(
sdev
, 
phyaddr
) < 0)

173 
	`shªnÚ_šfo
("”a£ NOR fÏsh:…hyaddrğ0x%x, blk_size=0x%x,„emašğ0x%x,†’gthğ0x%x\n", 
phyaddr
, 
blk_size
, 
»maš
, 
Ëngth
);

174 
	`shªnÚ_m¦“p
(15);

177 
phyaddr
 +ğ
blk_size
;

178 ià(
phyaddr
 > 
sdev
->
nÜæash
.
£gm’t
[
£g
].
’d_phyaddr
) {

180 ià(++
£g
 >ğ
sdev
->
nÜæash
.
£gm’ts
)

182 
phyaddr
 -ğ
blk_size
;

183 
blk_size
 = 
sdev
->
nÜæash
.
£gm’t
[
£g
].blk_size;

184 
phyaddr
 +ğ
blk_size
;

187 
»maš
 -ğ
blk_size
;

188 
sdev
->
nÜæash
.
´og»ss
 = (
Ëngth
 - 
»maš
) * 100 /†ength;

192 
	}
}

194 
	$shªnÚ_nÜæash_wr™e
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
, u32 
Ëngth
, *
d©a
)

196 
£g
;

197 
u32
 *
buf
 = 
NULL
;

198 
u32
 
blk_size
;

199 
u32
 
xãr_size
;

200 
»maš
;

201 
u32
 
com¶‘e
;

202 
i
 = 0, 
»t
 = 0;

204 ià(
phyaddr
 + 
Ëngth
 > 
sdev
->
nÜæash
.
size_šby‹s
) {

205 
	`shªnÚ_”r
("overflow NOR‡ddress!\n");

209 ià(
Ëngth
 == 0 || (0 !=†ength % 4)) {

210 
	`shªnÚ_”r
("Ëngth %d i šv®id!\n", 
Ëngth
);

214 ià(
	`shªnÚ_dev_is_g5
(
sdev
è&& (
phyaddr
 % 4096)) {

215 
	`shªnÚ_”r
("phyaddr is‚ot 4k‡ligned\n");

219 
£g
 = 0; seg < 
sdev
->
nÜæash
.
£gm’ts
; seg++)

221 ià(
phyaddr
 >ğ
sdev
->
nÜæash
.
£gm’t
[
£g
].
¡¬t_phyaddr
 &&…hyadd¸<ğsdev->nÜæash.£gm’t[£g].
’d_phyaddr
)

224 ià(
£g
 =ğ
sdev
->
nÜæash
.
£gm’ts
) {

225 
	`shªnÚ_”r
("ÿÂÙ fšd NOR segm’ˆtØwr™e,…hyaddr=0x%08x.\n", 
phyaddr
);

229 
blk_size
 = 
sdev
->
nÜæash
.
£gm’t
[
£g
].blk_size;

230 
»maš
 = 
Ëngth
;

231 
com¶‘e
 = 0;

232 
sdev
->
nÜæash
.
´og»ss
 = 0;

234 
buf
 = (
u32
*)
	`shªnÚ_kz®loc
(
sdev
->
nÜæash
.
buf_size
, 
GFP_SHANNON
);

235 ià(!
buf
) {

236 
	`shªnÚ_”r
("cannot‡lloc memory for‚or flash write.\n");

237  -
ENOMEM
;

240 
»maš
 > 0)

242 
xãr_size
 = 
»maš
 < 
sdev
->
nÜæash
.
buf_size
 ?„emain : sdev->norflash.buf_size;

243 ià((
phyaddr
 / 
blk_size
è!ğ(Õhyadd¸+ 
xãr_size
 - 1) / blk_size)) {

244 
	`shªnÚ_”r
("across block span!\n");

245 
»t
 = -1;

246 
çed
;

249 
	`shªnÚ_mem£t
(
buf
, 0xFF, 
xãr_size
);

250 
	`shªnÚ_memıy
(
buf
, 
d©a
 + 
com¶‘e
, 
xãr_size
);

251 ià(
sdev
->
nÜæash
.
´iv©e_št
)

252 
	`__u8_Ë2be
(
buf
, 
xãr_size
);

259 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

260 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

261 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

266  
i
 = 0; i < 
xãr_size
 / 4; i++) {

267 
	`shªnÚ_¿w_wr™–
(
buf
[
i
], (
u32
 *)
sdev
->
b¬
 + sdev->
nÜæash
.
buf_addr
 + i);

268 ià((
i
 % 8) == 7) {

269 ià(
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
) == 0x5a5a5a5a)

274 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

275 
	`shªnÚ_iÜ—d32
((
u32
*)
sdev
->
b¬
 + 
SH_NORFLASH_STATE_OFFSET
);

276 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

279 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

280 ià(
	`shªnÚ_nÜæash_wr™e_g5
(
sdev
, 
phyaddr
) < 0) {

281 
»t
 = -1;

282 
çed
;

285 ià(
	`shªnÚ_nÜæash_wr™e_g4
(
sdev
, 
phyaddr
) < 0) {

286 
»t
 = -1;

287 
çed
;

291 
	`shªnÚ_šfo
("wr™NOR fÏsh:…hyaddrğ0x%x, xãr_size=%d,„emašğ%d,†’gthğ%d\n", 
phyaddr
, 
xãr_size
, 
»maš
, 
Ëngth
);

292 
	`shªnÚ_m¦“p
(15);

295 
»maš
 -ğ
xãr_size
;

296 
com¶‘e
 +ğ
xãr_size
;

297 
sdev
->
nÜæash
.
´og»ss
 = (
Ëngth
 - 
»maš
) * 100 /†ength;

299 
phyaddr
 +ğ
xãr_size
;

301 ià(
phyaddr
 > 
sdev
->
nÜæash
.
£gm’t
[
£g
].
’d_phyaddr
) {

303 ià(++
£g
 >ğ
sdev
->
nÜæash
.
£gm’ts
)

305 
blk_size
 = 
sdev
->
nÜæash
.
£gm’t
[
£g
].blk_size;

309 
çed
:

310 
	`shªnÚ_kä“
(
buf
);

312  
»t
;

313 
	}
}

315 
	$shªnÚ_nÜæash_»ad
(
shªnÚ_dev
 *
sdev
, 
u32
 
phyaddr
, u32 
Ëngth
, *
d©a
)

317 
£g
;

318 
u32
 *
buf
 = 
NULL
;

319 
u32
 
blk_size
;

320 
u32
 
xãr_size
;

321 
»maš
;

322 
u32
 
com¶‘e
;

323 
i
 = 0, 
»t
 = 0;

326 ià(
phyaddr
 + 
Ëngth
 > 
sdev
->
nÜæash
.
size_šby‹s
) {

327 
	`shªnÚ_”r
("overflow NOR‡ddress!\n");

331 ià(
Ëngth
 == 0 || (0 !=†ength % 4)) {

332 
	`shªnÚ_”r
("Ëngth %d i šv®id!\n", 
phyaddr
);

336 ià(
	`shªnÚ_dev_is_g5
(
sdev
è&& (
phyaddr
 % 4096)) {

337 
	`shªnÚ_”r
("phyaddr is‚ot 4k‡ligned\n");

341 
£g
 = 0; seg < 
sdev
->
nÜæash
.
£gm’ts
; seg++)

343 ià(
phyaddr
 >ğ
sdev
->
nÜæash
.
£gm’t
[
£g
].
¡¬t_phyaddr
 &&…hyadd¸<ğsdev->nÜæash.£gm’t[£g].
’d_phyaddr
)

346 ià(
£g
 =ğ
sdev
->
nÜæash
.
£gm’ts
) {

347 
	`shªnÚ_”r
("ÿÂÙ fšd NOR segm’ˆtØ»ad,…hyaddr=0x%08x.\n", 
phyaddr
);

351 
blk_size
 = 
sdev
->
nÜæash
.
£gm’t
[
£g
].blk_size;

352 
»maš
 = 
Ëngth
;

353 
com¶‘e
 = 0;

354 
sdev
->
nÜæash
.
´og»ss
 = 0;

356 
buf
 = (
u32
*)
	`shªnÚ_kz®loc
(
sdev
->
nÜæash
.
buf_size
, 
GFP_SHANNON
);

357 ià(!
buf
) {

358 
	`shªnÚ_”r
("cannot‡lloc memory for‚or flash„ead.\n");

359  -
ENOMEM
;

362 
»maš
 > 0)

364 
xãr_size
 = 
»maš
 < 
sdev
->
nÜæash
.
buf_size
 ?„emain : sdev->norflash.buf_size;

365 ià((
phyaddr
 / 
blk_size
è!ğ(Õhyadd¸+ 
xãr_size
 - 1) / blk_size)) {

366 
	`shªnÚ_”r
("across block span!\n");

367 
»t
 = -1;

368 
çed
;

371 
	`shªnÚ_mem£t
(
buf
, 0xFF, 
xãr_size
);

373 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

374 ià(
	`shªnÚ_nÜæash_»ad_g5
(
sdev
, 
phyaddr
) < 0) {

375 
»t
 = -1;

376 
çed
;

379 ià(
	`shªnÚ_nÜæash_»ad_g4
(
sdev
, 
phyaddr
, 
xãr_size
) < 0) {

380 
»t
 = -1;

381 
çed
;

388 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

390  
i
 = 0; i < 
xãr_size
 / 4; i++)

391 
buf
[
i
] = 
	`shªnÚ_¿w_»adl
Ğ(
u32
 *)
sdev
->
b¬
 + sdev->
nÜæash
.
buf_addr
 + i);

393 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

395 ià(
sdev
->
nÜæash
.
´iv©e_št
)

396 
	`__u8_Ë2be
(
buf
, 
xãr_size
);

397 
	`shªnÚ_memıy
(
d©a
 + 
com¶‘e
, 
buf
, 
xãr_size
);

399 
	`shªnÚ_šfo
("»ad NOR fÏsh:…hyaddrğ0x%x, xãr_size=%d,„emašğ%d,†’gthğ%d\n", 
phyaddr
, 
xãr_size
, 
»maš
, 
Ëngth
);

400 
	`shªnÚ_m¦“p
(15);

403 
»maš
 -ğ
xãr_size
;

404 
com¶‘e
 +ğ
xãr_size
;

405 
sdev
->
nÜæash
.
´og»ss
 = (
Ëngth
 - 
»maš
) * 100 /†ength;

407 
phyaddr
 +ğ
xãr_size
;

409 ià(
phyaddr
 > 
sdev
->
nÜæash
.
£gm’t
[
£g
].
’d_phyaddr
) {

411 ià(++
£g
 >ğ
sdev
->
nÜæash
.
£gm’ts
)

413 
blk_size
 = 
sdev
->
nÜæash
.
£gm’t
[
£g
].blk_size;

417 
çed
:

418 
	`shªnÚ_kä“
(
buf
);

420  
»t
;

421 
	}
}

423 
	#NORFLASH_INFO_ADDR
 0X1FFF000

	)

425 
	$»ad_nÜæash_šfo
(
shªnÚ_dev
 *
sdev
)

427 
nÜæash_šfo
 
nÜ_buf
;

428 
u32
 
nÜæash_šfo_addr
;

430 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

431 
nÜæash_šfo_addr
 = 
sdev
->
nÜæash
.
pc›_phy_addr
 + 
NOR_PAGE_SIZE
 * 0xFF;

433 
nÜæash_šfo_addr
 = 
NORFLASH_INFO_ADDR
;

435 
	`shªnÚ_mem£t
(&
nÜ_buf
, 0x00, (
nÜæash_šfo
));

437 ià(
	`shªnÚ_nÜæash_»ad
(
sdev
, 
nÜæash_šfo_addr
, (
nÜæash_šfo
), &
nÜ_buf
)) {

438 
	`shªnÚ_”r
("failedo„ead NOR flash.\n");

439 
u£_deçuÉ
;

442 ià(
	`shªnÚ_mem_»adq
(&
nÜ_buf
.
magic_numb”
) != 0X646972656374696F)

444 
	`debugs1
("couldn't get valid serviceag from NOR flash.\n");

445 
u£_deçuÉ
;

448 
sdev
->
has_£rviû_g
 = 1;

449 
	`shªnÚ_memıy
(
sdev
->
£rviû_g
, 
nÜ_buf
.service_tag, 32);

450 
	`shªnÚ_memıy
(
sdev
->
mod–_id
, 
nÜ_buf
.model_id, 40);

453 
u£_deçuÉ
:

454 
sdev
->
has_£rviû_g
 = 0;

455 
	`shªnÚ_¢´štf
(
sdev
->
£rviû_g
, 20, "%16.16Îx", sdev->
dÇ
);

456 
	`shªnÚ_¢´štf
(
sdev
->
mod–_id
, 40, "Direct-IO PCIe Flash");

458 
	}
}

	@shannon_ns.c

1 
	~"shªnÚ.h
"

2 
	~"shªnÚ_ioùl.h
"

4 
shªnÚ_li¡_h—d
 
	gshªnÚ_poŞ_li¡
;

5 
	#MAX_POOL_COUNT
 26

	)

6 
	#SPOOL_MINORS
 16

	)

7 
	gpoŞ_b™m­
;

8 
shªnÚ_mu‹x_t
 
	gpoŞ_£m
;

9 
shªnÚ_memblock_´—Îoc
;

10 
shªnÚ_memblock_poŞ
 
m­_bË_poŞ
;

11 
shªnÚ_memblock_poŞ
 
‹mp_bË_poŞ
;

13 
put_»fcouÁ
(
shªnÚ_©omic_t
 *
»fcouÁ
, (*
»Ëa£
)(shªnÚ_©omic_ˆ*
k»f
))

15 
	`WARN_ON
(
»Ëa£
 =ğ
NULL
);

16 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(
»fcouÁ
))

17 
	`»Ëa£
(
»fcouÁ
);

18 
	}
}

20 
	$g‘_»fcouÁ
(
shªnÚ_©omic_t
 *
»fcouÁ
)

22 
	`WARN_ON
(!
	`shªnÚ_©omic_»ad
(
»fcouÁ
));

23 
	`shªnÚ_©omic_šc
(
»fcouÁ
);

24 
	}
}

26 
	$ä“_Çme¥aû
(
shªnÚ_©omic_t
 *
»fcouÁ
)

28 
shªnÚ_Çme¥aû
 *
ns
 = 
	`cÚš”_of
(
»fcouÁ
, shannon_namespace,„efcount);

30 
	`shªnÚ_šfo
("th»fcouÁ oàÇme¥aû %d deü—£Ø0.\n", 
ns
->
idx
);

31 
	`shªnÚ_m­_bË_ä“_ns
(&
ns
->
sdisk
);

32 ià(
ns
->
sdisk
.
queue
)

33 
	`shªnÚ_blk_ş—nup_queue
(
ns
->
sdisk
.
queue
);

34 
ns
->
sdisk
.
queue
 = 
NULL
;

35 
	`shªnÚ_kä“
(
ns
);

36 
	}
}

38 
shªnÚ_Çme¥aû
 *
	$ns_g‘_»ã»nû
(
shªnÚ_Çme¥aû
 *
ns
)

40 ià(!
ns
)

41  
NULL
;

42 
	`g‘_»fcouÁ
(&
ns
->
»fcouÁ
);

43 ià(
	`shªnÚ_©omic_»ad
(&
ns
->
»fcouÁ
) == 1) {

44 
	`put_»fcouÁ
(&
ns
->
»fcouÁ
, 
ä“_Çme¥aû
);

45  
NULL
;

47  
ns
;

48 
	}
}

50 
	$ns_put_»ã»nû
(
shªnÚ_Çme¥aû
 *
ns
)

52 
	`put_»fcouÁ
(&
ns
->
»fcouÁ
, 
ä“_Çme¥aû
);

53 
	}
}

55 
	$sh_šü—£_u£rs_ns
(
shªnÚ_Çme¥aû
 *
ns
)

57 
	`shªnÚ_©omic_šc
(&
ns
->
u£rs
);

58 
	`shªnÚ_b¬r›r
();

60 
	}
}

62 
	$sh_deü—£_u£rs_ns
(
shªnÚ_Çme¥aû
 *
ns
)

64 ià(
	`shªnÚ_©omic_dec_ªd_‹¡
(&
ns
->
u£rs
)) {

65 
	`shªnÚ_šfo
("thu£r oàÇme¥aû %d deü—£Ø0.\n", 
ns
->
idx
);

66 
	`put_»fcouÁ
(&
ns
->
»fcouÁ
, 
ä“_Çme¥aû
);

70 
	}
}

72 
shªnÚ_disÿrd_ns
(
shªnÚ_Çme¥aû
 *
ns
, 
logicb64_t
 
¡¬t_lba
,†ogicb64_ˆ
’d_lba
, 
d–_ns
);

73 
	$»Ëa£_Çme¥aû
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

75 
shªnÚ_ns_¬g
 *
ns_¬g
;

76 
shªnÚ_Çme¥aû
 *
ns
;

77 
idx
, 
»t
 = 0;

79 
ns_¬g
 = 
	`shªnÚ_kz®loc
((*ns_¬g), 
GFP_SHANNON
);

80 ià(
ns_¬g
 =ğ
NULL
) {

81 
	`shªnÚ_”r
("Alloc‚s_arg failed!\n");

82  -
ENOMEM
;

85 ià(
	`shªnÚ_cİy_äom_u£r
(
ns_¬g
, (
shªnÚ_ns_¬g
 * 
__u£r
)
¬g
,

86 (*
ns_¬g
))) {

87 
	`shªnÚ_”r
("Cannot get data from userspace.\n");

88 
»t
 = -
EFAULT
;

89 
out
;

91 
idx
 = 
ns_¬g
->
vŞ_idx
;

92 
ns
 = 
¥oŞ
->ns[
idx
];

94 
ns
 = 
	`ns_g‘_»ã»nû
(ns);

95 ià(
ns
)

96 
	`shªnÚ_disÿrd_ns
(
ns
, 0,‚s->
sdisk
.
£ùÜs
>>Òs->
logicb_shiá
-9), 1);

97 
	`ns_put_»ã»nû
(
ns
);

99 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

100 
ns
 = 
¥oŞ
->ns[
idx
];

101 ià(
ns
) {

102 ià(
ns
->
sdisk
.
gd
) {

103 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

104 
	`shªnÚ_”r
("ns->sdisk.gd is‚ot NULL!\n");

105 
»t
 = -
EBUSY
;

106 
out
;

108 ià(
ns
->
sdisk
.
´iÜ™y
 == 1) {

109 
	`shªnÚ_©omic_dec
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
);

110 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) == 0)

111 
	`£t_poŞ_h¬d_queue_lim™
(
¥oŞ
, 0);

113 
¥oŞ
->
ns
[
idx
] = 
NULL
;

114 
	`shªnÚ_b¬r›r
();

115 
	`sh_deü—£_u£rs_ns
(
ns
);

117 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

118 
	`shªnÚ_ş—r_b™
(
idx
, &
¥oŞ
->
poŞ_šfo
->
ns_b™m­
);

119 
	`shªnÚ_©omic_dec
(&
¥oŞ
->
ns_couÁ
);

120 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

121 
	`upd©e_poŞ_šfo
(
¥oŞ
);

123 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

124 
out
:

125 
	`shªnÚ_kä“
(
ns_¬g
);

126  
»t
;

127 
	}
}

130 
	$ns_š™Ÿlize_v¬ŸbËs
(
shªnÚ_Çme¥aû
 *
ns
)

132 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

133 
i
, 
j
;

135 
ns
->
d©a_pba
.
lun_pba
 = 0x03ffffff;

136 
ns
->
d©a
 = &ns->
poŞ
->
ns_d©a
[ns->
idx
];

137 
	`shªnÚ_š™_wa™queue_h—d
(&
ns
->
upd©e_ns_d©a_dÚe_ev’t
);

138 
	`shªnÚ_mem£t
(
ns
->
d©a
, 0, (*(ns->data)));

139 
	`shªnÚ_©omic_£t
(&
ns
->
ios
, 0);

140 
	`shªnÚ_mu‹x_š™
(&
ns
->
thrÙe_ios_£m
);

141 
	`shªnÚ_©omic_£t
(&
ns
->
sdisk
.
³ndšg_bios
, 0);

142 
ns
->
sdisk
.
©ched
 = 
SHN_DISK_DETACHED
;

144 
	`shªnÚ_¥š_lock_š™
(&
sdisk
->
»cÜd_Ï‹ncy_lock
);

145 
	`shªnÚ_¥š_lock_š™
(&
ns
->
d©a_lock
);

146 
sdisk
->
´št_Ï‹ncy_š‹rv®
 = 0;

147 
	`shªnÚ_š™_tim”
(&
sdisk
->
´št_Ï‹ncy_tim”
);

148 
	`shªnÚ_£t_tim”_cÚ‹xt
(&
sdisk
->
´št_Ï‹ncy_tim”
, 
ns_´št_Ï‹ncy_funùiÚ
);

149 
i
 = 0; i < 2; i++) {

150 
j
 = 0; j < 
RMW_LIST_COUNT
; j++) {

151 
	`shªnÚ_¥š_lock_š™
(&
sdisk
->
rmw_li¡_lock
[
i
][
j
]);

152 
	`SHANNON_INIT_LIST_HEAD
(&
sdisk
->
rmw_li¡
[
i
][
j
]);

155 
	}
}

159 
shªnÚ_Çme¥aû
 *
	$®loc_Çme¥aû
()

161 
shªnÚ_Çme¥aû
 *
ns
;

163 
ns
 = 
	`shªnÚ_kz®loc
((
shªnÚ_Çme¥aû
), 
GFP_SHANNON
);

164 ià(
ns
 =ğ
NULL
) {

165 
	`shªnÚ_”r
("Cannot‡lloc‚amespace.\n");

166  
NULL
;

168  
ns
;

169 
	}
}

172 
	$š™_Úe_Çme¥aû
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_ns_¬g
 *
ns_¬g
)

174 
	`ns_š™Ÿlize_v¬ŸbËs
(
ns
);

176 
ns
->
logicb_shiá
 = 
NS_LOGICB_SHIFT
;

177 
ns
->
logicb_size
 = 1UL <<‚s->
logicb_shiá
;

178 ià((
ns_¬g
->
block_shiá
 >= 9) && (ns_arg->block_shift <= 12))

179 
ns
->
u£r_logicb_shiá
 = 
ns_¬g
->
block_shiá
;

181 
ns
->
u£r_logicb_shiá
 =‚s->
logicb_shiá
;

182 
ns
->
u£r_logicb_size
 = 1 <<‚s->
u£r_logicb_shiá
;

183 
ns
->
¡r_size_shiá
 = 
NS_STRIP_SIZE_SHIFT
;

184 
ns
->
¡r_size
 = 1 << 
NS_STRIP_SIZE_SHIFT
;

185 
ns
->
max_iİs
 = 
ns_¬g
->max_iops;

186 
ns
->
sdisk
.
´iÜ™y
 = 
ns_¬g
->priority;

188 
	`shªnÚ_¢´štf
(
ns
->
sdisk
.
disk_Çme
, 16, "p%uvŞ%u",‚s->
poŞ
->
id
,‚s->
idx
);

189 
ns
->
majÜ
 =‚s->
poŞ
->major;

191 ià(
	`shªnÚ_®loc_m­_bË_ns
(&
ns
->
sdisk
, 
ns_¬g
->
£ùÜs
,‚s->
logicb_shiá
,‚s->
poŞ
->
sdev_couÁ
,‚s->
¡r_size_shiá
) < 0) {

192 
	`shªnÚ_”r
("Cannot‡lloc map_table for‚amespace.\n");

193  -
ENOMEM
;

195 
ns
->
sdisk
.
£ùÜs
 = 
ns_¬g
->sectors;

196 
	`shªnÚ_©omic_£t
(&
ns
->
u£rs
, 1);

197 
	`shªnÚ_©omic_£t
(&
ns
->
»fcouÁ
, 1);

200 
	}
}

203 
	$š™_Çme¥aûs
(
shªnÚ_poŞ
 *
¥oŞ
)

205 
shªnÚ_ns_¬g
 *
ns_¬g
;

206 
shªnÚ_poŞ_šfo
 *
poŞ_šfo
;

207 
shªnÚ_Çme¥aû
 *
ns
;

208 
idx
, 
»t
 = 0;

210 
ns_¬g
 = 
	`shªnÚ_kz®loc
((*ns_¬g), 
GFP_SHANNON
);

211 ià(
ns_¬g
 =ğ
NULL
) {

212 
	`shªnÚ_”r
("Alloc‚s_arg failed!\n");

213  -
ENOMEM
;

216 ià(
shªnÚ_memblock_´—Îoc
 == 0) {

217 
	`shªnÚ_memblock_poŞ_šc_maxt
(&
m­_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

218 
	`shªnÚ_memblock_poŞ_add
(&
m­_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

220 
	`shªnÚ_memblock_poŞ_šc_maxt
(&
‹mp_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

221 
	`shªnÚ_memblock_poŞ_add
(&
‹mp_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

222 } ià(
shªnÚ_memblock_´—Îoc
 > 0) {

223 
	`shªnÚ_queue_wÜk
(
m­_bË_poŞ
.
memblock_wq
, &m­_bË_poŞ.
®loc_wÜk
);

224 
	`shªnÚ_queue_wÜk
(
‹mp_bË_poŞ
.
memblock_wq
, &‹mp_bË_poŞ.
®loc_wÜk
);

227 
poŞ_šfo
 = 
¥oŞ
->pool_info;

228 
idx
 = 0; idx < 
SHANNON_NS_NUM
; idx++) {

229 ià(!
	`shªnÚ_‹¡_b™
(
idx
, (*)
poŞ_šfo
->
ns_b™m­
))

231 
	`shªnÚ_©omic_šc
(&
¥oŞ
->
ns_couÁ
);

232 
ns_¬g
->
poŞ_id
 = 
¥oŞ
->
id
;

233 
ns_¬g
->
vŞ_idx
 = 
idx
;

234 
ns_¬g
->
max_iİs
 = 
	`ns_©Œi1_max_iİs
(
poŞ_šfo
->
ns_©Œi1
[
idx
]);

235 
ns_¬g
->
£ùÜs
 = 
	`ns_©Œi1_£ùÜs
(
poŞ_šfo
->
ns_©Œi1
[
idx
]);

236 
ns_¬g
->
´iÜ™y
 = 
	`ns_©Œi2_´iÜ™y
(
poŞ_šfo
->
ns_©Œi2
[
idx
]);

237 
ns_¬g
->
£q_num
 = 
	`ns_©Œi2_£q_num
(
poŞ_šfo
->
ns_©Œi2
[
idx
]);

238 
ns_¬g
->
block_shiá
 = 
	`ns_©Œi2_blockshiá
(
poŞ_šfo
->
ns_©Œi2
[
idx
]);

240 
ns
 = 
	`®loc_Çme¥aû
();

241 ià(
ns
 =ğ
NULL
) {

242 
	`shªnÚ_”r
("alloc_namespace failed.\n");

245 
ns
->
idx
 = 
ns_¬g
->
vŞ_idx
;

246 
ns
->
£q_num
 = 
ns_¬g
->seq_num;

247 
ns
->
poŞ
 = 
¥oŞ
;

248 ià(
	`š™_Úe_Çme¥aû
(
ns
, 
ns_¬g
) < 0) {

249 
	`shªnÚ_kä“
(
ns
);

250 
»t
 = -
ENOMEM
;

253 
¥oŞ
->
ns
[ns->
idx
] =‚s;

256 
	`shªnÚ_kä“
(
ns_¬g
);

258 
	}
}

261 
	$ü—‹_Çme¥aû
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

263 
shªnÚ_dev
 *
sdev
;

264 
shªnÚ_ns_¬g
 *
ns_¬g
;

265 
shªnÚ_Çme¥aû
 *
ns
;

266 
»t
 = 0, 
i
;

268 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
ns_couÁ
è>ğ
SHANNON_NS_NUM
) {

269 
	`shªnÚ_”r
("we have %d‚amespaces, cannot create‡‚ew one.\n",

270 
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
ns_couÁ
));

271  -
EFAULT
;

274 
ns_¬g
 = 
	`shªnÚ_kz®loc
((*ns_¬g), 
GFP_SHANNON
);

275 ià(
ns_¬g
 =ğ
NULL
) {

276 
	`shªnÚ_”r
("Alloc‚s_arg failed!\n");

277  -
ENOMEM
;

280 ià(
	`shªnÚ_cİy_äom_u£r
(
ns_¬g
, (
shªnÚ_ns_¬g
 * 
__u£r
)
¬g
,

281 (*
ns_¬g
))) {

282 
	`shªnÚ_”r
("Cannot get data from userspace.\n");

283 
»t
 = -
EFAULT
;

284 
out
;

288 ià((
ns_¬g
->
£ùÜs
 <ğ0è|| (ns_¬g->
£q_num
 != 0) || \

289 (
ns_¬g
->
´iÜ™y
 < 0è|| (ns_¬g->´iÜ™y >ğ
PRIORITY_LEVELS
)) {

290 
	`shªnÚ_w¬n
("Wrong‡rguments: sectors=%d, seq_num=%d,…riority=%d.\n",

291 
ns_¬g
->
£ùÜs
,‚s_¬g->
£q_num
,‚s_¬g->
´iÜ™y
);

292 
»t
 = -
EINVAL
;

293 
out
;

296 
ns
 = 
	`®loc_Çme¥aû
();

297 ià(
ns
 =ğ
NULL
) {

298 
	`shªnÚ_”r
("Cannot‡llocate memory for‚amespace.\n");

299 
»t
 = -
ENOMEM
;

300 
out
;

303 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

305 ià(
ns_¬g
->
vŞ_idx
 < 0) {

306 
ns
->
idx
 = 
	`shªnÚ_fšd_fœ¡_z”o_b™
((*)
¥oŞ
->
poŞ_šfo
->
ns_b™m­
,

307 
SHANNON_NS_NUM
);

311 
ns
->
idx
 = 
ns_¬g
->
vŞ_idx
;

312 ià(
ns
->
idx
 < 
SHANNON_NS_NUM


313 && 
	`shªnÚ_‹¡_b™
(
ns
->
idx
, (*)
¥oŞ
->
poŞ_šfo
->
ns_b™m­
)) {

314 
	`shªnÚ_w¬n
("Name¥aû #%dƒxi¡s.\n", 
ns
->
idx
);

315 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

316 
	`sh_deü—£_u£rs_ns
(
ns
);

317 
»t
 = -
EEXIST
;

318 
out
;

321 ià(
ns
->
idx
 >ğ
SHANNON_NS_NUM
) {

322 
	`shªnÚ_”r
("Úly suµÜˆ%d‚ame¥aûs.\n", 
SHANNON_NS_NUM
);

323 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

324 
	`sh_deü—£_u£rs_ns
(
ns
);

325 
»t
 = -
EFAULT
;

326 
out
;

328 
	`shªnÚ_£t_b™
(
ns
->
idx
, 
¥oŞ
->
poŞ_šfo
->
ns_b™m­
);

330 
	`shªnÚ_©omic_šc
(&
¥oŞ
->
ns_couÁ
);

332 
¥oŞ
->
poŞ_šfo
->
cur_ns_£q_num
++;

333 
¥oŞ
->
poŞ_šfo
->
cur_ns_£q_num
 &ğ
NS_SEQ_NUM_MASK
;

334 ià(
¥oŞ
->
poŞ_šfo
->
cur_ns_£q_num
 == 0)

335 
¥oŞ
->
poŞ_šfo
->
cur_ns_£q_num
 = 1;

336 
ns
->
£q_num
 = 
¥oŞ
->
poŞ_šfo
->
cur_ns_£q_num
;

337 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

339 
ns
->
poŞ
 = 
¥oŞ
;

340 ià(
	`š™_Úe_Çme¥aû
(
ns
, 
ns_¬g
) < 0) {

341 
»t
 = -
ENOMEM
;

342 
š™_çed
;

345 ià(
ns_¬g
->
d©a
 !ğ
NULL
) {

346 
ns_·th_Ën
 = (
ns
->
d©a
->
Çme
);

347 *
Çme
;

348 
»t
 = 
	`shªnÚ_cİy_äom_u£r
(
ns
->
d©a
, (
shªnÚ_ns_d©a
 *
__u£r
)
ns_¬g
->data,

349 (*(
ns
->
d©a
)));

350 ià(
»t
) {

351 
	`shªnÚ_”r
("Cannot copy data from userspace.\n");

352 
»t
 = -
EFAULT
;

353 
Çme_”rÜ
;

355 
Çme
 = 
ns
->
d©a
->name;

357 ià(
	`shªnÚ_¡ºËn
(
Çme
, 
ns_·th_Ën
) ==‚s_path_len) {

358 
	`shªnÚ_”r
("Volume…athoo†ong\n");

359 
»t
 = -
EINVAL
;

360 
Çme_”rÜ
;

362 ià(
	`shªnÚ_¡¾’
(
Çme
) != 0) {

363 
shªnÚ_poŞ
 *
p
;

364 
	`shªnÚ_mu‹x_lock
(&
poŞ_£m
);

365 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
shªnÚ_poŞ_li¡
, 
li¡
) {

366 ià(
p
->
id
 !ğ
¥oŞ
->id)

367 
	`shªnÚ_mu‹x_lock
(&
p
->
¡©e_£m
);

368 ià(
p
->
ns
) {

369 
i
;

370 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

371 
shªnÚ_Çme¥aû
 *
n
 = 
p
->
ns
[
i
];

372 ià(!
n
)

374 ià(!
	`¡rcmp
(
Çme
, 
n
->
d©a
->name)) {

375 
	`shªnÚ_”r
("%s‡lso has‚ame %s\n",

376 
n
->
sdisk
.
disk_Çme
,

377 
Çme
);

378 ià(
p
->
id
 !ğ
¥oŞ
->id)

379 
	`shªnÚ_mu‹x_uÆock
(&
p
->
¡©e_£m
);

380 
	`shªnÚ_mu‹x_uÆock
(&
poŞ_£m
);

381 
»t
 = -
EEXIST
;

382 
Çme_”rÜ
;

386 ià(
p
->
id
 !ğ
¥oŞ
->id)

387 
	`shªnÚ_mu‹x_uÆock
(&
p
->
¡©e_£m
);

389 
	`shªnÚ_mu‹x_uÆock
(&
poŞ_£m
);

390 
	`upd©e_ns_d©a
(
ns
);

393 
¥oŞ
->
ns
[ns->
idx
] =‚s;

394 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

395 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

396 ià(
sdev
)

397 
	`shªnÚ_m­_bË_’abË
(&
ns
->
sdisk
.
Ímt_¬¿y
[
i
]);

400 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

401 
¥oŞ
->
poŞ_šfo
->
ns_©Œi1
[
ns
->
idx
] = 
	`make_ns_©Œi1
Òs->
sdisk
.
£ùÜs
,‚s->
max_iİs
);

402 
¥oŞ
->
poŞ_šfo
->
ns_©Œi2
[
ns
->
idx
] = 
	`make_ns_©Œi2
Òs->
sdisk
.
´iÜ™y
,‚s->
£q_num
,‚s->
u£r_logicb_shiá
);

403 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

404 
	`upd©e_poŞ_šfo
(
¥oŞ
);

406 
»t
 = 
	`shªnÚ_©ch_ns
(
¥oŞ
->
ns
[ns->
idx
]);

408 
ns_¬g
->
vŞ_idx
 = 
ns
->
idx
;

409 
ns_¬g
->
£q_num
 = 
ns
->seq_num;

410 ià(
ns_¬g
->
´iÜ™y
 == 1) {

411 
	`shªnÚ_©omic_šc
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
);

412 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) == 1)

413 
	`£t_poŞ_h¬d_queue_lim™
(
¥oŞ
, 32);

415 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_ns_¬g
 * 
__u£r
)
¬g
,

416 
ns_¬g
, (*ns_arg))) {

417 
	`shªnÚ_”r
("Cannot copy datao userspace.\n");

418  -
EFAULT
;

421 
out
;

422 
Çme_”rÜ
:

423 
	`shªnÚ_m­_bË_ä“_ns
(&
ns
->
sdisk
);

424 
š™_çed
:

426 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

427 
	`shªnÚ_ş—r_b™
(
ns
->
idx
, &
¥oŞ
->
poŞ_šfo
->
ns_b™m­
);

428 
	`shªnÚ_©omic_dec
(&
¥oŞ
->
ns_couÁ
);

429 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

430 
	`shªnÚ_kä“
(
ns
);

432 
out
:

433 
	`shªnÚ_kä“
(
ns_¬g
);

434  
»t
;

435 
	}
}

437 
	$shªnÚ_ioùl_£t_ns
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

439 
shªnÚ_ns_¬g
 *
ns_¬g
;

440 
shªnÚ_Çme¥aû
 *
ns
;

441 
u32
 
Şd_max_iİs
;

442 
u16
 
Şd_´iÜ™y
;

443 
u64
 
Şd_£ùÜs
;

444 
»t
 = 0;

445 
idx
;

447 
ns_¬g
 = 
	`shªnÚ_kz®loc
((*ns_¬g), 
GFP_SHANNON
);

448 ià(
ns_¬g
 =ğ
NULL
) {

449 
	`shªnÚ_”r
("Alloc‚s_arg failed!\n");

450  -
ENOMEM
;

453 ià(
	`shªnÚ_cİy_äom_u£r
(
ns_¬g
, (
shªnÚ_ns_¬g
 * 
__u£r
)
¬g
,

454 (*
ns_¬g
))) {

455 
	`shªnÚ_”r
("Cannot get data from userspace.\n");

456 
»t
 = -
EFAULT
;

457 
out
;

461 ià(((
ns_¬g
->
£‰šg
 & 
SET_SECTORS_MASK
è&& (ns_¬g->
£ùÜs
 <ğ0)è|| (ns_¬g->
£q_num
 != 0) || \

462 ((
ns_¬g
->
£‰šg
 & 
SET_PRIORITY_MASK
è&& (Òs_¬g->
´iÜ™y
 < 0è|| (ns_¬g->´iÜ™y >ğ
PRIORITY_LEVELS
)))) {

463 
	`shªnÚ_w¬n
("Wrong‡rguments: sectors=%d, seq_num=%d,…riority=%d.\n",

464 
ns_¬g
->
£ùÜs
,‚s_¬g->
£q_num
,‚s_¬g->
´iÜ™y
);

465 
»t
 = -
EINVAL
;

466 
out
;

469 
idx
 = 
ns_¬g
->
vŞ_idx
;

470 
ns
 = 
¥oŞ
->ns[
idx
];

471 ià((
idx
 >ğ
SHANNON_NS_NUM
è|| (
ns
 =ğ
NULL
)) {

472 
	`shªnÚ_”r
("Çme¥aû %d dØnÙƒxi¡.\n", 
idx
);

473 
»t
 = -
EFAULT
;

474 
out
;

476 
Şd_max_iİs
 = 
ns
->
max_iİs
;

477 
Şd_´iÜ™y
 = 
ns
->
sdisk
.
´iÜ™y
;

478 
Şd_£ùÜs
 = 
ns
->
sdisk
.
£ùÜs
;

480 ià(
ns_¬g
->
£‰šg
 & 
SET_MAX_IOPS_MASK
)

481 
ns
->
max_iİs
 = 
ns_¬g
->max_iops;

483 ià(
ns_¬g
->
£‰šg
 & 
SET_PRIORITY_MASK
)

484 
ns
->
sdisk
.
´iÜ™y
 = 
ns_¬g
->priority;

486 ià(
ns_¬g
->
£‰šg
 & 
SET_SECTORS_MASK
) {

487 ià(
ns_¬g
->
£ùÜs
 > 
ns
->
sdisk
.sectors) {

488 ià((
»t
 = 
	`shªnÚ_m­_bË_»size
(&
ns
->
sdisk
, 
ns_¬g
->
£ùÜs
,‚s->
logicb_shiá
)) < 0) {

489 
	`shªnÚ_”r
("Cannot„esize map_table for‚amespace.\n");

490 
»t
 = -
ENOMEM
;

491 
£t_çed
;

493 
ns
->
sdisk
.
£ùÜs
 = 
ns_¬g
->sectors;

494 ià(
ns
->
sdisk
.
gd
)

495 
	`shªnÚ_£t_ÿ·c™y
(
ns
->
sdisk
.
gd
,‚s->sdisk.
£ùÜs
);

497 
	`shªnÚ_”r
("%s:‚ame¥aû %d¬g‘ seùÜ mu¡ bÏrgthª cu¼’ˆ£ùÜs.\n", 
__func__
, 
idx
);

498 
»t
 = -
EINVAL
;

499 
£t_çed
;

502 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

503 
¥oŞ
->
poŞ_šfo
->
ns_©Œi1
[
ns
->
idx
] = 
	`make_ns_©Œi1
Òs->
sdisk
.
£ùÜs
,‚s->
max_iİs
);

504 
¥oŞ
->
poŞ_šfo
->
ns_©Œi2
[
ns
->
idx
] = 
	`make_ns_©Œi2
Òs->
sdisk
.
´iÜ™y
,‚s->
£q_num
,‚s->
u£r_logicb_shiá
);

505 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

506 
	`upd©e_poŞ_šfo
(
¥oŞ
);

509 ià(
Şd_´iÜ™y
 =ğ0 && 
ns
->
sdisk
.
´iÜ™y
 == 1) {

510 
	`shªnÚ_©omic_šc
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
);

511 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) == 1)

512 
	`£t_poŞ_h¬d_queue_lim™
(
¥oŞ
, 32);

513 } ià(
Şd_´iÜ™y
 =ğ1 && 
ns
->
sdisk
.
´iÜ™y
 == 0) {

514 
	`shªnÚ_©omic_dec
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
);

515 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) == 0)

516 
	`£t_poŞ_h¬d_queue_lim™
(
¥oŞ
, 0);

518 
	`shªnÚ_kä“
(
ns_¬g
);

521 
£t_çed
:

522 
ns
->
max_iİs
 = 
Şd_max_iİs
;

523 
ns
->
sdisk
.
´iÜ™y
 = 
Şd_´iÜ™y
;

524 
ns
->
sdisk
.
£ùÜs
 = 
Şd_£ùÜs
;

525 
out
:

526 
	`shªnÚ_kä“
(
ns_¬g
);

527  
»t
;

528 
	}
}

530 
	$shªnÚ_©ch_ns
(
shªnÚ_Çme¥aû
 *
ns
)

532 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

534 ià(
sdisk
->
gd
) {

535 
	`shªnÚ_”r
("g’disk /dev/% ®»adyƒxi¡s.\n", 
sdisk
->
disk_Çme
);

536  -
EEXIST
;

538 
sdisk
->
gd
 = 
	`shªnÚ_®loc_disk
(
SHANNON_NS_NUM
);

539 ià(!
sdisk
->
gd
) {

540 
	`shªnÚ_”r
("%s:‡Îoc_disk faed.\n", 
sdisk
->
disk_Çme
);

541  -
ENOMEM
;

543 ià(
ns
->
poŞ
->
acûss_mode
 =ğ
SHN_MODE_READONLY
)

544 
	`shªnÚ_£t_disk_ro
(
sdisk
->
gd
, 1);

547 
sdisk
->
queue
 = 
	`shªnÚ_ü—‹_blkqueue
(
ns
, &sdisk->
queue_lock
, 1);

548 ià(!
sdisk
->
queue
) {

549 
	`shªnÚ_”r
("create_blkqueue failed!\n");

550 
	`shªnÚ_put_disk
(
sdisk
->
gd
);

551  -
ENOMEM
;

553 
	`shªnÚ_Œim_£‰šg
(
sdisk
->
queue
);

554 
	`shªnÚ_rÙ©iÚ®_£‰šg
(
sdisk
->
queue
);

555 
	`shªnÚ_blk_queue_max_hw_£ùÜs
(
sdisk
->
queue
, 
SHN_BLK_DEF_MAX_SECTORS
);

556 
	`shªnÚ_blk_queue_block_size
(
sdisk
->
queue
, 
ns
->
u£r_logicb_size
,‚s->
logicb_size
);

557 
	`shªnÚ_blk_queue_io_mš
(
sdisk
->
queue
, 
ns
->
logicb_size
);

558 
	`shªnÚ_blk_queue_io_İt
(
sdisk
->
queue
, 
ns
->
logicb_size
 *‚s->
¡r_size
);

559 
	`shªnÚ_š™_g’disk
(
sdisk
->
gd
, sdisk->
disk_Çme
, 
ns
->
majÜ
, 
SPOOL_MINORS
,

560 
ns
->
idx
 * 
SPOOL_MINORS
, 
sdisk
->
queue
,‚s);

561 
	`shªnÚ_£t_ÿ·c™y
(
sdisk
->
gd
, sdisk->
£ùÜs
);

562 
sdisk
->
©ched
 = 
SHN_DISK_INATTACH
;

563 
	`shªnÚ_add_disk
(
sdisk
->
gd
);

564 ià(
ns
->
poŞ
->
sysfs_š™_dÚe
 == 0)

565 
	`shªnÚ_”r
("%s: cannot‡dd kobjecto sysfs,…ool sysfs init failed.\n",

566 
ns
->
sdisk
.
disk_Çme
);

567 ià(
	`shªnÚ_sysfs_š™_ns
(&
ns
->
sysfs_kobj
)) {

568 
	`shªnÚ_”r
("%s:‡dd kobjeùØsysf çed.\n", 
ns
->
sdisk
.
disk_Çme
);

570 
	`debugs1
("%s: sysf objeù in™ dÚe.\n", 
ns
->
sdisk
.
disk_Çme
);

571 
ns
->
sysfs_š™_dÚe
 = 1;

574 
sdisk
->
©ched
 = 
SHN_DISK_ATTACHED
;

575 
	`shªnÚ_šfo
("A‰ached‚ame¥aû %s\n", 
sdisk
->
disk_Çme
);

578 
	}
}

580 
	$shªnÚ_ioùl_©ch_ns
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

582 
shªnÚ_ns_¬g
 *
ns_¬g
;

583 
shªnÚ_Çme¥aû
 *
ns
;

584 
idx
, 
»t
 = 0;

586 
ns_¬g
 = 
	`shªnÚ_kz®loc
((*ns_¬g), 
GFP_SHANNON
);

587 ià(
ns_¬g
 =ğ
NULL
)

588  -
ENOMEM
;

590 ià(
	`shªnÚ_cİy_äom_u£r
(
ns_¬g
, (
shªnÚ_ns_¬g
 * 
__u£r
)
¬g
,

591 (*
ns_¬g
))) {

592 
	`shªnÚ_”r
("Cannot get data from userspace.\n");

593 
»t
 = -
EFAULT
;

594 
out
;

596 
idx
 = 
ns_¬g
->
vŞ_idx
;

597 
ns
 = 
¥oŞ
->ns[
idx
];

598 ià((
idx
 >ğ
SHANNON_NS_NUM
è|| (
ns
 =ğ
NULL
)) {

599 
	`shªnÚ_”r
("Çme¥aû %d dØnÙƒxi¡.\n", 
idx
);

600 
»t
 = -
EFAULT
;

601 
out
;

603 
»t
 = 
	`shªnÚ_©ch_ns
(
ns
);

605 
out
:

606 
	`shªnÚ_kä“
(
ns_¬g
);

607  
»t
;

608 
	}
}

610 
	$shªnÚ_d‘ach_ns
(
shªnÚ_Çme¥aû
 *
ns
)

612 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

613 
sdisk
->
©ched
 = 
SHN_DISK_DETACHED
;

614 
	`¡İ_´št_Ï‹ncy_tim”
(
sdisk
);

615 ià(
sdisk
->
gd
) {

616 ià(
ns
->
sysfs_š™_dÚe
) {

617 
ns
->
sysfs_š™_dÚe
 = 0;

618 
	`shªnÚ_sysfs_ex™_ns
(&
ns
->
sysfs_kobj
);

620 
ns
->
ho¡_wr™e_£ùÜs_hi¡Üy
 +ğ
	`shªnÚ_wr™e_£ùÜs
(
sdisk
->
gd
);

621 
ns
->
ho¡_»ad_£ùÜs_hi¡Üy
 +ğ
	`shªnÚ_»ad_£ùÜs
(
sdisk
->
gd
);

622 
	`shªnÚ_d–_g’disk
(
sdisk
->
gd
);

623 
	`shªnÚ_put_disk
(
sdisk
->
gd
);

624 
	`shªnÚ_šfo
("D‘ached Dœeù-IO PCIFÏsh deviû % äom OS.\n", 
sdisk
->
disk_Çme
);

625 
sdisk
->
gd
 = 
NULL
;

627 ià(
sdisk
->
queue
) {

628 
	`shªnÚ_blk_ş—nup_queue
(
sdisk
->
queue
);

629 
sdisk
->
queue
 = 
NULL
;

631 
	}
}

634 
	$shªnÚ_ioùl_d‘ach_ns
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

636 
shªnÚ_ns_¬g
 *
ns_¬g
;

637 
shªnÚ_Çme¥aû
 *
ns
;

638 
idx
, 
»t
 = 0;

639 
Şd_©ched
 = 0;

641 
ns_¬g
 = 
	`shªnÚ_kz®loc
((*ns_¬g), 
GFP_SHANNON
);

642 ià(
ns_¬g
 =ğ
NULL
) {

643 
	`shªnÚ_”r
("Alloc‚s_arg failed!\n");

644  -
ENOMEM
;

647 ià(
	`shªnÚ_cİy_äom_u£r
(
ns_¬g
, (
shªnÚ_ns_¬g
 * 
__u£r
)
¬g
,

648 (*
ns_¬g
))) {

649 
	`shªnÚ_”r
("Cannot get data from userspace.\n");

650 
»t
 = -
EFAULT
;

651 
out
;

653 
idx
 = 
ns_¬g
->
vŞ_idx
;

654 
ns
 = 
¥oŞ
->ns[
idx
];

655 ià((
idx
 >ğ
SHANNON_NS_NUM
è|| (
ns
 =ğ
NULL
)) {

656 
	`shªnÚ_”r
("Çme¥aû %d dØnÙƒxi¡.\n", 
idx
);

657 
»t
 = -
EFAULT
;

658 
out
;

660 ià((
	`shªnÚ_©omic_»ad
(&
ns
->
u£rs
è> 1è|| 
	`shªnÚ_bio_š_æight_ns
(ns)) {

661 
	`shªnÚ_”r
("ns->users=%d, bio_in_flight_ns=%d.\n",

662 
	`shªnÚ_©omic_»ad
(&
ns
->
u£rs
),

663 
	`shªnÚ_bio_š_æight_ns
(
ns
));

664 
»t
 = -
EBUSY
;

665 
out
;

667 
Şd_©ched
 = 
ns
->
sdisk
.
©ched
;

668 
ns
->
sdisk
.
©ched
 = 
SHN_DISK_DETACHED
;

669 
	`shªnÚ_b¬r›r
();

670 ià((
	`shªnÚ_©omic_»ad
(&
ns
->
u£rs
è> 1è|| 
	`shªnÚ_bio_š_æight_ns
(ns)) {

671 
	`shªnÚ_”r
("ns->users=%d, bio_in_flight_ns=%d.\n",

672 
	`shªnÚ_©omic_»ad
(&
ns
->
u£rs
),

673 
	`shªnÚ_bio_š_æight_ns
(
ns
));

674 
»t
 = -
EBUSY
;

675 
ns
->
sdisk
.
©ched
 = 
Şd_©ched
;

676 
out
;

679 
	`shªnÚ_d‘ach_ns
(
ns
);

681 
out
:

682 
	`shªnÚ_kä“
(
ns_¬g
);

683  
»t
;

684 
	}
}

686 
	$shªnÚ_ioùl_g‘_ns_¡©us
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

688 
shªnÚ_ns_¡©us
 *
ns_¡©us
;

689 
shªnÚ_Çme¥aû
 *
ns
;

690 
»t
 = 0;

692 
ns_¡©us
 = 
	`shªnÚ_kz®loc
((*ns_¡©us), 
GFP_SHANNON
);

693 ià(
ns_¡©us
 =ğ
NULL
) {

694 
	`shªnÚ_”r
("Cannot‡llocate volume status.\n");

695  -
ENOMEM
;

697 ià(
	`shªnÚ_cİy_äom_u£r
(
ns_¡©us
, (
shªnÚ_ns_¡©us
 * 
__u£r
)
¬g
,

698 (*
ns_¡©us
))) {

699 
	`shªnÚ_”r
("Cannot get data from userspace.\n");

700 
»t
 = -
EFAULT
;

701 
out
;

703 
ns
 = 
¥oŞ
->ns[
ns_¡©us
->
idx
];

704 ià((
ns_¡©us
->
idx
 >ğ
SHANNON_NS_NUM
è|| (
ns
 =ğ
NULL
)) {

705 
	`shªnÚ_”r
("Çme¥aû %d dØnÙƒxi¡.\n", 
ns_¡©us
->
idx
);

706 
»t
 = -
EFAULT
;

707 
out
;

710 
ns_¡©us
->
poŞ_id
 = 
¥oŞ
->
id
;

711 
ns_¡©us
->
max_iİs
 = 
ns
->max_iops;

712 
ns_¡©us
->
´iÜ™y
 = 
ns
->
sdisk
.priority;

713 
ns_¡©us
->
£ùÜs
 = 
ns
->
sdisk
.sectors;

714 
ns_¡©us
->
£q_num
 = 
ns
->seq_num;

715 
ns_¡©us
->
block_shiá
 = 
ns
->
u£r_logicb_shiá
;

716 
ns_¡©us
->
¡r_size
 = 
ns
->strip_size;

717 
ns_¡©us
->
v®id_£ùÜs
 = 
	`g‘_sdisk_v®id_logicbs
(&
ns
->
sdisk
è<< (ns->
logicb_shiá
 - 9);

718 
ns_¡©us
->
¡©e
 = 
ns
->
sdisk
.
gd
 ? 
SHN_STATE_ATTACHED
 : 
SHN_STATE_DETACHED
;

720 
	`ns_upd©e_io_¡©i¡ics
(
ns
);

721 
ns_¡©us
->
ho¡_»ad_bªdwidth
 = 
ns
->host_read_bandwidth;

722 
ns_¡©us
->
ho¡_»ad_iİs
 = 
ns
->host_read_iops;

723 
ns_¡©us
->
ho¡_»ad_Ï‹ncy
 = 
ns
->host_read_latency;

724 
ns_¡©us
->
ho¡_wr™e_bªdwidth
 = 
ns
->host_write_bandwidth;

725 
ns_¡©us
->
ho¡_wr™e_iİs
 = 
ns
->host_write_iops;

726 
ns_¡©us
->
ho¡_wr™e_Ï‹ncy
 = 
ns
->host_write_latency;

728 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_ns_¡©us
 * 
__u£r
)
¬g
,

729 
ns_¡©us
, (*ns_status))) {

730 
	`shªnÚ_”r
("Cannot copy datao userspace.\n");

731 
»t
 = -
EFAULT
;

732 
out
;

734 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_ns_d©a
 * 
__u£r
)
ns_¡©us
->
d©a
,

735 
ns
->
d©a
, (*(ns->data)))) {

736 
	`shªnÚ_”r
("Cannot copy‚s datao userspace.\n");

737 
»t
 = -
EFAULT
;

740 
out
:

741 
	`shªnÚ_kä“
(
ns_¡©us
);

742  
»t
;

743 
	}
}

746 
	$£t_poŞ_ro
(
shªnÚ_poŞ
 *
¥oŞ
, 
»adÚly
)

748 
shªnÚ_Çme¥aû
 *
ns
;

749 
i
;

751 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

752 
ns
 = 
¥oŞ
->ns[
i
];

753 ià(
ns
 &&‚s->
sdisk
.
gd
)

754 
	`shªnÚ_£t_disk_ro
(
ns
->
sdisk
.
gd
, 
»adÚly
);

756 
	}
}

758 
	$g‘_sdev_»adÚly_»asÚ
(
shªnÚ_poŞ
 *
¥oŞ
)

760 
shªnÚ_dev
 *
sdev
;

761 
sdev_»asÚ
 = 0;

762 
i
;

764 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

765 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

766 ià(
sdev
)

767 
sdev_»asÚ
 |ğ
sdev
->
»adÚly_»asÚ
;

769  
sdev_»asÚ
;

770 
	}
}

772 
	$¥oŞ_upd©e_acûss_mode
(
shªnÚ_poŞ
 *
¥oŞ
)

774 
u64
 
»adÚly_»asÚ
, 
sdev_»asÚ
;

776 
sdev_»asÚ
 = 
	`g‘_sdev_»adÚly_»asÚ
(
¥oŞ
);

777 
»adÚly_»asÚ
 = 
¥oŞ
->»adÚly_»asÚ | 
sdev_»asÚ
;

778 ià(
»adÚly_»asÚ
) {

779 
¥oŞ
->
acûss_mode
 = 
SHN_MODE_READONLY
;

780 
	`shªnÚ_w¬n
("pool->readonly_reason=0x%lx, sdev->readonly_reason=0x%lx.\n",

781 
¥oŞ
->
»adÚly_»asÚ
, 
sdev_»asÚ
);

782 
	`shªnÚ_w¬n
("S‘‡Î‚ame¥aû iÀpoŞ %dØ»adÚly!", 
¥oŞ
->
id
);

783 
	`£t_poŞ_ro
(
¥oŞ
, 1);

785 
¥oŞ
->
acûss_mode
 = 
SHN_MODE_READWRITE
;

786 
	`£t_poŞ_ro
(
¥oŞ
, 0);

788  
¥oŞ
->
acûss_mode
;

789 
	}
}

792 
	$cİy_poŞ_šfo
(
shªnÚ_poŞ_šfo
 *
to
, shªnÚ_poŞ_šfØ*
äom
)

794 
i
;

795 
to
->
upd©e_couÁ
 = 
	`shªnÚ_mem_»adl
(&
äom
->update_count);

796 
to
->
cur_ns_£q_num
 = 
	`shªnÚ_mem_»adw
(&
äom
->cur_ns_seq_num);

797 
to
->
avaabË_ÿ·c™y
 = 
	`shªnÚ_mem_»adq
(&
äom
->available_capacity);

798 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

799 
to
->
ns_©Œi1
[
i
] = 
	`shªnÚ_mem_»adq
(
äom
->ns_attri1 + i);

800 
to
->
ns_©Œi2
[
i
] = 
	`shªnÚ_mem_»adl
(
äom
->ns_attri2 + i);

801 
to
->
ns_©Œi3
[
i
] = 
	`shªnÚ_mem_»adl
(
äom
->ns_attri3 + i);

803 
i
 = 0; i < (
SHANNON_NS_NUM
+63)/64; i++) {

804 
to
->
ns_b™m­
[
i
] = 
	`shªnÚ_mem_»adq
(
äom
->ns_bitmap + i);

806 
	}
}

808 
	$cİy_ns_d©a
(
shªnÚ_ns_d©a
 *
to
, shªnÚ_ns_d©¨*
äom
)

810 
to
->
v”siÚ
 = 
	`shªnÚ_mem_»adq
(&
äom
->version);

811 
	`shªnÚ_memıy
(
to
->
Çme
, 
äom
->name, (to->name));

812 
	}
}

814 
	$upd©e_poŞ_šfo
(
shªnÚ_poŞ
 *
¥oŞ
)

816 
shªnÚ_dev
 *
sdev
;

817 
i
;

819 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

820 
¥oŞ
->
poŞ_šfo
->
upd©e_couÁ
++;

821 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

823 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

824 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

825 ià(
sdev
 =ğ
NULL
)

827 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

828 
	`upd©e_poŞ_šfo_g5
(
sdev
, 0);

830 
	`upd©e_poŞ_šfo_g4
(
sdev
, 
¥oŞ
);

832 
	}
}

834 
	$»cov”_poŞ_šfo
(
shªnÚ_poŞ
 *
¥oŞ
, *
±r
)

836 
shªnÚ_poŞ_šfo
 *
poŞ_šfo
;

838 ià(!
¥oŞ
 || !
±r
) {

839 
	`shªnÚ_”r
("¥oŞ=0x%Í,…Œ=0x%Í.\n", 
¥oŞ
, 
±r
);

842 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

843 
poŞ_šfo
 = (
shªnÚ_poŞ_šfo
 *)
±r
;

844 ià(
	`shªnÚ_mem_»adl
(&
poŞ_šfo
->
upd©e_couÁ
è> 
¥oŞ
->pool_info->update_count) {

845 
	`cİy_poŞ_šfo
(
¥oŞ
->
poŞ_šfo
,…ool_info);

846 
¥oŞ
->
avaabË_ÿ·c™y
 = spoŞ->
poŞ_šfo
->available_capacity;

848 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

850 
	}
}

852 
	$upd©e_ns_d©a_ÿÎback
(
shªnÚ_bio
 *
sbio
)

854 
shªnÚ_Çme¥aû
 *
ns
 = 
sbio
->
d©a
;

855 
shªnÚ_dev
 *
sdev
 = 
ns
->
poŞ
->
sdevs
[0];

856 
shªnÚ_»que¡
 *
»q
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
sbio
->
»q_li¡
, shannon_request,

857 
bio_li¡
);

858 
shªnÚ_sb
 *
sb
;

860 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

861 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
 / sdev->
logicbs_š_siblšg_eblock
;

862 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

863 
	`shªnÚ_¥š_lock_bh
(&
ns
->
d©a_lock
);

864 
	`£t_v®id
(
sdev
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

865 ià(
ns
->
d©a_pba
.
lun_pba
 != 0x03ffffff)

866 
	`£t_Şd_pba_¡®e
(
sdev
, 
ns
->
d©a_pba
.
lun
,‚s->d©a_pba.
lun_pba
);

867 
ns
->
d©a_pba
 = 
»q
->
pba
;

868 
	`shªnÚ_¥š_uÆock_bh
(&
ns
->
d©a_lock
);

870 
	`shªnÚ_šfo
("%s:†un=%d,†un_pba=%d.\n", 
__func__
, 
»q
->
pba
.
lun
,„eq->pba.
lun_pba
);

871 
	`shªnÚ_©omic_sub
(1, &
sb
->
š_wr™e_logicbs
);

873 
	`shªnÚ_dma_unm­_sšgË
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, 4096, 
SHANNON_DMA_TODEVICE
);

874 
	`ä“_logicb_buf
(
sdev
, 
»q
->
vœt_addr
);

875 
	`ä“_»q
(
»q
);

876 
	`ä“_sbio
(
sbio
);

877 
ns
->
upd©e_ns_d©a_dÚe
 = 1;

878 
	`shªnÚ_wake_up
(&
ns
->
upd©e_ns_d©a_dÚe_ev’t
);

879 
	}
}

884 
	$upd©e_ns_d©a
(
shªnÚ_Çme¥aû
 *
ns
)

886 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

887 
shªnÚ_dev
 *
sdev
 = 
ns
->
poŞ
->
sdevs
[0];

888 
shªnÚ_bio
 *
sbio
;

889 *
buf
 = 
	`®loc_logicb_buf
(
sdev
, 
GFP_SHANNON
);

890 
¡ack_size
 = (()&¡ack_sizeè& (
THREAD_SIZE
-1);

891 
¡ack_size
 = 
THREAD_SIZE
 - stack_size;

893 
ns
->
d©a
->
v”siÚ
++;

894 
	`cİy_ns_d©a
(
buf
, 
ns
->
d©a
);

896 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

897 
	`£t_sbio_debug_g
(
sbio
, 
UPDATE_NS_DATA_TAG
);

898 
sbio
->
logicbs
 = 1;

899 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

900 
sbio
->
ÿÎback
 = 
upd©e_ns_d©a_ÿÎback
;

901 
sbio
->
may_¦“p_š_ÿÎback
 = 1;

902 
sbio
->
d©a
 = 
ns
;

904 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

905 
»q
->
sbio
 = sbio;

906 
	`£t_»q_debug_g
(
»q
, 
UPDATE_NS_DATA_TAG
, 0);

907 
»q
->
İcode
 = 
sh_cmd_wr™e
;

908 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

909 
»q
->
d©©y³
 = 
lba_ty³
[
sdev
->
lba_fÜm©
];

910 ià(
sdev
->
u£_du®_h—d
)

911 
»q
->
h—d
 = 
COLD_HEAD
;

913 
»q
->
h—d
 = 
HOT_HEAD
;

914 
»q
->
lba
 = 
šv®id_lba
[
sdev
->
lba_fÜm©
];

915 
»q
->
ns_id
 = 
ns
->
idx
;

916 
»q
->
ns_£q_num
 = 
ns
->
£q_num
;

917 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_sšgË
(
sdev
->
pci_dev
, 
buf
, (*(
ns
->
d©a
)),

918 
SHANNON_DMA_TODEVICE
);

919 
»q
->
vœt_addr
 = 
buf
;

920 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

921 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

922 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

923 
ns
->
upd©e_ns_d©a_dÚe
 = 0;

924 
	`add_wr™e_»q_to_»que¡_queue_
(
sdev
, 
»q
, 
ns
->
sdisk
.
´iÜ™y
);

925 ià(
¡ack_size
 > 4096)

926 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

928 
	`shªnÚ_pick_»que¡
(
sdev
, 1);

929 ià(
sdev
->
u£_du®_h—d
)

930 
	`mod_fl_chunk_tim”
(
sdev
, (1<<
COLD_INDEX
));

932 
	`mod_fl_chunk_tim”
(
sdev
, (1<<
HOT_INDEX
));

933 
	`shªnÚ_wa™_ev’t
(
ns
->
upd©e_ns_d©a_dÚe_ev’t
,‚s->
upd©e_ns_d©a_dÚe
 != 0);

935 
	}
}

937 
	$®loc_poŞ_šfo
(
shªnÚ_poŞ
 *
¥oŞ
)

939 
¥oŞ
->
ns
 = 
	`shªnÚ_kz®loc
((
shªnÚ_Çme¥aû
 *è* 
SHANNON_NS_NUM
, 
GFP_SHANNON
);

940 ià(
¥oŞ
->
ns
 =ğ
NULL
) {

941 
	`shªnÚ_”r
("Alloc spool->ns failed!\n");

942  -
ENOMEM
;

944 
¥oŞ
->
ns_d©a
 = 
	`shªnÚ_kz®loc
((
shªnÚ_ns_d©a
è* 
SHANNON_NS_NUM
, 
GFP_SHANNON
);

945 ià(
¥oŞ
->
ns_d©a
 =ğ
NULL
) {

946 
	`shªnÚ_”r
("Alloc spool->ns_data failed\n");

947 
	`shªnÚ_kä“
(
¥oŞ
->
ns
);

948  -
ENOMEM
;

950 
¥oŞ
->
poŞ_šfo
 = 
	`shªnÚ_kz®loc
(65536, 
GFP_SHANNON
);

951 ià(
¥oŞ
->
poŞ_šfo
 =ğ
NULL
) {

952 
	`shªnÚ_”r
("Alloc…ool_info failed!\n");

953 
	`shªnÚ_kä“
(
¥oŞ
->
ns
);

954 
	`shªnÚ_kä“
(
¥oŞ
->
ns_d©a
);

955  -
ENOMEM
;

957 
¥oŞ
->
poŞ_šfo
->
cur_ns_£q_num
 = 1;

959 
	}
}

961 
	$»Ëa£_poŞ_šfo
(
shªnÚ_poŞ
 *
¥oŞ
)

963 
	`shªnÚ_kä“
(
¥oŞ
->
ns
);

964 
	`shªnÚ_kä“
(
¥oŞ
->
ns_d©a
);

965 
	`shªnÚ_kä“
(
¥oŞ
->
poŞ_šfo
);

966 
	}
}

967 
	$ä“_¥oŞ
(
shªnÚ_©omic_t
 *
»fcouÁ
)

969 
shªnÚ_poŞ
 *
¥oŞ
 = 
	`cÚš”_of
(
»fcouÁ
, shannon_pool,„efcount);

971 
	`shªnÚ_šfo
("th»fcouÁ oàpoŞ %d deü—£Ø0.\n", 
¥oŞ
->
id
);

972 
	`»Ëa£_poŞ_šfo
(
¥oŞ
);

973 
	`shªnÚ_kä“
(
¥oŞ
);

974 
	}
}

976 
shªnÚ_poŞ
 *
	$¥oŞ_g‘_»ã»nû
(
shªnÚ_poŞ
 *
¥oŞ
)

978 ià(!
¥oŞ
)

979  
NULL
;

980 
	`g‘_»fcouÁ
(&
¥oŞ
->
»fcouÁ
);

981 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
»fcouÁ
) == 1) {

982 
	`put_»fcouÁ
(&
¥oŞ
->
»fcouÁ
, 
ä“_¥oŞ
);

983  
NULL
;

985  
¥oŞ
;

986 
	}
}

988 
	$¥oŞ_put_»ã»nû
(
shªnÚ_poŞ
 *
¥oŞ
)

990 
	`put_»fcouÁ
(&
¥oŞ
->
»fcouÁ
, 
ä“_¥oŞ
);

991 
	}
}

994 
»fÜm©
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_fÜm©_¬g2
 *
çrg
);

995 
shªnÚ_poŞ
 *
	$®loc_poŞ
(
sdev_couÁ
, 
u64
 
w©”m¬k
)

997 
shªnÚ_poŞ
 *
p
 = 
NULL
;

998 
»Œy
:

999 
p
 = 
	`shªnÚ_kz®loc
((*pè+ (
shªnÚ_dev
 *è* 
sdev_couÁ
, 
GFP_SHANNON
);

1000 ià(!
p
) {

1001 
	`shªnÚ_w¬n
("Alloc shannon_pool failed!\n");

1002 
	`shªnÚ_m¦“p
(5);

1003 
»Œy
;

1005 ià(
	`®loc_poŞ_šfo
(
p
) < 0) {

1006 
	`shªnÚ_kä“
(
p
);

1007  
NULL
;

1010 
	`shªnÚ_mu‹x_š™
(&
p
->
¡©e_£m
);

1011 
	`shªnÚ_mu‹x_š™
(&
p
->
poŞ_šfo_£m
);

1012 
	`shªnÚ_©omic_£t
(&
p
->
»fcouÁ
, 1);

1013 
	`shªnÚ_©omic_£t
(&
p
->
ns_couÁ
, 0);

1014 
	`shªnÚ_©omic_£t
(&
p
->
high_´iÜ™y_ns_couÁ
, 0);

1015 
	`shªnÚ_©omic64_£t
(&
p
->
u£d_logicbs
, 0);

1016 
	`shªnÚ_©omic_£t
(&
p
->
»cov”_ns_d©a_dÚe
, 0);

1017 
	`shªnÚ_š™_wa™queue_h—d
(&
p
->
»cov”_ns_d©a_dÚe_ev’t
);

1018 
p
->
avaabË_ÿ·c™y
 = 0;

1019 
p
->
physiÿl_ÿ·c™y
 = 0;

1020 
p
->
w©”m¬k
 = watermark;

1021 
p
->
id
 = 
	`shªnÚ_fšd_fœ¡_z”o_b™
(&
poŞ_b™m­
, 
MAX_POOL_COUNT
);

1022 ià(
p
->
id
 =ğ
MAX_POOL_COUNT
) {

1023 
	`shªnÚ_”r
("Úly suµÜˆ%d…oŞs.\n", 
MAX_POOL_COUNT
);

1024 
	`put_»fcouÁ
(&
p
->
»fcouÁ
, 
ä“_¥oŞ
);

1025  
NULL
;

1027 
	`shªnÚ_£t_b™
(
p
->
id
, &
poŞ_b™m­
);

1028 
p
->
sdev_couÁ
 = sdev_count;

1029 
p
->
Úlše_sdev_couÁ
 = 0;

1030 
p
->
majÜ
 = 
	`shªnÚ_»gi¡”_blkdev
(0, "shannon");

1031 
	`debugs0
("majÜ=%d.\n", 
p
->
majÜ
);

1032 
	`shªnÚ_¢´štf
(
p
->
cdev_Çme
, 16, "poŞ%d",…->
id
);

1033 
	`shªnÚ_¢´štf
(
p
->
nod’ame
, 32, "shªnÚ/%s",…->
cdev_Çme
);

1034 
	`shªnÚ_ü—‹_miscdeviû
(&
p
->
misc
,…->
cdev_Çme
,…->
nod’ame
, 
FOR_POOL
);

1035 ià(
	`shªnÚ_sysfs_š™_poŞ
(&
p
->
sysfs_kobj
)) {

1036 
	`shªnÚ_”r
("%s:‡dd kobjeùØsysf çed.\n", 
p
->
cdev_Çme
);

1038 
	`debugs1
("%s: sysf objeù in™ dÚe.\n", 
p
->
cdev_Çme
);

1039 
p
->
sysfs_š™_dÚe
 = 1;

1041  
p
;

1042 
	}
}

1044 
	$»Ëa£_poŞ
(
shªnÚ_poŞ
 *
¥oŞ
)

1046 
i
;

1048 ià(
¥oŞ
->
majÜ
 > 0)

1049 
	`shªnÚ_uÄegi¡”_blkdev
(
¥oŞ
->
majÜ
, "shannon");

1050 
	`shªnÚ_ş—r_b™
(
¥oŞ
->
id
, &
poŞ_b™m­
);

1051 ià(
¥oŞ
->
ns
) {

1052 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

1053 ià(
¥oŞ
->
ns
[
i
]) {

1054 
shªnÚ_Çme¥aû
 *
ns
 = 
¥oŞ
->ns[
i
];

1055 
	`shªnÚ_d‘ach_ns
(
ns
);

1056 
¥oŞ
->
ns
[
i
] = 
NULL
;

1057 
	`shªnÚ_b¬r›r
();

1058 
	`sh_deü—£_u£rs_ns
(
ns
);

1062 ià(
¥oŞ
->
sysfs_š™_dÚe
) {

1063 
	`shªnÚ_sysfs_ex™_poŞ
(&
¥oŞ
->
sysfs_kobj
);

1066 
	`shªnÚ_de¡roy_miscdeviû
(&
¥oŞ
->
misc
);

1067 
	`put_»fcouÁ
(&
¥oŞ
->
»fcouÁ
, 
ä“_¥oŞ
);

1068 
	}
}

1070 
	$»Ëa£_poŞ_¡ruù
(
shªnÚ_poŞ
 *
¥oŞ
)

1072 ià(
¥oŞ
 =ğ
NULL
)

1075 ià(--
¥oŞ
->
Úlše_sdev_couÁ
 == 0) {

1076 
	`shªnÚ_mu‹x_lock
(&
poŞ_£m
);

1077 
	`shªnÚ_li¡_d–
(&
¥oŞ
->
li¡
);

1078 
	`shªnÚ_mu‹x_uÆock
(&
poŞ_£m
);

1079 
	`shªnÚ_memblock_poŞ_dec_maxt
(&
m­_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1080 
	`shªnÚ_memblock_poŞ_dec_maxt
(&
‹mp_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1081 
	`»Ëa£_poŞ
(
¥oŞ
);

1084 
	}
}

1086 
	$d–‘e_poŞ
(
shªnÚ_poŞ
 *
¥oŞ
)

1088 
i
, 
»t
 = 0;

1089 
shªnÚ_fÜm©_¬g2
 *
fÜm©_¬g2
;

1091 ià(!
¥oŞ
) {

1092 
	`shªnÚ_”r
("This…ool does‚otƒxist!\n");

1093  -
EINVAL
;

1096 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
ns_couÁ
è&& spoŞ->
Úlše_sdev_couÁ
 =ğ¥oŞ->
sdev_couÁ
) {

1097 
	`shªnÚ_w¬n
("Warning: Cannot delete…ool. %d‚amespace‡re in use.\n",

1098 
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
ns_couÁ
));

1099  -
EBUSY
;

1102 
fÜm©_¬g2
 = 
	`shªnÚ_kz®loc
((*fÜm©_¬g2), 
GFP_SHANNON
);

1103 ià(
fÜm©_¬g2
 =ğ
NULL
) {

1104 
	`shªnÚ_”r
("Cannot‡llocate memory for format_arg2.\n");

1105  -
ENOMEM
;

1108 
	`shªnÚ_mu‹x_lock
(&
poŞ_£m
);

1109 
	`shªnÚ_li¡_d–
(&
¥oŞ
->
li¡
);

1110 
	`shªnÚ_mu‹x_uÆock
(&
poŞ_£m
);

1112 
	`shªnÚ_memblock_poŞ_dec_maxt
(&
m­_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1113 
	`shªnÚ_memblock_poŞ_dec_maxt
(&
‹mp_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1115 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1116 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

1117 
shªnÚ_dev
 *
sdev
 = 
¥oŞ
->
sdevs
[
i
];

1118 ià(!
sdev
)

1121 ià(
	`shªnÚ_®loc_m­_bË
(&
sdev
->
sdisk
, sdev->sdisk.
£ùÜs
, sdev->
logicb_shiá
)) {

1122 
»t
 = -
ENOMEM
;

1123 
	`shªnÚ_”r
("cannot‡llocateƒnough memory for map_table!\n");

1125 
	`sdev_m­_bË_’abË
(
sdev
);

1126 
	`shªnÚ_š™_blk_queue
(
sdev
);

1127 
	`shªnÚ_b¬r›r
();

1128 
¥oŞ
->
sdevs
[
i
] = 
NULL
;

1129 
sdev
->
¥oŞ
 = 
NULL
;

1131 
sdev
->
mbr
.
sdev_id
 = 0;

1132 
sdev
->
mbr
.
sdev_couÁ
 = 0;

1133 
sdev
->
mbr
.
poŞ_w©”m¬k
 = 0;

1134 ià(
	`»fÜm©
(
sdev
, 
fÜm©_¬g2
)) {

1135 
»t
 = -
EFAULT
;

1136 
	`shªnÚ_”r
("»fÜm© deviû %d faed!\n", 
i
);

1140 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1141 
	`»Ëa£_poŞ
(
¥oŞ
);

1142 
	`shªnÚ_kä“
(
fÜm©_¬g2
);

1143  
»t
;

1144 
	}
}

1146 
shªnÚ_poŞ
 *
	$fšd_poŞ_fÜ_sdev
(
shªnÚ_dev
 *
sdev
)

1148 
u64
 
w©”m¬k
 = 
sdev
->
mbr
.
poŞ_w©”m¬k
;

1149 
shªnÚ_poŞ
 *
p
;

1150 ià(!
w©”m¬k
) {

1151 
	`shªnÚ_šfo
("ThpoŞ_w©”m¬k oàdeviû % i NULL.\n", 
sdev
->
cdev_Çme
);

1152  
NULL
;

1154 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
shªnÚ_poŞ_li¡
, 
li¡
)

1155 ià(
p
->
w©”m¬k
 == watermark)

1156  
p
;

1157 
p
 = 
	`®loc_poŞ
(
sdev
->
mbr
.
sdev_couÁ
, 
w©”m¬k
);

1158 
	`shªnÚ_li¡_add_
(&
p
->
li¡
, &
shªnÚ_poŞ_li¡
);

1159  
p
;

1160 
	}
}

1162 
shªnÚ_poŞ
 *
	$fšd_shªnÚ_poŞ
(
u16
 
poŞ_id
)

1164 
shªnÚ_poŞ
 *
¥oŞ
;

1165 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
¥oŞ
, &
shªnÚ_poŞ_li¡
, 
li¡
)

1166 ià(
poŞ_id
 =ğ
¥oŞ
->
id
)

1167  
¥oŞ
;

1168  
NULL
;

1169 
	}
}

1171 
shªnÚ_dev
 *
	$fšd_shªnÚ_dev
(
u8
 
id
)

1173 
shªnÚ_dev
 *
sdev
;

1174 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
sdev
, &
shªnÚ_dev_li¡
, 
li¡
)

1175 ià(
sdev
->
drive_no
 =ğ
id
)

1176  
sdev
;

1177  
NULL
;

1178 
	}
}

1180 
shªnÚ_g‘_¿ndom_by‹s
(*, );

1181 
	$__ü—‹_poŞ
(
¬g
)

1183 
shªnÚ_poŞ
 *
¥oŞ
;

1184 
shªnÚ_ü—‹_poŞ_¬g
 
ü—‹_¬g
;

1185 
shªnÚ_fÜm©_¬g2
 *
fÜm©_¬g2
;

1186 
shªnÚ_dev
 *
sdev
;

1187 
»t
 = 0;

1188 
i
;

1189 
u64
 
w©”m¬k
;

1191 ià(
	`shªnÚ_cİy_äom_u£r
(&
ü—‹_¬g
,

1192 (
shªnÚ_ü—‹_poŞ_¬g
 * 
__u£r
)
¬g
,

1193 (
ü—‹_¬g
))) {

1194 
	`shªnÚ_”r
("Could‚ot copy…ool info from userspace.\n");

1195  -
EFAULT
;

1197 ià(
ü—‹_¬g
.
couÁ
 == 0) {

1198 
	`shªnÚ_”r
("Cannot create‡…ool with zero device.\n");

1199  -
EINVAL
;

1202 
i
 = 0; i < 
ü—‹_¬g
.
couÁ
; i++) {

1203 
sdev
 = 
	`fšd_shªnÚ_dev
(
ü—‹_¬g
.
dev_id
[
i
]);

1204 ià(!
sdev
 || sdev->
¥oŞ
 || sdev->
sdisk
.
gd
) {

1205 ià(!
sdev
) {

1206 
	`shªnÚ_”r
("Create…ool failed, device does‚otƒxist.\n");

1207 
»t
 = -
EINVAL
;

1208 } ià(
sdev
->
¥oŞ
) {

1209 
	`shªnÚ_”r
("device %s belongso‡…ool.\n");

1210 
»t
 = -
EBUSY
;

1212 
	`shªnÚ_”r
("Create…ool failed, device is‡ttached.");

1213 
»t
 = -
EBUSY
;

1217 ià(
»t
)

1218  
»t
;

1220 
fÜm©_¬g2
 = 
	`shªnÚ_kz®loc
((*fÜm©_¬g2), 
GFP_SHANNON
);

1221 ià(
fÜm©_¬g2
 =ğ
NULL
) {

1222 
	`shªnÚ_”r
("Cannot‡llocate memory for format_arg2.\n");

1223  -
ENOMEM
;

1226 
	`shªnÚ_g‘_¿ndom_by‹s
(&
w©”m¬k
, (watermark));

1227 
¥oŞ
 = 
	`®loc_poŞ
(
ü—‹_¬g
.
couÁ
, 
w©”m¬k
);

1228 
¥oŞ
->
Úlše_sdev_couÁ
 = 
ü—‹_¬g
.
couÁ
;

1229 
i
 = 0; i < 
ü—‹_¬g
.
couÁ
; i++) {

1230 
sdev
 = 
	`fšd_shªnÚ_dev
(
ü—‹_¬g
.
dev_id
[
i
]);

1231 
¥oŞ
->
sdevs
[
i
] = 
sdev
;

1232 
sdev
->
¥oŞ
 = spool;

1235 
¥oŞ
->
avaabË_ÿ·c™y
 = 
ü—‹_¬g
.
ÿ·c™y
;

1236 
¥oŞ
->
poŞ_šfo
->
avaabË_ÿ·c™y
 = 
ü—‹_¬g
.
ÿ·c™y
;

1237 
	`ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
¥oŞ
);

1238 
¥oŞ
->
poŞ_šfo
->
upd©e_couÁ
++;

1240 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

1241 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

1242 
sdev
->
mbr
.
sdev_id
 = 
i
;

1243 
sdev
->
mbr
.
sdev_couÁ
 = 
¥oŞ
->sdev_count;

1244 
sdev
->
mbr
.
poŞ_w©”m¬k
 = 
w©”m¬k
;

1245 
	`ş—r_©omic_´iÜ™ize_wr™e
(
sdev
);

1246 ià(
	`»fÜm©
(
sdev
, 
fÜm©_¬g2
)) {

1247 
»t
 = -
EFAULT
;

1248 
	`shªnÚ_”r
("»fÜm© deviû %d faed!\n", 
i
);

1251 
	`shªnÚ_kä“
(
fÜm©_¬g2
);

1254 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

1255 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

1256 
	`shªnÚ_m­_bË_ä“
(&
sdev
->
sdisk
);

1258 
	`BUG_ON
(
sdev
->
sdisk
.
sdev_couÁ
 != 1);

1259 ià(
sdev
->
sdisk
.
Ímt_¬¿y
 && (sdev->sdisk.Ímt_¬¿y[0].
m­_bË
.
memblock_couÁ
 != 0)) {

1260 ià(
sdev
->
sdisk
.
queue
) {

1261 
	`shªnÚ_blk_ş—nup_queue
(
sdev
->
sdisk
.
queue
);

1262 
sdev
->
sdisk
.
queue
 = 
NULL
;

1267 
	`shªnÚ_li¡_add_
(&
¥oŞ
->
li¡
, &
shªnÚ_poŞ_li¡
);

1269 
ü—‹_¬g
.
poŞ_id
 = 
¥oŞ
->
id
;

1270 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_ü—‹_poŞ_¬g
 * 
__u£r
)
¬g
,

1271 &
ü—‹_¬g
, (create_arg))) {

1272 
	`shªnÚ_”r
("Could‚ot copy…ool infoo userspace.\n");

1273  -
EFAULT
;

1276 ià(!
»t
) {

1277 ià(
shªnÚ_memblock_´—Îoc
 == 0) {

1278 
	`shªnÚ_memblock_poŞ_šc_maxt
(&
m­_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1279 
	`shªnÚ_memblock_poŞ_add
(&
m­_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1280 
	`shªnÚ_memblock_poŞ_šc_maxt
(&
‹mp_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1281 
	`shªnÚ_memblock_poŞ_add
(&
‹mp_bË_poŞ
, 
¥oŞ
->
avaabË_ÿ·c™y
, 12);

1282 } ià(
shªnÚ_memblock_´—Îoc
 > 0) {

1283 
	`shªnÚ_queue_wÜk
(
m­_bË_poŞ
.
memblock_wq
, &m­_bË_poŞ.
®loc_wÜk
);

1284 
	`shªnÚ_queue_wÜk
(
‹mp_bË_poŞ
.
memblock_wq
, &‹mp_bË_poŞ.
®loc_wÜk
);

1288  
»t
;

1289 
	}
}

1291 
	$ü—‹_poŞ
(
¬g
)

1293 
»t
;

1294 
	`shªnÚ_mu‹x_lock
(&
poŞ_£m
);

1295 
»t
 = 
	`__ü—‹_poŞ
(
¬g
);

1296 
	`shªnÚ_mu‹x_uÆock
(&
poŞ_£m
);

1297  
»t
;

1298 
	}
}

1300 
	$check_mbr
(
shªnÚ_poŞ
 *
¥oŞ
, 
shªnÚ_mbr
 *
mbr
)

1302 ià(
¥oŞ
->
sdev_couÁ
 !ğ
mbr
->sdev_count) {

1303 
	`shªnÚ_”r
("%d, sdev_couÁ incÚsi¡’t!\n", 
__LINE__
);

1307 
	}
}

1309 
	$š™_sdev_š_poŞ
(
shªnÚ_dev
 *
sdev
)

1311 
shªnÚ_poŞ
 *
¥oŞ
 = 
	`fšd_poŞ_fÜ_sdev
(
sdev
);

1312 
shªnÚ_mbr
 *
mbr
 = &
sdev
->mbr;

1313 
»t
;

1315 ià(
¥oŞ
 =ğ
NULL
)

1316  -
EINVAL
;

1317 
sdev
->
¥oŞ
 = spool;

1319 ià(
mbr
->
sdev_id
 >ğ
¥oŞ
->
sdev_couÁ
) {

1320 
	`shªnÚ_”r
("%d, %s, cÜru±ed sdev_id!\n", 
__LINE__
,

1321 
sdev
->
sdisk
.
disk_Çme
);

1324 ià(
¥oŞ
->
sdevs
[
mbr
->
sdev_id
]) {

1325 
	`shªnÚ_”r
("%d, sdev_id cÚæiùs!\n", 
__LINE__
);

1328 
¥oŞ
->
sdevs
[
mbr
->
sdev_id
] = 
sdev
;

1330 
¥oŞ
->
Úlše_sdev_couÁ
++;

1331 
»t
 = 
	`check_mbr
(
¥oŞ
, 
mbr
);

1332 ià(
»t
 < 0) {

1333 
	`shªnÚ_”r
("Wrong mbr information!\n");

1334  -
EINVAL
;

1337 
	}
}

1340 *
	$g‘_shªnÚ_poŞ_äom_li¡
(
shªnÚ_li¡_h—d
 *
li¡
)

1342  
	`cÚš”_of
(
li¡
, 
shªnÚ_poŞ
,†ist);

1343 
	}
}

1345 *
	$g‘_miscdeviû_äom_shªnÚ_poŞ
(*
¥oŞ
)

1347  &((
shªnÚ_poŞ
 *)
¥oŞ
)->
misc
;

1348 
	}
}

1350 
	$shªnÚ_ioùl_g‘_poŞ_ÿp
(
¬g
)

1352 
ÿp
 = 0;

1353 
»t
 = 0;

1355 
ÿp
 |ğ
SUPPORT_SET_MAX_IOPS_MASK
;

1356 
ÿp
 |ğ
SUPPORT_SET_PRIORITY_MASK
;

1357 
ÿp
 |ğ
SUPPORT_SET_SECTORS_MASK
;

1359 ià(
	`shªnÚ_cİy_to_u£r
((* 
__u£r
)
¬g
, &
ÿp
, (cap))) {

1360 
	`shªnÚ_”r
("Cannot copy datao userspace.\n");

1361 
»t
 = -
EFAULT
;

1364  
»t
;

1365 
	}
}

1367 
	$shªnÚ_poŞ_©ch
(
shªnÚ_poŞ
 *
¥oŞ
)

1369 
shªnÚ_poŞ_šfo
 *
poŞ_šfo
;

1370 
shªnÚ_Çme¥aû
 *
ns
;

1371 
idx
, 
»suÉ
, 
»t
 = 0;

1373 ià(
¥oŞ
->
Úlše_sdev_couÁ
 !ğ¥oŞ->
sdev_couÁ
) {

1374 
	`shªnÚ_w¬n
("online_sdev_count=%d, sdev_count=%d.\n",

1375 
¥oŞ
->
Úlše_sdev_couÁ
, spoŞ->
sdev_couÁ
);

1379 
poŞ_šfo
 = 
¥oŞ
->pool_info;

1380 
	`ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
¥oŞ
);

1382 
idx
 = 0; idx < 
SHANNON_NS_NUM
; idx++) {

1383 ià(!
	`shªnÚ_‹¡_b™
(
idx
, (*)
poŞ_šfo
->
ns_b™m­
))

1385 
ns
 = 
¥oŞ
->ns[
idx
];

1386 ià(!
ns
) {

1387 
	`shªnÚ_”r
("Çme¥aû %d i NULL.\n", 
idx
);

1390 ià(
ns
->
sdisk
.
´iÜ™y
 == 1)

1391 
	`shªnÚ_©omic_šc
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
);

1392 
»suÉ
 = 
	`shªnÚ_©ch_ns
(
ns
);

1393 ià(
»suÉ
 < 0)

1394 
»t
 = 
»suÉ
;

1397 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) > 0)

1398 
	`£t_poŞ_h¬d_queue_lim™
(
¥oŞ
, 32);

1399 ià(
¥oŞ
->
acûss_mode
 =ğ
SHN_MODE_READONLY
)

1400 
	`shªnÚ_šfo
("Name¥aû š…oŞ%d‡»„—dÚly.\n", 
¥oŞ
->
id
);

1401  
»t
;

1402 
	}
}

1404 
	$shªnÚ_poŞ_d‘ach
(
shªnÚ_poŞ
 *
¥oŞ
)

1406 
shªnÚ_poŞ_šfo
 *
poŞ_šfo
;

1407 
shªnÚ_Çme¥aû
 *
ns
;

1408 
idx
;

1410 
poŞ_šfo
 = 
¥oŞ
->pool_info;

1411 
idx
 = 0; idx < 
SHANNON_NS_NUM
; idx++) {

1412 ià(!
	`shªnÚ_‹¡_b™
(
idx
, (*)
poŞ_šfo
->
ns_b™m­
))

1414 
ns
 = 
¥oŞ
->ns[
idx
];

1415 ià(!
ns
) {

1416 
	`shªnÚ_”r
("Çme¥aû %d i NULL.\n", 
idx
);

1419 
	`shªnÚ_d‘ach_ns
(
ns
);

1421 
	}
}

1423 
	$shªnÚ_ioùl_g‘_poŞ_¡©us
(
shªnÚ_poŞ
 *
¥oŞ
, 
¬g
)

1425 
shªnÚ_poŞ_¡©us
 *
poŞ_¡©us
;

1426 
u64
 
phy_ÿp
;

1427 
i
, 
»t
 = 0, 
logicb_shiá
 = 12;

1429 
poŞ_¡©us
 = 
	`shªnÚ_kz®loc
((*poŞ_¡©us), 
GFP_SHANNON
);

1430 ià(
poŞ_¡©us
 =ğ
NULL
) {

1431 
	`shªnÚ_”r
("Cannot‡llocate…ool_status.\n");

1432  -
ENOMEM
;

1435 
poŞ_¡©us
->
id
 = 
¥oŞ
->id;

1436 
poŞ_¡©us
->
¡©e
 = 
¥oŞ
->state;

1437 
poŞ_¡©us
->
sdev_couÁ
 = 
¥oŞ
->sdev_count;

1438 
poŞ_¡©us
->
Úlše_sdev_couÁ
 = 
¥oŞ
->online_sdev_count;

1439 
i
 = 0; i < 
MAX_DEVICE_NO
; i++)

1440 
poŞ_¡©us
->
sdev_id
[
i
] = ~0;

1441 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++)

1442 ià(
¥oŞ
->
sdevs
[
i
]) {

1443 
poŞ_¡©us
->
sdev_id
[
i
] = 
¥oŞ
->
sdevs
[i]->
drive_no
;

1444 
phy_ÿp
 = 
	`ÿlcuÏ‹_physiÿl_ÿ·c™y
(
¥oŞ
->
sdevs
[
i
]);

1445 
poŞ_¡©us
->
physiÿl_£ùÜs
 +ğ
phy_ÿp
;

1446 
logicb_shiá
 = 
¥oŞ
->
sdevs
[
i
]->logicb_shift;

1448 
poŞ_¡©us
->
acûss_mode
 = 
¥oŞ
->access_mode;

1449 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

1450 
poŞ_¡©us
->
u£d_£ùÜs
 = 
	`shªnÚ_©omic64_»ad
(&
¥oŞ
->
u£d_logicbs
è<< (
logicb_shiá
-9);

1451 
poŞ_¡©us
->
ÿ·c™y
 = 
¥oŞ
->
avaabË_ÿ·c™y
;

1452 
poŞ_¡©us
->
ns_couÁ
 = 
	`shªnÚ_©omic_»ad
(&
¥oŞ
->ns_count);

1453 
poŞ_¡©us
->
ov”´ovisiÚ
 = 
¥oŞ
->overprovision;

1454 
poŞ_¡©us
->
»adÚly_»asÚ
 = 
¥oŞ
->»adÚly_»asÚ | 
	`g‘_sdev_»adÚly_»asÚ
(spool);

1455 
	`shªnÚ_memıy
(&
poŞ_¡©us
->
ns_b™m­
, &
¥oŞ
->
poŞ_šfo
->ns_bitmap, (pool_status->ns_bitmap));

1456 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

1458 ià(
	`shªnÚ_cİy_to_u£r
((
shªnÚ_poŞ_¡©us
 * 
__u£r
)
¬g
,

1459 
poŞ_¡©us
, (*pool_status))) {

1460 
	`shªnÚ_”r
("Cannot copy datao userspace.\n");

1461 
»t
 = -
EFAULT
;

1464 
	`shªnÚ_kä“
(
poŞ_¡©us
);

1465  
»t
;

1466 
	}
}

1468 
	$shªnÚ_poŞ_ioùl
(
shªnÚ_fe_t
 *
fp
, 
cmd
, 
¬g
)

1470 
shªnÚ_poŞ
 *
¥oŞ
;

1471 
»t
 = -
ENOTTY
;

1473 
¥oŞ
 = 
	`shªnÚ_fe_´iv©e_d©a
(
fp
);

1474 ià(
¥oŞ
 =ğ
NULL
) {

1475 
	`shªnÚ_”r
("pool is NULL!\n");

1476  
»t
;

1479 ià(
¥oŞ
->
Úlše_sdev_couÁ
 !ğ¥oŞ->
sdev_couÁ
 &&

1480 (
cmd
 =ğ
SHANNON_IOCADDNS
 ||

1481 
cmd
 =ğ
SHANNON_IOCDELNS
 ||

1482 
cmd
 =ğ
SHANNON_IOCATTACHNS
 ||

1483 
cmd
 =ğ
SHANNON_IOCSETNS
 ||

1484 
cmd
 =ğ
SHANNON_IOCDETACHNS
)

1486 
	`shªnÚ_”r
("Úlše_sdev_couÁ=%d, cmd=0x%x.\n", 
¥oŞ
->
Úlše_sdev_couÁ
, 
cmd
);

1487  -
ENOTTY
;

1492 ià(
¥oŞ
->
acûss_mode
 =ğ
SHN_MODE_READONLY
 &&

1493 (
cmd
 =ğ
SHANNON_IOCADDNS
 || cmd =ğ
SHANNON_IOCSETNS
)

1495 
	`shªnÚ_”r
("acûss_mode=0x%x, cmd=0x%x.\n", 
¥oŞ
->
acûss_mode
, 
cmd
);

1496  -
ENOTTY
;

1498 
cmd
) {

1499 
SHANNON_IOCDELPOOL
:

1500  
	`d–‘e_poŞ
(
¥oŞ
);

1501 
SHANNON_IOCADDNS
:

1502 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1503 
»t
 = 
	`ü—‹_Çme¥aû
(
¥oŞ
, 
¬g
);

1504 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1505  
»t
;

1506 
SHANNON_IOCDELNS
:

1507 
»t
 = 
	`»Ëa£_Çme¥aû
(
¥oŞ
, 
¬g
);

1508  
»t
;

1509 
SHANNON_IOCATTACHNS
:

1510 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1511 
»t
 = 
	`shªnÚ_ioùl_©ch_ns
(
¥oŞ
, 
¬g
);

1512 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1513  
»t
;

1514 
SHANNON_IOCDETACHNS
:

1515 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1516 
»t
 = 
	`shªnÚ_ioùl_d‘ach_ns
(
¥oŞ
, 
¬g
);

1517 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1518  
»t
;

1519 
SHANNON_IOCSETNS
:

1520 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1521 
»t
 = 
	`shªnÚ_ioùl_£t_ns
(
¥oŞ
, 
¬g
);

1522 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1523  
»t
;

1524 
SHANNON_IOCGETPOOL
:

1525 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1526 
»t
 = 
	`shªnÚ_ioùl_g‘_poŞ_¡©us
(
¥oŞ
, 
¬g
);

1527 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1528  
»t
;

1529 
SHANNON_IOCGETPOOLCAP
:

1530  
	`shªnÚ_ioùl_g‘_poŞ_ÿp
(
¬g
);

1531 
SHANNON_IOCGETNS
:

1532 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

1533 
»t
 = 
	`shªnÚ_ioùl_g‘_ns_¡©us
(
¥oŞ
, 
¬g
);

1534 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

1535  
»t
;

1537 
	`debugs0
("Unknow cmd=0x%x.\n", 
cmd
);

1538  
»t
;

1542 
	}
}

1544 
	$»Ëa£_sdev_m­_bË
(
shªnÚ_dev
 *
sdev
)

1546 
i
;

1547 
shªnÚ_Çme¥aû
 *
ns
;

1549 ià(
sdev
->
¥oŞ
) {

1550 
i
 = 0; i < 
SHANNON_NS_NUM
; i++) {

1551 
ns
 = 
sdev
->
¥oŞ
->ns[
i
];

1552 ià(
ns
 !ğ
NULL
) {

1553 
	`shªnÚ_m­_bË_di§bË
(&
ns
->
sdisk
.
Ímt_¬¿y
[
sdev
->
mbr
.
sdev_id
]);

1554 
	`shªnÚ_m­_bË_»£t
(&
ns
->
sdisk
.
Ímt_¬¿y
[
sdev
->
mbr
.
sdev_id
], 1);

1558 
	}
}

1560 
	~"shªnÚ_ns_rw.c
"

	@shannon_ns_rw.c

2 
	$šü—£_ns_³ndšg_bios
(
shªnÚ_Çme¥aû
 *
ns
)

4 
	`shªnÚ_©omic_šc
(&
ns
->
sdisk
.
³ndšg_bios
);

5 
	}
}

7 
	$deü—£_ns_³ndšg_bios
(
shªnÚ_Çme¥aû
 *
ns
)

9 
	`shªnÚ_©omic_dec
(&
ns
->
sdisk
.
³ndšg_bios
);

10 
	}
}

12 
	$ns_have_»ad_£ùÜs
(
shªnÚ_Çme¥aû
 *
ns
)

14  
	`shªnÚ_»ad_£ùÜs
(
ns
->
sdisk
.
gd
);

15 
	}
}

17 
	$ns_have_»ad_ios
(
shªnÚ_Çme¥aû
 *
ns
)

19  
	`shªnÚ_»ad_ios
(
ns
->
sdisk
.
gd
);

20 
	}
}

22 
	$ns_have_wr™‹n_£ùÜs
(
shªnÚ_Çme¥aû
 *
ns
)

24  
	`shªnÚ_wr™e_£ùÜs
(
ns
->
sdisk
.
gd
);

25 
	}
}

27 
	$ns_have_wr™‹n_ios
(
shªnÚ_Çme¥aû
 *
ns
)

29  
	`shªnÚ_wr™e_ios
(
ns
->
sdisk
.
gd
);

30 
	}
}

32 
	$ns_have_»ad_m£cs
(
shªnÚ_Çme¥aû
 *
ns
)

34  
	`shªnÚ_»ad_m£cs
(
ns
->
sdisk
.
gd
);

35 
	}
}

37 
	$ns_have_wr™‹n_m£cs
(
shªnÚ_Çme¥aû
 *
ns
)

39  
	`shªnÚ_wr™e_m£cs
(
ns
->
sdisk
.
gd
);

40 
	}
}

42 
šlše
 
	$is_Ï¡_wr™e_»q_š_dev
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_dev
 *
sdev
, 
shªnÚ_»que¡
 *
»q
, 
logicb64_t
 
Ï¡_lba
)

44 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

46 ià((
»q
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
è&& (
sdev
->
gc_th»ad_¡©e
 =ğ
IN_GC_STATE
è&& (
ns
->
sdisk
.
´iÜ™y
 == 0)) {

47 ià(
»q
->
lba
 =ğ
Ï¡_lba
)

50 ià(
¥oŞ
->
sdev_couÁ
 == 1)

52 ià((((
»q
->
lba
 & (
ns
->
¡r_size
 - 1)è=ğÒs->¡r_siz- 1)è&& ((1 +„eq->lb¨+‚s->¡r_siz* (
¥oŞ
->
sdev_couÁ
 - 1)è> 
Ï¡_lba
)))

57 
	}
}

59 
	#DEV_LOGICBS_ARRAY_SIZE
 (16è

	)

60 
	$ns_b®ªû_gc
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
, *
dev_logicbs_¬¿y
, 
wa™_gc_mask
)

62 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

63 
shªnÚ_dev
 *
sdev
 = 
NULL
;

64 
u32
 
sdev_id
;

65 
u64
 
Ï¡_jiff›s
;

67 ià(
wa™_gc_mask
) {

68 (
sdev_id
 = 
	`shªnÚ_fšd_fœ¡_b™
(&
wa™_gc_mask
, 
DEV_LOGICBS_ARRAY_SIZE
)) < DEV_LOGICBS_ARRAY_SIZE) {

69 
sdev
 = 
¥oŞ
->
sdevs
[
sdev_id
];

70 ià(
sdev
 =ğ
NULL
) {

71 
	`shªnÚ_”r
("sdev id = %d, buˆsdev dÛ¢`ˆexi¡ iÀpoŞ.\n", 
sdev_id
);

72 
	`BUG_ON
(1);

74 
Ï¡_jiff›s
 = 
	`g‘_jiff›s
();

75 ià(
sdev
->
sdisk
.
ex™
 || sdev->
¶ug_out
) {

76 
	`shªnÚ_ş—r_b™
(
sdev_id
, &
sbio
->
wa™_dev_pick_mask
);

77 
wa™_gc_mask
 &ğ~(1 << 
sdev_id
);

78 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

82 ià(
	`shªnÚ_‹¡_b™
(
sdev_id
, &
sbio
->
wa™_dev_pick_mask
) == 0) {

83 
	`BUG_ON
(
dev_logicbs_¬¿y
[
sdev_id
] == 0);

84 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

85 
wa™_gc_mask
 &ğ~(1 << 
sdev_id
);

86 
	`b®ªû_gc
(
sdev
, 
dev_logicbs_¬¿y
[
sdev_id
]);

88 ià((
ns
->
sdisk
.
´iÜ™y
 =ğ0è&& (
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) != 0)) {

89 
	`shªnÚ_wa™_ev’t
(
sdev
->
wa™_pick_ev’t
, (((
	`g‘_jiff›s
(è- 
Ï¡_jiff›s
è/ 
	`g‘_HZ
()è>ğ
BALANCE_GC_TIMEOUT
) || \

90 (
	`shªnÚ_‹¡_b™
(
sdev_id
, &
sbio
->
wa™_dev_pick_mask
è=ğ0è|| 
sdev
->
sdisk
.
ex™
 || sdev->
¶ug_out
);

92 
	`shªnÚ_ş—r_b™
(
sdev_id
, &
sbio
->
wa™_dev_pick_mask
);

94 ià(
sdev
->
sdisk
.
ex™
 || sdev->
¶ug_out
) {

95 
	`shªnÚ_ş—r_b™
(
sdev_id
, &
sbio
->
wa™_dev_pick_mask
);

96 
wa™_gc_mask
 &ğ~(1 << 
sdev_id
);

97 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

102 
sdev_id
 = 0; sdev_id < 
¥oŞ
->
sdev_couÁ
; sdev_id++) {

103 
sdev
 = 
¥oŞ
->
sdevs
[
sdev_id
];

104 ià(
sdev
 && 
dev_logicbs_¬¿y
[
sdev_id
])

105 
	`b®ªû_gc
(
sdev
, 
dev_logicbs_¬¿y
[
sdev_id
]);

108 
	}
}

110 
šlše
 
u32
 
	$g‘_sdev_šdex_äom_lba
(
shªnÚ_Çme¥aû
 *
ns
, 
logicb64_t
 
lba
)

112 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

114 ià(
¥oŞ
->
sdev_couÁ
 == 1)

116 ià((
¥oŞ
->
sdev_couÁ
 & (spool->sdev_count - 1)) == 0)

117  (
lba
 >> 
ns
->
¡r_size_shiá
è& (
¥oŞ
->
sdev_couÁ
 - 1);

119  (
lba
 >> 
ns
->
¡r_size_shiá
è% 
¥oŞ
->
sdev_couÁ
;

120 
	}
}

122 
	$ns_upd©e_io_¡©i¡ics
(
shªnÚ_Çme¥aû
 *
ns
)

124 
u64
 
ho¡_wr™e_ios_Ï¡
;

125 
u64
 
ho¡_wr™e_m£cs_Ï¡
;

126 
u64
 
ho¡_»ad_ios_Ï¡
;

127 
u64
 
ho¡_»ad_m£cs_Ï¡
;

128 
jiff›s_d–
;

129 
u£c_–­£d
 = 0;

130 
æags
;

132 
æags
 = 
	`shªnÚ_¥š_lock_œq§ve
(&
ns
->
io_¡©i¡ics_lock
);

134 
jiff›s_d–
 = ()
	`g‘_jiff›s
(è- ()
ns
->
Ï¡_jiff›s
;

135 
u£c_–­£d
 = 
	`shªnÚ_jiff›s_to_u£cs
(
jiff›s_d–
);

136 ià(
u£c_–­£d
 < 300000) {

137 
	`shªnÚ_¥š_uÆock_œq»¡Üe
(&
ns
->
io_¡©i¡ics_lock
, 
æags
);

140 
ns
->
Ï¡_jiff›s
 = 
	`g‘_jiff›s
();

143 
ho¡_wr™e_ios_Ï¡
 = 
ns
->
ho¡_wr™e_ios
;

144 
ho¡_wr™e_m£cs_Ï¡
 = 
ns
->
ho¡_wr™e_m£cs
;

146 
ho¡_»ad_ios_Ï¡
 = 
ns
->
ho¡_»ad_ios
;

147 
ho¡_»ad_m£cs_Ï¡
 = 
ns
->
ho¡_»ad_m£cs
;

150 
ns
->
ho¡_wr™e_£ùÜs
 = 
	`ns_have_wr™‹n_£ùÜs
(ns);

151 
ns
->
ho¡_wr™e_ios
 = 
	`ns_have_wr™‹n_ios
(ns);

152 
ns
->
ho¡_wr™e_m£cs
 = 
	`ns_have_wr™‹n_m£cs
(ns);

154 
ns
->
ho¡_»ad_£ùÜs
 = 
	`ns_have_»ad_£ùÜs
(ns);

155 
ns
->
ho¡_»ad_ios
 = 
	`ns_have_»ad_ios
(ns);

156 
ns
->
ho¡_»ad_m£cs
 = 
	`ns_have_»ad_m£cs
(ns);

158 ià(
u£c_–­£d
 > 0) {

159 
ns
->
ho¡_wr™e_bªdwidth
 = (ns->
ho¡_wr™e_£ùÜs
 -‚s->
ho¡_wr™e_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

160 
ns
->
ho¡_wr™e_iİs
 = (ns->
ho¡_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
è* 1000000 / 
u£c_–­£d
;

161 
ns
->
ho¡_wr™e_Ï‹ncy
 = (ns->
ho¡_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
) ? \

162 (
ns
->
ho¡_wr™e_m£cs
 - 
ho¡_wr™e_m£cs_Ï¡
è* 1000 / (ns->
ho¡_wr™e_ios
 - 
ho¡_wr™e_ios_Ï¡
) : 0;

163 
ns
->
ho¡_»ad_bªdwidth
 = (ns->
ho¡_»ad_£ùÜs
 -‚s->
ho¡_»ad_£ùÜs_Ï¡
è/ 2 * 1000000 / 
u£c_–­£d
;

164 
ns
->
ho¡_»ad_iİs
 = (ns->
ho¡_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
è* 1000000 / 
u£c_–­£d
;

165 
ns
->
ho¡_»ad_Ï‹ncy
 = (ns->
ho¡_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
) ? \

166 (
ns
->
ho¡_»ad_m£cs
 - 
ho¡_»ad_m£cs_Ï¡
è* 1000 / (ns->
ho¡_»ad_ios
 - 
ho¡_»ad_ios_Ï¡
) : 0;

170 
ns
->
ho¡_wr™e_£ùÜs_Ï¡
 =‚s->
ho¡_wr™e_£ùÜs
;

171 
ns
->
ho¡_»ad_£ùÜs_Ï¡
 =‚s->
ho¡_»ad_£ùÜs
;

173 
	`shªnÚ_¥š_uÆock_œq»¡Üe
(&
ns
->
io_¡©i¡ics_lock
, 
æags
);

176 
	}
}

180 
shªnÚ_g’disk_t
 *
	$g‘_g’disk_äom_ns
(
shªnÚ_Çme¥aû
 *
ns
)

182  
ns
->
sdisk
.
gd
;

183 
	}
}

185 
	$ns_g‘_logicb_size
(
shªnÚ_Çme¥aû
 *
ns
)

187  
ns
->
logicb_size
;

188 
	}
}

190 
	$ns_g‘_logicb_shiá
(
shªnÚ_Çme¥aû
 *
ns
)

192  
ns
->
logicb_shiá
;

193 
	}
}

195 
shªnÚ_poŞ
 *
	$ns_g‘_poŞ
(
shªnÚ_Çme¥aû
 *
ns
)

197  
ns
->
poŞ
;

198 
	}
}

200 
shªnÚ_disk
 *
	$g‘_shªnÚ_disk_äom_ns
(
shªnÚ_Çme¥aû
 *
ns
)

202  &
ns
->
sdisk
;

203 
	}
}

205 
u64
 
	$poŞ_u£d_logicbs
(
shªnÚ_poŞ
 *
¥
)

207  
	`shªnÚ_©omic64_»ad
(&
¥
->
u£d_logicbs
);

208 
	}
}

210 
u64
 
	$poŞ_avaabË_ÿp
(
shªnÚ_poŞ
 *
¥
)

212  
¥
->
avaabË_ÿ·c™y
;

213 
	}
}

215 
	$shªnÚ_check_avaab™y_ns
(
shªnÚ_Çme¥aû
 *
ns
)

217 ià(
	`uÆik–y
(
ns
->
poŞ
->
ex™
)) {

218 
	`shªnÚ_”r
("pool isƒxiting!\n");

222 ià(
	`uÆik–y
(
ns
->
poŞ
->
¡©e
 & 
SHN_STATE_ERROR_BIT
)) {

223 
	`shªnÚ_”r
("poŞ->¡©e=0x%x\n", 
ns
->
poŞ
->
¡©e
);

227 ià(
ns
->
sdisk
.
©ched
 =ğ
SHN_DISK_DETACHED
) {

228 
	`shªnÚ_”r
("Çme¥aû%d‡Ì—dy d‘ached.\n", 
ns
->
idx
);

233 
	}
}

235 
	$shªnÚ_disk_»adÚly_ns
(
shªnÚ_Çme¥aû
 *
ns
)

237 ià(
	`uÆik–y
(
ns
->
poŞ
->
acûss_mode
 =ğ
SHN_MODE_READONLY
)) {

238 
	`shªnÚ_w¬n
("pool->access_mode is„eadonly!\n");

242 
	}
}

244 
u64
 
	$g‘_shªnÚ_ns_£ùÜs
(
shªnÚ_Çme¥aû
 *
ns
)

246  
ns
->
sdisk
.
£ùÜs
;

247 
	}
}

249 
	$shªnÚ_disÿrd_ns
(
shªnÚ_Çme¥aû
 *
ns
, 
logicb64_t
 
¡¬t_lba
,†ogicb64_ˆ
’d_lba
, 
d–_ns
)

251 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

252 
i
, 
j
;

253 
logicb64_t
 
lba
, 
fœ¡_lba
, 
fœ¡_¦Ù
, 
¦Ù
;

254 
lun_pba
 
Şd_pba
;

255 
shªnÚ_dev
 *
sdev
;

256 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

257 
u64
 
logicbs_disÿrded
 = 0;

260 ià(
¥oŞ
->
acûss_mode
 =ğ
SHN_MODE_READONLY
)

262 
	`debugs1
("¡¬t_lba=%d, couÁ=%d.\n", 
¡¬t_lba
, 
’d_lba
 - start_lba);

263 ià(
¡¬t_lba
 >ğ
’d_lba
)

266 
j
 = 0; j < 
ns
->
poŞ
->
sdev_couÁ
; j++) {

267 
u64
 
tmp
;

268 
sdev
 = 
ns
->
poŞ
->
sdevs
[
j
];

269 
	`BUG_ON
(
j
 !ğ
sdev
->
sdev_id
);

270 
tmp
 = 
¡¬t_lba
 / (
ns
->
¡r_size
 *‚s->
poŞ
->
sdev_couÁ
);

271 ià(((
¡¬t_lba
 % (
ns
->
¡r_size
 *‚s->
poŞ
->
sdev_couÁ
)è>>‚s->
¡r_size_shiá
è=ğ
sdev
->
sdev_id
)

272 
fœ¡_lba
 = 
¡¬t_lba
;

273 ià(((
¡¬t_lba
 % (
ns
->
¡r_size
 *‚s->
poŞ
->
sdev_couÁ
)è>>‚s->
¡r_size_shiá
è< 
sdev
->
sdev_id
)

274 
fœ¡_lba
 = 
tmp
 * (
ns
->
¡r_size
 *‚s->
poŞ
->
sdev_couÁ
è+ 
sdev
->
sdev_id
 *‚s->strip_size;

276 
fœ¡_lba
 = (
tmp
 + 1è* (
ns
->
¡r_size
 *‚s->
poŞ
->
sdev_couÁ
è+ 
sdev
->
sdev_id
 *‚s->strip_size;

278 
fœ¡_¦Ù
 = 
	`g‘_¦Ù_äom_Ímt
(
sdisk
, 
fœ¡_lba
);

279 
i
 = 0; i < 
LOCK_COUNT
; i++) {

280 
¦Ù
 = 
fœ¡_¦Ù
 + 
i
;

281 
lba
 = 
	`g‘_lba_äom_Ímt_¦Ù
(
sdev
, 
sdisk
, 
¦Ù
);

282 ià(
lba
 >ğ
’d_lba
)

284 
	`Ímt_lock
(
sdev
, 
sdisk
, 
lba
);

286 
	`g‘_lun_pba_äom_lba
(
lba
, &
Şd_pba
, 
NULL
, 
sdisk
);

287 ià((
Şd_pba
.
lun_pba
 !ğ0x03ffffffè&& (
d–_ns
 || !
	`‹¡_wr™e_š_´oûss
(
sdev
, &old_pba))) {

288 
	`upd©e_m­pšg_bË
(
sdisk
, 
lba
, 0x3ff, 0x03ffffff);

289 
	`£t_Şd_pba_¡®e
(
sdev
, 
Şd_pba
.
lun
, old_pba.
lun_pba
);

290 
	`shªnÚ_©omic64_dec
(&
sdev
->
¥oŞ
->
u£d_logicbs
);

295 ià(++
logicbs_disÿrded
 >= 2000) {

296 
logicbs_disÿrded
 = 0;

297 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
lba
);

298 
	`shªnÚ_cÚd_»sched
();

299 
	`Ímt_lock
(
sdev
, 
sdisk
, 
lba
);

301 
¦Ù
 +ğ
LOCK_COUNT
;

302 
lba
 = 
	`g‘_lba_äom_Ímt_¦Ù
(
sdev
, 
sdisk
, 
¦Ù
);

303 } 
lba
 < 
’d_lba
);

304 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
lba
);

307 
	}
}

309 
	$poŞ_deãr_gc_tim”
(
shªnÚ_poŞ
 *
¥oŞ
)

311 
shªnÚ_dev
 *
sdev
;

312 
i
;

314 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

315 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

316 ià(
	`shªnÚ_tim”_³ndšg
(&
sdev
->
gc_tim”
))

317 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 10);

319 
	}
}

321 
	$ns_fs_bio_»ad_ÿÎback
(
shªnÚ_bio
 *
sbio
)

323 
shªnÚ_Çme¥aû
 *
ns
 = (shªnÚ_Çme¥aû *)
sbio
->
d©a
;

324 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

325 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

326 
shªnÚ_dev
 *
sdev
;

327 
shªnÚ_»que¡
 *
»q
, *
tmp
;

329 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

330 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

331 
sdev
 = 
¥oŞ
->
sdevs
[
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
)];

332 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg
,„eq->
dma_dœ
);

333 ià(
»q
->
sg2
)

334 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg2
,„eq->
dma_dœ
);

335 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

336 
fœ¡_size
 = 
ns
->
logicb_size
 - (()
»q
->
vœt_addr
 & (ns->logicb_size - 1));

337 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
fœ¡_size
);

338 ià(
fœ¡_size
 < 
ns
->
logicb_size
)

339 
	`shªnÚ_memıy
(
»q
->
vœt_addr_2
,„eq->
»cov”_buf
 + 
fœ¡_size
, 
ns
->
logicb_size
 - first_size);

340 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

342 ià(
	`uÆik–y
(
sbio
->
¡©us
))

343 
	`shªnÚ_”r
("lba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n",

344 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

346 
	`ä“_»q
(
»q
);

349 
	`shªnÚ_com¶‘e_fs_io
(
sdisk
->
ho¡d©a
, sdisk->
gd
, 
sbio
);

350 
	`deü—£_ns_³ndšg_bios
(
ns
);

351 ià(
sbio
->
sg_couÁ
)

352 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

354 
sbio
->
Ï‹ncy
 = ((
	`g‘_jiff›s
(è- sbio->
¡¬t_time
è* 1000è/ 
	`g‘_HZ
();

355 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
)

356 
	`»cÜd_Ï‹ncy
(
sdisk
, 
sbio
);

357 
	`ä“_sbio
(
sbio
);

358 
	}
}

360 
	$ns_fs_bio_wr™e_ÿÎback
(
shªnÚ_bio
 *
sbio
)

362 
shªnÚ_Çme¥aû
 *
ns
 = (shªnÚ_Çme¥aû *)
sbio
->
d©a
;

363 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

364 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

365 
shªnÚ_»que¡
 *
»q
, *
tmp
;

366 
shªnÚ_dev
 *
sdev
;

367 
shªnÚ_sb
 *
sb
 = 
NULL
, *
Ï¡_sb
 = NULL;

368 
logicbs
 = 0;

370 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

371 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

372 
sdev
 = 
¥oŞ
->
sdevs
[
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
)];

373 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg
,„eq->
dma_dœ
);

374 ià(
»q
->
sg2
)

375 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg2
,„eq->
dma_dœ
);

376 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

377 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

378 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

379 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

380 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

381 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

383 
	`shªnÚ_šfo
("%s: sbio->¡¬t_£ùÜ=0x%lx, sbio->¡©us=0x%x.\n", 
__func__
, 
sbio
->
¡¬t_£ùÜ
, sbio->
¡©us
);

384 ià((
Ï¡_sb
 =ğ
NULL
è|| (Ï¡_sb =ğ
sb
))

385 
logicbs
++;

387 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

388 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
sdev
->
š_æight_wr™es
);

389 
logicbs
 = 1;

391 
Ï¡_sb
 = 
sb
;

393 
	`ä“_»q
(
»q
);

396 ià(
logicbs
) {

397 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

398 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
sdev
->
š_æight_wr™es
);

401 
	`shªnÚ_com¶‘e_fs_io
(
sdisk
->
ho¡d©a
, sdisk->
gd
, 
sbio
);

402 
	`deü—£_ns_³ndšg_bios
(
ns
);

403 ià(
sbio
->
sg_couÁ
)

404 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

406 
sbio
->
Ï‹ncy
 = ((
	`g‘_jiff›s
(è- sbio->
¡¬t_time
è* 1000è/ 
	`g‘_HZ
();

407 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
)

408 
	`»cÜd_Ï‹ncy
(
sdisk
, 
sbio
);

409 
	`ä“_sbio
(
sbio
);

410 
	}
}

412 
	$ns_subm™_®igÃd_»ad_bio
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
)

414 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

415 
shªnÚ_dev
 *
sdev
, *
Ï¡_sdev
 = 
NULL
;

416 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

417 
shªnÚ_sg_li¡_t
 *
sg
;

418 
shªnÚ_»que¡
 *
»q
 = 
NULL
;

419 
shªnÚ_sb
 *
sb
 = 
NULL
;

420 
i
, 
»t
, 
logicbs
;

421 
u64
 
¡¬t_£ùÜ
 = 
sbio
->start_sector;

422 
lun_pba
†un_pba;

423 
fœ¡_size
, 
Ï¡_size
 = 0;

424 
Ï¡_lun
 = -1, 
lun_logicbs
 = 0;

426 
logicbs
 = 
sbio
->
bio_size
 >> 
ns
->
logicb_shiá
;

427 
sbio
->
logicbs
 =†ogicbs;

428 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
logicbs
);

430 
sbio
->
ÿÎback
 = 
ns_fs_bio_»ad_ÿÎback
;

431 
sbio
->
d©a
 = 
ns
;

432 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

434 
sg
 = 
sbio
->sg;

435 
i
 = 0; i < 
logicbs
; i++) {

436 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

437 #ifdeà
CONFIG_SHANNON_DEBUG


438 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 
i
);

440 
»q
->
£nd”
 = 
FROM_HOST
;

441 
»q
->
sbio
 = sbio;

442 
	`£t_»q_šdex
(
»q
, 
i
);

443 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

444 
»q
->
İcode
 = 
sh_cmd_»ad
;

445 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

446 
»q
->
ns_id
 = 
ns
->
idx
;

447 
»q
->
ns_£q_num
 = 
ns
->
£q_num
;

448 
»q
->
lba
 = (
¡¬t_£ùÜ
 >> (
ns
->
logicb_shiá
 - 9)è+ 
i
;

449 
»q
->
Ëngth
 = 
ns
->
logicb_size
;

450 
»q
->
sg
 = sg;

451 
»q
->
vœt_addr
 = 
	`shªnÚ_sg_vœt
(
sg
);

452 
fœ¡_size
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

454 
sdev
 = 
¥oŞ
->
sdevs
[
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
)];

455 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
sg
,„eq->
dma_dœ
);

456 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

457 ià(()
»q
->
vœt_addr
 & (»q->
Ëngth
 - 1)) {

458 
»q
->
sg2
 = 
sg
;

459 
»q
->
vœt_addr_2
 = 
	`shªnÚ_sg_vœt
(
sg
);

460 
Ï¡_size
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

461 
»q
->
dma_add»ss_2
 = 
	`shªnÚ_dma_m­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
sg
,„eq->
dma_dœ
);

462 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

463 
	`BUG_ON
((
fœ¡_size
 + 
Ï¡_size
è!ğ
sdev
->
logicb_size
);

465 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

466 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
lun_pba
, 
NULL
, 
sdisk
);

467 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

468 ià(
»t
 < 0) {

469 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0, 
fœ¡_size
);

470 ià(
»q
->
vœt_addr_2
)

471 
	`shªnÚ_mem£t
(
»q
->
vœt_addr_2
, 0, 
Ï¡_size
);

472 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

475 
»q
->
pba
.
lun_pba
 =†un_pba.lun_pba;

476 
»q
->
pba
.
lun
 = 
lun_pba
.lun;

477 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

478 
»q
->
£q_num
 = 
sb
->seq_num;

479 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

480 ià(
Ï¡_sdev
 && ((
Ï¡_lun
 !ğ
lun_pba
.
lun
è|| (Ï¡_sdev !ğ
sdev
))) {

481 
	`lun£t_pick_»que¡
(
Ï¡_sdev
->
lun
[
Ï¡_lun
]->
lun£t
, 
lun_logicbs
);

482 
lun_logicbs
 = 0;

484 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[
lun_pba
.lun], 
»q
);

485 
Ï¡_sdev
 = 
sdev
;

486 
Ï¡_lun
 = 
lun_pba
.
lun
;

487 
lun_logicbs
++;

489 ià(
Ï¡_sdev
) {

490 
	`lun£t_pick_»que¡
(
Ï¡_sdev
->
lun
[
Ï¡_lun
]->
lun£t
, 
lun_logicbs
);

493 
	}
}

495 
šlše
 
	$check_poŞ_ä“_block
(
shªnÚ_poŞ
 *
¥oŞ
)

497 
shªnÚ_dev
 *
sdev
;

498 
i
;

500 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

501 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

502 ià(
sdev
 && sdev->
ä“_blkút
 < 
GC_THRESHOLD_N3
)

503 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
block_ho¡_wr
, (sdev->
sdisk
.
ex™
 || (sdev->
ä“_blkút
 >ğ
GC_THRESHOLD_N3
)));

505 
	}
}

507 
šlše
 
	$check_poŞ_»q_queue_Ëngth
(
shªnÚ_poŞ
 *
¥oŞ
, 
´iÜ™y
)

509 
shªnÚ_dev
 *
sdev
;

510 
i
;

511 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

512 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

513 ià(
sdev
) {

514 ià(
´iÜ™y
) {

515 ià((
sdev
->
š_block_¡©e
 < 2è&& (
	`shªnÚ_©omic_»ad
(&sdev->
wr™e_»qs
[1]è>ğ
REQ_QUEUE_THRESHOLD_H
))

516 
sdev
->
š_block_¡©e
 = 2;

517 ià(
sdev
->
š_block_¡©e
 == 2) {

518 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
lim™_»q_queue
[1], \

519 (
sdev
->
sdisk
.
ex™
 || (sdev->
š_block_¡©e
 < 2è|| (
	`shªnÚ_©omic_»ad
(&sdev->
wr™e_»qs
[1]è< 
REQ_QUEUE_THRESHOLD_L
)));

522 ià((
sdev
->
š_block_¡©e
 =ğ0è&& (
	`ho¡_»q_queue_Ëngth
(sdevè>ğ
REQ_QUEUE_THRESHOLD_H
))

523 
sdev
->
š_block_¡©e
 = 1;

524 ià(
sdev
->
š_block_¡©e
)

525 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
lim™_»q_queue
[0], \

526 (
sdev
->
sdisk
.
ex™
 || (sdev->
š_block_¡©e
 =ğ0è|| (
	`ho¡_»q_queue_Ëngth
(sdevè< 
REQ_QUEUE_THRESHOLD_L
)));

530 
	}
}

532 
šlše
 
	$sdev_subm™_wr™e_»que¡
(
shªnÚ_dev
 *
sdev
, 
dev_logicbs
, 
pick_š_´oûss
, 
fl_h—d
)

534 
	`shªnÚ_©omic_add
(
dev_logicbs
, &
sdev
->
š_æight_wr™es
);

535 ià(
pick_š_´oûss
)

536 
	`shªnÚ_pick_»que¡
(
sdev
, 
dev_logicbs
);

538 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

539 
	`mod_fl_chunk_tim”
(
sdev
, 
fl_h—d
);

540 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
)

541 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 4);

542 #ifdeà
CONFIG_SHANNON_STATISTICS


543 
	`shªnÚ_©omic_add
(
dev_logicbs
, &
sdev
->
äom_ho¡
);

545 
	}
}

547 
	$ns_subm™_®igÃd_wr™e_bio
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
)

549 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

550 
shªnÚ_dev
 *
sdev
, *
Ï¡_sdev
 = 
NULL
;

551 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

552 
shªnÚ_»que¡
 *
»q
;

553 
shªnÚ_sg_li¡_t
 *
sg
;

554 
u64
 
¡¬t_£ùÜ
 = 
sbio
->start_sector;

555 
logicb64_t
 
Ï¡_lba
;

556 
dev_logicbs
 = 0, 
fl_h—d
 = 0, 
h—d_šdex
 = 0;

557 
i
, 
logicbs
;

558 
shªnÚ_li¡_h—d
 
wr™e_li¡
;

559 
šdex
, 
dev_logicbs_¬¿y
[
DEV_LOGICBS_ARRAY_SIZE
] = {};

560 
wa™_gc_mask
 = 0;

561 
¡ack_size
;

563 
	`check_poŞ_ä“_block
(
¥oŞ
);

564 
	`check_poŞ_»q_queue_Ëngth
(
¥oŞ
, 
ns
->
sdisk
.
´iÜ™y
);

566 
¡ack_size
 = (()&¡ack_sizeè& (
THREAD_SIZE
-1);

567 
¡ack_size
 = 
THREAD_SIZE
 - stack_size;

569 
logicbs
 = 
sbio
->
bio_size
 >> 
ns
->
logicb_shiá
;

570 
Ï¡_lba
 = 
logicbs
 + (
¡¬t_£ùÜ
 >> (
ns
->
logicb_shiá
 - 9)) - 1;

571 
sbio
->
logicbs
 =†ogicbs;

572 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, 
logicbs
);

574 
sbio
->
ÿÎback
 = 
ns_fs_bio_wr™e_ÿÎback
;

575 
sbio
->
d©a
 = 
ns
;

576 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

578 
sg
 = 
sbio
->sg;

579 
	`SHANNON_INIT_LIST_HEAD
(&
wr™e_li¡
);

580 
i
 = 0; i < 
logicbs
; i++) {

581 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

582 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 
i
);

583 
»q
->
£nd”
 = 
FROM_HOST
;

584 
»q
->
sbio
 = sbio;

585 
	`£t_»q_šdex
(
»q
, 
i
);

586 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

587 
»q
->
İcode
 = 
sh_cmd_wr™e
;

588 
»q
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

589 
»q
->
d©©y³
 = 
LONG_LBA
;

590 
»q
->
ns_id
 = 
ns
->
idx
;

591 
»q
->
ns_£q_num
 = 
ns
->
£q_num
;

592 
»q
->
lba
 = (
¡¬t_£ùÜ
 >> (
ns
->
logicb_shiá
 - 9)è+ 
i
;

593 
»q
->
Ëngth
 = 
ns
->
logicb_size
;

594 
»q
->
sg
 = sg;

595 
»q
->
vœt_addr
 = 
	`shªnÚ_sg_vœt
(
sg
);

596 
šdex
 = 
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
);

597 
sdev
 = 
¥oŞ
->
sdevs
[
šdex
];

598 ià(
	`is_Ï¡_wr™e_»q_š_dev
(
ns
, 
sdev
, 
»q
, 
Ï¡_lba
)) {

599 
	`£t_»q_wa™_pick
(
»q
);

600 
	`BUG_ON
(
	`shªnÚ_‹¡_b™
(
sdev
->
mbr
.
sdev_id
, &
sbio
->
wa™_dev_pick_mask
));

601 
	`shªnÚ_£t_b™
(
sdev
->
mbr
.
sdev_id
, &
sbio
->
wa™_dev_pick_mask
);

602 
wa™_gc_mask
 |ğ1 << 
sdev
->
mbr
.
sdev_id
;

603 
	`shªnÚ_©omic_šc
(&
sbio
->
u£r_couÁ
);

604 ià(
	`uÆik–y
(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
b®ªû_gc_tim”
)))

605 
	`shªnÚ_mod_tim”
(&
sdev
->
b®ªû_gc_tim”
, 
	`g‘_jiff›s
(è+ 
BALANCE_GC_TIMEOUT
 * 
	`g‘_HZ
());

607 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
sg
,„eq->
dma_dœ
);

608 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

609 ià(()
»q
->
vœt_addr
 & (»q->
Ëngth
 - 1)) {

610 
»q
->
sg2
 = 
sg
;

611 
»q
->
vœt_addr_2
 = 
	`shªnÚ_sg_vœt
(
sg
);

612 
»q
->
dma_add»ss_2
 = 
	`shªnÚ_dma_m­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
sg
,„eq->
dma_dœ
);

613 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

615 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

616 
	`ho¡_g‘_h—d_ªd_£t_pba_bË
(
sdev
, 
sdisk
, 
sbio
->
bio
, 
»q
);

617 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

618 
	`£t_lun_pba_šv®id
(&
»q
->
pba
);

619 
h—d_šdex
 = 
»q
->
h—d
 & 
HEAD_INDEX_MASK
;

620 
dev_logicbs_¬¿y
[
šdex
]++;

622 ià((
Ï¡_sdev
 =ğ
NULL
è|| (Ï¡_sdev =ğ
sdev
)) {

623 
dev_logicbs
++;

624 
fl_h—d
 |ğ(1 << 
h—d_šdex
);

626 
	`add_wr™e_li¡_to_»que¡_queue_
(
Ï¡_sdev
, &
wr™e_li¡
, 
dev_logicbs
, 
ns
->
sdisk
.
´iÜ™y
);

627 
	`sdev_subm™_wr™e_»que¡
(
Ï¡_sdev
, 
dev_logicbs
, 0, 
fl_h—d
);

629 
	`SHANNON_INIT_LIST_HEAD
(&
wr™e_li¡
);

630 
dev_logicbs
 = 1;

631 
fl_h—d
 = 1 << 
h—d_šdex
;

633 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
wr™e_li¡
);

634 
Ï¡_sdev
 = 
sdev
;

636 ià(
dev_logicbs
) {

637 
	`add_wr™e_li¡_to_»que¡_queue_
(
Ï¡_sdev
, &
wr™e_li¡
, 
dev_logicbs
, 
ns
->
sdisk
.
´iÜ™y
);

638 
	`sdev_subm™_wr™e_»que¡
(
Ï¡_sdev
, 
dev_logicbs
, 
¡ack_size
 > 4096 ? 0 : 1, 
fl_h—d
);

641 
	`ns_b®ªû_gc
(
ns
, 
sbio
, 
dev_logicbs_¬¿y
, 
wa™_gc_mask
);

644 
	}
}

646 
	$ns_subm™_®igÃd_bio
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
)

648 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_FROMDEVICE
)

649 
	`ns_subm™_®igÃd_»ad_bio
(
ns
, 
sbio
);

650 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
)

651 
	`ns_subm™_®igÃd_wr™e_bio
(
ns
, 
sbio
);

654 
	}
}

657 
	$ns_nÚ®igÃd_»ad_bio_ÿÎback
(
shªnÚ_bio
 *
sbio
)

659 
shªnÚ_Çme¥aû
 *
ns
 = (shªnÚ_Çme¥aû *)
sbio
->
d©a
;

660 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

661 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

662 
shªnÚ_dev
 *
sdev
;

663 
logicb_size
 = 
ns
->logicb_size;

664 
shªnÚ_»que¡
 *
»q
, *
tmp
;

666 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

667 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

668 
sdev
 = 
¥oŞ
->
sdevs
[
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
)];

669 ià(
»q
->
Ëngth
 =ğ
ns
->
logicb_size
) {

670 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg
,„eq->
dma_dœ
);

671 ià(
»q
->
vœt_addr_2
)

672 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg2
,„eq->
dma_dœ
);

674 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

675 
fœ¡_size
 = 
logicb_size
 - (()
»q
->
vœt_addr
 & (logicb_size - 1));

676 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
fœ¡_size
);

677 ià(
fœ¡_size
 < 
ns
->
logicb_size
)

678 
	`shªnÚ_memıy
(
»q
->
vœt_addr_2
,„eq->
»cov”_buf
 + 
fœ¡_size
, 
logicb_size
 - first_size);

679 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

681 ià(
	`uÆik–y
(
sbio
->
¡©us
))

682 
	`shªnÚ_šfo
("%s():†ba=%ld,†un=%d,†un_pba=%d,ƒcc=0x%x,„eread=0x%x.\n",

683 
__func__
, 
»q
->
lba
,„eq->
pba
.
lun
,„eq->pba.
lun_pba
,„eq->
_ecc
,„eq->
»»ad
);

685 
	`ä“_»q
(
»q
);

688 
	`shªnÚ_com¶‘e_fs_io
(
sdisk
->
ho¡d©a
, sdisk->
gd
, 
sbio
);

689 
	`deü—£_ns_³ndšg_bios
(
ns
);

690 ià(
sbio
->
sg_couÁ
)

691 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

693 
sbio
->
Ï‹ncy
 = ((
	`g‘_jiff›s
(è- sbio->
¡¬t_time
è* 1000è/ 
	`g‘_HZ
();

694 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
)

695 
	`»cÜd_Ï‹ncy
(
sdisk
, 
sbio
);

697 
	`ä“_sbio
(
sbio
);

699 
	}
}

701 
	$ns_nÚ®igÃd_wr™e_bio_ÿÎback
(
shªnÚ_bio
 *
sbio
)

703 
shªnÚ_Çme¥aû
 *
ns
 = (shªnÚ_Çme¥aû *)
sbio
->
d©a
;

704 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

705 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

706 
shªnÚ_dev
 *
sdev
;

707 
logicb_size
 = 
ns
->logicb_size;

708 
shªnÚ_»que¡
 *
»q
, *
tmp
;

709 
shªnÚ_sb
 *
sb
 = 
NULL
, *
Ï¡_sb
 = NULL;

710 
logicbs
 = 0;

712 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

713 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

714 
sdev
 = 
¥oŞ
->
sdevs
[
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
)];

715 
	`shªnÚ_©omic_dec
(&
sdev
->
š_æight_wr™es
);

716 ià(
»q
->
Ëngth
 =ğ
logicb_size
) {

717 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg
,„eq->
dma_dœ
);

718 ià(
»q
->
vœt_addr_2
)

719 
	`shªnÚ_dma_unm­_Úe_sg_·ge
(
sdev
->
pci_dev
, 
»q
->
sg2
,„eq->
dma_dœ
);

720 ià(
	`lik–y
(!
	`lun_pba_is_šv®id
(&
»q
->
pba
))) {

721 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

722 ià(
	`lik–y
(
sbio
->
¡©us
 == 0)) {

723 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

724 
	`wr™e_»que¡_dÚe
(
sdev
, 
sdisk
, 
»q
);

725 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

727 
	`shªnÚ_šfo
("%s: sbio->¡¬t_£ùÜ=0x%lx, sbio->¡©us=0x%x.\n", 
__func__
, 
sbio
->
¡¬t_£ùÜ
, sbio->
¡©us
);

728 ià((
Ï¡_sb
 =ğ
NULL
è|| (Ï¡_sb =ğ
sb
))

729 
logicbs
++;

731 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

732 
logicbs
 = 1;

734 
Ï¡_sb
 = 
sb
;

737 
	`ä“_»q
(
»q
);

740 ià(
logicbs
) {

741 
	`shªnÚ_©omic_sub
(
logicbs
, &
Ï¡_sb
->
š_wr™e_logicbs
);

744 
	`shªnÚ_com¶‘e_fs_io
(
sdisk
->
ho¡d©a
, sdisk->
gd
, 
sbio
);

745 
	`deü—£_ns_³ndšg_bios
(
ns
);

746 ià(
sbio
->
sg_couÁ
)

747 
	`shªnÚ_sg_ä“
(
sbio
->
sg
, sbio->
sg_couÁ
);

749 
sbio
->
Ï‹ncy
 = ((
	`g‘_jiff›s
(è- sbio->
¡¬t_time
è* 1000è/ 
	`g‘_HZ
();

750 ià(
sdisk
->
´št_Ï‹ncy_š‹rv®
)

751 
	`»cÜd_Ï‹ncy
(
sdisk
, 
sbio
);

753 
	`ä“_sbio
(
sbio
);

754 
	}
}

756 
	$ns_subm™_nÚ®igÃd_bio
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
, 
fœ¡_size
)

758 
shªnÚ_poŞ
 *
¥oŞ
 = 
ns
->
poŞ
;

759 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

760 
shªnÚ_dev
 *
sdev
 = 
NULL
;

761 
shªnÚ_»que¡
 *
»q
;

762 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
, *
Ãxt_sg
 = NULL;

763 
i
, 
»mašed_size
, 
undÚe
 = 0;

764 
dev_logicbs_¬¿y
[
DEV_LOGICBS_ARRAY_SIZE
] = {};

765 
wa™_gc_mask
 = 0;

766 
logicb64_t
 
Ï¡_lba
 = (
sbio
->
¡¬t_£ùÜ
 >> (
ns
->
logicb_shiá
 - 9)è+ ((sbio->
bio_size
 - 
fœ¡_size
è/ 
	`ns_g‘_logicb_size
(ns));

767 
u64
 
¡¬t_off£t
;

770 
sdisk
->
nÚ®igÃd_bios
++;

771 
sbio
->
d©a
 = 
ns
;

772 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

773 
sbio
->
ÿÎback
 = 
ns_nÚ®igÃd_wr™e_bio_ÿÎback
;

774 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

776 
	`check_poŞ_ä“_block
(
¥oŞ
);

777 
	`check_poŞ_»q_queue_Ëngth
(
¥oŞ
, 
ns
->
sdisk
.
´iÜ™y
);

779 ià(
	`uÆik–y
(
sdisk
->
ex™
)) {

780 
	`shªnÚ_w¬n
("the disk is‡bsent!\n");

781  -
EIO
;

784 
sbio
->
ÿÎback
 = 
ns_nÚ®igÃd_»ad_bio_ÿÎback
;

785 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

788 
sbio
->
logicbs
 = 
	`ÿlcuÏ‹_nÚ®igÃd_bio_u£r_couÁ
(sbio, 
ns
->
logicb_size
, 
fœ¡_size
);

789 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
 + 1);

792 ià(
fœ¡_size
) {

793 
»mašed_size
 = 
fœ¡_size
;

794 
undÚe
 = 1;

796 
»mašed_size
 = 
ns
->
logicb_size
;

797 
undÚe
 = 0;

800 
¡¬t_off£t
 = 
sbio
->
¡¬t_£ùÜ
 << 9;

801 
sg
 = 
sbio
->sg;

802 
i
 = 0;

803 
sg
 && 
	`shªnÚ_sg_·ge
(sg)) {

804 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

805 #ifdeà
CONFIG_SHANNON_DEBUG


806 
	`£t_»q_debug_g
(
»q
, 
sbio
->
g
, 
i
);

808 
»q
->
£nd”
 = 
FROM_HOST
;

809 
»q
->
sbio
 = sbio;

810 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

811 
	`£t_»q_šdex
(
»q
, 
i
);

812 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

813 
»q
->
dma_dœ
 = 
sbio
->dma_dir;

814 
»q
->
sg
 = sg;

815 
»q
->
vœt_addr
 = 
	`shªnÚ_sg_vœt
(
sg
);

816 
»q
->
Ëngth
 = 
	`shªnÚ_sg_Ëngth
(
sg
);

817 
»q
->
¡¬t_off£t
 = start_offset;

818 
»q
->
ns_id
 = 
ns
->
idx
;

819 
»q
->
ns_£q_num
 = 
ns
->
£q_num
;

820 
»q
->
lba
 = 
¡¬t_off£t
 >> 
ns
->
logicb_shiá
;

821 
sdev
 = 
¥oŞ
->
sdevs
[
	`g‘_sdev_šdex_äom_lba
(
ns
, 
»q
->
lba
)];

822 ià(
	`is_Ï¡_wr™e_»q_š_dev
(
ns
, 
sdev
, 
»q
, 
Ï¡_lba
) && \

823 (((
¡¬t_off£t
 + 
	`shªnÚ_sg_Ëngth
(
sg
)è>> 
ns
->
logicb_shiá
è!ğ
»q
->
lba
)) {

824 
	`£t_»q_wa™_pick
(
»q
);

825 
	`BUG_ON
(
	`shªnÚ_‹¡_b™
(
sdev
->
mbr
.
sdev_id
, &
sbio
->
wa™_dev_pick_mask
));

826 
	`shªnÚ_£t_b™
(
sdev
->
mbr
.
sdev_id
, &
sbio
->
wa™_dev_pick_mask
);

827 
wa™_gc_mask
 |ğ1 << 
sdev
->
mbr
.
sdev_id
;

828 
	`shªnÚ_©omic_šc
(&
sbio
->
u£r_couÁ
);

829 ià(
	`uÆik–y
(!
	`shªnÚ_tim”_³ndšg
(&
sdev
->
b®ªû_gc_tim”
)))

830 
	`shªnÚ_mod_tim”
(&
sdev
->
b®ªû_gc_tim”
, 
	`g‘_jiff›s
(è+ 
BALANCE_GC_TIMEOUT
 * 
	`g‘_HZ
());

832 
dev_logicbs_¬¿y
[
sdev
->
mbr
.
sdev_id
]++;

834 
¡¬t_off£t
 +ğ
	`shªnÚ_sg_Ëngth
(
sg
);

836 ià(
undÚe
) {

837 
»mašed_size
 -ğ
»q
->
Ëngth
;

838 ià(
»mašed_size
 == 0) {

839 
»mašed_size
 = 
ns
->
logicb_size
;

840 
undÚe
 = 0;

842 
	`£nd_uÇligÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

844 ià((
	`shªnÚ_sg_off£t
(
sg
è& 0x7è|| (
	`shªnÚ_sg_Ëngth
(sg) & 0x7)) {

845 
undÚe
 = 1;

846 
»mašed_size
 -ğ
»q
->
Ëngth
;

847 
	`£nd_uÇligÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

849 ià(
»q
->
Ëngth
 =ğ
ns
->
logicb_size
) {

850 
	`£nd_®igÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

852 
Ãxt_sg
 = 
	`shªnÚ_sg_Ãxt
(
sg
);

853 ià(
	`is_cou¶e_sg
(
sg
, 
Ãxt_sg
)) {

854 
»q
->
sg2
 = 
Ãxt_sg
;

855 
»q
->
vœt_addr_2
 = 
	`shªnÚ_sg_vœt
(
Ãxt_sg
);

856 
»q
->
Ëngth
 = 
ns
->
logicb_size
;

857 
¡¬t_off£t
 +ğ
	`shªnÚ_sg_Ëngth
(
Ãxt_sg
);

858 
	`£nd_®igÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

860 
sg
 = 
Ãxt_sg
;

862 
undÚe
 = 1;

863 
»mašed_size
 -ğ
»q
->
Ëngth
;

864 
	`£nd_uÇligÃd_»q
(
sdev
, 
sdisk
, 
sbio
, 
»q
);

870 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
) {

871 
	`shªnÚ_©omic_šc
(&
sdev
->
š_æight_wr™es
);

872 ià(
sdev
->
gc_th»ad_¡©e
 !ğ
NO_RECLAIM
) {

873 
	`shªnÚ_deãr_tim”
(
sdev
, 
	`g‘_HZ
() * 4);

876 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

877 
i
++;

880 ià(
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
)

881 
	`ns_b®ªû_gc
(
ns
, 
sbio
, 
dev_logicbs_¬¿y
, 
wa™_gc_mask
);

883 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

886 
	}
}

888 
	$shªnÚ_subm™_bio_ns
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
)

890 
»t
 = 0;

892 
sbio
->
ns_id
 = 
ns
->
idx
;

893 
sbio
->
ns_£q_num
 = 
ns
->
£q_num
;

894 ià((
sbio
->
fœ¡_size
 =ğ0è&& ((sbio->
bio_size
 & (
ns
->
logicb_size
 - 1)è=ğ0è&& !sbio->
has_hŞe
)

895 
»t
 = 
	`ns_subm™_®igÃd_bio
(
ns
, 
sbio
);

897 
»t
 = 
	`ns_subm™_nÚ®igÃd_bio
(
ns
, 
sbio
, sbio->
fœ¡_size
);

900  
»t
;

901 
	}
}

903 
	#NS_THROTTLE_INTERVAL
 10

	)

904 
	$shªnÚ_subm™_bio_thrÙšg_ns
(
shªnÚ_Çme¥aû
 *
ns
, 
shªnÚ_bio
 *
sbio
)

906 ià(
ns
->
max_iİs
) {

907 
	`shªnÚ_©omic_šc
(&
ns
->
ios
);

908 ià(
	`shªnÚ_©omic_»ad
(&
ns
->
ios
è>ğns->
max_iİs
/(1000/
NS_THROTTLE_INTERVAL
)) {

909 
	`shªnÚ_mu‹x_lock
(&
ns
->
thrÙe_ios_£m
);

910 ià(
	`shªnÚ_©omic_»ad
(&
ns
->
ios
è>‚s->
max_iİs
/(1000/
NS_THROTTLE_INTERVAL
)) {

911 
u32
 
time
 = 
	`shªnÚ_jiff›s_to_m£cs
(
	`g‘_jiff›s
());

912 
	`shªnÚ_©omic_£t
(&
ns
->
ios
, 0);

913 ià((
time
 - 
ns
->
thrÙe_ios_time_¡amp
è>ğ
NS_THROTTLE_INTERVAL
) {

914 
ns
->
thrÙe_ios_time_¡amp
 = 
time
;

916 
	`shªnÚ_m¦“p
(
ns
->
thrÙe_ios_time_¡amp
 + 
NS_THROTTLE_INTERVAL
 - 
time
 - 1);

917 
ns
->
thrÙe_ios_time_¡amp
 = 
	`shªnÚ_jiff›s_to_m£cs
(
	`g‘_jiff›s
());

920 
	`shªnÚ_mu‹x_uÆock
(&
ns
->
thrÙe_ios_£m
);

921 
	`shªnÚ_©omic_šc
(&
ns
->
ios
);

924  
	`shªnÚ_subm™_bio_ns
(
ns
, 
sbio
);

925 
	}
}

927 
	$shªnÚ_bio_š_æight_ns
(
shªnÚ_Çme¥aû
 *
ns
)

929 ià(
ns
->
sdisk
.
gd
)

930  
	`shªnÚ_disk_š_æight
(
ns
->
sdisk
.
gd
);

933 
	}
}

935 
	$£t_poŞ_h¬d_queue_lim™
(
shªnÚ_poŞ
 *
¥
, 
lim™
)

937 
i
 = 0;

938 
¥
->
h¬d_queue_lim™
 = 
lim™
;

939 ; 
i
 < 
¥
->
sdev_couÁ
; i++) {

940 ià(!
¥
->
sdevs
[
i
])

942 
¥
->
sdevs
[
i
]->
h¬d_queue_lim™
 = 
lim™
;

944 
	}
}

946 
	$ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
shªnÚ_poŞ
 *
¥oŞ
)

948 
shªnÚ_dev
 *
sdev
;

949 
u64
 
phy_ÿp
 = 0;

950 
i
;

951 
i
 = 0; i < 
¥oŞ
->
sdev_couÁ
; i++) {

952 
sdev
 = 
¥oŞ
->
sdevs
[
i
];

953 ià(
sdev
 && (sdev->
š™_dÚe
 >ğ
STAGE_RECOVER_DONE
)) {

954 ià(
phy_ÿp
 =ğ0 ||…hy_ÿ°> 
sdev
->
max_£ùÜs
)

955 
phy_ÿp
 = 
sdev
->
max_£ùÜs
;

956 ià(
sdev
->
max_£ùÜs
 == 0)

957 
	`shªnÚ_šfo
("% max_£ùÜ i 0\n", 
sdev
->
sdisk
.
disk_Çme
);

960 ià(
phy_ÿp
 == 0) {

961 
	`shªnÚ_w¬n
("% phy_ÿ°i 0\n", 
¥oŞ
->
cdev_Çme
);

964 
phy_ÿp
 *ğ
¥oŞ
->
sdev_couÁ
;

965 
¥oŞ
->
ov”´ovisiÚ
 = (10000 * (
phy_ÿp
-¥oŞ->
avaabË_ÿ·c™y
)) /…hy_cap;

966 
¥oŞ
->
physiÿl_ÿ·c™y
 = 
phy_ÿp
;

968 
	}
}

970 
	$__£t_poŞ_ov”´ovisiÚ
(
shªnÚ_poŞ
 *
¥oŞ
, 
İ
)

972 
¥oŞ
->
ov”´ovisiÚ
 = 
İ
 * 100;

973 
¥oŞ
->
avaabË_ÿ·c™y
 = spoŞ->
physiÿl_ÿ·c™y
 * (100-
İ
) / 100;

974 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
poŞ_šfo_£m
);

975 
¥oŞ
->
poŞ_šfo
->
avaabË_ÿ·c™y
 = spool->available_capacity;

976 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
poŞ_šfo_£m
);

977 
	}
}

980 
	$£t_poŞ_ov”´ovisiÚ
(
shªnÚ_poŞ
 *
¥oŞ
, 
İ
)

982 
	`shªnÚ_mu‹x_lock
(&
¥oŞ
->
¡©e_£m
);

983 
	`__£t_poŞ_ov”´ovisiÚ
(
¥oŞ
, 
İ
);

984 ià(
	`shªnÚ_‹¡_ªd_ş—r_b™
(
SHN_REASON_LOW_OVERPROVISION
, &
¥oŞ
->
»adÚly_»asÚ
)) {

985 
	`shªnÚ_šfo
("¥oŞ %d: cË¬†ow ov”´ovisiÚ„—dÚly„—sÚ.\n", 
¥oŞ
->
id
);

986 
	`¥oŞ_upd©e_acûss_mode
(
¥oŞ
);

989 
	`upd©e_poŞ_šfo
(
¥oŞ
);

990 
	`shªnÚ_mu‹x_uÆock
(&
¥oŞ
->
¡©e_£m
);

991 
	}
}

993 
	$check_sbio_is_ov”wr™ed
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_Çme¥aû
 *
ns
)

995 
u64
 
off£t
 = 
sbio
->
¡¬t_£ùÜ
 << 9;

996 
lun_pba
†un_pba;

997 
shªnÚ_sg_li¡_t
 *
sg
 = 
sbio
->sg;

1000 ià(
	`g‘_lun_pba_äom_lba
(
off£t
 >> 
ns
->
logicb_shiá
, &
lun_pba
, 
NULL
, &ns->
sdisk
))

1002 
off£t
 +ğ
	`shªnÚ_sg_Ëngth
(
sg
);

1003 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

1004 } 
sg
 && 
	`shªnÚ_sg_·ge
(sg));

1007 
	}
}

	@shannon_pci.c

1 
	~"shªnÚ_pci.h
"

2 
	~"shªnÚ_time.h
"

3 
	~<lšux/pci.h
>

4 
	~<lšux/v”siÚ.h
>

5 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 19)

6 
	~<lšux/pci_hÙ¶ug.h
>

9 
shªnÚ_pci_dev_t
 *
	$shªnÚ_pci_g‘_¦Ù
(
shªnÚ_pci_dev_t
 *
dev
, 
devâ
)

11  (
shªnÚ_pci_dev_t
 *)
	`pci_g‘_¦Ù
(((
pci_dev
 *)
dev
)->
bus
, 
devâ
);

12 
	}
}

14 
	$shªnÚ_pci_di§bË_deviû
(
shªnÚ_pci_dev_t
 *
dev
)

16 
	`pci_di§bË_deviû
((
pci_dev
 *)
dev
);

17 
	}
}

19 
	$shªnÚ_pci_£t_ma¡”
(
shªnÚ_pci_dev_t
 *
dev
)

21 
	`pci_£t_ma¡”
((
pci_dev
 *)
dev
);

22 
	}
}

24 * 
	$shªnÚ_pci_®loc_cÚsi¡’t
(
shªnÚ_pci_dev_t
 *
hwdev
, 
shªnÚ_size_t
 
size
, 
shªnÚ_dma_addr_t
 *
dma_hªdË
)

26  
	`pci_®loc_cÚsi¡’t
((
pci_dev
 *)
hwdev
, 
size
, 
dma_hªdË
);

27 
	}
}

29 
	$shªnÚ_pci_ä“_cÚsi¡’t
(
shªnÚ_pci_dev_t
 *
hwdev
, 
shªnÚ_size_t
 
size
, *
vaddr
, 
shªnÚ_dma_addr_t
 
dma_hªdË
)

31 
	`pci_ä“_cÚsi¡’t
((
pci_dev
 *)
hwdev
, 
size
, 
vaddr
, 
dma_hªdË
);

32 
	}
}

34 
	$shªnÚ_pci_£t_drvd©a
(
shªnÚ_pci_dev_t
 *
pdev
, *
d©a
)

36 
	`pci_£t_drvd©a
((
pci_dev
 *)
pdev
, 
d©a
);

37 
	}
}

39 
	$shªnÚ_pci_’abË_deviû
(
shªnÚ_pci_dev_t
 *
dev
)

41  
	`pci_’abË_deviû
((
pci_dev
 *)
dev
);

42 
	}
}

44 
	$shªnÚ_pci_»que¡_»giÚ
(
shªnÚ_pci_dev_t
 *
dev
, 
i
, cÚ¡ *
p
)

46  
	`pci_»que¡_»giÚ
((
pci_dev
 *)
dev
, 
i
, 
p
);

47 
	}
}

49 
	$shªnÚ_pci_»Ëa£_»giÚs
(
shªnÚ_pci_dev_t
 *
pdev
)

51 
	`pci_»Ëa£_»giÚs
((
pci_dev
 *)
pdev
);

52 
	}
}

54 
shªnÚ_»sourû_size_t
 
	$shªnÚ_pci_»sourû_¡¬t
(
shªnÚ_pci_dev_t
 *
dev
, 
b¬
)

56  
	`pci_»sourû_¡¬t
((
pci_dev
 *)
dev
, 
b¬
);

57 
	}
}

59 
shªnÚ_»sourû_size_t
 
	$shªnÚ_pci_»sourû_Ën
(
shªnÚ_pci_dev_t
 *
dev
, 
b¬
)

61  
	`pci_»sourû_Ën
((
pci_dev
 *)
dev
, 
b¬
);

62 
	}
}

64 
	$shªnÚ_pci_’abË_msi
(
shªnÚ_pci_dev_t
 *
dev
)

66  
	`pci_’abË_msi
((
pci_dev
 *)
dev
);

67 
	}
}

69 
	$shªnÚ_pci_’abË_msix
(
shªnÚ_pci_dev_t
 *
dev
, **
msix_d©a
, 
nvec
)

71 
i
;

72 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(4, 12, 0)

73 
»t
;

76 *
msix_d©a
 = 
	`shªnÚ_kz®loc
(
nvec
 * (
msix_’Œy
), 
GFP_SHANNON
);

77 ià(!(*
msix_d©a
)) {

78 
	`shªnÚ_”r
("alloc msix data failed.\n");

79  -
ENOMEM
;

81 
i
 = 0; i < 
nvec
; i++)

82 ((
msix_’Œy
*)(*
msix_d©a
))[
i
].
’Œy
 = i;

84 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 12, 0)

85  
	`pci_’abË_msix
((
pci_dev
 *)
dev
, (
msix_’Œy
*)(*
msix_d©a
), 
nvec
);

87 
»t
 = 
	`pci_’abË_msix_¿nge
((
pci_dev
 *)
dev
, (
msix_’Œy
*)(*
msix_d©a
), 
nvec
,‚vec);

88 ià(
»t
 < 0)

89  
»t
;

92 
	}
}

94 
	$shªnÚ_pci_di§bË_msi
(
shªnÚ_pci_dev_t
 *
dev
)

96 
	`pci_di§bË_msi
((
pci_dev
 *)
dev
);

97 
	}
}

99 
	$shªnÚ_pci_di§bË_msix
(
shªnÚ_pci_dev_t
 *
dev
, **
msix_d©a
)

101 
	`shªnÚ_kä“
(*
msix_d©a
);

102 *
msix_d©a
 = 
NULL
;

103 
	`pci_di§bË_msix
((
pci_dev
 *)
dev
);

104 
	}
}

106 
	$shªnÚ_pci_g‘_msix_’Œy
(
shªnÚ_msix_’Œy_t
 *
msix_d©a
, 
œq
, 
’Œy_couÁ
)

108 
’Œy
;

110 
’Œy
 = 0;ƒÁry < 
’Œy_couÁ
;ƒntry++)

111 ià(((
msix_’Œy
*)
msix_d©a
)[
’Œy
].
veùÜ
 =ğ
œq
)

114  
’Œy
;

115 
	}
}

117 
	$shªnÚ_pci_g‘_msix_veùÜ
(
shªnÚ_msix_’Œy_t
 *
msix_d©a
, 
šdex
, 
’Œy_couÁ
)

119 ià(
šdex
 < 
’Œy_couÁ
)

120  ((
msix_’Œy
*)
msix_d©a
)[
šdex
].
veùÜ
;

123 
	}
}

125 
	$check_hÙ_¶uggabË
(
shªnÚ_pci_dev_t
 *
pdev
)

127 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 26)

128 
pci_dev
 *pci_dev = ((pci_dev *)
pdev
);

130 ià((
pci_dev
->
¦Ù
 =ğ
NULL
è|| (pci_dev->¦Ù->
hÙ¶ug
 == NULL))

137 
	}
}

139 
	$shªnÚ_g‘_ad­‹r_¡©us
(
shªnÚ_pci_dev_t
 *
pdev
)

141 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 26)

142 
pci_dev
 *
dev
 = ((pci_dev *)
pdev
);

143 
hÙ¶ug_¦Ù
 *
hÙ¶ug
 = 
dev
->
¦Ù
->hotplug;

144 
»t
;

145 
u8
 
ad­‹r_¡©us
;

147 
»t
 = 
hÙ¶ug
->
İs
->
	`g‘_ad­‹r_¡©us
(hÙ¶ug, &
ad­‹r_¡©us
);

148 ià(
»t
) {

149 
	`shªnÚ_”r
("get‡dapter status failed!\n");

150  
»t
;

153  
ad­‹r_¡©us
;

157 
	}
}

159 
	$shªnÚ_di§bË_¦Ù
(
shªnÚ_pci_dev_t
 *
pdev
)

161 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 26)

162 
pci_dev
 *
dev
 = ((pci_dev *)
pdev
);

163 
hÙ¶ug_¦Ù
 *
hÙ¶ug
 = 
dev
->
¦Ù
->hotplug;

165 
hÙ¶ug
->
İs
->
	`di§bË_¦Ù
(hotplug);

168 
	}
}

170 
šlše
 
	$shªnÚ_pci_pc›_ÿp
(
pci_dev
 *
dev
)

172  
	`pci_fšd_ÿ·b™y
(
dev
, 
PCI_CAP_ID_EXP
);

173 
	}
}

175 
	$shªnÚ_di§bË_cÜ»ùabË_«r
(
shªnÚ_pci_dev_t
 *
pdev
)

177 
u16
 
bus_v®
;

178 
pci_dev
 *
dev
 = (pci_dev *)
pdev
;

179 
bus_ÿp
;

181 ià(
dev
->
bus
->
£lf
 =ğ
NULL
)

184 
bus_ÿp
 = 
	`shªnÚ_pci_pc›_ÿp
(
dev
->
bus
->
£lf
);

185 ià(
bus_ÿp
 == 0)

187 
	`pci_»ad_cÚfig_wÜd
(
dev
->
bus
->
£lf
, 
bus_ÿp
 + 
PCI_EXP_DEVCTL
, &
bus_v®
);

188 
	`pci_wr™e_cÚfig_wÜd
(
dev
->
bus
->
£lf
, 
bus_ÿp
 + 
PCI_EXP_DEVCTL
, (
bus_v®
 & ~
PCI_EXP_DEVCTL_CERE
));

189 
	}
}

191 
	$shªnÚ_£t_max_·ylßd_size
(
shªnÚ_pci_dev_t
 *
pdev
)

193 
u16
 
v®
, 
bus_v®
, 
mps
, 
bus_mps
;

194 
pci_dev
 *
dev
 = (pci_dev *)
pdev
;

195 
dev_ÿp
, 
bus_ÿp
;

197 ià(
dev
->
bus
->
£lf
 =ğ
NULL
)

200 
dev_ÿp
 = 
	`shªnÚ_pci_pc›_ÿp
(
dev
);

201 ià(
dev_ÿp
 == 0)

203 
	`pci_»ad_cÚfig_wÜd
(
dev
, 
dev_ÿp
 + 
PCI_EXP_DEVCTL
, &
v®
);

204 
bus_ÿp
 = 
	`shªnÚ_pci_pc›_ÿp
(
dev
->
bus
->
£lf
);

205 ià(
bus_ÿp
 == 0)

207 
	`pci_»ad_cÚfig_wÜd
(
dev
->
bus
->
£lf
, 
bus_ÿp
 + 
PCI_EXP_DEVCTL
, &
bus_v®
);

208 
mps
 = 
v®
 & 
PCI_EXP_DEVCTL_PAYLOAD
;

209 
bus_mps
 = 
bus_v®
 & 
PCI_EXP_DEVCTL_PAYLOAD
;

210 ià(
mps
 !ğ
bus_mps
) {

211 
v®
 &ğ~
PCI_EXP_DEVCTL_PAYLOAD
;

212 
v®
 |ğ
bus_mps
;

213 
	`pci_wr™e_cÚfig_wÜd
(
dev
, 
dev_ÿp
 + 
PCI_EXP_DEVCTL
, 
v®
);

215 
	}
}

217 
šlše
 
boŞ
 
	$shªnÚ_pci_is_pc›
(
pci_dev
 *
dev
)

219  !!
	`shªnÚ_pci_pc›_ÿp
(
dev
);

220 
	}
}

222 
	#PCI_EXP_DEVCAP2_TIMEOUT
 0xf

	)

223 
	#PCI_EXP_TIMEOUT_RANGE_A
 0x1

	)

224 
	#PCI_EXP_TIMEOUT_RANGE_B
 0x2

	)

225 
	#PCI_EXP_TIMEOUT_RANGE_C
 0x4

	)

226 
	$shªnÚ_£t_bridge_timeout
(
shªnÚ_pci_dev_t
 *
pdev
)

228 
pci_dev
 *
bridge
, *
dev
 = (pci_dev *)
pdev
;

229 
u32
 
ÿp
;

230 
u16
 
æags
, 
ù¾
;

231 
pos
;

233 
bridge
 = 
dev
->
bus
->
£lf
;

234 ià(!
bridge
 || !
	`shªnÚ_pci_is_pc›
(bridge))

237 
pos
 = 
	`shªnÚ_pci_pc›_ÿp
(
bridge
);

238 ià(!
pos
)

242 
	`pci_»ad_cÚfig_wÜd
(
bridge
, 
pos
 + 
PCI_EXP_FLAGS
, &
æags
);

243 ià((
æags
 & 
PCI_EXP_FLAGS_VERS
) < 2)

246 
	`pci_»ad_cÚfig_dwÜd
(
bridge
, 
pos
 + 
PCI_EXP_DEVCAP2
, &
ÿp
);

247 
	`shªnÚ_šfo
("ÿp=0x%x.\n", 
ÿp
);

248 ià(!(
ÿp
 & 
PCI_EXP_DEVCAP2_TIMEOUT
))

251 ià(
ÿp
 & 
PCI_EXP_TIMEOUT_RANGE_B
) {

252 
	`pci_»ad_cÚfig_wÜd
(
bridge
, 
pos
 + 
PCI_EXP_DEVCTL2
, &
ù¾
);

253 
	`shªnÚ_šfo
("ù¾=0x%lx.\n", 
ù¾
);

254 
ù¾
 &= 0xf;

255 
ù¾
 |= 0x6;

256 
	`pci_wr™e_cÚfig_wÜd
(
bridge
, 
pos
 + 
PCI_EXP_DEVCTL2
, 
ù¾
);

258 
	}
}

260 *
	$shªnÚ_pci_g‘_drvd©a
(
shªnÚ_pci_dev_t
 *
pdev
)

262  
	`pci_g‘_drvd©a
((
pci_dev
 *)
pdev
);

263 
	}
}

265 
	$shªnÚ_pc›_£t_»adrq
(
shªnÚ_pci_dev_t
 *
pdev
, 
rq
)

267 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 23)

268  
	`pc›_£t_»adrq
((
pci_dev
 *)
pdev
, 
rq
);

270 
pci_dev
 * 
dev
 = (pci_dev *)
pdev
;

271 
ÿp
, 
”r
 = -
EINVAL
;

272 
u16
 
ùl
, 
v
;

274 ià(
rq
 < 128 ||„q > 4096 || (rq & (rq-1)))

275 
out
;

277 
v
 = (
	`ffs
(
rq
) - 8) << 12;

279 
ÿp
 = 
	`pci_fšd_ÿ·b™y
(
dev
, 
PCI_CAP_ID_EXP
);

280 ià(!
ÿp
)

281 
out
;

283 
”r
 = 
	`pci_»ad_cÚfig_wÜd
(
dev
, 
ÿp
 + 
PCI_EXP_DEVCTL
, &
ùl
);

284 ià(
”r
)

285 
out
;

287 ià((
ùl
 & 
PCI_EXP_DEVCTL_READRQ
è!ğ
v
) {

288 
ùl
 &ğ~
PCI_EXP_DEVCTL_READRQ
;

289 
ùl
 |ğ
v
;

290 
”r
 = 
	`pci_wr™e_cÚfig_wÜd
(
dev
, 
ÿp
 + 
PCI_EXP_DEVCTL
, 
ùl
);

293 
out
:

294  
”r
;

296 
	}
}

298 
	$g‘_pci_šfo
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_pci_šfo
 *
šfo
)

300 
pci_dev
 *pci_dev = (pci_dev *)
pdev
;

302 
ÿp
 = -
EINVAL
;

304 
šfo
->
devâ
 = 
pci_dev
->devfn;

305 
šfo
->
v’dÜ_id
 = 
pci_dev
->
v’dÜ
;

306 
šfo
->
deviû_id
 = 
pci_dev
->
deviû
;

307 
šfo
->
subsy¡em_v’dÜ_id
 = 
pci_dev
->
subsy¡em_v’dÜ
;

308 
šfo
->
subsy¡em_deviû_id
 = 
pci_dev
->
subsy¡em_deviû
;

309 
šfo
->
şass
 = 
pci_dev
->class;

310 ià(
pci_dev
->
bus
)

311 
šfo
->
pci_bus_numb”
 = 
pci_dev
->
bus
->
numb”
;

313 
šfo
->
pci_bus_numb”
 = 255;

314 
šfo
->
pci_¦Ù_numb”
 = 
	`PCI_SLOT
(
pci_dev
->
devâ
);

315 
šfo
->
pci_func_numb”
 = 
	`PCI_FUNC
(
pci_dev
->
devâ
);

317 
ÿp
 = 
	`pci_fšd_ÿ·b™y
(
pci_dev
, 
PCI_CAP_ID_EXP
);

319 ià(
ÿp
) {

320 ià(
	`pci_»ad_cÚfig_wÜd
(
pci_dev
, 
ÿp
 + 
PCI_EXP_LNKSTA
, &
šfo
->
Êk¡a
))

321 
šfo
->
Êk¡a
 = 0;

322 ià(
	`pci_»ad_cÚfig_dwÜd
(
pci_dev
, 
ÿp
 + 
PCI_EXP_LNKCAP
, &
šfo
->
Êkÿp
))

323 
šfo
->
Êkÿp
 = 0;

325 
šfo
->
Êk¡a
 = 0;

326 
šfo
->
Êkÿp
 = 0;

328 
	}
}

330 
	$g‘_pci_œq_num
(
shªnÚ_pci_dev_t
 *
pdev
)

332  ((
pci_dev
 *)
pdev
)->
œq
;

333 
	}
}

335 
shªnÚ_deviû_t
 *
	$g‘_deviû_äom_pci_dev
(
shªnÚ_pci_dev_t
 *
pdev
)

337  (
shªnÚ_deviû_t
 *)(&(((
pci_dev
 *)
pdev
)->
dev
));

338 
	}
}

340 
	$dev_is_8639
(
shªnÚ_pci_dev_t
 *
pdev
)

342 
pci_dev
 *pci_dev = (pci_dev *)
pdev
;

343  (
pci_dev
->
deviû
 == 0x1275)?1:0;

344 
	}
}

346 
	$dev_is_g5_ff§
(
shªnÚ_pci_dev_t
 *
pdev
)

348 
pci_dev
 *pci_dev = (pci_dev *)
pdev
;

349  (
pci_dev
->
deviû
 == 0x05a5)?1:0;

350 
	}
}

352 
	$dev_is_g5_åga
(
shªnÚ_pci_dev_t
 *
pdev
)

354 
pci_dev
 *pci_dev = (pci_dev *)
pdev
;

355  ((
pci_dev
->
deviû
 == 0x25a5) || (pci_dev->device == 0x35a5))?1:0;

356 
	}
}

358 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 29)

359 
	$shªnÚ_pc›_ær
(
pci_dev
 *
dev
)

361 
i
;

362 
pos
;

363 
u32
 
ÿp
;

364 
u16
 
¡©us
, 
cÚŒŞ
;

366 
pos
 = 
	`pci_fšd_ÿ·b™y
(
dev
, 
PCI_CAP_ID_EXP
);

367 ià(!
pos
)

368  -
ENOTTY
;

370 
	`pci_»ad_cÚfig_dwÜd
(
dev
, 
pos
 + 
PCI_EXP_DEVCAP
, &
ÿp
);

371 ià(!(
ÿp
 & 
PCI_EXP_DEVCAP_FLR
))

372  -
ENOTTY
;

375 
i
 = 0; i < 4; i++) {

376 ià(
i
)

377 
	`shªnÚ_m¦“p
((1 << (
i
 - 1)) * 100);

379 
	`pci_»ad_cÚfig_wÜd
(
dev
, 
pos
 + 
PCI_EXP_DEVSTA
, &
¡©us
);

380 ià(!(
¡©us
 & 
PCI_EXP_DEVSTA_TRPND
))

381 
ş—r
;

384 
	`dev_”r
(&
dev
->dev, "transaction is‚ot cleared; "

387 
ş—r
:

388 
	`pci_»ad_cÚfig_wÜd
(
dev
, 
pos
 + 
PCI_EXP_DEVCTL
, &
cÚŒŞ
);

389 
cÚŒŞ
 |ğ
PCI_EXP_DEVCTL_BCR_FLR
;

390 
	`pci_wr™e_cÚfig_wÜd
(
dev
, 
pos
 + 
PCI_EXP_DEVCTL
, 
cÚŒŞ
);

392 
	`shªnÚ_m¦“p
(100);

395 
	}
}

397 
	$shªnÚ_pci_af_ær
(
pci_dev
 *
dev
)

399 
i
;

400 
pos
;

401 
u8
 
ÿp
;

402 
u8
 
¡©us
;

404 
pos
 = 
	`pci_fšd_ÿ·b™y
(
dev
, 
PCI_CAP_ID_AF
);

405 ià(!
pos
)

406  -
ENOTTY
;

408 
	`pci_»ad_cÚfig_by‹
(
dev
, 
pos
 + 
PCI_AF_CAP
, &
ÿp
);

409 ià(!(
ÿp
 & 
PCI_AF_CAP_TP
è|| !(ÿ°& 
PCI_AF_CAP_FLR
))

410  -
ENOTTY
;

413 
i
 = 0; i < 4; i++) {

414 ià(
i
)

415 
	`shªnÚ_m¦“p
((1 << (
i
 - 1)) * 100);

417 
	`pci_»ad_cÚfig_by‹
(
dev
, 
pos
 + 
PCI_AF_STATUS
, &
¡©us
);

418 ià(!(
¡©us
 & 
PCI_AF_STATUS_TP
))

419 
ş—r
;

422 
	`dev_”r
(&
dev
->dev, "transaction is‚ot cleared; "

425 
ş—r
:

426 
	`pci_wr™e_cÚfig_by‹
(
dev
, 
pos
 + 
PCI_AF_CTRL
, 
PCI_AF_CTRL_FLR
);

427 
	`shªnÚ_m¦“p
(100);

430 
	}
}

432 
	$shªnÚ_pci_dev_d3_¦“p
(
pci_dev
 *
dev
)

434 
d–ay
 = 100;

435 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 33)

436 
d–ay
 = 
dev
->
d3_d–ay
;

438 
	`shªnÚ_m¦“p
(
d–ay
);

439 
	}
}

441 
	$shªnÚ_pci_pm_»£t
(
pci_dev
 *
dev
)

443 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

444 
u16
 
c¤
;

446 ià(!
dev
->
pm_ÿp
)

447  -
ENOTTY
;

449 
	`pci_»ad_cÚfig_wÜd
(
dev
, dev->
pm_ÿp
 + 
PCI_PM_CTRL
, &
c¤
);

450 ià(
c¤
 & 
PCI_PM_CTRL_NO_SOFT_RESET
)

451  -
ENOTTY
;

453 ià(
dev
->
cu¼’t_¡©e
 !ğ
PCI_D0
)

454  -
EINVAL
;

456 
c¤
 &ğ~
PCI_PM_CTRL_STATE_MASK
;

457 
c¤
 |ğ
PCI_D3hÙ
;

458 
	`pci_wr™e_cÚfig_wÜd
(
dev
, dev->
pm_ÿp
 + 
PCI_PM_CTRL
, 
c¤
);

459 
	`shªnÚ_pci_dev_d3_¦“p
(
dev
);

461 
c¤
 &ğ~
PCI_PM_CTRL_STATE_MASK
;

462 
c¤
 |ğ
PCI_D0
;

463 
	`pci_wr™e_cÚfig_wÜd
(
dev
, dev->
pm_ÿp
 + 
PCI_PM_CTRL
, 
c¤
);

464 
	`shªnÚ_pci_dev_d3_¦“p
(
dev
);

466  -
ENOTTY
;

467 
	}
}

469 
	$shªnÚ_pci_·»Á_bus_»£t
(
pci_dev
 *
dev
)

471 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

472 
u16
 
ù¾
;

473 
pci_dev
 *
pdev
;

475 ià(
	`pci_is_roÙ_bus
(
dev
->
bus
è|| dev->
subÜdš©e
 || !dev->bus->
£lf
)

476  -
ENOTTY
;

478 
	`li¡_fÜ_—ch_’Œy
(
pdev
, &
dev
->
bus
->
deviûs
, 
bus_li¡
)

479 ià(
pdev
 !ğ
dev
)

480  -
ENOTTY
;

482 
	`pci_»ad_cÚfig_wÜd
(
dev
->
bus
->
£lf
, 
PCI_BRIDGE_CONTROL
, &
ù¾
);

483 
ù¾
 |ğ
PCI_BRIDGE_CTL_BUS_RESET
;

484 
	`pci_wr™e_cÚfig_wÜd
(
dev
->
bus
->
£lf
, 
PCI_BRIDGE_CONTROL
, 
ù¾
);

485 
	`shªnÚ_m¦“p
(100);

487 
ù¾
 &ğ~
PCI_BRIDGE_CTL_BUS_RESET
;

488 
	`pci_wr™e_cÚfig_wÜd
(
dev
->
bus
->
£lf
, 
PCI_BRIDGE_CONTROL
, 
ù¾
);

489 
	`shªnÚ_m¦“p
(100);

491  -
ENOTTY
;

492 
	}
}

495 
	$shªnÚ_pci_g‘_max_lškwidth
(
shªnÚ_pci_šfo
 *
šfo
)

497  
šfo
 ? ((šfo->
Êkÿp
 >> 4) & 0x3f) : 0;

498 
	}
}

500 
	$shªnÚ_pci_g‘_cur_lškwidth
(
shªnÚ_pci_šfo
 *
šfo
)

502  
šfo
 ? ((šfo->
Êk¡a
 >> 4) & 0x3f) : 0;

503 
	}
}

505 
	$shªnÚ_pci_g‘_max_lšk¥“d
(
shªnÚ_pci_šfo
 *
šfo
)

507  
šfo
 ? (šfo->
Êkÿp
 & 0xf) : 0;

508 
	}
}

510 
	$shªnÚ_pci_g‘_cur_lšk¥“d
(
shªnÚ_pci_šfo
 *
šfo
)

512  
šfo
 ? (šfo->
Êk¡a
 & 0xf) : 0;

513 
	}
}

515 
	$shªnÚ_pci_»£t_funùiÚ
(
shªnÚ_pci_dev_t
 *
pdev
)

517 
rc
 = 1;

518 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 29)

520 ià(!
pdev
)

523 
	`pci_§ve_¡©e
(
pdev
);

524 
	`pci_wr™e_cÚfig_wÜd
(
pdev
, 
PCI_COMMAND
, 
PCI_COMMAND_INTX_DISABLE
);

526 
rc
 = 
	`shªnÚ_pc›_ær
(
pdev
);

527 ià(
rc
 !ğ-
ENOTTY
)

528 
dÚe
;

530 
rc
 = 
	`shªnÚ_pci_af_ær
(
pdev
);

531 ià(
rc
 !ğ-
ENOTTY
)

532 
dÚe
;

534 
rc
 = 
	`shªnÚ_pci_pm_»£t
(
pdev
);

535 ià(
rc
 !ğ-
ENOTTY
)

536 
dÚe
;

539 
rc
 = 
	`shªnÚ_pci_·»Á_bus_»£t
(
pdev
);

540 
dÚe
:

541 
	`pci_»¡Üe_¡©e
(
pdev
);

543  
rc
;

544 
	}
}

546 
	$shªnÚ_pci_g‘_node
(
shªnÚ_pci_dev_t
 *
pdev
)

548 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

549  
	`dev_to_node
(&(((
pci_dev
 *)
pdev
)->
dev
));

553 
	}
}

	@shannon_pci.h

1 #iâdeà
__SHANNON_PCI_H


2 
	#__SHANNON_PCI_H


	)

4 
	~"shªnÚ_kcÜe.h
"

5 
	~"shªnÚ_dma.h
"

7 
	sshªnÚ_pci_šfo
 {

8 
u32
 
	mdevâ
;

9 
u16
 
	mv’dÜ_id
;

10 
u16
 
	mdeviû_id
;

11 
u16
 
	msubsy¡em_v’dÜ_id
;

12 
u16
 
	msubsy¡em_deviû_id
;

13 
u32
 
	mşass
;

14 
u8
 
	mpci_bus_numb”
;

15 
u8
 
	mpci_¦Ù_numb”
;

16 
u8
 
	mpci_func_numb”
;

17 
u32
 
	mÊkÿp
;

18 
u16
 
	mÊk¡a
;

21 
shªnÚ_pci_dev_t
 *
shªnÚ_pci_g‘_¦Ù
(shªnÚ_pci_dev_ˆ*
dev
, 
devâ
);

22 
shªnÚ_pci_’abË_deviû
(
shªnÚ_pci_dev_t
 *
dev
);

23 
shªnÚ_pci_di§bË_deviû
(
shªnÚ_pci_dev_t
 *
dev
);

25 *
shªnÚ_pci_®loc_cÚsi¡’t
(
shªnÚ_pci_dev_t
 *
hwdev
, 
shªnÚ_size_t
 
size
, 
shªnÚ_dma_addr_t
 *
dma_hªdË
);

26 
shªnÚ_pci_ä“_cÚsi¡’t
(
shªnÚ_pci_dev_t
 *
hwdev
, 
shªnÚ_size_t
 
size
, *
vaddr
, 
shªnÚ_dma_addr_t
 
dma_hªdË
);

28 
shªnÚ_pci_£t_ma¡”
(
shªnÚ_pci_dev_t
 *
dev
);

29 
shªnÚ_pci_£t_drvd©a
(
shªnÚ_pci_dev_t
 *
pdev
, *
d©a
);

30 *
shªnÚ_pci_g‘_drvd©a
(
shªnÚ_pci_dev_t
 *
pdev
);

31 
shªnÚ_pci_»que¡_»giÚ
(
shªnÚ_pci_dev_t
 *
dev
, 
i
, cÚ¡ *
p
);

32 
shªnÚ_pci_»Ëa£_»giÚs
(
shªnÚ_pci_dev_t
 *
pdev
);

33 
shªnÚ_»sourû_size_t
 
shªnÚ_pci_»sourû_¡¬t
(
shªnÚ_pci_dev_t
 *
dev
, 
b¬
);

34 
shªnÚ_»sourû_size_t
 
shªnÚ_pci_»sourû_Ën
(
shªnÚ_pci_dev_t
 *
dev
, 
b¬
);

35 
shªnÚ_pci_’abË_msi
(
shªnÚ_pci_dev_t
 *
dev
);

36 
shªnÚ_pci_’abË_msix
(
shªnÚ_pci_dev_t
 *
dev
, **
msix_d©a
, 
nvec
);

37 
shªnÚ_pci_di§bË_msi
(
shªnÚ_pci_dev_t
 *
dev
);

38 
shªnÚ_pci_di§bË_msix
(
shªnÚ_pci_dev_t
 *
dev
, **
msix_d©a
);

39 
shªnÚ_pci_g‘_msix_’Œy
(
shªnÚ_msix_’Œy_t
 *
msix_d©a
, 
œq
, 
’Œy_couÁ
);

40 
shªnÚ_pci_g‘_msix_veùÜ
(
shªnÚ_msix_’Œy_t
 *
msix_d©a
, 
šdex
, 
’Œy_couÁ
);

41 
check_hÙ_¶uggabË
(
shªnÚ_pci_dev_t
 *
pdev
);

42 
shªnÚ_g‘_ad­‹r_¡©us
(
shªnÚ_pci_dev_t
 *
dev
);

43 
shªnÚ_di§bË_¦Ù
(
shªnÚ_pci_dev_t
 *
dev
);

44 
shªnÚ_di§bË_cÜ»ùabË_«r
(
shªnÚ_pci_dev_t
 *
dev
);

45 
shªnÚ_£t_max_·ylßd_size
(
shªnÚ_pci_dev_t
 *
dev
);

46 
shªnÚ_£t_bridge_timeout
(
shªnÚ_pci_dev_t
 *
dev
);

47 
shªnÚ_pc›_£t_»adrq
(
shªnÚ_pci_dev_t
 *
pdev
, 
rq
);

49 
g‘_pci_šfo
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_pci_šfo
 *
šfo
);

50 
g‘_pci_œq_num
(
shªnÚ_pci_dev_t
 *
pdev
);

51 
shªnÚ_deviû_t
 * 
g‘_deviû_äom_pci_dev
(
shªnÚ_pci_dev_t
 *
pdev
);

52 
dev_is_8639
(
shªnÚ_pci_dev_t
 *
pdev
);

53 
dev_is_g5_ff§
(
shªnÚ_pci_dev_t
 *
pdev
);

54 
dev_is_g5_åga
(
shªnÚ_pci_dev_t
 *
pdev
);

55 
shªnÚ_pci_g‘_max_lškwidth
(
shªnÚ_pci_šfo
 *
šfo
);

56 
shªnÚ_pci_g‘_cur_lškwidth
(
shªnÚ_pci_šfo
 *
šfo
);

57 
shªnÚ_pci_g‘_max_lšk¥“d
(
shªnÚ_pci_šfo
 *
šfo
);

58 
shªnÚ_pci_g‘_cur_lšk¥“d
(
shªnÚ_pci_šfo
 *
šfo
);

59 
shªnÚ_pci_»£t_funùiÚ
(
shªnÚ_pci_dev_t
 *
pdev
);

60 
shªnÚ_pci_g‘_node
(
shªnÚ_pci_dev_t
 *
pdev
);

	@shannon_port.h

1 #iâdeà
__SHANNON_PORT_H


2 
	#__SHANNON_PORT_H


	)

4 
	~"shªnÚ_kcÜe.h
"

6 
	~"shªnÚ_time.h
"

7 
	~"shªnÚ_wÜkqueue.h
"

8 
	~"shªnÚ_li¡.h
"

9 
	~"shªnÚ_fe.h
"

10 
	~"shªnÚ_sÿ‰”.h
"

11 
	~"shªnÚ_dma.h
"

12 
	~"shªnÚ_pci.h
"

13 
	~"shªnÚ_deviû.h
"

14 
	~"shªnÚ_block.h
"

15 
	~"shªnÚ_sched.h
"

16 
	~"shªnÚ_sysfs.h
"

17 
	~"shªnÚ_wa™queue.h
"

18 
	~"shªnÚ_scsi.h
"

19 
	~"shªnÚ_memblock.h
"

24 *
g‘_shªnÚ_dev_äom_li¡
(
shªnÚ_li¡_h—d
 *
li¡
);

25 *
g‘_miscdeviû_äom_shªnÚ_dev
(
shªnÚ_dev
 *
sdev
);

26 *
g‘_shªnÚ_poŞ_äom_li¡
(
shªnÚ_li¡_h—d
 *
li¡
);

27 *
g‘_miscdeviû_äom_shªnÚ_poŞ
(*
¥oŞ
);

33 
shªnÚ_li¡_h—d
 
shªnÚ_dev_li¡
;

34 
	#FOR_SDEV
 0

	)

35 
	#FOR_POOL
 1

	)

36 
shªnÚ_ü—‹_miscdeviû
(*
misc
, *
cdev_Çme
, *
nod’ame
, 
ty³
);

37 
shªnÚ_de¡roy_miscdeviû
(*
misc
);

	@shannon_prefetch.c

11 
	~"shªnÚ.h
"

12 
	~"shªnÚ_´eãtch.h
"

14 
šlše
 
	$´eãtch_check_dev_Œaffic
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_´eãtch
 *
´eãtch
)

16 
i
;

17 
u32
 
lun£t_qd
 = 0;

19 ià(
´eãtch
->
Œaffic_çùÜ
 == 0)

22 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

23 
lun£t_qd
 +ğ
	`lun£t_queue_d•th
(&
sdev
->
lun£ts
[
i
]) / 16;

25 ià(
lun£t_qd
 >ğ(
sdev
->
lun£t_couÁ
 * 
´eãtch
->
Œaffic_çùÜ
))

29 
	}
}

31 
	$hªdË_ÿche_¦Ù_»q_li¡
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_ÿche_¦Ù
 *
¦Ù
)

33 
shªnÚ_ÿche_lše
 *
ÿche_lše
 = 
¦Ù
->cache_line;

34 
shªnÚ_´eãtch
 *
´eãtch
 = 
ÿche_lše
->prefetch;

35 
shªnÚ_»que¡
 *
»q
, *
tmp
;

36 
shªnÚ_disk
 *
sdisk
;

37 
logicb64_t
 
fœ¡_lba
 = 
ÿche_lše
->first_lba;

38 
šdex
, 
fœ¡_size
;

39 
»t
, 
š_ÿche
;

40 
lun_pba
†un_pba;

42 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
¦Ù
->
»q_li¡
, 
li¡
) {

43 
š_ÿche
 = 0;

44 
	`shªnÚ_li¡_d–_š™
(&
»q
->
li¡
);

45 
	`shªnÚ_©omic_dec
(&
ÿche_lše
->
u£r_couÁ
);

46 
sdisk
 = 
	`cÚš”_of
(
´eãtch
, 
shªnÚ_disk
,…refetch);

47 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

48 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
lun_pba
, &
š_ÿche
, 
sdisk
);

49 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

50 ià(
»t
 < 0) {

51 
fœ¡_size
 = 
sdev
->
logicb_size
 - (()
»q
->
vœt_addr
 & (sdev->logicb_size - 1));

52 
	`shªnÚ_mem£t
(
»q
->
vœt_addr
, 0, 
fœ¡_size
);

53 ià(
fœ¡_size
 < 
sdev
->
logicb_size
)

54 
	`shªnÚ_mem£t
(
»q
->
vœt_addr_2
, 0, 
sdev
->
logicb_size
 - 
fœ¡_size
);

55 
»q
->
¡©e
 = 
REQ_DONE
;

56 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

59 ià(
š_ÿche
 == 0) {

60 
shªnÚ_poŞ
 *
¥oŞ
;

61 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

62 
shªnÚ_sb
 *
sb
;

63 
lun
;

65 ià(!
	`lÚg_lba_is_šv®id
(
»q
->
lba
)) {

66 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

67 ià(
¥oŞ
) {

68 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
»q
->
ns_id
]);

69 ià((
ns
 =ğ
NULL
è|| (
»q
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

70 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
»q
->
ns_id
);

71 
	`BUG
();

73 ià(
»q
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

74 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

75 
»q
->
ns_£q_num
,„eq->
ns_id
, 
ns
->
£q_num
);

76 
	`BUG
();

78 
sdisk
 = &
ns
->sdisk;

81 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

82 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &»q->
pba
, 
NULL
, 
sdisk
);

83 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

84 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

85 ià(
»t
 < 0) {

86 
	`shªnÚ_log
("%s:†b¨%x may bdisÿrded. Ju¡ ignÜ™.\n", 
sdev
->
sdisk
.
disk_Çme
, 
»q
->
lba
);

87 
»q
->
¡©e
 = 
REQ_DONE
;

88 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

91 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

92 
»q
->
£q_num
 = 
sb
->seq_num;

95 
»q
->
_ecc
 = 0;

96 
»q
->
_m‘ad©a
 = 0;

97 
lun
 = 
»q
->
pba
.lun;

98 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
»q
);

99 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

103 
	`BUG_ON
(
»q
->
lba
 < 
fœ¡_lba
);

104 
šdex
 = (
»q
->
lba
 - 
fœ¡_lba
è% 
¦Ù
->
ÿche_couÁ
;

105 
šdex
 = index % 
¦Ù
->
ÿche_couÁ
;

106 
	`BUG_ON
(
¦Ù
->
¦Ù_šdex
 !ğ(
»q
->
lba
 - 
fœ¡_lba
è/ slÙ->
ÿche_couÁ
);

107 
fœ¡_size
 = 
sdev
->
logicb_size
 - (()
»q
->
vœt_addr
 & (sdev->logicb_size - 1));

108 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, 
¦Ù
->
ÿche
[
šdex
], 
fœ¡_size
);

109 ià(
fœ¡_size
 < 
sdev
->
logicb_size
)

110 
	`shªnÚ_memıy
(
»q
->
vœt_addr_2
, 
¦Ù
->
ÿche
[
šdex
] + 
fœ¡_size
, 
sdev
->
logicb_size
 - first_size);

111 ià(
»q
->
£nd”
 =ğ
FROM_HOST
)

112 
¦Ù
->
ho¡_»ad_£ùÜs
 +ğ
sdev
->
£ùÜs_š_logicb
;

113 
»q
->
¡©e
 = 
REQ_DONE
;

114 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

116 
	`shªnÚ_ş—r_b™
(
SLOT_HANDLE_REQ_LIST_BIT
, &
¦Ù
->
¡©e
);

117 
	}
}

119 
	$´eãtch_ÿche_¦Ù_ÿÎback
(
shªnÚ_bio
 *
sbio
)

121 
shªnÚ_ÿche_¦Ù
 *
¦Ù
 = (shªnÚ_ÿche_¦Ù *)
sbio
->
d©a
;

122 
shªnÚ_ÿche_lše
 *
ÿche_lše
 = 
¦Ù
->cache_line;

123 
shªnÚ_´eãtch
 *
´eãtch
 = 
ÿche_lše
->prefetch;

124 
shªnÚ_disk
 *
sdisk
 = 
	`cÚš”_of
(
´eãtch
, shannon_disk,…refetch);

125 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
sdisk
, shannon_dev, sdisk);

126 
shªnÚ_»que¡
 *
»q
, *
tmp
;

127 
lun_pba
†un_pba;

128 
hªdË_»q_li¡
 = 0, 
»t
;

130 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
»q
, 
tmp
, &
sbio
->
»q_li¡
, 
bio_li¡
) {

131 
	`shªnÚ_li¡_d–
(&
»q
->
bio_li¡
);

132 ià(
	`uÆik–y
(
»q
->
»»ad
 & 
RAID_READ_MASK
)) {

133 
	`shªnÚ_memıy
(
»q
->
vœt_addr
,„eq->
»cov”_buf
, 
sdev
->
logicb_size
);

134 
	`ä“_logicb_buf
(
sdev
, 
»q
->
»cov”_buf
);

135 
»q
->
»cov”_buf
 = 
NULL
;

137 
	`shªnÚ_dma_unm­_·ge
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
,„eq->
dma_dœ
);

138 ià((
»q
->
_ecc
 >ğ
SH_FAKE_ERR
è|| !
	`g‘_´eãtch_’abË_¡©e
(
´eãtch
)) {

139 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

140 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
lun_pba
, 
NULL
, 
sdisk
);

141 ià(
»t
 == 0)

142 
	`ş—r_lba_d©a_š_ÿche
(
sdisk
, 
»q
->
lba
);

143 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

146 
	`ä“_»q
(
»q
);

149 
	`shªnÚ_wr™e_lock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

150 
	`shªnÚ_¥š_lock_bh
(&
¦Ù
->
li¡_lock
);

151 
	`BUG_ON
(
	`shªnÚ_‹¡_b™
(
SLOT_HANDLE_REQ_LIST_BIT
, &
¦Ù
->
¡©e
));

152 ià(!
	`shªnÚ_li¡_em±y
(&
¦Ù
->
»q_li¡
)) {

153 
	`shªnÚ_£t_b™
(
SLOT_HANDLE_REQ_LIST_BIT
, &
¦Ù
->
¡©e
);

154 
hªdË_»q_li¡
 = 1;

156 
	`shªnÚ_¥š_uÆock_bh
(&
¦Ù
->
li¡_lock
);

158 
	`BUG_ON
(!
	`shªnÚ_‹¡_b™
(
SLOT_WAIT_DATA_BIT
, &
¦Ù
->
¡©e
));

159 
	`shªnÚ_ş—r_b™
(
SLOT_WAIT_DATA_BIT
, &
¦Ù
->
¡©e
);

160 
	`shªnÚ_wr™e_uÆock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

162 if(
hªdË_»q_li¡
)

163 
	`hªdË_ÿche_¦Ù_»q_li¡
(
sdev
, 
¦Ù
);

165 
	`shªnÚ_©omic_dec
(&
ÿche_lše
->
u£r_couÁ
);

166 
	`ä“_sbio
(
sbio
);

167 
	}
}

169 
šlše
 
	$ÿche_lše_¦Ùs_»ady
(
shªnÚ_ÿche_lše
 *
ÿche
)

171  (
	`shªnÚ_©omic_»ad
(&
ÿche
->
u£r_couÁ
) == 0);

172 
	}
}

174 
	$ÿn_´eãtch_ÿche_lše
(
shªnÚ_ÿche_lše
 *
ÿche
)

176  
	`ÿche_lše_¦Ùs_»ady
(
ÿche
);

177 
	}
}

179 
	$£t_®l_ÿche_¦Ù_wa™_d©a
(
shªnÚ_ÿche_lše
 *
ÿche_lše
)

181 
i
;

183 
i
 = 0; i < 
ÿche_lše
->
¦Ù_couÁ
; i++)

184 
	`shªnÚ_£t_b™
(
SLOT_WAIT_DATA_BIT
, &
ÿche_lše
->
¦Ù
[
i
].
¡©e
);

185 
	}
}

187 
	$´eãtch_ÿche_lše
(
shªnÚ_´eãtch
 *
´eãtch
, 
shªnÚ_ÿche_lše
 *
ÿche_lše
)

189 
shªnÚ_disk
 *
sdisk
 = 
	`cÚš”_of
(
´eãtch
, shannon_disk,…refetch);

191 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
sdisk
, shannon_dev, sdisk);

192 
shªnÚ_bio
 *
sbio
;

193 
shªnÚ_»que¡
 *
»q
;

194 
shªnÚ_·ge
 *
·ge
;

195 
logicb64_t
 
Şd_fœ¡_lba
, 
fœ¡_lba
 = 
	`lba_rounddown_ÿche_lše
(
´eãtch
,…»ãtch->
cu¼’t_´eãtch_lba
);

196 
logicb64_t
 
¡¬t_´eãtch_lba
;

197 
shªnÚ_ÿche_¦Ù
 *
¦Ù
;

198 
Ï¡_lun
 = -1, 
lun_logicbs
 = 0;

199 
lun_pba
†un_pba;

200 
shªnÚ_sb
 *
sb
;

201 
i
, 
j
, 
»t
;

203 ià(
ÿche_lše
->
lše_¡©e
 =ğ
CACHE_LINE_DESTROYED
)

205 ià(
fœ¡_lba
 =ğ
ÿche_lše
->first_lba)

207 ià(
	`´eãtch_check_dev_Œaffic
(
sdev
, 
´eãtch
))

210 
	`shªnÚ_wr™e_lock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

211 ià(
	`ÿn_´eãtch_ÿche_lše
(
ÿche_lše
)) {

212 
Şd_fœ¡_lba
 = 
ÿche_lše
->
fœ¡_lba
;

213 ià(
Şd_fœ¡_lba
 !ğ
INVALID_LBA
) {

214 
i
 = 0; i < 
´eãtch
->
lba_³r_lše
; i++) {

215 ià(
Şd_fœ¡_lba
 + 
i
 < (
sdisk
->
£ùÜs
 >> (
sdev
->
logicb_shiá
 - 9))) {

216 
	`Ímt_lock
(
sdev
, 
sdisk
, 
Şd_fœ¡_lba
 + 
i
);

217 
»t
 = 
	`g‘_lun_pba_äom_lba
(
Şd_fœ¡_lba
 + 
i
, &
lun_pba
, 
NULL
, 
sdisk
);

218 ià(
»t
 == 0)

219 
	`ş—r_lba_d©a_š_ÿche
(
sdisk
, 
Şd_fœ¡_lba
 + 
i
);

220 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
Şd_fœ¡_lba
 + 
i
);

225 
	`£t_®l_ÿche_¦Ù_wa™_d©a
(
ÿche_lše
);

226 
	`shªnÚ_©omic_add
(
ÿche_lše
->
¦Ù_couÁ
, &ÿche_lše->
u£r_couÁ
);

227 
ÿche_lše
->
fœ¡_lba
 = first_lba;

229 
	`shªnÚ_wr™e_uÆock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

232 
	`shªnÚ_wr™e_uÆock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

233 
¡¬t_´eãtch_lba
 = 
ÿche_lše
->
fœ¡_lba
;

235 
i
 = 0; i < 
ÿche_lše
->
¦Ù_couÁ
; i++) {

236 
¦Ù
 = &
ÿche_lše
->¦Ù[
i
];

237 
sbio
 = 
	`®loc_sbio
(
GFP_SHANNON
);

238 
	`£t_sbio_debug_g
(
sbio
, 
PREFETCH_TAG
);

239 
sbio
->
logicbs
 = 
¦Ù
->
ÿche_couÁ
;

240 
	`shªnÚ_©omic_£t
(&
sbio
->
u£r_couÁ
, sbio->
logicbs
);

241 
sbio
->
ÿÎback
 = 
´eãtch_ÿche_¦Ù_ÿÎback
;

242 
sbio
->
may_¦“p_š_ÿÎback
 = 0;

243 
sbio
->
d©a
 = (*)
¦Ù
;

245 
j
 = 0; j < 
¦Ù
->
ÿche_couÁ
; j++) {

246 
logicb64_t
 
rg‘_lba
 = 
fœ¡_lba
 + 
i
 * 
¦Ù
->
ÿche_couÁ
 + 
j
;

247 ià(
¡¬t_´eãtch_lba
 > 
rg‘_lba
) {

248 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

251 ià(
	`uÆik–y
(
rg‘_lba
 > (
sdisk
->
£ùÜs
 >> (
sdev
->
logicb_shiá
 - 9)))) {

252 
	`sbio_»Ëa£
(
sdev
, 
sbio
);

255 
»q
 = 
	`®loc_»q
(
GFP_SHANNON
);

256 
	`£t_»q_debug_g
(
»q
, 
PREFETCH_TAG
, 
i
 * 
¦Ù
->
ÿche_couÁ
 + 
j
);

257 
»q
->
£nd”
 = 
FROM_PREFETCH
;

258 
»q
->
sbio
 = sbio;

259 
»q
->
İcode
 = 
sh_cmd_»ad
;

260 
»q
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

261 
»q
->
lba
 = 
rg‘_lba
;

262 
»q
->
Ëngth
 = 
sdev
->
logicb_size
;

263 
»q
->
vœt_addr
 = 
	`g‘_ÿche_¦Ù_šdex_addr
(
¦Ù
, 
j
);

264 
·ge
 = 
	`shªnÚ_vœt_to_·ge
((*)
»q
->
vœt_addr
);

265 ià(!
·ge
) {

266 
	`shªnÚ_”r
("vmalloc_to_page failed!.\n");

267 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

268 
	`ä“_»q
(
»q
);

271 
»q
->
dma_add»ss
 = 
	`shªnÚ_dma_m­_·ge
(
sdev
->
pci_dev
, 
·ge
, 0, sdev->
logicb_size
,„eq->
dma_dœ
);

272 ià(
	`shªnÚ_dma_m­pšg_”rÜ
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
)) {

273 
	`shªnÚ_”r
("shannon_dma_map_pageƒrror.\n");

274 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

275 
	`ä“_»q
(
»q
);

278 
	`Ímt_lock
(
sdev
, 
sdisk
, 
»q
->
lba
);

279 
»t
 = 
	`g‘_lun_pba_äom_lba
(
»q
->
lba
, &
lun_pba
, 
NULL
, 
sdisk
);

280 ià(
»t
 == 0)

281 
	`£t_lba_d©a_š_ÿche
(
sdisk
, 
»q
->
lba
);

282 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
»q
->
lba
);

283 ià(
»t
 < 0) {

284 
	`shªnÚ_dma_unm­_·ge
(
sdev
->
pci_dev
, 
»q
->
dma_add»ss
, sdev->
logicb_size
,„eq->
dma_dœ
);

285 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

286 
	`ä“_»q
(
»q
);

289 
´eãtch
->
´eãtch_couÁ
++;

290 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

291 
»q
->
pba
.
lun_pba
 =†un_pba.lun_pba;

292 
»q
->
pba
.
lun
 = 
lun_pba
.lun;

293 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

294 
»q
->
£q_num
 = 
sb
->seq_num;

295 
	`shªnÚ_li¡_add_
(&
»q
->
bio_li¡
, &
sbio
->
»q_li¡
);

296 
sb
 = 
sdev
->
sbs
 + 
»q
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

297 
»q
->
£q_num
 = 
sb
->seq_num;

298 
	`SHANNON_INIT_LIST_HEAD
(&
»q
->
chunk_li¡
);

299 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[
lun_pba
.lun], 
»q
);

300 ià((
Ï¡_lun
 >ğ0è&& (Ï¡_luÀ!ğ
lun_pba
.
lun
)) {

301 
	`lun£t_pick_»que¡
(
sdev
->
lun
[
Ï¡_lun
]->
lun£t
, 
lun_logicbs
);

302 
lun_logicbs
 = 0;

304 
Ï¡_lun
 = 
lun_pba
.
lun
;

305 
lun_logicbs
++;

307 ià(
Ï¡_lun
 >= 0)

308 
	`lun£t_pick_»que¡
(
sdev
->
lun
[
Ï¡_lun
]->
lun£t
, 
lun_logicbs
);

312 
	}
}

314 
shªnÚ_ÿche_lše
 *
	$g‘_Ãxt_´eãtch_ÿche_lše
(
shªnÚ_´eãtch
 *
´eãtch
)

316 
shªnÚ_ÿche_lše
 *
ÿche_lše
 = 
NULL
;

317 
logicb64_t
 
Ï¡_h™_lba
 = 
	`shªnÚ_©omic64_»ad
(&
´eãtch
->last_hit_lba);

318 
u64
 
tmp_´eãtch_lše
;

321 
´eãtch
->
cu¼’t_´eãtch_lba
 = 
	`lba_rounddown_ÿche_lše
Õ»ãtch, 
Ï¡_h™_lba
 +…»ãtch->
di¡ªû_çùÜ
 *…»ãtch->
lba_³r_lše
);

323 
tmp_´eãtch_lše
 = 
	`g‘_ÿche_lše_äom_lba
(
´eãtch
,…»ãtch->
cu¼’t_´eãtch_lba
);

324 
ÿche_lše
 = &
´eãtch
->ÿche_lše[
tmp_´eãtch_lše
];

325 ià(
ÿche_lše
->
fœ¡_lba
 =ğ
´eãtch
->
cu¼’t_´eãtch_lba
)

326  
NULL
;

328  
ÿche_lše
;

329 
	}
}

331 
	$shªnÚ_ÿche_¦Ù_š™
(
shªnÚ_ÿche_lše
 *
ÿche_lše
, 
u32
 
logicb_size
, u32 
šdex
)

333 
i
;

334 
shªnÚ_ÿche_¦Ù
 *
¦Ù
 = &
ÿche_lše
->¦Ù[
šdex
];

335 
shªnÚ_´eãtch
 *
´eãtch
 = 
ÿche_lše
->prefetch;

337 
	`BUG_ON
(
¦Ù
->
ÿche
 !ğ
NULL
);

338 
¦Ù
->
ÿche
 = 
	`shªnÚ_kz®loc
(
´eãtch
->
ÿche_³r_¦Ù
 * (*), 
GFP_SHANNON
);

339 ià(
¦Ù
->
ÿche
 =ğ
NULL
)

342 
i
 = 0; i < 
´eãtch
->
ÿche_³r_¦Ù
; i++) {

343 
¦Ù
->
ÿche
[
i
] = 
	`shªnÚ_km®loc
(
logicb_size
, 
GFP_SHANNON
);

344 ià(
¦Ù
->
ÿche
[
i
] =ğ
NULL
)

345 
çed
;

347 
¦Ù
->
¡©e
 = 0;

348 
¦Ù
->
¦Ù_šdex
 = 
šdex
;

349 
¦Ù
->
ÿche_couÁ
 = 
´eãtch
->
ÿche_³r_¦Ù
;

350 
¦Ù
->
ho¡_»ad_£ùÜs
 = 0;

351 
	`shªnÚ_¥š_lock_š™
(&
¦Ù
->
li¡_lock
);

352 
	`SHANNON_INIT_LIST_HEAD
(&
¦Ù
->
»q_li¡
);

353 
¦Ù
->
ÿche_lše
 = cache_line;

356 
çed
:

357 --
i
 >= 0) {

358 ià(
¦Ù
->
ÿche
[
i
]) {

359 
	`shªnÚ_kä“
(
¦Ù
->
ÿche
[
i
]);

360 
¦Ù
->
ÿche
[
i
] = 
NULL
;

363 
	`shªnÚ_kä“
(
¦Ù
->
ÿche
);

364 
¦Ù
->
ÿche
 = 
NULL
;

365 
¦Ù
->
ÿche_couÁ
 = 0;

366 
¦Ù
->
¦Ù_šdex
 = -1;

368 
	}
}

370 
	$shªnÚ_ÿche_¦Ù_de¡roy
(
shªnÚ_ÿche_¦Ù
 *
¦Ù
)

372 
i
;

374 
	`shªnÚ_¥š_lock_bh
(&
¦Ù
->
li¡_lock
);

375 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&
¦Ù
->
»q_li¡
));

376 
	`shªnÚ_¥š_uÆock_bh
(&
¦Ù
->
li¡_lock
);

377 
i
 = 0; i < 
¦Ù
->
ÿche_couÁ
; i++) {

378 ià(
¦Ù
->
ÿche
[
i
]) {

379 
	`shªnÚ_kä“
(
¦Ù
->
ÿche
[
i
]);

380 
¦Ù
->
ÿche
[
i
] = 
NULL
;

383 
	`shªnÚ_kä“
(
¦Ù
->
ÿche
);

384 
¦Ù
->
ÿche
 = 
NULL
;

385 
¦Ù
->
ÿche_couÁ
 = 0;

386 
	}
}

388 
	$shªnÚ_ÿche_lše_š™
(
shªnÚ_´eãtch
 *
´eãtch
, 
u32
 
šdex
, u32 
logicb_size
)

390 
i
;

391 
shªnÚ_ÿche_lše
 *
ÿche
 = &
´eãtch
->
ÿche_lše
[
šdex
];

393 
ÿche
->
lše_¡©e
 = 
CACHE_LINE_EMPTY
;

394 
ÿche
->
ÿche_lše_šdex
 = 
šdex
;

395 
ÿche
->
fœ¡_lba
 = 
INVALID_LBA
;

396 
ÿche
->
¦Ù_couÁ
 = 
´eãtch
->
lba_³r_lše
 /…»ãtch->
ÿche_³r_¦Ù
;

397 
ÿche
->
´eãtch
 =…refetch;

398 
	`BUG_ON
(
ÿche
->
¦Ù
);

399 
ÿche
->
¦Ù
 = 
	`shªnÚ_kz®loc
(ÿche->
¦Ù_couÁ
 * (
shªnÚ_ÿche_¦Ù
), 
GFP_SHANNON
);

400 ià(
ÿche
->
¦Ù
 =ğ
NULL
)

402 
i
 = 0; i < 
ÿche
->
¦Ù_couÁ
; i++) {

403 ià(
	`shªnÚ_ÿche_¦Ù_š™
(
ÿche
, 
logicb_size
, 
i
))

404 
çed
;

406 
	`shªnÚ_rwlock_š™
(&
ÿche
->
ÿche_lše_lock
);

407 
	`shªnÚ_©omic_£t
(&
ÿche
->
u£r_couÁ
, 0);

410 
çed
:

411 --
i
 >= 0)

412 
	`shªnÚ_ÿche_¦Ù_de¡roy
(&
ÿche
->
¦Ù
[
i
]);

413 
	`shªnÚ_kä“
(
ÿche
->
¦Ù
);

414 
ÿche
->
¦Ù
 = 
NULL
;

415 
ÿche
->
¦Ù_couÁ
 = 0;

416 
ÿche
->
´eãtch
 = 
NULL
;

418 
	}
}

420 
	$shªnÚ_ÿche_lše_de¡roy
(
shªnÚ_´eãtch
 *
´eãtch
, 
šdex
)

422 
i
;

423 
shªnÚ_ÿche_lše
 *
ÿche
;

424 ià(
´eãtch
->
ÿche_lše
 =ğ
NULL
)

427 
ÿche
 = &
´eãtch
->
ÿche_lše
[
šdex
];

428 ià(
ÿche
->
lše_¡©e
 !ğ
CACHE_LINE_DESTROYED
) {

429 
	`shªnÚ_wr™e_lock_bh
(&
ÿche
->
ÿche_lše_lock
);

430 ià(
ÿche
->
lše_¡©e
 !ğ
CACHE_LINE_DESTROYED
) {

431 
ÿche
->
lše_¡©e
 = 
CACHE_LINE_DESTROYED
;

432 
i
 = 0; i < 
ÿche
->
¦Ù_couÁ
; i++)

433 
	`shªnÚ_ÿche_¦Ù_de¡roy
(&
ÿche
->
¦Ù
[
i
]);

434 ià(
ÿche
->
¦Ù
) {

435 
	`shªnÚ_kä“
(
ÿche
->
¦Ù
);

436 
ÿche
->
¦Ù
 = 
NULL
;

438 
ÿche
->
fœ¡_lba
 = 
INVALID_LBA
;

440 
	`shªnÚ_wr™e_uÆock_bh
(&
ÿche
->
ÿche_lše_lock
);

442 
	}
}

444 
	$g‘_lba_d©a_äom_ÿche
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
)

446 
shªnÚ_´eãtch
 *
´eãtch
 = &
sdisk
->prefetch;

447 
shªnÚ_ÿche_lše
 *
ÿche_lše
 = 
	`g‘_ÿche_lše_¡ruù
(
´eãtch
, 
	`g‘_ÿche_lše_äom_lba
Õ»ãtch, 
»q
->
lba
));

448 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
sdisk
, shannon_dev, sdisk);

449 
shªnÚ_ÿche_¦Ù
 *
¦Ù
;

450 
¦Ù_šdex
;

451 
ÿche_lše_h™
 = 0;

452 
wa™_d©a
 = 0;

453 
šdex
, 
fœ¡_size
;

455 
	`BUG_ON
(
»q
->
lba
 =ğ
INVALID_LBA
);

456 
	`shªnÚ_»ad_lock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

457 
ÿche_lše_h™
 = ((
ÿche_lše
->
fœ¡_lba
 =ğ
	`lba_rounddown_ÿche_lše
(
´eãtch
, 
»q
->
lba
)) ? 1 : 0);

458 ià(
ÿche_lše_h™
) {

459 
	`BUG_ON
(
»q
->
lba
 < 
ÿche_lše
->
fœ¡_lba
);

460 
	`BUG_ON
((
»q
->
lba
 - 
ÿche_lše
->
fœ¡_lba
è>ğ
´eãtch
->
lba_³r_lše
);

461 
¦Ù_šdex
 = (
»q
->
lba
 - 
ÿche_lše
->
fœ¡_lba
è/ 
´eãtch
->
ÿche_³r_¦Ù
;

462 
¦Ù
 = &
ÿche_lše
->¦Ù[
¦Ù_šdex
];

464 
	`BUG_ON
(
¦Ù_šdex
 >ğ
ÿche_lše
->
¦Ù_couÁ
);

465 ià(
	`shªnÚ_‹¡_b™
(
SLOT_WAIT_DATA_BIT
, &
¦Ù
->
¡©e
)) {

466 
	`shªnÚ_¥š_lock_bh
(&
¦Ù
->
li¡_lock
);

467 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
¦Ù
->
»q_li¡
);

468 
»q
->
¡©e
 = 
REQ_WAIT_CACHE
;

469 
	`shªnÚ_¥š_uÆock_bh
(&
¦Ù
->
li¡_lock
);

470 
wa™_d©a
 = 1;

471 
´eãtch
->
wa™_ÿche_»ad_h™s
++;

473 
šdex
 = (
»q
->
lba
 - 
ÿche_lše
->
fœ¡_lba
è% 
¦Ù
->
ÿche_couÁ
;

474 
fœ¡_size
 = 
sdev
->
logicb_size
 - (()
»q
->
vœt_addr
 & (sdev->logicb_size - 1));

475 
	`shªnÚ_memıy
(
»q
->
vœt_addr
, 
¦Ù
->
ÿche
[
šdex
], 
fœ¡_size
);

476 ià(
fœ¡_size
 < 
sdev
->
logicb_size
)

477 
	`shªnÚ_memıy
(
»q
->
vœt_addr_2
, 
¦Ù
->
ÿche
[
šdex
] + 
fœ¡_size
, 
sdev
->
logicb_size
 - first_size);

478 
´eãtch
->
ÿche_h™s
++;

479 ià(
»q
->
£nd”
 =ğ
FROM_HOST
)

480 
¦Ù
->
ho¡_»ad_£ùÜs
 +ğ
sdev
->
£ùÜs_š_logicb
;

481 
	`shªnÚ_©omic_dec
(&
ÿche_lše
->
u£r_couÁ
);

484 
´eãtch
->
ÿche_miss
++;

485 
	`shªnÚ_©omic_dec
(&
ÿche_lše
->
u£r_couÁ
);

487 
	`shªnÚ_»ad_uÆock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

488 if(
ÿche_lše_h™
 && (
wa™_d©a
 == 0)) {

489 
»q
->
¡©e
 = 
REQ_DONE
;

490 
	`sbio_»Ëa£
(
sdev
, 
»q
->
sbio
);

493  
ÿche_lše_h™
;

494 
	}
}

496 
	#PREFETCH_BIO_SIZE_THRESHOLD
 (32768)

497 
	#LARGE_BLOCK_IO_THRESHOLD
 (4)

	)

499 
	$´eãtch_check
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
)

501 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

502 
shªnÚ_´eãtch
 *
´eãtch
 = &
sdisk
->prefetch;

503 
logicb64_t
 
fœ¡_lba
, 
Ï¡_lba
, 
Ï¡_h™_lba
, 
£ùÜ_couÁ
;

505 ià(!
	`g‘_´eãtch_’abË_¡©e
(
´eãtch
))

508 
fœ¡_lba
 = (
sbio
->
¡¬t_£ùÜ
 >> (
sdev
->
logicb_shiá
 - 9));

509 
£ùÜ_couÁ
 = (
sbio
->
bio_size
 >> 9) + ((sbio->bio_size % 512) ? 1 : 0);

510 
Ï¡_lba
 = (
sbio
->
¡¬t_£ùÜ
 + 
£ùÜ_couÁ
 - 1è>> (
sdev
->
logicb_shiá
 - 9);

511 
Ï¡_h™_lba
 = 
	`shªnÚ_©omic64_»ad
(&
´eãtch
->last_hit_lba);

512 ià((
fœ¡_lba
 =ğ
Ï¡_h™_lba
) || (first_lba == (last_hit_lba + 1))) {

513 
u64
 
£q»ad_couÁ
 = 
	`shªnÚ_©omic64_šc_»tuº
(&
´eãtch
->seqread_count);

515 ià((
sbio
->
bio_size
 >ğ
´eãtch
->
soá_bio_size_th»shŞd
è&& (
	`shªnÚ_disk_š_æight
(
sdev
->
sdisk
.
gd
è>ğ´eãtch->
Ïrge_block_io_th»shŞd
))

516 
out
;

517 ià((
sbio
->
bio_size
 >ğ
´eãtch
->
h¬d_bio_size_th»shŞd
))

518 
out
;

520 ià(
£q»ad_couÁ
 >ğ
´eãtch
->
£q»ad_th»shŞd
) {

521 ià(!
	`g‘_´eãtch_wÜkšg_¡©e
(
´eãtch
)) {

522 ià(
	`lik–y
(
sdev
->
´eãtch_th»ad
)) {

523 
	`£t_´eãtch_wÜkšg
(
´eãtch
);

524 
	`shªnÚ_wake_up_´oûss
(
sdev
->
´eãtch_th»ad
);

529 
	`shªnÚ_©omic64_£t
(&
´eãtch
->
£q»ad_couÁ
, 0);

531 
out
:

532 
	`shªnÚ_©omic64_£t
(&
´eãtch
->
Ï¡_h™_lba
, 
Ï¡_lba
);

533 
	}
}

535 
	$šü—£_ÿche_miss
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
)

537 
sdisk
->
´eãtch
.
ÿche_miss
++;

538 
	}
}

540 
	$drİ_ÿche_lše
(
shªnÚ_´eãtch
 *
´eãtch
, 
ÿche_lše
)

542 
shªnÚ_disk
 *
sdisk
 = 
	`cÚš”_of
(
´eãtch
, shannon_disk,…refetch);

543 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
sdisk
, shannon_dev, sdisk);

544 
shªnÚ_ÿche_lše
 *
ÿche
 = 
NULL
;

545 
logicb64_t
 
Şd_fœ¡_lba
;

546 
lun_pba
†un_pba;

547 
i
, 
»t
;

549 ià(
´eãtch
->
ÿche_lše
)

550 
ÿche
 = &
´eãtch
->
ÿche_lše
[cache_line];

552 ià(
ÿche
) {

553 
	`shªnÚ_wr™e_lock_bh
(&
ÿche
->
ÿche_lše_lock
);

554 
Şd_fœ¡_lba
 = 
ÿche
->
fœ¡_lba
;

555 ià(
Şd_fœ¡_lba
 !ğ
INVALID_LBA
) {

556 
i
 = 0; i < 
´eãtch
->
lba_³r_lše
; i++) {

557 ià(
Şd_fœ¡_lba
 + 
i
 < (
sdisk
->
£ùÜs
 << (
sdev
->
logicb_shiá
 - 9))) {

558 
	`Ímt_lock
(
sdev
, 
sdisk
, 
Şd_fœ¡_lba
 + 
i
);

559 
»t
 = 
	`g‘_lun_pba_äom_lba
(
Şd_fœ¡_lba
 + 
i
, &
lun_pba
, 
NULL
, 
sdisk
);

560 ià(
»t
 == 0)

561 
	`ş—r_lba_d©a_š_ÿche
(
sdisk
, 
Şd_fœ¡_lba
 + 
i
);

562 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
Şd_fœ¡_lba
 + 
i
);

567 
ÿche
->
fœ¡_lba
 = 
INVALID_LBA
;

568 
	`shªnÚ_wr™e_uÆock_bh
(&
ÿche
->
ÿche_lše_lock
);

570 
	}
}

572 
	$drİ_®l_ÿche_lše
(
shªnÚ_dev
 *
sdev
)

574 
shªnÚ_´eãtch
 *
´eãtch
 = &
sdev
->
sdisk
.prefetch;

575 
i
;

577 
i
 = 0; i < 
´eãtch
->
ÿche_lšes
; i++)

578 
	`drİ_ÿche_lše
(
´eãtch
, 
i
);

579 
	}
}

581 
	$hªdË_´eãtch_»q_li¡
(
shªnÚ_´eãtch
 *
´eãtch
)

583 
shªnÚ_disk
 *
sdisk
 = 
	`cÚš”_of
(
´eãtch
, shannon_disk,…refetch);

584 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
sdisk
, shannon_dev, sdisk);

585 
shªnÚ_»que¡
 *
´eq
 = 
NULL
;

586 
»t
;

589 
	`shªnÚ_¥š_lock_bh
(&
´eãtch
->
li¡_lock
);

590 ià(!
	`shªnÚ_li¡_em±y
(&
´eãtch
->
»q_li¡
)) {

591 
´eq
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
´eãtch
->
»q_li¡
, 
shªnÚ_»que¡
, 
li¡
);

592 
	`BUG_ON
(
´eq
 =ğ
NULL
);

593 
	`shªnÚ_li¡_d–_š™
(&
´eq
->
li¡
);

595 
	`shªnÚ_¥š_uÆock_bh
(&
´eãtch
->
li¡_lock
);

598 
	`shªnÚ_¥š_uÆock_bh
(&
´eãtch
->
li¡_lock
);

600 
´eq
->
¡©e
 = 
REQ_PICKED_FROM_PREFETCH
;

601 ià(
	`uÆik–y
(!
	`g‘_lba_d©a_äom_ÿche
(
sdisk
, 
´eq
))) {

602 
shªnÚ_poŞ
 *
¥oŞ
;

603 
shªnÚ_Çme¥aû
 *
ns
 = 
NULL
;

604 
shªnÚ_sb
 *
sb
;

605 
lun
;

607 ià(!
	`lÚg_lba_is_šv®id
(
´eq
->
lba
)) {

608 
¥oŞ
 = 
	`¥oŞ_g‘_»ã»nû
(
sdev
->spool);

609 ià(
¥oŞ
) {

610 
ns
 = 
	`ns_g‘_»ã»nû
(
¥oŞ
->ns[
´eq
->
ns_id
]);

611 ià((
ns
 =ğ
NULL
è|| (
´eq
->
ns_id
 >ğ
SHANNON_NS_NUM
)) {

612 
	`shªnÚ_”r
("WrÚg‚s_id=%d.\n", 
´eq
->
ns_id
);

613 
	`BUG
();

615 ià(
´eq
->
ns_£q_num
 !ğ
ns
->
£q_num
) {

616 
	`shªnÚ_”r
("Wrong‚s_seq_num:‚s_seq_num=0x%lx,‚s_id=%d,‚s->seq_num=0x%lx.\n",

617 
´eq
->
ns_£q_num
,…»q->
ns_id
, 
ns
->
£q_num
);

618 
	`BUG
();

620 
sdisk
 = &
ns
->sdisk;

623 
	`Ímt_lock
(
sdev
, 
sdisk
, 
´eq
->
lba
);

624 
»t
 = 
	`g‘_lun_pba_äom_lba
(
´eq
->
lba
, &´eq->
pba
, 
NULL
, 
sdisk
);

625 
	`Ímt_uÆock
(
sdev
, 
sdisk
, 
´eq
->
lba
);

626 
	`put_¥oŞ_ªd_ns
(
¥oŞ
, 
ns
);

627 ià(
»t
 < 0) {

628 
	`shªnÚ_log
("%s:†b¨%x may bdisÿrded. Ju¡ ignÜ™.\n", 
sdev
->
sdisk
.
disk_Çme
, 
´eq
->
lba
);

629 
´eq
->
¡©e
 = 
REQ_DONE
;

630 
	`sbio_»Ëa£
(
sdev
, 
´eq
->
sbio
);

633 
sb
 = 
sdev
->
sbs
 + 
´eq
->
pba
.
lun_pba
/sdev->
logicbs_š_siblšg_eblock
;

634 
´eq
->
£q_num
 = 
sb
->seq_num;

637 
´eq
->
_ecc
 = 0;

638 
´eq
->
_m‘ad©a
 = 0;

639 
lun
 = 
´eq
->
pba
.lun;

640 
	`add_lun_»que¡_queue_
(
sdev
->
lun
[lun], 
´eq
);

641 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun
[lun]->
lun£t
->
subm™_wÜk
);

644 
	}
}

646 
	$add_»q_to_´eãtch_li¡
(
shªnÚ_disk
 *
sdisk
, 
shªnÚ_»que¡
 *
»q
)

648 
shªnÚ_´eãtch
 *
´eãtch
 = &
sdisk
->prefetch;

649 
shªnÚ_ÿche_lše
 *
ÿche_lše
 = 
	`g‘_ÿche_lše_¡ruù
(
´eãtch
, 
	`g‘_ÿche_lše_äom_lba
Õ»ãtch, 
»q
->
lba
));

651 
	`shªnÚ_»ad_lock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

652 ià((
ÿche_lše
->
fœ¡_lba
 =ğ
	`lba_rounddown_ÿche_lše
(
´eãtch
, 
»q
->
lba
)))

653 
	`shªnÚ_©omic_šc
(&
ÿche_lše
->
u£r_couÁ
);

655 
	`shªnÚ_»ad_uÆock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

658 
	`shªnÚ_»ad_uÆock_bh
(&
ÿche_lše
->
ÿche_lše_lock
);

659 
	`shªnÚ_¥š_lock_bh
(&
´eãtch
->
li¡_lock
);

660 ià(
	`uÆik–y
(!
	`g‘_´eãtch_’abË_¡©e
(
´eãtch
))) {

661 
	`shªnÚ_¥š_uÆock_bh
(&
´eãtch
->
li¡_lock
);

662 
	`shªnÚ_©omic_dec
(&
ÿche_lše
->
u£r_couÁ
);

665 
»q
->
¡©e
 = 
REQ_IN_PREFETCH_REQ_LIST
;

666 
	`shªnÚ_li¡_add_
(&
»q
->
li¡
, &
´eãtch
->
»q_li¡
);

667 
	`shªnÚ_¥š_uÆock_bh
(&
´eãtch
->
li¡_lock
);

670 
	}
}

672 
	$´eãtch_th»ad_â
(*
d©a
)

674 
shªnÚ_dev
 *
sdev
 = 
d©a
;

675 
shªnÚ_disk
 *
sdisk
 = &
sdev
->sdisk;

676 
shªnÚ_´eãtch
 *
´eãtch
 = &
sdisk
->prefetch;

677 
shªnÚ_ÿche_lše
 *
ÿche_lše
;

678 
»t
 = 0;

681 ià(
	`shªnÚ_kth»ad_should_¡İ
())

684 
	`hªdË_´eãtch_»q_li¡
(
´eãtch
);

686 ià(!
	`g‘_´eãtch_wÜkšg_¡©e
(
´eãtch
è&& 
	`shªnÚ_li¡_em±y
(&´eãtch->
»q_li¡
è&& !
	`shªnÚ_kth»ad_should_¡İ
()) {

687 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_INTERRUPTIBLE
);

688 ià(!
	`g‘_´eãtch_wÜkšg_¡©e
(
´eãtch
è&& 
	`shªnÚ_li¡_em±y
(&´eãtch->
»q_li¡
è&& !
	`shªnÚ_kth»ad_should_¡İ
()) {

689 
	`shªnÚ_scheduË
();

690 
´eãtch
->
pŞl_times
 = 0;

692 
	`__shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_RUNNING
);

696 ià(
	`shªnÚ_©omic64_»ad
(&
´eãtch
->
£q»ad_couÁ
è<…»ãtch->
£q»ad_th»shŞd
) {

697 
	`£t_´eãtch_¦“pšg
(
´eãtch
);

701 
ÿche_lše
 = 
	`g‘_Ãxt_´eãtch_ÿche_lše
(
´eãtch
);

702 ià(
ÿche_lše
 !ğ
NULL
) {

703 ià(
	`´eãtch_ÿche_lše
(
´eãtch
, 
ÿche_lše
)) {

704 
»t
 = -1;

706 
´eãtch
->
pŞl_times
 = 0;

708 
»t
 = -1;

711 ià(
»t
) {

712 
´eãtch
->
pŞl_times
++;

713 ià(
´eãtch
->
pŞl_times
 >ğ´eãtch->
pŞl_times_th»shŞd
) {

714 
	`£t_´eãtch_¦“pšg
(
´eãtch
);

717 
	`shªnÚ_ud–ay
(10);

720 
	`shªnÚ_cÚd_»sched
();

722 
	`£t_´eãtch_di§bË
(
´eãtch
);

723 
	`shªnÚ_b¬r›r
();

725 
	`hªdË_´eãtch_»q_li¡
(
´eãtch
);

728 
	}
}

730 
	$shªnÚ_´eãtch_š™
(
shªnÚ_´eãtch
 *
´eãtch
, 
u32
 
logicb_size
)

732 
i
 = 0;

734 ià(
	`g‘_´eãtch_’abË_¡©e
(
´eãtch
))

736 ià(
logicb_size
 != 4096) {

737 
	`shªnÚ_log
("logicb size is‚otƒqual 4096,…refetch disable.\n");

740 ià((
PREFETCH_LBA_PER_CACHE_LINE
 % 
PREFETCH_CACHE_PER_SLOT
) != 0) {

741 
	`shªnÚ_log
("lba_pre_cache_line is‚ot‡ligned cache_per_slot,…refetch disable.\n");

744 
´eãtch
->
ÿche_lšes
 = 
PREFETCH_CACHE_LINE_COUNT
;

745 
´eãtch
->
lba_³r_lše
 = 
PREFETCH_LBA_PER_CACHE_LINE
;

746 
´eãtch
->
ÿche_³r_¦Ù
 = 
PREFETCH_CACHE_PER_SLOT
;

747 
´eãtch
->
¦Ù_³r_lše
 = 
PREFETCH_LBA_PER_CACHE_LINE
 / 
PREFETCH_CACHE_PER_SLOT
;

748 
´eãtch
->
lše_size
 = 
logicb_size
 *…»ãtch->
lba_³r_lše
;

749 
´eãtch
->
tÙ®_ÿches
 =…»ãtch->
lba_³r_lše
 *…»ãtch->
ÿche_lšes
;

750 
´eãtch
->
tÙ®_size
 =…»ãtch->
lše_size
 *…»ãtch->
ÿche_lšes
;

752 
	`BUG_ON
(
´eãtch
->
ÿche_lše
);

753 
´eãtch
->
ÿche_lše
 = 
	`shªnÚ_kz®loc
((
shªnÚ_ÿche_lše
è*…»ãtch->
ÿche_lšes
, 
GFP_SHANNON
);

754 ià(
´eãtch
->
ÿche_lše
 =ğ
NULL
)

755 
çed
;

756 
i
 = 0; i < 
´eãtch
->
ÿche_lšes
; i++) {

757 ià(
	`shªnÚ_ÿche_lše_š™
(
´eãtch
, 
i
, 
logicb_size
))

758 
çed
;

760 
´eãtch
->
ÿche_h™s
 = 0;

761 
´eãtch
->
wa™_ÿche_»ad_h™s
 = 0;

762 
´eãtch
->
ÿche_miss
 = 0;

763 
´eãtch
->
´eãtch_couÁ
 = 0;

764 
´eãtch
->
di¡ªû_çùÜ
 = 
DEFAULT_PREFETCH_DISTANCE_FACTOR
;

765 
´eãtch
->
£q»ad_th»shŞd
 = 
DEFAULT_SEQREAD_THRESHOLD
;

766 
	`shªnÚ_©omic64_£t
(&
´eãtch
->
£q»ad_couÁ
, 0);

767 
	`shªnÚ_©omic_£t
(&
´eãtch
->
Ï¡_h™_lba
, 
INVALID_LBA
);

768 
	`shªnÚ_¥š_lock_š™
(&
´eãtch
->
li¡_lock
);

769 
	`SHANNON_INIT_LIST_HEAD
(&
´eãtch
->
»q_li¡
);

770 
´eãtch
->
pŞl_times_th»shŞd
 = 
DEFAULT_PREFETCH_POLL_TIMES
;

771 
´eãtch
->
pŞl_times
 = 0;

772 
´eãtch
->
soá_bio_size_th»shŞd
 = 
PREFETCH_SOFT_BIO_SIZE_THRESHOLD
;

773 
´eãtch
->
h¬d_bio_size_th»shŞd
 = 
PREFETCH_HARD_BIO_SIZE_THRESHOLD
;

774 
´eãtch
->
Ïrge_block_io_th»shŞd
 = 
PREFETCH_LARGE_BLOCK_IO_THRESHOLD
;

775 
´eãtch
->
Œaffic_çùÜ
 = 
DEFAULT_PREFETCH_TRAFFIC_FACTOR
;

776 
	`£t_´eãtch_’abË
(
´eãtch
);

780 
çed
:

781 
	`shªnÚ_šfo
("prefetch init failed.\n");

782 
	`£t_´eãtch_di§bË
(
´eãtch
);

784 ià(
´eãtch
->
ÿche_lše
) {

785 --
i
 >= 0)

786 
	`shªnÚ_ÿche_lše_de¡roy
(
´eãtch
, 
i
);

787 
	`shªnÚ_kä“
(
´eãtch
->
ÿche_lše
);

788 
´eãtch
->
ÿche_lše
 = 
NULL
;

792 
	}
}

794 
	$shªnÚ_´eãtch_de¡roy
(
shªnÚ_´eãtch
 *
´eãtch
)

796 
i
;

798 
	`£t_´eãtch_di§bË
(
´eãtch
);

799 
	`shªnÚ_b¬r›r
();

800 ià(
´eãtch
->
ÿche_lše
) {

801 
i
 = 0; i < 
´eãtch
->
ÿche_lšes
; i++) {

802 
	`drİ_ÿche_lše
(
´eãtch
, 
i
);

803 
	`shªnÚ_ÿche_lše_de¡roy
(
´eãtch
, 
i
);

805 
	`shªnÚ_kä“
(
´eãtch
->
ÿche_lše
);

807 
	`shªnÚ_mem£t
(
´eãtch
, 0, (*prefetch));

808 
´eãtch
->
ÿche_lše
 = 
NULL
;

809 
	`shªnÚ_©omic64_£t
(&
´eãtch
->
Ï¡_h™_lba
, 
INVALID_LBA
);

810 
	}
}

	@shannon_prefetch.h

12 #iâdeà
__SHANNON_PREFETCH_H


13 
	#__SHANNON_PREFETCH_H


	)

15 
	#g‘_ÿche_lše_äom_lba
(
´eãtch
, 
lba
è((Öbaè/ (´eãtch)->
lba_³r_lše
è% (´eãtch)->
ÿche_lšes
)

	)

16 
	#lba_rounddown_ÿche_lše
(
´eãtch
, 
lba
è((Öbaè/ (´eãtch)->
lba_³r_lše
è* (´eãtch)->lba_³r_lše)

	)

17 
	#lba_roundup_ÿche_lše
(
´eãtch
, 
lba
è(((Öbaè/ (´eãtch)->
lba_³r_lše
è* (Õ»ãtch)->lba_³r_lš+ 1)è- 1)

	)

18 
	#g‘_ÿche_lše_¡ruù
(
´eãtch
, 
l
è(&Õ»ãtch)->
ÿche_lše
[Ö)])

	)

19 
	#g‘_ÿche_¦Ù_šdex_addr
(
¦Ù
, 
šdex
è((¦Ù)->
ÿche
[(šdex)])

	)

21 
	sshªnÚ_ÿche_¦Ù
 {

22 
	m¦Ù_šdex
;

23 
u32
 
	mÿche_couÁ
;

24 
	#SLOT_WAIT_DATA_BIT
 (1)

	)

25 
	#SLOT_HANDLE_REQ_LIST_BIT
 (2)

	)

26 
	m¡©e
;

27 
u64
 
	mho¡_»ad_£ùÜs
;

28 
shªnÚ_¥šlock_t
 
	mli¡_lock
;

29 
shªnÚ_li¡_h—d
 
	m»q_li¡
;

30 
shªnÚ_ÿche_lše
 *
	mÿche_lše
;

32 **
	mÿche
;

33 }
__©Œibu‹__
((
®igÃd
));

35 
	sshªnÚ_ÿche_lše
 {

36 
u32
 
	mÿche_lše_šdex
;

38 
	#CACHE_LINE_DESTROYED
 (0)

	)

39 
	#CACHE_LINE_EMPTY
 (1)

	)

40 
	#CACHE_LINE_READY
 (2)

	)

41 
	mlše_¡©e
;

42 
	m¦Ù_couÁ
;

43 
shªnÚ_´eãtch
 *
	m´eãtch
;

44 
logicb64_t
 
	mfœ¡_lba
;

45 
logicb64_t
 
	m¡¬t_´eãtch_lba
;

46 
shªnÚ_©omic_t
 
	mu£r_couÁ
;

47 
shªnÚ_rwlock_t
 
	mÿche_lše_lock
;

48 
shªnÚ_ÿche_¦Ù
 *
	m¦Ù
;

49 }
__©Œibu‹__
((
®igÃd
));

51 
	#PREFETCH_LBA_PER_CACHE_LINE
 (32)

	)

52 
	#PREFETCH_CACHE_LINE_COUNT
 (64)

	)

53 
	#PREFETCH_CACHE_PER_SLOT
 (8)

	)

54 
	sshªnÚ_´eãtch
 {

55 
	#g‘_´eãtch_’abË_¡©e
(
_´eãtch
è(
	`shªnÚ_‹¡_b™
(
PREFETCH_ENABLE_BIT
, &(_´eãtch)->
¡©e
))

	)

56 
	#£t_´eãtch_’abË
(
_´eãtch
è(
	`shªnÚ_£t_b™
(
PREFETCH_ENABLE_BIT
, &(_´eãtch)->
¡©e
))

	)

57 
	#£t_´eãtch_di§bË
(
_´eãtch
è(
	`shªnÚ_ş—r_b™
(
PREFETCH_ENABLE_BIT
, &(_´eãtch)->
¡©e
))

	)

58 
	#g‘_´eãtch_wÜkšg_¡©e
(
_´eãtch
è(
	`shªnÚ_‹¡_b™
(
PREFETCH_WORKING_BIT
, &(_´eãtch)->
¡©e
))

	)

59 
	#£t_´eãtch_wÜkšg
(
_´eãtch
è(
	`shªnÚ_£t_b™
(
PREFETCH_WORKING_BIT
, &(_´eãtch)->
¡©e
))

	)

60 
	#£t_´eãtch_¦“pšg
(
_´eãtch
è(
	`shªnÚ_ş—r_b™
(
PREFETCH_WORKING_BIT
, &(_´eãtch)->
¡©e
))

	)

61 
	#PREFETCH_ENABLE_BIT
 (0)

	)

62 
	#PREFETCH_WORKING_BIT
 (1)

	)

63 
	m¡©e
;

65 
u64
 
	mÿche_h™s
;

66 
u64
 
	mwa™_ÿche_»ad_h™s
;

67 
u64
 
	mÿche_miss
;

68 
u64
 
	m´eãtch_couÁ
;

69 
	#DEFAULT_SEQREAD_THRESHOLD
 (128)

70 
u32
 
£q»ad_th»shŞd
;

	)

71 
	#DEFAULT_PREFETCH_TRAFFIC_FACTOR
 (2)

	)

72 
u32
 
	mŒaffic_çùÜ
;

73 
	#DEFAULT_PREFETCH_DISTANCE_FACTOR
 (4)

	)

74 
	mdi¡ªû_çùÜ
;

75 
shªnÚ_©omic64_t
 
	m£q»ad_couÁ
;

76 
u64
 
	mÏ¡_£q»ad_couÁ
;

77 
shªnÚ_©omic64_t
 
	mÏ¡_h™_lba
;

78 
logicb64_t
 
	mcu¼’t_´eãtch_lba
;

79 
	#DEFAULT_PREFETCH_POLL_TIMES
 (4)

	)

80 
	mpŞl_times_th»shŞd
;

81 
	mpŞl_times
;

82 
	#PREFETCH_SOFT_BIO_SIZE_THRESHOLD
 (32 * 1024)

83 
	#PREFETCH_HARD_BIO_SIZE_THRESHOLD
 (
PREFETCH_LBA_PER_CACHE_LINE
 * 4096 * 2)

84 
soá_bio_size_th»shŞd
;

	)

85 
	mh¬d_bio_size_th»shŞd
;

86 
	#PREFETCH_LARGE_BLOCK_IO_THRESHOLD
 (4)

	)

87 
	mÏrge_block_io_th»shŞd
;

88 
shªnÚ_¥šlock_t
 
	mli¡_lock
;

89 
shªnÚ_li¡_h—d
 
	m»q_li¡
;

91 
shªnÚ_ÿche_lše
 *
	mÿche_lše
;

92 
shªnÚ_sk_¡ruù_t
 *
	m´eãtch_th»ad
;

94 
u32
 
	mtÙ®_size
;

95 
u32
 
	mtÙ®_ÿches
;

96 
u32
 
	mÿche_lšes
;

97 
u32
 
	m¦Ù_³r_lše
;

98 
u32
 
	mlba_³r_lše
;

99 
u32
 
	mÿche_³r_¦Ù
;

100 
u32
 
	mlše_size
;

	@shannon_reconfig.c

1 
	$·r™y_š™_fÜ_»cÚfig
(
shªnÚ_sb
 *
sb
, 
group_šdex
, 
µa
, 
u8
 
h—d
)

3 
shªnÚ_dev
 *
sdev
 = 
sb
->sdev;

4 
shªnÚ_»que¡
 *
»q
;

5 
shªnÚ_lun
 *
lun
;

6 
h—d_šdex
 = 
h—d
 & 
HEAD_INDEX_MASK
;

8 
sb
->
sdev
->
·r™y_š™_dÚe
[
h—d_šdex
] = 0;

10 
»q
 = 
	`®loc_»q
(
GFP_NOWAIT
);

11 
	`£t_»q_debug_g
(
»q
, 
PARITY_INIT_TAG
, 0);

12 
»q
->
İcode
 = 
sh_cmd_·r™y_š™
;

13 
»q
->
d©a_luns
 = 
sb
->
mš_d©a_luns
;

14 
»q
->
pba
.
lun
 = 
	`g‘_·r™y_lun
(&
sb
->
sub_group
[
group_šdex
]);

15 
»q
->
h—d
 = head;

16 
»q
->
µa
 =…pa;

17 
	`shªnÚ_šfo
("sb=%d,†un=%d, group_šdex=%d,…·=%d, h—d=0x%x.\n", 
sb
->
sb_šdex
, 
»q
->
pba
.
lun
, 
group_šdex
, 
µa
, 
h—d
);

18 
lun
 = 
sdev
->lun[
»q
->
pba
.lun];

19 
	`shªnÚ_·r™y_š™_cmd
(
lun
->
lun£t
, 
»q
);

22 
	}
}

24 
	#MAX_WAIT_MSECS
 1500

	)

25 
	$shªnÚ_»cÚfig
(
shªnÚ_dev
 *
sdev
)

27 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
;

28 
u32
 
£u
, 
”rÜ_couÁ
;

29 
i
, 
j
, 
¡©us
, 
Şd_¡©e
, 
wa™
;

31 ià(
sdev
->
»cÚfig_suµÜt
 == 0) {

32 
	`shªnÚ_w¬n
("Disk % dÛ nÙ suµÜˆ»cÚfig.\n", 
sdev
->
sdisk
.
disk_Çme
);

35 
£u
 = 
	`»ad_»g_§ã
(
sdev
, (
u32
 *)sdev->
b¬
 + 
SH_SEU_OFFSET
);

36 
	`shªnÚ_šfo
("%s: seu=0x%x.\n", 
sdev
->
cdev_Çme
, 
£u
);

37 ià(
£u
 == ~0) {

38 
	`check_¶ugout
(
sdev
);

39 ià(
sdev
->
¶ug_out
 == 0)

40 
sdev
->
¡©e
 |ğ
SHN_STATE_ERROR_BIT
;

41 
	`shªnÚ_šfo
("sdev->¶ug_out=%d, s‹=0x%x.\n", 
sdev
->
¶ug_out
, sdev->
¡©e
);

44 ià(
sdev
->
»cÚfig_times
 > 
MAX_RECONFIG_TIMES
) {

45 
	`shªnÚ_šfo
("%s:hi deviû ha b“Àš„—dÚly mode.\n", 
sdev
->
cdev_Çme
);

48 
	`¡İ_w©chdog_tim”
(
sdev
);

49 
sdev
->
big_lock
 = 1;

50 
sdev
->
sdisk
.
š_»cÚfig
 = 1;

52 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

53 ià(
has_dma_d–ay
)

54 
	`__shªnÚ_pick_»que¡
(
sdev
, 0xffffffff);

55 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

56 
	`shªnÚ_mu‹x_lock
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

59 
sdev
->
tÙ®_»cÚfig_times
++;

61 ià((
	`g‘_jiff›s
(è- 
sdev
->
fœ¡_jiff›
è> 
	`g‘_HZ
() * 60) {

62 
sdev
->
fœ¡_jiff›
 = 
	`g‘_jiff›s
();

63 
sdev
->
»cÚfig_times
 = 1;

65 
sdev
->
»cÚfig_times
++;

66 ià(
sdev
->
»cÚfig_times
 > 
MAX_RECONFIG_TIMES
) {

67 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

68 
	`shªnÚ_£t_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_SEU_INTERRUPT_OFFSET
, 
MASK_SEU_INTERRUPT
, 1);

69 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

70 
	`shªnÚ_”r
("%s: seu„egi¡”=0x%x, s‘Ø»adÚly.\n", 
sdev
->
cdev_Çme
, 
£u
);

71 
	`shªnÚ_£t_b™
(
SHN_REASON_SEU_ERROR
, &
sdev
->
»adÚly_»asÚ
);

72 
	`upd©e_acûss_mode
(
sdev
);

73 
out
;

76 
	`shªnÚ_šfo
("%s: wa™ commªd queui em±y.\n", 
sdev
->
cdev_Çme
);

77 !
	`®l_cmd_queue_is_em±y
(
sdev
))

78 
	`shªnÚ_m¦“p
(1);

79 
	`shªnÚ_šfo
("%s: commªd queui em±y‚ow.\n", 
sdev
->
cdev_Çme
);

81 ià(
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
) {

82 
	`shªnÚ_šfo
("%s: fÈ·g¡re.....\n", 
sdev
->
cdev_Çme
);

83 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

84 (
sdev
->
lun_š_group
[
i
] != 0) || \

85 (
sdev
->
wr_group
[
i
] != 0) || \

86 (
sdev
->
wr_¶ªe
[
i
] != 0) || \

87 (
sdev
->
wr_logicb
[
i
] != 0))

88 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

93 #ifdeà
SHANNON_USE_WRITE_BUFFER


94 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[0]);

95 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[1]);

97 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

98 
	`shªnÚ_mu‹x_lock
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

100 
	`shªnÚ_šfo
("%s: wa™ commªd queui em±y.\n", 
sdev
->
cdev_Çme
);

101 !
	`®l_cmd_queue_is_em±y
(
sdev
))

102 
	`shªnÚ_m¦“p
(1);

105 ià(
sdev
->
¢­_»ad_’abË
 && 
	`shªnÚ_dev_is_g5
(sdev)) {

106 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

107 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
))

109 
	`¢­_»ad_di§bË
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i], 1, 1);

110 
	`shªnÚ_pŞlšg_cmd
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i]->
phy_lun_num
, 0, 0, 0);

113 !
	`®l_cmd_queue_is_em±y
(
sdev
))

114 
	`shªnÚ_m¦“p
(1);

115 
	`shªnÚ_šfo
("%s: commªd queui em±y‚ow.\n", 
sdev
->
cdev_Çme
);

118 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

119 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

120 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

121 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

122 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

124 
Şd_¡©e
 = 
sdev
->
¡©e
;

125 
sdev
->
¡©e
 = 
SHN_STATE_RECONFIG
;

127 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

128 
	`shªnÚ_mu‹x_lock
(&
sdev
->
nÜæash_İs_£m
);

129 
	`shªnÚ_m¦“p
(10);

130 
	`shªnÚ_šfo
("%s: s¹„ecÚfig...\n", 
sdev
->
cdev_Çme
);

131 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

132 
	`shªnÚ_£t_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_CONTROL_OFFSET
, 
RECONFIG_START
, 1);

133 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

134 
wa™
 = 0;

136 ià(
wa™
 > 
MAX_WAIT_MSECS
) {

137 
sdev
->
¡©e
 = 
Şd_¡©e
 | 
SHN_STATE_ERROR_BIT
;

138 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
w©chdog_wÜk
);

139 
	`shªnÚ_”r
("»cÚfigimeout! s‘ s‹=0x%x.\n", 
sdev
->
¡©e
);

140 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

141 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

142 
out
;

144 
	`shªnÚ_m¦“p
(1);

145 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

146 
¡©us
 = 
	`shªnÚ_»ad_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_STATUS_OFFSET
, 
RECONFIG_STATUS
);

147 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

148 
wa™
++;

149 } 
¡©us
);

150 
	`shªnÚ_šfo
("%s: stu 1 =%d.\n", 
sdev
->
cdev_Çme
, 
¡©us
);

151 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

152 
	`shªnÚ_£t_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_CONTROL_OFFSET
, 
RECONFIG_START
, 0);

153 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

154 
	`shªnÚ_m¦“p
(100);

155 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

156 
”rÜ_couÁ
 = 
	`shªnÚ_»ad_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_STATUS_OFFSET
, 
ERROR_COUNT
);

157 
£u
 = 
	`shªnÚ_iÜ—d32
((
u32
 *)
sdev
->
b¬
 + 
SH_SEU_OFFSET
);

158 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

159 
	`shªnÚ_šfo
("%s: check seu=0x%x.\n", 
sdev
->
cdev_Çme
, 
£u
);

160 ià((
”rÜ_couÁ
 =ğ0è&& (
£u
 >> 
SH_SEU_CRC_ERROR_SHIFT
)) {

161 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

162 
	`shªnÚ_£t_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_CONTROL_OFFSET
, 
RECONFIG_START
, 1);

163 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

164 
wa™
 = 0;

166 ià(
wa™
 > 
MAX_WAIT_MSECS
) {

167 
sdev
->
¡©e
 = 
Şd_¡©e
 | 
SHN_STATE_ERROR_BIT
;

168 
	`shªnÚ_queue_wÜk
(
sdev
->
misc_wq
, &sdev->
w©chdog_wÜk
);

169 
	`shªnÚ_”r
("»cÚfigimeout! s‘ s‹=0x%x.\n", 
sdev
->
¡©e
);

170 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

171 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

172 
out
;

174 
	`shªnÚ_m¦“p
(1);

175 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

176 
¡©us
 = 
	`shªnÚ_»ad_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_STATUS_OFFSET
, 
RECONFIG_STATUS
);

177 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

178 
wa™
++;

179 } 
¡©us
);

180 
	`shªnÚ_šfo
("%s: stu 2=%d.\n", 
sdev
->
cdev_Çme
, 
¡©us
);

181 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

182 
	`shªnÚ_£t_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_CONTROL_OFFSET
, 
RECONFIG_START
, 0);

183 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

184 
	`shªnÚ_m¦“p
(100);

186 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

187 
”rÜ_couÁ
 = 
	`shªnÚ_»ad_»g
((
u32
 *)
sdev
->
b¬
 + 
SH_RECONFIG_STATUS_OFFSET
, 
ERROR_COUNT
);

188 
£u
 = 
	`shªnÚ_iÜ—d32
((
u32
 *)
sdev
->
b¬
 + 
SH_SEU_OFFSET
);

189 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

190 
	`shªnÚ_šfo
("%s: check seu‡gaš. seu=0x%x.\n", 
sdev
->
cdev_Çme
, 
£u
);

193 ià(
”rÜ_couÁ
 || (
£u
 >> 
SH_SEU_CRC_ERROR_SHIFT
)) {

194 
	`shªnÚ_”r
("%s:„ecÚfigƒ¼Ü couÁ=%d, seu„egi¡”=0x%x, s‘Ø»adÚly.\n", 
sdev
->
cdev_Çme
, 
”rÜ_couÁ
, 
£u
);

195 
	`shªnÚ_£t_b™
(
SHN_REASON_SEU_ERROR
, &
sdev
->
»adÚly_»asÚ
);

196 
	`upd©e_acûss_mode
(
sdev
);

199 
	`shªnÚ_šfo
("%s:„ecÚfig fšished.\n", 
sdev
->
cdev_Çme
);

200 ià(
	`shªnÚ_dev_is_g5
(
sdev
))

201 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
nÜæash_İs_£m
);

203 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

204 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

205 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

206 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

207 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

209 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

210 
	`shªnÚ_£t_ù¾_·¿m
(
sdev
);

211 
	`shªnÚ_m¦“p
(2);

212 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

213 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, 
ONFI_ASYNC_MODE
);

214 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

215 
	`shªnÚ_m¦“p
(10);

217 
	`shªnÚ_š™_nÜæash
(
sdev
);

218 
	`š™_glob®_cÚfig_»gs_fÜ_æashid
(
sdev
);

219 #ifdeà
CONFIG_SHANNON_DMA_QUEUE_64BIT


220 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

221 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
DMA_QUEUE_64BIT
, 1);

222 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

226 
lun_£ùiÚ
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)
sdev
->
b¬
 + 256);

227 
	`»£t_®l_lun£t
(
sdev
, 
lun_£ùiÚ
);

229 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

230 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

231 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, sdev->
ifmode
 =ğ
TOGGLE_MODE
 ? TOGGLE_MODE : 
ONFI_ASYNC_MODE
);

232 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

233 ià((
sdev
->
h¬dw¬e_v”siÚ
 >ğ5è&& (sdev->
miüocode_¬¿y
[0].
miüocode_Ëngth
 > 0)) {

234 
	`ş—n_®l_miüocode_u£d_¡©e
(
sdev
);

235 
	`wr™e_advªûd_»ad_miüocode
(
sdev
, 0);

236 
sdev
->
advªûd_»ad_¡©e
 |ğ
ADV_READ_SUPPORT_MASK
;

238 
sdev
->
advªûd_»ad_¡©e
 &ğ~
ADV_READ_SUPPORT_MASK
;

247 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

248 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
lun£ts
[
i
].
sq_addr
, sdev->lun£ts[i].
sq_dma_addr
);

249 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
lun£ts
[
i
].
cq_addr
, sdev->lun£ts[i].
cq_dma_addr
);

250 
sdev
->
lun£ts
[
i
].
sq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
,

251 &
sdev
->
lun£ts
[
i
].
sq_dma_addr
, 
GFP_ATOMIC
);

252 
sdev
->
lun£ts
[
i
].
cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
,

253 &
sdev
->
lun£ts
[
i
].
cq_dma_addr
, 
GFP_ATOMIC
);

255 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

257 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
sq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr0
);

258 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
sq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr1
);

259 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
cq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr0
);

260 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
cq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr1
);

262 
sdev
->
lun£ts
[
i
].
sq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
sq_h—d
);

263 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
cq_h—d
);

265 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

267 
sdev
->
lun£ts
[
i
].
sq_h—d
 = sdev->lun£ts[i].
sq_hw_h—d
;

268 
sdev
->
lun£ts
[
i
].
cq_h—d
 = sdev->lun£ts[i].
cq_hw_h—d
;

269 
sdev
->
lun£ts
[
i
].
cq_
 = sdev->lun£ts[i].
cq_h—d
;

270 
sdev
->
lun£ts
[
i
].
cq__tmp
 = sdev->lun£ts[i].
cq_h—d
;

272 
sdev
->
lun£ts
[
i
].
sq_h—d_tmp
 = sdev->lun£ts[i].
sq_h—d
;

275 ià(!
	`shªnÚ_dev_is_g5
(
sdev
))

276 
	`lun_£t_®l_ã©u»
(
sdev
);

278 #ifdeà
SHANNON_USE_WRITE_BUFFER


279 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_sq_addr
[0], sdev->
bufq_sq_dma_addr
[0]);

280 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_cq_addr
[0], sdev->
bufq_cq_dma_addr
[0]);

281 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_sq_addr
[1], sdev->
bufq_sq_dma_addr
[1]);

282 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_cq_addr
[1], sdev->
bufq_cq_dma_addr
[1]);

283 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_ack_cq_addr
, sdev->
bufq_ack_cq_dma_addr
);

285 
sdev
->
bufq_sq_addr
[0] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_sq_dma_addr
[0], 
GFP_ATOMIC
);

286 
sdev
->
bufq_cq_addr
[0] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_cq_dma_addr
[0], 
GFP_ATOMIC
);

287 
sdev
->
bufq_sq_addr
[1] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_sq_dma_addr
[1], 
GFP_ATOMIC
);

288 
sdev
->
bufq_cq_addr
[1] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_cq_dma_addr
[1], 
GFP_ATOMIC
);

289 
sdev
->
bufq_ack_cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_ack_cq_dma_addr
, 
GFP_ATOMIC
);

290 ià(
has_dma_d–ay
)

291 
	`ş—r_commªd_queue
((
u64
 *)
sdev
->
bufq_ack_cq_addr
, 0, 
QUEUE_SIZE
>>3, 
COMP_QUEUE_FILL
);

293 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

295 
sdev
->
bufq_b¬
[0] = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
šŒ_big_shiá
[0]));

296 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[0], &sdev->
bufq_b¬
[0]->
sq_dma_addr0
);

297 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[0] >> 32è: 0, &sdev->
bufq_b¬
[0]->
sq_dma_addr1
);

298 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[0], &sdev->
bufq_b¬
[0]->
cq_dma_addr0
);

299 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[0] >> 32è: 0, &sdev->
bufq_b¬
[0]->
cq_dma_addr1
);

301 
sdev
->
bufq_b¬
[1] = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
šŒ_big_shiá
[1]));

302 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[1], &sdev->
bufq_b¬
[1]->
sq_dma_addr0
);

303 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[1] >> 32è: 0, &sdev->
bufq_b¬
[1]->
sq_dma_addr1
);

304 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[1], &sdev->
bufq_b¬
[1]->
cq_dma_addr0
);

305 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[1] >> 32è: 0, &sdev->
bufq_b¬
[1]->
cq_dma_addr1
);

307 
sdev
->
bufq_ack_b¬
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
bufq_ack_šŒ_shiá
));

308 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_ack_cq_dma_addr
, &sdev->
bufq_ack_b¬
->
cq_dma_addr0
);

309 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_ack_cq_dma_addr
 >> 32è: 0, &sdev->
bufq_ack_b¬
->
cq_dma_addr1
);

311 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

312 
sdev
->
bufq_sq_hw_h—d
[
i
] = 
	`shªnÚ_»adl
(&sdev->
bufq_b¬
[i]->
sq_h—d
);

313 
sdev
->
bufq_sq_h—d
[
i
] = sdev->
bufq_sq_hw_h—d
[i];

314 
sdev
->
bufq_cq_hw_h—d
[
i
] = 
	`shªnÚ_»adl
(&sdev->
bufq_b¬
[i]->
cq_h—d
);

315 
sdev
->
bufq_cq_h—d
[
i
] = sdev->
bufq_cq_hw_h—d
[i];

316 
sdev
->
bufq_cq_
[
i
] = sdev->
bufq_cq_h—d
[i];

317 
sdev
->
bufq_sq_h—d_tmp
[
i
] = sdev->
bufq_sq_h—d
[i];

319 
sdev
->
bufq_ack_cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->
bufq_ack_b¬
->
cq_h—d
);

321 
sdev
->
bufq_ack_cq_h—d
 = sdev->
bufq_ack_cq_hw_h—d
;

322 
sdev
->
bufq_ack_cq_
 = sdev->
bufq_ack_cq_h—d
;

323 
	`shªnÚ_wr™–
(
sdev
->
bufq_ack_cq_
, &sdev->
bufq_ack_b¬
->
ack_cq_
);

325 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

327 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, sdev->
Çnd_·ge_size
, sdev->
dummy_·ge
, sdev->
dummy_dma_·ge
);

328 
sdev
->
dummy_·ge
 = 
	`shªnÚ_pci_®loc_cÚsi¡’t
(sdev->
pci_dev
, sdev->
Çnd_·ge_size
, &sdev->
dummy_dma_·ge
);

330 ià(
	`shªnÚ_dev_is_g5
(
sdev
)) {

331 
	`lun_£t_®l_ã©u»_w™h_´io
(
sdev
, 0);

332 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

333 
j
 = 
i
 * 
sdev
->
max_lun_š_lun£t
; j < (i + 1) * sdev->max_lun_in_lunset; j++) {

334 ià(!
	`shªnÚ_‹¡_b™
(
j
, (*)
sdev
->
mbr
.
bad_phy_lun_m­
)) {

335 
	`shªnÚ_pŞlšg_cmd
(&
sdev
->
lun£ts
[
i
], 
j
, 1, 0x0, 0x0);

340 
	`shªnÚ_m¦“p
(2);

341 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

342 
	`shªnÚ_£t_»g
(&
sdev
->
glob®_b¬
->
æash
, 
FLASH_MODE
, sdev->
ifmode
);

343 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

344 
	`shªnÚ_m¦“p
(10);

345 
	`lun_£t_®l_ã©u»_w™h_´io
(
sdev
, 1);

346 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

347 
j
 = 
i
 * 
sdev
->
max_lun_š_lun£t
; j < (i + 1) * sdev->max_lun_in_lunset; j++) {

348 ià(!
	`shªnÚ_‹¡_b™
(
j
, (*)
sdev
->
mbr
.
bad_phy_lun_m­
)) {

349 
	`shªnÚ_pŞlšg_cmd
(&
sdev
->
lun£ts
[
i
], 
j
, 1, 0x0, 0x0);

354 
	`shªnÚ_m¦“p
(2);

356 
	`š™_glob®_cÚfig_»gs
(
sdev
);

359 
	`£t_avaabË_¿id_¡res
(
sdev
);

361 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

362 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

363 
sdev
->
lun£ts
[
i
].
sq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
sq_h—d
);

364 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
cq_h—d
);

365 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

366 
sdev
->
lun£ts
[
i
].
sq_h—d
 = sdev->lun£ts[i].
sq_hw_h—d
;

367 
sdev
->
lun£ts
[
i
].
cq_h—d
 = sdev->lun£ts[i].
cq_hw_h—d
;

368 
sdev
->
lun£ts
[
i
].
cq_
 = sdev->lun£ts[i].
cq_h—d
;

369 
sdev
->
lun£ts
[
i
].
cq__tmp
 = sdev->lun£ts[i].
cq_h—d
;

371 
sdev
->
lun£ts
[
i
].
sq_h—d_tmp
 = sdev->lun£ts[i].
sq_h—d
;

372 
	`debugs1
("lun£t=%d, sq_h—d_tmp=%d, cq_=%d.\n", 
i
, 
sdev
->
lun£ts
[i].
sq_h—d_tmp
, sdev->lun£ts[i].
cq_
);

375 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

376 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

377 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

378 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

379 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

382 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

383 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

384 #ifdeà
SHANNON_USE_WRITE_BUFFER


385 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[0]);

386 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[1]);

389 
	`shªnÚ_šfo
("%s: s’d…¬™y_š™.\n", 
sdev
->
cdev_Çme
);

390 
	`·r™y_š™_fÜ_»cÚfig
(
sdev
->
aùive_blk
[0], sdev->
wr_group
[0], sdev->
wr_sb
[0] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[0], 
wr™e_h—d
[0]);

391 
	`·r™y_š™_fÜ_»cÚfig
(
sdev
->
aùive_blk
[1], sdev->
wr_group
[1], sdev->
wr_sb
[1] * sdev->
·ges_š_eblock
 * sdev->
¶ªes
 + sdev->
wr_chunk
[1], 
wr™e_h—d
[1]);

393 
sdev
->
¡©e
 = 
Şd_¡©e
;

394 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

395 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

396 
	`wr™e_š‹¼u±_veùÜ
(
sdev
, 
i
);

398 
out
:

399 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

400 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

401 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
lun£ts
[
i
].
»q_queue
))

402 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun£ts
[
i
].
subm™_wÜk
);

404 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

405 
sdev
->
sdisk
.
š_»cÚfig
 = 0;

406 
sdev
->
big_lock
 = 0;

407 
	`shªnÚ_wake_up
(&
sdev
->
big_lock_ev’t
);

408 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

409 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

410 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

411 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

412 
	`¡¬t_w©chdog_tim”
(
sdev
, 
WATCHDOG_SECONDS
);

414 
	`debug_´št
("exit.\n");

416 
	}
}

418 
	$shªnÚ_»cÚfig_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

420 
shªnÚ_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
»cÚfig_wÜk
);

421 
	`shªnÚ_»cÚfig
(
dev
);

422 
	}
}

424 
	$shªnÚ_»£t
(
shªnÚ_dev
 *
sdev
)

426 
shªnÚ_lun_b¬
 *
lun_£ùiÚ
;

427 
i
, 
Şd_¡©e
;

429 ià(
sdev
->
»£t_times
 > 
MAX_RESET_TIMES
)

432 
	`¡İ_w©chdog_tim”
(
sdev
);

433 
sdev
->
big_lock
 = 1;

434 
	`shªnÚ_mu‹x_lock
(&
sdev
->
pick_£m
);

435 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

436 
	`shªnÚ_mu‹x_lock
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

439 ià((
	`g‘_jiff›s
(è- 
sdev
->
fœ¡_»£t_jiff›
è> 
	`g‘_HZ
() * 60000000) {

440 
sdev
->
fœ¡_»£t_jiff›
 = 
	`g‘_jiff›s
();

441 
sdev
->
»£t_times
 = 1;

443 
sdev
->
»£t_times
++;

444 ià(
sdev
->
»£t_times
 > 
MAX_RESET_TIMES
) {

445 
	`shªnÚ_šfo
("%s:„e£ˆsk³d.\n", 
sdev
->
cdev_Çme
);

446 
out
;

450 
sdev
->
tÙ®_»£t_times
++;

452 
	`shªnÚ_šfo
("%s: wa™ commªd queui em±y.\n", 
sdev
->
cdev_Çme
);

453 !
	`®l_cmd_queue_is_em±y
(
sdev
))

454 
	`shªnÚ_m¦“p
(1);

455 
	`shªnÚ_šfo
("%s: commªd queui em±y‚ow.\n", 
sdev
->
cdev_Çme
);

457 ià(
sdev
->
acûss_mode
 !ğ
SHN_MODE_READONLY
) {

458 
	`shªnÚ_šfo
("%s: fÈ·g¡re.....\n", 
sdev
->
cdev_Çme
);

459 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

460 (
sdev
->
lun_š_group
[
i
] != 0) || \

461 (
sdev
->
wr_group
[
i
] != 0) || \

462 (
sdev
->
wr_¶ªe
[
i
] != 0) || \

463 (
sdev
->
wr_logicb
[
i
] != 0))

464 
	`£nd_dummy_»q
(
sdev
, 
wr™e_h—d
[
i
]);

469 #ifdeà
SHANNON_USE_WRITE_BUFFER


470 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[0]);

471 
	`shªnÚ_mu‹x_lock
(&
sdev
->
bufq_sq_£m
[1]);

473 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

474 
	`shªnÚ_mu‹x_lock
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

476 
	`shªnÚ_šfo
("%s: wa™ commªd queui em±y.\n", 
sdev
->
cdev_Çme
);

477 !
	`®l_cmd_queue_is_em±y
(
sdev
))

478 
	`shªnÚ_m¦“p
(1);

481 ià(
sdev
->
¢­_»ad_’abË
 && 
	`shªnÚ_dev_is_g5
(sdev)) {

482 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

483 ià(
	`shªnÚ_‹¡_b™
(
sdev
->
lun
[
i
]->
phy_lun_num
, (*)sdev->
mbr
.
bad_phy_lun_m­
))

485 
	`¢­_»ad_di§bË
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i], 1, 1);

486 
	`shªnÚ_pŞlšg_cmd
(
sdev
->
lun
[
i
]->
lun£t
, sdev->lun[i]->
phy_lun_num
, 0, 0, 0);

489 !
	`®l_cmd_queue_is_em±y
(
sdev
))

490 
	`shªnÚ_m¦“p
(1);

491 
	`shªnÚ_šfo
("%s: commªd queui em±y‚ow.\n", 
sdev
->
cdev_Çme
);

494 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

495 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

496 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

497 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

498 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

500 
Şd_¡©e
 = 
sdev
->
¡©e
;

501 
sdev
->
¡©e
 = 
SHN_STATE_RESET
;

503 
lun_£ùiÚ
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)
sdev
->
b¬
 + 256);

504 
	`»£t_®l_lun£t
(
sdev
, 
lun_£ùiÚ
);

506 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

507 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
lun£ts
[
i
].
sq_addr
, sdev->lun£ts[i].
sq_dma_addr
);

508 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
lun£ts
[
i
].
cq_addr
, sdev->lun£ts[i].
cq_dma_addr
);

509 
sdev
->
lun£ts
[
i
].
sq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
,

510 &
sdev
->
lun£ts
[
i
].
sq_dma_addr
, 
GFP_ATOMIC
);

511 
sdev
->
lun£ts
[
i
].
cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
,

512 &
sdev
->
lun£ts
[
i
].
cq_dma_addr
, 
GFP_ATOMIC
);

514 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

516 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
sq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr0
);

517 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
sq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
sq_dma_addr1
);

518 
	`shªnÚ_wr™–
((
u32
)
sdev
->
lun£ts
[
i
].
cq_dma_addr
, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr0
);

519 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
lun£ts
[
i
].
cq_dma_addr
 >> 32è: 0, &sdev->lun£ts[i].
lun_b¬
->
cq_dma_addr1
);

521 
sdev
->
lun£ts
[
i
].
sq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
sq_h—d
);

522 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
cq_h—d
);

524 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

526 
sdev
->
lun£ts
[
i
].
sq_h—d
 = sdev->lun£ts[i].
sq_hw_h—d
;

527 
sdev
->
lun£ts
[
i
].
cq_h—d
 = sdev->lun£ts[i].
cq_hw_h—d
;

528 
sdev
->
lun£ts
[
i
].
cq_
 = sdev->lun£ts[i].
cq_h—d
;

529 
sdev
->
lun£ts
[
i
].
cq__tmp
 = sdev->lun£ts[i].
cq_h—d
;

531 
sdev
->
lun£ts
[
i
].
sq_h—d_tmp
 = sdev->lun£ts[i].
sq_h—d
;

534 
	`lun_£t_®l_ã©u»
(
sdev
);

536 #ifdeà
SHANNON_USE_WRITE_BUFFER


537 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_sq_addr
[0], sdev->
bufq_sq_dma_addr
[0]);

538 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_cq_addr
[0], sdev->
bufq_cq_dma_addr
[0]);

539 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_sq_addr
[1], sdev->
bufq_sq_dma_addr
[1]);

540 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_cq_addr
[1], sdev->
bufq_cq_dma_addr
[1]);

541 
	`shªnÚ_dma_ä“_coh”’t
(
sdev
->
pci_dev
, 
QUEUE_SIZE
, (*)sdev->
bufq_ack_cq_addr
, sdev->
bufq_ack_cq_dma_addr
);

543 
sdev
->
bufq_sq_addr
[0] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_sq_dma_addr
[0], 
GFP_ATOMIC
);

544 
sdev
->
bufq_cq_addr
[0] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_cq_dma_addr
[0], 
GFP_ATOMIC
);

545 
sdev
->
bufq_sq_addr
[1] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_sq_dma_addr
[1], 
GFP_ATOMIC
);

546 
sdev
->
bufq_cq_addr
[1] = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_cq_dma_addr
[1], 
GFP_ATOMIC
);

547 
sdev
->
bufq_ack_cq_addr
 = 
	`shªnÚ_dma_®loc_coh”’t
(sdev->
pci_dev
, 
QUEUE_SIZE
, &sdev->
bufq_ack_cq_dma_addr
, 
GFP_ATOMIC
);

548 ià(
has_dma_d–ay
)

549 
	`ş—r_commªd_queue
((
u64
 *)
sdev
->
bufq_ack_cq_addr
, 0, 
QUEUE_SIZE
>>3, 
COMP_QUEUE_FILL
);

551 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

553 
sdev
->
bufq_b¬
[0] = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
šŒ_big_shiá
[0]));

554 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[0], &sdev->
bufq_b¬
[0]->
sq_dma_addr0
);

555 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[0] >> 32è: 0, &sdev->
bufq_b¬
[0]->
sq_dma_addr1
);

556 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[0], &sdev->
bufq_b¬
[0]->
cq_dma_addr0
);

557 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[0] >> 32è: 0, &sdev->
bufq_b¬
[0]->
cq_dma_addr1
);

559 
sdev
->
bufq_b¬
[1] = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
šŒ_big_shiá
[1]));

560 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_sq_dma_addr
[1], &sdev->
bufq_b¬
[1]->
sq_dma_addr0
);

561 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_sq_dma_addr
[1] >> 32è: 0, &sdev->
bufq_b¬
[1]->
sq_dma_addr1
);

562 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_cq_dma_addr
[1], &sdev->
bufq_b¬
[1]->
cq_dma_addr0
);

563 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_cq_dma_addr
[1] >> 32è: 0, &sdev->
bufq_b¬
[1]->
cq_dma_addr1
);

565 
sdev
->
bufq_ack_b¬
 = (
shªnÚ_lun_b¬
 *)((
u32
 *)sdev->
b¬
 + 256 + (8 * sdev->
bufq_ack_šŒ_shiá
));

566 
	`shªnÚ_wr™–
((
u32
)
sdev
->
bufq_ack_cq_dma_addr
, &sdev->
bufq_ack_b¬
->
cq_dma_addr0
);

567 
	`shªnÚ_wr™–
(((
dma_addr_t
è> 4è? (
u32
)(
sdev
->
bufq_ack_cq_dma_addr
 >> 32è: 0, &sdev->
bufq_ack_b¬
->
cq_dma_addr1
);

569 
i
 = 0; i < 
sdev
->
h—d_couÁ
; i++) {

570 
sdev
->
bufq_sq_hw_h—d
[
i
] = 
	`shªnÚ_»adl
(&sdev->
bufq_b¬
[i]->
sq_h—d
);

571 
sdev
->
bufq_sq_h—d
[
i
] = sdev->
bufq_sq_hw_h—d
[i];

572 
sdev
->
bufq_cq_hw_h—d
[
i
] = 
	`shªnÚ_»adl
(&sdev->
bufq_b¬
[i]->
cq_h—d
);

573 
sdev
->
bufq_cq_h—d
[
i
] = sdev->
bufq_cq_hw_h—d
[i];

574 
sdev
->
bufq_cq_
[
i
] = sdev->
bufq_cq_h—d
[i];

575 
sdev
->
bufq_sq_h—d_tmp
[
i
] = sdev->
bufq_sq_h—d
[i];

577 
sdev
->
bufq_ack_cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->
bufq_ack_b¬
->
cq_h—d
);

578 
sdev
->
bufq_ack_cq_h—d
 = sdev->
bufq_ack_cq_hw_h—d
;

579 
sdev
->
bufq_ack_cq_
 = sdev->
bufq_ack_cq_h—d
;

580 
	`shªnÚ_wr™–
(
sdev
->
bufq_ack_cq_
, &sdev->
bufq_ack_b¬
->
ack_cq_
);

582 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

585 
	`shªnÚ_pci_ä“_cÚsi¡’t
(
sdev
->
pci_dev
, sdev->
Çnd_·ge_size
, sdev->
dummy_·ge
, sdev->
dummy_dma_·ge
);

586 
sdev
->
dummy_·ge
 = 
	`shªnÚ_pci_®loc_cÚsi¡’t
(sdev->
pci_dev
, sdev->
Çnd_·ge_size
, &sdev->
dummy_dma_·ge
);

588 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

589 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
»gs_İ_lock
);

590 
sdev
->
lun£ts
[
i
].
sq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
sq_h—d
);

591 
sdev
->
lun£ts
[
i
].
cq_hw_h—d
 = 
	`shªnÚ_»adl
(&sdev->lun£ts[i].
lun_b¬
->
cq_h—d
);

592 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
»gs_İ_lock
);

593 
sdev
->
lun£ts
[
i
].
sq_h—d
 = sdev->lun£ts[i].
sq_hw_h—d
;

594 
sdev
->
lun£ts
[
i
].
cq_h—d
 = sdev->lun£ts[i].
cq_hw_h—d
;

595 
sdev
->
lun£ts
[
i
].
cq_
 = sdev->lun£ts[i].
cq_h—d
;

596 
sdev
->
lun£ts
[
i
].
cq__tmp
 = sdev->lun£ts[i].
cq_h—d
;

598 
sdev
->
lun£ts
[
i
].
sq_h—d_tmp
 = sdev->lun£ts[i].
sq_h—d
;

599 
	`debugs1
("lun£t=%d, sq_h—d_tmp=%d, cq_=%d.\n", 
i
, 
sdev
->
lun£ts
[i].
sq_h—d_tmp
, sdev->lun£ts[i].
cq_
);

602 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

603 
	`»ad_bufq_š‹¼u±_veùÜ
(
sdev
);

604 
	`»ad_Ùh”_š‹¼u±_veùÜ
(
sdev
);

605 
	`shªnÚ_ş—r_š‹¼u±
(
sdev
);

606 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0, (sdev->potential_interrupt_vectors));

609 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++)

610 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
lun£ts
[
i
].
sq_£m
);

611 #ifdeà
SHANNON_USE_WRITE_BUFFER


612 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[0]);

613 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
bufq_sq_£m
[1]);

616 
sdev
->
¡©e
 = 
Şd_¡©e
;

617 
	`shªnÚ_mem£t
(
sdev
->
pÙ’tŸl_š‹¼u±_veùÜs
, 0xFF, (sdev->potential_interrupt_vectors));

618 
i
 = 0; i < 
MAX_MSIX_INTERRUPTS
; i++)

619 
	`wr™e_š‹¼u±_veùÜ
(
sdev
, 
i
);

621 
out
:

622 
i
 = 0; i < 
sdev
->
lun£t_couÁ
; i++) {

623 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
lun£ts
[
i
].
lun_pick_£m
);

624 ià(!
	`shªnÚ_li¡_em±y
(&
sdev
->
lun£ts
[
i
].
»q_queue
))

625 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_»ad_wq
, &sdev->
lun£ts
[
i
].
subm™_wÜk
);

627 
	`shªnÚ_mu‹x_uÆock
(&
sdev
->
pick_£m
);

628 
sdev
->
big_lock
 = 0;

629 
	`shªnÚ_wake_up
(&
sdev
->
big_lock_ev’t
);

630 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[0]);

631 
	`shªnÚ_wake_up
(&
sdev
->
lim™_»q_queue
[1]);

632 ià(!
	`®l_»q_queue_is_em±y
(
sdev
))

633 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

634 
	`¡¬t_w©chdog_tim”
(
sdev
, 
WATCHDOG_SECONDS
);

636 
	`debug_´št
("exit.\n");

638 
	}
}

640 
	$shªnÚ_»£t_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

642 
shªnÚ_dev
 *
dev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
»£t_wÜk
);

643 
	`shªnÚ_»£t
(
dev
);

644 
	}
}

646 
	$shªnÚ_upd©e_miüocode
(
shªnÚ_dev
 *
sdev
)

648 ià(!(
sdev
->
advªûd_»ad_¡©e
 & 
ADV_READ_SUPPORT_MASK
))

651 
sdev
->
advªûd_»ad_¡©e
 |ğ
UPDATING_MICROCODE_MASK
;

654 
	`shªnÚ_m¦“p
(1);

655 } 
	`shªnÚ_©omic_»ad
(&
sdev
->
š_cmd_queue_adv_»ads
) != 0);

657 ià(
	`should_upd©e_miüocode
(
sdev
))

658 
	`wr™e_advªûd_»ad_miüocode
(
sdev
, 
	`g‘_upd©e_miüocode
(sdev));

660 
	`shªnÚ_¥š_lock_bh
(&
sdev
->
adv_»ad_li¡_lock
);

661 
sdev
->
advªûd_»ad_¡©e
 &ğ~
UPDATING_MICROCODE_MASK
;

662 
	`put_adv_»ad_li¡_to_»q_queue
(
sdev
);

663 
	`shªnÚ_¥š_uÆock_bh
(&
sdev
->
adv_»ad_li¡_lock
);

665 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
wÜk
);

666 
	}
}

668 
	$shªnÚ_upd©e_miüocode_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

670 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_dev, 
upd©e_miüocode_wÜk
);

671 
	`shªnÚ_upd©e_miüocode
(
sdev
);

672 
	}
}

	@shannon_regs.h

10 #iâdeà
__SHANNON_REGS_H


11 
	#__SHANNON_REGS_H


	)

17 
	#SH_EXT_TEMP_THRESHOLD_OFFSET
 0x12

	)

19 
	#SH_EXT_TEMP_CRITICAL_THRESHOLD_OFFSET
 0x13

	)

21 
	#SH_INNER_TEMP_THRESHOLD_OFFSET
 0x14

	)

24 
	#SH_DCM_FREQ_OFFSET
 0x16

	)

27 
	#SH_DEBUG_DCM_OFFSET
 0x18

	)

29 
	#SH_RECONFIG_CONTROL_OFFSET
 0x19

	)

30 
	#SH_RECONFIG_START_MASK
 0x80000000

	)

31 
	#SH_RECONFIG_START_SHIFT
 31

	)

34 
	#SH_RECONFIG_STATUS_OFFSET
 0x1a

	)

35 
	#SH_RECONFIG_STATUS_MASK
 0x80000000

	)

36 
	#SH_RECONFIG_STATUS_SHIFT
 31

	)

37 
	#SH_RECONFIG_SUPPORT_MASK
 0x40000000

	)

38 
	#SH_RECONFIG_SUPPORT_SHIFT
 30

	)

39 
	#SH_ERROR_COUNT_MASK
 0x3fff0000

	)

40 
	#SH_ERROR_COUNT_SHIFT
 16

	)

41 
	#SH_DONE_COUNT_MASK
 0x0000ffff

	)

42 
	#SH_DONE_COUNT_SHIFT
 0

	)

45 
	#SH_NORFLASH_ID_OFFSET
 0x1c

	)

47 
	#SH_NORFLASH_OPT_OFFSET
 0x1d

	)

48 
	#SH_NORFLASH_ERASE_SHIFT
 31

	)

49 
	#SH_NORFLASH_WRITE_SHIFT
 30

	)

50 
	#SH_NORFLASH_READ_SHIFT
 29

	)

51 
	#SH_NORFLASH_ADDR_MASK
 0x0000ffff

	)

53 
	#SH_NORFLASH_STATE_OFFSET
 0x1e

	)

54 
	#SH_NORFLASH_STATE_MASK
 0x00000001

	)

55 
	#SH_NORFLASH_WRITE_PROTECT_MASK
 0x80000000

	)

58 
	#SH_G5_FPGA_NORFLASH_OFFSET
 0x21

	)

59 
	#SH_G5_FPGA_NORFLASH_MASK
 0xffffffff

	)

60 
	#SH_G5_FPGA_NORFLASH_SHIFT
 0x0

	)

63 
	#SH_SEU_OFFSET
 0x25

	)

64 
	#SH_SEU_ECC_ERROR_MASK
 0x7fffffff

	)

65 
	#SH_SEU_CRC_ERROR_SHIFT
 31

	)

68 
	#SH_VCC_TEMP_OFFSET
 0x26

	)

69 
	#SH_TEMP_SHIFT
 0

	)

70 
	#SH_TEMP_MASK
 0x000003ff

	)

71 
	#SH_VCCINT_SHIFT
 10

	)

72 
	#SH_VCCINT_MASK
 0x000ffc00

	)

73 
	#SH_VCCAUX_SHIFT
 20

	)

74 
	#SH_VCCAUX_MASK
 0x7ff00000

	)

77 
	#SH_SEU_INTERRUPT_OFFSET
 0x30

	)

78 
	#SH_MASK_SEU_INTERRUPT_MASK
 0x00000001

	)

79 
	#SH_MASK_SEU_INTERRUPT_SHIFT
 0

	)

82 
	#SH_ICAP_OFFSET
 0x33

	)

85 
	#SH_TEMP_STATUS
 0x3c

	)

86 
	#SH_TEMP_STATUS_MASK
 0x00000060

	)

87 
	#SH_TEMP_WARN
 0x00000020

	)

88 
	#SH_TEMP_CRIT_WARN
 0x00000060

	)

91 
	#SH_TEMP_AUX1_OFFSET
 0x3d

	)

93 
	#SH_TEMP_AUX2_OFFSET
 0x3e

	)

95 
	#SH_TEMP_BOARD_OFFSET
 0x3f

	)

96 
	#SH_EXTERNAL_TEMP_MASK
 0xff

	)

97 
	#SH_EXTERNAL_TEMP_SHIFT
 5

	)

100 
	#SH_CORE_CLK_OFFSET
 0xf2

	)

102 
	#SH_DP_CLK_OFFSET
 0xf3

	)

105 
	#SH_INTERN_TEMP_OFFSET
 0xf4

	)

106 
	#SH_CURRENT_TEMP_SHIFT
 0

	)

107 
	#SH_CURRENT_TEMP_MASK
 0x000000ff

	)

108 
	#SH_MAX_TEMP_SHIFT
 8

	)

109 
	#SH_MAX_TEMP_MASK
 0x0000ff00

	)

112 
	#SH_ADVANCED_READ_OFFSET
 0x0C00

	)

118 
	#SH_FLASH_MODE_SHIFT
 0

	)

119 
	#SH_FLASH_MODE_MASK
 0x0000000f

	)

120 
	#SH_CMD_CYCLE_SHIFT
 4

	)

121 
	#SH_CMD_CYCLE_MASK
 0x000000f0

	)

122 
	#SH_SECTORS_IN_PAGE_SHIFT
 8

	)

123 
	#SH_SECTORS_IN_PAGE_MASK
 0x0000ff00

	)

124 
	#SH_PAGES_IN_BLOCK_SHIFT
 16

	)

125 
	#SH_PAGES_IN_BLOCK_MASK
 0x00ff0000

	)

126 
	#SH_RESET_SHIFT
 24

	)

127 
	#SH_RESET_MASK
 0x01000000

	)

128 
	#SH_DMA_QUEUE_64BIT_SHIFT
 25

	)

129 
	#SH_DMA_QUEUE_64BIT_MASK
 0x02000000

	)

130 
	#SH_LED_SHIFT
 28

	)

131 
	#SH_LED_MASK
 0xf0000000

	)

132 
	#SH_G5_LED_SHIFT
 26

	)

133 
	#SH_G5_LED_MASK
 0x7c000000

	)

134 
	#SH_VPP_SHIFT
 31

	)

135 
	#SH_VPP_MASK
 0x80000000

	)

137 
	#GREEN_CONSTANT
 0x0

	)

138 
	#GREEN_FLASHING
 0x1

	)

139 
	#YELLOW_DARK
 0x0

	)

140 
	#YELLOW_BRIGHT
 0x4

	)

141 
	#YELLOW_SLOW_FLASH
 0x2

	)

142 
	#YELLOW_FAST_FLASH
 0x6

	)

145 
	#SH_SECTOR_SIZE_SHIFT
 0

	)

146 
	#SH_SECTOR_SIZE_MASK
 0x000000ff

	)

147 
	#SH_ECC_CODEWORDS_SHIFT
 8

	)

148 
	#SH_ECC_CODEWORDS_MASK
 0x0000ff00

	)

149 
	#SH_FULL_SECTOR_SIZE_SHIFT
 16

	)

150 
	#SH_FULL_SECTOR_SIZE_MASK
 0xffff0000

	)

151 
	#SH_FIRST_CODEWORD_OFFSET_SHIFT
 16

	)

152 
	#SH_FIRST_CODEWORD_OFFSET_MASK
 0xffff0000

	)

155 
	#SH_PLANE_MASK_SHIFT
 0

	)

156 
	#SH_PLANE_MASK_MASK
 0x000000ff

	)

157 
	#SH_LUN_ADDR_MASK_SHIFT
 8

	)

158 
	#SH_LUN_ADDR_MASK_MASK
 0x0000ff00

	)

159 
	#SH_FULL_PAGE_SIZE_SHIFT
 16

	)

160 
	#SH_FULL_PAGE_SIZE_MASK
 0xffff0000

	)

163 
	#SH_RAID_ENABLE_SHIFT
 0

	)

164 
	#SH_RAID_ENABLE_MASK
 0x00000001

	)

165 
	#SH_PER_BYTE_DISABLE_SHIFT
 4

	)

166 
	#SH_PER_BYTE_DISABLE_MASK
 0x00000030

	)

167 
	#SH_SECTORS_IN_CHUNK_SHIFT
 8

	)

168 
	#SH_SECTORS_IN_CHUNK_MASK
 0x0000ff00

	)

169 
	#SH_CHUNK_SIZE_SHIFT
 16

	)

170 
	#SH_CHUNK_SIZE_MASK
 0x00ff0000

	)

171 
	#SH_RAID_STRIPES_SHIFT
 24

	)

172 
	#SH_RAID_STRIPES_MASK
 0xff000000

	)

175 
	#SH_ECC_BYPASS_SHIFT
 0

	)

176 
	#SH_ECC_BYPASS_MASK
 0x000000ff

	)

177 
	#SH_ECC_CORRECT_POWER_SHIFT
 8

	)

178 
	#SH_ECC_CORRECT_POWER_MASK
 0x00000f00

	)

179 
	#SH_ECC_FORCE_SECOND_SHIFT
 12

	)

180 
	#SH_ECC_FORCE_SECOND_MASK
 0x0000f000

	)

181 
	#SH_ECC_CODEWORD_SIZE_SHIFT
 16

	)

182 
	#SH_ECC_CODEWORD_SIZE_MASK
 0xffff0000

	)

185 
	#SH_INT_DELAY_SHIFT
 0

	)

186 
	#SH_INT_DELAY_MASK
 0x0000ffff

	)

187 
	#SH_POWER_BUDGET_SHIFT
 16

	)

188 
	#SH_POWER_BUDGET_MASK
 0x00ff0000

	)

189 
	#SH_SEED_IN_HIGH_SHIFT
 24

	)

190 
	#SH_SEED_IN_HIGH_MASK
 0xff000000

	)

193 
	#SH_THROTTLE_SHIFT
 8

	)

194 
	#SH_THROTTLE_MASK
 0x0000ff00

	)

195 
	#SH_HALTREAD_SHIFT
 16

	)

196 
	#SH_HALTREAD_MASK
 0x00ff0000

	)

197 
	#SH_DMA_MAX_READ_SHIFT
 24

	)

198 
	#SH_DMA_MAX_READ_MASK
 0xff000000

	)

200 
	#shªnÚ_£t_»g
(
»g_addr
, 
func
, 
v®ue
) \

201 
	`shªnÚ_wr™–
((
	`shªnÚ_»adl
(
»g_addr
è& ~
SH_
##
func
##
_MASK
è| ((
v®ue
è<< SH_##func##
_SHIFT
),„eg_addr)

	)

203 
	#shªnÚ_»ad_»g
(
»g_addr
, 
func
) \

204 ((
	`shªnÚ_»adl
(
»g_addr
è& 
SH_
##
func
##
_MASK
è>> SH_##func##
_SHIFT
)

	)

	@shannon_scatter.c

1 
	~"shªnÚ_sÿ‰”.h
"

2 
	~<lšux/mm.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/sÿ‰”li¡.h
>

5 
	~<lšux/v”siÚ.h
>

7 
shªnÚ_dma_addr_t
 
	$shªnÚ_sg_dma_add»ss
(
shªnÚ_sg_li¡_t
 *
sg
)

9  
	`sg_dma_add»ss
((
sÿ‰”li¡
 *)
sg
);

10 
	}
}

12 
	$shªnÚ_sg_£t_dma_add»ss
(
shªnÚ_sg_li¡_t
 *
sg
, 
shªnÚ_dma_addr_t
 
dma_addr
)

14 
	`sg_dma_add»ss
((
sÿ‰”li¡
 *)
sg
èğ
dma_addr
;

15 
	}
}

17 
shªnÚ_·ge
 *
	$shªnÚ_sg_·ge
(
shªnÚ_sg_li¡_t
 *
sg
)

19 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

20  
	`sg_·ge
((
sÿ‰”li¡
 *)
sg
);

22  ((
sÿ‰”li¡
 *)
sg
)->
·ge
;

24 
	}
}

26 
	$shªnÚ_sg_off£t
(
shªnÚ_sg_li¡_t
 *
sg
)

28  ((
sÿ‰”li¡
 *)
sg
)->
off£t
;

29 
	}
}

31 
	$shªnÚ_sg_Ëngth
(
shªnÚ_sg_li¡_t
 *
sg
)

33  ((
sÿ‰”li¡
 *)
sg
)->
Ëngth
;

34 
	}
}

36 
	$shªnÚ_sg_m¬k_’d
(
shªnÚ_sg_li¡_t
 *
sg
)

38 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

39 
	`sg_m¬k_’d
((
sÿ‰”li¡
 *)
sg
);

41 
	}
}

43 
shªnÚ_sg_li¡_t
 *
	$shªnÚ_sg_®loc
(
ÃÁs
, 
shªnÚ_gå_t
 
gå_mask
)

45  
	`kz®loc
((
sÿ‰”li¡
è* 
ÃÁs
, 
gå_mask
);

46 
	}
}

48 
	$shªnÚ_sg_ä“
(
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
)

50 
	`kä“
(
sgl
);

51 
	}
}

53 
	$shªnÚ_sg_š™_bË
(
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
)

55 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

56 
	`sg_š™_bË
(
sgl
, 
ÃÁs
);

58 
	`mem£t
(
sgl
, 0, (
sÿ‰”li¡
è* 
ÃÁs
);

60 
	}
}

62 
	$shªnÚ_sg_£t_·ge
(
shªnÚ_sg_li¡_t
 *
sg
, 
shªnÚ_·ge
 *
·ge
,

63 
Ën
, 
off£t
)

65 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

66  
	`sg_£t_·ge
((
sÿ‰”li¡
 *)
sg
, 
·ge
, 
Ën
, 
off£t
);

68 
sÿ‰”li¡
 *
sg_lšux
 = 
NULL
;

70 
sg_lšux
 = (
sÿ‰”li¡
 *)
sg
;

72 
sg_lšux
->
·ge
 =…age;

73 
sg_lšux
->
off£t
 = offset;

74 
sg_lšux
->
Ëngth
 = 
Ën
;

76 
	}
}

78 *
	$shªnÚ_sg_vœt
(
shªnÚ_sg_li¡_t
 *
sg
)

80 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

81  
	`sg_vœt
((
sÿ‰”li¡
 *)
sg
);

83  
	`·ge_add»ss
(((
sÿ‰”li¡
 *)
sg
)->
·ge
è+ ((sÿ‰”li¡ *)sg)->
off£t
;

85 
	}
}

87 
shªnÚ_sg_li¡_t
 *
	$shªnÚ_sg_Ãxt
(
shªnÚ_sg_li¡_t
 *
sg
)

89 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 24)

90  
	`sg_Ãxt
((
sÿ‰”li¡
 *)
sg
);

92  (
sÿ‰”li¡
 *)
sg
 + 1;

94 
	}
}

	@shannon_scatter.h

1 #iâdeà
__SHANNON_SCATTER_H


2 
	#__SHANNON_SCATTER_H


	)

3 
	~"shªnÚ_kcÜe.h
"

5 
	tshªnÚ_sg_li¡_t
;

7 
shªnÚ_dma_addr_t
 
shªnÚ_sg_dma_add»ss
(
shªnÚ_sg_li¡_t
 *
sg
);

8 
shªnÚ_sg_£t_dma_add»ss
(
shªnÚ_sg_li¡_t
 *
sg
, 
shªnÚ_dma_addr_t
 
dma_addr
);

9 
shªnÚ_·ge
 *
shªnÚ_sg_·ge
(
shªnÚ_sg_li¡_t
 *
sg
);

10 
shªnÚ_sg_off£t
(
shªnÚ_sg_li¡_t
 *
sg
);

11 
shªnÚ_sg_Ëngth
(
shªnÚ_sg_li¡_t
 *
sg
);

12 
shªnÚ_sg_m¬k_’d
(
shªnÚ_sg_li¡_t
 *
sg
);

14 
	#shªnÚ_fÜ_—ch_sg
(
sgli¡
, 
sg
, 
Ä
, 
__i
) \

15 
__i
 = 0, 
sg
 = (
sgli¡
); __˜< (
Ä
); __i++, sg = 
	`shªnÚ_sg_Ãxt
(sg))

	)

18 
shªnÚ_sg_li¡_t
 *
shªnÚ_sg_®loc
(
ÃÁs
, 
shªnÚ_gå_t
 
gå_mask
);

19 
shªnÚ_sg_ä“
(
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
);

20 
shªnÚ_sg_š™_bË
(
shªnÚ_sg_li¡_t
 *
sgl
, 
ÃÁs
);

22 
shªnÚ_sg_li¡_t
 *
shªnÚ_sg_Ãxt
(shªnÚ_sg_li¡_ˆ*
sg
);

23 *
shªnÚ_sg_vœt
(
shªnÚ_sg_li¡_t
 *
sg
);

24 
shªnÚ_sg_£t_·ge
(
shªnÚ_sg_li¡_t
 *
sg
, 
shªnÚ_·ge
 *
·ge
, 
Ën
, 
off£t
);

	@shannon_sched.c

1 
	~"shªnÚ_sched.h
"

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/š‹¼u±.h
>

4 
	~<lšux/sched.h
>

5 
	~<lšux/kth»ad.h
>

6 
	~<lšux/v”siÚ.h
>

8 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(3, 9, 0)

9 
	~<lšux/sched/¹.h
>

12 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(4, 11, 0)

13 
	~<lšux/sched/sigÇl.h
>

14 
	~<lšux/sched/debug.h
>

15 
	~<u­i/lšux/sched/ty³s.h
>

18 *
	$shªnÚ_cu¼’t
()

20  
cu¼’t
;

21 
	}
}

23 
	$shªnÚ_sigÇl_³ndšg
(*
p
)

25 
sk_¡ruù
 *
sk
 = (sk_¡ruù *)
p
;

26  
	`sigÇl_³ndšg
(
sk
);

27 
	}
}

29 
	$shªnÚ_š_soáœq
()

31  
	`š_soáœq
();

32 
	}
}

35 
œq»tuº_t
 
shªnÚ_š‹¼u±_w¿µ”
(
œq
, *
d©a


36 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 19)

37 , 
±_»gs
 *
»gs


41 
shªnÚ_š‹¼u±
(
œq
, 
d©a
);

42  
	gIRQ_HANDLED
;

45 
	$shªnÚ_di§bË_œq
(
œq
)

47 
	`di§bË_œq
(
œq
);

48 
	}
}

50 
	$shªnÚ_’abË_œq
(
œq
)

52 
	`’abË_œq
(
œq
);

53 
	}
}

55 
	$shªnÚ_»que¡_œq
(
œq
, cÚ¡ *
devÇme
, *
d©a
)

57  
	`»que¡_œq
(
œq
, 
shªnÚ_š‹¼u±_w¿µ”
, 0, 
devÇme
, 
d©a
);

58 
	}
}

60 
	$shªnÚ_skËt_scheduË
(
shªnÚ_skËt_¡ruù
 *
t
)

62 
	`skËt_scheduË
((
skËt_¡ruù
 *)
t
);

63 
	}
}

65 
shªnÚ_skËt_š™
(
shªnÚ_skËt_¡ruù
 *
t
, (*
func
)(), 
d©a
)

67 
	`skËt_š™
((
skËt_¡ruù
 *)
t
, 
func
, 
d©a
);

68 
	}
}

70 
	$shªnÚ_ä“_œq
(
œq
, *
dev_id
)

72 
	`ä“_œq
(
œq
, 
dev_id
);

73 
	}
}

77 
	$shªnÚ_wake_up_´oûss
(
shªnÚ_sk_¡ruù_t
 *
tsk
)

79  
	`wake_up_´oûss
((
sk_¡ruù
 *)
tsk
);

80 
	}
}

82 
	$shªnÚ_scheduË
()

84 
	`scheduË
();

85 
	}
}

87 sigÃd 
__sched
 
	$shªnÚ_scheduË_timeout
(sigÃd 
timeout
)

89  
	`scheduË_timeout
(
timeout
);

90 
	}
}

92 
	$shªnÚ_£t_cu¼’t_¡©e
(
¡©e
)

94 
	`£t_cu¼’t_¡©e
(
¡©e
);

95 
	}
}

97 
	$__shªnÚ_£t_cu¼’t_¡©e
(
¡©e
)

99 
	`__£t_cu¼’t_¡©e
(
¡©e
);

100 
	}
}

102 
	$shªnÚ_cÚd_»sched
()

104 
	`cÚd_»sched
();

105 
	}
}

107 
	$£t_th»ad_nÜm®
()

109 
sched_·¿m
 
·¿m
 = { .
sched_´iÜ™y
 = 0 };

110  
	`sched_£tscheduËr
(
cu¼’t
, 
SCHED_NORMAL
, &
·¿m
);

111 
	}
}

113 
	$£t_th»ad_¹
()

115 
sched_·¿m
 
·¿m
 = { .
sched_´iÜ™y
 = 
MAX_USER_RT_PRIO
-1 };

116  
	`sched_£tscheduËr
(
cu¼’t
, 
SCHED_FIFO
, &
·¿m
);

117 
	}
}

120 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 22)

121 *
	$kva¥rštf
(
gå_t
 
gå
, cÚ¡ *
fmt
, 
va_li¡
 
­
)

123 
Ën
;

124 *
p
;

125 
va_li¡
 
aq
;

127 
	`va_cİy
(
aq
, 
­
);

128 
Ën
 = 
	`v¢´štf
(
NULL
, 0, 
fmt
, 
aq
);

129 
	`va_’d
(
aq
);

131 
p
 = 
	`km®loc
(
Ën
+1, 
gå
);

132 ià(!
p
)

133  
NULL
;

135 
	`v¢´štf
(
p
, 
Ën
+1, 
fmt
, 
­
);

137  
p
;

138 
	}
}

142 
shªnÚ_sk_¡ruù_t
 * 
shªnÚ_kth»ad_run
((*
th»adâ
)(*
d©a
), *d©a, cÚ¡ *
Çmefmt
, ...)

144 
shªnÚ_sk_¡ruù_t
 *
sk
;

145 
va_li¡
 
­
;

146 *
p
;

148 
	`va_¡¬t
(
­
, 
Çmefmt
);

149 
p
 = 
	`kva¥rštf
(
GFP_SHANNON
, 
Çmefmt
, 
­
);

150 
	`va_’d
(
­
);

152 
sk
 = 
	`kth»ad_run
(
th»adâ
, 
d©a
, 
p
);

153 
	`shªnÚ_kä“
(
p
);

155  
sk
;

156 
	}
}

158 
	$shªnÚ_kth»ad_¡İ
(
shªnÚ_sk_¡ruù_t
 *
k
)

160  
	`kth»ad_¡İ
((
sk_¡ruù
 *)
k
);

161 
	}
}

163 
	$shªnÚ_kth»ad_should_¡İ
()

165  
	`kth»ad_should_¡İ
();

166 
	}
}

168 
	$shªnÚ_£t_node_ıus_®lowed
(
shªnÚ_sk_¡ruù_t
 *
k
, 
node
)

170 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 29)

171 ià(
node
 !ğ
NUMA_NO_NODE
) {

172 cÚ¡ 
ıumask
 *ıumask = 
	`ıumask_of_node
(
node
);

174 ià(!
	`ıumask_em±y
(
ıumask
))

175  
	`£t_ıus_®lowed_±r
((
sk_¡ruù
 *)
k
, 
ıumask
);

180 
	}
}

	@shannon_sched.h

1 #iâdeà
__SHANNON_SCHED_H


2 
	#__SHANNON_SCHED_H


	)

4 
	~"shªnÚ_kcÜe.h
"

6 
	#SHANNON_IRQ_NONE
 0

	)

7 
	#SHANNON_IRQ_HANDLED
 1

	)

8 
	#SHANNON_IRQ_WAKE_THREAD
 2

	)

10 
	#SHN_TASK_RUNNING
 0

	)

11 
	#SHN_TASK_INTERRUPTIBLE
 1

	)

12 
	#SHN_TASK_UNINTERRUPTIBLE
 2

	)

13 
	#__SHN_TASK_STOPPED
 4

	)

14 
	#__SHN_TASK_TRACED
 8

	)

16 
	#SHN_EXIT_ZOMBIE
 16

	)

17 
	#SHN_EXIT_DEAD
 32

	)

19 
	#SHN_TASK_DEAD
 64

	)

20 
	#SHN_TASK_WAKEKILL
 128

	)

21 
	#SHN_TASK_WAKING
 256

	)

22 
	#SHN_TASK_STATE_MAX
 512

	)

24 
	#SHN_TASK_KILLABLE
 (
SHN_TASK_WAKEKILL
 | 
SHN_TASK_UNINTERRUPTIBLE
)

	)

25 
	#SHN_TASK_STOPPED
 (
SHN_TASK_WAKEKILL
 | 
__SHN_TASK_STOPPED
)

	)

26 
	#SHN_TASK_TRACED
 (
SHN_TASK_WAKEKILL
 | 
__SHN_TASK_TRACED
)

	)

28 
	sshªnÚ_skËt_¡ruù
 {

29 
RESERVE_MEM
(56);

32 
	tshªnÚ_sk_¡ruù_t
;

34 *
shªnÚ_cu¼’t
();

35 
shªnÚ_sigÇl_³ndšg
(*
p
);

36 
shªnÚ_š_soáœq
();

39 
shªnÚ_š‹¼u±
(
œq
, *
d©a
);

40 
shªnÚ_di§bË_œq
(
œq
);

41 
shªnÚ_’abË_œq
(
œq
);

42 
shªnÚ_»que¡_œq
(
œq
, cÚ¡ *
devÇme
, *
d©a
);

44 
shªnÚ_skËt_scheduË
(
shªnÚ_skËt_¡ruù
 *
t
);

45 
shªnÚ_skËt_š™
(
shªnÚ_skËt_¡ruù
 *
t
, (*
func
)(), 
d©a
);

46 
	`shªnÚ_ä“_œq
(
œq
, *
dev_id
);

49 
	`shªnÚ_scheduË
();

50 sigÃd 
	`shªnÚ_scheduË_timeout
(sigÃd 
timeout
);

51 
	`shªnÚ_wake_up_´oûss
(
shªnÚ_sk_¡ruù_t
 *
tsk
);

52 
	`shªnÚ_£t_cu¼’t_¡©e
(
¡©e
);

53 
	`__shªnÚ_£t_cu¼’t_¡©e
(
¡©e
);

54 
	`shªnÚ_cÚd_»sched
();

55 
	`£t_th»ad_¹
();

56 
	`£t_th»ad_nÜm®
();

57 
	`shªnÚ_£t_node_ıus_®lowed
(
shªnÚ_sk_¡ruù_t
 *
k
, 
node
);

60 
shªnÚ_sk_¡ruù_t
 * 
	`shªnÚ_kth»ad_run
((*
th»adâ
)(*
d©a
), *d©a, cÚ¡ *
Çmefmt
, ...);

61 
	`shªnÚ_kth»ad_¡İ
(
shªnÚ_sk_¡ruù_t
 *
k
);

62 
	`shªnÚ_kth»ad_should_¡İ
();

	@shannon_scsi.c

1 
	~<scsi/scsi.h
>

2 
	~<scsi/scsi_cmnd.h
>

3 
	~<scsi/scsi_deviû.h
>

4 
	~<scsi/scsi_ho¡.h
>

5 
	~<scsi/scsi_eh.h
>

6 
	~<lšux/pci.h
>

7 
	~<lšux/v”siÚ.h
>

8 
	~<lšux/sÿ‰”li¡.h
>

9 
	~<lšux/blkdev.h
>

10 
	~<lšux/highmem.h
>

11 
	~<lšux/moduË.h
>

12 
	~"shªnÚ_pÜt.h
"

14 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

16 
	$shªnÚ_fl_äom_dev_bufãr
(*
scsi_cmnd
, *
¬r
, 
¬r_Ën
)

18 
scsi_cmnd
 *
sı
 = (scsi_cmnd *)scsi_cmnd;

19 
k
, 
»q_Ën
, 
aù_Ën
, 
Ën
, 
aùive
;

20 * 
kaddr
;

21 * 
kaddr_off
;

22 
sÿ‰”li¡
 * 
sg²t
;

24 ià(0 =ğ
sı
->
»que¡_bufæ’
)

26 ià(
NULL
 =ğ
sı
->
»que¡_bufãr
)

27  (
DID_ERROR
 << 16);

28 ià(! ((
sı
->
sc_d©a_dœeùiÚ
 =ğ
DMA_BIDIRECTIONAL
) ||

29 (
sı
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
)))

30  (
DID_ERROR
 << 16);

31 ià(0 =ğ
sı
->
u£_sg
) {

32 
»q_Ën
 = 
sı
->
»que¡_bufæ’
;

33 
aù_Ën
 = (
»q_Ën
 < 
¬r_Ën
) ?„eq_len :‡rr_len;

34 
	`memıy
(
sı
->
»que¡_bufãr
, 
¬r
, 
aù_Ën
);

35 ià(
sı
->
»sid
)

36 
sı
->
»sid
 -ğ
aù_Ën
;

38 
sı
->
»sid
 = 
»q_Ën
 - 
aù_Ën
;

41 
sg²t
 = (
sÿ‰”li¡
 *)
sı
->
»que¡_bufãr
;

42 
aùive
 = 1;

43 
k
 = 0, 
»q_Ën
 = 0, 
aù_Ën
 = 0; k < 
sı
->
u£_sg
; ++k, ++
sg²t
) {

44 ià(
aùive
) {

45 
kaddr
 = (*)

46 
	`km­_©omic
(
sg²t
->
·ge
, 
KM_USER0
);

47 ià(
NULL
 =ğ
kaddr
)

48  (
DID_ERROR
 << 16);

49 
kaddr_off
 = (*)
kaddr
 + 
sg²t
->
off£t
;

50 
Ën
 = 
sg²t
->
Ëngth
;

51 ià((
»q_Ën
 + 
Ën
è> 
¬r_Ën
) {

52 
aùive
 = 0;

53 
Ën
 = 
¬r_Ën
 - 
»q_Ën
;

55 
	`memıy
(
kaddr_off
, 
¬r
 + 
»q_Ën
, 
Ën
);

56 
	`kunm­_©omic
(
kaddr
, 
KM_USER0
);

57 
aù_Ën
 +ğ
Ën
;

59 
»q_Ën
 +ğ
sg²t
->
Ëngth
;

61 ià(
sı
->
»sid
)

62 
sı
->
»sid
 -ğ
aù_Ën
;

64 
sı
->
»sid
 = 
»q_Ën
 - 
aù_Ën
;

66 
	}
}

68 #–ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 25)

70 
	$shªnÚ_fl_äom_dev_bufãr
(*
scsi_cmnd
, *
¬r
, 
¬r_Ën
)

72 
scsi_cmnd
 *
sı
 = (scsi_cmnd *)scsi_cmnd;

73 
k
, 
»q_Ën
, 
aù_Ën
, 
Ën
, 
aùive
;

74 * 
kaddr
;

75 * 
kaddr_off
;

76 
sÿ‰”li¡
 * 
sg
;

78 ià(0 =ğ
sı
->
»que¡_bufæ’
)

80 ià(
NULL
 =ğ
sı
->
»que¡_bufãr
)

81  (
DID_ERROR
 << 16);

82 ià(! ((
sı
->
sc_d©a_dœeùiÚ
 =ğ
DMA_BIDIRECTIONAL
) ||

83 (
sı
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
)))

84  (
DID_ERROR
 << 16);

85 ià(0 =ğ
sı
->
u£_sg
) {

86 
»q_Ën
 = 
sı
->
»que¡_bufæ’
;

87 
aù_Ën
 = (
»q_Ën
 < 
¬r_Ën
) ?„eq_len :‡rr_len;

88 
	`memıy
(
sı
->
»que¡_bufãr
, 
¬r
, 
aù_Ën
);

89 ià(
sı
->
»sid
)

90 
sı
->
»sid
 -ğ
aù_Ën
;

92 
sı
->
»sid
 = 
»q_Ën
 - 
aù_Ën
;

95 
aùive
 = 1;

96 
»q_Ën
 = 
aù_Ën
 = 0;

97 
	`scsi_fÜ_—ch_sg
(
sı
, 
sg
, sı->
u£_sg
, 
k
) {

98 ià(
aùive
) {

99 
kaddr
 = (*)

100 
	`km­_©omic
(
	`sg_·ge
(
sg
), 
KM_USER0
);

101 ià(
NULL
 =ğ
kaddr
)

102  (
DID_ERROR
 << 16);

103 
kaddr_off
 = (*)
kaddr
 + 
sg
->
off£t
;

104 
Ën
 = 
sg
->
Ëngth
;

105 ià((
»q_Ën
 + 
Ën
è> 
¬r_Ën
) {

106 
aùive
 = 0;

107 
Ën
 = 
¬r_Ën
 - 
»q_Ën
;

109 
	`memıy
(
kaddr_off
, 
¬r
 + 
»q_Ën
, 
Ën
);

110 
	`kunm­_©omic
(
kaddr
, 
KM_USER0
);

111 
aù_Ën
 +ğ
Ën
;

113 
»q_Ën
 +ğ
sg
->
Ëngth
;

115 ià(
sı
->
»sid
)

116 
sı
->
»sid
 -ğ
aù_Ën
;

118 
sı
->
»sid
 = 
»q_Ën
 - 
aù_Ën
;

120 
	}
}

122 #–ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 26)

124 
	$shªnÚ_fl_äom_dev_bufãr
(*
scsi_cmnd
, *
¬r
, 
¬r_Ën
)

126 
scsi_cmnd
 *
sı
 = (scsi_cmnd *)scsi_cmnd;

127 
k
, 
»q_Ën
, 
aù_Ën
, 
Ën
, 
aùive
;

128 * 
kaddr
;

129 * 
kaddr_off
;

130 
sÿ‰”li¡
 *
sg
;

131 
scsi_d©a_bufãr
 *
sdb
 = 
	`scsi_š
(
sı
);

133 ià(!
sdb
->
Ëngth
)

135 ià(!
sdb
->
bË
.
sgl
)

136  (
DID_ERROR
 << 16);

137 ià(!(
	`scsi_bidi_cmnd
(
sı
è|| sı->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
))

138  (
DID_ERROR
 << 16);

139 
aùive
 = 1;

140 
»q_Ën
 = 
aù_Ën
 = 0;

141 
	`fÜ_—ch_sg
(
sdb
->
bË
.
sgl
, 
sg
, sdb->bË.
ÃÁs
, 
k
) {

142 ià(
aùive
) {

143 
kaddr
 = (*)

144 
	`km­_©omic
(
	`sg_·ge
(
sg
), 
KM_USER0
);

145 ià(
NULL
 =ğ
kaddr
)

146  (
DID_ERROR
 << 16);

147 
kaddr_off
 = (*)
kaddr
 + 
sg
->
off£t
;

148 
Ën
 = 
sg
->
Ëngth
;

149 ià((
»q_Ën
 + 
Ën
è> 
¬r_Ën
) {

150 
aùive
 = 0;

151 
Ën
 = 
¬r_Ën
 - 
»q_Ën
;

153 
	`memıy
(
kaddr_off
, 
¬r
 + 
»q_Ën
, 
Ën
);

154 
	`kunm­_©omic
(
kaddr
, 
KM_USER0
);

155 
aù_Ën
 +ğ
Ën
;

157 
»q_Ën
 +ğ
sg
->
Ëngth
;

159 ià(
sdb
->
»sid
)

160 
sdb
->
»sid
 -ğ
aù_Ën
;

162 
sdb
->
»sid
 = 
»q_Ën
 - 
aù_Ën
;

164 
	}
}

168 
	$shªnÚ_fl_äom_dev_bufãr
(*
scsi_cmnd
, *
¬r
, 
¬r_Ën
)

170 
scsi_cmnd
 *
sı
 = (scsi_cmnd *)scsi_cmnd;

171 
aù_Ën
;

172 
scsi_d©a_bufãr
 *
sdb
 = 
	`scsi_š
(
sı
);

174 ià(!
sdb
->
Ëngth
)

176 ià(!(
	`scsi_bidi_cmnd
(
sı
è|| sı->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
))

177  
DID_ERROR
 << 16;

179 
aù_Ën
 = 
	`sg_cİy_äom_bufãr
(
sdb
->
bË
.
sgl
, sdb->bË.
ÃÁs
,

180 
¬r
, 
¬r_Ën
);

181 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3, 11, 0)

182 
sdb
->
»sid
 = 
	`scsi_bufæ’
(
sı
è- 
aù_Ën
;

184 ià(
sdb
->
»sid
)

185 
sdb
->
»sid
 -ğ
aù_Ën
;

187 
sdb
->
»sid
 = 
	`scsi_bufæ’
(
sı
è- 
aù_Ën
;

191 
	}
}

195 
	$shªnÚ_bud_£n£_bufãr
(*
sbuff
, 
key
, 
asc
, 
asq
)

197 
	`mem£t
(
sbuff
, 0, 
SHANNON_SCSI_SENSE_LEN
);

198 
	`scsi_bud_£n£_bufãr
(0, 
sbuff
, 
key
, 
asc
, 
asq
);

199 
	}
}

201 
	$’d_scsi_cmnd
(
shªnÚ_bio
 *
sbio
, 
shªnÚ_scsi_cmd_¡©us
 
scsi_¡©us
, *
£n£_bufãr
)

203 
scsi_cmnd
 *scsi_cmnd = (scsi_cmnd *)
sbio
->scsi_cmnd;

205 ià((
scsi_¡©us
 & 0xffè=ğ
STATUS_CODE_CHECK_CONDITION
) {

206 ià(
scsi_cmnd
 && 
£n£_bufãr
)

207 
	`memıy
(
scsi_cmnd
->
£n£_bufãr
, s’£_bufãr, 
SHANNON_SCSI_SENSE_LEN
);

209 
scsi_cmnd
->
»suÉ
 = 
scsi_¡©us
;

210 
scsi_cmnd
->
ho¡_süibbË
 = 
NULL
;

211 
scsi_cmnd
->
	`scsi_dÚe
(scsi_cmnd);

212 
	}
}

214 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 24)

216 
	#sg_Ãxt
(
sg
è((sgè+ 1)

	)

217 
	#sg_Ï¡
(
sg
, 
ÃÁs
è(&(sg[Ò’tsè- 1]))

	)

222 
	#fÜ_—ch_sg
(
sgli¡
, 
sg
, 
Ä
, 
__i
) \

223 
__i
 = 0, 
sg
 = (
sgli¡
); __˜< (
Ä
); __i++, sg = 
	`sg_Ãxt
(sg))

	)

225 
	#sg_·ge
(
sg
è((sg)->
·ge
)

	)

229 
	$shªnÚ_cÚv”t_scsi_scmd
(
shªnÚ_bio
 *
sbio
, 
logicb_size
)

231 
scsi_cmnd
 *scsi_cmnd = (scsi_cmnd *)
sbio
->scsi_cmnd;

232 
·ge
 *page;

233 
shªnÚ_sg_li¡_t
 *
sg
 = 
NULL
;

234 
i
, 
off£t
, 
»mašed_size
, 
m­_size
 = 0, 
undÚe
 = 0;

235 
¥aû_š_·ge
;

236 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

237 
scsi_d©a_bufãr
 *
sdb
 = &
scsi_cmnd
->sdb;

238 
sÿ‰”li¡
 *
sgl
 = 
sdb
->
bË
.sgl, *
sge
;

239 
sbio
->
bio_size
 = 
sdb
->
Ëngth
;

241 
sÿ‰”li¡
 *
sgl
 = (sÿ‰”li¡ *)
scsi_cmnd
->
»que¡_bufãr
, *
sge
;

242 
sbio
->
bio_size
 = 
scsi_cmnd
->
»que¡_bufæ’
;

245 ià(
scsi_cmnd
->
sc_d©a_dœeùiÚ
 =ğ
DMA_FROM_DEVICE
)

246 
sbio
->
dma_dœ
 = 
SHANNON_DMA_FROMDEVICE
;

247 ià(
scsi_cmnd
->
sc_d©a_dœeùiÚ
 =ğ
DMA_TO_DEVICE
)

248 
sbio
->
dma_dœ
 = 
SHANNON_DMA_TODEVICE
;

250 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

251 
sbio
->
£gm’ts
 = 
sdb
->
bË
.
ÃÁs
;

253 
sbio
->
£gm’ts
 = 
scsi_cmnd
->
u£_sg
;

254 
	`BUG_ON
(0 =ğ
scsi_cmnd
->
u£_sg
);

256 
sbio
->
sg_couÁ
 = 2 * ((sbio->
bio_size
 + 
logicb_size
 - 1)/logicb_sizeè+ sbio->
£gm’ts
;

257 
sbio
->
sg
 = 
	`shªnÚ_sg_®loc
(sbio->
sg_couÁ
, 
GFP_ATOMIC
);

258 ià(
sbio
->
sg
 =ğ
NULL
) {

259 
	`shªnÚ_”r
("alloc sg failed.\n");

260  -
ENOMEM
;

262 
	`shªnÚ_sg_š™_bË
(
sbio
->
sg
, sbio->
sg_couÁ
);

264 
sbio
->
fœ¡_size
 = 
logicb_size
 - ((sbio->
¡¬t_£ùÜ
 << 9) & (logicb_size - 1));

265 
sbio
->
fœ¡_size
 = sbio->fœ¡_siz% 
logicb_size
;

266 
sbio
->
fœ¡_size
 = 
	`mš
(sbio->
bio_size
, sbio->first_size);

268 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

269 
	`debugs1
("sdb->length=%d, bio_size=%d, start_sector=0x%lx, segments=%d, sg_count=%d, first_size=%d.\n",

270 
sdb
->
Ëngth
, 
sbio
->
bio_size
, sbio->
¡¬t_£ùÜ
, sbio->
£gm’ts
, sbio->
sg_couÁ
, sbio->
fœ¡_size
);

272 
	`debugs1
("scsi_cmnd->request_bufflen=%d, bio_size=%d, start_sector=0x%lx, segments=%d, sg_count=%d, first_size=%d.\n",

273 
scsi_cmnd
->
»que¡_bufæ’
, 
sbio
->
bio_size
, sbio->
¡¬t_£ùÜ
, sbio->
£gm’ts
, sbio->
sg_couÁ
, sbio->
fœ¡_size
);

276 
»mašed_size
 = 
sbio
->
fœ¡_size
 ? sbio->fœ¡_siz: 
logicb_size
;

278 
sbio
->
has_hŞe
 = 0;

279 
sbio
->
u£d_sg_couÁ
 = 0;

280 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

281 
	`fÜ_—ch_sg
(
sgl
, 
sge
, 
sdb
->
bË
.
ÃÁs
, 
i
) {

282 
	`debugs1
("i=%d,‚’ts=%d, off£t=%d,†’gth=%d.\n", 
i
, 
sdb
->
bË
.
ÃÁs
, 
sge
->
off£t
, sge->
Ëngth
);

284 
	`fÜ_—ch_sg
(
sgl
, 
sge
, 
scsi_cmnd
->
u£_sg
, 
i
) {

285 
	`debugs1
("i=%d,‚’ts=%d, off£t=%d,†’gth=%d.\n", 
i
, 
scsi_cmnd
->
u£_sg
, 
sge
->
off£t
, sge->
Ëngth
);

288 ià((
i
 !ğ0è&& (
sge
->
off£t
 != 0))

289 
sbio
->
has_hŞe
 = 1;

291 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

292 ià((
i
 !ğ
sdb
->
bË
.
ÃÁs
-1è&& ((
sge
->
off£t
 + sge->
Ëngth
)&0xfff))

294 ià((
i
 !ğ
scsi_cmnd
->
u£_sg
-1è&& ((
sge
->
off£t
 + sge->
Ëngth
)&0xfff))

296 
sbio
->
has_hŞe
 = 1;

298 
off£t
 = 0;

299 
off£t
 < 
sge
->
Ëngth
 && 
sbio
->
u£d_sg_couÁ
 < sbio->
sg_couÁ
) {

300 
¥aû_š_·ge
 = 
PAGE_SIZE
 - ((
sge
->
off£t
 + offset) % PAGE_SIZE);

301 ià(
¥aû_š_·ge
 < 
»mašed_size
) {

302 ià((
sge
->
Ëngth
 - 
off£t
è< 
¥aû_š_·ge
) {

303 
m­_size
 = 
sge
->
Ëngth
 - 
off£t
;

304 
undÚe
 = 1;

306 
m­_size
 = 
¥aû_š_·ge
;

307 
undÚe
 = 1;

310 ià((
sge
->
Ëngth
 - 
off£t
è< 
»mašed_size
) {

311 
m­_size
 = 
sge
->
Ëngth
 - 
off£t
;

312 
undÚe
 = 1;

314 
m­_size
 = 
»mašed_size
;

315 
undÚe
 = 0;

318 
»mašed_size
 -ğ
m­_size
;

319 ià(
»mašed_size
 == 0)

320 
»mašed_size
 = 
logicb_size
;

321 
sg
 = sg ? 
	`shªnÚ_sg_Ãxt
(sgè: 
sbio
->sg;

322 
	`debugs1
("off£t=%d, m­_size=%d.\n", 
off£t
, 
m­_size
);

323 
·ge
 = 
	`sg_·ge
(
sge
);

324 
	`shªnÚ_sg_£t_·ge
(
sg
, 
·ge
 + (
sge
->
off£t
 + off£t)/
PAGE_SIZE
, 
m­_size
, (sge->offset + offset) % PAGE_SIZE);

325 
sbio
->
u£d_sg_couÁ
++;

326 
off£t
 +ğ
m­_size
;

328 
	`BUG_ON
(
off£t
 < 
sge
->
Ëngth
);

331 
sg
 = 
sbio
->sg;

332 
i
 = 0; i < 
sbio
->
sg_couÁ
; i++) {

333 
	`shªnÚ_šfo
("i=%d, sg=0x%lx, shªnÚ_sg_·ge(sg)=0x%lx.\n", 
i
, 
sg
, 
	`shªnÚ_sg_·ge
(sg));

334 
sg
 = 
	`shªnÚ_sg_Ãxt
(sg);

339 
	}
}

341 
shªnÚ_»ûive_scsi_cmd
(
shªnÚ_bio
 *
sbio
, *
£n£_bufãr
);

342 
shªnÚ_scsi_queuecommªd_lck
(
scsi_cmnd
 *scsi_cmnd, (*
dÚe_â
)(scsi_cmnd *))

344 
Scsi_Ho¡
 *
sho¡
 = 
scsi_cmnd
->
deviû
->
ho¡
;

345 
scsi_deviû
 *
sdeviû
 = 
scsi_cmnd
->
deviû
;

346 
scsi_rg‘
 *
¡¬g‘
 = 
	`scsi_rg‘
(
sdeviû
);

348 
shªnÚ_bio
 *
sbio
;

349 
£n£_bufãr
[
SHANNON_SCSI_SENSE_LEN
];

350 
»t
;

352 
	`debugs1
("host=%d, channel=%d,arget=%d,†un=%d, cmd=0x%x.\n",

353 
sho¡
->
this_id
, 
¡¬g‘
->
chªÃl
, srg‘->
id
, 
sdeviû
->
lun
, *
scsi_cmnd
->
cmnd
);

354 
scsi_cmnd
->
scsi_dÚe
 = 
dÚe_â
;

355 
sbio
 = 
	`®loc_sbio
(
GFP_NOWAIT
);

356 
sbio
->
ho¡d©a
 = (
shªnÚ_scsi_´iv©e
 *)
sho¡
->hostdata;

357 
sbio
->
scsi_cmnd
 = scsi_cmnd;

358 
sbio
->
cmd
 = 
scsi_cmnd
->
cmnd
;

360 
scsi_cmnd
->
ho¡_süibbË
 = (*)
sbio
;

362 ià(
¡¬g‘
->
id
 != 0) {

363 
	`debugs1
("rg‘ i ab£Á!¬g‘=%d, cmd=0x%x.\n", 
¡¬g‘
->
id
, *
sbio
->
cmd
);

364 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_LOGICAL_UNIT_NOT_READY
, 0);

365 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

366 
	`ä“_sbio
(
sbio
);

370 
»t
 = 
	`shªnÚ_»ûive_scsi_cmd
(
sbio
, 
£n£_bufãr
);

371  
»t
;

372 
	}
}

374 #ià
LINUX_VERSION_CODE
 >ğ
KERNEL_VERSION
(2, 6, 37)

375 
	$DEF_SCSI_QCMD
(
shªnÚ_scsi_queuecommªd
)

378 cÚ¡ *
	$shªnÚ_scsi_šfo
(
Scsi_Ho¡
 *
ho¡
)

381 
	}
}

383 
	$shªnÚ_scsi_bio¥¬am
(
scsi_deviû
 *
sdev
, 
block_deviû
 *
bdev
, 
£ùÜ_t
 
ÿ·c™y
, 
geom
[])

385 
h—ds
, 
£ùÜs
, 
cylšd”s
;

387 
h—ds
 = 64;

388 
£ùÜs
 = 32;

389 
cylšd”s
 = ()
ÿ·c™y
 / (
h—ds
 * 
£ùÜs
);

390 ià(
cylšd”s
 > 1024) {

391 
h—ds
 = 255;

392 
£ùÜs
 = 63;

393 
cylšd”s
 = ()
ÿ·c™y
 / (
h—ds
 * 
£ùÜs
);

395 
geom
[0] = 
h—ds
;

396 
geom
[1] = 
£ùÜs
;

397 
geom
[2] = 
cylšd”s
;

400 
	}
}

402 
	$shªnÚ_scsi_¦ave_cÚfigu»
(
scsi_deviû
 *
sdp
)

404 
	`shªnÚ_šfo
("¦ave_cÚfigu» <%u %u %u %u>\n", 
sdp
->
ho¡
->
ho¡_no
, sdp->
chªÃl
, sdp->
id
, sdp->
lun
);

405 ià(
sdp
->
ho¡
->
max_cmd_Ën
 != 32)

406 
sdp
->
ho¡
->
max_cmd_Ën
 = 32;

407 ià(
sdp
->
ho¡
->
cmd_³r_lun
)

408 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3, 19, 0)

409 
	`scsi_chªge_queue_d•th
(
sdp
, sdp->
ho¡
->
cmd_³r_lun
);

411 
	`scsi_adju¡_queue_d•th
(
sdp
, 0, sdp->
ho¡
->
cmd_³r_lun
);

413 
	`blk_queue_max_£gm’t_size
(
sdp
->
»que¡_queue
, 512 * 1024);

415 
	}
}

418 
scsi_ho¡_‹m¶©e
 
	gshªnÚ_scsi_‹m¶©e
 = {

419 .
moduË
 = 
THIS_MODULE
,

420 .
	gÇme
 = "Shannon Direct IO",

421 .
	gšfo
 = 
shªnÚ_scsi_šfo
,

422 .
	g¦ave_cÚfigu»
 = 
shªnÚ_scsi_¦ave_cÚfigu»
,

423 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 37)

424 .
	gqueuecommªd
 = 
shªnÚ_scsi_queuecommªd_lck
,

426 .
	gqueuecommªd
 = 
shªnÚ_scsi_queuecommªd
,

428 .
	gbios_·¿m
 = 
shªnÚ_scsi_bio¥¬am
,

429 .
	gÿn_queue
 = 0xfffff,

430 .
	gthis_id
 = -1,

431 .
	gsg_bËsize
 = 
SG_ALL
,

432 .
	gcmd_³r_lun
 = 0x3fff,

433 .
	gmax_£ùÜs
 = 0xffff,

434 .
	gu£_şu¡”šg
 = 
DISABLE_CLUSTERING
,

437 
shªnÚ_»move
(*
d©a
, 
shªnÚ_pci_dev_t
 *
pdev
);

438 
shªnÚ_´obe
(
shªnÚ_pci_dev_t
 *
pdev
, cÚ¡ 
shªnÚ_pci_deviû_id_t
 *
id
, 
shªnÚ_scsi_´iv©e
 *
ho¡d©a
);

439 
	$shªnÚ_scsi_´obe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
id
)

441 
Scsi_Ho¡
 *
sho¡
;

442 
shªnÚ_scsi_´iv©e
 *
ho¡d©a
;

444 
sho¡
 = 
	`scsi_ho¡_®loc
(&
shªnÚ_scsi_‹m¶©e
, (
shªnÚ_scsi_´iv©e
));

445 
ho¡d©a
 = (
shªnÚ_scsi_´iv©e
 *)
sho¡
->hostdata;

446 
	`shªnÚ_mem£t
(
ho¡d©a
, 0, (
shªnÚ_scsi_´iv©e
));

447 
ho¡d©a
->
scsi_ho¡
 = 
sho¡
;

448 
ho¡d©a
->
scsi_ho¡_no
 = 
sho¡
->
ho¡_no
;

449 
	`shªnÚ_pci_£t_drvd©a
(
pdev
, 
ho¡d©a
);

450 
	`shªnÚ_¥š_lock_š™
(&
ho¡d©a
->
¡©s_lock
);

451 
ho¡d©a
->
£ùÜs
[0] = hostdata->sectors[1] = 0;

452 
ho¡d©a
->
ios
[0] = hostdata->ios[1] = 0;

453 
ho¡d©a
->
ticks
[0] = hostdata->ticks[1] = 0;

454 
ho¡d©a
->
š_æight
[0] = hostdata->in_flight[1] = 0;

455  
	`shªnÚ_´obe
(
pdev
, 
id
, 
ho¡d©a
);

456 
	}
}

458 
	$shªnÚ_scsi_»move
(
pci_dev
 *
pdev
)

460 
shªnÚ_scsi_´iv©e
 *
ho¡d©a
 = 
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

461 
	`shªnÚ_»move
(
ho¡d©a
->
sdev
, 
pdev
);

462 
	`scsi_ho¡_put
(
ho¡d©a
->
scsi_ho¡
);

463 
	}
}

465 
	$shªnÚ_©ch_scsi
(
shªnÚ_scsi_´iv©e
 *
´iv©e
, *
d©a
)

467 
pci_dev
 *
pdev
 = (pci_dev *)
d©a
;

468 
	`debugs1
("enter.\n");

469 ià(
	`scsi_add_ho¡
(
´iv©e
->
scsi_ho¡
, &
pdev
->
dev
))

471 
	`scsi_sÿn_ho¡
(
´iv©e
->
scsi_ho¡
);

472 
	`debugs1
("exit.\n");

474 
	}
}

476 
	$shªnÚ_d‘ach_scsi
(
shªnÚ_scsi_´iv©e
 *
´iv©e
)

478 
	`debugs1
("enter.\n");

479 
	`scsi_»move_ho¡
(
´iv©e
->
scsi_ho¡
);

480 
	`debugs1
("exit.\n");

481 
	}
}

	@shannon_scsi.h

1 #iâdeà
__SHANNON_SCSI_H


2 
	#__SHANNON_SCSI_H


	)

4 
	~"shªnÚ_wÜkqueue.h
"

6 
	#SHANNON_SCSI_SENSE_LEN
 32

	)

12 
	#SHN_DID_OK
 0x00

	)

13 
	#SHN_DID_NO_CONNECT
 0x01

	)

14 
	#SHN_DID_BUS_BUSY
 0x02

	)

15 
	#SHN_DID_TIME_OUT
 0x03

	)

16 
	#SHN_DID_BAD_TARGET
 0x04

	)

17 
	#SHN_DID_ABORT
 0x05

	)

18 
	#SHN_DID_PARITY
 0x06

	)

19 
	#SHN_DID_ERROR
 0x07

	)

20 
	#SHN_DID_RESET
 0x08

	)

21 
	#SHN_DID_BAD_INTR
 0x09

	)

22 
	#SHN_DID_PASSTHROUGH
 0x0¨

	)

23 
	#SHN_DID_SOFT_ERROR
 0x0b

	)

24 
	#SHN_DID_IMM_RETRY
 0x0ø

	)

25 
	#SHN_DID_REQUEUE
 0x0d

	)

27 
	#SHN_DID_TRANSPORT_DISRUPTED
 0x0

	)

31 
	#SHN_DID_TRANSPORT_FAILFAST
 0x0à

	)

32 
	#SHN_DID_TARGET_FAILURE
 0x10

	)

34 
	#SHN_DID_NEXUS_FAILURE
 0x11

	)

36 
	#SHN_DRIVER_OK
 0x00

	)

42 
	#SHN_DRIVER_BUSY
 0x01

	)

43 
	#SHN_DRIVER_SOFT
 0x02

	)

44 
	#SHN_DRIVER_MEDIA
 0x03

	)

45 
	#SHN_DRIVER_ERROR
 0x04

	)

47 
	#SHN_DRIVER_INVALID
 0x05

	)

48 
	#SHN_DRIVER_TIMEOUT
 0x06

	)

49 
	#SHN_DRIVER_HARD
 0x07

	)

50 
	#SHN_DRIVER_SENSE
 0x08

	)

56 
	#SENSE_KEY_NO_SENSE
 0x00

	)

57 
	#SENSE_KEY_RECOVERED_ERROR
 0x01

	)

58 
	#SENSE_KEY_NOT_READY
 0x02

	)

59 
	#SENSE_KEY_MEDIUM_ERROR
 0x03

	)

60 
	#SENSE_KEY_HARDWARE_ERROR
 0x04

	)

61 
	#SENSE_KEY_ILLEGAL_REQUEST
 0x05

	)

62 
	#SENSE_KEY_UNIT_ATTENTION
 0x06

	)

63 
	#SENSE_KEY_DATA_PROTECT
 0x07

	)

64 
	#SENSE_KEY_BLANK_CHECK
 0x08

	)

65 
	#SENSE_KEY_COPY_ABORTED
 0x0a

	)

66 
	#SENSE_KEY_ABORTED_COMMAND
 0x0b

	)

67 
	#SENSE_KEY_VOLUME_OVERFLOW
 0x0d

	)

68 
	#SENSE_KEY_MISCOMPARE
 0x0e

	)

71 
	#ASC_NO_ADDITIONAL_SENSE
 0x00

	)

72 
	#ASC_PERIPHERAL_DEV_WRITE_FAULT
 0x03

	)

73 
	#ASC_LOGICAL_UNIT_NOT_READY
 0x04

	)

74 
	#ASC_WARNING
 0x0B

	)

75 
	#ASC_LOG_BLOCK_GUARD_CHECK_FAILED
 0x10

	)

76 
	#ASC_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x10

	)

77 
	#ASC_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x10

	)

78 
	#ASC_UNRECOVERED_READ_ERR
 0x11

	)

79 
	#ASC_PARAMETER_LIST_LENGTH_ERR
 0x1a

	)

80 
	#ASC_MISCOMPARE_DURING_VERIFY
 0x1D

	)

81 
	#ASC_INVALID_OPCODE
 0x20

	)

82 
	#ASC_ADDR_OUT_OF_RANGE
 0x21

	)

83 
	#ASC_INVALID_COMMAND_OPCODE
 0x20

	)

84 
	#ASC_INVALID_FIELD_IN_CDB
 0x24

	)

85 
	#ASC_INVALID_LUN
 0x25

	)

86 
	#ASC_INVALID_FIELD_IN_PARAM_LIST
 0x26

	)

87 
	#ASC_POWERON_RESET
 0x29

	)

88 
	#ASC_FORMAT_COMMAND_FAILED
 0x31

	)

89 
	#ASC_SAVING_PARAMS_UNSUP
 0x39

	)

90 
	#ASC_INTERNAL_TARGET_FAILURE
 0x44

	)

91 
	#ASC_TRANSPORT_PROBLEM
 0x4b

	)

92 
	#ASC_THRESHOLD_EXCEEDED
 0x5d

	)

93 
	#ASC_LOW_POWER_COND_ON
 0x5e

	)

96 
	#ASCQ_CAUSE_NOT_REPORTABLE
 0x00

	)

97 
	#ASCQ_FORMAT_COMMAND_FAILED
 0x01

	)

98 
	#ASCQ_LOG_BLOCK_GUARD_CHECK_FAILED
 0x01

	)

99 
	#ASCQ_LOG_BLOCK_APPTAG_CHECK_FAILED
 0x02

	)

100 
	#ASCQ_LOG_BLOCK_REFTAG_CHECK_FAILED
 0x03

	)

101 
	#ASCQ_ACK_NAK_TO
 0x03

	)

102 
	#ASCQ_FORMAT_IN_PROGRESS
 0x04

	)

103 
	#ASCQ_POWER_LOSS_EXPECTED
 0x08

	)

104 
	#ASCQ_INVALID_LUN_ID
 0x09

	)

107 
	eshªnÚ_scsi_cmd_¡©us


109 
	mSTATUS_CODE_GOOD
 = 0x00,

110 
	mSTATUS_CODE_CHECK_CONDITION
 = 0x02,

111 
	mSTATUS_CODE_CONDITION_MET
 = 0x04,

112 
	mSTATUS_CODE_BUSY
 = 0x08,

113 
	mSTATUS_CODE_RESERVATION_CONFLICT
 = 0x18,

114 
	mSTATUS_CODE_TASK_SET_FULL
 = 0x28,

115 
	mSTATUS_CODE_ACA_ACTIVE
 = 0x30,

116 
	mSTATUS_CODE_TASK_ABORTED
 = 0x40,

119 
	#CHECK_CONDITION_STATUS
 ((
SHN_DRIVER_SENSE
 << 24è| 
STATUS_CODE_CHECK_CONDITION
)

	)

121 
	sshªnÚ_scsi_´iv©e
 {

122 *
	mscsi_ho¡
;

123 *
	msdev
;

125 
shªnÚ_¥šlock_t
 
	m¡©s_lock
;

126 
	m£ùÜs
[2];

127 
	mios
[2];

128 
	mticks
[2];

129 
	mš_æight
[2];

131 
	mscsi_ho¡_no
;

134 
shªnÚ_fl_äom_dev_bufãr
(*
scsi_cmnd
, *
¬r
, 
¬r_Ën
);

135 
shªnÚ_bud_£n£_bufãr
(*
sbuff
, 
key
, 
asc
, 
asq
);

136 
shªnÚ_©ch_scsi
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, *
d©a
);

137 
shªnÚ_d‘ach_scsi
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
);

138 
shªnÚ_scsi_disk_š_æight
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
);

139 
shªnÚ_scsi_£ùÜs
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
);

140 
shªnÚ_scsi_ios
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
);

141 
shªnÚ_scsi_m£cs
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
);

	@shannon_scsi_cmd.c

1 
	~"shªnÚ.h
"

3 
šlše
 
	$scsi_¡©_£ùÜs_add
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
, 
£ùÜs
)

5 
ho¡d©a
->
£ùÜs
[
wr™e
] += sectors;

6 
	}
}

8 
šlše
 
	$scsi_¡©_ios_šc
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
)

10 
ho¡d©a
->
ios
[
wr™e
] += 1;

11 
	}
}

13 
šlše
 
	$scsi_¡©_ticks_add
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
, 
ticks
)

15 
ho¡d©a
->
ticks
[
wr™e
] +=icks;

16 
	}
}

18 
šlše
 
	$scsi_¡©_š_æight_šc
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
)

20 
ho¡d©a
->
š_æight
[
wr™e
] += 1;

21 
	}
}

23 
šlše
 
	$scsi_¡©_š_æight_dec
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
)

25 
ho¡d©a
->
š_æight
[
wr™e
] -= 1;

26 
	}
}

28 
	$shªnÚ_scsi_¡¬t_io_acù
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
shªnÚ_bio
 *
sbio
)

30 
wr™e
 = (
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
)?1:0;

32 
	`shªnÚ_¥š_lock_bh
(&
ho¡d©a
->
¡©s_lock
);

33 
	`scsi_¡©_£ùÜs_add
(
ho¡d©a
, 
wr™e
, (
sbio
->
bio_size
 >> 9));

34 
	`scsi_¡©_ios_šc
(
ho¡d©a
, 
wr™e
);

35 
	`scsi_¡©_š_æight_šc
(
ho¡d©a
, 
wr™e
);

36 
	`shªnÚ_¥š_uÆock_bh
(&
ho¡d©a
->
¡©s_lock
);

37 
	}
}

39 
	$shªnÚ_scsi_’d_io_acù
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
shªnÚ_bio
 *
sbio
, 
du¿tiÚ
)

41 
wr™e
 = (
sbio
->
dma_dœ
 =ğ
SHANNON_DMA_TODEVICE
)?1:0;

43 
	`shªnÚ_¥š_lock_bh
(&
ho¡d©a
->
¡©s_lock
);

44 
	`scsi_¡©_ticks_add
(
ho¡d©a
, 
wr™e
, 
du¿tiÚ
);

45 
	`scsi_¡©_š_æight_dec
(
ho¡d©a
, 
wr™e
);

46 
	`shªnÚ_¥š_uÆock_bh
(&
ho¡d©a
->
¡©s_lock
);

47 
	}
}

49 
	$shªnÚ_scsi_disk_š_æight
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
)

51  (
ho¡d©a
->
š_æight
[0] + hostdata->in_flight[1]);

52 
	}
}

54 
	$shªnÚ_scsi_£ùÜs
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
)

56  
ho¡d©a
->
£ùÜs
[
wr™e
];

57 
	}
}

59 
	$shªnÚ_scsi_ios
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
)

61  
ho¡d©a
->
ios
[
wr™e
];

62 
	}
}

64 
	$shªnÚ_scsi_m£cs
(
shªnÚ_scsi_´iv©e
 *
ho¡d©a
, 
wr™e
)

66  
	`shªnÚ_jiff›s_to_m£cs
(
ho¡d©a
->
ticks
[
wr™e
]);

67 
	}
}

70 
	#TEST_UNIT_READY
 0x00

	)

71 
	#REQUEST_SENSE
 0x03

	)

72 
	#READ_6
 0x08

	)

73 
	#WRITE_6
 0x0a

	)

74 
	#SEEK_6
 0x0b

	)

75 
	#INQUIRY
 0x12

	)

76 
	#RECOVER_BUFFERED_DATA
 0x14

	)

77 
	#MODE_SELECT
 0x15

	)

78 
	#MODE_SENSE
 0x1a

	)

79 
	#ALLOW_MEDIUM_REMOVAL
 0x1e

	)

80 
	#READ_CAPACITY
 0x25

	)

81 
	#READ_10
 0x28

	)

82 
	#WRITE_10
 0x2a

	)

83 
	#SEEK_10
 0x2b

	)

84 
	#SYNCHRONIZE_CACHE
 0x35

	)

85 
	#WRITE_SAME
 0x41

	)

86 
	#XDWRITEREAD_10
 0x53

	)

87 
	#MODE_SELECT_10
 0x55

	)

88 
	#MODE_SENSE_10
 0x5a

	)

89 
	#VARIABLE_LENGTH_CMD
 0x7f

	)

90 
	#REPORT_LUNS
 0xa0

	)

91 
	#READ_12
 0xa8

	)

92 
	#WRITE_12
 0x¯

	)

93 
	#READ_16
 0x88

	)

94 
	#COMPARE_AND_WRITE
 0x89

	)

95 
	#WRITE_16
 0x8a

	)

96 
	#WRITE_SAME_16
 0x93

	)

97 
	#SERVICE_ACTION_IN
 0x9e

	)

99 
	#SAI_READ_CAPACITY_16
 0x10

	)

100 
	#SAI_GET_LBA_STATUS
 0x12

	)

103 
	#REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
 6

	)

104 
	#REPORT_LUNS_SR_OFFSET
 2

	)

105 
	#READ_CAP_16_CDB_ALLOC_LENGTH_OFFSET
 10

	)

106 
	#REQUEST_SENSE_CDB_ALLOC_LENGTH_OFFSET
 4

	)

107 
	#REQUEST_SENSE_DESC_OFFSET
 1

	)

108 
	#REQUEST_SENSE_DESC_MASK
 0x01

	)

109 
	#DESCRIPTOR_FORMAT_SENSE_DATA_TYPE
 1

	)

113 
	#GET_OPCODE
(
cdb
ècdb[0]

	)

115 
	#GET_U8_FROM_CDB
(
cdb
, 
šdex
è(cdb[šdex] << 0)

	)

117 
	#GET_U16_FROM_CDB
(
cdb
, 
šdex
è((cdb[šdex] << 8è| (cdb[šdex + 1] << 0))

	)

119 
	#GET_U24_FROM_CDB
(
cdb
, 
šdex
) ((cdb[index] << 16) | \

120 (
cdb
[
šdex
 + 1] << 8) | \

121 (
cdb
[
šdex
 + 2] << 0))

	)

123 
	#GET_U32_FROM_CDB
(
cdb
, 
šdex
) ((cdb[index] << 24) | \

124 (
cdb
[
šdex
 + 1] << 16) | \

125 (
cdb
[
šdex
 + 2] << 8) | \

126 (
cdb
[
šdex
 + 3] << 0))

	)

128 
	#GET_U64_FROM_CDB
(
cdb
, 
šdex
è((((
u64
)cdb[index]) << 56) | \

129 (((
u64
)
cdb
[
šdex
 + 1]) << 48) | \

130 (((
u64
)
cdb
[
šdex
 + 2]) << 40) | \

131 (((
u64
)
cdb
[
šdex
 + 3]) << 32) | \

132 (((
u64
)
cdb
[
šdex
 + 4]) << 24) | \

133 (((
u64
)
cdb
[
šdex
 + 5]) << 16) | \

134 (((
u64
)
cdb
[
šdex
 + 6]) << 8) | \

135 (((
u64
)
cdb
[
šdex
 + 7]è<< 0))

	)

139 
	#GET_REPORT_LUNS_ALLOC_LENGTH
(
cdb
) \

140 (
	`GET_U32_FROM_CDB
(
cdb
, 
REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
))

	)

143 
	#GET_READ_CAP_16_ALLOC_LENGTH
(
cdb
) \

144 (
	`GET_U32_FROM_CDB
(
cdb
, 
READ_CAP_16_CDB_ALLOC_LENGTH_OFFSET
))

	)

146 
	#IS_READ_CAP_16
(
cdb
) \

147 ((
cdb
[0] =ğ
SERVICE_ACTION_IN
 && cdb[1] =ğ
SAI_READ_CAPACITY_16
è? 1 : 0)

	)

150 
	#GET_REQUEST_SENSE_ALLOC_LENGTH
(
cdb
) \

151 (
	`GET_U8_FROM_CDB
(
cdb
, 
REQUEST_SENSE_CDB_ALLOC_LENGTH_OFFSET
))

	)

155 
	#INQUIRY_EVPD_BYTE_OFFSET
 1

	)

156 
	#INQUIRY_PAGE_CODE_BYTE_OFFSET
 2

	)

157 
	#INQUIRY_EVPD_BIT_MASK
 1

	)

158 
	#INQUIRY_CDB_ALLOCATION_LENGTH_OFFSET
 3

	)

161 
	#VPD_SUPPORTED_PAGES
 0x00

	)

162 
	#VPD_SERIAL_NUMBER
 0x80

	)

163 
	#VPD_DEVICE_IDENTIFIERS
 0x83

	)

164 
	#VPD_EXTENDED_INQUIRY
 0x86

	)

165 
	#VPD_BLOCK_LIMITS
 0xB0

	)

166 
	#VPD_BLOCK_DEV_CHARACTERISTICS
 0xB1

	)

168 
	#GET_INQ_EVPD_BIT
(
cdb
) \

169 ((
	`GET_U8_FROM_CDB
(
cdb
, 
INQUIRY_EVPD_BYTE_OFFSET
) & \

170 
INQUIRY_EVPD_BIT_MASK
è? 1 : 0)

	)

172 
	#GET_INQ_PAGE_CODE
(
cdb
) \

173 (
	`GET_U8_FROM_CDB
(
cdb
, 
INQUIRY_PAGE_CODE_BYTE_OFFSET
))

	)

175 
	#GET_INQ_ALLOC_LENGTH
(
cdb
) \

176 (
	`GET_U16_FROM_CDB
(
cdb
, 
INQUIRY_CDB_ALLOCATION_LENGTH_OFFSET
))

	)

178 
	#INQ_STANDARD_INQUIRY_PAGE
 0x00

	)

179 
	#INQ_SUPPORTED_VPD_PAGES_PAGE
 0x00

	)

180 
	#INQ_UNIT_SERIAL_NUMBER_PAGE
 0x80

	)

181 
	#INQ_DEVICE_IDENTIFICATION_PAGE
 0x83

	)

182 
	#INQ_EXTENDED_INQUIRY_DATA_PAGE
 0x86

	)

183 
	#INQ_BLOCK_LIMITS_PAGE
 0xB0

	)

184 
	#INQ_BDEV_CHARACTERISTICS_PAGE
 0xB1

	)

185 
	#INQ_SERIAL_NUMBER_LENGTH
 32

	)

186 
	#INQ_NUM_SUPPORTED_VPD_PAGES
 6

	)

187 
	#VERSION_SPC_4
 0x06

	)

188 
	#STANDARD_INQUIRY_LENGTH
 36

	)

189 
	#ADDITIONAL_STD_INQ_LENGTH
 31

	)

190 
	#EXTENDED_INQUIRY_DATA_PAGE_LENGTH
 0x3C

	)

192 
	$shªnÚ_check_»adšess
(
shªnÚ_bio
 *
sbio
, *
£n£_bufãr
)

194 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
ho¡d©a
->sdev;

196 ià(
	`uÆik–y
(
sdev
->
sdisk
.
ex™
)) {

197 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_NOT_READY
, 
ASC_LOGICAL_UNIT_NOT_READY
, 0);

198 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

202 ià(
	`uÆik–y
(
sdev
->
ho¡_acûss_blocked
)) {

203 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ABORTED_COMMAND
, 
ASC_NO_ADDITIONAL_SENSE
, 0);

204 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

208 ià(
	`uÆik–y
(
sdev
->
big_lock
))

209 
	`shªnÚ_wa™_ev’t_š‹¼u±ibË
(
sdev
->
big_lock_ev’t
, sdev->
big_lock
 == 0);

212 
	}
}

214 cÚ¡ *
	gšq_v’dÜ_id
 = "Shannon";

215 cÚ¡ *
	gšq_´oduù_id
 = "Direct-IO";

216 cÚ¡ *
	gšq_´oduù_»v
 = "0004";

217 
	$shªnÚ_Œªs_¡ªd¬d_šquœy_·ge
(
shªnÚ_bio
 *
sbio
,

218 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

221 
shªnÚ_dev
 *
sdev
;

222 
»t
;

224 
	`debugs1
("sbio=0x%lx.\n", 
sbio
);

225 
	`debugs1
("ho¡d©a=0x%lx.\n", 
sbio
->
ho¡d©a
);

226 
	`debugs1
("sdev=0x%lx.\n", 
sbio
->
ho¡d©a
->
sdev
);

227 
sdev
 = (
shªnÚ_dev
 *)
sbio
->
ho¡d©a
->sdev;

228 
šq_»¥Ú£
[0] = 0;

230 
šq_»¥Ú£
[1] = 0;

231 
šq_»¥Ú£
[2] = 
VERSION_SPC_4
;

232 
šq_»¥Ú£
[3] = 2;

233 
šq_»¥Ú£
[4] = 
STANDARD_INQUIRY_LENGTH
 - 5;

234 
šq_»¥Ú£
[5] = 0;

235 
šq_»¥Ú£
[6] = 0;

236 
šq_»¥Ú£
[7] = 0x2;

237 
	`memıy
(&
šq_»¥Ú£
[8], 
šq_v’dÜ_id
, 
	`shªnÚ_¡¾’
(inq_vendor_id));

238 
	`memıy
(&
šq_»¥Ú£
[16], 
šq_´oduù_id
, 
	`shªnÚ_¡¾’
(inq_product_id));

239 
	`memıy
(&
šq_»¥Ú£
[32], 
šq_´oduù_»v
, 
	`shªnÚ_¡¾’
(inq_product_rev));

241 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
STANDARD_INQUIRY_LENGTH
);

242  
»t
;

243 
	}
}

245 
	$shªnÚ_Œªs_suµÜ‹d_vpd_·ges
(
shªnÚ_bio
 *
sbio
,

246 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

248 
xãr_Ën
;

249 
»t
;

251 
	`shªnÚ_mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

252 
šq_»¥Ú£
[1] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

253 
šq_»¥Ú£
[3] = 
INQ_NUM_SUPPORTED_VPD_PAGES
;

254 
šq_»¥Ú£
[4] = 
INQ_SUPPORTED_VPD_PAGES_PAGE
;

255 
šq_»¥Ú£
[5] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

256 
šq_»¥Ú£
[6] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

257 
šq_»¥Ú£
[7] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

258 
šq_»¥Ú£
[8] = 
INQ_BLOCK_LIMITS_PAGE
;

259 
šq_»¥Ú£
[9] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

260 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

261 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
xãr_Ën
);

262  
»t
;

263 
	}
}

265 
	$shªnÚ_Œªs_un™_£rŸl_·ge
(
shªnÚ_bio
 *
sbio
, 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

267 
shªnÚ_dev
 *
sdev
;

268 
xãr_Ën
;

269 
»t
;

271 
sdev
 = (
shªnÚ_dev
 *)
sbio
->
ho¡d©a
->sdev;

273 
	`shªnÚ_mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

274 
šq_»¥Ú£
[1] = 
INQ_UNIT_SERIAL_NUMBER_PAGE
;

275 
šq_»¥Ú£
[3] = 
INQ_SERIAL_NUMBER_LENGTH
;

276 
	`¡ºıy
(&
šq_»¥Ú£
[4], 
sdev
->
£rviû_g
, 32);

277 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

278 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
xãr_Ën
);

279  
»t
;

280 
	}
}

282 
	$shªnÚ_Œªs_deviû_id_·ge
(
shªnÚ_bio
 *
sbio
, 
u8
 *
šq_»¥Ú£
, 
®loc_Ën
)

284 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
ho¡d©a
->sdev;

286 
xãr_Ën
, 
»t
;

288 
	`mem£t
(
šq_»¥Ú£
, 0, 
STANDARD_INQUIRY_LENGTH
);

289 
šq_»¥Ú£
[1] = 
INQ_DEVICE_IDENTIFICATION_PAGE
;

290 
šq_»¥Ú£
[3] = 20;

292 
šq_»¥Ú£
[4] = 0x01;

293 
šq_»¥Ú£
[5] = 0x03;

294 
šq_»¥Ú£
[6] = 0x00;

295 
šq_»¥Ú£
[7] = 16;

297 
šq_»¥Ú£
[8] = 0x63;

298 
šq_»¥Ú£
[9] = 0x33;

299 
šq_»¥Ú£
[10] = 0x33;

300 
šq_»¥Ú£
[11] = 0x30;

302 ià(
	`shªnÚ_¡¾’
(
sdev
->
£rviû_g
) == 14) {

303 
šq_»¥Ú£
[12] = 
sdev
->
£rviû_g
[0] + sdev->service_tag[1];

304 
šq_»¥Ú£
[13] = 
sdev
->
£rviû_g
[2] + sdev->service_tag[3];

305 
	`memıy
(&
šq_»¥Ú£
[14], &
sdev
->
£rviû_g
[4], 10);

307 
šq_»¥Ú£
[12] = 
sdev
->
£rviû_g
[0];

308 
šq_»¥Ú£
[13] = 
sdev
->
£rviû_g
[1];

309 
šq_»¥Ú£
[14] = (
sdev
->
£rviû_g
[2] - '0') * 10 + (sdev->service_tag[3] - '0');

310 
šq_»¥Ú£
[15] = 
sdev
->
£rviû_g
[4];

311 
šq_»¥Ú£
[16] = (
sdev
->
£rviû_g
[5] - '0') * 10 + (sdev->service_tag[6] - '0');

312 
šq_»¥Ú£
[17] = 
sdev
->
£rviû_g
[7];

313 
šq_»¥Ú£
[18] = 
sdev
->
£rviû_g
[8];

314 
šq_»¥Ú£
[19] = (
sdev
->
£rviû_g
[9] - '0') * 10 + (sdev->service_tag[10] - '0');

315 
šq_»¥Ú£
[20] = (
sdev
->
£rviû_g
[11] - '0') * 10 + (sdev->service_tag[12] - '0');

316 
šq_»¥Ú£
[21] = 
sdev
->
£rviû_g
[13];

317 
šq_»¥Ú£
[22] = 
sdev
->
£rviû_g
[14];

318 
šq_»¥Ú£
[23] = 
sdev
->
£rviû_g
[15];

321 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
STANDARD_INQUIRY_LENGTH
);

322 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
xãr_Ën
);

323  
»t
;

324 
	}
}

326 
	$shªnÚ_Œªs_ex‹nded_šquœy
(
shªnÚ_bio
 *
sbio
, 
®loc_Ën
)

328 
u8
 *
šq_»¥Ú£
;

329 
»t
;

330 
xãr_Ën
;

332 
šq_»¥Ú£
 = 
	`shªnÚ_kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_ATOMIC
);

333 ià(
šq_»¥Ú£
 =ğ
NULL
) {

334  -
ENOMEM
;

336 
šq_»¥Ú£
[1] = 
INQ_EXTENDED_INQUIRY_DATA_PAGE
;

337 
šq_»¥Ú£
[2] = 0x00;

338 
šq_»¥Ú£
[3] = 0x3C;

339 
šq_»¥Ú£
[4] = 0x00;

340 
šq_»¥Ú£
[5] = 0x01;

342 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

343 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
xãr_Ën
);

344 
	`shªnÚ_kä“
(
šq_»¥Ú£
);

345  
»t
;

346 
	}
}

348 
	$shªnÚ_Œªs_block_lim™s_·ge
(
shªnÚ_bio
 *
sbio
, 
®loc_Ën
)

350 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
ho¡d©a
->sdev;

352 
u8
 *
šq_»¥Ú£
;

353 
»t
;

354 
xãr_Ën
;

356 
šq_»¥Ú£
 = 
	`shªnÚ_kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_ATOMIC
);

357 ià(
šq_»¥Ú£
 =ğ
NULL
) {

358  -
ENOMEM
;

360 
šq_»¥Ú£
[1] = 
INQ_BLOCK_LIMITS_PAGE
;

361 
šq_»¥Ú£
[2] = 0x00;

362 
šq_»¥Ú£
[3] = 0x3C;

363 
šq_»¥Ú£
[6] = 0x00;

364 ià(
sdev
->
u£r_logicb_size
 == 512)

365 
šq_»¥Ú£
[7] = 0x08;

367 
šq_»¥Ú£
[7] = 0x00;

369 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

370 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
xãr_Ën
);

371 
	`shªnÚ_kä“
(
šq_»¥Ú£
);

372  
»t
;

373 
	}
}

375 
	$shªnÚ_Œªs_bdev_ch¬_·ge
(
shªnÚ_bio
 *
sbio
, 
®loc_Ën
)

377 
u8
 *
šq_»¥Ú£
;

378 
»t
;

379 
xãr_Ën
;

381 
šq_»¥Ú£
 = 
	`shªnÚ_kz®loc
(
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
, 
GFP_ATOMIC
);

382 ià(
šq_»¥Ú£
 =ğ
NULL
) {

383  -
ENOMEM
;

385 
šq_»¥Ú£
[1] = 
INQ_BDEV_CHARACTERISTICS_PAGE
;

386 
šq_»¥Ú£
[2] = 0x00;

387 
šq_»¥Ú£
[3] = 0x3C;

388 
šq_»¥Ú£
[4] = 0x00;

389 
šq_»¥Ú£
[5] = 0x01;

390 
šq_»¥Ú£
[6] = 0x00;

392 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
EXTENDED_INQUIRY_DATA_PAGE_LENGTH
);

393 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
šq_»¥Ú£
, 
xãr_Ën
);

394 
	`shªnÚ_kä“
(
šq_»¥Ú£
);

395  
»t
;

396 
	}
}

398 
	$shªnÚ_»¥_šquœy
(
shªnÚ_bio
 *
sbio
, *
£n£_bufãr
)

400 
»s
 = 0;

401 
u8
 
evpd
;

402 
u8
 
·ge_code
;

403 
®loc_Ën
;

404 
u8
 *
šq_»¥Ú£
;

407 
evpd
 = 
	`GET_INQ_EVPD_BIT
(
sbio
->
cmd
);

408 
·ge_code
 = 
	`GET_INQ_PAGE_CODE
(
sbio
->
cmd
);

409 
®loc_Ën
 = 
	`GET_INQ_ALLOC_LENGTH
(
sbio
->
cmd
);

410 
	`debugs1
("evpd=0x%x,…age_code=0x%x,‡Îoc_Ën=0x%x.\n", 
evpd
, 
·ge_code
, 
®loc_Ën
);

412 
šq_»¥Ú£
 = 
	`shªnÚ_kz®loc
(
STANDARD_INQUIRY_LENGTH
, 
GFP_ATOMIC
);

413 ià(
šq_»¥Ú£
 =ğ
NULL
) {

414  -
ENOMEM
;

417 ià(
evpd
 == 0) {

418 ià(
·ge_code
 =ğ
INQ_STANDARD_INQUIRY_PAGE
) {

419 
»s
 = 
	`shªnÚ_Œªs_¡ªd¬d_šquœy_·ge
(
sbio
, 
šq_»¥Ú£
, 
STANDARD_INQUIRY_LENGTH
);

421 
	`shªnÚ_šfo
("unsuµÜ‹dƒvpd=%d,…age_code=%d.\n", 
evpd
, 
·ge_code
);

422 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

423 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

424 
out
;

427 
·ge_code
) {

428 
VPD_SUPPORTED_PAGES
:

429 
»s
 = 
	`shªnÚ_Œªs_suµÜ‹d_vpd_·ges
(
sbio
, 
šq_»¥Ú£
, 
®loc_Ën
);

431 
VPD_SERIAL_NUMBER
:

432 
»s
 = 
	`shªnÚ_Œªs_un™_£rŸl_·ge
(
sbio
, 
šq_»¥Ú£
, 
®loc_Ën
);

434 
VPD_DEVICE_IDENTIFIERS
:

435 
»s
 = 
	`shªnÚ_Œªs_deviû_id_·ge
(
sbio
, 
šq_»¥Ú£
, 
®loc_Ën
);

437 
VPD_BLOCK_DEV_CHARACTERISTICS
:

438 
»s
 = 
	`shªnÚ_Œªs_bdev_ch¬_·ge
(
sbio
, 
®loc_Ën
);

440 
VPD_EXTENDED_INQUIRY
:

441 
»s
 = 
	`shªnÚ_Œªs_ex‹nded_šquœy
(
sbio
, 
®loc_Ën
);

443 
VPD_BLOCK_LIMITS
:

444 
»s
 = 
	`shªnÚ_Œªs_block_lim™s_·ge
(
sbio
, 
®loc_Ën
);

447 
	`shªnÚ_šfo
("unsuµÜ‹dƒvpd=%d,…age_code=%d.\n", 
evpd
, 
·ge_code
);

448 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

449 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

450 
out
;

453 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

454 
out
:

455 
	`shªnÚ_kä“
(
šq_»¥Ú£
);

456  
»s
;

458 
	}
}

461 
	#REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
 6

	)

462 
	#REPORT_LUNS_SR_OFFSET
 2

	)

464 
	#ALL_LUNS_RETURNED
 0x02

	)

465 
	#ALL_WELL_KNOWN_LUNS_RETURNED
 0x01

	)

466 
	#RESTRICTED_LUNS_RETURNED
 0x00

	)

468 
	#GET_REPORT_LUNS_ALLOC_LENGTH
(
cdb
) \

469 (
	`GET_U32_FROM_CDB
(
cdb
, 
REPORT_LUNS_CDB_ALLOC_LENGTH_OFFSET
))

	)

471 
	#SHANNON_SCSI_RLUN_ARR_SZ
 16

	)

472 
	#LUN_ENTRY_SIZE
 8

	)

473 
	#DEF_MAX_LUNS
 1

	)

475 
	$shªnÚ_»¥_»pÜt_luns
(
shªnÚ_bio
 *
sbio
)

477 
u32
 
®loc_Ën
, 
xãr_Ën
, 
»¥_size
;

478 
u8
 
£Ëù_»pÜt
;

479 
»¥Ú£
[
SHANNON_SCSI_RLUN_ARR_SZ
];

480 
__be64
 
tmp_id
;

481 
__be32
 
tmp_Ën
;

483 
®loc_Ën
 = 
	`GET_REPORT_LUNS_ALLOC_LENGTH
(
sbio
->
cmd
);

484 
£Ëù_»pÜt
 = 
	`GET_U8_FROM_CDB
(
sbio
->
cmd
, 
REPORT_LUNS_SR_OFFSET
);

485 
	`debugs1
("®loc_Ën=%d, s–eù_»pÜt=%d.\n", 
®loc_Ën
, 
£Ëù_»pÜt
);

486 
»¥_size
 = 
SHANNON_SCSI_RLUN_ARR_SZ
;

488 ià((
£Ëù_»pÜt
 !ğ
ALL_LUNS_RETURNED
) &&

489 (
£Ëù_»pÜt
 !ğ
ALL_WELL_KNOWN_LUNS_RETURNED
) &&

490 (
£Ëù_»pÜt
 !ğ
RESTRICTED_LUNS_RETURNED
)) {

492 
	`mem£t
(
»¥Ú£
, 0, 
SHANNON_SCSI_RLUN_ARR_SZ
);

493 
tmp_Ën
 = 
	`ıu_to_be32
(
DEF_MAX_LUNS
);

494 
	`shªnÚ_memıy
(
»¥Ú£
, &
tmp_Ën
, (
u32
));

495 
tmp_id
 = 
	`ıu_to_be64
(0);

496 
	`shªnÚ_memıy
(&
»¥Ú£
[8], &
tmp_id
, (
u64
));

497 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

498  
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
»¥Ú£
, 
xãr_Ën
);

501 
	}
}

504 
	#READ_CAP_10_RESP_SIZE
 8

	)

505 
	#READ_CAP_16_RESP_SIZE
 32

	)

506 
	$shªnÚ_»¥_»ad_ÿ·c™y
(
shªnÚ_bio
 *
sbio
, 
u8
 *
£n£_bufãr
)

508 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
ho¡d©a
->sdev;

509 
»t
 = 0;

510 
u32
 
®loc_Ën
 = 
READ_CAP_10_RESP_SIZE
;

511 
u32
 
»¥_size
 = 
READ_CAP_10_RESP_SIZE
;

512 
u32
 
xãr_Ën
;

513 
u32
 
lba_size
;

514 
u64
 
¾ba
;

515 
u8
 
cdb16
;

516 
u8
 *
»¥Ú£
;

517 
__be64
 
tmp_¾ba
;

518 
__be32
 
tmp_¾ba_32
;

519 
__be32
 
tmp_lba_size
;

521 
cdb16
 = 
	`IS_READ_CAP_16
(
sbio
->
cmd
);

522 ià(
cdb16
) {

523 
®loc_Ën
 = 
	`GET_READ_CAP_16_ALLOC_LENGTH
(
sbio
->
cmd
);

524 
»¥_size
 = 
READ_CAP_16_RESP_SIZE
;

527 
»¥Ú£
 = 
	`shªnÚ_kz®loc
(
»¥_size
, 
GFP_ATOMIC
);

528 ià(
»¥Ú£
 =ğ
NULL
) {

529 
	`shªnÚ_”r
("allocate„esponse buffer failed!\n");

530 
»t
 = -
ENOMEM
;

531 
”r
;

534 
lba_size
 = 
sdev
->
u£r_logicb_size
;

535 
¾ba
 = (
sdev
->
sdisk
.
£ùÜs
 * 512ULè/ sdev->
u£r_logicb_size
 - 1;

537 ià(!
cdb16
) {

540 
¾ba
 = 0xFFFFFFFF;

541 
tmp_¾ba_32
 = 
	`shªnÚ_ıu_to_be32
(
¾ba
);

542 
tmp_lba_size
 = 
	`shªnÚ_ıu_to_be32
(
lba_size
);

543 
	`shªnÚ_memıy
(
»¥Ú£
, &
tmp_¾ba_32
, (
u32
));

544 
	`shªnÚ_memıy
(&
»¥Ú£
[4], &
tmp_lba_size
, (
u32
));

546 
tmp_¾ba
 = 
	`shªnÚ_ıu_to_be64
(
¾ba
);

547 
tmp_lba_size
 = 
	`shªnÚ_ıu_to_be32
(
lba_size
);

548 
	`shªnÚ_memıy
(
»¥Ú£
, &
tmp_¾ba
, (
u64
));

549 
	`shªnÚ_memıy
(&
»¥Ú£
[8], &
tmp_lba_size
, (
u32
));

550 
»¥Ú£
[12] = 0;

551 ià(
sdev
->
u£r_logicb_size
 == 4096) {

553 
»¥Ú£
[13] = 0;

556 
»¥Ú£
[13] = 3;

562 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

563 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
»¥Ú£
, 
xãr_Ën
);

564 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

565 
	`shªnÚ_kä“
(
»¥Ú£
);

566  
»t
;

567 
”r
:

568 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

569 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

570  
»t
;

571 
	}
}

574 
	#MODE_PAGE_INFO_EXCEP
 0x1C

	)

575 
	#MODE_PAGE_CACHING
 0x08

	)

576 
	#MODE_PAGE_CONTROL
 0x0A

	)

577 
	#MODE_PAGE_POWER_CONDITION
 0x1A

	)

578 
	#MODE_PAGE_RETURN_ALL
 0x3F

	)

579 
	#MODE_PAGE_BLK_DES_LEN
 0x08

	)

580 
	#MODE_PAGE_LLBAA_BLK_DES_LEN
 0x10

	)

581 
	#MODE_PAGE_CACHING_LEN
 0x14

	)

582 
	#MODE_PAGE_CONTROL_LEN
 0x0C

	)

583 
	#MODE_PAGE_POW_CND_LEN
 0x28

	)

584 
	#MODE_PAGE_INF_EXC_LEN
 0x0C

	)

585 
	#MODE_PAGE_ALL_LEN
 0x54

	)

586 
	#MODE_SENSE6_MPH_SIZE
 4

	)

587 
	#MODE_SENSE6_ALLOC_LEN_OFFSET
 4

	)

588 
	#MODE_SENSE_PAGE_CONTROL_OFFSET
 2

	)

589 
	#MODE_SENSE_PAGE_CONTROL_MASK
 0xC0

	)

590 
	#MODE_SENSE_PAGE_CODE_OFFSET
 2

	)

591 
	#MODE_SENSE_PAGE_CODE_MASK
 0x3F

	)

592 
	#MODE_SENSE_SUBPAGE_CODE_OFFSET
 3

	)

593 
	#MODE_SENSE_LLBAA_OFFSET
 1

	)

594 
	#MODE_SENSE_LLBAA_MASK
 0x10

	)

595 
	#MODE_SENSE_LLBAA_SHIFT
 4

	)

596 
	#MODE_SENSE_DBD_OFFSET
 1

	)

597 
	#MODE_SENSE_DBD_MASK
 8

	)

598 
	#MODE_SENSE_DBD_SHIFT
 3

	)

599 
	#MODE_SENSE10_MPH_SIZE
 8

	)

600 
	#MODE_SENSE10_ALLOC_LEN_OFFSET
 7

	)

601 
	#MODE_SELECT_CDB_PAGE_FORMAT_OFFSET
 1

	)

602 
	#MODE_SELECT_CDB_SAVE_PAGES_OFFSET
 1

	)

603 
	#MODE_SELECT_6_CDB_PARAM_LIST_LENGTH_OFFSET
 4

	)

604 
	#MODE_SELECT_10_CDB_PARAM_LIST_LENGTH_OFFSET
 7

	)

605 
	#MODE_SELECT_CDB_PAGE_FORMAT_MASK
 0x10

	)

606 
	#MODE_SELECT_CDB_SAVE_PAGES_MASK
 0x1

	)

607 
	#MODE_SELECT_6_BD_OFFSET
 3

	)

608 
	#MODE_SELECT_10_BD_OFFSET
 6

	)

609 
	#MODE_SELECT_10_LLBAA_OFFSET
 4

	)

610 
	#MODE_SELECT_10_LLBAA_MASK
 1

	)

611 
	#MODE_SELECT_6_MPH_SIZE
 4

	)

612 
	#MODE_SELECT_10_MPH_SIZE
 8

	)

613 
	#CACHING_MODE_PAGE_WCE_MASK
 0x04

	)

614 
	#MODE_SENSE_BLK_DESC_ENABLED
 0

	)

615 
	#MODE_SENSE_BLK_DESC_COUNT
 1

	)

616 
	#MODE_SELECT_PAGE_CODE_MASK
 0x3F

	)

617 
	#SHORT_DESC_BLOCK
 8

	)

618 
	#LONG_DESC_BLOCK
 16

	)

619 
	#MODE_PAGE_POW_CND_LEN_FIELD
 0x26

	)

620 
	#MODE_PAGE_INF_EXC_LEN_FIELD
 0x0A

	)

621 
	#MODE_PAGE_CACHING_LEN_FIELD
 0x12

	)

622 
	#MODE_PAGE_CONTROL_LEN_FIELD
 0x0A

	)

623 
	#MODE_SENSE_PC_CURRENT_VALUES
 0

	)

626 
	#GET_MODE_SENSE_DBD
(
cdb
) \

627 ((
	`GET_U8_FROM_CDB
(
cdb
, 
MODE_SENSE_DBD_OFFSET
è& 
MODE_SENSE_DBD_MASK
) >> \

628 
MODE_SENSE_DBD_SHIFT
)

	)

630 
	#GET_MODE_SENSE_LLBAA
(
cdb
) \

631 ((
	`GET_U8_FROM_CDB
(
cdb
, 
MODE_SENSE_LLBAA_OFFSET
) & \

632 
MODE_SENSE_LLBAA_MASK
è>> 
MODE_SENSE_LLBAA_SHIFT
)

	)

634 
	#GET_MODE_SENSE_MPH_SIZE
(
cdb10
) \

635 (
cdb10
 ? 
MODE_SENSE10_MPH_SIZE
 : 
MODE_SENSE6_MPH_SIZE
)

	)

638 
	$shªnÚ_Œªs_fl_mode_·rm_hdr
(
u8
 *
»¥
, 
Ën
, u8 
cdb10
, u8 
Îb¯
,

639 
u16
 
mode_d©a_Ëngth
, u16 
blk_desc_Ën
)

642 ià((
cdb10
 && 
Ën
 < 8) || (!cdb10 &&†en < 4))

645 ià(
cdb10
) {

646 
»¥
[0] = (
mode_d©a_Ëngth
 & 0xFF00) >> 8;

647 
»¥
[1] = (
mode_d©a_Ëngth
 & 0x00FF);

649 
»¥
[4] = 
Îb¯
;

650 
»¥
[5] = 0;

651 
»¥
[6] = (
blk_desc_Ën
 & 0xFF00) >> 8;

652 
»¥
[7] = (
blk_desc_Ën
 & 0x00FF);

654 
»¥
[0] = (
mode_d©a_Ëngth
 & 0x00FF);

656 
»¥
[3] = (
blk_desc_Ën
 & 0x00FF);

660 
	}
}

662 
šlše
 
	$shªnÚ_Œªs_g‘_blk_desc_Ën
(
u8
 
dbd
, u8 
Îb¯
)

664 ià(
dbd
 =ğ
MODE_SENSE_BLK_DESC_ENABLED
) {

666  8 * (
Îb¯
 + 1è* 
MODE_SENSE_BLK_DESC_COUNT
;

670 
	}
}

672 
	$shªnÚ_Œªs_fl_ÿchšg_·ge
(
shªnÚ_bio
 *
sbio
, 
u8
 *
»¥
, 
Ën
)

674 
u8
 
vwc
;

676 
vwc
 = 1;

677 
»¥
[0] = 
MODE_PAGE_CACHING
;

678 
»¥
[1] = 
MODE_PAGE_CACHING_LEN_FIELD
;

679 
»¥
[2] = 
vwc
 << 2;

681 
	}
}

683 
	$shªnÚ_Œªs_fl_cÚŒŞ_·ge
(
shªnÚ_bio
 *
sbio
, 
u8
 *
»¥
, 
Ën
)

685 ià(
Ën
 < 
MODE_PAGE_CONTROL_LEN
)

688 
»¥
[0] = 
MODE_PAGE_CONTROL
;

689 
»¥
[1] = 
MODE_PAGE_CONTROL_LEN_FIELD
;

690 
»¥
[2] = 0x0E;

692 
»¥
[3] = 0x10;

694 
»¥
[5] = 0x40;

696 
»¥
[8] = 0xFF;

697 
»¥
[9] = 0xFF;

700 
	}
}

702 
	$shªnÚ_Œªs_fl_pow_úd_·ge
(
shªnÚ_bio
 *
sbio
, 
u8
 *
»¥
, 
Ën
)

704 ià(
Ën
 < 
MODE_PAGE_POW_CND_LEN
)

707 
»¥
[0] = 
MODE_PAGE_POWER_CONDITION
;

708 
»¥
[1] = 
MODE_PAGE_POW_CND_LEN_FIELD
;

711 
	}
}

713 
	$shªnÚ_Œªs_fl_šf_exc_·ge
(
shªnÚ_bio
 *
sbio
, 
u8
 *
»¥
, 
Ën
)

715 ià(
Ën
 < 
MODE_PAGE_INF_EXC_LEN
)

718 
»¥
[0] = 
MODE_PAGE_INFO_EXCEP
;

719 
»¥
[1] = 
MODE_PAGE_INF_EXC_LEN_FIELD
;

720 
»¥
[2] = 0x88;

723 
	}
}

725 
	$shªnÚ_Œªs_fl_®l_·ges
(
shªnÚ_bio
 *
sbio
, 
u8
 *
»¥
, 
Ën
)

727 
»s
 = 0;

728 
u16
 
mode_·ges_off£t_1
 = 0;

729 
u16
 
mode_·ges_off£t_2
, 
mode_·ges_off£t_3
, 
mode_·ges_off£t_4
;

731 
mode_·ges_off£t_2
 = 
mode_·ges_off£t_1
 + 
MODE_PAGE_CACHING_LEN
;

732 
mode_·ges_off£t_3
 = 
mode_·ges_off£t_2
 + 
MODE_PAGE_CONTROL_LEN
;

733 
mode_·ges_off£t_4
 = 
mode_·ges_off£t_3
 + 
MODE_PAGE_POW_CND_LEN
;

734 
»s
 = 
	`shªnÚ_Œªs_fl_ÿchšg_·ge
(
sbio
, &
»¥
[
mode_·ges_off£t_1
], 
MODE_PAGE_CACHING_LEN
);

735 ià(
»s
 != 0)

736 
out
;

737 
»s
 = 
	`shªnÚ_Œªs_fl_cÚŒŞ_·ge
(
sbio
, &
»¥
[
mode_·ges_off£t_2
], 
MODE_PAGE_CONTROL_LEN
);

738 ià(
»s
 != 0)

739 
out
;

740 
»s
 = 
	`shªnÚ_Œªs_fl_pow_úd_·ge
(
sbio
, &
»¥
[
mode_·ges_off£t_3
], 
MODE_PAGE_POW_CND_LEN
);

741 ià(
»s
 != 0)

742 
out
;

743 
»s
 = 
	`shªnÚ_Œªs_fl_šf_exc_·ge
(
sbio
, &
»¥
[
mode_·ges_off£t_4
], 
MODE_PAGE_INF_EXC_LEN
);

744 ià(
»s
 != 0)

745 
out
;

746 
out
:

747  
»s
;

748 
	}
}

750 
shªnÚ_Œªs_mode_·ge_ü—‹
(
shªnÚ_bio
 *
sbio
, 
u16
 
®loc_Ën
, 
u8
 
cdb10
,

751 (*
mode_·ge_fl_func
)(
shªnÚ_bio
 *
sbio
, 
u8
 *, ),

752 
u16
 
mode_·ges_tÙ_Ën
)

754 
xãr_Ën
, 
»t
 = 0;

755 
u8
 *
»¥Ú£
;

756 
u8
 
dbd
, 
Îb¯
;

757 
u16
 
»¥_size
;

758 
mph_size
;

759 
u16
 
mode_·ges_off£t_1
;

760 
u16
 
blk_desc_Ën
, 
blk_desc_off£t
, 
mode_d©a_Ëngth
;

762 
dbd
 = 
	`GET_MODE_SENSE_DBD
(
sbio
->
cmd
);

763 
Îb¯
 = 
	`GET_MODE_SENSE_LLBAA
(
sbio
->
cmd
);

764 
mph_size
 = 
	`GET_MODE_SENSE_MPH_SIZE
(
cdb10
);

765 
blk_desc_Ën
 = 
	`shªnÚ_Œªs_g‘_blk_desc_Ën
(
dbd
, 
Îb¯
);

766 
	`debugs1
("dbd=%d,†lb¯=%d, mph_size=%d, blk_desc_Ën=%d.\n", 
dbd
, 
Îb¯
, 
mph_size
, 
blk_desc_Ën
);

768 
»¥_size
 = 
mph_size
 + 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

770 
mode_d©a_Ëngth
 = 3 + (3 * 
cdb10
è+ 
blk_desc_Ën
 + 
mode_·ges_tÙ_Ën
;

771 
blk_desc_off£t
 = 
mph_size
;

772 
mode_·ges_off£t_1
 = 
blk_desc_off£t
 + 
blk_desc_Ën
;

773 
»¥Ú£
 = 
	`shªnÚ_kz®loc
(
»¥_size
, 
GFP_ATOMIC
);

774 
»t
 = 
	`shªnÚ_Œªs_fl_mode_·rm_hdr
(&
»¥Ú£
[0], 
mph_size
, 
cdb10
, 
Îb¯
, 
mode_d©a_Ëngth
, 
blk_desc_Ën
);

776 
»t
 = 
	`mode_·ge_fl_func
(
sbio
, &
»¥Ú£
[
mode_·ges_off£t_1
], 
mode_·ges_tÙ_Ën
);

777 
xãr_Ën
 = 
	`mš
(
®loc_Ën
, 
»¥_size
);

778 
»t
 = 
	`shªnÚ_fl_äom_dev_bufãr
(
sbio
->
scsi_cmnd
, 
»¥Ú£
, 
xãr_Ën
);

780 
	`shªnÚ_kä“
(
»¥Ú£
);

781  
»t
;

782 
	}
}

784 
	$shªnÚ_»¥_mode_£n£
(
shªnÚ_bio
 *
sbio
, *
£n£_bufãr
)

786 
u16
 
®loc_Ën
;

787 
u8
 
cdb10
 = 0;

788 
u8
 
·ge_code
;

789 
u8
 
sub·ge_code
;

790 
u8
 
pc
;

791 
»t
;

793 ià(
	`GET_OPCODE
(
sbio
->
cmd
è=ğ
MODE_SENSE
) {

794 
®loc_Ën
 = 
	`GET_U8_FROM_CDB
(
sbio
->
cmd
, 
MODE_SENSE6_ALLOC_LEN_OFFSET
);

796 
®loc_Ën
 = 
	`GET_U16_FROM_CDB
(
sbio
->
cmd
, 
MODE_SENSE10_ALLOC_LEN_OFFSET
);

797 
cdb10
 = 1;

799 
pc
 = 
	`GET_U8_FROM_CDB
(
sbio
->
cmd
, 
MODE_SENSE_PAGE_CONTROL_OFFSET
è& 
MODE_SENSE_PAGE_CONTROL_MASK
;

800 
·ge_code
 = 
	`GET_U8_FROM_CDB
(
sbio
->
cmd
, 
MODE_SENSE_PAGE_CODE_OFFSET
è& 
MODE_SENSE_PAGE_CODE_MASK
;

801 
sub·ge_code
 = 
	`GET_U8_FROM_CDB
(
sbio
->
cmd
, 
MODE_SENSE_SUBPAGE_CODE_OFFSET
);

802 
	`debugs1
("İcode=0x%x,‡Îoc_Ën=%d,…c=0x%x,…age_code=0x%x.\n", 
	`GET_OPCODE
(
sbio
->
cmd
), 
®loc_Ën
, 
pc
, 
·ge_code
);

804 
·ge_code
) {

805 
MODE_PAGE_CACHING
:

806 
»t
 = 
	`shªnÚ_Œªs_mode_·ge_ü—‹
(
sbio
, 
®loc_Ën
, 
cdb10
,

807 &
shªnÚ_Œªs_fl_ÿchšg_·ge
,

808 
MODE_PAGE_CACHING_LEN
);

810 
MODE_PAGE_INFO_EXCEP
:

811 ià(0 =ğ
sub·ge_code
)

812 
»t
 = 
	`shªnÚ_Œªs_mode_·ge_ü—‹
(
sbio
, 
®loc_Ën
, 
cdb10
,

813 &
shªnÚ_Œªs_fl_šf_exc_·ge
,

814 
MODE_PAGE_INF_EXC_LEN
);

816 
	`shªnÚ_šfo
("unsuµÜ‹d…age_code=0x%x, sub·ge_code=0x%x.\n", 
·ge_code
, 
sub·ge_code
);

817 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

818 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

819 
out
;

822 
MODE_PAGE_POWER_CONDITION
:

823 
»t
 = 
	`shªnÚ_Œªs_mode_·ge_ü—‹
(
sbio
, 
®loc_Ën
, 
cdb10
,

824 &
shªnÚ_Œªs_fl_pow_úd_·ge
,

825 
MODE_PAGE_POW_CND_LEN
);

827 
MODE_PAGE_CONTROL
:

828 
»t
 = 
	`shªnÚ_Œªs_mode_·ge_ü—‹
(
sbio
, 
®loc_Ën
, 
cdb10
,

829 &
shªnÚ_Œªs_fl_cÚŒŞ_·ge
,

830 
MODE_PAGE_CONTROL_LEN
);

832 
MODE_PAGE_RETURN_ALL
:

833 ià((0 =ğ
sub·ge_code
) || (0xff == subpage_code))

834 
»t
 = 
	`shªnÚ_Œªs_mode_·ge_ü—‹
(
sbio
, 
®loc_Ën
, 
cdb10
,

835 &
shªnÚ_Œªs_fl_®l_·ges
,

836 
MODE_PAGE_ALL_LEN
);

838 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

839 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

840 
out
;

844 
	`shªnÚ_šfo
("unsuµÜ‹d…age_code=0x%x.\n", 
·ge_code
);

845 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

846 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

847 
out
;

849 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

850 
out
:

852 
	}
}

854 
	$g‘_d©a_Œªsãr_šfo
(*
cmd
,

855 *
lba
, *
num
,

856 
u32
 *
ei_lba
)

858 *
ei_lba
 = 0;

860 *
cmd
) {

861 
VARIABLE_LENGTH_CMD
:

862 *
lba
 = (
u64
)
cmd
[19] | (u64)cmd[18] << 8 |

863 (
u64
)
cmd
[17] << 16 | (u64)cmd[16] << 24 |

864 (
u64
)
cmd
[15] << 32 | (u64)cmd[14] << 40 |

865 (
u64
)
cmd
[13] << 48 | (u64)cmd[12] << 56;

867 *
ei_lba
 = (
u32
)
cmd
[23] | (u32)cmd[22] << 8 |

868 (
u32
)
cmd
[21] << 16 | (u32)cmd[20] << 24;

870 *
num
 = (
u32
)
cmd
[31] | (u32)cmd[30] << 8 | (u32)cmd[29] << 16 |

871 (
u32
)
cmd
[28] << 24;

874 
WRITE_SAME_16
:

875 
WRITE_16
:

876 
READ_16
:

877 *
lba
 = (
u64
)
cmd
[9] | (u64)cmd[8] << 8 |

878 (
u64
)
cmd
[7] << 16 | (u64)cmd[6] << 24 |

879 (
u64
)
cmd
[5] << 32 | (u64)cmd[4] << 40 |

880 (
u64
)
cmd
[3] << 48 | (u64)cmd[2] << 56;

882 *
num
 = (
u32
)
cmd
[13] | (u32)cmd[12] << 8 | (u32)cmd[11] << 16 |

883 (
u32
)
cmd
[10] << 24;

885 
WRITE_12
:

886 
READ_12
:

887 *
lba
 = (
u32
)
cmd
[5] | (u32)cmd[4] << 8 | (u32)cmd[3] << 16 |

888 (
u32
)
cmd
[2] << 24;

890 *
num
 = (
u32
)
cmd
[9] | (u32)cmd[8] << 8 | (u32)cmd[7] << 16 |

891 (
u32
)
cmd
[6] << 24;

893 
WRITE_SAME
:

894 
WRITE_10
:

895 
READ_10
:

896 
XDWRITEREAD_10
:

897 *
lba
 = (
u32
)
cmd
[5] | (u32)cmd[4] << 8 | (u32)cmd[3] << 16 |

898 (
u32
)
cmd
[2] << 24;

900 *
num
 = (
u32
)
cmd
[8] | (u32)cmd[7] << 8;

902 
WRITE_6
:

903 
READ_6
:

904 *
lba
 = (
u32
)
cmd
[3] | (u32)cmd[2] << 8 |

905 (
u32
)(
cmd
[1] & 0x1f) << 16;

906 *
num
 = (0 =ğ
cmd
[4]) ? 256 : cmd[4];

911 
	}
}

913 
shªnÚ_cÚv”t_scsi_scmd
(
shªnÚ_bio
 *
sbio
, 
logicb_size
);

914 
shªnÚ_subm™_bio
(
shªnÚ_dev
 *
sdev
, 
shªnÚ_bio
 *
sbio
);

915 
	$shªnÚ_»¥_rw
(
shªnÚ_bio
 *
sbio
)

917 
shªnÚ_dev
 *
sdev
 = (shªnÚ_dev *)
sbio
->
ho¡d©a
->sdev;

918 
lba
 = 0;

919 
num
 = 0;

920 
£n£_bufãr
[
SHANNON_SCSI_SENSE_LEN
];

921 
u32
 
ei_lba
 = 0;

923 
	`g‘_d©a_Œªsãr_šfo
(
sbio
->
cmd
, &
lba
, &
num
, &
ei_lba
);

924 
	`SHANNON_INIT_LIST_HEAD
(&
sbio
->
»q_li¡
);

925 
sbio
->
¡¬t_£ùÜ
 = (
lba
 * 
sdev
->
u£r_logicb_size
)/512;

927 ià(0 =ğ
num
) {

928 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

932 ià(
	`uÆik–y
(
sbio
->
¡¬t_£ùÜ
 + 
num
 * 
sdev
->
u£r_logicb_size
 / 512è> (sdev->
sdisk
.
£ùÜs
 - 1))

934 
	`shªnÚ_šfo
("LBA ouˆoà¿nge:†ba=%Îu,‚um=%u.\n", 
lba
, 
num
);

935 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_ADDR_OUT_OF_RANGE
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

936 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

937 
	`ä“_sbio
(
sbio
);

941 
	`shªnÚ_cÚv”t_scsi_scmd
(
sbio
, 
sdev
->
logicb_size
);

942 
sbio
->
¡¬t_time
 = 
	`g‘_jiff›s
();

943 
	`shªnÚ_scsi_¡¬t_io_acù
(
sdev
->
sdisk
.
ho¡d©a
, 
sbio
);

944 
	`shªnÚ_subm™_bio
(
sdev
, 
sbio
);

946 
	}
}

948 
	$subm™_scsi_rw_sk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

950 
shªnÚ_bio
 *
sbio
 = 
	`cÚš”_of
(
wÜk
, shªnÚ_bio, 
scsi_wÜk
);

951 
	`shªnÚ_»¥_rw
(
sbio
);

952 
	}
}

954 
	$shªnÚ_»ûive_scsi_cmd
(
shªnÚ_bio
 *
sbio
, *
£n£_bufãr
)

956 
»t
;

958 ià(
	`shªnÚ_check_»adšess
(
sbio
, 
£n£_bufãr
)) {

959 
	`ä“_sbio
(
sbio
);

963 *
sbio
->
cmd
) {

964 
INQUIRY
:

965 
	`debugs1
("INQUIRY\n");

966 
»t
 = 
	`shªnÚ_»¥_šquœy
(
sbio
, 
£n£_bufãr
);

967 
	`ä“_sbio
(
sbio
);

969 
TEST_UNIT_READY
:

970 
	`debugs1
("TEST_UNIT_READY\n");

971 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

972 
	`ä“_sbio
(
sbio
);

974 
SYNCHRONIZE_CACHE
:

975 
	`debugs1
("SYNCHRONIZE_CACHE\n");

976 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

977 
	`ä“_sbio
(
sbio
);

979 
ALLOW_MEDIUM_REMOVAL
:

980 
	`debugs1
("ALLOW_MEDIUM_REMOVAL\n");

981 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

982 
	`ä“_sbio
(
sbio
);

984 
REQUEST_SENSE
:

985 
	`debugs1
("REQUEST_SENSE, unsupported!\n");

986 
	`ä“_sbio
(
sbio
);

988 
MODE_SELECT
:

989 
MODE_SELECT_10
:

990 
	`debugs1
("MODE_SELECT: cmd=0x%lx.\n", *
sbio
->
cmd
);

991 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

992 
	`ä“_sbio
(
sbio
);

994 
MODE_SENSE
:

995 
MODE_SENSE_10
:

996 
	`debugs1
("MODE_SENSE: cmd=0x%lx.\n", *
sbio
->
cmd
);

997 
	`shªnÚ_»¥_mode_£n£
(
sbio
, 
£n£_bufãr
);

998 
	`ä“_sbio
(
sbio
);

1000 
REPORT_LUNS
:

1001 
	`debugs1
("REPORT_LUNS.\n");

1002 
	`shªnÚ_»¥_»pÜt_luns
(
sbio
);

1003 
	`’d_scsi_cmnd
(
sbio
, 
STATUS_CODE_GOOD
, 
£n£_bufãr
);

1004 
	`ä“_sbio
(
sbio
);

1006 
READ_CAPACITY
:

1007 
	`debugs1
("READ_CAPACITY.\n");

1008 
	`shªnÚ_»¥_»ad_ÿ·c™y
(
sbio
, 
£n£_bufãr
);

1009 
	`ä“_sbio
(
sbio
);

1011 
SERVICE_ACTION_IN
:

1012 ià(
	`IS_READ_CAP_16
(
sbio
->
cmd
)) {

1013 
	`debugs1
("READ_CAPACITY 16.\n");

1014 
	`shªnÚ_»¥_»ad_ÿ·c™y
(
sbio
, 
£n£_bufãr
);

1015 
	`ä“_sbio
(
sbio
);

1017 
	`debugs1
("unsuµÜ‹d S”viû AùiÚ CMD:0x%x\n", 
sbio
->
cmd
[1]);

1018 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

1019 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

1020 
	`ä“_sbio
(
sbio
);

1023 
READ_16
:

1024 
READ_12
:

1025 
READ_10
:

1026 
READ_6
:

1027 
WRITE_16
:

1028 
WRITE_12
:

1029 
WRITE_10
:

1030 
WRITE_6
:

1031 
	`debugs1
("READ/WRITE, cmd=0x%x\n", *
sbio
->
cmd
);

1033 
	`shªnÚ_š™_wÜk
(&
sbio
->
scsi_wÜk
, 
subm™_scsi_rw_sk
);

1034 
	`shªnÚ_queue_wÜk
(
shªnÚ_³rıu_wq
, &
sbio
->
scsi_wÜk
);

1037 
	`shªnÚ_šfo
("unsuµÜ‹d SCSI CMD:0x%x\n", *
sbio
->
cmd
);

1038 
	`shªnÚ_bud_£n£_bufãr
(
£n£_bufãr
, 
SENSE_KEY_ILLEGAL_REQUEST
, 
ASC_INVALID_FIELD_IN_CDB
, 
ASCQ_CAUSE_NOT_REPORTABLE
);

1039 
	`’d_scsi_cmnd
(
sbio
, 
CHECK_CONDITION_STATUS
, 
£n£_bufãr
);

1040 
	`ä“_sbio
(
sbio
);

1044 
	}
}

	@shannon_sysfs.c

1 
	~"shªnÚ_pci.h
"

2 
	~"shªnÚ_sysfs.h
"

3 
	~<lšux/kobjeù.h
>

4 
	~<lšux/sysfs.h
>

5 
	~<lšux/”ºo.h
>

6 
	~<lšux/moduË.h
>

7 
	~<lšux/v”siÚ.h
>

8 
	~<lšux/g’hd.h
>

9 
	~<lšux/miscdeviû.h
>

10 
	~<lšux/pci.h
>

11 
	~<lšux/hwmÚ.h
>

12 
	~<lšux/hwmÚ-sysfs.h
>

13 
	~"shªnÚ_scsi.h
"

15 
	sshªnÚ_©Œ
 {

16 
©Œibu‹
 
	m©Œ
;

17 
shªnÚ_ssize_t
 (*
show
)(
	mshªnÚ_dev
 *, *);

18 
shªnÚ_ssize_t
 (*
¡Üe
)(
	mshªnÚ_dev
 *, cÚ¡ *, 
shªnÚ_size_t
 
	mcouÁ
);

21 
	sshªnÚ_deviû_©Œ
 {

22 
deviû_©Œibu‹
 
	m©Œ
;

23 
shªnÚ_ssize_t
 (*
show
)(
	mshªnÚ_dev
 *, *);

24 
shªnÚ_ssize_t
 (*
¡Üe
)(
	mshªnÚ_dev
 *, cÚ¡ *, 
shªnÚ_size_t
 
	mcouÁ
);

27 
	#defše_Úe_rw
(
_Çme
) \

28 
shªnÚ_©Œ
 
_Çme
 = \

29 
	`__ATTR
(
_Çme
, 0644, _Çme##
_show
, _Çme##
_¡Üe
)

	)

31 
	#defše_Úe_ro
(
_Çme
) \

32 
shªnÚ_©Œ
 
_Çme
 = \

33 
	`__ATTR_RO
(
_Çme
)

	)

35 
	#defše_Úe_deviû_rw
(
_Çme
) \

36 
shªnÚ_deviû_©Œ
 
_Çme
 = {\

37 .
©Œ
 = 
	`__ATTR
(
_Çme
, 0644, 
shªnÚ_deviû_show
, 
shªnÚ_deviû_¡Üe
), \

38 .
show
 = 
_Çme
##
_show
,\

39 .
¡Üe
 = 
_Çme
##
_¡Üe
,\

40 }

	)

42 
	#defše_Úe_deviû_ro
(
_Çme
) \

43 
shªnÚ_deviû_©Œ
 
_Çme
 = {\

44 .
©Œ
 = 
	`__ATTR
(
_Çme
, 0644, 
shªnÚ_deviû_show
, 
shªnÚ_deviû_¡Üe
), \

45 .
show
 = 
_Çme
##
_show
,\

46 }

	)

48 
	#to_shªnÚ_©Œ
(
a
è
	`cÚš”_of
×, 
shªnÚ_©Œ
, 
©Œ
)

	)

49 
	#to_shªnÚ_deviû_©Œ
(
a
è
	`cÚš”_of
×, 
shªnÚ_deviû_©Œ
, 
©Œ
)

	)

51 
shªnÚ_scsi_mode
;

52 
shªnÚ_ssize_t
 
	$shªnÚ_deviû_show
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

54 
pci_dev
 *
pdev
 = 
NULL
;

55 
shªnÚ_dev
 *
sdev
 = 
NULL
;

56 
shªnÚ_deviû_©Œ
 *
§‰r
 = 
NULL
;

57 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

58 
shªnÚ_scsi_´iv©e
 *
ho¡d©a
;

60 
pdev
 = 
	`cÚš”_of
(
dev
, 
pci_dev
, dev);

61 ià(
shªnÚ_scsi_mode
) {

62 
ho¡d©a
 = 
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

63 
sdev
 = 
ho¡d©a
->sdev;

65 
sdev
 = 
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

66 
§‰r
 = 
	`to_shªnÚ_deviû_©Œ
(
©Œ
);

68 ià(
§‰r
->
show
)

69 
»t
 = 
§‰r
->
	`show
(
sdev
, 
buf
);

71 
»t
 = -
EIO
;

73  
»t
;

74 
	}
}

76 
ssize_t
 
	$shªnÚ_deviû_¡Üe
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

78 
pci_dev
 *
pdev
 = 
NULL
;

79 
shªnÚ_dev
 *
sdev
 = 
NULL
;

80 
shªnÚ_deviû_©Œ
 *
§‰r
 = 
NULL
;

81 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

82 
shªnÚ_scsi_´iv©e
 *
ho¡d©a
;

84 
pdev
 = 
	`cÚš”_of
(
dev
, 
pci_dev
, dev);

85 ià(
shªnÚ_scsi_mode
) {

86 
ho¡d©a
 = 
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

87 
sdev
 = 
ho¡d©a
->sdev;

89 
sdev
 = 
	`shªnÚ_pci_g‘_drvd©a
(
pdev
);

90 
§‰r
 = 
	`to_shªnÚ_deviû_©Œ
(
©Œ
);

92 ià(
§‰r
->
¡Üe
)

93 
»t
 = 
§‰r
->
	`¡Üe
(
sdev
, 
buf
, 
couÁ
);

95 
»t
 = -
EIO
;

97  
»t
;

98 
	}
}

100 
shªnÚ_ssize_t
 
	$shªnÚ_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

102 
shªnÚ_dev
 *
sdev
 = 
	`to_shªnÚ_dev
((
shªnÚ_kobjeù_t
 *)
kobj
);

103 
shªnÚ_©Œ
 *
§‰r
 = 
	`to_shªnÚ_©Œ
(
©Œ
);

104 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

106 if(
§‰r
->
show
)

107 
»t
 = 
§‰r
->
	`show
(
sdev
, 
buf
);

109 
»t
 = -
EIO
;

111  
»t
;

112 
	}
}

114 
shªnÚ_ssize_t
 
	$shªnÚ_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

116 
shªnÚ_dev
 *
sdev
 = 
	`to_shªnÚ_dev
((
shªnÚ_kobjeù_t
 *)
kobj
);

117 
shªnÚ_©Œ
 *
§‰r
 = 
	`to_shªnÚ_©Œ
(
©Œ
);

118 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

120 if(
§‰r
->
¡Üe
)

121 
»t
 = 
§‰r
->
	`¡Üe
(
sdev
, 
buf
, 
couÁ
);

123 
»t
 = -
EIO
;

125  
»t
;

126 
	}
}

128 
	$shªnÚ_sysfs_»Ëa£
(
kobjeù
 *
kobj
)

130 
	}
}

132 
sysfs_İs
 
	gshªnÚ_sysfs_İs
 = {

133 .
show
 = 
shªnÚ_show
,

134 .
	g¡Üe
 = 
shªnÚ_¡Üe
,

137 
defše_Úe_ro
(
mod–
);

138 
defše_Úe_ro
(
fœmw¬e_v”siÚ
);

139 
defše_Úe_ro
(
fœmw¬e_bud
);

140 
defše_Úe_ro
(
driv”_v”siÚ
);

141 
defše_Úe_ro
(
£rŸl_numb”
);

142 
defše_Úe_ro
(
Çnd_mªuçùu»r
);

143 
defše_Úe_ro
(
Çnd_æash_id
);

144 
defše_Úe_ro
(
chªÃls
);

145 
defše_Úe_ro
(
lun£ts_š_chªÃl
);

146 
defše_Úe_ro
(
luns_š_lun£t
);

147 
defše_Úe_ro
(
avaabË_luns
);

148 
defše_Úe_ro
(
eblocks_š_lun
);

149 
defše_Úe_ro
(
·ges_š_eblock
);

150 
defše_Úe_ro
(
Çnd_·ge_size
);

151 
defše_Úe_ro
(
block_size
);

152 
defše_Úe_ro
(
u£_du®_h—d
);

153 
defše_Úe_ro
(
pow”_Ú_£cÚds
);

154 
defše_Úe_ro
(
pow”_cyşe_couÁ
);

155 
defše_Úe_ro
(
u£r_ÿ·c™y
);

156 
defše_Úe_ro
(
physiÿl_ÿ·c™y
);

157 
defše_Úe_ro
(
ov”´ovisiÚ
);

158 
defše_Úe_ro
(
ä“_blkút
);

159 
defše_Úe_ro
(
¡©ic_bad_blkút
);

160 
defše_Úe_ro
(
dyÇmic_bad_blkút
);

161 
defše_Úe_ro
(
max_”r_blocks
);

162 
defše_Úe_ro
(
»cÚfig_suµÜt
);

163 
defše_Úe_ro
(
£u_æag
);

164 
defše_Úe_ro
(
£u_üc_”rÜ
);

165 
defše_Úe_ro
(
£u_üc_”rÜ_hi¡Üy
);

166 
defše_Úe_ro
(
£u_ecc_”rÜ
);

167 
defše_Úe_ro
(
£u_ecc_”rÜ_hi¡Üy
);

168 
defše_Úe_ro
(
e¡im©ed_liã_Ëá
);

169 
defše_Úe_ro
(
ho¡_wr™e_£ùÜs
);

170 
defše_Úe_ro
(
ho¡_wr™e_bªdwidth
);

171 
defše_Úe_ro
(
ho¡_wr™e_iİs
);

172 
defše_Úe_ro
(
ho¡_wr™e_Ï‹ncy
);

173 
defše_Úe_ro
(
tÙ®_wr™e_£ùÜs
);

174 
defše_Úe_ro
(
tÙ®_wr™e_bªdwidth
);

175 
defše_Úe_ro
(
wr™e_am¶if›r
);

176 
defše_Úe_ro
(
wr™e_am¶if›r_liãtime
);

177 
defše_Úe_ro
(
ho¡_»ad_£ùÜs
);

178 
defše_Úe_ro
(
ho¡_»ad_bªdwidth
);

179 
defše_Úe_ro
(
ho¡_»ad_iİs
);

180 
defše_Úe_ro
(
ho¡_»ad_Ï‹ncy
);

181 
defše_Úe_ro
(
tÙ®_gc_logicbs
);

182 
defše_Úe_ro
(
tÙ®_wl_logicbs
);

183 
defše_Úe_ro
(
tÙ®_”r_»cov”_logicbs
);

184 
defše_Úe_ro
(
‹m³¿tu»_št
);

185 
defše_Úe_ro
(
‹m³¿tu»_št_max
);

186 
defše_Úe_ro
(
‹m³¿tu»_æash
);

187 
defše_Úe_ro
(
‹m³¿tu»_æash_max
);

188 
defše_Úe_ro
(
‹m³¿tu»_bßrd
);

189 
defše_Úe_ro
(
‹m³¿tu»_bßrd_max
);

190 
defše_Úe_rw
(
‹m³¿tu»_w¬nšg_th»shŞd
);

191 
defše_Úe_ro
(
vŞge_št
);

192 
defše_Úe_ro
(
vŞge_št_max
);

193 
defše_Úe_ro
(
vŞge_aux
);

194 
defše_Úe_ro
(
vŞge_aux_max
);

195 
defše_Úe_ro
(
ecc_çu»_times
);

196 
defše_Úe_ro
(
ecc_¡©i¡ics
);

197 
defše_Úe_ro
(
deviû_¡©e
);

198 
defše_Úe_ro
(
acûss_mode
);

199 
defše_Úe_ro
(
»adÚly_»asÚ
);

200 
defše_Úe_ro
(
»duûd_wr™e_»asÚ
);

201 
defše_Úe_rw
(
pm_qos_v®ue
);

202 
defše_Úe_rw
(
»cov”_¿‹
);

203 
defše_Úe_rw
(
hÙ_block_»şaim_´iÜ™y
);

204 
defše_Úe_rw
(
su¥icious_bad_lun_šdiÿtÜ
);

205 
defše_Úe_rw
(
debug_Ëv–
);

206 
defše_Úe_rw
(
shªnÚ_bufãr_wr™e
);

207 
defše_Úe_rw
(
shªnÚ_pŞl_times
);

208 
defše_Úe_rw
(
»ad_”r_msg_Ëv–
);

209 
defše_Úe_rw
(
wl_debug
);

210 
defše_Úe_rw
(
”r_check_debug
);

211 
defše_Úe_rw
(
»ad_di¡urb_th»shŞd
);

212 
defše_Úe_rw
(
İ’_block_»ad_di¡urb_th»shŞd
);

213 
defše_Úe_rw
(
wl_tim”_š‹rv®
);

214 
defše_Úe_rw
(
max_š_wl_logicbs
);

215 
defše_Úe_rw
(
wl_max_”a£_couÁ
);

216 
defše_Úe_rw
(
wl_”a£_couÁ_d–_0
);

217 
defše_Úe_rw
(
wl_”a£_couÁ_d–_1
);

218 
defše_Úe_rw
(
fl_chunk_tim”_expœe
);

219 
defše_Úe_rw
(
³riod_»ad_³riod
);

220 
defše_Úe_rw
(
³riod_»ad_µa
);

221 
defše_Úe_rw
(
sw™ch_miüocode
);

222 
defše_Úe_ro
(
£rviû_g
);

223 
defše_Úe_ro
(
åga_dÇ
);

224 
defše_Úe_ro
(
udid
);

225 
defše_Úe_ro
(
»äesh_mbr_couÁ
);

226 
defše_Úe_ro
(
©omic_wr™e
);

227 
defše_Úe_ro
(
´iÜ™ize_wr™e
);

228 
defše_Úe_ro
(
nÚ®igÃd_bios
);

229 
defše_Úe_rw
(
´št_Ï‹ncy_š‹rv®
);

230 
defše_Úe_rw
(
h¬d_queue_lim™
);

231 
defše_Úe_rw
(
cmd_queue_wr™es_lim™
);

232 
defše_Úe_ro
(
h¬dw¬e_v”siÚ
);

233 
defše_Úe_rw
(
ecc_çu»_¿‹_th»shŞd
);

234 
defše_Úe_ro
(
ıs_üc
);

235 
defše_Úe_rw
(
ç¡_»ad
);

236 
defše_Úe_rw
(
drİ_ÿche
);

237 
defše_Úe_rw
(
´eãtch_£q»ad_th»shŞd
);

238 
defše_Úe_rw
(
´eãtch_pŞl_times_th»shŞd
);

239 
defše_Úe_rw
(
´eãtch_soá_bio_size_th»shŞd
);

240 
defše_Úe_rw
(
´eãtch_h¬d_bio_size_th»shŞd
);

241 
defše_Úe_rw
(
´eãtch_Ïrge_block_io_th»shŞd
);

242 
defše_Úe_rw
(
´eãtch_di¡ªû_çùÜ
);

243 
defše_Úe_rw
(
´eãtch_’abË
);

244 
defše_Úe_rw
(
´eãtch_Œaffic_çùÜ
);

246 
defše_Úe_rw
(
upd©e_œq_d–ay_š‹rv®
);

247 
defše_Úe_rw
(
»ad_Ï‹ncy_divide
);

248 
defše_Úe_rw
(
wr™e_Ï‹ncy_divide
);

249 
defše_Úe_rw
(
»ad_th»shŞd_çùÜ
);

250 
defše_Úe_rw
(
wr™e_th»shŞd_çùÜ
);

251 
defše_Úe_rw
(
dyÇmic_œq_d–ay
);

252 
defše_Úe_rw
(
œq_d–ay_çùÜ
);

253 
defše_Úe_rw
(
mš_œq_d–ay
);

254 
defše_Úe_rw
(
max_œq_d–ay
);

256 #ifdeà
CONFIG_HWMON


257 
defše_Úe_deviû_ro
(
Çme
);

258 
defše_Úe_deviû_ro
(
‹mp1_šput
);

259 
defše_Úe_deviû_ro
(
‹mp1_Ïb–
);

260 
defše_Úe_deviû_ro
(
‹mp1_max
);

261 
defše_Úe_deviû_ro
(
‹mp1_ü™
);

262 
defše_Úe_deviû_ro
(
‹mp2_šput
);

263 
defše_Úe_deviû_ro
(
‹mp2_Ïb–
);

264 
defše_Úe_deviû_ro
(
‹mp2_max
);

265 
defše_Úe_deviû_ro
(
‹mp2_ü™
);

266 
defše_Úe_deviû_ro
(
‹mp3_šput
);

267 
defše_Úe_deviû_ro
(
‹mp3_Ïb–
);

268 
defše_Úe_deviû_ro
(
‹mp3_max
);

269 
defše_Úe_deviû_ro
(
‹mp3_ü™
);

271 
deviû_©Œibu‹
 *
	gshªnÚ_hwmÚ_©Œs
[] = {

272 &
Çme
.
©Œ
,

273 &
‹mp1_šput
.
©Œ
,

274 &
‹mp1_Ïb–
.
©Œ
,

275 &
‹mp1_max
.
©Œ
,

276 &
‹mp1_ü™
.
©Œ
,

277 &
‹mp2_šput
.
©Œ
,

278 &
‹mp2_Ïb–
.
©Œ
,

279 &
‹mp2_max
.
©Œ
,

280 &
‹mp2_ü™
.
©Œ
,

281 &
‹mp3_šput
.
©Œ
,

282 &
‹mp3_Ïb–
.
©Œ
,

283 &
‹mp3_max
.
©Œ
,

284 &
‹mp3_ü™
.
©Œ
,

285 
NULL
,

289 
©Œibu‹
 *
	gshªnÚ_deçuÉ_©Œs
[] = {

290 &
mod–
.
©Œ
,

291 &
fœmw¬e_v”siÚ
.
©Œ
,

292 &
fœmw¬e_bud
.
©Œ
,

293 &
driv”_v”siÚ
.
©Œ
,

294 &
£rŸl_numb”
.
©Œ
,

295 &
Çnd_mªuçùu»r
.
©Œ
,

296 &
Çnd_æash_id
.
©Œ
,

297 &
chªÃls
.
©Œ
,

298 &
lun£ts_š_chªÃl
.
©Œ
,

299 &
luns_š_lun£t
.
©Œ
,

300 &
avaabË_luns
.
©Œ
,

301 &
eblocks_š_lun
.
©Œ
,

302 &
·ges_š_eblock
.
©Œ
,

303 &
Çnd_·ge_size
.
©Œ
,

304 &
block_size
.
©Œ
,

305 &
u£_du®_h—d
.
©Œ
,

306 &
pow”_Ú_£cÚds
.
©Œ
,

307 &
pow”_cyşe_couÁ
.
©Œ
,

308 &
u£r_ÿ·c™y
.
©Œ
,

309 &
physiÿl_ÿ·c™y
.
©Œ
,

310 &
ov”´ovisiÚ
.
©Œ
,

311 &
ä“_blkút
.
©Œ
,

312 &
¡©ic_bad_blkút
.
©Œ
,

313 &
dyÇmic_bad_blkút
.
©Œ
,

314 &
max_”r_blocks
.
©Œ
,

315 &
»cÚfig_suµÜt
.
©Œ
,

316 &
£u_æag
.
©Œ
,

317 &
£u_üc_”rÜ
.
©Œ
,

318 &
£u_üc_”rÜ_hi¡Üy
.
©Œ
,

319 &
£u_ecc_”rÜ
.
©Œ
,

320 &
£u_ecc_”rÜ_hi¡Üy
.
©Œ
,

321 &
e¡im©ed_liã_Ëá
.
©Œ
,

322 &
ho¡_wr™e_£ùÜs
.
©Œ
,

323 &
ho¡_wr™e_bªdwidth
.
©Œ
,

324 &
ho¡_wr™e_iİs
.
©Œ
,

325 &
ho¡_wr™e_Ï‹ncy
.
©Œ
,

326 &
tÙ®_wr™e_£ùÜs
.
©Œ
,

327 &
tÙ®_wr™e_bªdwidth
.
©Œ
,

328 &
wr™e_am¶if›r
.
©Œ
,

329 &
wr™e_am¶if›r_liãtime
.
©Œ
,

330 &
ho¡_»ad_£ùÜs
.
©Œ
,

331 &
ho¡_»ad_bªdwidth
.
©Œ
,

332 &
ho¡_»ad_iİs
.
©Œ
,

333 &
ho¡_»ad_Ï‹ncy
.
©Œ
,

334 &
tÙ®_gc_logicbs
.
©Œ
,

335 &
tÙ®_wl_logicbs
.
©Œ
,

336 &
tÙ®_”r_»cov”_logicbs
.
©Œ
,

337 &
‹m³¿tu»_št
.
©Œ
,

338 &
‹m³¿tu»_št_max
.
©Œ
,

339 &
‹m³¿tu»_æash
.
©Œ
,

340 &
‹m³¿tu»_æash_max
.
©Œ
,

341 &
‹m³¿tu»_bßrd
.
©Œ
,

342 &
‹m³¿tu»_bßrd_max
.
©Œ
,

343 &
‹m³¿tu»_w¬nšg_th»shŞd
.
©Œ
,

344 &
vŞge_št
.
©Œ
,

345 &
vŞge_št_max
.
©Œ
,

346 &
vŞge_aux
.
©Œ
,

347 &
vŞge_aux_max
.
©Œ
,

348 &
ecc_çu»_times
.
©Œ
,

349 &
ecc_¡©i¡ics
.
©Œ
,

350 &
deviû_¡©e
.
©Œ
,

351 &
acûss_mode
.
©Œ
,

352 &
»adÚly_»asÚ
.
©Œ
,

353 &
»duûd_wr™e_»asÚ
.
©Œ
,

354 &
pm_qos_v®ue
.
©Œ
,

355 &
»cov”_¿‹
.
©Œ
,

356 &
hÙ_block_»şaim_´iÜ™y
.
©Œ
,

357 &
su¥icious_bad_lun_šdiÿtÜ
.
©Œ
,

358 &
debug_Ëv–
.
©Œ
,

359 &
shªnÚ_bufãr_wr™e
.
©Œ
,

360 &
shªnÚ_pŞl_times
.
©Œ
,

361 &
»ad_”r_msg_Ëv–
.
©Œ
,

362 &
wl_debug
.
©Œ
,

363 &
”r_check_debug
.
©Œ
,

364 &
»ad_di¡urb_th»shŞd
.
©Œ
,

365 &
İ’_block_»ad_di¡urb_th»shŞd
.
©Œ
,

366 &
wl_tim”_š‹rv®
.
©Œ
,

367 &
max_š_wl_logicbs
.
©Œ
,

368 &
wl_max_”a£_couÁ
.
©Œ
,

369 &
wl_”a£_couÁ_d–_0
.
©Œ
,

370 &
wl_”a£_couÁ_d–_1
.
©Œ
,

371 &
fl_chunk_tim”_expœe
.
©Œ
,

372 &
³riod_»ad_³riod
.
©Œ
,

373 &
³riod_»ad_µa
.
©Œ
,

374 &
sw™ch_miüocode
.
©Œ
,

375 &
£rviû_g
.
©Œ
,

376 &
åga_dÇ
.
©Œ
,

377 &
udid
.
©Œ
,

378 &
»äesh_mbr_couÁ
.
©Œ
,

379 &
©omic_wr™e
.
©Œ
,

380 &
´iÜ™ize_wr™e
.
©Œ
,

381 &
nÚ®igÃd_bios
.
©Œ
,

382 &
´št_Ï‹ncy_š‹rv®
.
©Œ
,

383 &
h¬d_queue_lim™
.
©Œ
,

384 &
cmd_queue_wr™es_lim™
.
©Œ
,

385 &
h¬dw¬e_v”siÚ
.
©Œ
,

386 &
ecc_çu»_¿‹_th»shŞd
.
©Œ
,

387 &
ıs_üc
.
©Œ
,

388 &
upd©e_œq_d–ay_š‹rv®
.
©Œ
,

389 &
»ad_Ï‹ncy_divide
.
©Œ
,

390 &
wr™e_Ï‹ncy_divide
.
©Œ
,

391 &
wr™e_th»shŞd_çùÜ
.
©Œ
,

392 &
»ad_th»shŞd_çùÜ
.
©Œ
,

393 &
dyÇmic_œq_d–ay
.
©Œ
,

394 &
œq_d–ay_çùÜ
.
©Œ
,

395 &
mš_œq_d–ay
.
©Œ
,

396 &
max_œq_d–ay
.
©Œ
,

397 &
ç¡_»ad
.
©Œ
,

398 &
drİ_ÿche
.
©Œ
,

399 &
´eãtch_£q»ad_th»shŞd
.
©Œ
,

400 &
´eãtch_pŞl_times_th»shŞd
.
©Œ
,

401 &
´eãtch_soá_bio_size_th»shŞd
.
©Œ
,

402 &
´eãtch_h¬d_bio_size_th»shŞd
.
©Œ
,

403 &
´eãtch_Ïrge_block_io_th»shŞd
.
©Œ
,

404 &
´eãtch_di¡ªû_çùÜ
.
©Œ
,

405 &
´eãtch_’abË
.
©Œ
,

406 &
´eãtch_Œaffic_çùÜ
.
©Œ
,

407 
NULL
,

410 
shªnÚ_ssize_t
 
	$pci_šfo_show
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

412 
shªnÚ_dev
 *
sdev
 = 
	`to_shªnÚ_dev
((
shªnÚ_kobjeù_t
 *)
kobj
->
·»Á
);

413 
shªnÚ_©Œ
 *
§‰r
 = 
	`to_shªnÚ_©Œ
(
©Œ
);

414 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

416 if(
§‰r
->
show
)

417 
»t
 = 
§‰r
->
	`show
(
sdev
, 
buf
);

419 
»t
 = -
EIO
;

421  
»t
;

422 
	}
}

424 
shªnÚ_ssize_t
 
	$pci_šfo_¡Üe
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

426 
shªnÚ_dev
 *
sdev
 = 
	`to_shªnÚ_dev
((
shªnÚ_kobjeù_t
 *)
kobj
->
·»Á
);

427 
shªnÚ_©Œ
 *
§‰r
 = 
	`to_shªnÚ_©Œ
(
©Œ
);

428 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

430 if(
§‰r
->
¡Üe
)

431 
»t
 = 
§‰r
->
	`¡Üe
(
sdev
, 
buf
, 
couÁ
);

433 
»t
 = -
EIO
;

435  
»t
;

436 
	}
}

438 
sysfs_İs
 
	gpci_šfo_sysfs_İs
 = {

439 .
show
 = 
pci_šfo_show
,

440 .
	g¡Üe
 = 
pci_šfo_¡Üe
,

443 
defše_Úe_ro
(
v’dÜ_id
);

444 
defše_Úe_ro
(
deviû_id
);

445 
defše_Úe_ro
(
subsy¡em_v’dÜ_id
);

446 
defše_Úe_ro
(
subsy¡em_deviû_id
);

447 
defše_Úe_ro
(
pci_add»ss
);

448 
defše_Úe_ro
(
pci_şass
);

449 
defše_Úe_ro
(
lškÿp
);

450 
defše_Úe_ro
(
lšk¡a
);

452 
©Œibu‹
 *
	gpci_šfo_deçuÉ_©Œs
[] = {

453 &
v’dÜ_id
.
©Œ
,

454 &
deviû_id
.
©Œ
,

455 &
subsy¡em_v’dÜ_id
.
©Œ
,

456 &
subsy¡em_deviû_id
.
©Œ
,

457 &
pci_add»ss
.
©Œ
,

458 &
pci_şass
.
©Œ
,

459 &
lškÿp
.
©Œ
,

460 &
lšk¡a
.
©Œ
,

461 
NULL
,

464 
kobj_ty³
 
	gshªnÚ_kty³
 = {

465 .
sysfs_İs
 = &
shªnÚ_sysfs_İs
,

466 .
	gdeçuÉ_©Œs
 = 
shªnÚ_deçuÉ_©Œs
,

467 .
	g»Ëa£
 = 
shªnÚ_sysfs_»Ëa£
,

470 
kobj_ty³
 
	gpci_šfo_kty³
 = {

471 .
sysfs_İs
 = &
pci_šfo_sysfs_İs
,

472 .
	gdeçuÉ_©Œs
 = 
pci_šfo_deçuÉ_©Œs
,

473 .
	g»Ëa£
 = 
shªnÚ_sysfs_»Ëa£
,

476 
	$shªnÚ_sysfs_š™
(
shªnÚ_kobjeù_t
 *
skobj
)

478 
»t
;

479 
kobjeù
 *
pci_šfo
 = (kobjeù *)
	`to_shªnÚ_pci_šfo_kobj
(
skobj
);

480 
miscdeviû
 *
misc
 = (miscdeviû *)
	`to_sdev_misc
(
skobj
);

481 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

482 
kobjeù
 *
dev_kobj
 = &
misc
->
this_deviû
->
kobj
;

484 
kobjeù
 *
dev_kobj
 = &
misc
->
şass
->
kobj
;

487 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

488 
	`mem£t
(
skobj
, 0x00, (
shªnÚ_kobjeù_t
));

489 
»t
 = 
	`kobjeù_š™_ªd_add
((
kobjeù
 *)
skobj
, &
shªnÚ_kty³
, 
dev_kobj
, "shannon");

490 ià(
»t
)

491  
»t
;

493 
	`mem£t
(
pci_šfo
, 0x00, (
shªnÚ_kobjeù_t
));

494 
»t
 = 
	`kobjeù_š™_ªd_add
(
pci_šfo
, &
pci_šfo_kty³
, (
kobjeù
 *)
skobj
, "pci_info");

495 ià(
»t
)

496 
d–_skobj
;

498 
kobjeù
 *
kobj
 = (kobjeù*)
skobj
;

500 
	`mem£t
(
skobj
, 0x00, (
shªnÚ_kobjeù_t
));

501 
	`kobjeù_š™
(
kobj
);

502 
kobj
->
·»Á
 = 
dev_kobj
;

503 
	`kobjeù_£t_Çme
(
kobj
, "shannon");

504 
kobj
->
kty³
 = &
shªnÚ_kty³
;

505 
»t
 = 
	`kobjeù_add
(
kobj
);

506 ià(
»t
)

507  
»t
;

509 
	`mem£t
(
pci_šfo
, 0x00, (
shªnÚ_kobjeù_t
));

510 
	`kobjeù_š™
(
pci_šfo
);

511 
pci_šfo
->
·»Á
 = 
kobj
;

512 
	`kobjeù_£t_Çme
(
pci_šfo
, "pci_info");

513 
pci_šfo
->
kty³
 = &
pci_šfo_kty³
;

514 
»t
 = 
	`kobjeù_add
(
pci_šfo
);

515 ià(
»t
)

516 
d–_skobj
;

519  
»t
;

520 
d–_skobj
:

521 
	`kobjeù_d–
((
kobjeù
 *)
skobj
);

523  
»t
;

524 
	}
}

526 
	$shªnÚ_sysfs_ex™
(
shªnÚ_kobjeù_t
 *
skobj
)

528 
kobjeù
 *
pci_šfo
 = (kobjeù *)
	`to_shªnÚ_pci_šfo_kobj
(
skobj
);

530 
	`kobjeù_d–
(
pci_šfo
);

531 
	`kobjeù_d–
((
kobjeù
 *)
skobj
);

532 
	}
}

534 
kobjeù
 *
	$to_sdev_kobj
(
shªnÚ_kobjeù_t
 *
skobj
)

536 
g’disk
 *
disk
 = (g’disk *)
	`to_shªnÚ_disk
(
skobj
);

537 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

538 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

539  &
	`disk_to_dev
(
disk
)->
kobj
;

541  &
disk
->
dev
.
kobj
;

545  &
disk
->
kobj
;

547 
	}
}

549 
	$shªnÚ_sysfs_lšk
(
shªnÚ_kobjeù_t
 *
skobj
)

551 
kobjeù
 *
sdev_kobj
 = 
	`to_sdev_kobj
(
skobj
);

552  
	`sysfs_ü—‹_lšk
(
sdev_kobj
, (
kobjeù
 *)
skobj
, "shannon");

553 
	}
}

555 
	$shªnÚ_sysfs_uÆšk
(
shªnÚ_kobjeù_t
 *
skobj
)

557 
kobjeù
 *
sdev_kobj
 = 
	`to_sdev_kobj
(
skobj
);

558 
	`sysfs_»move_lšk
(
sdev_kobj
, "shannon");

559 
	}
}

561 
shªnÚ_deviû_t
 *
	$shªnÚ_hwmÚ_š™
(
shªnÚ_pci_dev_t
 *
pdev
)

563 #ifdeà
CONFIG_HWMON


564 
deviû
 *
dev
 = &((
pci_dev
 *)
pdev
)->dev;

565 
deviû
 *
hwmÚ_dev
 = 
NULL
;

567 
”r
 = 0;

568 
i
;

571 
i
 = 0; 
shªnÚ_hwmÚ_©Œs
[i] && !
”r
; i++)

572 
”r
 = 
	`deviû_ü—‹_fe
(
dev
, 
shªnÚ_hwmÚ_©Œs
[
i
]);

574 ià(
”r
) {

575 --
i
 >= 0)

576 
	`deviû_»move_fe
(
dev
, 
shªnÚ_hwmÚ_©Œs
[
i
]);

577 
	`shªnÚ_w¬n
("create hwmon sysfs files failed!");

578  
NULL
;

581 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 10, 0)

582 
hwmÚ_dev
 = 
	`hwmÚ_deviû_»gi¡”
(
dev
);

584 
hwmÚ_dev
 = 
	`hwmÚ_deviû_»gi¡”_w™h_šfo
(
dev
, 
NULL
, NULL, NULL, NULL);

586 ià(
	`IS_ERR
(
hwmÚ_dev
)) {

587 
	`shªnÚ_w¬n
("hwmon_device_register failed!");

588 
i
 = 0; 
shªnÚ_hwmÚ_©Œs
[i]; i++)

589 
	`deviû_»move_fe
(
dev
, 
shªnÚ_hwmÚ_©Œs
[
i
]);

590  
NULL
;

593  
hwmÚ_dev
;

595  
NULL
;

597 
	}
}

599 
	$shªnÚ_hwmÚ_ex™
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_deviû_t
 *
hwmÚ_dev
)

601 #ifdeà
CONFIG_HWMON


602 
deviû
 *
dev
 = &((
pci_dev
 *)
pdev
)->dev;

603 
i
;

605 ià(
	`SHANNON_IS_ERR_OR_NULL
(
hwmÚ_dev
))

608 
	`hwmÚ_deviû_uÄegi¡”
((
deviû
 *)
hwmÚ_dev
);

609 
i
 = 0; 
shªnÚ_hwmÚ_©Œs
[i]; i++)

610 
	`deviû_»move_fe
(
dev
, 
shªnÚ_hwmÚ_©Œs
[
i
]);

612 
	}
}

616 
	sshªnÚ_©Œ_ns
 {

617 
©Œibu‹
 
	m©Œ
;

618 
shªnÚ_ssize_t
 (*
show
)(
	mshªnÚ_Çme¥aû
 *, *);

619 
shªnÚ_ssize_t
 (*
¡Üe
)(
	mshªnÚ_Çme¥aû
 *, cÚ¡ *, 
shªnÚ_size_t
 
	mcouÁ
);

622 
	#defše_Úe_rw_ns
(
_Çme
) \

623 
shªnÚ_©Œ_ns
 
_Çme
##
_ns
 = \

624 
	`__ATTR
(
_Çme
, 0644, _Çme##
_ns_show
, _Çme##
_ns_¡Üe
)

	)

630 
	#defše_Úe_ro_ns
(
_Çme
) \

631 
shªnÚ_©Œ_ns
 
_Çme
##
_ns
 = \

632 
	`__ATTR
(
_Çme
, 0444, _Çme##
_ns_show
, 
NULL
)

	)

635 
	#to_shªnÚ_©Œ_ns
(
a
è
	`cÚš”_of
×, 
shªnÚ_©Œ_ns
, 
©Œ
)

	)

637 
shªnÚ_ssize_t
 
	$shªnÚ_show_ns
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

639 
shªnÚ_Çme¥aû
 *
ns
 = 
	`to_shªnÚ_Çme¥aû
((
shªnÚ_kobjeù_t
 *)
kobj
);

640 
shªnÚ_©Œ_ns
 *
§‰r
 = 
	`to_shªnÚ_©Œ_ns
(
©Œ
);

641 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

643 ià(
§‰r
->
show
)

644 
»t
 = 
§‰r
->
	`show
(
ns
, 
buf
);

646 
»t
 = -
EIO
;

648  
»t
;

649 
	}
}

651 
shªnÚ_ssize_t
 
	$shªnÚ_¡Üe_ns
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

653 
shªnÚ_Çme¥aû
 *
ns
 = 
	`to_shªnÚ_Çme¥aû
((
shªnÚ_kobjeù_t
 *)
kobj
);

654 
shªnÚ_©Œ_ns
 *
§‰r
 = 
	`to_shªnÚ_©Œ_ns
(
©Œ
);

655 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

657 ià(
§‰r
->
¡Üe
)

658 
»t
 = 
§‰r
->
	`¡Üe
(
ns
, 
buf
, 
couÁ
);

660 
»t
 = -
EIO
;

662  
»t
;

663 
	}
}

665 
	$shªnÚ_sysfs_»Ëa£_ns
(
kobjeù
 *
kobj
)

667 
	}
}

669 
sysfs_İs
 
	gshªnÚ_sysfs_İs_ns
 = {

670 .
show
 = 
shªnÚ_show_ns
,

671 .
	g¡Üe
 = 
shªnÚ_¡Üe_ns
,

674 
defše_Úe_ro_ns
(
ho¡_wr™e_£ùÜs
);

675 
defše_Úe_ro_ns
(
ho¡_»ad_£ùÜs
);

676 
defše_Úe_ro_ns
(
v®id_£ùÜs
);

677 
defše_Úe_ro_ns
(
³ndšg_bios
);

678 
defše_Úe_ro_ns
(
nÚ®igÃd_bios
);

679 
defše_Úe_ro_ns
(
£q_num
);

680 
defše_Úe_ro_ns
(
rmw_li¡
);

681 
defše_Úe_rw_ns
(
´št_Ï‹ncy_š‹rv®
);

682 
defše_Úe_ro_ns
(
u£r_defšed_Çme
);

684 
©Œibu‹
 *
	gshªnÚ_deçuÉ_©Œs_ns
[] = {

685 &
ho¡_wr™e_£ùÜs_ns
.
©Œ
,

686 &
ho¡_»ad_£ùÜs_ns
.
©Œ
,

687 &
v®id_£ùÜs_ns
.
©Œ
,

688 &
³ndšg_bios_ns
.
©Œ
,

689 &
nÚ®igÃd_bios_ns
.
©Œ
,

690 &
£q_num_ns
.
©Œ
,

691 &
rmw_li¡_ns
.
©Œ
,

692 &
´št_Ï‹ncy_š‹rv®_ns
.
©Œ
,

693 &
u£r_defšed_Çme_ns
.
©Œ
,

694 
NULL
,

697 
kobj_ty³
 
	gshªnÚ_kty³_ns
 = {

698 .
sysfs_İs
 = &
shªnÚ_sysfs_İs_ns
,

699 .
	gdeçuÉ_©Œs
 = 
shªnÚ_deçuÉ_©Œs_ns
,

700 .
	g»Ëa£
 = 
shªnÚ_sysfs_»Ëa£_ns
,

703 
	$shªnÚ_sysfs_š™_ns
(
shªnÚ_kobjeù_t
 *
skobj
)

705 
»t
;

706 
g’disk
 *
disk
 = (g’disk *)
	`to_shªnÚ_disk_ns
(
skobj
);

707 *
ns_Çme
 = 
	`to_ns_Çme
(
skobj
);

708 
kobjeù
 *
ns_kobj
;

709 
miscdeviû
 *
misc
 = (miscdeviû *)
	`ns_to_poŞ_misc
(
skobj
);

710 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

711 
kobjeù
 *
poŞ_kobj
 = &
misc
->
this_deviû
->
kobj
;

713 
kobjeù
 *
poŞ_kobj
 = &
misc
->
şass
->
kobj
;

716 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

717 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 28)

718 
deviû
 *
ddev
 = 
	`disk_to_dev
(
disk
);

720 
deviû
 *
ddev
 = &
disk
->
dev
;

722 
	`mem£t
(
skobj
, 0x00, (
shªnÚ_kobjeù_t
));

723 
»t
 = 
	`kobjeù_š™_ªd_add
((
kobjeù
 *)
skobj
, &
shªnÚ_kty³_ns
, &
ddev
->
kobj
, "shannon");

724 
ns_kobj
 = &
ddev
->
kobj
;

726 
kobjeù
 *
kobj
 = (kobjeù *)
skobj
;

728 
	`mem£t
(
skobj
, 0x00, (
shªnÚ_kobjeù_t
));

729 
	`kobjeù_š™
(
kobj
);

730 
kobj
->
·»Á
 = &
disk
->kobj;

731 
	`kobjeù_£t_Çme
(
kobj
, "shannon");

732 
kobj
->
kty³
 = &
shªnÚ_kty³_ns
;

733 
»t
 = 
	`kobjeù_add
(
kobj
);

734 
ns_kobj
 = &
disk
->
kobj
;

737 ià(
»t
)

738  
»t
;

739 
»t
 = 
	`sysfs_ü—‹_lšk
(
poŞ_kobj
, 
ns_kobj
, 
ns_Çme
);

740 ià(
»t
)

741 
	`kobjeù_d–
(
ns_kobj
);

742  
»t
;

743 
	}
}

745 
	$shªnÚ_sysfs_ex™_ns
(
shªnÚ_kobjeù_t
 *
skobj
)

747 *
ns_Çme
 = 
	`to_ns_Çme
(
skobj
);

748 
miscdeviû
 *
misc
 = (miscdeviû *)
	`ns_to_poŞ_misc
(
skobj
);

749 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

750 
kobjeù
 *
poŞ_kobj
 = &
misc
->
this_deviû
->
kobj
;

752 
kobjeù
 *
poŞ_kobj
 = &
misc
->
şass
->
kobj
;

754 
	`kobjeù_d–
((
kobjeù
 *)
skobj
);

755 
	`sysfs_»move_lšk
(
poŞ_kobj
, 
ns_Çme
);

756 
	}
}

759 
	sshªnÚ_©Œ_poŞ
 {

760 
©Œibu‹
 
	m©Œ
;

761 
shªnÚ_ssize_t
 (*
show
)(
	mshªnÚ_poŞ
 *, *);

762 
shªnÚ_ssize_t
 (*
¡Üe
)(
	mshªnÚ_poŞ
 *, cÚ¡ *, 
shªnÚ_size_t
 
	mcouÁ
);

765 
	#defše_Úe_rw_poŞ
(
_Çme
) \

766 
shªnÚ_©Œ_poŞ
 
_Çme
##
_poŞ
 = \

767 
	`__ATTR
(
_Çme
, 0644, _Çme##
_poŞ_show
, _Çme##
_poŞ_¡Üe
)

	)

773 
	#defše_Úe_ro_poŞ
(
_Çme
) \

774 
shªnÚ_©Œ_poŞ
 
_Çme
##
_poŞ
 = \

775 
	`__ATTR
(
_Çme
, 0444, _Çme##
_poŞ_show
, 
NULL
)

	)

777 
	#to_shªnÚ_©Œ_poŞ
(
a
è
	`cÚš”_of
×, 
shªnÚ_©Œ_poŞ
, 
©Œ
)

	)

779 
shªnÚ_ssize_t
 
	$shªnÚ_show_poŞ
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, *
buf
)

781 
shªnÚ_poŞ
 *
poŞ
 = 
	`to_shªnÚ_poŞ
((
shªnÚ_kobjeù_t
 *)
kobj
);

782 
shªnÚ_©Œ_poŞ
 *
§‰r
 = 
	`to_shªnÚ_©Œ_poŞ
(
©Œ
);

783 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

785 ià(
§‰r
->
show
)

786 
»t
 = 
§‰r
->
	`show
(
poŞ
, 
buf
);

788 
»t
 = -
EIO
;

790  
»t
;

791 
	}
}

793 
shªnÚ_ssize_t
 
	$shªnÚ_¡Üe_poŞ
(
kobjeù
 *
kobj
, 
©Œibu‹
 *
©Œ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

795 
shªnÚ_poŞ
 *
poŞ
 = 
	`to_shªnÚ_poŞ
((
shªnÚ_kobjeù_t
 *)
kobj
);

796 
shªnÚ_©Œ_poŞ
 *
§‰r
 = 
	`to_shªnÚ_©Œ_poŞ
(
©Œ
);

797 
shªnÚ_ssize_t
 
»t
 = -
EINVAL
;

799 ià(
§‰r
->
¡Üe
)

800 
»t
 = 
§‰r
->
	`¡Üe
(
poŞ
, 
buf
, 
couÁ
);

802 
»t
 = -
EIO
;

804  
»t
;

805 
	}
}

807 
	$shªnÚ_sysfs_»Ëa£_poŞ
(
kobjeù
 *
kobj
)

809 
	}
}

811 
sysfs_İs
 
	gshªnÚ_sysfs_İs_poŞ
 = {

812 .
show
 = 
shªnÚ_show_poŞ
,

813 .
	g¡Üe
 = 
shªnÚ_¡Üe_poŞ
,

816 
defše_Úe_ro_poŞ
(
u£d_¥aû_³rûÁage
);

817 
defše_Úe_ro_poŞ
(
physiÿl_ÿ·c™y
);

818 
defše_Úe_rw_poŞ
(
ov”´ovisiÚ
);

819 
defše_Úe_rw_poŞ
(
h¬d_queue_lim™
);

821 
©Œibu‹
 *
	gshªnÚ_deçuÉ_©Œs_poŞ
[] = {

822 &
u£d_¥aû_³rûÁage_poŞ
.
©Œ
,

823 &
physiÿl_ÿ·c™y_poŞ
.
©Œ
,

824 &
ov”´ovisiÚ_poŞ
.
©Œ
,

825 &
h¬d_queue_lim™_poŞ
.
©Œ
,

826 
NULL
,

829 
kobj_ty³
 
	gshªnÚ_kty³_poŞ
 = {

830 .
sysfs_İs
 = &
shªnÚ_sysfs_İs_poŞ
,

831 .
	gdeçuÉ_©Œs
 = 
shªnÚ_deçuÉ_©Œs_poŞ
,

832 .
	g»Ëa£
 = 
shªnÚ_sysfs_»Ëa£_poŞ
,

835 
	$shªnÚ_sysfs_š™_poŞ
(
shªnÚ_kobjeù_t
 *
skobj
)

837 
»t
;

838 
miscdeviû
 *
misc
 = (miscdeviû *)
	`to_poŞ_misc
(
skobj
);

839 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

840 
deviû
 *
poŞ_dev
 = 
misc
->
this_deviû
;

842 
şass_deviû
 *
poŞ_dev
 = 
misc
->
şass
;

845 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 25)

846 
	`mem£t
(
skobj
, 0x00, (
shªnÚ_kobjeù_t
));

847 
»t
 = 
	`kobjeù_š™_ªd_add
((
kobjeù
 *)
skobj
, &
shªnÚ_kty³_poŞ
, &
poŞ_dev
->
kobj
, "shannon");

849 
kobjeù
 *
kobj
 = (kobjeù *)
skobj
;

851 
	`mem£t
(
skobj
, 0x00, (
shªnÚ_kobjeù_t
));

852 
	`kobjeù_š™
(
kobj
);

853 
kobj
->
·»Á
 = &
poŞ_dev
->kobj;

854 
	`kobjeù_£t_Çme
(
kobj
, "shannon");

855 
kobj
->
kty³
 = &
shªnÚ_kty³_poŞ
;

856 
»t
 = 
	`kobjeù_add
(
kobj
);

859  
»t
;

860 
	}
}

862 
	$shªnÚ_sysfs_ex™_poŞ
(
shªnÚ_kobjeù_t
 *
skobj
)

864 
	`kobjeù_d–
((
kobjeù
 *)
skobj
);

865 
	}
}

	@shannon_sysfs.h

1 #iâdeà
__SHANNON_SYSFS_H


2 
	#__SHANNON_SYSFS_H


	)

4 
	~"shªnÚ_kcÜe.h
"

6 
	s__shªnÚ_kobjeù
 {

7 
RESERVE_MEM
(152);

10 
__shªnÚ_kobjeù
 
	tshªnÚ_kobjeù_t
;

12 
shªnÚ_sysfs_š™
(
shªnÚ_kobjeù_t
 *
skobj
);

13 
shªnÚ_sysfs_ex™
(
shªnÚ_kobjeù_t
 *
skobj
);

14 
shªnÚ_sysfs_lšk
(
shªnÚ_kobjeù_t
 *
skobj
);

15 
shªnÚ_sysfs_uÆšk
(
shªnÚ_kobjeù_t
 *
skobj
);

16 
shªnÚ_deviû_t
 *
shªnÚ_hwmÚ_š™
(
shªnÚ_pci_dev_t
 *
pdev
);

17 
shªnÚ_hwmÚ_ex™
(
shªnÚ_pci_dev_t
 *
pdev
, 
shªnÚ_deviû_t
 *
hwmÚ_dev
);

19 
	gshªnÚ_dev
;

21 
shªnÚ_dev
 * 
to_shªnÚ_dev
(
shªnÚ_kobjeù_t
 *
skobj
);

22 *
to_sdev_misc
(
shªnÚ_kobjeù_t
 *
skobj
);

23 *
to_shªnÚ_disk
(
shªnÚ_kobjeù_t
 *
skobj
);

24 
shªnÚ_kobjeù_t
 *
to_shªnÚ_pci_šfo_kobj
(shªnÚ_kobjeù_ˆ*
skobj
);

25 * 
shªnÚ_disk_Çme
(
shªnÚ_dev
 *
sdev
);

26 
shªnÚ_ssize_t
 
mod–_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

27 
shªnÚ_ssize_t
 
fœmw¬e_v”siÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

28 
shªnÚ_ssize_t
 
fœmw¬e_bud_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

29 
shªnÚ_ssize_t
 
driv”_v”siÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

30 
shªnÚ_ssize_t
 
£rŸl_numb”_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

31 
shªnÚ_ssize_t
 
Çnd_mªuçùu»r_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

32 
shªnÚ_ssize_t
 
Çnd_æash_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

33 
shªnÚ_ssize_t
 
chªÃls_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

34 
shªnÚ_ssize_t
 
lun£ts_š_chªÃl_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

35 
shªnÚ_ssize_t
 
luns_š_lun£t_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

36 
shªnÚ_ssize_t
 
avaabË_luns_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

37 
shªnÚ_ssize_t
 
eblocks_š_lun_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

38 
shªnÚ_ssize_t
 
·ges_š_eblock_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

39 
shªnÚ_ssize_t
 
Çnd_·ge_size_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

40 
shªnÚ_ssize_t
 
block_size_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

41 
shªnÚ_ssize_t
 
u£_du®_h—d_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

42 
shªnÚ_ssize_t
 
pow”_Ú_£cÚds_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

43 
shªnÚ_ssize_t
 
pow”_cyşe_couÁ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

44 
shªnÚ_ssize_t
 
u£r_ÿ·c™y_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

45 
shªnÚ_ssize_t
 
physiÿl_ÿ·c™y_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

46 
shªnÚ_ssize_t
 
ov”´ovisiÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

47 
shªnÚ_ssize_t
 
ä“_blkút_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

48 
shªnÚ_ssize_t
 
¡©ic_bad_blkút_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

49 
shªnÚ_ssize_t
 
dyÇmic_bad_blkút_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

50 
shªnÚ_ssize_t
 
max_”r_blocks_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

51 
shªnÚ_ssize_t
 
»cÚfig_suµÜt_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

52 
shªnÚ_ssize_t
 
£u_æag_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

53 
shªnÚ_ssize_t
 
£u_üc_”rÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

54 
shªnÚ_ssize_t
 
£u_üc_”rÜ_hi¡Üy_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

55 
shªnÚ_ssize_t
 
£u_ecc_”rÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

56 
shªnÚ_ssize_t
 
£u_ecc_”rÜ_hi¡Üy_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

57 
shªnÚ_ssize_t
 
e¡im©ed_liã_Ëá_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

58 
shªnÚ_ssize_t
 
ho¡_wr™e_£ùÜs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

59 
shªnÚ_ssize_t
 
ho¡_wr™e_bªdwidth_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

60 
shªnÚ_ssize_t
 
ho¡_wr™e_iİs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

61 
shªnÚ_ssize_t
 
ho¡_wr™e_Ï‹ncy_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

62 
shªnÚ_ssize_t
 
tÙ®_wr™e_£ùÜs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

63 
shªnÚ_ssize_t
 
tÙ®_wr™e_bªdwidth_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

64 
shªnÚ_ssize_t
 
wr™e_am¶if›r_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

65 
shªnÚ_ssize_t
 
wr™e_am¶if›r_liãtime_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

66 
shªnÚ_ssize_t
 
ho¡_»ad_£ùÜs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

67 
shªnÚ_ssize_t
 
ho¡_»ad_bªdwidth_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

68 
shªnÚ_ssize_t
 
ho¡_»ad_iİs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

69 
shªnÚ_ssize_t
 
ho¡_»ad_Ï‹ncy_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

70 
shªnÚ_ssize_t
 
tÙ®_gc_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

71 
shªnÚ_ssize_t
 
tÙ®_wl_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

72 
shªnÚ_ssize_t
 
tÙ®_”r_»cov”_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

73 
shªnÚ_ssize_t
 
‹m³¿tu»_št_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

74 
shªnÚ_ssize_t
 
‹m³¿tu»_št_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

75 
shªnÚ_ssize_t
 
‹m³¿tu»_æash_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

76 
shªnÚ_ssize_t
 
‹m³¿tu»_æash_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

77 
shªnÚ_ssize_t
 
‹m³¿tu»_bßrd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

78 
shªnÚ_ssize_t
 
‹m³¿tu»_bßrd_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

79 
shªnÚ_ssize_t
 
‹m³¿tu»_w¬nšg_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

80 
shªnÚ_ssize_t
 
‹m³¿tu»_w¬nšg_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

81 
shªnÚ_ssize_t
 
vŞge_št_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

82 
shªnÚ_ssize_t
 
vŞge_št_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

83 
shªnÚ_ssize_t
 
vŞge_aux_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

84 
shªnÚ_ssize_t
 
vŞge_aux_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

85 
shªnÚ_ssize_t
 
ecc_çu»_times_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

86 
shªnÚ_ssize_t
 
ecc_¡©i¡ics_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

87 
shªnÚ_ssize_t
 
deviû_¡©e_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

88 
shªnÚ_ssize_t
 
acûss_mode_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

89 
shªnÚ_ssize_t
 
»duûd_wr™e_»asÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

90 
shªnÚ_ssize_t
 
»adÚly_»asÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

91 
shªnÚ_ssize_t
 
pm_qos_v®ue_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

92 
shªnÚ_ssize_t
 
pm_qos_v®ue_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

93 
shªnÚ_ssize_t
 
»cov”_¿‹_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

94 
shªnÚ_ssize_t
 
»cov”_¿‹_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

95 
shªnÚ_ssize_t
 
hÙ_block_»şaim_´iÜ™y_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

96 
shªnÚ_ssize_t
 
hÙ_block_»şaim_´iÜ™y_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

97 
shªnÚ_ssize_t
 
su¥icious_bad_lun_šdiÿtÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

98 
shªnÚ_ssize_t
 
su¥icious_bad_lun_šdiÿtÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

99 
shªnÚ_ssize_t
 
debug_Ëv–_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

100 
shªnÚ_ssize_t
 
debug_Ëv–_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

101 
shªnÚ_ssize_t
 
shªnÚ_bufãr_wr™e_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

102 
shªnÚ_ssize_t
 
shªnÚ_bufãr_wr™e_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

103 
shªnÚ_ssize_t
 
shªnÚ_pŞl_times_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

104 
shªnÚ_ssize_t
 
shªnÚ_pŞl_times_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

105 
shªnÚ_ssize_t
 
»ad_”r_msg_Ëv–_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

106 
shªnÚ_ssize_t
 
»ad_”r_msg_Ëv–_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

107 
shªnÚ_ssize_t
 
wl_debug_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

108 
shªnÚ_ssize_t
 
wl_debug_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

109 
shªnÚ_ssize_t
 
”r_check_debug_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

110 
shªnÚ_ssize_t
 
”r_check_debug_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

111 
shªnÚ_ssize_t
 
»ad_di¡urb_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

112 
shªnÚ_ssize_t
 
»ad_di¡urb_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

113 
shªnÚ_ssize_t
 
İ’_block_»ad_di¡urb_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

114 
shªnÚ_ssize_t
 
İ’_block_»ad_di¡urb_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

115 
shªnÚ_ssize_t
 
wl_tim”_š‹rv®_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

116 
shªnÚ_ssize_t
 
wl_tim”_š‹rv®_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

117 
shªnÚ_ssize_t
 
max_š_wl_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

118 
shªnÚ_ssize_t
 
max_š_wl_logicbs_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

119 
shªnÚ_ssize_t
 
wl_max_”a£_couÁ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

120 
shªnÚ_ssize_t
 
wl_max_”a£_couÁ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

121 
shªnÚ_ssize_t
 
wl_”a£_couÁ_d–_0_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

122 
shªnÚ_ssize_t
 
wl_”a£_couÁ_d–_0_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

123 
shªnÚ_ssize_t
 
wl_”a£_couÁ_d–_1_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

124 
shªnÚ_ssize_t
 
wl_”a£_couÁ_d–_1_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

125 
shªnÚ_ssize_t
 
fl_chunk_tim”_expœe_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

126 
shªnÚ_ssize_t
 
fl_chunk_tim”_expœe_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

127 
shªnÚ_ssize_t
 
£rviû_g_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

128 
shªnÚ_ssize_t
 
åga_dÇ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

129 
shªnÚ_ssize_t
 
udid_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

130 
shªnÚ_ssize_t
 
»äesh_mbr_couÁ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

131 
shªnÚ_ssize_t
 
©omic_wr™e_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

132 
shªnÚ_ssize_t
 
´iÜ™ize_wr™e_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

133 
shªnÚ_ssize_t
 
nÚ®igÃd_bios_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

134 
shªnÚ_ssize_t
 
Çme_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

135 
shªnÚ_ssize_t
 
‹mp1_šput_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

136 
shªnÚ_ssize_t
 
‹mp1_Ïb–_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

137 
shªnÚ_ssize_t
 
‹mp1_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

138 
shªnÚ_ssize_t
 
‹mp1_ü™_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

139 
shªnÚ_ssize_t
 
‹mp2_šput_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

140 
shªnÚ_ssize_t
 
‹mp2_Ïb–_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

141 
shªnÚ_ssize_t
 
‹mp2_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

142 
shªnÚ_ssize_t
 
‹mp2_ü™_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

143 
shªnÚ_ssize_t
 
‹mp3_šput_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

144 
shªnÚ_ssize_t
 
‹mp3_Ïb–_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

145 
shªnÚ_ssize_t
 
‹mp3_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

146 
shªnÚ_ssize_t
 
‹mp3_ü™_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

148 
shªnÚ_ssize_t
 
v’dÜ_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

149 
shªnÚ_ssize_t
 
deviû_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

150 
shªnÚ_ssize_t
 
subsy¡em_v’dÜ_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

151 
shªnÚ_ssize_t
 
subsy¡em_deviû_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

152 
shªnÚ_ssize_t
 
pci_add»ss_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

153 
shªnÚ_ssize_t
 
pci_şass_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

154 
shªnÚ_ssize_t
 
lškÿp_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

155 
shªnÚ_ssize_t
 
lšk¡a_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

156 
shªnÚ_ssize_t
 
³riod_»ad_³riod_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

157 
shªnÚ_ssize_t
 
³riod_»ad_³riod_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

158 
shªnÚ_ssize_t
 
³riod_»ad_µa_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

159 
shªnÚ_ssize_t
 
³riod_»ad_µa_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

160 
shªnÚ_ssize_t
 
sw™ch_miüocode_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

161 
shªnÚ_ssize_t
 
sw™ch_miüocode_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

162 
shªnÚ_ssize_t
 
´št_Ï‹ncy_š‹rv®_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

163 
shªnÚ_ssize_t
 
´št_Ï‹ncy_š‹rv®_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

164 
shªnÚ_ssize_t
 
h¬d_queue_lim™_show
(
shªnÚ_dev
 *, *
buf
);

165 
shªnÚ_ssize_t
 
h¬d_queue_lim™_¡Üe
(
shªnÚ_dev
 *, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

166 
shªnÚ_ssize_t
 
cmd_queue_wr™es_lim™_show
(
shªnÚ_dev
 *, *
buf
);

167 
shªnÚ_ssize_t
 
cmd_queue_wr™es_lim™_¡Üe
(
shªnÚ_dev
 *, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

168 
shªnÚ_ssize_t
 
h¬dw¬e_v”siÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

169 
shªnÚ_ssize_t
 
ecc_çu»_¿‹_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

170 
shªnÚ_ssize_t
 
ecc_çu»_¿‹_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

171 
shªnÚ_ssize_t
 
ıs_üc_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

172 
shªnÚ_ssize_t
 
ç¡_»ad_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

173 
shªnÚ_ssize_t
 
ç¡_»ad_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

175 
shªnÚ_ssize_t
 
upd©e_œq_d–ay_š‹rv®_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

176 
shªnÚ_ssize_t
 
upd©e_œq_d–ay_š‹rv®_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

177 
shªnÚ_ssize_t
 
dyÇmic_œq_d–ay_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

178 
shªnÚ_ssize_t
 
dyÇmic_œq_d–ay_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

179 
shªnÚ_ssize_t
 
œq_d–ay_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

180 
shªnÚ_ssize_t
 
œq_d–ay_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

181 
shªnÚ_ssize_t
 
max_œq_d–ay_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

182 
shªnÚ_ssize_t
 
max_œq_d–ay_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

183 
shªnÚ_ssize_t
 
mš_œq_d–ay_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

184 
shªnÚ_ssize_t
 
mš_œq_d–ay_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

185 
shªnÚ_ssize_t
 
»ad_Ï‹ncy_divide_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

186 
shªnÚ_ssize_t
 
»ad_Ï‹ncy_divide_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

187 
shªnÚ_ssize_t
 
wr™e_Ï‹ncy_divide_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

188 
shªnÚ_ssize_t
 
wr™e_Ï‹ncy_divide_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

189 
shªnÚ_ssize_t
 
wr™e_th»shŞd_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

190 
shªnÚ_ssize_t
 
wr™e_th»shŞd_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

191 
shªnÚ_ssize_t
 
»ad_th»shŞd_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

192 
shªnÚ_ssize_t
 
»ad_th»shŞd_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

193 
shªnÚ_ssize_t
 
drİ_ÿche_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

194 
shªnÚ_ssize_t
 
drİ_ÿche_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

195 
shªnÚ_ssize_t
 
´eãtch_£q»ad_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

196 
shªnÚ_ssize_t
 
´eãtch_£q»ad_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

197 
shªnÚ_ssize_t
 
´eãtch_pŞl_times_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

198 
shªnÚ_ssize_t
 
´eãtch_pŞl_times_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

199 
shªnÚ_ssize_t
 
´eãtch_soá_bio_size_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

200 
shªnÚ_ssize_t
 
´eãtch_soá_bio_size_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

201 
shªnÚ_ssize_t
 
´eãtch_h¬d_bio_size_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

202 
shªnÚ_ssize_t
 
´eãtch_h¬d_bio_size_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

203 
shªnÚ_ssize_t
 
´eãtch_Ïrge_block_io_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

204 
shªnÚ_ssize_t
 
´eãtch_Ïrge_block_io_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

205 
shªnÚ_ssize_t
 
´eãtch_di¡ªû_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

206 
shªnÚ_ssize_t
 
´eãtch_di¡ªû_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

207 
shªnÚ_ssize_t
 
´eãtch_’abË_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

208 
shªnÚ_ssize_t
 
´eãtch_’abË_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

209 
shªnÚ_ssize_t
 
´eãtch_Œaffic_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
);

210 
shªnÚ_ssize_t
 
´eãtch_Œaffic_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

214 *
to_ns_Çme
(
shªnÚ_kobjeù_t
 *
skobj
);

215 *
ns_to_poŞ_misc
(
shªnÚ_kobjeù_t
 *
skobj
);

216 
shªnÚ_Çme¥aû
 *
to_shªnÚ_Çme¥aû
(
shªnÚ_kobjeù_t
 *
skobj
);

217 *
to_shªnÚ_disk_ns
(
shªnÚ_kobjeù_t
 *
skobj
);

218 
shªnÚ_ssize_t
 
ho¡_wr™e_£ùÜs_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

219 
shªnÚ_ssize_t
 
ho¡_»ad_£ùÜs_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

220 
shªnÚ_ssize_t
 
v®id_£ùÜs_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

221 
shªnÚ_ssize_t
 
³ndšg_bios_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

222 
shªnÚ_ssize_t
 
nÚ®igÃd_bios_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

223 
shªnÚ_ssize_t
 
£q_num_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

224 
shªnÚ_ssize_t
 
rmw_li¡_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

225 
shªnÚ_ssize_t
 
´št_Ï‹ncy_š‹rv®_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

226 
shªnÚ_ssize_t
 
´št_Ï‹ncy_š‹rv®_ns_¡Üe
(
shªnÚ_Çme¥aû
 *
ns
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

227 
shªnÚ_ssize_t
 
u£r_defšed_Çme_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
);

228 
shªnÚ_sysfs_š™_ns
(
shªnÚ_kobjeù_t
 *
skobj
);

229 
shªnÚ_sysfs_ex™_ns
(
shªnÚ_kobjeù_t
 *
skobj
);

232 
shªnÚ_poŞ
 *
to_shªnÚ_poŞ
(
shªnÚ_kobjeù_t
 *
skobj
);

233 *
to_poŞ_misc
(
shªnÚ_kobjeù_t
 *
skobj
);

234 
shªnÚ_ssize_t
 
u£d_¥aû_³rûÁage_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
);

235 
shªnÚ_ssize_t
 
physiÿl_ÿ·c™y_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
);

236 
shªnÚ_sysfs_š™_poŞ
(
shªnÚ_kobjeù_t
 *
skobj
);

237 
shªnÚ_sysfs_ex™_poŞ
(
shªnÚ_kobjeù_t
 *
skobj
);

238 
shªnÚ_ssize_t
 
ov”´ovisiÚ_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
);

239 
shªnÚ_ssize_t
 
ov”´ovisiÚ_poŞ_¡Üe
(
shªnÚ_poŞ
 *
¥oŞ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

240 
shªnÚ_ssize_t
 
h¬d_queue_lim™_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
);

241 
shªnÚ_ssize_t
 
h¬d_queue_lim™_poŞ_¡Üe
(
shªnÚ_poŞ
 *
¥oŞ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
);

	@shannon_sysfs_core.c

5 
shªnÚ_dev
 * 
	$to_shªnÚ_dev
(
shªnÚ_kobjeù_t
 *
skobj
)

7  
	`cÚš”_of
(
skobj
, 
shªnÚ_dev
, 
sysfs_kobj
);

8 
	}
}

10 *
	$to_sdev_misc
(
shªnÚ_kobjeù_t
 *
skobj
)

12 
shªnÚ_dev
 *
p
 = 
	`cÚš”_of
(
skobj
, shªnÚ_dev, 
sysfs_kobj
);

13  &
p
->
misc
;

14 
	}
}

16 *
	$to_shªnÚ_disk
(
shªnÚ_kobjeù_t
 *
skobj
)

18 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
skobj
, shªnÚ_dev, 
sysfs_kobj
);

19  
sdev
->
sdisk
.
gd
;

20 
	}
}

22 
shªnÚ_kobjeù_t
 *
	$to_shªnÚ_pci_šfo_kobj
(
shªnÚ_kobjeù_t
 *
skobj
)

24 
shªnÚ_dev
 *
sdev
 = 
	`cÚš”_of
(
skobj
, shªnÚ_dev, 
sysfs_kobj
);

25  &
sdev
->
sysfs_pci_šfo_kobj
;

26 
	}
}

28 * 
	$shªnÚ_disk_Çme
(
shªnÚ_dev
 *
sdev
)

30  
sdev
->
sdisk
.
disk_Çme
;

31 
	}
}

33 
shªnÚ_ssize_t
 
	$Çnd_mªuçùu»r_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

35  
	`shªnÚ_¥rštf
(
buf
, "%0#Îx\n", 
sdev
->
mbr
.
Çnd_mªuçùu»
);

36 
	}
}

38 
shªnÚ_ssize_t
 
	$Çnd_æash_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

40  
	`shªnÚ_¥rštf
(
buf
, "%0#Îx\n", 
sdev
->
mbr
.
Çnd_id
);

41 
	}
}

43 
shªnÚ_ssize_t
 
	$chªÃls_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

45  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
mbr
.
cfg_chªÃls
);

46 
	}
}

48 
shªnÚ_ssize_t
 
	$lun£ts_š_chªÃl_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

50  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
mbr
.
cfg_lun£t_š_chªÃl
);

51 
	}
}

53 
shªnÚ_ssize_t
 
	$luns_š_lun£t_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

55  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
mbr
.
cfg_lun_š_lun£t
);

56 
	}
}

58 
shªnÚ_ssize_t
 
	$avaabË_luns_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

60  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
mbr
.
lun_amouÁ
);

61 
	}
}

63 
shªnÚ_ssize_t
 
	$eblocks_š_lun_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

65  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
mbr
.
eblocks_š_lun
);

66 
	}
}

68 
shªnÚ_ssize_t
 
	$·ges_š_eblock_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

70  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
mbr
.
·ges_š_eblock
);

71 
	}
}

73 
shªnÚ_ssize_t
 
	$Çnd_·ge_size_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

75  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
Çnd_·ge_size
);

76 
	}
}

78 
shªnÚ_ssize_t
 
	$block_size_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

80  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
logicb_size
);

81 
	}
}

83 
shªnÚ_ssize_t
 
	$u£_du®_h—d_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

85  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
u£_du®_h—d
);

86 
	}
}

88 
shªnÚ_ssize_t
 
	$pow”_Ú_£cÚds_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

90 
	`upd©e_pow”_Ú_£cÚds
(
sdev
);

91  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
pow”_Ú_£cÚds
);

92 
	}
}

94 
shªnÚ_ssize_t
 
	$pow”_cyşe_couÁ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

96  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
pow”_cyşe_couÁ
);

97 
	}
}

99 
shªnÚ_ssize_t
 
	$u£r_ÿ·c™y_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

101  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
sdisk
.
£ùÜs
);

102 
	}
}

104 
shªnÚ_ssize_t
 
	$physiÿl_ÿ·c™y_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

106  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
max_£ùÜs
);

107 
	}
}

109 
shªnÚ_ssize_t
 
	$ov”´ovisiÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

111  
	`shªnÚ_¥rštf
(
buf
, "%d.%d\n", 
sdev
->
ov”´ovisiÚ_¿‹
 / 100, sdev->overprovision_rate % 100);

112 
	}
}

114 
shªnÚ_ssize_t
 
	$ä“_blkút_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

116  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
ä“_blkút
);

117 
	}
}

119 
shªnÚ_ssize_t
 
	$¡©ic_bad_blkút_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

121  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
¡©ic_bad_blkút
));

122 
	}
}

124 
shªnÚ_ssize_t
 
	$dyÇmic_bad_blkút_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

126  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
dyÇmic_bad_blkút
));

127 
	}
}

129 
shªnÚ_ssize_t
 
	$max_”r_blocks_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

131 
i
, 
lun
 = -1, 
max_”r_blocks
 = 0;

133 
i
 = 0; i < 
sdev
->
lun_couÁ
; i++) {

134 ià(
	`shªnÚ_©omic_»ad
(&
sdev
->
lun
[
i
]->
”r_blocks
è> 
max_”r_blocks
) {

135 
lun
 = 
i
;

136 
max_”r_blocks
 = 
	`shªnÚ_©omic_»ad
(&
sdev
->
lun
[
i
]->
”r_blocks
);

140  
	`shªnÚ_¥rštf
(
buf
, "%dƒ¼ block š†un=%d\n", 
max_”r_blocks
, 
lun
);

141 
	}
}

143 
shªnÚ_ssize_t
 
	$»cÚfig_suµÜt_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

145  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
sdev
->
»cÚfig_suµÜt
);

146 
	}
}

148 
shªnÚ_ssize_t
 
	$£u_æag_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

150 ià(
sdev
->
£u_üc_”rÜ
)

151  
	`shªnÚ_¥rštf
(
buf
, "uncorrectable\n");

152 ià(
sdev
->
£u_ecc_”rÜ
)

153  
	`shªnÚ_¥rštf
(
buf
, "correctable\n");

155  
	`shªnÚ_¥rštf
(
buf
, "normal\n");

156 
	}
}

158 
shªnÚ_ssize_t
 
	$£u_üc_”rÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

160  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
sdev
->
£u_üc_”rÜ
);

161 
	}
}

163 
shªnÚ_ssize_t
 
	$£u_üc_”rÜ_hi¡Üy_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

165  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
sdev
->
£u_üc_”rÜ_hi¡Üy
);

166 
	}
}

168 
shªnÚ_ssize_t
 
	$£u_ecc_”rÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

170  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
sdev
->
£u_ecc_”rÜ
);

171 
	}
}

173 
shªnÚ_ssize_t
 
	$£u_ecc_”rÜ_hi¡Üy_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

175  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
sdev
->
£u_ecc_”rÜ_hi¡Üy
);

176 
	}
}

179 
shªnÚ_ssize_t
 
	$e¡im©ed_liã_Ëá_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

181 ià(
sdev
->
av”age_”a£_couÁ
 >ğsdev->
æash_³_th»shŞd
)

182  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 0);

184  
	`shªnÚ_¥rštf
(
buf
, "%d\n", (
sdev
->
æash_³_th»shŞd
 - sdev->
av”age_”a£_couÁ
) * 100 / sdev->flash_pe_threshold);

185 
	}
}

187 
shªnÚ_ssize_t
 
	$ho¡_wr™e_£ùÜs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

189  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
ho¡_wr™e_£ùÜs
);

190 
	}
}

192 
shªnÚ_ssize_t
 
	$ho¡_wr™e_bªdwidth_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

194 
	`upd©e_io_¡©i¡ics
(
sdev
);

195  
	`shªnÚ_¥rštf
(
buf
, "%Îu KB/s\n", 
sdev
->
ho¡_wr™e_bªdwidth
);

196 
	}
}

198 
shªnÚ_ssize_t
 
	$ho¡_wr™e_iİs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

200 
	`upd©e_io_¡©i¡ics
(
sdev
);

201  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
ho¡_wr™e_iİs
);

202 
	}
}

204 
shªnÚ_ssize_t
 
	$ho¡_wr™e_Ï‹ncy_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

206 
	`upd©e_io_¡©i¡ics
(
sdev
);

207  
	`shªnÚ_¥rštf
(
buf
, "%Îu us\n", 
sdev
->
ho¡_wr™e_Ï‹ncy
);

208 
	}
}

210 
shªnÚ_ssize_t
 
	$tÙ®_wr™e_£ùÜs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

212  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
tÙ®_wr™e_£ùÜs
);

213 
	}
}

215 
shªnÚ_ssize_t
 
	$tÙ®_wr™e_bªdwidth_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

217 
	`upd©e_io_¡©i¡ics
(
sdev
);

218  
	`shªnÚ_¥rštf
(
buf
, "%Îu KB/s\n", 
sdev
->
tÙ®_wr™e_bªdwidth
);

219 
	}
}

221 
shªnÚ_ssize_t
 
	$wr™e_am¶if›r_liãtime_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

223 ià(
sdev
->
ho¡_wr™e_£ùÜs
)

224  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
tÙ®_wr™e_£ùÜs
 * 100 / sdev->
ho¡_wr™e_£ùÜs
);

226  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 100);

227 
	}
}

229 
shªnÚ_ssize_t
 
	$wr™e_am¶if›r_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

231 
	`upd©e_io_¡©i¡ics
(
sdev
);

232  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
wr™e_am¶if›r
);

233 
	}
}

235 
shªnÚ_ssize_t
 
	$ho¡_»ad_£ùÜs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

237 
sdev
->
ho¡_»ad_£ùÜs
 = sdev->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_have_»ad_£ùÜs
(sdev);

238  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
ho¡_»ad_£ùÜs
);

239 
	}
}

241 
shªnÚ_ssize_t
 
	$ho¡_»ad_bªdwidth_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

243 
	`upd©e_io_¡©i¡ics
(
sdev
);

244  
	`shªnÚ_¥rštf
(
buf
, "%Îu KB/s\n", 
sdev
->
ho¡_»ad_bªdwidth
);

245 
	}
}

247 
shªnÚ_ssize_t
 
	$h¬dw¬e_v”siÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

249  
	`shªnÚ_¥rštf
(
buf
, "0x%x\n", 
sdev
->
h¬dw¬e_v”siÚ
);

250 
	}
}

252 
shªnÚ_ssize_t
 
	$ecc_çu»_¿‹_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

254  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
ecc_çu»_¿‹_th»shŞd
);

255 
	}
}

257 
shªnÚ_ssize_t
 
	$ecc_çu»_¿‹_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

259 
v®
;

260 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

262 ià(
v®
 >= 0)

263 
sdev
->
ecc_çu»_¿‹_th»shŞd
 = 
v®
;

264  
couÁ
;

265 
	}
}

267 
shªnÚ_ssize_t
 
	$ho¡_»ad_iİs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

269 
	`upd©e_io_¡©i¡ics
(
sdev
);

270  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
ho¡_»ad_iİs
);

271 
	}
}

273 
shªnÚ_ssize_t
 
	$ho¡_»ad_Ï‹ncy_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

275 
	`upd©e_io_¡©i¡ics
(
sdev
);

276  
	`shªnÚ_¥rštf
(
buf
, "%Îu us\n", 
sdev
->
ho¡_»ad_Ï‹ncy
);

277 
	}
}

279 
shªnÚ_ssize_t
 
	$tÙ®_gc_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

281  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
tÙ®_gc_logicbs
);

282 
	}
}

284 
shªnÚ_ssize_t
 
	$tÙ®_wl_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

286  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
tÙ®_wl_logicbs
);

287 
	}
}

289 
shªnÚ_ssize_t
 
	$tÙ®_”r_»cov”_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

291  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
sdev
->
tÙ®_”r_»cov”_logicbs
);

292 
	}
}

294 
shªnÚ_ssize_t
 
	$‹m³¿tu»_št_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

296 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

297  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_št
);

298 
	}
}

300 
shªnÚ_ssize_t
 
	$‹m³¿tu»_št_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

302 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

303  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_št_max
);

304 
	}
}

306 
shªnÚ_ssize_t
 
	$‹m³¿tu»_æash_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

308 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

309  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_æash
);

310 
	}
}

312 
shªnÚ_ssize_t
 
	$‹m³¿tu»_æash_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

314 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

315  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_æash_max
);

316 
	}
}

318 
shªnÚ_ssize_t
 
	$‹m³¿tu»_bßrd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

320 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

321  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_bßrd
);

322 
	}
}

324 
shªnÚ_ssize_t
 
	$‹m³¿tu»_bßrd_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

326 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

327  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_bßrd_max
);

328 
	}
}

330 
shªnÚ_ssize_t
 
	$‹m³¿tu»_w¬nšg_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

332  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_w¬nšg_th»shŞd
);

333 
	}
}

335 
shªnÚ_ssize_t
 
	$‹m³¿tu»_w¬nšg_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

337 
v®
;

338 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

340 ià((
v®
 < 50) || (val > 90))

341  -
EINVAL
;

342 
sdev
->
‹m³¿tu»_w¬nšg_th»shŞd
 = 
v®
;

343  
couÁ
;

344 
	}
}

346 
shªnÚ_ssize_t
 
	$vŞge_št_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

348 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

349  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
vŞge_št
);

350 
	}
}

352 
shªnÚ_ssize_t
 
	$vŞge_št_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

354 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

355  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
vŞge_št_max
);

356 
	}
}

358 
shªnÚ_ssize_t
 
	$vŞge_aux_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

360 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

361  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
vŞge_aux
);

362 
	}
}

364 
shªnÚ_ssize_t
 
	$vŞge_aux_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

366 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

367  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
vŞge_aux_max
);

368 
	}
}

370 
shªnÚ_ssize_t
 
	$ecc_çu»_times_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

372  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
ecc_çu»_times
));

373 
	}
}

376 
shªnÚ_ssize_t
 
	$ecc_¡©i¡ics_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

378 
i
, 
»t
 = 0;

379 
i
 = 0; i <ğ
sdev
->
ecc_cÜ»ùiÚ_pow”
; i++)

380 
»t
 +ğ
	`shªnÚ_¥rštf
(
buf
 +„‘, "%Îu ", 
sdev
->
ecc_¡©i¡ics
[
i
]);

381 
»t
 +ğ
	`shªnÚ_¥rštf
(
buf
 +„et, "\n");

383  
»t
;

384 
	}
}

386 
shªnÚ_ssize_t
 
	$deviû_¡©e_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

388 
sdev
->
¡©e
)

390 
SHN_STATE_DETACHED
:

391  
	`shªnÚ_¥rštf
(
buf
, "¡©e=%d, d‘ached\n", 
sdev
->
¡©e
);

392 
SHN_STATE_ATTACHED
:

393  
	`shªnÚ_¥rštf
(
buf
, "¡©e=%d,‡‰ached\n", 
sdev
->
¡©e
);

394 (
SHN_STATE_DETACHED
 | 
SHN_STATE_ERROR_BIT
):

395 (
SHN_STATE_ATTACHED
 | 
SHN_STATE_ERROR_BIT
):

396  
	`shªnÚ_¥rštf
(
buf
, "¡©e=%d,ƒ¼Ü\n", 
sdev
->
¡©e
);

398  
	`shªnÚ_¥rštf
(
buf
, "¡©e=%d, unknown\n", 
sdev
->
¡©e
);

400 
	}
}

402 
shªnÚ_ssize_t
 
	$acûss_mode_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

404 
sdev
->
acûss_mode
)

406 
SHN_MODE_READWRITE
:

407  
	`shªnÚ_¥rštf
(
buf
, "mode=%d,„—dwr™e\n", 
sdev
->
acûss_mode
);

408 
SHN_MODE_REDUCED_WRITE
:

409  
	`shªnÚ_¥rštf
(
buf
, "mode=%d,„eduûd-wr™e\n", 
sdev
->
acûss_mode
);

410 
SHN_MODE_READONLY
:

411  
	`shªnÚ_¥rštf
(
buf
, "mode=%d,„—dÚly\n", 
sdev
->
acûss_mode
);

413  
	`shªnÚ_¥rštf
(
buf
, "mode=%d, unknown\n", 
sdev
->
acûss_mode
);

415 
	}
}

417 
shªnÚ_ssize_t
 
	$»duûd_wr™e_»asÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

419  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
»duûd_wr™e_»asÚ
);

420 
	}
}

422 
shªnÚ_ssize_t
 
	$»adÚly_»asÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

424  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
»adÚly_»asÚ
);

425 
	}
}

427 
shªnÚ_ssize_t
 
	$mod–_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

429  
	`shªnÚ_¥rštf
(
buf
, "%s\n", 
sdev
->
mod–_id
);

430 
	}
}

432 
shªnÚ_ssize_t
 
	$fœmw¬e_v”siÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

434 ià(
sdev
->
fœmw¬e_v”siÚ
)

435  
	`shªnÚ_¥rštf
(
buf
, "%u.%u.%u\n", (
sdev
->
fœmw¬e_v”siÚ
 & 0x0000ffff) >> 12, ((sdev->firmware_version & 0x0000ffff) >> 8) & 0xf, ((sdev->firmware_version & 0x0000ffff) >> 4) & 0xf);

437  
	`shªnÚ_¥rštf
(
buf
, "3.2.8\n");

438 
	}
}

440 
shªnÚ_ssize_t
 
	$fœmw¬e_bud_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

442  
	`shªnÚ_¥rštf
(
buf
, "%x\n", 
sdev
->
fœmw¬e_g
);

443 
	}
}

445 
shªnÚ_ssize_t
 
	$ıs_üc_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

447  
	`shªnÚ_¥rštf
(
buf
, "0x%08X\n", 
sdev
->
ıs_üc
);

448 
	}
}

450 
shªnÚ_ssize_t
 
	$driv”_v”siÚ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

452 ià(
SHANNON_FIX_VERSION_CODE
)

453  
	`shªnÚ_¥rštf
(
buf
, "%d.%d.%d.%d\n", 
	`SHANNON_VERSION_MAJOR
(
SHANNON_VERSION_CODE
), 
	`SHANNON_VERSION_MINOR
(SHANNON_VERSION_CODE), 
	`SHANNON_VERSION_RELEASE
(SHANNON_VERSION_CODE), 
SHANNON_FIX_VERSION_CODE
);

455  
	`shªnÚ_¥rštf
(
buf
, "%d.%d.%d\n", 
	`SHANNON_VERSION_MAJOR
(
SHANNON_VERSION_CODE
), 
	`SHANNON_VERSION_MINOR
(SHANNON_VERSION_CODE), 
	`SHANNON_VERSION_RELEASE
(SHANNON_VERSION_CODE));

456 
	}
}

458 
shªnÚ_ssize_t
 
	$åga_dÇ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

460  
	`shªnÚ_¥rštf
(
buf
, "%16.16Îx\n", 
sdev
->
dÇ
);

461 
	}
}

463 
shªnÚ_ssize_t
 
	$£rŸl_numb”_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

465  
	`shªnÚ_¥rštf
(
buf
, "%s\n", 
sdev
->
£rviû_g
);

466 
	}
}

468 
shªnÚ_ssize_t
 
	$pm_qos_v®ue_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

470  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
shªnÚ_pm_qos_v®ue
);

471 
	}
}

473 
shªnÚ_ssize_t
 
	$pm_qos_v®ue_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

475 
v®
;

476 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

478 
shªnÚ_pm_qos_v®ue
 = 
v®
;

479  
couÁ
;

480 
	}
}

482 
shªnÚ_ssize_t
 
	$»cov”_¿‹_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

484  
	`shªnÚ_¥rštf
(
buf
, "%d MB/s\n", 
sdev
->
»cov”_¿‹
);

485 
	}
}

487 
shªnÚ_ssize_t
 
	$»cov”_¿‹_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

489 
v®
;

490 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

492 ià((
v®
 < 50) || (val > 500))

493  -
EINVAL
;

494 
sdev
->
»cov”_¿‹
 = 
v®
;

495  
couÁ
;

496 
	}
}

498 
shªnÚ_ssize_t
 
	$hÙ_block_»şaim_´iÜ™y_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

500  
	`shªnÚ_¥rštf
(
buf
, "%d (NÜm® i 100)\n", 
sdev
->
hÙ_block_»şaim_´iÜ™y
);

501 
	}
}

503 
shªnÚ_ssize_t
 
	$hÙ_block_»şaim_´iÜ™y_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

505 
v®
;

506 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

508 ià((
v®
 < 50) || (val > 150))

509  -
EINVAL
;

510 
sdev
->
hÙ_block_»şaim_´iÜ™y
 = 
v®
;

511  
couÁ
;

512 
	}
}

514 
shªnÚ_ssize_t
 
	$su¥icious_bad_lun_šdiÿtÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

516  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
su¥icious_bad_lun_šdiÿtÜ
);

517 
	}
}

519 
shªnÚ_ssize_t
 
	$su¥icious_bad_lun_šdiÿtÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

521 
v®
;

522 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

524 ià((
v®
 < 1è|| (v® > 
sdev
->
sb_couÁ
))

525  -
EINVAL
;

526 
sdev
->
su¥icious_bad_lun_šdiÿtÜ
 = 
v®
;

527  
couÁ
;

528 
	}
}

530 
shªnÚ_ssize_t
 
	$ç¡_»ad_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

532  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
ç¡_»ad_’abË
);

533 
	}
}

535 
shªnÚ_ssize_t
 
	$ç¡_»ad_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

537 
v®
;

538 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

540 ià(!(
sdev
->
mbr
.
ã©u»_æags
 & 
FAST_READ_ENABLE
)) {

541 
	`shªnÚ_”r
("This device don't support fast„ead.\n");

542  -
EINVAL
;

545 ià(
v®
 == 0)

546 
sdev
->
ç¡_»ad_’abË
 = 0;

548 
sdev
->
ç¡_»ad_’abË
 = 1;

550  
couÁ
;

551 
	}
}

553 
shªnÚ_debug_Ëv–
;

554 
shªnÚ_ssize_t
 
	$debug_Ëv–_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

556  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
shªnÚ_debug_Ëv–
);

557 
	}
}

559 
shªnÚ_ssize_t
 
	$debug_Ëv–_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

561 
v®
;

562 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

564 ià((
v®
 < 0) || (val > 4))

565  -
EINVAL
;

566 
shªnÚ_debug_Ëv–
 = 
v®
;

567  
couÁ
;

568 
	}
}

570 
shªnÚ_bufãr_wr™e
;

571 
shªnÚ_ssize_t
 
	$shªnÚ_bufãr_wr™e_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

573  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
shªnÚ_bufãr_wr™e
);

574 
	}
}

576 
shªnÚ_ssize_t
 
	$shªnÚ_bufãr_wr™e_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

578 
v®
;

579 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

581 ià((
v®
 < 0) || (val > 1))

582  -
EINVAL
;

583 
shªnÚ_bufãr_wr™e
 = 
v®
;

584  
couÁ
;

585 
	}
}

587 
shªnÚ_pŞl_times
;

588 
shªnÚ_ssize_t
 
	$shªnÚ_pŞl_times_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

590  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
shªnÚ_pŞl_times
);

591 
	}
}

593 
shªnÚ_ssize_t
 
	$shªnÚ_pŞl_times_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

595 
v®
;

596 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

598 ià((
v®
 < 2) || (val > 8))

599  -
EINVAL
;

600 
shªnÚ_pŞl_times
 = 
v®
;

601  
couÁ
;

602 
	}
}

604 
shªnÚ_ssize_t
 
	$»ad_”r_msg_Ëv–_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

606  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
»ad_”r_msg_Ëv–
);

607 
	}
}

609 
shªnÚ_ssize_t
 
	$»ad_”r_msg_Ëv–_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

611 
v®
;

612 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

614 ià((
v®
 < 0) || (val > 10))

615  -
EINVAL
;

616 
sdev
->
»ad_”r_msg_Ëv–
 = 
v®
;

617  
couÁ
;

618 
	}
}

620 
wl_debug
;

621 
shªnÚ_ssize_t
 
	$wl_debug_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

623  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
wl_debug
);

624 
	}
}

626 
shªnÚ_ssize_t
 
	$wl_debug_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

628 
v®
;

629 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

631 ià((
v®
 < 0) || (val > 4))

632  -
EINVAL
;

633 
	`shªnÚ_log
("%s: s‘ wl_debugØ%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
v®
);

634 
wl_debug
 = 
v®
;

635  
couÁ
;

636 
	}
}

638 
shªnÚ_ssize_t
 
	$”r_check_debug_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

640  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
”r_check_debug
);

641 
	}
}

643 
shªnÚ_ssize_t
 
	$”r_check_debug_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

645 
v®
;

646 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

648 ià((
v®
 < 0) || (val > 4))

649  -
EINVAL
;

650 
	`shªnÚ_log
("%s: s‘ƒ¼_check_debugØ%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
v®
);

651 
sdev
->
”r_check_debug
 = 
v®
;

652  
couÁ
;

653 
	}
}

655 
shªnÚ_ssize_t
 
	$»ad_di¡urb_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

657  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
»ad_di¡urb_th»shŞd
);

658 
	}
}

660 
shªnÚ_ssize_t
 
	$»ad_di¡urb_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

662 
v®
;

663 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

665 ià((
v®
 < 10000) || (val > 100000000UL))

666  -
EINVAL
;

667 
	`shªnÚ_log
("%s: s‘„—d_di¡urb_th»shŞdØ%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
v®
);

668 
sdev
->
»ad_di¡urb_th»shŞd
 = 
v®
;

669  
couÁ
;

670 
	}
}

672 
shªnÚ_ssize_t
 
	$İ’_block_»ad_di¡urb_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

674  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
İ’_block_»ad_di¡urb_th»shŞd
);

675 
	}
}

677 
shªnÚ_ssize_t
 
	$İ’_block_»ad_di¡urb_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

679 
v®
;

680 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

682 ià((
v®
 < 1000) || (val > 50000000UL))

683  -
EINVAL
;

684 
	`shªnÚ_log
("%s: s‘ o³n_block_»ad_di¡urb_th»shŞdØ%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
v®
);

685 
sdev
->
İ’_block_»ad_di¡urb_th»shŞd
 = 
v®
;

686  
couÁ
;

687 
	}
}

689 
shªnÚ_ssize_t
 
	$wl_tim”_š‹rv®_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

691  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
wl_tim”_š‹rv®
);

692 
	}
}

694 
shªnÚ_ssize_t
 
	$wl_tim”_š‹rv®_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

696 
v®
;

697 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

699 ià((
v®
 < 10) || (val > 36000UL))

700  -
EINVAL
;

701 
	`shªnÚ_log
("%s: s‘ wl_tim”_š‹rv®Ø%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
v®
);

702 
sdev
->
wl_tim”_š‹rv®
 = 
v®
;

703 ià((
sdev
->
sdisk
.
ex™
 =ğ0è&& (sdev->
¡İ_®l
 =ğ0è&& (sdev->
acûss_mode
 !ğ
SHN_MODE_READONLY
))

704 
	`shªnÚ_mod_tim”
(&
sdev
->
wl_tim”
, 
	`g‘_jiff›s
(è+ sdev->
wl_tim”_š‹rv®
 * 
	`g‘_HZ
());

705  
couÁ
;

706 
	}
}

708 
shªnÚ_ssize_t
 
	$max_š_wl_logicbs_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

710  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
max_š_wl_logicbs
);

711 
	}
}

713 
shªnÚ_ssize_t
 
	$max_š_wl_logicbs_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

715 
v®
;

716 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

718 ià((
v®
 < 0) || (val > 1000UL))

719  -
EINVAL
;

720 
	`shªnÚ_log
("%s: s‘ max_š_wl_logicb tØ%d.\n", 
sdev
->
sdisk
.
disk_Çme
, 
v®
);

721 
sdev
->
max_š_wl_logicbs
 = 
v®
;

722 
sdev
->
cu¼’t_max_š_wl_logicbs
 = 
v®
;

723  
couÁ
;

724 
	}
}

726 
shªnÚ_ssize_t
 
	$wl_max_”a£_couÁ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

728  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
wl_max_”a£_couÁ
);

729 
	}
}

731 
shªnÚ_ssize_t
 
	$wl_max_”a£_couÁ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

733 
v®
;

734 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

736 ià((
v®
 < 1000) || (val > 20000))

737  -
EINVAL
;

738 
sdev
->
wl_max_”a£_couÁ
 = 
v®
;

739  
couÁ
;

740 
	}
}

742 
shªnÚ_ssize_t
 
	$wl_”a£_couÁ_d–_0_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

744  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
wl_”a£_couÁ_d–
[0]);

745 
	}
}

747 
shªnÚ_ssize_t
 
	$wl_”a£_couÁ_d–_0_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

749 
v®
;

750 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

752 ià((
v®
 <ğ
sdev
->
wl_”a£_couÁ_d–
[1]) || (val > 20000))

753  -
EINVAL
;

754 
sdev
->
wl_”a£_couÁ_d–
[0] = 
v®
;

755  
couÁ
;

756 
	}
}

758 
shªnÚ_ssize_t
 
	$wl_”a£_couÁ_d–_1_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

760  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
wl_”a£_couÁ_d–
[1]);

761 
	}
}

763 
shªnÚ_ssize_t
 
	$wl_”a£_couÁ_d–_1_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

765 
v®
;

766 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

768 ià((
v®
 < 2è|| (v® >ğ
sdev
->
wl_”a£_couÁ_d–
[0]))

769  -
EINVAL
;

770 
sdev
->
wl_”a£_couÁ_d–
[1] = 
v®
;

771  
couÁ
;

772 
	}
}

774 #ifdeà
SHANNON_USE_WRITE_BUFFER


775 
shªnÚ_ssize_t
 
	$fl_chunk_tim”_expœe_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

777  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
fl_chunk_tim”_expœe
);

778 
	}
}

780 
shªnÚ_ssize_t
 
	$fl_chunk_tim”_expœe_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

782 
v®
;

783 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

785 ià((
v®
 < 1) || (val > 60000))

786  -
EINVAL
;

787 
sdev
->
fl_chunk_tim”_expœe
 = 
v®
;

788  
couÁ
;

789 
	}
}

791 
shªnÚ_ssize_t
 
	$fl_chunk_tim”_expœe_show
(
shªnÚ_dev
 *
sdev
, *
buf
è{  0; 
	}
}

792 
shªnÚ_ssize_t
 
	$fl_chunk_tim”_expœe_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
è{  0; 
	}
}

795 
shªnÚ_ssize_t
 
	$´št_Ï‹ncy_š‹rv®_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

797  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´št_Ï‹ncy_š‹rv®
);

798 
	}
}

800 
shªnÚ_ssize_t
 
	$´št_Ï‹ncy_š‹rv®_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

802 
v®
;

803 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

805 ià((
v®
 < 0) || (val > 86400))

806  -
EINVAL
;

807 ià(
sdev
->
sdisk
.
´št_Ï‹ncy_š‹rv®
 !ğ
v®
) {

808 
sdev
->
sdisk
.
´št_Ï‹ncy_š‹rv®
 = 
v®
;

809 ià(
sdev
->
sdisk
.
´št_Ï‹ncy_š‹rv®
)

810 
	`¡¬t_´št_Ï‹ncy_tim”
(&
sdev
->
sdisk
);

812 
	`¡İ_´št_Ï‹ncy_tim”
(&
sdev
->
sdisk
);

814 
	`shªnÚ_šfo
("modify…ršt_Ï‹ncy_š‹rv®Ø%d.\n", 
v®
);

815  
couÁ
;

816 
	}
}

818 
shªnÚ_ssize_t
 
	$h¬d_queue_lim™_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

820  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
h¬d_queue_lim™
);

821 
	}
}

823 
shªnÚ_ssize_t
 
	$h¬d_queue_lim™_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

825 
v®
;

826 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

828 ià((
v®
 < 0) || (val > 10000))

829  -
EINVAL
;

830 
sdev
->
h¬d_queue_lim™
 = 
v®
;

831 
	`shªnÚ_šfo
("%s, modify h¬d_queue_lim™Ø%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

832  
couÁ
;

833 
	}
}

835 
shªnÚ_ssize_t
 
	$cmd_queue_wr™es_lim™_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

837  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
cmd_queue_wr™es_lim™
);

838 
	}
}

840 
shªnÚ_ssize_t
 
	$cmd_queue_wr™es_lim™_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

842 
v®
;

843 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

845 ià(
v®
 <ğ((
sdev
->
max_luns_š_group
 * sdev->
logicbs_š_chunk
) >> 1)) {

846 
	`shªnÚ_”r
("cmd_queue_wr™es_lim™ mu¡ bg»©”hª %d.\n", (
sdev
->
max_luns_š_group
 * sdev->
logicbs_š_chunk
) >> 1);

847  -
EINVAL
;

849 ià(
v®
 > 1000000)

850  -
EINVAL
;

851 
sdev
->
cmd_queue_wr™es_lim™
 = 
v®
;

852 
	`shªnÚ_šfo
("%s, modify cmd_queue_wr™es_lim™Ø%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

853  
couÁ
;

854 
	}
}

856 
shªnÚ_ssize_t
 
	$£rviû_g_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

858  
	`shªnÚ_¥rštf
(
buf
, "%s\n", 
sdev
->
£rviû_g
);

859 
	}
}

861 
shªnÚ_ssize_t
 
	$udid_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

863  
	`shªnÚ_¥rštf
(
buf
, "%s\n", 
sdev
->
udid
);

864 
	}
}

866 
shªnÚ_ssize_t
 
	$»äesh_mbr_couÁ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

868  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
	`shªnÚ_©omic_»ad
(&
sdev
->
»äesh_mbr_couÁ
));

869 
	}
}

871 
shªnÚ_ssize_t
 
	$©omic_wr™e_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

873  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
©omic_wr™e
 ? 1 : 0);

874 
	}
}

876 
shªnÚ_ssize_t
 
	$´iÜ™ize_wr™e_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

878  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
´iÜ™ize_wr™e
 ? 1 : 0);

879 
	}
}

881 
shªnÚ_ssize_t
 
	$nÚ®igÃd_bios_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

883  
	`shªnÚ_¥rštf
(
buf
, "%lu\n", 
sdev
->
sdisk
.
nÚ®igÃd_bios
);

884 
	}
}

887 
shªnÚ_ssize_t
 
	$Çme_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

889  
	`shªnÚ_¥rštf
(
buf
, "shªnÚ-%s\n", 
sdev
->
sdisk
.
disk_Çme
);

890 
	}
}

892 
shªnÚ_ssize_t
 
	$‹mp1_šput_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

894 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

895  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_bßrd
 * 1000);

896 
	}
}

898 
shªnÚ_ssize_t
 
	$‹mp1_Ïb–_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

900  
	`shªnÚ_¥rštf
(
buf
, "Board\n");

901 
	}
}

903 
shªnÚ_ssize_t
 
	$‹mp1_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

905  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
TEMP_BOARD_THRESHOLD
 * 1000);

906 
	}
}

908 
shªnÚ_ssize_t
 
	$‹mp1_ü™_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

910  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
TEMP_BOARD_CRITICAL_THRESHOLD
 * 1000);

911 
	}
}

913 
shªnÚ_ssize_t
 
	$‹mp2_šput_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

915 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

916  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_æash
 * 1000);

917 
	}
}

919 
shªnÚ_ssize_t
 
	$‹mp2_Ïb–_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

921  
	`shªnÚ_¥rštf
(
buf
, "Flash\n");

922 
	}
}

924 
shªnÚ_ssize_t
 
	$‹mp2_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

926  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
TEMP_AUX1_THRESHOLD
 * 1000);

927 
	}
}

929 
shªnÚ_ssize_t
 
	$‹mp2_ü™_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

931  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
TEMP_AUX1_CRITICAL_THRESHOLD
 * 1000);

932 
	}
}

934 
shªnÚ_ssize_t
 
	$‹mp3_šput_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

936 
	`upd©e_vŞge_‹m³¿tu»
(
sdev
);

937  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
‹m³¿tu»_št
 * 1000);

938 
	}
}

940 
shªnÚ_ssize_t
 
	$‹mp3_Ïb–_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

942  
	`shªnÚ_¥rštf
(
buf
, "Controller\n");

943 
	}
}

945 
shªnÚ_ssize_t
 
	$‹mp3_max_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

947  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
TEMP_INNER_THRESHOLD
 * 1000);

948 
	}
}

950 
shªnÚ_ssize_t
 
	$‹mp3_ü™_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

952  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
TEMP_INNER_CRITICAL_THRESHOLD
 * 1000);

953 
	}
}

956 
shªnÚ_ssize_t
 
	$v’dÜ_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

958  
	`shªnÚ_¥rštf
(
buf
, "%0#4.4x\n", 
sdev
->
pci_šfo
.
v’dÜ_id
);

959 
	}
}

961 
shªnÚ_ssize_t
 
	$deviû_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

963  
	`shªnÚ_¥rštf
(
buf
, "%0#4.4x\n", 
sdev
->
pci_šfo
.
deviû_id
);

964 
	}
}

966 
shªnÚ_ssize_t
 
	$subsy¡em_v’dÜ_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

968  
	`shªnÚ_¥rštf
(
buf
, "%0#4.4x\n", 
sdev
->
pci_šfo
.
subsy¡em_v’dÜ_id
);

969 
	}
}

971 
shªnÚ_ssize_t
 
	$subsy¡em_deviû_id_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

973  
	`shªnÚ_¥rštf
(
buf
, "%0#4.4x\n", 
sdev
->
pci_šfo
.
subsy¡em_deviû_id
);

974 
	}
}

976 
shªnÚ_ssize_t
 
	$pci_add»ss_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

978  
	`shªnÚ_¥rštf
(
buf
, "%02.2x:%02.2x:%01.1x\n", 
sdev
->
pci_šfo
.
pci_bus_numb”
, sdev->pci_šfo.
pci_¦Ù_numb”
, sdev->pci_šfo.
pci_func_numb”
);

979 
	}
}

981 
shªnÚ_ssize_t
 
	$pci_şass_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

983  
	`shªnÚ_¥rštf
(
buf
, "%0#6.6x\n", 
sdev
->
pci_šfo
.
şass
);

984 
	}
}

986 
shªnÚ_ssize_t
 
	$lškÿp_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

988  
	`shªnÚ_¥rštf
(
buf
, "% x %d\n", 
	`lšk¥“d_¡r
(
sdev
->
pci_šfo
.
Êkÿp
 & 0xf), (sdev->pci_info.lnkcap >> 4) & 0x3f);

989 
	}
}

991 
shªnÚ_ssize_t
 
	$lšk¡a_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

993  
	`shªnÚ_¥rštf
(
buf
, "% x %d\n", 
	`lšk¥“d_¡r
(
sdev
->
pci_šfo
.
Êk¡a
 & 0xf), (sdev->pci_info.lnksta >> 4) & 0x3f);

994 
	}
}

996 
shªnÚ_ssize_t
 
	$³riod_»ad_³riod_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

998  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
³riod_»ad
.
³riod
);

999 
	}
}

1001 
shªnÚ_ssize_t
 
	$³riod_»ad_³riod_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1003 
v®
;

1004 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1006 ià(
v®
 < 0)

1007  -
EINVAL
;

1008 
sdev
->
³riod_»ad
.
³riod
 = 
v®
;

1009 
	`shªnÚ_šfo
("%s, modify…”iod_»ad…”iodØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1010 ià(
sdev
->
³riod_»ad
.
³riod
 > 0) {

1011 ià(
	`³riod_»ad_’abË
(
sdev
)) {

1012 
	`shªnÚ_”r
("Enable…eriod„ead failed.…eriod_read_interval=%d,…eriod_read_ppa=%d.\n", \

1013 
sdev
->
³riod_»ad
.
_š‹rv®
, sdev->³riod_»ad.
µa
);

1016 
	`³riod_»ad_di§bË
(
sdev
);

1018  
couÁ
;

1019 
	}
}

1021 
shªnÚ_ssize_t
 
	$³riod_»ad_µa_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1023  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
sdev
->
³riod_»ad
.
µa
);

1024 
	}
}

1026 
shªnÚ_ssize_t
 
	$³riod_»ad_µa_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1028 
v®
;

1029 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1031 ià(
v®
 >ğ(
sdev
->
·ges_š_eblock
 * sdev->
¶ªes
))

1032  -
EINVAL
;

1033 
sdev
->
³riod_»ad
.
µa
 = 
v®
;

1034 
	`shªnÚ_šfo
("%s, modify…”iod_»ad_µ¨tØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1035 ià((
sdev
->
³riod_»ad
.
µa
 >ğ0è&& (sdev->³riod_»ad.µ¨< sdev->
·ges_š_eblock
 * sdev->
¶ªes
)) {

1036 ià(
	`³riod_»ad_’abË
(
sdev
))

1037 
	`shªnÚ_”r
("Enable…eriod„ead failed.…eriod_read_interval=%d,…eriod_read_ppa=%d.\n", \

1038 
sdev
->
³riod_»ad
.
_š‹rv®
, sdev->³riod_»ad.
µa
);

1040 
	`³riod_»ad_di§bË
(
sdev
);

1042  
couÁ
;

1043 
	}
}

1045 
shªnÚ_ssize_t
 
	$sw™ch_miüocode_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1047 
i
;

1049 
i
 = 0; i < 
MICROCODE_ARRAY_SIZE
; i++) {

1050 ià(
sdev
->
miüocode_¬¿y
[
i
].
¡©e
 & 
MICROCODE_IN_USE_MASK
)

1051  
	`shªnÚ_¥rštf
(
buf
, "šdex: %u.\n", 
i
);

1053  
	`shªnÚ_¥rštf
(
buf
, "index: -1.\n");

1054 
	}
}

1056 
shªnÚ_ssize_t
 
	$sw™ch_miüocode_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1058 
v®
;

1059 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1061 ià((
v®
 < 0è|| (v® >ğ
MICROCODE_ARRAY_SIZE
))

1062  -
EINVAL
;

1063 ià(
sdev
->
miüocode_¬¿y
[
v®
].
¡©e
 & 
MICROCODE_VALID_MASK
) {

1064 ià(!(
sdev
->
miüocode_¬¿y
[
v®
].
¡©e
 & 
MICROCODE_IN_USE_MASK
)) {

1065 
sdev
->
cu¼’t_miüocode_šdex
 = 
v®
;

1066 ià(
	`should_upd©e_miüocode
(
sdev
))

1067 
	`shªnÚ_queue_wÜk
(
sdev
->
shªnÚ_wq
, &sdev->
upd©e_miüocode_wÜk
);

1070  
couÁ
;

1071 
	}
}

1074 
shªnÚ_Çme¥aû
 *
	$to_shªnÚ_Çme¥aû
(
shªnÚ_kobjeù_t
 *
skobj
)

1076  
	`cÚš”_of
(
skobj
, 
shªnÚ_Çme¥aû
, 
sysfs_kobj
);

1077 
	}
}

1079 *
	$to_shªnÚ_disk_ns
(
shªnÚ_kobjeù_t
 *
skobj
)

1081 
shªnÚ_Çme¥aû
 *
ns
 = 
	`cÚš”_of
(
skobj
, shªnÚ_Çme¥aû, 
sysfs_kobj
);

1082  
ns
->
sdisk
.
gd
;

1083 
	}
}

1085 *
	$to_ns_Çme
(
shªnÚ_kobjeù_t
 *
skobj
)

1087 
shªnÚ_Çme¥aû
 *
ns
 = 
	`cÚš”_of
(
skobj
, shªnÚ_Çme¥aû, 
sysfs_kobj
);

1088  
ns
->
sdisk
.
disk_Çme
;

1089 
	}
}

1091 *
	$ns_to_poŞ_misc
(
shªnÚ_kobjeù_t
 *
skobj
)

1093 
shªnÚ_Çme¥aû
 *
ns
 = 
	`cÚš”_of
(
skobj
, shªnÚ_Çme¥aû, 
sysfs_kobj
);

1094  &
ns
->
poŞ
->
misc
;

1095 
	}
}

1097 
shªnÚ_ssize_t
 
	$ho¡_wr™e_£ùÜs_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1099  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
ns
->
ho¡_wr™e_£ùÜs_hi¡Üy
 + 
	`shªnÚ_wr™e_£ùÜs
Òs->
sdisk
.
gd
));

1100 
	}
}

1102 
shªnÚ_ssize_t
 
	$ho¡_»ad_£ùÜs_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1104  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
ns
->
ho¡_»ad_£ùÜs_hi¡Üy
 + 
	`shªnÚ_»ad_£ùÜs
Òs->
sdisk
.
gd
));

1105 
	}
}

1107 
shªnÚ_ssize_t
 
	$v®id_£ùÜs_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1109  
	`shªnÚ_¥rštf
(
buf
, "%Îu\n", 
	`g‘_sdisk_v®id_logicbs
(&
ns
->
sdisk
è<< (ns->
logicb_shiá
 - 9));

1110 
	}
}

1112 
shªnÚ_ssize_t
 
	$³ndšg_bios_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1114  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
	`shªnÚ_©omic_»ad
(&
ns
->
sdisk
.
³ndšg_bios
));

1115 
	}
}

1117 
shªnÚ_ssize_t
 
	$nÚ®igÃd_bios_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1119  
	`shªnÚ_¥rštf
(
buf
, "%lu\n", 
ns
->
sdisk
.
nÚ®igÃd_bios
);

1120 
	}
}

1122 
shªnÚ_ssize_t
 
	$£q_num_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1124  
	`shªnÚ_¥rštf
(
buf
, "%u\n", 
ns
->
£q_num
);

1125 
	}
}

1127 
shªnÚ_ssize_t
 
	$rmw_li¡_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1129 
shªnÚ_disk
 *
sdisk
 = &
ns
->sdisk;

1130 
lba_li¡
 *
p
;

1131 
i
, 
j
, 
»t
 = 0;

1133 
i
 = 0; i < 2; i++) {

1134 
j
 = 0; j < 
RMW_LIST_COUNT
; j++) {

1135 
	`shªnÚ_¥š_lock_bh
(&
sdisk
->
rmw_li¡_lock
[
i
][
j
]);

1136 
»t
 +ğ
	`shªnÚ_¥rštf
(
buf
 +„‘, "%s%2d:> ", 
i
?"wr™e":"»ad", 
j
);

1137 
	`shªnÚ_li¡_fÜ_—ch_’Œy
(
p
, &
sdisk
->
rmw_li¡
[
i
][
j
], 
li¡
) {

1138 
»t
 +ğ
	`shªnÚ_¥rštf
(
buf
 +„‘, " %d=%d.", 
p
->
lba
,…->
¡©us
);

1140 
»t
 +ğ
	`shªnÚ_¥rštf
(
buf
 +„et, "\n");

1141 
	`shªnÚ_¥š_uÆock_bh
(&
sdisk
->
rmw_li¡_lock
[
i
][
j
]);

1143 
»t
 +ğ
	`shªnÚ_¥rštf
(
buf
 +„et, "----------------------------------\n");

1145  
»t
;

1146 
	}
}

1148 
shªnÚ_ssize_t
 
	$´št_Ï‹ncy_š‹rv®_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1150  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
ns
->
sdisk
.
´št_Ï‹ncy_š‹rv®
);

1151 
	}
}

1153 
shªnÚ_ssize_t
 
	$´št_Ï‹ncy_š‹rv®_ns_¡Üe
(
shªnÚ_Çme¥aû
 *
ns
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1155 
v®
;

1156 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1158 ià((
v®
 < 0) || (val > 86400))

1159  -
EINVAL
;

1160 ià(
ns
->
sdisk
.
´št_Ï‹ncy_š‹rv®
 !ğ
v®
) {

1161 
ns
->
sdisk
.
´št_Ï‹ncy_š‹rv®
 = 
v®
;

1162 ià(
ns
->
sdisk
.
´št_Ï‹ncy_š‹rv®
)

1163 
	`¡¬t_´št_Ï‹ncy_tim”
(&
ns
->
sdisk
);

1165 
	`¡İ_´št_Ï‹ncy_tim”
(&
ns
->
sdisk
);

1167 
	`shªnÚ_šfo
("modify‚ame¥aû %d…ršt_Ï‹ncy_š‹rv®Ø%d.\n", 
ns
->
idx
, 
v®
);

1168  
couÁ
;

1169 
	}
}

1171 
shªnÚ_ssize_t
 
	$u£r_defšed_Çme_ns_show
(
shªnÚ_Çme¥aû
 *
ns
, *
buf
)

1173  
	`shªnÚ_¥rštf
(
buf
, "%s\n", 
ns
->
d©a
->
Çme
);

1174 
	}
}

1178 
shªnÚ_poŞ
 *
	$to_shªnÚ_poŞ
(
shªnÚ_kobjeù_t
 *
skobj
)

1180 
shªnÚ_poŞ
 *
¥
 = 
	`cÚš”_of
(
skobj
, shªnÚ_poŞ, 
sysfs_kobj
);

1181  
¥
;

1182 
	}
}

1184 *
	$to_poŞ_misc
(
shªnÚ_kobjeù_t
 *
skobj
)

1186 
shªnÚ_poŞ
 *
¥
 = 
	`cÚš”_of
(
skobj
, shªnÚ_poŞ, 
sysfs_kobj
);

1187  &
¥
->
misc
;

1188 
	}
}

1190 
shªnÚ_ssize_t
 
	$u£d_¥aû_³rûÁage_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
)

1192  
	`shªnÚ_¥rštf
(
buf
, "%llu\n",

1193 100 * (
	`shªnÚ_©omic64_»ad
(&
¥oŞ
->
u£d_logicbs
) << 3)

1194 / 
¥oŞ
->
avaabË_ÿ·c™y
);

1195 
	}
}

1197 
shªnÚ_ssize_t
 
	$physiÿl_ÿ·c™y_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
)

1199 
	`ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
¥oŞ
);

1200  
	`shªnÚ_¥rštf
(
buf
, "%Îu seùÜs\n", 
¥oŞ
->
physiÿl_ÿ·c™y
);

1201 
	}
}

1203 
shªnÚ_ssize_t
 
	$ov”´ovisiÚ_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
)

1205 
	`ÿlcuÏ‹_poŞ_ov”´ovisiÚ
(
¥oŞ
);

1206  
	`shªnÚ_¥rštf
(
buf
, "%d.%d\n", 
¥oŞ
->
ov”´ovisiÚ
/100, spool->overprovision % 100);

1207 
	}
}

1209 
shªnÚ_ssize_t
 
	$ov”´ovisiÚ_poŞ_¡Üe
(
shªnÚ_poŞ
 *
¥oŞ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1211 
v®
;

1212 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1213 ià(
v®
 < 15 || val > 30)

1214  -
EINVAL
;

1215 
	`£t_poŞ_ov”´ovisiÚ
(
¥oŞ
, 
v®
);

1216  
couÁ
;

1217 
	}
}

1219 
shªnÚ_ssize_t
 
	$h¬d_queue_lim™_poŞ_show
(
shªnÚ_poŞ
 *
¥oŞ
, *
buf
)

1221  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
¥oŞ
->
h¬d_queue_lim™
);

1222 
	}
}

1224 
shªnÚ_ssize_t
 
	$h¬d_queue_lim™_poŞ_¡Üe
(
shªnÚ_poŞ
 *
¥oŞ
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1226 
v®
;

1227 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1229 ià((
v®
 < 0) || (val > 10000))

1230  -
EINVAL
;

1231 ià(
	`shªnÚ_©omic_»ad
(&
¥oŞ
->
high_´iÜ™y_ns_couÁ
) == 0) {

1232 
	`shªnÚ_šfo
("%s,‚Øhigh…riÜ™y vŞumexi¡s!\n", 
¥oŞ
->
cdev_Çme
);

1233  -
EINVAL
;

1235 
	`£t_poŞ_h¬d_queue_lim™
(
¥oŞ
, 
v®
);

1236 
	`shªnÚ_šfo
("%s, modify h¬d_queue_lim™Ø%d.\n", 
¥oŞ
->
cdev_Çme
, 
v®
);

1237  
couÁ
;

1238 
	}
}

1240 
shªnÚ_ssize_t
 
	$upd©e_œq_d–ay_š‹rv®_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1242  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_š‹rv®
);

1243 
	}
}

1245 
shªnÚ_ssize_t
 
	$upd©e_œq_d–ay_š‹rv®_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1247 
v®
;

1248 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1249 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1251 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1252 
	`shªnÚ_šfo
("%s, upd©e_œq_d–ay_š‹rv® oÆy suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1253  -
EINVAL
;

1255 ià(
v®
 < 0)

1256  -
EINVAL
;

1257 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1258 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1259 
	`shªnÚ_m¦“p
(2);

1260 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1261 
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_š‹rv®
 = 
v®
;

1262 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1263 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1264 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1265 
	`shªnÚ_šfo
("%s, modify upd©e_œq_d–ay_š‹rv®Ø%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1266  
couÁ
;

1267 
	}
}

1269 
shªnÚ_ssize_t
 
	$dyÇmic_œq_d–ay_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1271  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
);

1272 
	}
}

1274 
shªnÚ_ssize_t
 
	$dyÇmic_œq_d–ay_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1276 
v®
;

1277 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1279 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1280 
	`shªnÚ_šfo
("%s, dyÇmic_œq_d–ay oÆy suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1281  -
EINVAL
;

1283 ià(
v®
 < 0)

1284  -
EINVAL
;

1285 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1286 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1287 
	`shªnÚ_m¦“p
(2);

1288 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1289 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
v®
;

1290 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1291 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1292 
	`shªnÚ_šfo
("%s, modify dyÇmic_œq_d–ayØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1293  
couÁ
;

1294 
	}
}

1296 
shªnÚ_ssize_t
 
	$œq_d–ay_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1298  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
çùÜ
);

1299 
	}
}

1301 
shªnÚ_ssize_t
 
	$œq_d–ay_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1303 
v®
;

1304 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1305 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1307 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1308 
	`shªnÚ_šfo
("%s, irq_d–ay_çcÙ¸Úly suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1309  -
EINVAL
;

1311 ià(
v®
 < 0)

1312  -
EINVAL
;

1313 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1314 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1315 
	`shªnÚ_m¦“p
(2);

1316 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1317 
sdev
->
œq_d–ay
.
çùÜ
 = 
v®
;

1318 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1319 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1320 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1321 
	`shªnÚ_šfo
("%s, modify dyÇmic_œq_d–ayØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1322  
couÁ
;

1323 
	}
}

1325 
shªnÚ_ssize_t
 
	$»ad_Ï‹ncy_divide_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1327  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
»ad_Ï‹ncy_divide
);

1328 
	}
}

1330 
shªnÚ_ssize_t
 
	$»ad_Ï‹ncy_divide_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1332 
v®
;

1333 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1334 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1336 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1337 
	`shªnÚ_šfo
("%s,„—d_Ï‹ncy_dividÚly suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1338  -
EINVAL
;

1340 ià(
v®
 <= 0)

1341  -
EINVAL
;

1342 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1343 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1344 
	`shªnÚ_m¦“p
(2);

1345 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1346 
sdev
->
œq_d–ay
.
»ad_Ï‹ncy_divide
 = 
v®
;

1347 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1348 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1349 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1350 
	`shªnÚ_šfo
("%s, modify„—d_Ï‹ncy_dividtØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1351  
couÁ
;

1352 
	}
}

1354 
shªnÚ_ssize_t
 
	$wr™e_Ï‹ncy_divide_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1356  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
wr™e_Ï‹ncy_divide
);

1357 
	}
}

1359 
shªnÚ_ssize_t
 
	$wr™e_Ï‹ncy_divide_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1361 
v®
;

1362 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1363 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1365 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1366 
	`shªnÚ_šfo
("%s, wr™e_Ï‹ncy_devidÚly suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1367  -
EINVAL
;

1369 ià(
v®
 <= 0)

1370  -
EINVAL
;

1371 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1372 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1373 
	`shªnÚ_m¦“p
(2);

1374 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1375 
sdev
->
œq_d–ay
.
wr™e_Ï‹ncy_divide
 = 
v®
;

1376 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1377 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1378 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1379 
	`shªnÚ_šfo
("%s, modify wr™e_Ï‹ncy_dividtØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1380  
couÁ
;

1381 
	}
}

1383 
shªnÚ_ssize_t
 
	$wr™e_th»shŞd_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1385  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
wr™e_th»shŞd_çùÜ
);

1386 
	}
}

1388 
shªnÚ_ssize_t
 
	$wr™e_th»shŞd_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1390 
v®
;

1391 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1392 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1394 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1395 
	`shªnÚ_šfo
("%s, wr™e_th»shŞd_çùÜ oÆy suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1396  -
EINVAL
;

1398 ià(
v®
 < 0)

1399  -
EINVAL
;

1400 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1401 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1402 
	`shªnÚ_m¦“p
(2);

1403 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1404 
sdev
->
œq_d–ay
.
wr™e_th»shŞd_çùÜ
 = 
v®
;

1405 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1406 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1407 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1408 
	`shªnÚ_šfo
("%s, modify wr™e_th»shŞd_çùÜØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1409  
couÁ
;

1410 
	}
}

1412 
shªnÚ_ssize_t
 
	$»ad_th»shŞd_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1414  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
»ad_th»shŞd_çùÜ
);

1415 
	}
}

1417 
shªnÚ_ssize_t
 
	$»ad_th»shŞd_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1419 
v®
;

1420 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1421 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1423 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1424 
	`shªnÚ_šfo
("%s,„—d_th»shŞd_çùÜ oÆy suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1425  -
EINVAL
;

1427 ià(
v®
 < 0)

1428  -
EINVAL
;

1429 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1430 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1431 
	`shªnÚ_m¦“p
(2);

1432 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1433 
sdev
->
œq_d–ay
.
»ad_th»shŞd_çùÜ
 = 
v®
;

1434 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1435 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1436 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1437 
	`shªnÚ_šfo
("%s, modify„—d_th»shŞd_çùÜØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1438  
couÁ
;

1439 
	}
}

1441 
shªnÚ_ssize_t
 
	$max_œq_d–ay_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1443  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
max_œq_d–ay
);

1444 
	}
}

1446 
shªnÚ_ssize_t
 
	$max_œq_d–ay_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1448 
v®
;

1449 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1450 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1452 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1453 
	`shªnÚ_šfo
("%s, max_œq_d–ay oÆy suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1454  -
EINVAL
;

1456 ià(
v®
 < 0)

1457  -
EINVAL
;

1458 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1459 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1460 
	`shªnÚ_m¦“p
(2);

1461 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1462 
sdev
->
œq_d–ay
.
max_œq_d–ay
 = 
v®
;

1463 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1464 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1465 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1466 
	`shªnÚ_šfo
("%s, modify max_œq_d–ayØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1467  
couÁ
;

1468 
	}
}

1470 
shªnÚ_ssize_t
 
	$mš_œq_d–ay_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1472  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
œq_d–ay
.
mš_œq_d–ay
);

1473 
	}
}

1475 
shªnÚ_ssize_t
 
	$mš_œq_d–ay_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1477 
v®
;

1478 
Şd_dyÇmic_œq_d–ay
 = 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
;

1479 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1481 ià(!
	`shªnÚ_dev_is_g5
(
sdev
)) {

1482 
	`shªnÚ_šfo
("%s, mš_œq_d–ay oÆy suµÜˆby G5 deviûs.\n", 
sdev
->
cdev_Çme
);

1483  -
EINVAL
;

1485 ià(
v®
 < 0)

1486  -
EINVAL
;

1487 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 0;

1488 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1489 
	`shªnÚ_m¦“p
(2);

1490 
	`shªnÚ_d–_tim”_sync
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
);

1491 
sdev
->
œq_d–ay
.
mš_œq_d–ay
 = 
v®
;

1492 
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 = 
Şd_dyÇmic_œq_d–ay
;

1493 ià(
sdev
->
œq_d–ay
.
dyÇmic_œq_d–ay
 && 
shªnÚ_dyÇmic_œq_d–ay
)

1494 
	`shªnÚ_mod_tim”
(&
sdev
->
œq_d–ay
.
upd©e_œq_d–ay_tim”
, 
	`shªnÚ_m£cs_to_jiff›s
(sdev->œq_d–ay.
upd©e_œq_d–ay_š‹rv®
è+ 
	`g‘_jiff›s
());

1495 
	`shªnÚ_šfo
("%s, modify mš_œq_d–ayØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1496  
couÁ
;

1497 
	}
}

1499 
shªnÚ_ssize_t
 
	$drİ_ÿche_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1501  
	`shªnÚ_¥rštf
(
buf
, "0\n");

1502 
	}
}

1504 
shªnÚ_ssize_t
 
	$drİ_ÿche_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1506 
v®
;

1507 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1509 ià(
v®
 != 0) {

1510 
	`drİ_®l_ÿche_lše
(
sdev
);

1511 
	`shªnÚ_šfo
("%s, drİ cachfšished.\n", 
sdev
->
cdev_Çme
);

1513  
couÁ
;

1514 
	}
}

1516 
shªnÚ_ssize_t
 
	$´eãtch_£q»ad_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1518  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
£q»ad_th»shŞd
);

1519 
	}
}

1521 
shªnÚ_ssize_t
 
	$´eãtch_£q»ad_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1523 
v®
;

1524 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1526 ià(
v®
 < 0 || val >= 100000)

1527  -
EINVAL
;

1529 
sdev
->
sdisk
.
´eãtch
.
£q»ad_th»shŞd
 = 
v®
;

1530 
	`shªnÚ_šfo
("%s, modify seq»ad_th»shŞdØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1532  
couÁ
;

1533 
	}
}

1535 
shªnÚ_ssize_t
 
	$´eãtch_pŞl_times_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1537  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
pŞl_times_th»shŞd
);

1538 
	}
}

1540 
shªnÚ_ssize_t
 
	$´eãtch_pŞl_times_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1542 
v®
;

1543 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1545 ià(
v®
 < 0 || val >= 1000)

1546  -
EINVAL
;

1548 
sdev
->
sdisk
.
´eãtch
.
pŞl_times_th»shŞd
 = 
v®
;

1549 
	`shªnÚ_šfo
("%s, modify…»ãtch…Şl_times_th»shŞdØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1551  
couÁ
;

1552 
	}
}

1554 
shªnÚ_ssize_t
 
	$´eãtch_soá_bio_size_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1556  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
soá_bio_size_th»shŞd
);

1557 
	}
}

1559 
shªnÚ_ssize_t
 
	$´eãtch_soá_bio_size_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1561 
v®
;

1562 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1564 ià(
v®
 < 0)

1565  -
EINVAL
;

1567 
sdev
->
sdisk
.
´eãtch
.
soá_bio_size_th»shŞd
 = 
v®
;

1568 
	`shªnÚ_šfo
("%s, modify…»ãtch soá_bio_size_th»shŞdØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1570  
couÁ
;

1571 
	}
}

1573 
shªnÚ_ssize_t
 
	$´eãtch_h¬d_bio_size_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1575  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
h¬d_bio_size_th»shŞd
);

1576 
	}
}

1578 
shªnÚ_ssize_t
 
	$´eãtch_h¬d_bio_size_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1580 
v®
;

1581 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1583 ià(
v®
 < 0)

1584  -
EINVAL
;

1586 
sdev
->
sdisk
.
´eãtch
.
h¬d_bio_size_th»shŞd
 = 
v®
;

1587 
	`shªnÚ_šfo
("%s, modify…»ãtch h¬d_bio_size_th»shŞdØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1589  
couÁ
;

1590 
	}
}

1592 
shªnÚ_ssize_t
 
	$´eãtch_Ïrge_block_io_th»shŞd_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1594  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
Ïrge_block_io_th»shŞd
);

1595 
	}
}

1597 
shªnÚ_ssize_t
 
	$´eãtch_Ïrge_block_io_th»shŞd_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1599 
v®
;

1600 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1602 ià(
v®
 < 0)

1603  -
EINVAL
;

1605 
sdev
->
sdisk
.
´eãtch
.
Ïrge_block_io_th»shŞd
 = 
v®
;

1606 
	`shªnÚ_šfo
("%s, modify…»ãtch†¬ge_block_io_th»shŞdØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1608  
couÁ
;

1609 
	}
}

1611 
shªnÚ_ssize_t
 
	$´eãtch_di¡ªû_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1613  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
di¡ªû_çùÜ
);

1614 
	}
}

1616 
shªnÚ_ssize_t
 
	$´eãtch_di¡ªû_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1618 
v®
;

1619 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1621 ià(
v®
 < 0 || v® > (
sdev
->
sdisk
.
´eãtch
.
ÿche_lšes
 - 1))

1622  -
EINVAL
;

1624 
sdev
->
sdisk
.
´eãtch
.
di¡ªû_çùÜ
 = 
v®
;

1625 
	`shªnÚ_šfo
("%s, modify…»ãtch di¡ªû_çùÜØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1627  
couÁ
;

1628 
	}
}

1630 
shªnÚ_ssize_t
 
	$´eãtch_’abË_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1632  
	`shªnÚ_¥rštf
(
buf
, "%s\n", 
	`g‘_´eãtch_’abË_¡©e
(&
sdev
->
sdisk
.
´eãtch
) ? "enable" : "disable");

1633 
	}
}

1635 
shªnÚ_ssize_t
 
	$´eãtch_’abË_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1637 
v®
;

1638 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1640 ià(
v®
 == 0)

1641 
	`£t_´eãtch_di§bË
(&
sdev
->
sdisk
.
´eãtch
);

1643 
	`£t_´eãtch_’abË
(&
sdev
->
sdisk
.
´eãtch
);

1645 
	`shªnÚ_šfo
("%s,…»ãtch i %s.\n", 
sdev
->
cdev_Çme
, 
	`g‘_´eãtch_’abË_¡©e
(&sdev->
sdisk
.
´eãtch
) ? "enable" : "disable");

1647  
couÁ
;

1648 
	}
}

1650 
shªnÚ_ssize_t
 
	$´eãtch_Œaffic_çùÜ_show
(
shªnÚ_dev
 *
sdev
, *
buf
)

1652  
	`shªnÚ_¥rštf
(
buf
, "%d\n", 
sdev
->
sdisk
.
´eãtch
.
Œaffic_çùÜ
);

1653 
	}
}

1655 
shªnÚ_ssize_t
 
	$´eãtch_Œaffic_çùÜ_¡Üe
(
shªnÚ_dev
 *
sdev
, cÚ¡ *
buf
, 
shªnÚ_size_t
 
couÁ
)

1657 
v®
;

1658 
v®
 = 
	`shªnÚ_sim¶e_¡¹Ş
(
buf
, 
NULL
, 10);

1660 ià(
v®
 < 0)

1661  -
EINVAL
;

1663 
sdev
->
sdisk
.
´eãtch
.
Œaffic_çùÜ
 = 
v®
;

1664 
	`shªnÚ_šfo
("%s, modify…»ãtch¿ffic_çùÜØ%d.\n", 
sdev
->
cdev_Çme
, 
v®
);

1666  
couÁ
;

1667 
	}
}

	@shannon_time.c

1 
	~"shªnÚ_time.h
"

2 
	~<lšux/jiff›s.h
>

3 
	~<lšux/time.h
>

4 
	~<lšux/tim”.h
>

5 
	~<lšux/d–ay.h
>

6 
	~<lšux/v”siÚ.h
>

7 
	~<asm/·¿m.h
>

9 
	$g‘_HZ
()

11  
HZ
;

12 
	}
}

15 
	$shªnÚ_š™_tim”
(
shªnÚ_tim”_li¡
 *
tim”
)

17 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 15, 0)

18 
	`š™_tim”
((
tim”_li¡
 *)
tim”
);

19 ((
tim”_li¡
 *)
tim”
)->
funùiÚ
 = 
NULL
;

21 
	`__š™_tim”
((
tim”_li¡
 *)
tim”
, 
NULL
, 0);

23 
	}
}

25 
	$shªnÚ_add_tim”
(
shªnÚ_tim”_li¡
 *
tim”
, 
expœes
)

27 ((
tim”_li¡
 *)
tim”
)->
expœes
 =ƒxpires;

28 
	`add_tim”
((
tim”_li¡
 *)
tim”
);

29 
	}
}

31 
	$shªnÚ_d–_tim”_sync
(
shªnÚ_tim”_li¡
 *
tim”
)

33  
	`d–_tim”_sync
((
tim”_li¡
 *)
tim”
);

34 
	}
}

36 
	$shªnÚ_d–_tim”
(
shªnÚ_tim”_li¡
 *
tim”
)

38  
	`d–_tim”
((
tim”_li¡
 *)
tim”
);

39 
	}
}

41 
	$shªnÚ_mod_tim”
(
shªnÚ_tim”_li¡
 *
tim”
, 
expœes
)

43  
	`mod_tim”
((
tim”_li¡
 *)
tim”
, 
expœes
);

44 
	}
}

46 
	$shªnÚ_tim”_³ndšg
(
shªnÚ_tim”_li¡
 * 
tim”
)

48  
	`tim”_³ndšg
((
tim”_li¡
 *)
tim”
);

49 
	}
}

51 
shªnÚ_£t_tim”_cÚ‹xt
(
shªnÚ_tim”_li¡
 *
tim”
, (*
f
)(shannon_timer_list *))

53 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 15, 0)

54 ((
tim”_li¡
 *)
tim”
)->
d©a
 = ()timer;

55 ((
tim”_li¡
 *)
tim”
)->
funùiÚ
 = ((*è())
f
;

57 ((
tim”_li¡
 *)
tim”
)->
funùiÚ
 = ((*è(tim”_li¡ *))
f
;

59 
	}
}

61 
	$shªnÚ_tim”_has_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
)

63  ((
tim”_li¡
 *)
tim”
)->
funùiÚ
 ? 1 : 0;

64 
	}
}

67 
	$shªnÚ_m¦“p
(
m£cs
)

69 
	`m¦“p
(
m£cs
);

70 
	}
}

72 
	$shªnÚ_ud–ay
(
u£cs
)

74 
	`ud–ay
(
u£cs
);

75 
	}
}

78 
	$g‘_jiff›s
()

80  
jiff›s
;

81 
	}
}

83 
	$shªnÚ_do_g‘timeofday
(
shªnÚ_timev®
 *
tv
)

85 
timev®
 
time
;

86 
	`do_g‘timeofday
(&
time
);

87 
tv
->
tv_£c
 = 
time
.tv_sec;

88 
tv
->
tv_u£c
 = 
time
.tv_usec;

89 
	}
}

92 
	$shªnÚ_jiff›s_to_m£cs
(cÚ¡ 
j
)

94  
	`jiff›s_to_m£cs
(
j
);

95 
	}
}

97 
	$shªnÚ_jiff›s_to_u£cs
(cÚ¡ 
j
)

99  
	`jiff›s_to_u£cs
(
j
);

100 
	}
}

102 
	$shªnÚ_m£cs_to_jiff›s
(cÚ¡ 
m
)

104  
	`m£cs_to_jiff›s
(
m
);

105 
	}
}

107 
	$shªnÚ_u£cs_to_jiff›s
(cÚ¡ 
u
)

109  
	`u£cs_to_jiff›s
(
u
);

110 
	}
}

	@shannon_time.h

1 #iâdeà
__SHANNON_TIME_H


2 
	#__SHANNON_TIME_H


	)

4 
	~"shªnÚ_kcÜe.h
"

6 
	#äom_tim”
(
v¬
, 
ÿÎback_tim”
, 
tim”_f›ldÇme
) \

7 
	`cÚš”_of
(
ÿÎback_tim”
, 
	`ty³of
(*
v¬
), 
tim”_f›ldÇme
)

	)

10 
	s__shªnÚ_tim”_li¡
 {

11 
RESERVE_MEM
(160);

14 
	sshªnÚ_timev®
 {

15 
u64
 
	mtv_£c
;

16 
u64
 
	mtv_u£c
;

19 
__shªnÚ_tim”_li¡
 
	tshªnÚ_tim”_li¡
;

21 
g‘_HZ
();

22 
shªnÚ_š™_tim”
(
shªnÚ_tim”_li¡
 *
tim”
);

23 
shªnÚ_add_tim”
(
shªnÚ_tim”_li¡
 *
tim”
, 
expœes
);

24 
shªnÚ_£t_tim”_cÚ‹xt
(
shªnÚ_tim”_li¡
 *
tim”
, (*
f
)(shannon_timer_list *));

25 
	`shªnÚ_tim”_has_funùiÚ
(
shªnÚ_tim”_li¡
 *
tim”
);

26 
	`shªnÚ_d–_tim”_sync
(
shªnÚ_tim”_li¡
 *
tim”
);

27 
	`shªnÚ_d–_tim”
(
shªnÚ_tim”_li¡
 *
tim”
);

28 
	`shªnÚ_mod_tim”
(
shªnÚ_tim”_li¡
 *
tim”
, 
expœes
);

29 
	`shªnÚ_tim”_³ndšg
(
shªnÚ_tim”_li¡
 * 
tim”
);

32 
	`shªnÚ_m¦“p
(
m£cs
);

33 
	`shªnÚ_ud–ay
(
u£cs
);

35 
	`g‘_jiff›s
();

36 
	`shªnÚ_do_g‘timeofday
(
shªnÚ_timev®
 *
tv
);

39 
	`shªnÚ_jiff›s_to_m£cs
(cÚ¡ 
j
);

40 
	`shªnÚ_jiff›s_to_u£cs
(cÚ¡ 
j
);

41 
	`shªnÚ_m£cs_to_jiff›s
(cÚ¡ 
m
);

42 
	`shªnÚ_u£cs_to_jiff›s
(cÚ¡ 
u
);

	@shannon_waitqueue.c

6 
	~<lšux/š™.h
>

7 
	~<lšux/moduË.h
>

8 
	~<lšux/sched.h
>

9 
	~<lšux/mm.h
>

10 
	~<lšux/wa™.h
>

11 
	~<lšux/hash.h
>

12 
	~<lšux/v”siÚ.h
>

14 
	~"shªnÚ_wa™queue.h
"

16 
	$__shªnÚ_wake_up_commÚ
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
mode
,

17 
Ä_exşusive
, 
wake_æags
, *
key
)

19 
shªnÚ_wa™_queue_t
 *
cu¼
, *
Ãxt
;

21 
	`shªnÚ_li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
q
->
sk_li¡
,ask_list) {

22 
æags
 = 
cu¼
->flags;

24 ià(
cu¼
->
	`func
(cu¼, 
mode
, 
wake_æags
, 
key
) &&

25 (
æags
 & 
WQ_FLAG_EXCLUSIVE
è&& !--
Ä_exşusive
)

28 
	}
}

30 
	$__shªnÚ_wake_up
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
mode
,

31 
Ä_exşusive
, *
key
)

33 
æags
;

35 
	`¥š_lock_œq§ve
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

36 
	`__shªnÚ_wake_up_commÚ
(
q
, 
mode
, 
Ä_exşusive
, 0, 
key
);

37 
	`¥š_uÆock_œq»¡Üe
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

38 
	}
}

40 
	$__shªnÚ_š™_wa™queue_h—d
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_lock_şass_key
 *
key
)

42 
	`¥š_lock_š™
((
¥šlock_t
 *)&
q
->
lock
);

43 
	`lockd•_£t_şass
((
¥šlock_t
 *)&
q
->
lock
, (
lock_şass_key
 *)
key
);

44 
	`SHANNON_INIT_LIST_HEAD
(&
q
->
sk_li¡
);

45 
	}
}

47 
šlše
 
	$__shªnÚ_add_wa™_queue
(
shªnÚ_wa™_queue_h—d_t
 *
h—d
, 
shªnÚ_wa™_queue_t
 *
Ãw
)

49 
	`shªnÚ_li¡_add
(&
Ãw
->
sk_li¡
, &
h—d
->task_list);

50 
	}
}

52 
	$shªnÚ_wa™queue_aùive
(
shªnÚ_wa™_queue_h—d_t
 *
q
)

54  !
	`shªnÚ_li¡_em±y
(&
q
->
sk_li¡
);

55 
	}
}

57 
	$shªnÚ_add_wa™_queue
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_wa™_queue_t
 *
wa™
)

59 
æags
;

61 
wa™
->
æags
 &ğ~
WQ_FLAG_EXCLUSIVE
;

62 
	`¥š_lock_œq§ve
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

63 
	`__shªnÚ_add_wa™_queue
(
q
, 
wa™
);

64 
	`¥š_uÆock_œq»¡Üe
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

65 
	}
}

79 
	$shªnÚ_´•¬e_to_wa™
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_wa™_queue_t
 *
wa™
, 
¡©e
)

81 
æags
;

83 
wa™
->
æags
 &ğ~
WQ_FLAG_EXCLUSIVE
;

84 
	`¥š_lock_œq§ve
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

85 ià(
	`shªnÚ_li¡_em±y
(&
wa™
->
sk_li¡
))

86 
	`__shªnÚ_add_wa™_queue
(
q
, 
wa™
);

87 
	`£t_cu¼’t_¡©e
(
¡©e
);

88 
	`¥š_uÆock_œq»¡Üe
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

89 
	}
}

101 
	$shªnÚ_fšish_wa™
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_wa™_queue_t
 *
wa™
)

103 
æags
;

105 
	`__£t_cu¼’t_¡©e
(
TASK_RUNNING
);

119 ià(!
	`shªnÚ_li¡_em±y_ÿ»ful
(&
wa™
->
sk_li¡
)) {

120 
	`¥š_lock_œq§ve
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

121 
	`shªnÚ_li¡_d–_š™
(&
wa™
->
sk_li¡
);

122 
	`¥š_uÆock_œq»¡Üe
((
¥šlock_t
 *)&
q
->
lock
, 
æags
);

124 
	}
}

126 
	$shªnÚ_autÜemove_wake_funùiÚ
(
shªnÚ_wa™_queue_t
 *
wa™
, 
mode
, 
sync
, *
key
)

128 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(4, 13, 0)

129 
»t
 = 
	`deçuÉ_wake_funùiÚ
((
wa™_queue_t
 *)
wa™
, 
mode
, 
sync
, 
key
);

131 
»t
 = 
	`deçuÉ_wake_funùiÚ
((
wa™_queue_’Œy_t
 *)
wa™
, 
mode
, 
sync
, 
key
);

134 ià(
»t
)

135 
	`shªnÚ_li¡_d–_š™
(&
wa™
->
sk_li¡
);

136  
»t
;

137 
	}
}

	@shannon_waitqueue.h

1 #iâdeà
__SHANNON_WAITQUEUE_H


2 
	#__SHANNON_WAITQUEUE_H


	)

4 
	~"shªnÚ_kcÜe.h
"

5 
	~"shªnÚ_sched.h
"

6 
	~"shªnÚ_li¡.h
"

8 
	s__shªnÚ_wa™_queue_h—d
 {

9 
shªnÚ_¥šlock_t
 
	mlock
;

10 
shªnÚ_li¡_h—d
 
	msk_li¡
;

12 
__shªnÚ_wa™_queue_h—d
 
	tshªnÚ_wa™_queue_h—d_t
;

14 
	sshªnÚ_lock_şass_key
 {

15 
RESERVE_MEM
(16);

18 
__shªnÚ_wa™_queue
 
	tshªnÚ_wa™_queue_t
;

19 (*
	tshªnÚ_wa™_queue_func_t
)(
	tshªnÚ_wa™_queue_t
 *
	twa™
, 
	tmode
, 
	tæags
, *
	tkey
);

21 
	s__shªnÚ_wa™_queue
 {

22 
æags
;

23 *
´iv©e
;

24 
shªnÚ_wa™_queue_func_t
 
func
;

25 
shªnÚ_li¡_h—d
 
sk_li¡
;

28 
	`__shªnÚ_wake_up
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
mode
, 
Ä_exşusive
, *
key
);

29 
	`__shªnÚ_š™_wa™queue_h—d
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_lock_şass_key
 *
key
);

30 
	`shªnÚ_wa™queue_aùive
(
shªnÚ_wa™_queue_h—d_t
 *
q
);

31 
	`shªnÚ_´•¬e_to_wa™
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_wa™_queue_t
 *
wa™
, 
¡©e
);

32 
	`shªnÚ_fšish_wa™
(
shªnÚ_wa™_queue_h—d_t
 *
q
, 
shªnÚ_wa™_queue_t
 *
wa™
);

34 
	`shªnÚ_autÜemove_wake_funùiÚ
(
shªnÚ_wa™_queue_t
 *
wa™
, 
mode
, 
sync
, *
key
);

36 
	#shªnÚ_š™_wa™queue_h—d
(
q
) \

38 
shªnÚ_lock_şass_key
 
__key
; \

40 
	`__shªnÚ_š™_wa™queue_h—d
((
q
), &
__key
); \

41 
	}
} 0)

	)

43 
	#shªnÚ_wake_up
(
x
è
	`__shªnÚ_wake_up
(x, (
SHN_TASK_INTERRUPTIBLE
 | 
SHN_TASK_UNINTERRUPTIBLE
), 1, 
NULL
)

	)

45 
	#SHANNON_DEFINE_WAIT_FUNC
(
Çme
, 
funùiÚ
) \

46 
shªnÚ_wa™_queue_t
 
Çme
 = { \

47 .
´iv©e
 = 
	`shªnÚ_cu¼’t
(), \

48 .
func
 = 
funùiÚ
, \

49 .
sk_li¡
 = 
	`SHANNON_LIST_HEAD_INIT
((
Çme
).task_list), \

50 }

	)

52 
	#SHANNON_DEFINE_WAIT
(
Çme
è
	`SHANNON_DEFINE_WAIT_FUNC
Òame, 
shªnÚ_autÜemove_wake_funùiÚ
)

	)

54 
	#__shªnÚ_wa™_ev’t
(
wq
, 
cÚd™iÚ
) \

56 
	`SHANNON_DEFINE_WAIT
(
__wa™
); \

59 
	`shªnÚ_´•¬e_to_wa™
(&
wq
, &
__wa™
, 
SHN_TASK_UNINTERRUPTIBLE
); \

60 ià(
cÚd™iÚ
) \

62 
	`shªnÚ_scheduË
(); \

64 
	`shªnÚ_fšish_wa™
(&
wq
, &
__wa™
); \

65 } 0)

	)

67 
	#shªnÚ_wa™_ev’t
(
wq
, 
cÚd™iÚ
) \

69 ià(
cÚd™iÚ
) \

71 
	`__shªnÚ_wa™_ev’t
(
wq
, 
cÚd™iÚ
); \

72 } 0)

	)

74 
	#__shªnÚ_wa™_ev’t_š‹¼u±ibË
(
wq
, 
cÚd™iÚ
, 
»t
) \

76 
	`SHANNON_DEFINE_WAIT
(
__wa™
); \

79 
	`shªnÚ_´•¬e_to_wa™
(&
wq
, &
__wa™
, 
SHN_TASK_INTERRUPTIBLE
); \

80 ià(
cÚd™iÚ
) \

82 ià(!
	`shªnÚ_sigÇl_³ndšg
(
	`shªnÚ_cu¼’t
())) { \

83 
	`shªnÚ_scheduË
(); \

86 
»t
 = -
ERESTARTSYS
; \

89 
	`shªnÚ_fšish_wa™
(&
wq
, &
__wa™
); \

90 } 0)

	)

92 
	#shªnÚ_wa™_ev’t_š‹¼u±ibË
(
wq
, 
cÚd™iÚ
) \

94 
__»t
 = 0; \

95 ià(!(
cÚd™iÚ
)) \

96 
	`__shªnÚ_wa™_ev’t_š‹¼u±ibË
(
wq
, 
cÚd™iÚ
, 
__»t
); \

97 
__»t
; \

98 })

	)

	@shannon_workqueue.c

1 
	~"shªnÚ_wÜkqueue.h
"

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/v”siÚ.h
>

4 
	~<lšux/wÜkqueue.h
>

6 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 20)

7 
	s__d–ayed_wÜk
 {

8 
wÜk_¡ruù
 
	mwÜk
;

12 
	$shªnÚ_š™_wÜk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
, 
shªnÚ_wÜk_func_t
 
func
)

14 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

15 
	`INIT_WORK
((
wÜk_¡ruù
 *)
wÜk
, (
wÜk_func_t
)
func
);

17 
	`INIT_WORK
((
wÜk_¡ruù
 *)
wÜk
, (*)
func
, work);

19 
	}
}

21 
	$shªnÚ_š™_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
, 
shªnÚ_wÜk_func_t
 
func
)

23 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

24 
	`INIT_DELAYED_WORK
((
d–ayed_wÜk
 *)
wÜk
, (
wÜk_func_t
)
func
);

26 
	`INIT_WORK
((
wÜk_¡ruù
 *)
wÜk
, (*)
func
, work);

28 
	}
}

30 
shªnÚ_d–ayed_wÜk
 *
	$g‘_d–ayed_wÜk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

32 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

33 
d–ayed_wÜk
 *d–ayed_wÜk = 
	`cÚš”_of
((
wÜk_¡ruù
 *)
wÜk
, delayed_work, work);

34  (
shªnÚ_d–ayed_wÜk
 *)
d–ayed_wÜk
;

36  (
shªnÚ_d–ayed_wÜk
 *)
wÜk
;

39 
	}
}

41 
	$shªnÚ_queue_wÜk
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
, 
shªnÚ_wÜk_¡ruù
 *
wÜk
)

43  
	`queue_wÜk
((
wÜkqueue_¡ruù
 *)
wq
, (
wÜk_¡ruù
 *)
wÜk
);

44 
	}
}

46 
shªnÚ_wÜkqueue_¡ruù_t
 *
	$shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(cÚ¡ *
Çme
)

48  
	`ü—‹_sšgËth»ad_wÜkqueue
(
Çme
);

49 
	}
}

51 
shªnÚ_wÜkqueue_¡ruù_t
 *
	$shªnÚ_ü—‹_wÜkqueue
(cÚ¡ *
Çme
)

53  
	`ü—‹_wÜkqueue
(
Çme
);

54 
	}
}

56 
	$shªnÚ_de¡roy_wÜkqueue
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
)

58 
	`de¡roy_wÜkqueue
((
wÜkqueue_¡ruù
 *)
wq
);

59 
	}
}

61 
	$shªnÚ_æush_wÜkqueue
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
)

63 
	`æush_wÜkqueue
((
wÜkqueue_¡ruù
 *)
wq
);

64 
	}
}

66 
	$shªnÚ_ÿnûl_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
)

68 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

69 
	`ÿnûl_d–ayed_wÜk
((
d–ayed_wÜk
 *)
wÜk
);

71 
	`ÿnûl_d–ayed_wÜk
((
wÜk_¡ruù
 *)
wÜk
);

73 
	}
}

76 
	$shªnÚ_queue_d–ayed_wÜk
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
, 
shªnÚ_d–ayed_wÜk
 *
wÜk
, 
d–ay
)

78 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

79  
	`queue_d–ayed_wÜk
((
wÜkqueue_¡ruù
 *)
wq
, (
d–ayed_wÜk
 *)
wÜk
, 
d–ay
);

81  
	`queue_d–ayed_wÜk
((
wÜkqueue_¡ruù
 *)
wq
, (
wÜk_¡ruù
 *)
wÜk
, 
d–ay
);

83 
	}
}

85 
	$shªnÚ_scheduË_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
, 
d–ay
)

87 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

88  
	`scheduË_d–ayed_wÜk
((
d–ayed_wÜk
 *)
wÜk
, 
d–ay
);

90  
	`scheduË_d–ayed_wÜk
((
wÜk_¡ruù
 *)
wÜk
, 
d–ay
);

92 
	}
}

94 
	$shªnÚ_scheduË_wÜk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

96  
	`scheduË_wÜk
((
wÜk_¡ruù
 *)
wÜk
);

97 
	}
}

99 
	$shªnÚ_wÜk_ş—r_³ndšg
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

101 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

102 
	`ş—r_b™
(0, &((
wÜk_¡ruù
 *)
wÜk
)->
³ndšg
);

103 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 22)

104 
	`wÜk_»Ëa£
((
wÜk_¡ruù
 *)
wÜk
);

105 #–ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(3, 16, 0)

106 
	`wÜk_ş—r_³ndšg
((
wÜk_¡ruù
 *)
wÜk
);

108 
	`ş—r_b™
(
WORK_STRUCT_PENDING_BIT
, 
	`wÜk_d©a_b™s
((
wÜk_¡ruù
 *)
wÜk
));

110 
	}
}

112 
	$shªnÚ_wÜk_³ndšg
(
shªnÚ_wÜk_¡ruù
 *
wÜk
)

114 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 20)

115  
	`‹¡_b™
(0, &((
wÜk_¡ruù
 *)
wÜk
)->
³ndšg
);

117  
	`wÜk_³ndšg
((
wÜk_¡ruù
 *)
wÜk
);

119 
	}
}

121 
	$__shªnÚ_ÿnûl_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
)

123 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(3, 15, 0)

124 
»t
;

126 
»t
 = 
	`d–_tim”
(&((
d–ayed_wÜk
 *)
wÜk
)->
tim”
);

127 ià(
»t
)

128 
	`shªnÚ_wÜk_ş—r_³ndšg
((
shªnÚ_wÜk_¡ruù
 *)(&((
d–ayed_wÜk
 *)
wÜk
)->work));

129  
»t
;

130 #–ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 31)

131  
	`__ÿnûl_d–ayed_wÜk
((
d–ayed_wÜk
 *)
wÜk
);

133 
»t
;

134 #ià
LINUX_VERSION_CODE
 >ğ
	`KERNEL_VERSION
(2, 6, 20)

135 
»t
 = 
	`d–_tim”
(&((
d–ayed_wÜk
 *)
wÜk
)->
tim”
);

136 ià(
»t
)

137 
	`shªnÚ_wÜk_ş—r_³ndšg
((
shªnÚ_wÜk_¡ruù
 *)(&((
d–ayed_wÜk
 *)
wÜk
)->work));

139 
»t
 = 
	`d–_tim”
(&(((
__d–ayed_wÜk
 *)
wÜk
)->wÜk.
tim”
));

140 ià(
»t
)

141 
	`shªnÚ_wÜk_ş—r_³ndšg
((
shªnÚ_wÜk_¡ruù
 *)(&((
__d–ayed_wÜk
 *)
wÜk
)->work));

143  
»t
;

145 
	}
}

147 
	#RT_MAX_LOOP_COUNT
 1000

	)

149 
	$¹_th»ad_â
(*
d©a
)

151 
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
 = 
d©a
;

152 
shªnÚ_¹_wÜk_¡ruù
 *
¹w
;

153 
æags
;

154 
»t
 = 
	`£t_th»ad_¹
();

155 
loİ_couÁ
, 
is_¹
;

157 ià(
»t
)

158 
	`shªnÚ_w¬n
("FaedØ£ˆ'%s'ØbRT,ƒ¼Ü: %d.\n", 
¹wq
->
th»ad_Çme
, 
»t
);

160 
loİ_couÁ
 = 0;

161 
is_¹
 = 1;

162 !
	`shªnÚ_li¡_em±y
(&
¹wq
->
li¡
)) {

163 
æags
 = 
	`shªnÚ_¥š_lock_œq§ve
(&
¹wq
->
lock
);

164 
¹w
 = 
	`shªnÚ_li¡_fœ¡_’Œy
(&
¹wq
->
li¡
, 
shªnÚ_¹_wÜk_¡ruù
,

165 
li¡
);

166 
	`shªnÚ_li¡_d–_š™
(&
¹w
->
li¡
);

167 
	`shªnÚ_ş—r_b™
(
RT_WORK_STRUCT_PENDING_BIT
, &
¹w
->
æags
);

168 
	`shªnÚ_¥š_uÆock_œq»¡Üe
(&
¹wq
->
lock
, 
æags
);

169 
¹w
->
	`func
(rtw);

170 ++
loİ_couÁ
;

171 ià(
loİ_couÁ
 >ğ
RT_MAX_LOOP_COUNT
) {

172 ià(
is_¹
) {

173 
»t
 = 
	`£t_th»ad_nÜm®
();

174 
is_¹
 = 0;

176 
	`shªnÚ_cÚd_»sched
();

179 ià(!
is_¹
)

180 
	`£t_th»ad_¹
();

181 
	`shªnÚ_wake_up
(&
¹wq
->
æush_ev’t
);

182 ià(
	`uÆik–y
(
	`shªnÚ_kth»ad_should_¡İ
()))

184 ià(
	`shªnÚ_li¡_em±y
(&
¹wq
->
li¡
)) {

185 
	`shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_INTERRUPTIBLE
);

186 ià(
	`shªnÚ_li¡_em±y
(&
¹wq
->
li¡
))

187 
	`shªnÚ_scheduË
();

189 
	`__shªnÚ_£t_cu¼’t_¡©e
(
SHN_TASK_RUNNING
);

194 
	}
}

196 
shªnÚ_¹_wÜkqueue_¡ruù
 *
	$shªnÚ_ü—‹_sšgËth»ad_¹_wÜkqueue
(cÚ¡ *
Çme
)

198 
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
 = 
	`shªnÚ_kz®loc
((*¹wq), 
GFP_SHANNON
);

199 ià(!
¹wq
)

200  
NULL
;

201 
	`shªnÚ_¥š_lock_š™
(&
¹wq
->
lock
);

202 
	`SHANNON_INIT_LIST_HEAD
(&
¹wq
->
li¡
);

203 
	`shªnÚ_š™_wa™queue_h—d
(&
¹wq
->
æush_ev’t
);

204 
¹wq
->
th»ad
 = 
	`shªnÚ_kth»ad_run
(
¹_th»ad_â
,„twq, "%s", 
Çme
);

205 ià(
	`SHANNON_IS_ERR
(
¹wq
->
th»ad
)) {

206 
	`shªnÚ_kä“
(
¹wq
);

207  
NULL
;

209 
	`shªnÚ_¢´štf
(
¹wq
->
th»ad_Çme
, Ôtwq->th»ad_Çme), "%s", 
Çme
);

210  
¹wq
;

211 
	}
}

213 
	$shªnÚ_æush_¹_wÜkqueue
(
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
)

215 
	`shªnÚ_wake_up_´oûss
(
¹wq
->
th»ad
);

216 
	`shªnÚ_wa™_ev’t
(
¹wq
->
æush_ev’t
, 
	`shªnÚ_li¡_em±y
(&¹wq->
li¡
));

217 
	}
}

219 
	$shªnÚ_de¡roy_¹_wÜkqueue
(
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
)

221 
	`shªnÚ_æush_¹_wÜkqueue
(
¹wq
);

222 
	`shªnÚ_kth»ad_¡İ
(
¹wq
->
th»ad
);

223 
	`shªnÚ_kä“
(
¹wq
);

224 
	}
}

226 
	$shªnÚ_¹_queue_wÜk
(
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
, 
shªnÚ_¹_wÜk_¡ruù
 *
wÜk
)

228 
æags
;

229 
»t
 = 0;

230 
æags
 = 
	`shªnÚ_¥š_lock_œq§ve
(&
¹wq
->
lock
);

231 ià(!
	`shªnÚ_‹¡_ªd_£t_b™
(
RT_WORK_STRUCT_PENDING_BIT
, &
wÜk
->
æags
)) {

232 
	`BUG_ON
(!
	`shªnÚ_li¡_em±y
(&
wÜk
->
li¡
));

233 
	`shªnÚ_li¡_add_
(&
wÜk
->
li¡
, &
¹wq
->list);

235 
»t
 = -1;

236 
	`shªnÚ_¥š_uÆock_œq»¡Üe
(&
¹wq
->
lock
, 
æags
);

237 ià(
»t
 == 0)

238 
	`shªnÚ_wake_up_´oûss
(
¹wq
->
th»ad
);

239  
»t
;

240 
	}
}

242 
	$shªnÚ_š™_¹_wÜk
(
shªnÚ_¹_wÜk_¡ruù
 *
wÜk
, 
shªnÚ_¹_wÜk_func_t
 
func
)

244 
	`SHANNON_INIT_LIST_HEAD
(&
wÜk
->
li¡
);

245 
wÜk
->
func
 = func;

246 
	}
}

	@shannon_workqueue.h

1 #iâdeà
__SHANNON_WORKQUEUE_H


2 
	#__SHANNON_WORKQUEUE_H


	)

4 
	~"shªnÚ_kcÜe.h
"

5 
	~"shªnÚ_li¡.h
"

6 
	~"shªnÚ_sched.h
"

7 
	~"shªnÚ_wa™queue.h
"

9 
	sshªnÚ_wÜk_¡ruù
 {

10 
RESERVE_MEM
(216);

13 
	sshªnÚ_d–ayed_wÜk
 {

14 
RESERVE_MEM
(300);

17 (*
	tshªnÚ_wÜk_func_t
)(
	tshªnÚ_wÜk_¡ruù
 *
	twÜk
);

18 
	tshªnÚ_wÜkqueue_¡ruù_t
;

21 
	`shªnÚ_š™_wÜk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
, 
shªnÚ_wÜk_func_t
 
func
);

22 
	`shªnÚ_š™_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
, 
shªnÚ_wÜk_func_t
 
func
);

23 
shªnÚ_d–ayed_wÜk
 *
	`g‘_d–ayed_wÜk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

24 
	`shªnÚ_queue_wÜk
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
, 
shªnÚ_wÜk_¡ruù
 *
wÜk
);

25 
	`shªnÚ_wÜk_³ndšg
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

26 
	`shªnÚ_queue_d–ayed_wÜk
(
shªnÚ_wÜkqueue_¡ruù_t
*
wq
, 
shªnÚ_d–ayed_wÜk
 *
wÜk
, 
d–ay
);

27 
	`shªnÚ_scheduË_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
, 
d–ay
);

28 
	`shªnÚ_scheduË_wÜk
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

29 
	`shªnÚ_ÿnûl_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
);

30 
	`__shªnÚ_ÿnûl_d–ayed_wÜk
(
shªnÚ_d–ayed_wÜk
 *
wÜk
);

31 
	`shªnÚ_wÜk_ş—r_³ndšg
(
shªnÚ_wÜk_¡ruù
 *
wÜk
);

33 
shªnÚ_wÜkqueue_¡ruù_t
 *
	`shªnÚ_ü—‹_sšgËth»ad_wÜkqueue
(cÚ¡ *
Çme
);

34 
shªnÚ_wÜkqueue_¡ruù_t
 *
	`shªnÚ_ü—‹_wÜkqueue
(cÚ¡ *
Çme
);

35 
	`shªnÚ_de¡roy_wÜkqueue
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
);

36 
	`shªnÚ_æush_wÜkqueue
(
shªnÚ_wÜkqueue_¡ruù_t
 *
wq
);

38 
	sshªnÚ_¹_wÜkqueue_¡ruù
 {

39 
shªnÚ_¥šlock_t
 
lock
;

40 
shªnÚ_li¡_h—d
 
li¡
;

41 
shªnÚ_wa™_queue_h—d_t
 
æush_ev’t
;

42 
shªnÚ_sk_¡ruù_t
 *
th»ad
;

43 
th»ad_Çme
[32];

46 
shªnÚ_¹_wÜk_¡ruù
;

47 (*
	tshªnÚ_¹_wÜk_func_t
)(
	tshªnÚ_¹_wÜk_¡ruù
 *
	twÜk
);

48 
	sshªnÚ_¹_wÜk_¡ruù
 {

49 
	#RT_WORK_STRUCT_PENDING_BIT
 0

	)

50 
æags
;

51 
shªnÚ_¹_wÜk_func_t
 
func
;

52 
shªnÚ_li¡_h—d
 
li¡
;

55 
	`shªnÚ_š™_¹_wÜk
(
shªnÚ_¹_wÜk_¡ruù
 *
wÜk
, 
shªnÚ_¹_wÜk_func_t
 
func
);

56 
	`shªnÚ_¹_queue_wÜk
(
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
, 
shªnÚ_¹_wÜk_¡ruù
 *
wÜk
);

57 
shªnÚ_¹_wÜkqueue_¡ruù
 *
	`shªnÚ_ü—‹_sšgËth»ad_¹_wÜkqueue
(cÚ¡ *
Çme
);

58 
	`shªnÚ_de¡roy_¹_wÜkqueue
(
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
);

59 
	`shªnÚ_æush_¹_wÜkqueue
(
shªnÚ_¹_wÜkqueue_¡ruù
 *
¹wq
);

	@/usr/include/asm/param.h

2 #iâdeà
__ASM_STUB_PARAM_H


3 
	#__ASM_STUB_PARAM_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/·¿m.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/·¿m.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/linux/errno.h

1 #iâdeà
_LINUX_ERRNO_H


2 
	#_LINUX_ERRNO_H


	)

4 
	~<asm/”ºo.h
>

	@/usr/include/linux/fcntl.h

1 #iâdeà
_LINUX_FCNTL_H


2 
	#_LINUX_FCNTL_H


	)

4 
	~<asm/fú.h
>

8 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
+5)

	)

10 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
+0)

	)

11 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
+1)

	)

17 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

22 
	#DN_ACCESS
 0x00000001

	)

23 
	#DN_MODIFY
 0x00000002

	)

24 
	#DN_CREATE
 0x00000004

	)

25 
	#DN_DELETE
 0x00000008

	)

26 
	#DN_RENAME
 0x00000010

	)

27 
	#DN_ATTRIB
 0x00000020

	)

28 
	#DN_MULTISHOT
 0x80000000

	)

30 
	#AT_FDCWD
 -100

	)

33 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

34 
	#AT_REMOVEDIR
 0x200

	)

36 
	#AT_SYMLINK_FOLLOW
 0x400

	)

37 
	#AT_NO_AUTOMOUNT
 0x800

	)

	@/usr/include/linux/fs.h

1 #iâdeà
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<lšux/lim™s.h
>

10 
	~<lšux/ioùl.h
>

23 #undeà
NR_OPEN


24 
sysùl_Ä_İ’
;

25 
	#INR_OPEN
 1024

	)

27 
	#BLOCK_SIZE_BITS
 10

	)

28 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

30 
	#SEEK_SET
 0

	)

31 
	#SEEK_CUR
 1

	)

32 
	#SEEK_END
 2

	)

35 
	sfes_¡©_¡ruù
 {

36 
	mÄ_fes
;

37 
	mÄ_ä“_fes
;

38 
	mmax_fes
;

40 
fes_¡©_¡ruù
 
fes_¡©
;

41 
g‘_max_fes
();

43 
	sšodes_¡©_t
 {

44 
	mÄ_šodes
;

45 
	mÄ_unu£d
;

46 
	mdummy
[5];

48 
šodes_¡©_t
 
šodes_¡©
;

50 
Ëa£s_’abË
, 
Ëa£_b»ak_time
;

52 #ifdeà
CONFIG_DNOTIFY


53 
dœ_nÙify_’abË
;

56 
	#NR_FILE
 8192

	)

58 
	#MAY_EXEC
 1

	)

59 
	#MAY_WRITE
 2

	)

60 
	#MAY_READ
 4

	)

61 
	#MAY_APPEND
 8

	)

63 
	#FMODE_READ
 1

	)

64 
	#FMODE_WRITE
 2

	)

67 
	#FMODE_LSEEK
 4

	)

68 
	#FMODE_PREAD
 8

	)

69 
	#FMODE_PWRITE
 
FMODE_PREAD


	)

74 
	#FMODE_EXEC
 16

	)

76 
	#FMODE_32BITHASH
 ( (
fmode_t
)0x200)

	)

78 
	#FMODE_64BITHASH
 ( (
fmode_t
)0x400)

	)

80 
	#RW_MASK
 1

	)

81 
	#RWA_MASK
 2

	)

82 
	#READ
 0

	)

83 
	#WRITE
 1

	)

84 
	#READA
 2

	)

85 
	#SWRITE
 3

	)

86 
	#SPECIAL
 4

	)

87 
	#READ_SYNC
 (
READ
 | (1 << 
BIO_RW_SYNC
))

	)

88 
	#WRITE_SYNC
 (
WRITE
 | (1 << 
BIO_RW_SYNC
))

	)

89 
	#WRITE_BARRIER
 ((1 << 
BIO_RW
è| (1 << 
BIO_RW_BARRIER
))

	)

91 
	#SEL_IN
 1

	)

92 
	#SEL_OUT
 2

	)

93 
	#SEL_EX
 4

	)

96 
	#FS_REQUIRES_DEV
 1

	)

97 
	#FS_BINARY_MOUNTDATA
 2

	)

98 
	#HAVE_FALLOCATE


	)

99 
	#FS_HAS_FALLOCATE
 4

	)

100 
	#FS_HAS_FIEMAP
 8

	)

101 
	#FS_HAS_FREEZE
 16

	)

102 
	#FS_HAS_TRYTOFREE
 32

	)

103 
	#FS_HAS_GETRESV
 64

	)

104 
	#FS_HAS_IODONE2
 128

	)

105 
	#FS_REVAL_DOT
 16384

	)

106 
	#FS_RENAME_DOES_D_MOVE
 32768

	)

113 
	#MS_RDONLY
 1

	)

114 
	#MS_NOSUID
 2

	)

115 
	#MS_NODEV
 4

	)

116 
	#MS_NOEXEC
 8

	)

117 
	#MS_SYNCHRONOUS
 16

	)

118 
	#MS_REMOUNT
 32

	)

119 
	#MS_MANDLOCK
 64

	)

120 
	#MS_DIRSYNC
 128

	)

121 
	#MS_NOATIME
 1024

	)

122 
	#MS_NODIRATIME
 2048

	)

123 
	#MS_BIND
 4096

	)

124 
	#MS_MOVE
 8192

	)

125 
	#MS_REC
 16384

	)

126 
	#MS_VERBOSE
 32768

	)

128 
	#MS_SILENT
 32768

	)

129 
	#MS_POSIXACL
 (1<<16è

	)

130 
	#MS_UNBINDABLE
 (1<<17è

	)

131 
	#MS_PRIVATE
 (1<<18è

	)

132 
	#MS_SLAVE
 (1<<19è

	)

133 
	#MS_SHARED
 (1<<20è

	)

134 
	#MS_NO_LEASES
 (1<<21è

	)

135 
	#MS_HAS_SETLEASE
 (1<<22è

	)

136 
	#MS_I_VERSION
 (1<<23è

	)

137 
	#MS_HAS_NEW_AOPS
 (1<<24è

	)

138 
	#MS_HAS_LAUNDER_PAGE
 (1<<25è

	)

139 
	#MS_ACTIVE
 (1<<30)

	)

140 
	#MS_NOUSER
 (1<<31)

	)

145 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
)

	)

150 
	#MS_MGC_VAL
 0xC0ED0000

	)

151 
	#MS_MGC_MSK
 0xffff0000

	)

155 
	#S_SYNC
 1

	)

156 
	#S_NOATIME
 2

	)

157 
	#S_APPEND
 4

	)

158 
	#S_IMMUTABLE
 8

	)

159 
	#S_DEAD
 16

	)

160 
	#S_NOQUOTA
 32

	)

161 
	#S_DIRSYNC
 64

	)

162 
	#S_NOCMTIME
 128

	)

163 
	#S_SWAPFILE
 256

	)

164 
	#S_PRIVATE
 512

	)

165 
	#S_AUTOMOUNT
 2048

	)

168 
	#S_NOATTRKILL
 65536

	)

183 
	#__IS_FLG
(
šode
,
æg
è((šode)->
i_sb
->
s_æags
 & (æg))

	)

185 
	#IS_RDONLY
(
šode
è((šode)->
i_sb
->
s_æags
 & 
MS_RDONLY
)

	)

186 
	#IS_SYNC
(
šode
è(
	`__IS_FLG
(šode, 
MS_SYNCHRONOUS
) || \

187 ((
šode
)->
i_æags
 & 
S_SYNC
))

	)

188 
	#IS_DIRSYNC
(
šode
è(
	`__IS_FLG
(šode, 
MS_SYNCHRONOUS
|
MS_DIRSYNC
) || \

189 ((
šode
)->
i_æags
 & (
S_SYNC
|
S_DIRSYNC
)))

	)

190 
	#IS_MANDLOCK
(
šode
è
	`__IS_FLG
(šode, 
MS_MANDLOCK
)

	)

191 
	#IS_NOATIME
(
šode
è
	`__IS_FLG
(šode, 
MS_RDONLY
|
MS_NOATIME
)

	)

192 
	#IS_I_VERSION
(
šode
è
	`__IS_FLG
(šode, 
MS_I_VERSION
)

	)

194 
	#IS_NOQUOTA
(
šode
è((šode)->
i_æags
 & 
S_NOQUOTA
)

	)

195 
	#IS_APPEND
(
šode
è((šode)->
i_æags
 & 
S_APPEND
)

	)

196 
	#IS_IMMUTABLE
(
šode
è((šode)->
i_æags
 & 
S_IMMUTABLE
)

	)

197 
	#IS_POSIXACL
(
šode
è
	`__IS_FLG
(šode, 
MS_POSIXACL
)

	)

199 
	#IS_DEADDIR
(
šode
è((šode)->
i_æags
 & 
S_DEAD
)

	)

200 
	#IS_NOCMTIME
(
šode
è((šode)->
i_æags
 & 
S_NOCMTIME
)

	)

201 
	#IS_SWAPFILE
(
šode
è((šode)->
i_æags
 & 
S_SWAPFILE
)

	)

202 
	#IS_PRIVATE
(
šode
è((šode)->
i_æags
 & 
S_PRIVATE
)

	)

203 
	#IS_AUTOMOUNT
(
šode
è((šode)->
i_æags
 & 
S_AUTOMOUNT
)

	)

204 
	#IS_NO_LEASES
(
šode
è
	`__IS_FLG
(šode, 
MS_NO_LEASES
)

	)

205 
	#IS_SETLEASE
(
šode
è
	`__IS_FLG
(šode, 
MS_HAS_SETLEASE
)

	)

206 
	#IS_NEWAOPS
(
šode
è
	`__IS_FLG
(šode, 
MS_HAS_NEW_AOPS
)

	)

207 
	#IS_LAUNDERPAGE
(
šode
è
	`__IS_FLG
(šode, 
MS_HAS_LAUNDER_PAGE
)

	)

212 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

213 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

214 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

215 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

216 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

217 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

218 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

219 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

220 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

221 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

222 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

223 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

225 
	#BLKPG
 
	`_IO
(0x12,105)

	)

229 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

230 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

235 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

236 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

237 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

238 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

239 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

240 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

241 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

243 
	#BMAP_IOCTL
 1

	)

244 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

245 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

246 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

247 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

249 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

250 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

251 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

252 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

253 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

254 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

255 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

256 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

257 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

262 
	#FS_SECRM_FL
 0x00000001

	)

263 
	#FS_UNRM_FL
 0x00000002

	)

264 
	#FS_COMPR_FL
 0x00000004

	)

265 
	#FS_SYNC_FL
 0x00000008

	)

266 
	#FS_IMMUTABLE_FL
 0x00000010

	)

267 
	#FS_APPEND_FL
 0x00000020

	)

268 
	#FS_NODUMP_FL
 0x00000040

	)

269 
	#FS_NOATIME_FL
 0x00000080

	)

271 
	#FS_DIRTY_FL
 0x00000100

	)

272 
	#FS_COMPRBLK_FL
 0x00000200

	)

273 
	#FS_NOCOMP_FL
 0x00000400

	)

274 
	#FS_ECOMPR_FL
 0x00000800

	)

276 
	#FS_BTREE_FL
 0x00001000

	)

277 
	#FS_INDEX_FL
 0x00001000

	)

278 
	#FS_IMAGIC_FL
 0x00002000

	)

279 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

280 
	#FS_NOTAIL_FL
 0x00008000

	)

281 
	#FS_DIRSYNC_FL
 0x00010000

	)

282 
	#FS_TOPDIR_FL
 0x00020000

	)

283 
	#FS_EXTENT_FL
 0x00080000

	)

284 
	#FS_DIRECTIO_FL
 0x00100000

	)

285 
	#FS_RESERVED_FL
 0x80000000

	)

287 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

288 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

291 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

292 
	#SYNC_FILE_RANGE_WRITE
 2

	)

293 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/genhd.h

1 #iâdeà
_LINUX_GENHD_H


2 
	#_LINUX_GENHD_H


	)

12 
	~<lšux/ty³s.h
>

17 
	mDOS_EXTENDED_PARTITION
 = 5,

18 
	mLINUX_EXTENDED_PARTITION
 = 0x85,

19 
	mWIN98_EXTENDED_PARTITION
 = 0x0f,

21 
	mLINUX_SWAP_PARTITION
 = 0x82,

22 
	mLINUX_RAID_PARTITION
 = 0xfd,

24 
	mSOLARIS_X86_PARTITION
 = 
LINUX_SWAP_PARTITION
,

25 
	mNEW_SOLARIS_X86_PARTITION
 = 0xbf,

27 
	mDM6_AUX1PARTITION
 = 0x51,

28 
	mDM6_AUX3PARTITION
 = 0x53,

29 
	mDM6_PARTITION
 = 0x54,

30 
	mEZD_PARTITION
 = 0x55,

32 
	mFREEBSD_PARTITION
 = 0xa5,

33 
	mOPENBSD_PARTITION
 = 0xa6,

34 
	mNETBSD_PARTITION
 = 0xa9,

35 
	mBSDI_PARTITION
 = 0xb7,

36 
	mMINIX_PARTITION
 = 0x81,

37 
	mUNIXWARE_PARTITION
 = 0x63,

41 
	s·¹™iÚ
 {

42 
	mboÙ_šd
;

43 
	mh—d
;

44 
	m£ùÜ
;

45 
	mcyl
;

46 
	msys_šd
;

47 
	m’d_h—d
;

48 
	m’d_£ùÜ
;

49 
	m’d_cyl
;

50 
	m¡¬t_£ù
;

51 
	mÄ_£ùs
;

52 } 
__©Œibu‹__
((
·cked
));

56 #ifdeà
CONFIG_SOLARIS_X86_PARTITION


58 
	#SOLARIS_X86_NUMSLICE
 8

	)

59 
	#SOLARIS_X86_VTOC_SANE
 (0x600DDEEEUL)

	)

61 
	ssŞ¬is_x86_¦iû
 {

62 
__Ë16
 
	ms_g
;

63 
__Ë16
 
	ms_æag
;

64 
__Ë32
 
	ms_¡¬t
;

65 
__Ë32
 
	ms_size
;

68 
	ssŞ¬is_x86_vtoc
 {

69 
	mv_boÙšfo
[3];

70 
__Ë32
 
	mv_§n™y
;

71 
__Ë32
 
	mv_v”siÚ
;

72 
	mv_vŞume
[8];

73 
__Ë16
 
	mv_£ùÜsz
;

74 
__Ë16
 
	mv_Å¬ts
;

75 
	mv_»£rved
[10];

76 
sŞ¬is_x86_¦iû


77 
	mv_¦iû
[
SOLARIS_X86_NUMSLICE
];

78 
	mtime¡amp
[
SOLARIS_X86_NUMSLICE
];

79 
	mv_asciab–
[128];

84 #ifdeà
CONFIG_BSD_DISKLABEL


92 
	#BSD_DISKMAGIC
 (0x82564557ULè

	)

93 
	#BSD_MAXPARTITIONS
 16

	)

94 
	#OPENBSD_MAXPARTITIONS
 16

	)

95 
	#BSD_FS_UNUSED
 0

	)

96 
	sbsd_diskÏb–
 {

97 
__Ë32
 
	md_magic
;

98 
__s16
 
	md_ty³
;

99 
__s16
 
	md_subty³
;

100 
	md_ty³Çme
[16];

101 
	md_·ckÇme
[16];

102 
__u32
 
	md_£csize
;

103 
__u32
 
	md_n£ùÜs
;

104 
__u32
 
	md_Á¿cks
;

105 
__u32
 
	md_ncylšd”s
;

106 
__u32
 
	md_£ı”cyl
;

107 
__u32
 
	md_£ı”un™
;

108 
__u16
 
	md_¥¬e¥”Œack
;

109 
__u16
 
	md_¥¬e¥”cyl
;

110 
__u32
 
	md_acylšd”s
;

111 
__u16
 
	md_½m
;

112 
__u16
 
	md_š‹¾—ve
;

113 
__u16
 
	md_Œackskew
;

114 
__u16
 
	md_cylskew
;

115 
__u32
 
	md_h—dsw™ch
;

116 
__u32
 
	md_Œk£ek
;

117 
__u32
 
	md_æags
;

118 
	#NDDATA
 5

	)

119 
__u32
 
	md_drived©a
[
NDDATA
];

120 
	#NSPARE
 5

	)

121 
__u32
 
	md_¥¬e
[
NSPARE
];

122 
__Ë32
 
	md_magic2
;

123 
__Ë16
 
	md_checksum
;

126 
__Ë16
 
	md_Å¬t™iÚs
;

127 
__Ë32
 
	md_bbsize
;

128 
__Ë32
 
	md_sbsize
;

129 
	sbsd_·¹™iÚ
 {

130 
__Ë32
 
	mp_size
;

131 
__Ë32
 
	mp_off£t
;

132 
__Ë32
 
	mp_fsize
;

133 
__u8
 
	mp_f¡y³
;

134 
__u8
 
	mp_äag
;

135 
__Ë16
 
	mp_ıg
;

136 } 
	md_·¹™iÚs
[
BSD_MAXPARTITIONS
];

141 #ifdeà
CONFIG_UNIXWARE_DISKLABEL


147 
	#UNIXWARE_DISKMAGIC
 (0xCA5E600DULè

	)

148 
	#UNIXWARE_DISKMAGIC2
 (0x600DDEEEULè

	)

149 
	#UNIXWARE_NUMSLICE
 16

	)

150 
	#UNIXWARE_FS_UNUSED
 0

	)

152 
	sunixw¬e_¦iû
 {

153 
__Ë16
 
	ms_Ïb–
;

154 
__Ë16
 
	ms_æags
;

155 
__Ë32
 
	m¡¬t_£ù
;

156 
__Ë32
 
	mÄ_£ùs
;

159 
	sunixw¬e_diskÏb–
 {

160 
__Ë32
 
	md_ty³
;

161 
__Ë32
 
	md_magic
;

162 
__Ë32
 
	md_v”siÚ
;

163 
	md_£rŸl
[12];

164 
__Ë32
 
	md_ncylšd”s
;

165 
__Ë32
 
	md_Á¿cks
;

166 
__Ë32
 
	md_n£ùÜs
;

167 
__Ë32
 
	md_£csize
;

168 
__Ë32
 
	md_·¹_¡¬t
;

169 
__Ë32
 
	md_unknown1
[12];

170 
__Ë32
 
	md_®t_tbl
;

171 
__Ë32
 
	md_®t_Ën
;

172 
__Ë32
 
	md_phys_cyl
;

173 
__Ë32
 
	md_phys_Œk
;

174 
__Ë32
 
	md_phys_£c
;

175 
__Ë32
 
	md_phys_by‹s
;

176 
__Ë32
 
	md_unknown2
;

177 
__Ë32
 
	md_unknown3
;

178 
__Ë32
 
	md_·d
[8];

180 
	sunixw¬e_vtoc
 {

181 
__Ë32
 
	mv_magic
;

182 
__Ë32
 
	mv_v”siÚ
;

183 
	mv_Çme
[8];

184 
__Ë16
 
	mv_n¦iûs
;

185 
__Ë16
 
	mv_unknown1
;

186 
__Ë32
 
	mv_»£rved
[10];

187 
unixw¬e_¦iû


188 
	mv_¦iû
[
UNIXWARE_NUMSLICE
];

189 } 
	mvtoc
;

195 #ifdeà
CONFIG_MINIX_SUBPARTITION


196 
	#MINIX_NR_SUBPARTITIONS
 4

	)

	@/usr/include/linux/hdreg.h

1 #iâdeà
_LINUX_HDREG_H


2 
	#_LINUX_HDREG_H


	)

9 
	#HDIO_DRIVE_CMD_HDR_SIZE
 (4 * (
u8
))

	)

10 
	#HDIO_DRIVE_HOB_HDR_SIZE
 (8 * (
u8
))

	)

11 
	#HDIO_DRIVE_TASK_HDR_SIZE
 (8 * (
u8
))

	)

13 
	#IDE_DRIVE_TASK_INVALID
 -1

	)

14 
	#IDE_DRIVE_TASK_NO_DATA
 0

	)

15 
	#IDE_DRIVE_TASK_SET_XFER
 1

	)

17 
	#IDE_DRIVE_TASK_IN
 2

	)

19 
	#IDE_DRIVE_TASK_OUT
 3

	)

20 
	#IDE_DRIVE_TASK_RAW_WRITE
 4

	)

25 
	#IDE_TASKFILE_STD_IN_FLAGS
 0xFE

	)

26 
	#IDE_HOB_STD_IN_FLAGS
 0x3C

	)

27 
	#IDE_TASKFILE_STD_OUT_FLAGS
 0xFE

	)

28 
	#IDE_HOB_STD_OUT_FLAGS
 0x3C

	)

30 
	tsk_iÜeg_t
;

31 
	t§_iÜeg_t
;

33 
	uide_»g_v®id_s
 {

34 
	m®l
 : 16;

36 
	md©a
 : 1;

37 
	m”rÜ_ã©u»
 : 1;

38 
	m£ùÜ
 : 1;

39 
	mn£ùÜ
 : 1;

40 
	mlcyl
 : 1;

41 
	mhcyl
 : 1;

42 
	m£Ëù
 : 1;

43 
	m¡©us_commªd
 : 1;

45 
	md©a_hob
 : 1;

46 
	m”rÜ_ã©u»_hob
 : 1;

47 
	m£ùÜ_hob
 : 1;

48 
	mn£ùÜ_hob
 : 1;

49 
	mlcyl_hob
 : 1;

50 
	mhcyl_hob
 : 1;

51 
	m£Ëù_hob
 : 1;

52 
	mcÚŒŞ_hob
 : 1;

53 } 
	mb
;

54 } 
	tide_»g_v®id_t
;

56 
	side_sk_»que¡_s
 {

57 
sk_iÜeg_t
 
	mio_pÜts
[8];

58 
sk_iÜeg_t
 
	mhob_pÜts
[8];

59 
ide_»g_v®id_t
 
	mout_æags
;

60 
ide_»g_v®id_t
 
	mš_æags
;

61 
	md©a_pha£
;

62 
	m»q_cmd
;

63 
	mout_size
;

64 
	mš_size
;

65 } 
	tide_sk_»que¡_t
;

67 
	side_ioùl_»que¡_s
 {

68 
ide_sk_»que¡_t
 *
	msk_»que¡
;

69 *
	mout_bufãr
;

70 *
	mš_bufãr
;

71 } 
	tide_ioùl_»que¡_t
;

73 
	shd_drive_cmd_hdr
 {

74 
sk_iÜeg_t
 
	mcommªd
;

75 
sk_iÜeg_t
 
	m£ùÜ_numb”
;

76 
sk_iÜeg_t
 
	mã©u»
;

77 
sk_iÜeg_t
 
	m£ùÜ_couÁ
;

80 
	shd_drive_sk_hdr
 {

81 
sk_iÜeg_t
 
	md©a
;

82 
sk_iÜeg_t
 
	mã©u»
;

83 
sk_iÜeg_t
 
	m£ùÜ_couÁ
;

84 
sk_iÜeg_t
 
	m£ùÜ_numb”
;

85 
sk_iÜeg_t
 
	mlow_cylšd”
;

86 
sk_iÜeg_t
 
	mhigh_cylšd”
;

87 
sk_iÜeg_t
 
	mdeviû_h—d
;

88 
sk_iÜeg_t
 
	mcommªd
;

89 } 
	tsk_¡ruù_t
;

91 
	shd_drive_hob_hdr
 {

92 
sk_iÜeg_t
 
	md©a
;

93 
sk_iÜeg_t
 
	mã©u»
;

94 
sk_iÜeg_t
 
	m£ùÜ_couÁ
;

95 
sk_iÜeg_t
 
	m£ùÜ_numb”
;

96 
sk_iÜeg_t
 
	mlow_cylšd”
;

97 
sk_iÜeg_t
 
	mhigh_cylšd”
;

98 
sk_iÜeg_t
 
	mdeviû_h—d
;

99 
sk_iÜeg_t
 
	mcÚŒŞ
;

100 } 
	thob_¡ruù_t
;

102 
	#TASKFILE_INVALID
 0x7fff

	)

103 
	#TASKFILE_48
 0x8000

	)

105 
	#TASKFILE_NO_DATA
 0x0000

	)

107 
	#TASKFILE_IN
 0x0001

	)

108 
	#TASKFILE_MULTI_IN
 0x0002

	)

110 
	#TASKFILE_OUT
 0x0004

	)

111 
	#TASKFILE_MULTI_OUT
 0x0008

	)

112 
	#TASKFILE_IN_OUT
 0x0010

	)

114 
	#TASKFILE_IN_DMA
 0x0020

	)

115 
	#TASKFILE_OUT_DMA
 0x0040

	)

116 
	#TASKFILE_IN_DMAQ
 0x0080

	)

117 
	#TASKFILE_OUT_DMAQ
 0x0100

	)

119 
	#TASKFILE_P_IN
 0x0200

	)

120 
	#TASKFILE_P_OUT
 0x0400

	)

121 
	#TASKFILE_P_IN_DMA
 0x0800

	)

122 
	#TASKFILE_P_OUT_DMA
 0x1000

	)

123 
	#TASKFILE_P_IN_DMAQ
 0x2000

	)

124 
	#TASKFILE_P_OUT_DMAQ
 0x4000

	)

127 
	#WIN_NOP
 0x00

	)

131 
	#CFA_REQ_EXT_ERROR_CODE
 0x03

	)

135 
	#WIN_SRST
 0x08

	)

136 
	#WIN_DEVICE_RESET
 0x08

	)

140 
	#WIN_RECAL
 0x10

	)

141 
	#WIN_RESTORE
 
WIN_RECAL


	)

145 
	#WIN_READ
 0x20

	)

146 
	#WIN_READ_ONCE
 0x21

	)

147 
	#WIN_READ_LONG
 0x22

	)

148 
	#WIN_READ_LONG_ONCE
 0x23

	)

149 
	#WIN_READ_EXT
 0x24

	)

150 
	#WIN_READDMA_EXT
 0x25

	)

151 
	#WIN_READDMA_QUEUED_EXT
 0x26

	)

152 
	#WIN_READ_NATIVE_MAX_EXT
 0x27

	)

156 
	#WIN_MULTREAD_EXT
 0x29

	)

160 
	#WIN_WRITE
 0x30

	)

161 
	#WIN_WRITE_ONCE
 0x31

	)

162 
	#WIN_WRITE_LONG
 0x32

	)

163 
	#WIN_WRITE_LONG_ONCE
 0x33

	)

164 
	#WIN_WRITE_EXT
 0x34

	)

165 
	#WIN_WRITEDMA_EXT
 0x35

	)

166 
	#WIN_WRITEDMA_QUEUED_EXT
 0x36

	)

167 
	#WIN_SET_MAX_EXT
 0x37

	)

168 
	#CFA_WRITE_SECT_WO_ERASE
 0x38

	)

169 
	#WIN_MULTWRITE_EXT
 0x39

	)

173 
	#WIN_WRITE_VERIFY
 0x3C

	)

177 
	#WIN_VERIFY
 0x40

	)

178 
	#WIN_VERIFY_ONCE
 0x41

	)

179 
	#WIN_VERIFY_EXT
 0x42

	)

183 
	#WIN_FORMAT
 0x50

	)

187 
	#WIN_INIT
 0x60

	)

191 
	#WIN_SEEK
 0x70

	)

193 
	#CFA_TRANSLATE_SECTOR
 0x87

	)

194 
	#WIN_DIAGNOSE
 0x90

	)

195 
	#WIN_SPECIFY
 0x91

	)

196 
	#WIN_DOWNLOAD_MICROCODE
 0x92

	)

197 
	#WIN_STANDBYNOW2
 0x94

	)

198 
	#WIN_STANDBY2
 0x96

	)

199 
	#WIN_SETIDLE2
 0x97

	)

200 
	#WIN_CHECKPOWERMODE2
 0x98

	)

201 
	#WIN_SLEEPNOW2
 0x99

	)

205 
	#WIN_PACKETCMD
 0xA0

	)

206 
	#WIN_PIDENTIFY
 0xA1

	)

207 
	#WIN_QUEUED_SERVICE
 0xA2

	)

208 
	#WIN_SMART
 0xB0

	)

209 
	#CFA_ERASE_SECTORS
 0xC0

	)

210 
	#WIN_MULTREAD
 0xC4

	)

211 
	#WIN_MULTWRITE
 0xC5

	)

212 
	#WIN_SETMULT
 0xC6

	)

213 
	#WIN_READDMA_QUEUED
 0xC7

	)

214 
	#WIN_READDMA
 0xC8

	)

215 
	#WIN_READDMA_ONCE
 0xC9

	)

216 
	#WIN_WRITEDMA
 0xCA

	)

217 
	#WIN_WRITEDMA_ONCE
 0xCB

	)

218 
	#WIN_WRITEDMA_QUEUED
 0xCC

	)

219 
	#CFA_WRITE_MULTI_WO_ERASE
 0xCD

	)

220 
	#WIN_GETMEDIASTATUS
 0xDA

	)

221 
	#WIN_ACKMEDIACHANGE
 0xDB

	)

222 
	#WIN_POSTBOOT
 0xDC

	)

223 
	#WIN_PREBOOT
 0xDD

	)

224 
	#WIN_DOORLOCK
 0xDE

	)

225 
	#WIN_DOORUNLOCK
 0xDF

	)

226 
	#WIN_STANDBYNOW1
 0xE0

	)

227 
	#WIN_IDLEIMMEDIATE
 0xE1

	)

228 
	#WIN_STANDBY
 0xE2

	)

229 
	#WIN_SETIDLE1
 0xE3

	)

230 
	#WIN_READ_BUFFER
 0xE4

	)

231 
	#WIN_CHECKPOWERMODE1
 0xE5

	)

232 
	#WIN_SLEEPNOW1
 0xE6

	)

233 
	#WIN_FLUSH_CACHE
 0xE7

	)

234 
	#WIN_WRITE_BUFFER
 0xE8

	)

235 
	#WIN_WRITE_SAME
 0xE9

	)

237 
	#WIN_FLUSH_CACHE_EXT
 0xEA

	)

238 
	#WIN_IDENTIFY
 0xEC

	)

239 
	#WIN_MEDIAEJECT
 0xED

	)

240 
	#WIN_IDENTIFY_DMA
 0xEE

	)

241 
	#WIN_SETFEATURES
 0xEF

	)

242 
	#EXABYTE_ENABLE_NEST
 0xF0

	)

243 
	#WIN_SECURITY_SET_PASS
 0xF1

	)

244 
	#WIN_SECURITY_UNLOCK
 0xF2

	)

245 
	#WIN_SECURITY_ERASE_PREPARE
 0xF3

	)

246 
	#WIN_SECURITY_ERASE_UNIT
 0xF4

	)

247 
	#WIN_SECURITY_FREEZE_LOCK
 0xF5

	)

248 
	#WIN_SECURITY_DISABLE
 0xF6

	)

249 
	#WIN_READ_NATIVE_MAX
 0xF8

	)

250 
	#WIN_SET_MAX
 0xF9

	)

251 
	#DISABLE_SEAGATE
 0xFB

	)

255 
	#SMART_READ_VALUES
 0xD0

	)

256 
	#SMART_READ_THRESHOLDS
 0xD1

	)

257 
	#SMART_AUTOSAVE
 0xD2

	)

258 
	#SMART_SAVE
 0xD3

	)

259 
	#SMART_IMMEDIATE_OFFLINE
 0xD4

	)

260 
	#SMART_READ_LOG_SECTOR
 0xD5

	)

261 
	#SMART_WRITE_LOG_SECTOR
 0xD6

	)

262 
	#SMART_WRITE_THRESHOLDS
 0xD7

	)

263 
	#SMART_ENABLE
 0xD8

	)

264 
	#SMART_DISABLE
 0xD9

	)

265 
	#SMART_STATUS
 0xDA

	)

266 
	#SMART_AUTO_OFFLINE
 0xDB

	)

270 
	#SMART_LCYL_PASS
 0x4F

	)

271 
	#SMART_HCYL_PASS
 0xC2

	)

274 
	#SETFEATURES_EN_8BIT
 0x01

	)

275 
	#SETFEATURES_EN_WCACHE
 0x02

	)

276 
	#SETFEATURES_DIS_DEFECT
 0x04

	)

277 
	#SETFEATURES_EN_APM
 0x05

	)

278 
	#SETFEATURES_EN_SAME_R
 0x22

	)

279 
	#SETFEATURES_DIS_MSN
 0x31

	)

280 
	#SETFEATURES_DIS_RETRY
 0x33

	)

281 
	#SETFEATURES_EN_AAM
 0x42

	)

282 
	#SETFEATURES_RW_LONG
 0x44

	)

283 
	#SETFEATURES_SET_CACHE
 0x54

	)

284 
	#SETFEATURES_DIS_RLA
 0x55

	)

285 
	#SETFEATURES_EN_RI
 0x5D

	)

286 
	#SETFEATURES_EN_SI
 0x5E

	)

287 
	#SETFEATURES_DIS_RPOD
 0x66

	)

288 
	#SETFEATURES_DIS_ECC
 0x77

	)

289 
	#SETFEATURES_DIS_8BIT
 0x81

	)

290 
	#SETFEATURES_DIS_WCACHE
 0x82

	)

291 
	#SETFEATURES_EN_DEFECT
 0x84

	)

292 
	#SETFEATURES_DIS_APM
 0x85

	)

293 
	#SETFEATURES_EN_ECC
 0x88

	)

294 
	#SETFEATURES_EN_MSN
 0x95

	)

295 
	#SETFEATURES_EN_RETRY
 0x99

	)

296 
	#SETFEATURES_EN_RLA
 0xAA

	)

297 
	#SETFEATURES_PREFETCH
 0xAB

	)

298 
	#SETFEATURES_EN_REST
 0xAC

	)

299 
	#SETFEATURES_4B_RW_LONG
 0xBB

	)

300 
	#SETFEATURES_DIS_AAM
 0xC2

	)

301 
	#SETFEATURES_EN_RPOD
 0xCC

	)

302 
	#SETFEATURES_DIS_RI
 0xDD

	)

303 
	#SETFEATURES_EN_SAME_M
 0xDD

	)

304 
	#SETFEATURES_DIS_SI
 0xDE

	)

308 
	#SECURITY_SET_PASSWORD
 0xBA

	)

309 
	#SECURITY_UNLOCK
 0xBB

	)

310 
	#SECURITY_ERASE_PREPARE
 0xBC

	)

311 
	#SECURITY_ERASE_UNIT
 0xBD

	)

312 
	#SECURITY_FREEZE_LOCK
 0xBE

	)

313 
	#SECURITY_DISABLE_PASSWORD
 0xBF

	)

315 
	shd_geom‘ry
 {

316 
	mh—ds
;

317 
	m£ùÜs
;

318 
	mcylšd”s
;

319 
	m¡¬t
;

323 
	#HDIO_GETGEO
 0x0301

	)

324 
	#HDIO_GET_UNMASKINTR
 0x0302

	)

325 
	#HDIO_GET_MULTCOUNT
 0x0304

	)

326 
	#HDIO_GET_QDMA
 0x0305

	)

328 
	#HDIO_SET_XFER
 0x0306

	)

330 
	#HDIO_OBSOLETE_IDENTITY
 0x0307

	)

331 
	#HDIO_GET_KEEPSETTINGS
 0x0308

	)

332 
	#HDIO_GET_32BIT
 0x0309

	)

333 
	#HDIO_GET_NOWERR
 0x030¨

	)

334 
	#HDIO_GET_DMA
 0x030b

	)

335 
	#HDIO_GET_NICE
 0x030ø

	)

336 
	#HDIO_GET_IDENTITY
 0x030d

	)

337 
	#HDIO_GET_WCACHE
 0x030

	)

338 
	#HDIO_GET_ACOUSTIC
 0x030à

	)

339 
	#HDIO_GET_ADDRESS
 0x0310

	)

341 
	#HDIO_GET_BUSSTATE
 0x031¨

	)

342 
	#HDIO_TRISTATE_HWIF
 0x031b

	)

343 
	#HDIO_DRIVE_RESET
 0x031ø

	)

344 
	#HDIO_DRIVE_TASKFILE
 0x031d

	)

345 
	#HDIO_DRIVE_TASK
 0x031

	)

346 
	#HDIO_DRIVE_CMD
 0x031à

	)

347 
	#HDIO_DRIVE_CMD_AEB
 
HDIO_DRIVE_TASK


	)

350 
	#HDIO_SET_MULTCOUNT
 0x0321

	)

351 
	#HDIO_SET_UNMASKINTR
 0x0322

	)

352 
	#HDIO_SET_KEEPSETTINGS
 0x0323

	)

353 
	#HDIO_SET_32BIT
 0x0324

	)

354 
	#HDIO_SET_NOWERR
 0x0325

	)

355 
	#HDIO_SET_DMA
 0x0326

	)

356 
	#HDIO_SET_PIO_MODE
 0x0327

	)

357 
	#HDIO_SCAN_HWIF
 0x0328

	)

358 
	#HDIO_SET_NICE
 0x0329

	)

359 
	#HDIO_UNREGISTER_HWIF
 0x032¨

	)

360 
	#HDIO_SET_WCACHE
 0x032b

	)

361 
	#HDIO_SET_ACOUSTIC
 0x032ø

	)

362 
	#HDIO_SET_BUSSTATE
 0x032d

	)

363 
	#HDIO_SET_QDMA
 0x032

	)

364 
	#HDIO_SET_ADDRESS
 0x032à

	)

368 
	mBUSSTATE_OFF
 = 0,

369 
	mBUSSTATE_ON
,

370 
	mBUSSTATE_TRISTATE


379 
	#__NEW_HD_DRIVE_ID


	)

387 
	shd_driveid
 {

388 
	mcÚfig
;

389 
	mcyls
;

390 
	m»£rved2
;

391 
	mh—ds
;

392 
	mŒack_by‹s
;

393 
	m£ùÜ_by‹s
;

394 
	m£ùÜs
;

395 
	mv’dÜ0
;

396 
	mv’dÜ1
;

397 
	mv’dÜ2
;

398 
	m£rŸl_no
[20];

399 
	mbuf_ty³
;

400 
	mbuf_size
;

403 
	mecc_by‹s
;

404 
	mfw_»v
[8];

405 
	mmod–
[40];

406 
	mmax_muÉ£ù
;

407 
	mv’dÜ3
;

408 
	mdwÜd_io
;

409 
	mv’dÜ4
;

410 
	mÿ·b™y
;

416 
	m»£rved50
;

417 
	mv’dÜ5
;

418 
	mtPIO
;

419 
	mv’dÜ6
;

420 
	mtDMA
;

421 
	mf›ld_v®id
;

426 
	mcur_cyls
;

427 
	mcur_h—ds
;

428 
	mcur_£ùÜs
;

429 
	mcur_ÿ·c™y0
;

430 
	mcur_ÿ·c™y1
;

431 
	mmuÉ£ù
;

432 
	mmuÉ£ù_v®id
;

433 
	mlba_ÿ·c™y
;

434 
	mdma_1wÜd
;

435 
	mdma_mwÜd
;

436 
	meide_pio_modes
;

437 
	meide_dma_mš
;

438 
	meide_dma_time
;

439 
	meide_pio
;

440 
	meide_pio_iÜdy
;

441 
	mwÜds69_70
[2];

445 
	mwÜds71_74
[4];

448 
	mqueue_d•th
;

452 
	mwÜds76_79
[4];

453 
	mmajÜ_»v_num
;

454 
	mmšÜ_»v_num
;

455 
	mcommªd_£t_1
;

473 
	mcommªd_£t_2
;

491 
	mcfs£
;

503 
	mcfs_’abË_1
;

522 
	mcfs_’abË_2
;

541 
	mcsf_deçuÉ
;

553 
	mdma_uÉ¿
;

554 
	mŒ£uc
;

555 
	mŒsEuc
;

556 
	mCurAPMv®ues
;

557 
	mm´c
;

558 
	mhw_cÚfig
;

576 
	macou¡ic
;

580 
	mm¤qs
;

581 
	msxã¹
;

582 
	m§l
;

583 
	m¥g
;

584 
	mlba_ÿ·c™y_2
;

585 
	mwÜds104_125
[22];

586 
	mÏ¡_lun
;

587 
	mwÜd127
;

595 
	mdlf
;

607 
	mcsfo
;

615 
	mwÜds130_155
[26];

616 
	mwÜd156
;

617 
	mwÜds157_159
[3];

618 
	mcç_pow”
;

625 
	mwÜds161_175
[15];

626 
	mwÜds176_205
[30];

627 
	mwÜds206_254
[49];

628 
	mš‹gr™y_wÜd
;

639 
	#IDE_NICE_DSC_OVERLAP
 (0è

	)

640 
	#IDE_NICE_ATAPI_OVERLAP
 (1è

	)

641 
	#IDE_NICE_0
 (2è

	)

642 
	#IDE_NICE_1
 (3è

	)

643 
	#IDE_NICE_2
 (4è

	)

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/linux/kdev_t.h

1 #iâdeà
_LINUX_KDEV_T_H


2 
	#_LINUX_KDEV_T_H


	)

8 
	#MAJOR
(
dev
è((dev)>>8)

	)

9 
	#MINOR
(
dev
è((devè& 0xff)

	)

10 
	#MKDEV
(
ma
,
mi
è((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

9 
	#SI_LOAD_SHIFT
 16

	)

10 
	ssysšfo
 {

11 
	mu±ime
;

12 
	mlßds
[3];

13 
	mtÙ®¿m
;

14 
	mä“¿m
;

15 
	msh¬ed¿m
;

16 
	mbufã¼am
;

17 
	mtÙ®sw­
;

18 
	mä“sw­
;

19 
	m´ocs
;

20 
	m·d
;

21 
	mtÙ®high
;

22 
	mä“high
;

23 
	mmem_un™
;

24 
	m_f
[20-2*()-()];

28 
	#BUILD_BUG_ON
(
cÚd™iÚ
è(()([1 - 2*!!(cÚd™iÚ)]))

	)

31 
	#BUILD_BUG_ON_NOT_POWER_OF_2
(
n
) \

32 
	`BUILD_BUG_ON
((
n
è=ğ0 || ((Òè& (Òè- 1)è!ğ0))

	)

38 
	#BUILD_BUG_ON_ZERO
(
e
è(([1 - 2 * !!Ó)]è- 1)

	)

41 
	#__FUNCTION__
 (
__func__
)

	)

43 
	gmoduË
;

45 
m¬k_h¬dw¬e_unsuµÜ‹d
(cÚ¡ *
msg
);

46 
m¬k_‹ch_´ev›w
(cÚ¡ *
msg
, 
moduË
 *
mod
);

	@/usr/include/linux/pci.h

17 #iâdeà
LINUX_PCI_H


18 
	#LINUX_PCI_H


	)

21 
	~<lšux/pci_»gs.h
>

24 
	~<lšux/pci_ids.h
>

34 
	#PCI_DEVFN
(
¦Ù
,
func
è((((¦Ùè& 0x1fè<< 3è| ((funcè& 0x07))

	)

35 
	#PCI_SLOT
(
devâ
è(((devâè>> 3è& 0x1f)

	)

36 
	#PCI_FUNC
(
devâ
è((devâè& 0x07)

	)

39 
	#PCIIOC_BASE
 ('P' << 24 | 'C' << 16 | 'I' << 8)

	)

40 
	#PCIIOC_CONTROLLER
 (
PCIIOC_BASE
 | 0x00è

	)

41 
	#PCIIOC_MMAP_IS_IO
 (
PCIIOC_BASE
 | 0x01è

	)

42 
	#PCIIOC_MMAP_IS_MEM
 (
PCIIOC_BASE
 | 0x02è

	)

43 
	#PCIIOC_WRITE_COMBINE
 (
PCIIOC_BASE
 | 0x03è

	)

	@/usr/include/linux/random.h

7 #iâdeà
_LINUX_RANDOM_H


8 
	#_LINUX_RANDOM_H


	)

10 
	~<lšux/ioùl.h
>

15 
	#RNDGETENTCNT
 
	`_IOR
Ğ'R', 0x00, )

	)

18 
	#RNDADDTOENTCNT
 
	`_IOW
Ğ'R', 0x01, )

	)

21 
	#RNDGETPOOL
 
	`_IOR
Ğ'R', 0x02, [2] )

	)

27 
	#RNDADDENTROPY
 
	`_IOW
Ğ'R', 0x03, [2] )

	)

30 
	#RNDZAPENTCNT
 
	`_IO
Ğ'R', 0x04 )

	)

33 
	#RNDCLEARPOOL
 
	`_IO
Ğ'R', 0x06 )

	)

35 
	s¿nd_poŞ_šfo
 {

36 
	m’Œİy_couÁ
;

37 
	mbuf_size
;

38 
__u32
 
	mbuf
[0];

41 
	sºd_¡©e
 {

42 
__u32
 
	ms1
, 
	ms2
, 
	ms3
;

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

4 
	~<lšux/auxvec.h
>

9 
	#CSIGNAL
 0x000000fà

	)

10 
	#CLONE_VM
 0x00000100

	)

11 
	#CLONE_FS
 0x00000200

	)

12 
	#CLONE_FILES
 0x00000400

	)

13 
	#CLONE_SIGHAND
 0x00000800

	)

14 
	#CLONE_PTRACE
 0x00002000

	)

15 
	#CLONE_VFORK
 0x00004000

	)

16 
	#CLONE_PARENT
 0x00008000

	)

17 
	#CLONE_THREAD
 0x00010000

	)

18 
	#CLONE_NEWNS
 0x00020000

	)

19 
	#CLONE_SYSVSEM
 0x00040000

	)

20 
	#CLONE_SETTLS
 0x00080000

	)

21 
	#CLONE_PARENT_SETTID
 0x00100000

	)

22 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

23 
	#CLONE_DETACHED
 0x00400000

	)

24 
	#CLONE_UNTRACED
 0x00800000

	)

25 
	#CLONE_CHILD_SETTID
 0x01000000

	)

26 
	#CLONE_STOPPED
 0x02000000

	)

31 
	#SCHED_NORMAL
 0

	)

32 
	#SCHED_FIFO
 1

	)

33 
	#SCHED_RR
 2

	)

34 
	#SCHED_BATCH
 3

	)

	@/usr/include/linux/time.h

1 #iâdeà
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<lšux/ty³s.h
>

7 #iâdeà
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime¥ec
 {

10 
time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimev®
 {

16 
time_t
 
	mtv_£c
;

17 
su£cÚds_t
 
	mtv_u£c
;

20 
	stimezÚe
 {

21 
	mtz_mšu‹swe¡
;

22 
	mtz_d¡time
;

26 
	#NFDBITS
 
__NFDBITS


	)

28 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

29 
	#FD_SET
(
fd
,
fd£
è
	`__FD_SET
(fd,fd£)

	)

30 
	#FD_CLR
(
fd
,
fd£
è
	`__FD_CLR
(fd,fd£)

	)

31 
	#FD_ISSET
(
fd
,
fd£
è
	`__FD_ISSET
(fd,fd£)

	)

32 
	#FD_ZERO
(
fd£
è
	`__FD_ZERO
(fd£)

	)

38 
	#ITIMER_REAL
 0

	)

39 
	#ITIMER_VIRTUAL
 1

	)

40 
	#ITIMER_PROF
 2

	)

42 
	s™im”¥ec
 {

43 
time¥ec
 
	m™_š‹rv®
;

44 
time¥ec
 
	m™_v®ue
;

47 
	s™im”v®
 {

48 
timev®
 
	m™_š‹rv®
;

49 
timev®
 
	m™_v®ue
;

55 
	#CLOCK_REALTIME
 0

	)

56 
	#CLOCK_MONOTONIC
 1

	)

57 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

58 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

63 
	#CLOCK_SGI_CYCLE
 10

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

5 
	~<lšux/posix_ty³s.h
>

6 
	~<asm/ty³s.h
>

8 #iâdeà
__KERNEL_STRICT_NAMES


10 
__u32
 
	t__k”Ãl_dev_t
;

12 
__k”Ãl_fd_£t
 
	tfd_£t
;

13 
__k”Ãl_dev_t
 
	tdev_t
;

14 
__k”Ãl_šo_t
 
	tšo_t
;

15 
__k”Ãl_mode_t
 
	tmode_t
;

16 
__k”Ãl_Æšk_t
 
	tÆšk_t
;

17 
__k”Ãl_off_t
 
	toff_t
;

18 
__k”Ãl_pid_t
 
	tpid_t
;

19 
__k”Ãl_daddr_t
 
	tdaddr_t
;

20 
__k”Ãl_key_t
 
	tkey_t
;

21 
__k”Ãl_su£cÚds_t
 
	tsu£cÚds_t
;

22 
__k”Ãl_tim”_t
 
	ttim”_t
;

23 
__k”Ãl_şockid_t
 
	tşockid_t
;

24 
__k”Ãl_mqd_t
 
	tmqd_t
;

26 
__k”Ãl_uid_t
 
	tuid_t
;

27 
__k”Ãl_gid_t
 
	tgid_t
;

29 #ià
defšed
(
__GNUC__
è&& !defšed(
__STRICT_ANSI__
)

30 
__k”Ãl_loff_t
 
	tloff_t
;

37 #iâdeà
_SIZE_T


38 
	#_SIZE_T


	)

39 
__k”Ãl_size_t
 
	tsize_t
;

42 #iâdeà
_SSIZE_T


43 
	#_SSIZE_T


	)

44 
__k”Ãl_ssize_t
 
	tssize_t
;

47 #iâdeà
_PTRDIFF_T


48 
	#_PTRDIFF_T


	)

49 
__k”Ãl_±rdiff_t
 
	t±rdiff_t
;

52 #iâdeà
_TIME_T


53 
	#_TIME_T


	)

54 
__k”Ãl_time_t
 
	ttime_t
;

57 #iâdeà
_CLOCK_T


58 
	#_CLOCK_T


	)

59 
__k”Ãl_şock_t
 
	tşock_t
;

62 #iâdeà
_CADDR_T


63 
	#_CADDR_T


	)

64 
__k”Ãl_ÿddr_t
 
	tÿddr_t
;

68 
	tu_ch¬
;

69 
	tu_shÜt
;

70 
	tu_št
;

71 
	tu_lÚg
;

74 
	tunch¬
;

75 
	tushÜt
;

76 
	tušt
;

77 
	tulÚg
;

79 #iâdeà
__BIT_TYPES_DEFINED__


80 
	#__BIT_TYPES_DEFINED__


	)

82 
__u8
 
	tu_št8_t
;

83 
__s8
 
	tšt8_t
;

84 
__u16
 
	tu_št16_t
;

85 
__s16
 
	tšt16_t
;

86 
__u32
 
	tu_št32_t
;

87 
__s32
 
	tšt32_t
;

91 
__u8
 
	tušt8_t
;

92 
__u16
 
	tušt16_t
;

93 
__u32
 
	tušt32_t
;

95 #ià
defšed
(
__GNUC__
è&& !defšed(
__STRICT_ANSI__
)

96 
__u64
 
	tušt64_t
;

97 
__u64
 
	tu_št64_t
;

98 
__s64
 
	tšt64_t
;

102 
	#®igÃd_u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

109 #iâdeà
HAVE_SECTOR_T


110 
	t£ùÜ_t
;

113 #iâdeà
HAVE_BLKCNT_T


114 
	tblkút_t
;

121 #iâdeà
pgoff_t


122 
	#pgoff_t
 

	)

132 #ifdeà
__CHECKER__


133 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

135 
	#__b™wi£__


	)

137 #ifdeà
__CHECK_ENDIAN__


138 
	#__b™wi£
 
__b™wi£__


	)

140 
	#__b™wi£


	)

143 
__u16
 
	t__b™wi£
 
	t__Ë16
;

144 
__u16
 
	t__b™wi£
 
	t__be16
;

145 
__u32
 
	t__b™wi£
 
	t__Ë32
;

146 
__u32
 
	t__b™wi£
 
	t__be32
;

147 #ià
defšed
(
__GNUC__
è&& !defšed(
__STRICT_ANSI__
)

148 
__u64
 
	t__b™wi£
 
	t__Ë64
;

149 
__u64
 
	t__b™wi£
 
	t__be64
;

152 
__u16
 
	t__b™wi£
 
	t__sum16
;

153 
__u32
 
	t__b™wi£
 
	t__wsum
;

156 
	su¡©
 {

157 
__k”Ãl_daddr_t
 
	mf_tä“
;

158 
__k”Ãl_šo_t
 
	mf_tšode
;

159 
	mf_âame
[6];

160 
	mf_åack
[6];

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 132626

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

3 
	#RHEL_MAJOR
 5

	)

4 
	#RHEL_MINOR
 11

	)

5 
	#RHEL_RELEASE_CODE
 1291

	)

6 
	#RHEL_RELEASE_VERSION
(
a
,
b
è((×è<< 8è+ (b))

	)

	@/usr/include/linux/wait.h

1 #iâdeà
_LINUX_WAIT_H


2 
	#_LINUX_WAIT_H


	)

4 
	#WNOHANG
 0x00000001

	)

5 
	#WUNTRACED
 0x00000002

	)

6 
	#WSTOPPED
 
WUNTRACED


	)

7 
	#WEXITED
 0x00000004

	)

8 
	#WCONTINUED
 0x00000008

	)

9 
	#WNOWAIT
 0x01000000

	)

11 
	#__WNOTHREAD
 0x20000000

	)

12 
	#__WALL
 0x40000000

	)

13 
	#__WCLONE
 0x80000000

	)

16 
	#P_ALL
 0

	)

17 
	#P_PID
 1

	)

18 
	#P_PGID
 2

	)

	@/usr/include/scsi/scsi.h

24 #iâdeà
_SCSI_SCSI_H


25 
	#_SCSI_SCSI_H
 1

	)

27 
	~<ã©u»s.h
>

33 
	#TEST_UNIT_READY
 0x00

	)

34 
	#REZERO_UNIT
 0x01

	)

35 
	#REQUEST_SENSE
 0x03

	)

36 
	#FORMAT_UNIT
 0x04

	)

37 
	#READ_BLOCK_LIMITS
 0x05

	)

38 
	#REASSIGN_BLOCKS
 0x07

	)

39 
	#READ_6
 0x08

	)

40 
	#WRITE_6
 0x0a

	)

41 
	#SEEK_6
 0x0b

	)

42 
	#READ_REVERSE
 0x0f

	)

43 
	#WRITE_FILEMARKS
 0x10

	)

44 
	#SPACE
 0x11

	)

45 
	#INQUIRY
 0x12

	)

46 
	#RECOVER_BUFFERED_DATA
 0x14

	)

47 
	#MODE_SELECT
 0x15

	)

48 
	#RESERVE
 0x16

	)

49 
	#RELEASE
 0x17

	)

50 
	#COPY
 0x18

	)

51 
	#ERASE
 0x19

	)

52 
	#MODE_SENSE
 0x1a

	)

53 
	#START_STOP
 0x1b

	)

54 
	#RECEIVE_DIAGNOSTIC
 0x1c

	)

55 
	#SEND_DIAGNOSTIC
 0x1d

	)

56 
	#ALLOW_MEDIUM_REMOVAL
 0x1e

	)

58 
	#SET_WINDOW
 0x24

	)

59 
	#READ_CAPACITY
 0x25

	)

60 
	#READ_10
 0x28

	)

61 
	#WRITE_10
 0x2a

	)

62 
	#SEEK_10
 0x2b

	)

63 
	#WRITE_VERIFY
 0x2e

	)

64 
	#VERIFY
 0x2f

	)

65 
	#SEARCH_HIGH
 0x30

	)

66 
	#SEARCH_EQUAL
 0x31

	)

67 
	#SEARCH_LOW
 0x32

	)

68 
	#SET_LIMITS
 0x33

	)

69 
	#PRE_FETCH
 0x34

	)

70 
	#READ_POSITION
 0x34

	)

71 
	#SYNCHRONIZE_CACHE
 0x35

	)

72 
	#LOCK_UNLOCK_CACHE
 0x36

	)

73 
	#READ_DEFECT_DATA
 0x37

	)

74 
	#MEDIUM_SCAN
 0x38

	)

75 
	#COMPARE
 0x39

	)

76 
	#COPY_VERIFY
 0x3a

	)

77 
	#WRITE_BUFFER
 0x3b

	)

78 
	#READ_BUFFER
 0x3c

	)

79 
	#UPDATE_BLOCK
 0x3d

	)

80 
	#READ_LONG
 0x3e

	)

81 
	#WRITE_LONG
 0x3f

	)

82 
	#CHANGE_DEFINITION
 0x40

	)

83 
	#WRITE_SAME
 0x41

	)

84 
	#READ_TOC
 0x43

	)

85 
	#LOG_SELECT
 0x4c

	)

86 
	#LOG_SENSE
 0x4d

	)

87 
	#MODE_SELECT_10
 0x55

	)

88 
	#RESERVE_10
 0x56

	)

89 
	#RELEASE_10
 0x57

	)

90 
	#MODE_SENSE_10
 0x5a

	)

91 
	#PERSISTENT_RESERVE_IN
 0x5e

	)

92 
	#PERSISTENT_RESERVE_OUT
 0x5f

	)

93 
	#MOVE_MEDIUM
 0xa5

	)

94 
	#READ_12
 0xa8

	)

95 
	#WRITE_12
 0x¯

	)

96 
	#WRITE_VERIFY_12
 0x«

	)

97 
	#SEARCH_HIGH_12
 0xb0

	)

98 
	#SEARCH_EQUAL_12
 0xb1

	)

99 
	#SEARCH_LOW_12
 0xb2

	)

100 
	#READ_ELEMENT_STATUS
 0xb8

	)

101 
	#SEND_VOLUME_TAG
 0xb6

	)

102 
	#WRITE_LONG_2
 0x—

	)

108 
	#GOOD
 0x00

	)

109 
	#CHECK_CONDITION
 0x01

	)

110 
	#CONDITION_GOOD
 0x02

	)

111 
	#BUSY
 0x04

	)

112 
	#INTERMEDIATE_GOOD
 0x08

	)

113 
	#INTERMEDIATE_C_GOOD
 0x0a

	)

114 
	#RESERVATION_CONFLICT
 0x0c

	)

115 
	#COMMAND_TERMINATED
 0x11

	)

116 
	#QUEUE_FULL
 0x14

	)

118 
	#STATUS_MASK
 0x3e

	)

124 
	#NO_SENSE
 0x00

	)

125 
	#RECOVERED_ERROR
 0x01

	)

126 
	#NOT_READY
 0x02

	)

127 
	#MEDIUM_ERROR
 0x03

	)

128 
	#HARDWARE_ERROR
 0x04

	)

129 
	#ILLEGAL_REQUEST
 0x05

	)

130 
	#UNIT_ATTENTION
 0x06

	)

131 
	#DATA_PROTECT
 0x07

	)

132 
	#BLANK_CHECK
 0x08

	)

133 
	#COPY_ABORTED
 0x0a

	)

134 
	#ABORTED_COMMAND
 0x0b

	)

135 
	#VOLUME_OVERFLOW
 0x0d

	)

136 
	#MISCOMPARE
 0x0e

	)

143 
	#TYPE_DISK
 0x00

	)

144 
	#TYPE_TAPE
 0x01

	)

145 
	#TYPE_PROCESSOR
 0x03

	)

146 
	#TYPE_WORM
 0x04

	)

147 
	#TYPE_ROM
 0x05

	)

148 
	#TYPE_SCANNER
 0x06

	)

149 
	#TYPE_MOD
 0x07

	)

151 
	#TYPE_MEDIUM_CHANGER
 0x08

	)

152 
	#TYPE_ENCLOSURE
 0x0d

	)

153 
	#TYPE_NO_LUN
 0x7f

	)

161 
	sccs_mode£l_h—d


163 
	m_r1
;

164 
	mmedium
;

165 
	m_r2
;

166 
	mblock_desc_Ëngth
;

167 
	md’s™y
;

168 
	mnumb”_blocks_hi
;

170 
	mnumb”_blocks_med
;

171 
	mnumb”_blocks_lo
;

172 
	m_r3
;

173 
	mblock_Ëngth_hi
;

175 
	mblock_Ëngth_med
;

176 
	mblock_Ëngth_lo
;

183 
	#COMMAND_COMPLETE
 0x00

	)

184 
	#EXTENDED_MESSAGE
 0x01

	)

185 
	#EXTENDED_MODIFY_DATA_POINTER
 0x00

	)

186 
	#EXTENDED_SDTR
 0x01

	)

187 
	#EXTENDED_EXTENDED_IDENTIFY
 0x02

	)

188 
	#EXTENDED_WDTR
 0x03

	)

189 
	#SAVE_POINTERS
 0x02

	)

190 
	#RESTORE_POINTERS
 0x03

	)

191 
	#DISCONNECT
 0x04

	)

192 
	#INITIATOR_ERROR
 0x05

	)

193 
	#ABORT
 0x06

	)

194 
	#MESSAGE_REJECT
 0x07

	)

195 
	#NOP
 0x08

	)

196 
	#MSG_PARITY_ERROR
 0x09

	)

197 
	#LINKED_CMD_COMPLETE
 0x0a

	)

198 
	#LINKED_FLG_CMD_COMPLETE
 0x0b

	)

199 
	#BUS_DEVICE_RESET
 0x0c

	)

201 
	#INITIATE_RECOVERY
 0x0à

	)

202 
	#RELEASE_RECOVERY
 0x10

	)

204 
	#SIMPLE_QUEUE_TAG
 0x20

	)

205 
	#HEAD_OF_QUEUE_TAG
 0x21

	)

206 
	#ORDERED_QUEUE_TAG
 0x22

	)

213 
	#SCSI_IOCTL_GET_IDLUN
 0x5382

	)

217 
	#SCSI_IOCTL_TAGGED_ENABLE
 0x5383

	)

218 
	#SCSI_IOCTL_TAGGED_DISABLE
 0x5384

	)

221 
	#SCSI_IOCTL_PROBE_HOST
 0x5385

	)

224 
	#SCSI_IOCTL_GET_BUS_NUMBER
 0x5386

	)

	@/usr/include/asm-i386/param.h

1 #iâdeà
_ASMi386_PARAM_H


2 
	#_ASMi386_PARAM_H


	)

5 #iâdeà
HZ


6 
	#HZ
 100

	)

9 
	#EXEC_PAGESIZE
 4096

	)

11 #iâdeà
NOGROUP


12 
	#NOGROUP
 (-1)

	)

15 
	#MAXHOSTNAMELEN
 64

	)

16 
	#COMMAND_LINE_SIZE
 2048

	)

	@/usr/include/asm-x86_64/param.h

1 #iâdeà
_ASMx86_64_PARAM_H


2 
	#_ASMx86_64_PARAM_H


	)

5 #iâdeà
HZ


6 
	#HZ
 100

	)

9 
	#EXEC_PAGESIZE
 4096

	)

11 #iâdeà
NOGROUP


12 
	#NOGROUP
 (-1)

	)

15 
	#MAXHOSTNAMELEN
 64

	)

	@/usr/include/asm/errno.h

2 #iâdeà
__ASM_STUB_ERRNO_H


3 
	#__ASM_STUB_ERRNO_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/”ºo.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/”ºo.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/asm/fcntl.h

2 #iâdeà
__ASM_STUB_FCNTL_H


3 
	#__ASM_STUB_FCNTL_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/fú.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/fú.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/asm/ioctl.h

2 #iâdeà
__ASM_STUB_IOCTL_H


3 
	#__ASM_STUB_IOCTL_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/ioùl.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/ioùl.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/asm/types.h

2 #iâdeà
__ASM_STUB_TYPES_H


3 
	#__ASM_STUB_TYPES_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/ty³s.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/ty³s.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/features.h

20 #iâdef 
_FEATURES_H


21 
	#_FEATURES_H
 1

	)

93 #undeà
__USE_ISOC99


94 #undeà
__USE_POSIX


95 #undeà
__USE_POSIX2


96 #undeà
__USE_POSIX199309


97 #undeà
__USE_POSIX199506


98 #undeà
__USE_XOPEN


99 #undeà
__USE_XOPEN_EXTENDED


100 #undeà
__USE_UNIX98


101 #undeà
__USE_XOPEN2K


102 #undeà
__USE_LARGEFILE


103 #undeà
__USE_LARGEFILE64


104 #undeà
__USE_FILE_OFFSET64


105 #undeà
__USE_BSD


106 #undeà
__USE_SVID


107 #undeà
__USE_MISC


108 #undeà
__USE_ATFILE


109 #undeà
__USE_GNU


110 #undeà
__USE_REENTRANT


111 #undeà
__USE_FORTIFY_LEVEL


112 #undeà
__FAVOR_BSD


113 #undeà
__KERNEL_STRICT_NAMES


117 #iâdeà
_LOOSE_KERNEL_NAMES


118 
	#__KERNEL_STRICT_NAMES


	)

122 
	#__USE_ANSI
 1

	)

131 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


132 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

133 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

135 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

140 #ià
defšed
 
_BSD_SOURCE
 && \

141 !(
defšed
 
	g_POSIX_SOURCE
 || defšed 
	g_POSIX_C_SOURCE
 || \

142 
defšed
 
	g_XOPEN_SOURCE
 || defšed 
	g_XOPEN_SOURCE_EXTENDED
 || \

143 
defšed
 
	g_GNU_SOURCE
 || defšed 
	g_SVID_SOURCE
)

144 
	#__FAVOR_BSD
 1

	)

148 #ifdeà
_GNU_SOURCE


149 #undeà
_ISOC99_SOURCE


150 
	#_ISOC99_SOURCE
 1

	)

151 #undeà
_POSIX_SOURCE


152 
	#_POSIX_SOURCE
 1

	)

153 #undeà
_POSIX_C_SOURCE


154 
	#_POSIX_C_SOURCE
 200112L

	)

155 #undeà
_XOPEN_SOURCE


156 
	#_XOPEN_SOURCE
 600

	)

157 #undeà
_XOPEN_SOURCE_EXTENDED


158 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

159 #undeà
_LARGEFILE64_SOURCE


160 
	#_LARGEFILE64_SOURCE
 1

	)

161 #undeà
_BSD_SOURCE


162 
	#_BSD_SOURCE
 1

	)

163 #undeà
_SVID_SOURCE


164 
	#_SVID_SOURCE
 1

	)

165 #undeà
_ATFILE_SOURCE


166 
	#_ATFILE_SOURCE
 1

	)

171 #ià(!
defšed
 
__STRICT_ANSI__
 && !defšed 
_ISOC99_SOURCE
 && \

172 !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 && \

173 !
defšed
 
	g_XOPEN_SOURCE
 && !defšed 
	g_XOPEN_SOURCE_EXTENDED
 && \

174 !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
)

175 
	#_BSD_SOURCE
 1

	)

176 
	#_SVID_SOURCE
 1

	)

183 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

184 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

185 
	#__USE_ISOC99
 1

	)

190 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

191 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

192 
	#_POSIX_SOURCE
 1

	)

193 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

194 
	#_POSIX_C_SOURCE
 2

	)

195 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

196 
	#_POSIX_C_SOURCE
 199506L

	)

198 
	#_POSIX_C_SOURCE
 200112L

	)

202 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


203 
	#__USE_POSIX
 1

	)

206 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


207 
	#__USE_POSIX2
 1

	)

210 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

211 
	#__USE_POSIX199309
 1

	)

214 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

215 
	#__USE_POSIX199506
 1

	)

218 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

219 
	#__USE_XOPEN2K
 1

	)

222 #ifdef 
_XOPEN_SOURCE


223 
	#__USE_XOPEN
 1

	)

224 #ià(
_XOPEN_SOURCE
 - 0) >= 500

225 
	#__USE_XOPEN_EXTENDED
 1

	)

226 
	#__USE_UNIX98
 1

	)

227 #undeà
_LARGEFILE_SOURCE


228 
	#_LARGEFILE_SOURCE
 1

	)

229 #ià(
_XOPEN_SOURCE
 - 0) >= 600

230 
	#__USE_XOPEN2K
 1

	)

231 #undeà
__USE_ISOC99


232 
	#__USE_ISOC99
 1

	)

235 #ifdeà
_XOPEN_SOURCE_EXTENDED


236 
	#__USE_XOPEN_EXTENDED
 1

	)

241 #ifdeà
_LARGEFILE_SOURCE


242 
	#__USE_LARGEFILE
 1

	)

245 #ifdeà
_LARGEFILE64_SOURCE


246 
	#__USE_LARGEFILE64
 1

	)

249 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

250 
	#__USE_FILE_OFFSET64
 1

	)

253 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


254 
	#__USE_MISC
 1

	)

257 #ifdef 
_BSD_SOURCE


258 
	#__USE_BSD
 1

	)

261 #ifdef 
_SVID_SOURCE


262 
	#__USE_SVID
 1

	)

265 #ifdef 
_ATFILE_SOURCE


266 
	#__USE_ATFILE
 1

	)

269 #ifdef 
_GNU_SOURCE


270 
	#__USE_GNU
 1

	)

273 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


274 
	#__USE_REENTRANT
 1

	)

277 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

278 && 
defšed
 
__OPTIMIZE__
 && __OPTIMIZE__ > 0 \

279 && (
__GNUC_PREREQ
 (4, 1) \

280 || (
defšed
 
	g__GNUC_RH_RELEASE__
 && 
__GNUC_PREREQ
 (4, 0)) \

281 || (
defšed
 
	g__GNUC_RH_RELEASE__
 && 
__GNUC_PREREQ
 (3, 4) \

282 && 
	g__GNUC_MINOR__
 == 4 \

283 && (
__GNUC_PATCHLEVEL__
 > 2 \

284 || (
__GNUC_PATCHLEVEL__
 =ğ2 && 
__GNUC_RH_RELEASE__
 >= 8))))

285 #ià
_FORTIFY_SOURCE
 > 1

286 
	#__USE_FORTIFY_LEVEL
 2

	)

288 
	#__USE_FORTIFY_LEVEL
 1

	)

291 
	#__USE_FORTIFY_LEVEL
 0

	)

295 
	#__STDC_IEC_559__
 1

	)

296 
	#__STDC_IEC_559_COMPLEX__
 1

	)

299 
	#__STDC_ISO_10646__
 200009L

	)

307 #undeà
__GNU_LIBRARY__


308 
	#__GNU_LIBRARY__
 6

	)

312 
	#__GLIBC__
 2

	)

313 
	#__GLIBC_MINOR__
 5

	)

315 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

316 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

319 #ià
defšed
 
__GNUC__
 \

320 || (
defšed
 
	g__PGI
 && defšed 
	g__i386__
 ) \

321 || (
defšed
 
	g__INTEL_COMPILER
 && (defšed 
	g__i386__
 || defšed 
	g__Ÿ64__
)) \

322 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L)

323 
	#__GLIBC_HAVE_LONG_LONG
 1

	)

327 #iâdeà
__ASSEMBLER__


328 #iâdeà
_SYS_CDEFS_H


329 
	~<sys/cdefs.h
>

334 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


335 
	#__USE_LARGEFILE
 1

	)

336 
	#__USE_LARGEFILE64
 1

	)

342 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

343 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__


344 
	#__USE_EXTERN_INLINES
 1

	)

352 
	~<gnu/¡ubs.h
>

	@/usr/include/linux/auxvec.h

1 #iâdeà
_LINUX_AUXVEC_H


2 
	#_LINUX_AUXVEC_H


	)

4 
	~<asm/auxvec.h
>

8 
	#AT_NULL
 0

	)

9 
	#AT_IGNORE
 1

	)

10 
	#AT_EXECFD
 2

	)

11 
	#AT_PHDR
 3

	)

12 
	#AT_PHENT
 4

	)

13 
	#AT_PHNUM
 5

	)

14 
	#AT_PAGESZ
 6

	)

15 
	#AT_BASE
 7

	)

16 
	#AT_FLAGS
 8

	)

17 
	#AT_ENTRY
 9

	)

18 
	#AT_NOTELF
 10

	)

19 
	#AT_UID
 11

	)

20 
	#AT_EUID
 12

	)

21 
	#AT_GID
 13

	)

22 
	#AT_EGID
 14

	)

23 
	#AT_PLATFORM
 15

	)

24 
	#AT_HWCAP
 16

	)

25 
	#AT_CLKTCK
 17

	)

27 
	#AT_SECURE
 23

	)

28 
	#AT_BASE_PLATFORM
 24

	)

31 
	#AT_VECTOR_SIZE
 44

	)

	@/usr/include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#CHILD_MAX
 999

	)

9 
	#OPEN_MAX
 256

	)

10 
	#LINK_MAX
 127

	)

11 
	#MAX_CANON
 255

	)

12 
	#MAX_INPUT
 255

	)

13 
	#NAME_MAX
 255

	)

14 
	#PATH_MAX
 4096

	)

15 
	#PIPE_BUF
 4096

	)

16 
	#XATTR_NAME_MAX
 255

	)

17 
	#XATTR_SIZE_MAX
 65536

	)

18 
	#XATTR_LIST_MAX
 65536

	)

20 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/pci_ids.h

9 
	#PCI_CLASS_NOT_DEFINED
 0x0000

	)

10 
	#PCI_CLASS_NOT_DEFINED_VGA
 0x0001

	)

12 
	#PCI_BASE_CLASS_STORAGE
 0x01

	)

13 
	#PCI_CLASS_STORAGE_SCSI
 0x0100

	)

14 
	#PCI_CLASS_STORAGE_IDE
 0x0101

	)

15 
	#PCI_CLASS_STORAGE_FLOPPY
 0x0102

	)

16 
	#PCI_CLASS_STORAGE_IPI
 0x0103

	)

17 
	#PCI_CLASS_STORAGE_RAID
 0x0104

	)

18 
	#PCI_CLASS_STORAGE_SATA
 0x0106

	)

19 
	#PCI_CLASS_STORAGE_SATA_AHCI
 0x010601

	)

20 
	#PCI_CLASS_STORAGE_SAS
 0x0107

	)

21 
	#PCI_CLASS_STORAGE_OTHER
 0x0180

	)

23 
	#PCI_BASE_CLASS_NETWORK
 0x02

	)

24 
	#PCI_CLASS_NETWORK_ETHERNET
 0x0200

	)

25 
	#PCI_CLASS_NETWORK_TOKEN_RING
 0x0201

	)

26 
	#PCI_CLASS_NETWORK_FDDI
 0x0202

	)

27 
	#PCI_CLASS_NETWORK_ATM
 0x0203

	)

28 
	#PCI_CLASS_NETWORK_OTHER
 0x0280

	)

30 
	#PCI_BASE_CLASS_DISPLAY
 0x03

	)

31 
	#PCI_CLASS_DISPLAY_VGA
 0x0300

	)

32 
	#PCI_CLASS_DISPLAY_XGA
 0x0301

	)

33 
	#PCI_CLASS_DISPLAY_3D
 0x0302

	)

34 
	#PCI_CLASS_DISPLAY_OTHER
 0x0380

	)

36 
	#PCI_BASE_CLASS_MULTIMEDIA
 0x04

	)

37 
	#PCI_CLASS_MULTIMEDIA_VIDEO
 0x0400

	)

38 
	#PCI_CLASS_MULTIMEDIA_AUDIO
 0x0401

	)

39 
	#PCI_CLASS_MULTIMEDIA_PHONE
 0x0402

	)

40 
	#PCI_CLASS_MULTIMEDIA_OTHER
 0x0480

	)

42 
	#PCI_BASE_CLASS_MEMORY
 0x05

	)

43 
	#PCI_CLASS_MEMORY_RAM
 0x0500

	)

44 
	#PCI_CLASS_MEMORY_FLASH
 0x0501

	)

45 
	#PCI_CLASS_MEMORY_OTHER
 0x0580

	)

47 
	#PCI_BASE_CLASS_BRIDGE
 0x06

	)

48 
	#PCI_CLASS_BRIDGE_HOST
 0x0600

	)

49 
	#PCI_CLASS_BRIDGE_ISA
 0x0601

	)

50 
	#PCI_CLASS_BRIDGE_EISA
 0x0602

	)

51 
	#PCI_CLASS_BRIDGE_MC
 0x0603

	)

52 
	#PCI_CLASS_BRIDGE_PCI
 0x0604

	)

53 
	#PCI_CLASS_BRIDGE_PCMCIA
 0x0605

	)

54 
	#PCI_CLASS_BRIDGE_NUBUS
 0x0606

	)

55 
	#PCI_CLASS_BRIDGE_CARDBUS
 0x0607

	)

56 
	#PCI_CLASS_BRIDGE_RACEWAY
 0x0608

	)

57 
	#PCI_CLASS_BRIDGE_OTHER
 0x0680

	)

59 
	#PCI_BASE_CLASS_COMMUNICATION
 0x07

	)

60 
	#PCI_CLASS_COMMUNICATION_SERIAL
 0x0700

	)

61 
	#PCI_CLASS_COMMUNICATION_PARALLEL
 0x0701

	)

62 
	#PCI_CLASS_COMMUNICATION_MULTISERIAL
 0x0702

	)

63 
	#PCI_CLASS_COMMUNICATION_MODEM
 0x0703

	)

64 
	#PCI_CLASS_COMMUNICATION_OTHER
 0x0780

	)

66 
	#PCI_BASE_CLASS_SYSTEM
 0x08

	)

67 
	#PCI_CLASS_SYSTEM_PIC
 0x0800

	)

68 
	#PCI_CLASS_SYSTEM_PIC_IOAPIC
 0x080010

	)

69 
	#PCI_CLASS_SYSTEM_PIC_IOXAPIC
 0x080020

	)

70 
	#PCI_CLASS_SYSTEM_DMA
 0x0801

	)

71 
	#PCI_CLASS_SYSTEM_TIMER
 0x0802

	)

72 
	#PCI_CLASS_SYSTEM_RTC
 0x0803

	)

73 
	#PCI_CLASS_SYSTEM_PCI_HOTPLUG
 0x0804

	)

74 
	#PCI_CLASS_SYSTEM_SDHCI
 0x0805

	)

75 
	#PCI_CLASS_SYSTEM_OTHER
 0x0880

	)

77 
	#PCI_BASE_CLASS_INPUT
 0x09

	)

78 
	#PCI_CLASS_INPUT_KEYBOARD
 0x0900

	)

79 
	#PCI_CLASS_INPUT_PEN
 0x0901

	)

80 
	#PCI_CLASS_INPUT_MOUSE
 0x0902

	)

81 
	#PCI_CLASS_INPUT_SCANNER
 0x0903

	)

82 
	#PCI_CLASS_INPUT_GAMEPORT
 0x0904

	)

83 
	#PCI_CLASS_INPUT_OTHER
 0x0980

	)

85 
	#PCI_BASE_CLASS_DOCKING
 0x0a

	)

86 
	#PCI_CLASS_DOCKING_GENERIC
 0x0a00

	)

87 
	#PCI_CLASS_DOCKING_OTHER
 0x0a80

	)

89 
	#PCI_BASE_CLASS_PROCESSOR
 0x0b

	)

90 
	#PCI_CLASS_PROCESSOR_386
 0x0b00

	)

91 
	#PCI_CLASS_PROCESSOR_486
 0x0b01

	)

92 
	#PCI_CLASS_PROCESSOR_PENTIUM
 0x0b02

	)

93 
	#PCI_CLASS_PROCESSOR_ALPHA
 0x0b10

	)

94 
	#PCI_CLASS_PROCESSOR_POWERPC
 0x0b20

	)

95 
	#PCI_CLASS_PROCESSOR_MIPS
 0x0b30

	)

96 
	#PCI_CLASS_PROCESSOR_CO
 0x0b40

	)

98 
	#PCI_BASE_CLASS_SERIAL
 0x0c

	)

99 
	#PCI_CLASS_SERIAL_FIREWIRE
 0x0c00

	)

100 
	#PCI_CLASS_SERIAL_FIREWIRE_OHCI
 0x0c0010

	)

101 
	#PCI_CLASS_SERIAL_ACCESS
 0x0c01

	)

102 
	#PCI_CLASS_SERIAL_SSA
 0x0c02

	)

103 
	#PCI_CLASS_SERIAL_USB
 0x0c03

	)

104 
	#PCI_CLASS_SERIAL_USB_UHCI
 0x0c0300

	)

105 
	#PCI_CLASS_SERIAL_USB_OHCI
 0x0c0310

	)

106 
	#PCI_CLASS_SERIAL_USB_EHCI
 0x0c0320

	)

107 
	#PCI_CLASS_SERIAL_FIBER
 0x0c04

	)

108 
	#PCI_CLASS_SERIAL_SMBUS
 0x0c05

	)

110 
	#PCI_BASE_CLASS_INTELLIGENT
 0x0e

	)

111 
	#PCI_CLASS_INTELLIGENT_I2O
 0x0e00

	)

113 
	#PCI_BASE_CLASS_SATELLITE
 0x0f

	)

114 
	#PCI_CLASS_SATELLITE_TV
 0x0f00

	)

115 
	#PCI_CLASS_SATELLITE_AUDIO
 0x0f01

	)

116 
	#PCI_CLASS_SATELLITE_VOICE
 0x0f03

	)

117 
	#PCI_CLASS_SATELLITE_DATA
 0x0f04

	)

119 
	#PCI_BASE_CLASS_CRYPT
 0x10

	)

120 
	#PCI_CLASS_CRYPT_NETWORK
 0x1000

	)

121 
	#PCI_CLASS_CRYPT_ENTERTAINMENT
 0x1001

	)

122 
	#PCI_CLASS_CRYPT_OTHER
 0x1080

	)

124 
	#PCI_BASE_CLASS_SIGNAL_PROCESSING
 0x11

	)

125 
	#PCI_CLASS_SP_DPIO
 0x1100

	)

126 
	#PCI_CLASS_SP_OTHER
 0x1180

	)

128 
	#PCI_CLASS_OTHERS
 0xff

	)

132 
	#PCI_VENDOR_ID_DYNALINK
 0x0675

	)

133 
	#PCI_DEVICE_ID_DYNALINK_IS64PH
 0x1702

	)

135 
	#PCI_VENDOR_ID_BERKOM
 0x0871

	)

136 
	#PCI_DEVICE_ID_BERKOM_A1T
 0xfç1

	)

137 
	#PCI_DEVICE_ID_BERKOM_T_CONCEPT
 0xfç2

	)

138 
	#PCI_DEVICE_ID_BERKOM_A4T
 0xfç4

	)

139 
	#PCI_DEVICE_ID_BERKOM_SCITEL_QUADRO
 0xfç8

	)

141 
	#PCI_VENDOR_ID_COMPAQ
 0x0e11

	)

142 
	#PCI_DEVICE_ID_COMPAQ_TOKENRING
 0x0508

	)

143 
	#PCI_DEVICE_ID_COMPAQ_TACHYON
 0xa0fc

	)

144 
	#PCI_DEVICE_ID_COMPAQ_SMART2P
 0x«10

	)

145 
	#PCI_DEVICE_ID_COMPAQ_NETEL100
 0x«32

	)

146 
	#PCI_DEVICE_ID_COMPAQ_NETEL10
 0x«34

	)

147 
	#PCI_DEVICE_ID_COMPAQ_TRIFLEX_IDE
 0x«33

	)

148 
	#PCI_DEVICE_ID_COMPAQ_NETFLEX3I
 0x«35

	)

149 
	#PCI_DEVICE_ID_COMPAQ_NETEL100D
 0x«40

	)

150 
	#PCI_DEVICE_ID_COMPAQ_NETEL100PI
 0x«43

	)

151 
	#PCI_DEVICE_ID_COMPAQ_NETEL100I
 0xb011

	)

152 
	#PCI_DEVICE_ID_COMPAQ_CISS
 0xb060

	)

153 
	#PCI_DEVICE_ID_COMPAQ_CISSB
 0xb178

	)

154 
	#PCI_DEVICE_ID_COMPAQ_CISSC
 0x46

	)

155 
	#PCI_DEVICE_ID_COMPAQ_THUNDER
 0xf130

	)

156 
	#PCI_DEVICE_ID_COMPAQ_NETFLEX3B
 0xf150

	)

158 
	#PCI_VENDOR_ID_NCR
 0x1000

	)

159 
	#PCI_VENDOR_ID_LSI_LOGIC
 0x1000

	)

160 
	#PCI_DEVICE_ID_NCR_53C810
 0x0001

	)

161 
	#PCI_DEVICE_ID_NCR_53C820
 0x0002

	)

162 
	#PCI_DEVICE_ID_NCR_53C825
 0x0003

	)

163 
	#PCI_DEVICE_ID_NCR_53C815
 0x0004

	)

164 
	#PCI_DEVICE_ID_LSI_53C810AP
 0x0005

	)

165 
	#PCI_DEVICE_ID_NCR_53C860
 0x0006

	)

166 
	#PCI_DEVICE_ID_LSI_53C1510
 0x000a

	)

167 
	#PCI_DEVICE_ID_NCR_53C896
 0x000b

	)

168 
	#PCI_DEVICE_ID_NCR_53C895
 0x000c

	)

169 
	#PCI_DEVICE_ID_NCR_53C885
 0x000d

	)

170 
	#PCI_DEVICE_ID_NCR_53C875
 0x000f

	)

171 
	#PCI_DEVICE_ID_NCR_53C1510
 0x0010

	)

172 
	#PCI_DEVICE_ID_LSI_53C895A
 0x0012

	)

173 
	#PCI_DEVICE_ID_LSI_53C875A
 0x0013

	)

174 
	#PCI_DEVICE_ID_LSI_53C1010_33
 0x0020

	)

175 
	#PCI_DEVICE_ID_LSI_53C1010_66
 0x0021

	)

176 
	#PCI_DEVICE_ID_LSI_53C1030
 0x0030

	)

177 
	#PCI_DEVICE_ID_LSI_1030_53C1035
 0x0032

	)

178 
	#PCI_DEVICE_ID_LSI_53C1035
 0x0040

	)

179 
	#PCI_DEVICE_ID_NCR_53C875J
 0x008f

	)

180 
	#PCI_DEVICE_ID_LSI_FC909
 0x0621

	)

181 
	#PCI_DEVICE_ID_LSI_FC929
 0x0622

	)

182 
	#PCI_DEVICE_ID_LSI_FC929_LAN
 0x0623

	)

183 
	#PCI_DEVICE_ID_LSI_FC919
 0x0624

	)

184 
	#PCI_DEVICE_ID_LSI_FC919_LAN
 0x0625

	)

185 
	#PCI_DEVICE_ID_LSI_FC929X
 0x0626

	)

186 
	#PCI_DEVICE_ID_LSI_FC939X
 0x0642

	)

187 
	#PCI_DEVICE_ID_LSI_FC949X
 0x0640

	)

188 
	#PCI_DEVICE_ID_LSI_FC949ES
 0x0646

	)

189 
	#PCI_DEVICE_ID_LSI_FC919X
 0x0628

	)

190 
	#PCI_DEVICE_ID_NCR_YELLOWFIN
 0x0701

	)

191 
	#PCI_DEVICE_ID_LSI_61C102
 0x0901

	)

192 
	#PCI_DEVICE_ID_LSI_63C815
 0x1000

	)

193 
	#PCI_DEVICE_ID_LSI_SAS1064
 0x0050

	)

194 
	#PCI_DEVICE_ID_LSI_SAS1064R
 0x0411

	)

195 
	#PCI_DEVICE_ID_LSI_SAS1066
 0x005E

	)

196 
	#PCI_DEVICE_ID_LSI_SAS1068
 0x0054

	)

197 
	#PCI_DEVICE_ID_LSI_SAS1064A
 0x005C

	)

198 
	#PCI_DEVICE_ID_LSI_SAS1064E
 0x0056

	)

199 
	#PCI_DEVICE_ID_LSI_SAS1066E
 0x005A

	)

200 
	#PCI_DEVICE_ID_LSI_SAS1068E
 0x0058

	)

201 
	#PCI_DEVICE_ID_LSI_SAS1078
 0x0060

	)

203 
	#PCI_VENDOR_ID_ATI
 0x1002

	)

205 
	#PCI_DEVICE_ID_ATI_68800
 0x4158

	)

206 
	#PCI_DEVICE_ID_ATI_215CT222
 0x4354

	)

207 
	#PCI_DEVICE_ID_ATI_210888CX
 0x4358

	)

208 
	#PCI_DEVICE_ID_ATI_215ET222
 0x4554

	)

210 
	#PCI_DEVICE_ID_ATI_215GB
 0x4742

	)

211 
	#PCI_DEVICE_ID_ATI_215GD
 0x4744

	)

212 
	#PCI_DEVICE_ID_ATI_215GI
 0x4749

	)

213 
	#PCI_DEVICE_ID_ATI_215GP
 0x4750

	)

214 
	#PCI_DEVICE_ID_ATI_215GQ
 0x4751

	)

215 
	#PCI_DEVICE_ID_ATI_215XL
 0x4752

	)

216 
	#PCI_DEVICE_ID_ATI_215GT
 0x4754

	)

217 
	#PCI_DEVICE_ID_ATI_215GTB
 0x4755

	)

218 
	#PCI_DEVICE_ID_ATI_215_IV
 0x4756

	)

219 
	#PCI_DEVICE_ID_ATI_215_IW
 0x4757

	)

220 
	#PCI_DEVICE_ID_ATI_215_IZ
 0x475A

	)

221 
	#PCI_DEVICE_ID_ATI_210888GX
 0x4758

	)

222 
	#PCI_DEVICE_ID_ATI_215_LB
 0x4c42

	)

223 
	#PCI_DEVICE_ID_ATI_215_LD
 0x4c44

	)

224 
	#PCI_DEVICE_ID_ATI_215_LG
 0x4c47

	)

225 
	#PCI_DEVICE_ID_ATI_215_LI
 0x4c49

	)

226 
	#PCI_DEVICE_ID_ATI_215_LM
 0x4c4D

	)

227 
	#PCI_DEVICE_ID_ATI_215_LN
 0x4c4E

	)

228 
	#PCI_DEVICE_ID_ATI_215_LR
 0x4c52

	)

229 
	#PCI_DEVICE_ID_ATI_215_LS
 0x4c53

	)

230 
	#PCI_DEVICE_ID_ATI_264_LT
 0x4c54

	)

232 
	#PCI_DEVICE_ID_ATI_264VT
 0x5654

	)

233 
	#PCI_DEVICE_ID_ATI_264VU
 0x5655

	)

234 
	#PCI_DEVICE_ID_ATI_264VV
 0x5656

	)

236 
	#PCI_DEVICE_ID_ATI_RAGE128_RE
 0x5245

	)

237 
	#PCI_DEVICE_ID_ATI_RAGE128_RF
 0x5246

	)

238 
	#PCI_DEVICE_ID_ATI_RAGE128_RG
 0x5247

	)

240 
	#PCI_DEVICE_ID_ATI_RAGE128_RK
 0x524b

	)

241 
	#PCI_DEVICE_ID_ATI_RAGE128_RL
 0x524c

	)

242 
	#PCI_DEVICE_ID_ATI_RAGE128_SE
 0x5345

	)

243 
	#PCI_DEVICE_ID_ATI_RAGE128_SF
 0x5346

	)

244 
	#PCI_DEVICE_ID_ATI_RAGE128_SG
 0x5347

	)

245 
	#PCI_DEVICE_ID_ATI_RAGE128_SH
 0x5348

	)

246 
	#PCI_DEVICE_ID_ATI_RAGE128_SK
 0x534b

	)

247 
	#PCI_DEVICE_ID_ATI_RAGE128_SL
 0x534c

	)

248 
	#PCI_DEVICE_ID_ATI_RAGE128_SM
 0x534d

	)

249 
	#PCI_DEVICE_ID_ATI_RAGE128_SN
 0x534e

	)

251 
	#PCI_DEVICE_ID_ATI_RAGE128_TF
 0x5446

	)

252 
	#PCI_DEVICE_ID_ATI_RAGE128_TL
 0x544c

	)

253 
	#PCI_DEVICE_ID_ATI_RAGE128_TR
 0x5452

	)

254 
	#PCI_DEVICE_ID_ATI_RAGE128_TS
 0x5453

	)

255 
	#PCI_DEVICE_ID_ATI_RAGE128_TT
 0x5454

	)

256 
	#PCI_DEVICE_ID_ATI_RAGE128_TU
 0x5455

	)

258 
	#PCI_DEVICE_ID_ATI_RAGE128_LE
 0x4c45

	)

259 
	#PCI_DEVICE_ID_ATI_RAGE128_LF
 0x4c46

	)

261 
	#PCI_DEVICE_ID_ATI_RAGE128_MF
 0x4d46

	)

262 
	#PCI_DEVICE_ID_ATI_RAGE128_ML
 0x4d4c

	)

264 
	#PCI_DEVICE_ID_ATI_RAGE128_PA
 0x5041

	)

265 
	#PCI_DEVICE_ID_ATI_RAGE128_PB
 0x5042

	)

266 
	#PCI_DEVICE_ID_ATI_RAGE128_PC
 0x5043

	)

267 
	#PCI_DEVICE_ID_ATI_RAGE128_PD
 0x5044

	)

268 
	#PCI_DEVICE_ID_ATI_RAGE128_PE
 0x5045

	)

269 
	#PCI_DEVICE_ID_ATI_RAGE128_PF
 0x5046

	)

271 
	#PCI_DEVICE_ID_ATI_RAGE128_PG
 0x5047

	)

272 
	#PCI_DEVICE_ID_ATI_RAGE128_PH
 0x5048

	)

273 
	#PCI_DEVICE_ID_ATI_RAGE128_PI
 0x5049

	)

274 
	#PCI_DEVICE_ID_ATI_RAGE128_PJ
 0x504A

	)

275 
	#PCI_DEVICE_ID_ATI_RAGE128_PK
 0x504B

	)

276 
	#PCI_DEVICE_ID_ATI_RAGE128_PL
 0x504C

	)

277 
	#PCI_DEVICE_ID_ATI_RAGE128_PM
 0x504D

	)

278 
	#PCI_DEVICE_ID_ATI_RAGE128_PN
 0x504E

	)

279 
	#PCI_DEVICE_ID_ATI_RAGE128_PO
 0x504F

	)

280 
	#PCI_DEVICE_ID_ATI_RAGE128_PP
 0x5050

	)

281 
	#PCI_DEVICE_ID_ATI_RAGE128_PQ
 0x5051

	)

282 
	#PCI_DEVICE_ID_ATI_RAGE128_PR
 0x5052

	)

283 
	#PCI_DEVICE_ID_ATI_RAGE128_PS
 0x5053

	)

284 
	#PCI_DEVICE_ID_ATI_RAGE128_PT
 0x5054

	)

285 
	#PCI_DEVICE_ID_ATI_RAGE128_PU
 0x5055

	)

286 
	#PCI_DEVICE_ID_ATI_RAGE128_PV
 0x5056

	)

287 
	#PCI_DEVICE_ID_ATI_RAGE128_PW
 0x5057

	)

288 
	#PCI_DEVICE_ID_ATI_RAGE128_PX
 0x5058

	)

291 
	#PCI_DEVICE_ID_ATI_RADEON_QD
 0x5144

	)

292 
	#PCI_DEVICE_ID_ATI_RADEON_QE
 0x5145

	)

293 
	#PCI_DEVICE_ID_ATI_RADEON_QF
 0x5146

	)

294 
	#PCI_DEVICE_ID_ATI_RADEON_QG
 0x5147

	)

296 
	#PCI_DEVICE_ID_ATI_RADEON_QY
 0x5159

	)

297 
	#PCI_DEVICE_ID_ATI_RADEON_QZ
 0x515a

	)

299 
	#PCI_DEVICE_ID_ATI_RADEON_QL
 0x514c

	)

300 
	#PCI_DEVICE_ID_ATI_RADEON_QN
 0x514e

	)

301 
	#PCI_DEVICE_ID_ATI_RADEON_QO
 0x514f

	)

302 
	#PCI_DEVICE_ID_ATI_RADEON_Ql
 0x516c

	)

303 
	#PCI_DEVICE_ID_ATI_RADEON_BB
 0x4242

	)

305 
	#PCI_DEVICE_ID_ATI_RADEON_QM
 0x514d

	)

307 
	#PCI_DEVICE_ID_ATI_RADEON_QW
 0x5157

	)

308 
	#PCI_DEVICE_ID_ATI_RADEON_QX
 0x5158

	)

311 
	#PCI_DEVICE_ID_ATI_RADEON_Id
 0x4964

	)

312 
	#PCI_DEVICE_ID_ATI_RADEON_Ie
 0x4965

	)

313 
	#PCI_DEVICE_ID_ATI_RADEON_If
 0x4966

	)

314 
	#PCI_DEVICE_ID_ATI_RADEON_Ig
 0x4967

	)

316 
	#PCI_DEVICE_ID_ATI_RADEON_Ya
 0x5961

	)

317 
	#PCI_DEVICE_ID_ATI_RADEON_Yd
 0x5964

	)

320 
	#PCI_DEVICE_ID_ATI_RADEON_ND
 0x4e44

	)

321 
	#PCI_DEVICE_ID_ATI_RADEON_NE
 0x4e45

	)

322 
	#PCI_DEVICE_ID_ATI_RADEON_NF
 0x4e46

	)

323 
	#PCI_DEVICE_ID_ATI_RADEON_NG
 0x4e47

	)

327 
	#PCI_DEVICE_ID_ATI_RADEON_LY
 0x4c59

	)

328 
	#PCI_DEVICE_ID_ATI_RADEON_LZ
 0x4c5a

	)

330 
	#PCI_DEVICE_ID_ATI_RADEON_LW
 0x4c57

	)

331 
	#PCI_DEVICE_ID_ATI_RADEON_LX
 0x4c58

	)

333 
	#PCI_DEVICE_ID_ATI_RADEON_Ld
 0x4c64

	)

334 
	#PCI_DEVICE_ID_ATI_RADEON_Le
 0x4c65

	)

335 
	#PCI_DEVICE_ID_ATI_RADEON_Lf
 0x4c66

	)

336 
	#PCI_DEVICE_ID_ATI_RADEON_Lg
 0x4c67

	)

339 
	#PCI_DEVICE_ID_ATI_RS100
 0xÿb0

	)

340 
	#PCI_DEVICE_ID_ATI_RS200
 0xÿb2

	)

341 
	#PCI_DEVICE_ID_ATI_RS200_B
 0xcbb2

	)

342 
	#PCI_DEVICE_ID_ATI_RS250
 0xÿb3

	)

343 
	#PCI_DEVICE_ID_ATI_RS300_100
 0x5830

	)

344 
	#PCI_DEVICE_ID_ATI_RS300_133
 0x5831

	)

345 
	#PCI_DEVICE_ID_ATI_RS300_166
 0x5832

	)

346 
	#PCI_DEVICE_ID_ATI_RS300_200
 0x5833

	)

347 
	#PCI_DEVICE_ID_ATI_RS350_100
 0x7830

	)

348 
	#PCI_DEVICE_ID_ATI_RS350_133
 0x7831

	)

349 
	#PCI_DEVICE_ID_ATI_RS350_166
 0x7832

	)

350 
	#PCI_DEVICE_ID_ATI_RS350_200
 0x7833

	)

351 
	#PCI_DEVICE_ID_ATI_RS400_100
 0x5a30

	)

352 
	#PCI_DEVICE_ID_ATI_RS400_133
 0x5a31

	)

353 
	#PCI_DEVICE_ID_ATI_RS400_166
 0x5a32

	)

354 
	#PCI_DEVICE_ID_ATI_RS400_200
 0x5a33

	)

355 
	#PCI_DEVICE_ID_ATI_RS480
 0x5950

	)

357 
	#PCI_DEVICE_ID_ATI_IXP200_IDE
 0x4349

	)

358 
	#PCI_DEVICE_ID_ATI_IXP200_SMBUS
 0x4353

	)

359 
	#PCI_DEVICE_ID_ATI_IXP300_SMBUS
 0x4363

	)

360 
	#PCI_DEVICE_ID_ATI_IXP300_IDE
 0x4369

	)

361 
	#PCI_DEVICE_ID_ATI_IXP300_SATA
 0x436e

	)

362 
	#PCI_DEVICE_ID_ATI_IXP400_SMBUS
 0x4372

	)

363 
	#PCI_DEVICE_ID_ATI_IXP400_IDE
 0x4376

	)

364 
	#PCI_DEVICE_ID_ATI_IXP400_SATA
 0x4379

	)

365 
	#PCI_DEVICE_ID_ATI_IXP400_SATA2
 0x437a

	)

366 
	#PCI_DEVICE_ID_ATI_IXP600_SATA
 0x4380

	)

367 
	#PCI_DEVICE_ID_ATI_SBX00_SMBUS
 0x4385

	)

368 
	#PCI_DEVICE_ID_ATI_IXP600_IDE
 0x438c

	)

369 
	#PCI_DEVICE_ID_ATI_IXP700_SATA
 0x4390

	)

370 
	#PCI_DEVICE_ID_ATI_IXP700_IDE
 0x439c

	)

372 
	#PCI_VENDOR_ID_VLSI
 0x1004

	)

373 
	#PCI_DEVICE_ID_VLSI_82C592
 0x0005

	)

374 
	#PCI_DEVICE_ID_VLSI_82C593
 0x0006

	)

375 
	#PCI_DEVICE_ID_VLSI_82C594
 0x0007

	)

376 
	#PCI_DEVICE_ID_VLSI_82C597
 0x0009

	)

377 
	#PCI_DEVICE_ID_VLSI_82C541
 0x000c

	)

378 
	#PCI_DEVICE_ID_VLSI_82C543
 0x000d

	)

379 
	#PCI_DEVICE_ID_VLSI_82C532
 0x0101

	)

380 
	#PCI_DEVICE_ID_VLSI_82C534
 0x0102

	)

381 
	#PCI_DEVICE_ID_VLSI_82C535
 0x0104

	)

382 
	#PCI_DEVICE_ID_VLSI_82C147
 0x0105

	)

383 
	#PCI_DEVICE_ID_VLSI_VAS96011
 0x0702

	)

386 
	#PCI_DEVICE_ID_RD890_IOMMU
 0x5a23

	)

388 
	#PCI_VENDOR_ID_ADL
 0x1005

	)

389 
	#PCI_DEVICE_ID_ADL_2301
 0x2301

	)

391 
	#PCI_VENDOR_ID_NS
 0x100b

	)

392 
	#PCI_DEVICE_ID_NS_87415
 0x0002

	)

393 
	#PCI_DEVICE_ID_NS_87560_LIO
 0x000e

	)

394 
	#PCI_DEVICE_ID_NS_87560_USB
 0x0012

	)

395 
	#PCI_DEVICE_ID_NS_83815
 0x0020

	)

396 
	#PCI_DEVICE_ID_NS_83820
 0x0022

	)

397 
	#PCI_DEVICE_ID_NS_CS5535_ISA
 0x002b

	)

398 
	#PCI_DEVICE_ID_NS_CS5535_IDE
 0x002d

	)

399 
	#PCI_DEVICE_ID_NS_CS5535_AUDIO
 0x002e

	)

400 
	#PCI_DEVICE_ID_NS_CS5535_USB
 0x002f

	)

401 
	#PCI_DEVICE_ID_NS_GX_VIDEO
 0x0030

	)

402 
	#PCI_DEVICE_ID_NS_SATURN
 0x0035

	)

403 
	#PCI_DEVICE_ID_NS_SCx200_BRIDGE
 0x0500

	)

404 
	#PCI_DEVICE_ID_NS_SCx200_SMI
 0x0501

	)

405 
	#PCI_DEVICE_ID_NS_SCx200_IDE
 0x0502

	)

406 
	#PCI_DEVICE_ID_NS_SCx200_AUDIO
 0x0503

	)

407 
	#PCI_DEVICE_ID_NS_SCx200_VIDEO
 0x0504

	)

408 
	#PCI_DEVICE_ID_NS_SCx200_XBUS
 0x0505

	)

409 
	#PCI_DEVICE_ID_NS_SC1100_BRIDGE
 0x0510

	)

410 
	#PCI_DEVICE_ID_NS_SC1100_SMI
 0x0511

	)

411 
	#PCI_DEVICE_ID_NS_SC1100_XBUS
 0x0515

	)

412 
	#PCI_DEVICE_ID_NS_87410
 0xd001

	)

414 
	#PCI_DEVICE_ID_NS_GX_HOST_BRIDGE
 0x0028

	)

416 
	#PCI_VENDOR_ID_TSENG
 0x100c

	)

417 
	#PCI_DEVICE_ID_TSENG_W32P_2
 0x3202

	)

418 
	#PCI_DEVICE_ID_TSENG_W32P_b
 0x3205

	)

419 
	#PCI_DEVICE_ID_TSENG_W32P_c
 0x3206

	)

420 
	#PCI_DEVICE_ID_TSENG_W32P_d
 0x3207

	)

421 
	#PCI_DEVICE_ID_TSENG_ET6000
 0x3208

	)

423 
	#PCI_VENDOR_ID_WEITEK
 0x100e

	)

424 
	#PCI_DEVICE_ID_WEITEK_P9000
 0x9001

	)

425 
	#PCI_DEVICE_ID_WEITEK_P9100
 0x9100

	)

427 
	#PCI_VENDOR_ID_DEC
 0x1011

	)

428 
	#PCI_DEVICE_ID_DEC_BRD
 0x0001

	)

429 
	#PCI_DEVICE_ID_DEC_TULIP
 0x0002

	)

430 
	#PCI_DEVICE_ID_DEC_TGA
 0x0004

	)

431 
	#PCI_DEVICE_ID_DEC_TULIP_FAST
 0x0009

	)

432 
	#PCI_DEVICE_ID_DEC_TGA2
 0x000D

	)

433 
	#PCI_DEVICE_ID_DEC_FDDI
 0x000F

	)

434 
	#PCI_DEVICE_ID_DEC_TULIP_PLUS
 0x0014

	)

435 
	#PCI_DEVICE_ID_DEC_21142
 0x0019

	)

436 
	#PCI_DEVICE_ID_DEC_21052
 0x0021

	)

437 
	#PCI_DEVICE_ID_DEC_21150
 0x0022

	)

438 
	#PCI_DEVICE_ID_DEC_21152
 0x0024

	)

439 
	#PCI_DEVICE_ID_DEC_21153
 0x0025

	)

440 
	#PCI_DEVICE_ID_DEC_21154
 0x0026

	)

441 
	#PCI_DEVICE_ID_DEC_21285
 0x1065

	)

442 
	#PCI_DEVICE_ID_COMPAQ_42XX
 0x0046

	)

444 
	#PCI_VENDOR_ID_CIRRUS
 0x1013

	)

445 
	#PCI_DEVICE_ID_CIRRUS_7548
 0x0038

	)

446 
	#PCI_DEVICE_ID_CIRRUS_5430
 0x00a0

	)

447 
	#PCI_DEVICE_ID_CIRRUS_5434_4
 0x00a4

	)

448 
	#PCI_DEVICE_ID_CIRRUS_5434_8
 0x00a8

	)

449 
	#PCI_DEVICE_ID_CIRRUS_5436
 0x00ac

	)

450 
	#PCI_DEVICE_ID_CIRRUS_5446
 0x00b8

	)

451 
	#PCI_DEVICE_ID_CIRRUS_5480
 0x00bc

	)

452 
	#PCI_DEVICE_ID_CIRRUS_5462
 0x00d0

	)

453 
	#PCI_DEVICE_ID_CIRRUS_5464
 0x00d4

	)

454 
	#PCI_DEVICE_ID_CIRRUS_5465
 0x00d6

	)

455 
	#PCI_DEVICE_ID_CIRRUS_6729
 0x1100

	)

456 
	#PCI_DEVICE_ID_CIRRUS_6832
 0x1110

	)

457 
	#PCI_DEVICE_ID_CIRRUS_7543
 0x1202

	)

458 
	#PCI_DEVICE_ID_CIRRUS_4610
 0x6001

	)

459 
	#PCI_DEVICE_ID_CIRRUS_4612
 0x6003

	)

460 
	#PCI_DEVICE_ID_CIRRUS_4615
 0x6004

	)

462 
	#PCI_VENDOR_ID_IBM
 0x1014

	)

463 
	#PCI_DEVICE_ID_IBM_TR
 0x0018

	)

464 
	#PCI_DEVICE_ID_IBM_TR_WAKE
 0x003e

	)

465 
	#PCI_DEVICE_ID_IBM_CPC710_PCI64
 0x00fc

	)

466 
	#PCI_DEVICE_ID_IBM_SNIPE
 0x0180

	)

467 
	#PCI_DEVICE_ID_IBM_CITRINE
 0x028C

	)

468 
	#PCI_DEVICE_ID_IBM_GEMSTONE
 0xB166

	)

469 
	#PCI_DEVICE_ID_IBM_OBSIDIAN
 0x02BD

	)

470 
	#PCI_DEVICE_ID_IBM_ICOM_DEV_ID_1
 0x0031

	)

471 
	#PCI_DEVICE_ID_IBM_ICOM_DEV_ID_2
 0x0219

	)

472 
	#PCI_DEVICE_ID_IBM_ICOM_V2_TWO_PORTS_RVX
 0x021A

	)

473 
	#PCI_DEVICE_ID_IBM_ICOM_V2_ONE_PORT_RVX_ONE_PORT_MDM
 0x0251

	)

474 
	#PCI_DEVICE_ID_IBM_ICOM_FOUR_PORT_MODEL
 0x252

	)

475 
	#PCI_DEVICE_ID_IBM_ICOM_V2_ONE_PORT_RVX_ONE_PORT_MDM_PCIE
 0x0361

	)

476 
	#PCI_SUBVENDOR_ID_IBM
 0x1014

	)

477 
	#PCI_SUBDEVICE_ID_IBM_SATURN_SERIAL_ONE_PORT
 0x03d4

	)

479 
	#PCI_VENDOR_ID_UNISYS
 0x1018

	)

480 
	#PCI_DEVICE_ID_UNISYS_DMA_DIRECTOR
 0x001C

	)

482 
	#PCI_VENDOR_ID_COMPEX2
 0x101¨

	)

483 
	#PCI_DEVICE_ID_COMPEX2_100VG
 0x0005

	)

485 
	#PCI_VENDOR_ID_WD
 0x101c

	)

486 
	#PCI_DEVICE_ID_WD_90C
 0xc24a

	)

488 
	#PCI_VENDOR_ID_AMI
 0x101e

	)

489 
	#PCI_DEVICE_ID_AMI_MEGARAID3
 0x1960

	)

490 
	#PCI_DEVICE_ID_AMI_MEGARAID
 0x9010

	)

491 
	#PCI_DEVICE_ID_AMI_MEGARAID2
 0x9060

	)

493 
	#PCI_VENDOR_ID_AMD
 0x1022

	)

494 
	#PCI_DEVICE_ID_AMD_K8_NB
 0x1100

	)

495 
	#PCI_DEVICE_ID_AMD_K8_NB_MISC
 0x1103

	)

496 
	#PCI_DEVICE_ID_AMD_10H_NB_HT
 0x1200

	)

497 
	#PCI_DEVICE_ID_AMD_10H_NB_MAP
 0x1201

	)

498 
	#PCI_DEVICE_ID_AMD_10H_NB_DRAM
 0x1202

	)

499 
	#PCI_DEVICE_ID_AMD_10H_NB_MISC
 0x1203

	)

500 
	#PCI_DEVICE_ID_AMD_10H_NB_LINK
 0x1204

	)

501 
	#PCI_DEVICE_ID_AMD_11H_NB_HT
 0x1300

	)

502 
	#PCI_DEVICE_ID_AMD_11H_NB_MAP
 0x1301

	)

503 
	#PCI_DEVICE_ID_AMD_11H_NB_DRAM
 0x1302

	)

504 
	#PCI_DEVICE_ID_AMD_11H_NB_MISC
 0x1303

	)

505 
	#PCI_DEVICE_ID_AMD_11H_NB_LINK
 0x1304

	)

506 
	#PCI_DEVICE_ID_AMD_LANCE
 0x2000

	)

507 
	#PCI_DEVICE_ID_AMD_LANCE_HOME
 0x2001

	)

508 
	#PCI_DEVICE_ID_AMD_SCSI
 0x2020

	)

509 
	#PCI_DEVICE_ID_AMD_SERENADE
 0x36c0

	)

510 
	#PCI_DEVICE_ID_AMD_FE_GATE_7006
 0x7006

	)

511 
	#PCI_DEVICE_ID_AMD_FE_GATE_7007
 0x7007

	)

512 
	#PCI_DEVICE_ID_AMD_FE_GATE_700C
 0x700C

	)

513 
	#PCI_DEVICE_ID_AMD_FE_GATE_700E
 0x700E

	)

514 
	#PCI_DEVICE_ID_AMD_COBRA_7401
 0x7401

	)

515 
	#PCI_DEVICE_ID_AMD_VIPER_7409
 0x7409

	)

516 
	#PCI_DEVICE_ID_AMD_VIPER_740B
 0x740B

	)

517 
	#PCI_DEVICE_ID_AMD_VIPER_7410
 0x7410

	)

518 
	#PCI_DEVICE_ID_AMD_VIPER_7411
 0x7411

	)

519 
	#PCI_DEVICE_ID_AMD_VIPER_7413
 0x7413

	)

520 
	#PCI_DEVICE_ID_AMD_VIPER_7440
 0x7440

	)

521 
	#PCI_DEVICE_ID_AMD_OPUS_7441
 0x7441

	)

522 
	#PCI_DEVICE_ID_AMD_OPUS_7443
 0x7443

	)

523 
	#PCI_DEVICE_ID_AMD_VIPER_7443
 0x7443

	)

524 
	#PCI_DEVICE_ID_AMD_OPUS_7445
 0x7445

	)

525 
	#PCI_DEVICE_ID_AMD_8111_LPC
 0x7468

	)

526 
	#PCI_DEVICE_ID_AMD_8111_IDE
 0x7469

	)

527 
	#PCI_DEVICE_ID_AMD_8111_SMBUS2
 0x746a

	)

528 
	#PCI_DEVICE_ID_AMD_8111_SMBUS
 0x746b

	)

529 
	#PCI_DEVICE_ID_AMD_8111_AUDIO
 0x746d

	)

530 
	#PCI_DEVICE_ID_AMD_8151_0
 0x7454

	)

531 
	#PCI_DEVICE_ID_AMD_8131_BRIDGE
 0x7450

	)

532 
	#PCI_DEVICE_ID_AMD_8131_APIC
 0x7451

	)

533 
	#PCI_DEVICE_ID_AMD_8132_BRIDGE
 0x7458

	)

534 
	#PCI_DEVICE_ID_AMD_HUDSON2_SMBUS
 0x780b

	)

535 
	#PCI_DEVICE_ID_AMD_CS5536_ISA
 0x2090

	)

536 
	#PCI_DEVICE_ID_AMD_CS5536_FLASH
 0x2091

	)

537 
	#PCI_DEVICE_ID_AMD_CS5536_AUDIO
 0x2093

	)

538 
	#PCI_DEVICE_ID_AMD_CS5536_OHC
 0x2094

	)

539 
	#PCI_DEVICE_ID_AMD_CS5536_EHC
 0x2095

	)

540 
	#PCI_DEVICE_ID_AMD_CS5536_UDC
 0x2096

	)

541 
	#PCI_DEVICE_ID_AMD_CS5536_UOC
 0x2097

	)

542 
	#PCI_DEVICE_ID_AMD_CS5536_IDE
 0x209A

	)

543 
	#PCI_DEVICE_ID_AMD_LX_VIDEO
 0x2081

	)

544 
	#PCI_DEVICE_ID_AMD_LX_AES
 0x2082

	)

545 
	#PCI_DEVICE_ID_AMD_HUDSON2_IDE
 0x780c

	)

546 
	#PCI_DEVICE_ID_AMD_HUDSON2_SATA_IDE
 0x7800

	)

548 
	#PCI_VENDOR_ID_TRIDENT
 0x1023

	)

549 
	#PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
 0x2000

	)

550 
	#PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
 0x2001

	)

551 
	#PCI_DEVICE_ID_TRIDENT_9320
 0x9320

	)

552 
	#PCI_DEVICE_ID_TRIDENT_9388
 0x9388

	)

553 
	#PCI_DEVICE_ID_TRIDENT_9397
 0x9397

	)

554 
	#PCI_DEVICE_ID_TRIDENT_939A
 0x939A

	)

555 
	#PCI_DEVICE_ID_TRIDENT_9520
 0x9520

	)

556 
	#PCI_DEVICE_ID_TRIDENT_9525
 0x9525

	)

557 
	#PCI_DEVICE_ID_TRIDENT_9420
 0x9420

	)

558 
	#PCI_DEVICE_ID_TRIDENT_9440
 0x9440

	)

559 
	#PCI_DEVICE_ID_TRIDENT_9660
 0x9660

	)

560 
	#PCI_DEVICE_ID_TRIDENT_9750
 0x9750

	)

561 
	#PCI_DEVICE_ID_TRIDENT_9850
 0x9850

	)

562 
	#PCI_DEVICE_ID_TRIDENT_9880
 0x9880

	)

563 
	#PCI_DEVICE_ID_TRIDENT_8400
 0x8400

	)

564 
	#PCI_DEVICE_ID_TRIDENT_8420
 0x8420

	)

565 
	#PCI_DEVICE_ID_TRIDENT_8500
 0x8500

	)

567 
	#PCI_VENDOR_ID_AI
 0x1025

	)

568 
	#PCI_DEVICE_ID_AI_M1435
 0x1435

	)

570 
	#PCI_VENDOR_ID_DELL
 0x1028

	)

571 
	#PCI_DEVICE_ID_DELL_RACIII
 0x0008

	)

572 
	#PCI_DEVICE_ID_DELL_RAC4
 0x0012

	)

573 
	#PCI_DEVICE_ID_DELL_PERC5
 0x0015

	)

575 
	#PCI_VENDOR_ID_MATROX
 0x102B

	)

576 
	#PCI_DEVICE_ID_MATROX_MGA_2
 0x0518

	)

577 
	#PCI_DEVICE_ID_MATROX_MIL
 0x0519

	)

578 
	#PCI_DEVICE_ID_MATROX_MYS
 0x051A

	)

579 
	#PCI_DEVICE_ID_MATROX_MIL_2
 0x051b

	)

580 
	#PCI_DEVICE_ID_MATROX_MYS_AGP
 0x051e

	)

581 
	#PCI_DEVICE_ID_MATROX_MIL_2_AGP
 0x051f

	)

582 
	#PCI_DEVICE_ID_MATROX_MGA_IMP
 0x0d10

	)

583 
	#PCI_DEVICE_ID_MATROX_G100_MM
 0x1000

	)

584 
	#PCI_DEVICE_ID_MATROX_G100_AGP
 0x1001

	)

585 
	#PCI_DEVICE_ID_MATROX_G200_PCI
 0x0520

	)

586 
	#PCI_DEVICE_ID_MATROX_G200_AGP
 0x0521

	)

587 
	#PCI_DEVICE_ID_MATROX_G400
 0x0525

	)

588 
	#PCI_DEVICE_ID_MATROX_G550
 0x2527

	)

589 
	#PCI_DEVICE_ID_MATROX_VIA
 0x4536

	)

591 
	#PCI_VENDOR_ID_CT
 0x102c

	)

592 
	#PCI_DEVICE_ID_CT_69000
 0x00c0

	)

593 
	#PCI_DEVICE_ID_CT_65545
 0x00d8

	)

594 
	#PCI_DEVICE_ID_CT_65548
 0x00dc

	)

595 
	#PCI_DEVICE_ID_CT_65550
 0x00e0

	)

596 
	#PCI_DEVICE_ID_CT_65554
 0x00e4

	)

597 
	#PCI_DEVICE_ID_CT_65555
 0x00e5

	)

599 
	#PCI_VENDOR_ID_MIRO
 0x1031

	)

600 
	#PCI_DEVICE_ID_MIRO_36050
 0x5601

	)

601 
	#PCI_DEVICE_ID_MIRO_DC10PLUS
 0x7eã

	)

602 
	#PCI_DEVICE_ID_MIRO_DC30PLUS
 0xd801

	)

604 
	#PCI_VENDOR_ID_NEC
 0x1033

	)

605 
	#PCI_DEVICE_ID_NEC_CBUS_1
 0x0001

	)

606 
	#PCI_DEVICE_ID_NEC_LOCAL
 0x0002

	)

607 
	#PCI_DEVICE_ID_NEC_ATM
 0x0003

	)

608 
	#PCI_DEVICE_ID_NEC_R4000
 0x0004

	)

609 
	#PCI_DEVICE_ID_NEC_486
 0x0005

	)

610 
	#PCI_DEVICE_ID_NEC_ACCEL_1
 0x0006

	)

611 
	#PCI_DEVICE_ID_NEC_UXBUS
 0x0007

	)

612 
	#PCI_DEVICE_ID_NEC_ACCEL_2
 0x0008

	)

613 
	#PCI_DEVICE_ID_NEC_GRAPH
 0x0009

	)

614 
	#PCI_DEVICE_ID_NEC_VL
 0x0016

	)

615 
	#PCI_DEVICE_ID_NEC_STARALPHA2
 0x002ø

	)

616 
	#PCI_DEVICE_ID_NEC_CBUS_2
 0x002d

	)

617 
	#PCI_DEVICE_ID_NEC_USB
 0x0035

	)

618 
	#PCI_DEVICE_ID_NEC_CBUS_3
 0x003b

	)

619 
	#PCI_DEVICE_ID_NEC_NAPCCARD
 0x003e

	)

620 
	#PCI_DEVICE_ID_NEC_PCX2
 0x0046

	)

621 
	#PCI_DEVICE_ID_NEC_NILE4
 0x005a

	)

622 
	#PCI_DEVICE_ID_NEC_VRC5476
 0x009b

	)

623 
	#PCI_DEVICE_ID_NEC_VRC4173
 0x00a5

	)

624 
	#PCI_DEVICE_ID_NEC_VRC5477_AC97
 0x00a6

	)

625 
	#PCI_DEVICE_ID_NEC_PC9821CS01
 0x800ø

	)

626 
	#PCI_DEVICE_ID_NEC_PC9821NRB06
 0x800d

	)

628 
	#PCI_VENDOR_ID_FD
 0x1036

	)

629 
	#PCI_DEVICE_ID_FD_36C70
 0x0000

	)

631 
	#PCI_VENDOR_ID_SI
 0x1039

	)

632 
	#PCI_DEVICE_ID_SI_5591_AGP
 0x0001

	)

633 
	#PCI_DEVICE_ID_SI_6202
 0x0002

	)

634 
	#PCI_DEVICE_ID_SI_503
 0x0008

	)

635 
	#PCI_DEVICE_ID_SI_ACPI
 0x0009

	)

636 
	#PCI_DEVICE_ID_SI_SMBUS
 0x0016

	)

637 
	#PCI_DEVICE_ID_SI_LPC
 0x0018

	)

638 
	#PCI_DEVICE_ID_SI_5597_VGA
 0x0200

	)

639 
	#PCI_DEVICE_ID_SI_6205
 0x0205

	)

640 
	#PCI_DEVICE_ID_SI_501
 0x0406

	)

641 
	#PCI_DEVICE_ID_SI_496
 0x0496

	)

642 
	#PCI_DEVICE_ID_SI_300
 0x0300

	)

643 
	#PCI_DEVICE_ID_SI_315H
 0x0310

	)

644 
	#PCI_DEVICE_ID_SI_315
 0x0315

	)

645 
	#PCI_DEVICE_ID_SI_315PRO
 0x0325

	)

646 
	#PCI_DEVICE_ID_SI_530
 0x0530

	)

647 
	#PCI_DEVICE_ID_SI_540
 0x0540

	)

648 
	#PCI_DEVICE_ID_SI_550
 0x0550

	)

649 
	#PCI_DEVICE_ID_SI_540_VGA
 0x5300

	)

650 
	#PCI_DEVICE_ID_SI_550_VGA
 0x5315

	)

651 
	#PCI_DEVICE_ID_SI_620
 0x0620

	)

652 
	#PCI_DEVICE_ID_SI_630
 0x0630

	)

653 
	#PCI_DEVICE_ID_SI_633
 0x0633

	)

654 
	#PCI_DEVICE_ID_SI_635
 0x0635

	)

655 
	#PCI_DEVICE_ID_SI_640
 0x0640

	)

656 
	#PCI_DEVICE_ID_SI_645
 0x0645

	)

657 
	#PCI_DEVICE_ID_SI_646
 0x0646

	)

658 
	#PCI_DEVICE_ID_SI_648
 0x0648

	)

659 
	#PCI_DEVICE_ID_SI_650
 0x0650

	)

660 
	#PCI_DEVICE_ID_SI_651
 0x0651

	)

661 
	#PCI_DEVICE_ID_SI_655
 0x0655

	)

662 
	#PCI_DEVICE_ID_SI_661
 0x0661

	)

663 
	#PCI_DEVICE_ID_SI_730
 0x0730

	)

664 
	#PCI_DEVICE_ID_SI_733
 0x0733

	)

665 
	#PCI_DEVICE_ID_SI_630_VGA
 0x6300

	)

666 
	#PCI_DEVICE_ID_SI_735
 0x0735

	)

667 
	#PCI_DEVICE_ID_SI_740
 0x0740

	)

668 
	#PCI_DEVICE_ID_SI_741
 0x0741

	)

669 
	#PCI_DEVICE_ID_SI_745
 0x0745

	)

670 
	#PCI_DEVICE_ID_SI_746
 0x0746

	)

671 
	#PCI_DEVICE_ID_SI_755
 0x0755

	)

672 
	#PCI_DEVICE_ID_SI_760
 0x0760

	)

673 
	#PCI_DEVICE_ID_SI_900
 0x0900

	)

674 
	#PCI_DEVICE_ID_SI_961
 0x0961

	)

675 
	#PCI_DEVICE_ID_SI_962
 0x0962

	)

676 
	#PCI_DEVICE_ID_SI_963
 0x0963

	)

677 
	#PCI_DEVICE_ID_SI_965
 0x0965

	)

678 
	#PCI_DEVICE_ID_SI_966
 0x0966

	)

679 
	#PCI_DEVICE_ID_SI_968
 0x0968

	)

680 
	#PCI_DEVICE_ID_SI_5511
 0x5511

	)

681 
	#PCI_DEVICE_ID_SI_5513
 0x5513

	)

682 
	#PCI_DEVICE_ID_SI_5517
 0x5517

	)

683 
	#PCI_DEVICE_ID_SI_5518
 0x5518

	)

684 
	#PCI_DEVICE_ID_SI_5571
 0x5571

	)

685 
	#PCI_DEVICE_ID_SI_5581
 0x5581

	)

686 
	#PCI_DEVICE_ID_SI_5582
 0x5582

	)

687 
	#PCI_DEVICE_ID_SI_5591
 0x5591

	)

688 
	#PCI_DEVICE_ID_SI_5596
 0x5596

	)

689 
	#PCI_DEVICE_ID_SI_5597
 0x5597

	)

690 
	#PCI_DEVICE_ID_SI_5598
 0x5598

	)

691 
	#PCI_DEVICE_ID_SI_5600
 0x5600

	)

692 
	#PCI_DEVICE_ID_SI_7012
 0x7012

	)

693 
	#PCI_DEVICE_ID_SI_7013
 0x7013

	)

694 
	#PCI_DEVICE_ID_SI_7016
 0x7016

	)

695 
	#PCI_DEVICE_ID_SI_7018
 0x7018

	)

697 
	#PCI_VENDOR_ID_ATTANSIC
 0x1969

	)

698 
	#PCI_DEVICE_ID_ATTANSIC_L1
 0x1048

	)

699 
	#PCI_DEVICE_ID_ATTANSIC_L2
 0x2048

	)

701 
	#PCI_VENDOR_ID_HP
 0x103c

	)

702 
	#PCI_DEVICE_ID_HP_VISUALIZE_EG
 0x1005

	)

703 
	#PCI_DEVICE_ID_HP_VISUALIZE_FX6
 0x1006

	)

704 
	#PCI_DEVICE_ID_HP_VISUALIZE_FX4
 0x1008

	)

705 
	#PCI_DEVICE_ID_HP_VISUALIZE_FX2
 0x100a

	)

706 
	#PCI_DEVICE_ID_HP_TACHYON
 0x1028

	)

707 
	#PCI_DEVICE_ID_HP_TACHLITE
 0x1029

	)

708 
	#PCI_DEVICE_ID_HP_J2585A
 0x1030

	)

709 
	#PCI_DEVICE_ID_HP_J2585B
 0x1031

	)

710 
	#PCI_DEVICE_ID_HP_J2973A
 0x1040

	)

711 
	#PCI_DEVICE_ID_HP_J2970A
 0x1042

	)

712 
	#PCI_DEVICE_ID_HP_DIVA
 0x1048

	)

713 
	#PCI_DEVICE_ID_HP_DIVA_TOSCA1
 0x1049

	)

714 
	#PCI_DEVICE_ID_HP_DIVA_TOSCA2
 0x104A

	)

715 
	#PCI_DEVICE_ID_HP_DIVA_MAESTRO
 0x104B

	)

716 
	#PCI_DEVICE_ID_HP_REO_IOC
 0x10f1

	)

717 
	#PCI_DEVICE_ID_HP_VISUALIZE_FXE
 0x108b

	)

718 
	#PCI_DEVICE_ID_HP_DIVA_HALFDOME
 0x1223

	)

719 
	#PCI_DEVICE_ID_HP_DIVA_KEYSTONE
 0x1226

	)

720 
	#PCI_DEVICE_ID_HP_DIVA_POWERBAR
 0x1227

	)

721 
	#PCI_DEVICE_ID_HP_ZX1_IOC
 0x122a

	)

722 
	#PCI_DEVICE_ID_HP_PCIX_LBA
 0x122e

	)

723 
	#PCI_DEVICE_ID_HP_SX1000_IOC
 0x127c

	)

724 
	#PCI_DEVICE_ID_HP_DIVA_EVEREST
 0x1282

	)

725 
	#PCI_DEVICE_ID_HP_DIVA_AUX
 0x1290

	)

726 
	#PCI_DEVICE_ID_HP_DIVA_RMP3
 0x1301

	)

727 
	#PCI_DEVICE_ID_HP_DIVA_HURRICANE
 0x132a

	)

728 
	#PCI_DEVICE_ID_HP_CISSA
 0x3220

	)

729 
	#PCI_DEVICE_ID_HP_CISSC
 0x3230

	)

730 
	#PCI_DEVICE_ID_HP_CISSD
 0x3238

	)

731 
	#PCI_DEVICE_ID_HP_CISSE
 0x323A

	)

732 
	#PCI_DEVICE_ID_HP_CISSF
 0x323B

	)

733 
	#PCI_DEVICE_ID_HP_CISSH
 0x323C

	)

734 
	#PCI_DEVICE_ID_HP_ZX2_IOC
 0x4031

	)

736 
	#PCI_VENDOR_ID_PCTECH
 0x1042

	)

737 
	#PCI_DEVICE_ID_PCTECH_RZ1000
 0x1000

	)

738 
	#PCI_DEVICE_ID_PCTECH_RZ1001
 0x1001

	)

739 
	#PCI_DEVICE_ID_PCTECH_SAMURAI_IDE
 0x3020

	)

741 
	#PCI_VENDOR_ID_ASUSTEK
 0x1043

	)

742 
	#PCI_DEVICE_ID_ASUSTEK_0675
 0x0675

	)

744 
	#PCI_VENDOR_ID_DPT
 0x1044

	)

745 
	#PCI_DEVICE_ID_DPT
 0xa400

	)

747 
	#PCI_VENDOR_ID_OPTI
 0x1045

	)

748 
	#PCI_DEVICE_ID_OPTI_82C558
 0xc558

	)

749 
	#PCI_DEVICE_ID_OPTI_82C621
 0xc621

	)

750 
	#PCI_DEVICE_ID_OPTI_82C700
 0xc700

	)

751 
	#PCI_DEVICE_ID_OPTI_82C825
 0xd568

	)

753 
	#PCI_VENDOR_ID_ELSA
 0x1048

	)

754 
	#PCI_DEVICE_ID_ELSA_MICROLINK
 0x1000

	)

755 
	#PCI_DEVICE_ID_ELSA_QS3000
 0x3000

	)

758 
	#PCI_VENDOR_ID_BUSLOGIC
 0x104B

	)

759 
	#PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER_NC
 0x0140

	)

760 
	#PCI_DEVICE_ID_BUSLOGIC_MULTIMASTER
 0x1040

	)

761 
	#PCI_DEVICE_ID_BUSLOGIC_FLASHPOINT
 0x8130

	)

763 
	#PCI_VENDOR_ID_TI
 0x104c

	)

764 
	#PCI_DEVICE_ID_TI_TVP4020
 0x3d07

	)

765 
	#PCI_DEVICE_ID_TI_4450
 0x8011

	)

766 
	#PCI_DEVICE_ID_TI_TSB43AB22
 0x8023

	)

767 
	#PCI_DEVICE_ID_TI_XX21_XX11
 0x8031

	)

768 
	#PCI_DEVICE_ID_TI_XX21_XX11_SD
 0x8034

	)

769 
	#PCI_DEVICE_ID_TI_X515
 0x8036

	)

770 
	#PCI_DEVICE_ID_TI_XX12
 0x8039

	)

771 
	#PCI_DEVICE_ID_TI_1130
 0xac12

	)

772 
	#PCI_DEVICE_ID_TI_1031
 0xac13

	)

773 
	#PCI_DEVICE_ID_TI_1131
 0xac15

	)

774 
	#PCI_DEVICE_ID_TI_1250
 0xac16

	)

775 
	#PCI_DEVICE_ID_TI_1220
 0xac17

	)

776 
	#PCI_DEVICE_ID_TI_1221
 0xac19

	)

777 
	#PCI_DEVICE_ID_TI_1210
 0xac1a

	)

778 
	#PCI_DEVICE_ID_TI_1450
 0xac1b

	)

779 
	#PCI_DEVICE_ID_TI_1225
 0xac1c

	)

780 
	#PCI_DEVICE_ID_TI_1251A
 0xac1d

	)

781 
	#PCI_DEVICE_ID_TI_1211
 0xac1e

	)

782 
	#PCI_DEVICE_ID_TI_1251B
 0xac1f

	)

783 
	#PCI_DEVICE_ID_TI_4410
 0xac41

	)

784 
	#PCI_DEVICE_ID_TI_4451
 0xac42

	)

785 
	#PCI_DEVICE_ID_TI_4510
 0xac44

	)

786 
	#PCI_DEVICE_ID_TI_4520
 0xac46

	)

787 
	#PCI_DEVICE_ID_TI_7510
 0xac47

	)

788 
	#PCI_DEVICE_ID_TI_7610
 0xac48

	)

789 
	#PCI_DEVICE_ID_TI_7410
 0xac49

	)

790 
	#PCI_DEVICE_ID_TI_1410
 0xac50

	)

791 
	#PCI_DEVICE_ID_TI_1420
 0xac51

	)

792 
	#PCI_DEVICE_ID_TI_1451A
 0xac52

	)

793 
	#PCI_DEVICE_ID_TI_1620
 0xac54

	)

794 
	#PCI_DEVICE_ID_TI_1520
 0xac55

	)

795 
	#PCI_DEVICE_ID_TI_1510
 0xac56

	)

796 
	#PCI_DEVICE_ID_TI_X620
 0xac8d

	)

797 
	#PCI_DEVICE_ID_TI_X420
 0xac8e

	)

799 
	#PCI_VENDOR_ID_SONY
 0x104d

	)

803 
	#PCI_VENDOR_ID_WINBOND2
 0x1050

	)

804 
	#PCI_DEVICE_ID_WINBOND2_89C940F
 0x5a5a

	)

805 
	#PCI_DEVICE_ID_WINBOND2_6692
 0x6692

	)

807 
	#PCI_VENDOR_ID_ANIGMA
 0x1051

	)

808 
	#PCI_DEVICE_ID_ANIGMA_MC145575
 0x0100

	)

810 
	#PCI_VENDOR_ID_EFAR
 0x1055

	)

811 
	#PCI_DEVICE_ID_EFAR_SLC90E66_1
 0x9130

	)

812 
	#PCI_DEVICE_ID_EFAR_SLC90E66_3
 0x9463

	)

814 
	#PCI_VENDOR_ID_MOTOROLA
 0x1057

	)

815 
	#PCI_DEVICE_ID_MOTOROLA_MPC105
 0x0001

	)

816 
	#PCI_DEVICE_ID_MOTOROLA_MPC106
 0x0002

	)

817 
	#PCI_DEVICE_ID_MOTOROLA_MPC107
 0x0004

	)

818 
	#PCI_DEVICE_ID_MOTOROLA_RAVEN
 0x4801

	)

819 
	#PCI_DEVICE_ID_MOTOROLA_FALCON
 0x4802

	)

820 
	#PCI_DEVICE_ID_MOTOROLA_HAWK
 0x4803

	)

821 
	#PCI_DEVICE_ID_MOTOROLA_HARRIER
 0x480b

	)

822 
	#PCI_DEVICE_ID_MOTOROLA_MPC5200
 0x5803

	)

823 
	#PCI_DEVICE_ID_MOTOROLA_MPC5200B
 0x5809

	)

825 
	#PCI_VENDOR_ID_PROMISE
 0x105a

	)

826 
	#PCI_DEVICE_ID_PROMISE_20265
 0x0d30

	)

827 
	#PCI_DEVICE_ID_PROMISE_20267
 0x4d30

	)

828 
	#PCI_DEVICE_ID_PROMISE_20246
 0x4d33

	)

829 
	#PCI_DEVICE_ID_PROMISE_20262
 0x4d38

	)

830 
	#PCI_DEVICE_ID_PROMISE_20263
 0x0D38

	)

831 
	#PCI_DEVICE_ID_PROMISE_20268
 0x4d68

	)

832 
	#PCI_DEVICE_ID_PROMISE_20269
 0x4d69

	)

833 
	#PCI_DEVICE_ID_PROMISE_20270
 0x6268

	)

834 
	#PCI_DEVICE_ID_PROMISE_20271
 0x6269

	)

835 
	#PCI_DEVICE_ID_PROMISE_20275
 0x1275

	)

836 
	#PCI_DEVICE_ID_PROMISE_20276
 0x5275

	)

837 
	#PCI_DEVICE_ID_PROMISE_20277
 0x7275

	)

839 
	#PCI_VENDOR_ID_FOXCONN
 0x105b

	)

841 
	#PCI_VENDOR_ID_UMC
 0x1060

	)

842 
	#PCI_DEVICE_ID_UMC_UM8673F
 0x0101

	)

843 
	#PCI_DEVICE_ID_UMC_UM8886BF
 0x673a

	)

844 
	#PCI_DEVICE_ID_UMC_UM8886A
 0x886a

	)

847 
	#PCI_VENDOR_ID_MYLEX
 0x1069

	)

848 
	#PCI_DEVICE_ID_MYLEX_DAC960_P
 0x0001

	)

849 
	#PCI_DEVICE_ID_MYLEX_DAC960_PD
 0x0002

	)

850 
	#PCI_DEVICE_ID_MYLEX_DAC960_PG
 0x0010

	)

851 
	#PCI_DEVICE_ID_MYLEX_DAC960_LA
 0x0020

	)

852 
	#PCI_DEVICE_ID_MYLEX_DAC960_LP
 0x0050

	)

853 
	#PCI_DEVICE_ID_MYLEX_DAC960_BA
 0xBA56

	)

854 
	#PCI_DEVICE_ID_MYLEX_DAC960_GEM
 0xB166

	)

857 
	#PCI_VENDOR_ID_APPLE
 0x106b

	)

858 
	#PCI_DEVICE_ID_APPLE_BANDIT
 0x0001

	)

859 
	#PCI_DEVICE_ID_APPLE_HYDRA
 0x000e

	)

860 
	#PCI_DEVICE_ID_APPLE_UNI_N_FW
 0x0018

	)

861 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP
 0x0020

	)

862 
	#PCI_DEVICE_ID_APPLE_UNI_N_GMAC
 0x0021

	)

863 
	#PCI_DEVICE_ID_APPLE_UNI_N_GMACP
 0x0024

	)

864 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP_P
 0x0027

	)

865 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP15
 0x002d

	)

866 
	#PCI_DEVICE_ID_APPLE_UNI_N_PCI15
 0x002e

	)

867 
	#PCI_DEVICE_ID_APPLE_UNI_N_GMAC2
 0x0032

	)

868 
	#PCI_DEVICE_ID_APPLE_UNI_N_ATA
 0x0033

	)

869 
	#PCI_DEVICE_ID_APPLE_UNI_N_AGP2
 0x0034

	)

870 
	#PCI_DEVICE_ID_APPLE_IPID_ATA100
 0x003b

	)

871 
	#PCI_DEVICE_ID_APPLE_K2_ATA100
 0x0043

	)

872 
	#PCI_DEVICE_ID_APPLE_U3_AGP
 0x004b

	)

873 
	#PCI_DEVICE_ID_APPLE_K2_GMAC
 0x004c

	)

874 
	#PCI_DEVICE_ID_APPLE_SH_ATA
 0x0050

	)

875 
	#PCI_DEVICE_ID_APPLE_SH_SUNGEM
 0x0051

	)

876 
	#PCI_DEVICE_ID_APPLE_U3L_AGP
 0x0058

	)

877 
	#PCI_DEVICE_ID_APPLE_U3H_AGP
 0x0059

	)

878 
	#PCI_DEVICE_ID_APPLE_IPID2_AGP
 0x0066

	)

879 
	#PCI_DEVICE_ID_APPLE_IPID2_ATA
 0x0069

	)

880 
	#PCI_DEVICE_ID_APPLE_IPID2_FW
 0x006a

	)

881 
	#PCI_DEVICE_ID_APPLE_IPID2_GMAC
 0x006b

	)

882 
	#PCI_DEVICE_ID_APPLE_TIGON3
 0x1645

	)

884 
	#PCI_VENDOR_ID_YAMAHA
 0x1073

	)

885 
	#PCI_DEVICE_ID_YAMAHA_724
 0x0004

	)

886 
	#PCI_DEVICE_ID_YAMAHA_724F
 0x000d

	)

887 
	#PCI_DEVICE_ID_YAMAHA_740
 0x000a

	)

888 
	#PCI_DEVICE_ID_YAMAHA_740C
 0x000c

	)

889 
	#PCI_DEVICE_ID_YAMAHA_744
 0x0010

	)

890 
	#PCI_DEVICE_ID_YAMAHA_754
 0x0012

	)

893 
	#PCI_VENDOR_ID_QLOGIC
 0x1077

	)

894 
	#PCI_DEVICE_ID_QLOGIC_ISP10160
 0x1016

	)

895 
	#PCI_DEVICE_ID_QLOGIC_ISP1020
 0x1020

	)

896 
	#PCI_DEVICE_ID_QLOGIC_ISP1080
 0x1080

	)

897 
	#PCI_DEVICE_ID_QLOGIC_ISP12160
 0x1216

	)

898 
	#PCI_DEVICE_ID_QLOGIC_ISP1240
 0x1240

	)

899 
	#PCI_DEVICE_ID_QLOGIC_ISP1280
 0x1280

	)

900 
	#PCI_DEVICE_ID_QLOGIC_ISP2100
 0x2100

	)

901 
	#PCI_DEVICE_ID_QLOGIC_ISP2200
 0x2200

	)

902 
	#PCI_DEVICE_ID_QLOGIC_ISP2300
 0x2300

	)

903 
	#PCI_DEVICE_ID_QLOGIC_ISP2312
 0x2312

	)

904 
	#PCI_DEVICE_ID_QLOGIC_ISP2322
 0x2322

	)

905 
	#PCI_DEVICE_ID_QLOGIC_ISP6312
 0x6312

	)

906 
	#PCI_DEVICE_ID_QLOGIC_ISP6322
 0x6322

	)

907 
	#PCI_DEVICE_ID_QLOGIC_ISP2422
 0x2422

	)

908 
	#PCI_DEVICE_ID_QLOGIC_ISP2432
 0x2432

	)

909 
	#PCI_DEVICE_ID_QLOGIC_ISP2512
 0x2512

	)

910 
	#PCI_DEVICE_ID_QLOGIC_ISP2522
 0x2522

	)

911 
	#PCI_DEVICE_ID_QLOGIC_ISP5422
 0x5422

	)

912 
	#PCI_DEVICE_ID_QLOGIC_ISP5432
 0x5432

	)

914 
	#PCI_VENDOR_ID_CYRIX
 0x1078

	)

915 
	#PCI_DEVICE_ID_CYRIX_5510
 0x0000

	)

916 
	#PCI_DEVICE_ID_CYRIX_PCI_MASTER
 0x0001

	)

917 
	#PCI_DEVICE_ID_CYRIX_5520
 0x0002

	)

918 
	#PCI_DEVICE_ID_CYRIX_5530_LEGACY
 0x0100

	)

919 
	#PCI_DEVICE_ID_CYRIX_5530_IDE
 0x0102

	)

920 
	#PCI_DEVICE_ID_CYRIX_5530_AUDIO
 0x0103

	)

921 
	#PCI_DEVICE_ID_CYRIX_5530_VIDEO
 0x0104

	)

925 
	#PCI_VENDOR_ID_CONTAQ
 0x1080

	)

926 
	#PCI_DEVICE_ID_CONTAQ_82C693
 0xc693

	)

929 
	#PCI_VENDOR_ID_OLICOM
 0x108d

	)

930 
	#PCI_DEVICE_ID_OLICOM_OC2325
 0x0012

	)

931 
	#PCI_DEVICE_ID_OLICOM_OC2183
 0x0013

	)

932 
	#PCI_DEVICE_ID_OLICOM_OC2326
 0x0014

	)

934 
	#PCI_VENDOR_ID_SUN
 0x108e

	)

935 
	#PCI_DEVICE_ID_SUN_EBUS
 0x1000

	)

936 
	#PCI_DEVICE_ID_SUN_HAPPYMEAL
 0x1001

	)

937 
	#PCI_DEVICE_ID_SUN_RIO_EBUS
 0x1100

	)

938 
	#PCI_DEVICE_ID_SUN_RIO_GEM
 0x1101

	)

939 
	#PCI_DEVICE_ID_SUN_RIO_1394
 0x1102

	)

940 
	#PCI_DEVICE_ID_SUN_RIO_USB
 0x1103

	)

941 
	#PCI_DEVICE_ID_SUN_GEM
 0x2bad

	)

942 
	#PCI_DEVICE_ID_SUN_SIMBA
 0x5000

	)

943 
	#PCI_DEVICE_ID_SUN_PBM
 0x8000

	)

944 
	#PCI_DEVICE_ID_SUN_SCHIZO
 0x8001

	)

945 
	#PCI_DEVICE_ID_SUN_SABRE
 0xa000

	)

946 
	#PCI_DEVICE_ID_SUN_HUMMINGBIRD
 0xa001

	)

947 
	#PCI_DEVICE_ID_SUN_TOMATILLO
 0xa801

	)

948 
	#PCI_DEVICE_ID_SUN_CASSINI
 0xabba

	)

950 
	#PCI_VENDOR_ID_CMD
 0x1095

	)

951 
	#PCI_DEVICE_ID_CMD_643
 0x0643

	)

952 
	#PCI_DEVICE_ID_CMD_646
 0x0646

	)

953 
	#PCI_DEVICE_ID_CMD_648
 0x0648

	)

954 
	#PCI_DEVICE_ID_CMD_649
 0x0649

	)

956 
	#PCI_DEVICE_ID_SII_680
 0x0680

	)

957 
	#PCI_DEVICE_ID_SII_3112
 0x3112

	)

958 
	#PCI_DEVICE_ID_SII_1210SA
 0x0240

	)

961 
	#PCI_VENDOR_ID_BROOKTREE
 0x109e

	)

962 
	#PCI_DEVICE_ID_BROOKTREE_878
 0x0878

	)

963 
	#PCI_DEVICE_ID_BROOKTREE_879
 0x0879

	)

966 
	#PCI_VENDOR_ID_SGI
 0x10a9

	)

967 
	#PCI_DEVICE_ID_SGI_IOC3
 0x0003

	)

968 
	#PCI_DEVICE_ID_SGI_IOC4
 0x100a

	)

969 
	#PCI_VENDOR_ID_SGI_LITHIUM
 0x1002

	)

972 
	#PCI_VENDOR_ID_WINBOND
 0x10ad

	)

973 
	#PCI_DEVICE_ID_WINBOND_82C105
 0x0105

	)

974 
	#PCI_DEVICE_ID_WINBOND_83C553
 0x0565

	)

977 
	#PCI_VENDOR_ID_PLX
 0x10b5

	)

978 
	#PCI_DEVICE_ID_PLX_R685
 0x1030

	)

979 
	#PCI_DEVICE_ID_PLX_ROMULUS
 0x106a

	)

980 
	#PCI_DEVICE_ID_PLX_SPCOM800
 0x1076

	)

981 
	#PCI_DEVICE_ID_PLX_1077
 0x1077

	)

982 
	#PCI_DEVICE_ID_PLX_SPCOM200
 0x1103

	)

983 
	#PCI_DEVICE_ID_PLX_DJINN_ITOO
 0x1151

	)

984 
	#PCI_DEVICE_ID_PLX_R753
 0x1152

	)

985 
	#PCI_DEVICE_ID_PLX_OLITEC
 0x1187

	)

986 
	#PCI_DEVICE_ID_PLX_PCI200SYN
 0x3196

	)

987 
	#PCI_DEVICE_ID_PLX_9050
 0x9050

	)

988 
	#PCI_DEVICE_ID_PLX_9080
 0x9080

	)

989 
	#PCI_DEVICE_ID_PLX_GTEK_SERIAL2
 0xa001

	)

991 
	#PCI_VENDOR_ID_MADGE
 0x10b6

	)

992 
	#PCI_DEVICE_ID_MADGE_MK2
 0x0002

	)

994 
	#PCI_VENDOR_ID_3COM
 0x10b7

	)

995 
	#PCI_DEVICE_ID_3COM_3C985
 0x0001

	)

996 
	#PCI_DEVICE_ID_3COM_3C940
 0x1700

	)

997 
	#PCI_DEVICE_ID_3COM_3C339
 0x3390

	)

998 
	#PCI_DEVICE_ID_3COM_3C359
 0x3590

	)

999 
	#PCI_DEVICE_ID_3COM_3C940B
 0x80eb

	)

1000 
	#PCI_DEVICE_ID_3COM_3CR990
 0x9900

	)

1001 
	#PCI_DEVICE_ID_3COM_3CR990_TX_95
 0x9902

	)

1002 
	#PCI_DEVICE_ID_3COM_3CR990_TX_97
 0x9903

	)

1003 
	#PCI_DEVICE_ID_3COM_3CR990B
 0x9904

	)

1004 
	#PCI_DEVICE_ID_3COM_3CR990_FX
 0x9905

	)

1005 
	#PCI_DEVICE_ID_3COM_3CR990SVR95
 0x9908

	)

1006 
	#PCI_DEVICE_ID_3COM_3CR990SVR97
 0x9909

	)

1007 
	#PCI_DEVICE_ID_3COM_3CR990SVR
 0x990a

	)

1010 
	#PCI_VENDOR_ID_AL
 0x10b9

	)

1011 
	#PCI_DEVICE_ID_AL_M1533
 0x1533

	)

1012 
	#PCI_DEVICE_ID_AL_M1535
 0x1535

	)

1013 
	#PCI_DEVICE_ID_AL_M1541
 0x1541

	)

1014 
	#PCI_DEVICE_ID_AL_M1563
 0x1563

	)

1015 
	#PCI_DEVICE_ID_AL_M1621
 0x1621

	)

1016 
	#PCI_DEVICE_ID_AL_M1631
 0x1631

	)

1017 
	#PCI_DEVICE_ID_AL_M1632
 0x1632

	)

1018 
	#PCI_DEVICE_ID_AL_M1641
 0x1641

	)

1019 
	#PCI_DEVICE_ID_AL_M1644
 0x1644

	)

1020 
	#PCI_DEVICE_ID_AL_M1647
 0x1647

	)

1021 
	#PCI_DEVICE_ID_AL_M1651
 0x1651

	)

1022 
	#PCI_DEVICE_ID_AL_M1671
 0x1671

	)

1023 
	#PCI_DEVICE_ID_AL_M1681
 0x1681

	)

1024 
	#PCI_DEVICE_ID_AL_M1683
 0x1683

	)

1025 
	#PCI_DEVICE_ID_AL_M1689
 0x1689

	)

1026 
	#PCI_DEVICE_ID_AL_M5219
 0x5219

	)

1027 
	#PCI_DEVICE_ID_AL_M5228
 0x5228

	)

1028 
	#PCI_DEVICE_ID_AL_M5229
 0x5229

	)

1029 
	#PCI_DEVICE_ID_AL_M5451
 0x5451

	)

1030 
	#PCI_DEVICE_ID_AL_M7101
 0x7101

	)

1034 
	#PCI_VENDOR_ID_NEOMAGIC
 0x10c8

	)

1035 
	#PCI_DEVICE_ID_NEOMAGIC_NM256AV_AUDIO
 0x8005

	)

1036 
	#PCI_DEVICE_ID_NEOMAGIC_NM256ZX_AUDIO
 0x8006

	)

1037 
	#PCI_DEVICE_ID_NEOMAGIC_NM256XL_PLUS_AUDIO
 0x8016

	)

1040 
	#PCI_VENDOR_ID_TCONRAD
 0x10da

	)

1041 
	#PCI_DEVICE_ID_TCONRAD_TOKENRING
 0x0508

	)

1044 
	#PCI_VENDOR_ID_NVIDIA
 0x10de

	)

1045 
	#PCI_DEVICE_ID_NVIDIA_TNT
 0x0020

	)

1046 
	#PCI_DEVICE_ID_NVIDIA_TNT2
 0x0028

	)

1047 
	#PCI_DEVICE_ID_NVIDIA_UTNT2
 0x0029

	)

1048 
	#PCI_DEVICE_ID_NVIDIA_TNT_UNKNOWN
 0x002a

	)

1049 
	#PCI_DEVICE_ID_NVIDIA_VTNT2
 0x002C

	)

1050 
	#PCI_DEVICE_ID_NVIDIA_UVTNT2
 0x002D

	)

1051 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SMBUS
 0x0034

	)

1052 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_IDE
 0x0035

	)

1053 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SATA
 0x0036

	)

1054 
	#PCI_DEVICE_ID_NVIDIA_NVENET_10
 0x0037

	)

1055 
	#PCI_DEVICE_ID_NVIDIA_NVENET_11
 0x0038

	)

1056 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SATA2
 0x003e

	)

1057 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800_ULTRA
 0x0040

	)

1058 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800
 0x0041

	)

1059 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800_LE
 0x0042

	)

1060 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800_GT
 0x0045

	)

1061 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_4000
 0x004E

	)

1062 
	#PCI_DEVICE_ID_NVIDIA_NFORCE4_SMBUS
 0x0052

	)

1063 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_IDE
 0x0053

	)

1064 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_SATA
 0x0054

	)

1065 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_SATA2
 0x0055

	)

1066 
	#PCI_DEVICE_ID_NVIDIA_NVENET_8
 0x0056

	)

1067 
	#PCI_DEVICE_ID_NVIDIA_NVENET_9
 0x0057

	)

1068 
	#PCI_DEVICE_ID_NVIDIA_CK804_AUDIO
 0x0059

	)

1069 
	#PCI_DEVICE_ID_NVIDIA_CK804_PCIE
 0x005d

	)

1070 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2_SMBUS
 0x0064

	)

1071 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2_IDE
 0x0065

	)

1072 
	#PCI_DEVICE_ID_NVIDIA_NVENET_2
 0x0066

	)

1073 
	#PCI_DEVICE_ID_NVIDIA_MCP2_MODEM
 0x0069

	)

1074 
	#PCI_DEVICE_ID_NVIDIA_MCP2_AUDIO
 0x006a

	)

1075 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2S_SMBUS
 0x0084

	)

1076 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2S_IDE
 0x0085

	)

1077 
	#PCI_DEVICE_ID_NVIDIA_NVENET_4
 0x0086

	)

1078 
	#PCI_DEVICE_ID_NVIDIA_MCP2S_MODEM
 0x0089

	)

1079 
	#PCI_DEVICE_ID_NVIDIA_CK8_AUDIO
 0x008a

	)

1080 
	#PCI_DEVICE_ID_NVIDIA_NVENET_5
 0x008c

	)

1081 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2S_SATA
 0x008e

	)

1082 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_7800_GT
 0x0090

	)

1083 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_7800_GTX
 0x0091

	)

1084 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_7800
 0x0098

	)

1085 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_7800_GTX
 0x0099

	)

1086 
	#PCI_DEVICE_ID_NVIDIA_ITNT2
 0x00A0

	)

1087 
	#PCI_DEVICE_ID_GEFORCE_6800A
 0x00c1

	)

1088 
	#PCI_DEVICE_ID_GEFORCE_6800A_LE
 0x00c2

	)

1089 
	#PCI_DEVICE_ID_GEFORCE_GO_6800
 0x00c8

	)

1090 
	#PCI_DEVICE_ID_GEFORCE_GO_6800_ULTRA
 0x00c9

	)

1091 
	#PCI_DEVICE_ID_QUADRO_FX_GO1400
 0x00cc

	)

1092 
	#PCI_DEVICE_ID_QUADRO_FX_1400
 0x00û

	)

1093 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3
 0x00d1

	)

1094 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3_SMBUS
 0x00d4

	)

1095 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3_IDE
 0x00d5

	)

1096 
	#PCI_DEVICE_ID_NVIDIA_NVENET_3
 0x00d6

	)

1097 
	#PCI_DEVICE_ID_NVIDIA_MCP3_MODEM
 0x00d9

	)

1098 
	#PCI_DEVICE_ID_NVIDIA_MCP3_AUDIO
 0x00da

	)

1099 
	#PCI_DEVICE_ID_NVIDIA_NVENET_7
 0x00df

	)

1100 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S
 0x00e1

	)

1101 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_SATA
 0x00e3

	)

1102 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_SMBUS
 0x00e4

	)

1103 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_IDE
 0x00e5

	)

1104 
	#PCI_DEVICE_ID_NVIDIA_NVENET_6
 0x00e6

	)

1105 
	#PCI_DEVICE_ID_NVIDIA_CK8S_AUDIO
 0x00—

	)

1106 
	#PCI_DEVICE_ID_NVIDIA_NFORCE3S_SATA2
 0x00“

	)

1107 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6800_ALT1
 0x00f0

	)

1108 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6600_ALT1
 0x00f1

	)

1109 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6600_ALT2
 0x00f2

	)

1110 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6200_ALT1
 0x00f3

	)

1111 
	#PCIE_DEVICE_ID_NVIDIA_GEFORCE_6800_GT
 0x00f9

	)

1112 
	#PCIE_DEVICE_ID_NVIDIA_QUADRO_NVS280
 0x00fd

	)

1113 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_SDR
 0x0100

	)

1114 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_DDR
 0x0101

	)

1115 
	#PCI_DEVICE_ID_NVIDIA_QUADRO
 0x0103

	)

1116 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_MX
 0x0110

	)

1117 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_MX2
 0x0111

	)

1118 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_GO
 0x0112

	)

1119 
	#PCI_DEVICE_ID_NVIDIA_QUADRO2_MXR
 0x0113

	)

1120 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6600_GT
 0x0140

	)

1121 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6600
 0x0141

	)

1122 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6610_XL
 0x0145

	)

1123 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_540
 0x014E

	)

1124 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6200
 0x014F

	)

1125 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_GTS
 0x0150

	)

1126 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_GTS2
 0x0151

	)

1127 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE2_ULTRA
 0x0152

	)

1128 
	#PCI_DEVICE_ID_NVIDIA_QUADRO2_PRO
 0x0153

	)

1129 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6200_TURBOCACHE
 0x0161

	)

1130 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6200
 0x0164

	)

1131 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6250
 0x0166

	)

1132 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6200_1
 0x0167

	)

1133 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_GO_6250_1
 0x0168

	)

1134 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_460
 0x0170

	)

1135 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440
 0x0171

	)

1136 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_420
 0x0172

	)

1137 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440_SE
 0x0173

	)

1138 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_440_GO
 0x0174

	)

1139 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_420_GO
 0x0175

	)

1140 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_420_GO_M32
 0x0176

	)

1141 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_460_GO
 0x0177

	)

1142 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_500XGL
 0x0178

	)

1143 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_440_GO_M64
 0x0179

	)

1144 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_200
 0x017A

	)

1145 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_550XGL
 0x017B

	)

1146 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_500_GOGL
 0x017C

	)

1147 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_410_GO_M16
 0x017D

	)

1148 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440_8X
 0x0181

	)

1149 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_440SE_8X
 0x0182

	)

1150 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_420_8X
 0x0183

	)

1151 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_4000
 0x0185

	)

1152 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_448_GO
 0x0186

	)

1153 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_488_GO
 0x0187

	)

1154 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_580_XGL
 0x0188

	)

1155 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_MX_MAC
 0x0189

	)

1156 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_280_NVS
 0x018A

	)

1157 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_380_XGL
 0x018B

	)

1158 
	#PCI_DEVICE_ID_NVIDIA_IGEFORCE2
 0x01a0

	)

1159 
	#PCI_DEVICE_ID_NVIDIA_NFORCE
 0x01a4

	)

1160 
	#PCI_DEVICE_ID_NVIDIA_MCP1_AUDIO
 0x01b1

	)

1161 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_SMBUS
 0x01b4

	)

1162 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_IDE
 0x01bc

	)

1163 
	#PCI_DEVICE_ID_NVIDIA_MCP1_MODEM
 0x01c1

	)

1164 
	#PCI_DEVICE_ID_NVIDIA_NVENET_1
 0x01c3

	)

1165 
	#PCI_DEVICE_ID_NVIDIA_NFORCE2
 0x01e0

	)

1166 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE3
 0x0200

	)

1167 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE3_1
 0x0201

	)

1168 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE3_2
 0x0202

	)

1169 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_DDC
 0x0203

	)

1170 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800B
 0x0211

	)

1171 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800B_LE
 0x0212

	)

1172 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_6800B_GT
 0x0215

	)

1173 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4600
 0x0250

	)

1174 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4400
 0x0251

	)

1175 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4200
 0x0253

	)

1176 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_900XGL
 0x0258

	)

1177 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_750XGL
 0x0259

	)

1178 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_700XGL
 0x025B

	)

1179 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SMBUS
 0x0264

	)

1180 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_IDE
 0x0265

	)

1181 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA
 0x0266

	)

1182 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA2
 0x0267

	)

1183 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SMBUS
 0x0368

	)

1184 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_IDE
 0x036E

	)

1185 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA
 0x037E

	)

1186 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA2
 0x037F

	)

1187 
	#PCI_DEVICE_ID_NVIDIA_NVENET_12
 0x0268

	)

1188 
	#PCI_DEVICE_ID_NVIDIA_NVENET_13
 0x0269

	)

1189 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4800
 0x0280

	)

1190 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4800_8X
 0x0281

	)

1191 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_TI_4800SE
 0x0282

	)

1192 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE4_4200_GO
 0x0286

	)

1193 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_980_XGL
 0x0288

	)

1194 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_780_XGL
 0x0289

	)

1195 
	#PCI_DEVICE_ID_NVIDIA_QUADRO4_700_GOGL
 0x028C

	)

1196 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5800_ULTRA
 0x0301

	)

1197 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5800
 0x0302

	)

1198 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_2000
 0x0308

	)

1199 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_1000
 0x0309

	)

1200 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5600_ULTRA
 0x0311

	)

1201 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5600
 0x0312

	)

1202 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5600SE
 0x0314

	)

1203 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5600
 0x031A

	)

1204 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5650
 0x031B

	)

1205 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_GO700
 0x031C

	)

1206 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200
 0x0320

	)

1207 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200_ULTRA
 0x0321

	)

1208 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200_1
 0x0322

	)

1209 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5200SE
 0x0323

	)

1210 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5200
 0x0324

	)

1211 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5250
 0x0325

	)

1212 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5500
 0x0326

	)

1213 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5100
 0x0327

	)

1214 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5250_32
 0x0328

	)

1215 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO_5200
 0x0329

	)

1216 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_NVS_280_PCI
 0x032A

	)

1217 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_500
 0x032B

	)

1218 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5300
 0x032C

	)

1219 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5100
 0x032D

	)

1220 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900_ULTRA
 0x0330

	)

1221 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900
 0x0331

	)

1222 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900XT
 0x0332

	)

1223 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5950_ULTRA
 0x0333

	)

1224 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5900ZT
 0x0334

	)

1225 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_3000
 0x0338

	)

1226 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_700
 0x033F

	)

1227 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700_ULTRA
 0x0341

	)

1228 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700
 0x0342

	)

1229 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700LE
 0x0343

	)

1230 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_5700VE
 0x0344

	)

1231 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5700_1
 0x0347

	)

1232 
	#PCI_DEVICE_ID_NVIDIA_GEFORCE_FX_GO5700_2
 0x0348

	)

1233 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_GO1000
 0x034C

	)

1234 
	#PCI_DEVICE_ID_NVIDIA_QUADRO_FX_1100
 0x034E

	)

1235 
	#PCI_DEVICE_ID_NVIDIA_NVENET_14
 0x0372

	)

1236 
	#PCI_DEVICE_ID_NVIDIA_NVENET_15
 0x0373

	)

1237 
	#PCI_DEVICE_ID_NVIDIA_NVENET_16
 0x03E5

	)

1238 
	#PCI_DEVICE_ID_NVIDIA_NVENET_17
 0x03E6

	)

1239 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA
 0x03E7

	)

1240 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_IDE
 0x03EC

	)

1241 
	#PCI_DEVICE_ID_NVIDIA_NVENET_18
 0x03EE

	)

1242 
	#PCI_DEVICE_ID_NVIDIA_NVENET_19
 0x03EF

	)

1243 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA2
 0x03F6

	)

1244 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA3
 0x03F7

	)

1245 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP65_IDE
 0x0448

	)

1246 
	#PCI_DEVICE_ID_NVIDIA_NVENET_20
 0x0450

	)

1247 
	#PCI_DEVICE_ID_NVIDIA_NVENET_21
 0x0451

	)

1248 
	#PCI_DEVICE_ID_NVIDIA_NVENET_22
 0x0452

	)

1249 
	#PCI_DEVICE_ID_NVIDIA_NVENET_23
 0x0453

	)

1250 
	#PCI_DEVICE_ID_NVIDIA_NVENET_24
 0x054C

	)

1251 
	#PCI_DEVICE_ID_NVIDIA_NVENET_25
 0x054D

	)

1252 
	#PCI_DEVICE_ID_NVIDIA_NVENET_26
 0x054E

	)

1253 
	#PCI_DEVICE_ID_NVIDIA_NVENET_27
 0x054F

	)

1254 
	#PCI_DEVICE_ID_NVIDIA_NVENET_28
 0x07DC

	)

1255 
	#PCI_DEVICE_ID_NVIDIA_NVENET_29
 0x07DD

	)

1256 
	#PCI_DEVICE_ID_NVIDIA_NVENET_30
 0x07DE

	)

1257 
	#PCI_DEVICE_ID_NVIDIA_NVENET_31
 0x07DF

	)

1258 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP67_IDE
 0x0560

	)

1259 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP73_IDE
 0x056C

	)

1260 
	#PCI_DEVICE_ID_NVIDIA_NFORCE_MCP77_IDE
 0x0759

	)

1261 
	#PCI_DEVICE_ID_NVIDIA_NVENET_32
 0x0760

	)

1262 
	#PCI_DEVICE_ID_NVIDIA_NVENET_33
 0x0761

	)

1263 
	#PCI_DEVICE_ID_NVIDIA_NVENET_34
 0x0762

	)

1264 
	#PCI_DEVICE_ID_NVIDIA_NVENET_35
 0x0763

	)

1265 
	#PCI_DEVICE_ID_NVIDIA_NVENET_36
 0x0AB0

	)

1266 
	#PCI_DEVICE_ID_NVIDIA_NVENET_37
 0x0AB1

	)

1267 
	#PCI_DEVICE_ID_NVIDIA_NVENET_38
 0x0AB2

	)

1268 
	#PCI_DEVICE_ID_NVIDIA_NVENET_39
 0x0AB3

	)

1270 
	#PCI_VENDOR_ID_IMS
 0x10e0

	)

1271 
	#PCI_DEVICE_ID_IMS_TT128
 0x9128

	)

1272 
	#PCI_DEVICE_ID_IMS_TT3D
 0x9135

	)

1277 
	#PCI_VENDOR_ID_INTERG
 0x10—

	)

1278 
	#PCI_DEVICE_ID_INTERG_1682
 0x1682

	)

1279 
	#PCI_DEVICE_ID_INTERG_2000
 0x2000

	)

1280 
	#PCI_DEVICE_ID_INTERG_2010
 0x2010

	)

1281 
	#PCI_DEVICE_ID_INTERG_5000
 0x5000

	)

1282 
	#PCI_DEVICE_ID_INTERG_5050
 0x5050

	)

1284 
	#PCI_VENDOR_ID_REALTEK
 0x10ec

	)

1285 
	#PCI_DEVICE_ID_REALTEK_8139
 0x8139

	)

1287 
	#PCI_VENDOR_ID_XILINX
 0x10“

	)

1288 
	#PCI_DEVICE_ID_RME_DIGI96
 0x3fc0

	)

1289 
	#PCI_DEVICE_ID_RME_DIGI96_8
 0x3fc1

	)

1290 
	#PCI_DEVICE_ID_RME_DIGI96_8_PRO
 0x3fc2

	)

1291 
	#PCI_DEVICE_ID_RME_DIGI96_8_PAD_OR_PST
 0x3fc3

	)

1292 
	#PCI_DEVICE_ID_XILINX_HAMMERFALL_DSP
 0x3fc5

	)

1293 
	#PCI_DEVICE_ID_XILINX_HAMMERFALL_DSP_MADI
 0x3fc6

	)

1296 
	#PCI_VENDOR_ID_INIT
 0x1101

	)

1298 
	#PCI_VENDOR_ID_CREATIVE
 0x1102

	)

1299 
	#PCI_DEVICE_ID_CREATIVE_EMU10K1
 0x0002

	)

1300 
	#PCI_DEVICE_ID_CREATIVE_20K1
 0x0005

	)

1301 
	#PCI_DEVICE_ID_CREATIVE_20K2
 0x000b

	)

1302 
	#PCI_SUBDEVICE_ID_CREATIVE_SB0760
 0x0024

	)

1303 
	#PCI_SUBDEVICE_ID_CREATIVE_SB08801
 0x0041

	)

1304 
	#PCI_SUBDEVICE_ID_CREATIVE_SB08802
 0x0042

	)

1305 
	#PCI_SUBDEVICE_ID_CREATIVE_SB08803
 0x0043

	)

1306 
	#PCI_SUBDEVICE_ID_CREATIVE_HENDRIX
 0x6000

	)

1308 
	#PCI_VENDOR_ID_ECTIVA
 0x1102

	)

1309 
	#PCI_DEVICE_ID_ECTIVA_EV1938
 0x8938

	)

1311 
	#PCI_VENDOR_ID_TTI
 0x1103

	)

1312 
	#PCI_DEVICE_ID_TTI_HPT343
 0x0003

	)

1313 
	#PCI_DEVICE_ID_TTI_HPT366
 0x0004

	)

1314 
	#PCI_DEVICE_ID_TTI_HPT372
 0x0005

	)

1315 
	#PCI_DEVICE_ID_TTI_HPT302
 0x0006

	)

1316 
	#PCI_DEVICE_ID_TTI_HPT371
 0x0007

	)

1317 
	#PCI_DEVICE_ID_TTI_HPT374
 0x0008

	)

1318 
	#PCI_DEVICE_ID_TTI_HPT372N
 0x0009

	)

1320 
	#PCI_VENDOR_ID_VIA
 0x1106

	)

1321 
	#PCI_DEVICE_ID_VIA_8763_0
 0x0198

	)

1322 
	#PCI_DEVICE_ID_VIA_8380_0
 0x0204

	)

1323 
	#PCI_DEVICE_ID_VIA_3238_0
 0x0238

	)

1324 
	#PCI_DEVICE_ID_VIA_PT880
 0x0258

	)

1325 
	#PCI_DEVICE_ID_VIA_PT880ULTRA
 0x0308

	)

1326 
	#PCI_DEVICE_ID_VIA_PX8X0_0
 0x0259

	)

1327 
	#PCI_DEVICE_ID_VIA_3269_0
 0x0269

	)

1328 
	#PCI_DEVICE_ID_VIA_K8T800PRO_0
 0x0282

	)

1329 
	#PCI_DEVICE_ID_VIA_3296_0
 0x0296

	)

1330 
	#PCI_DEVICE_ID_VIA_8363_0
 0x0305

	)

1331 
	#PCI_DEVICE_ID_VIA_P4M800CE
 0x0314

	)

1332 
	#PCI_DEVICE_ID_VIA_VT3351
 0x0351

	)

1333 
	#PCI_DEVICE_ID_VIA_VT3364
 0x0364

	)

1334 
	#PCI_DEVICE_ID_VIA_8371_0
 0x0391

	)

1335 
	#PCI_DEVICE_ID_VIA_8501_0
 0x0501

	)

1336 
	#PCI_DEVICE_ID_VIA_82C561
 0x0561

	)

1337 
	#PCI_DEVICE_ID_VIA_82C586_1
 0x0571

	)

1338 
	#PCI_DEVICE_ID_VIA_82C576
 0x0576

	)

1339 
	#PCI_DEVICE_ID_VIA_SATA_EIDE
 0x0581

	)

1340 
	#PCI_DEVICE_ID_VIA_82C586_0
 0x0586

	)

1341 
	#PCI_DEVICE_ID_VIA_82C596
 0x0596

	)

1342 
	#PCI_DEVICE_ID_VIA_82C597_0
 0x0597

	)

1343 
	#PCI_DEVICE_ID_VIA_82C598_0
 0x0598

	)

1344 
	#PCI_DEVICE_ID_VIA_8601_0
 0x0601

	)

1345 
	#PCI_DEVICE_ID_VIA_8605_0
 0x0605

	)

1346 
	#PCI_DEVICE_ID_VIA_82C686
 0x0686

	)

1347 
	#PCI_DEVICE_ID_VIA_82C691_0
 0x0691

	)

1348 
	#PCI_DEVICE_ID_VIA_82C576_1
 0x1571

	)

1349 
	#PCI_DEVICE_ID_VIA_82C586_2
 0x3038

	)

1350 
	#PCI_DEVICE_ID_VIA_82C586_3
 0x3040

	)

1351 
	#PCI_DEVICE_ID_VIA_82C596_3
 0x3050

	)

1352 
	#PCI_DEVICE_ID_VIA_82C596B_3
 0x3051

	)

1353 
	#PCI_DEVICE_ID_VIA_82C686_4
 0x3057

	)

1354 
	#PCI_DEVICE_ID_VIA_82C686_5
 0x3058

	)

1355 
	#PCI_DEVICE_ID_VIA_8233_5
 0x3059

	)

1356 
	#PCI_DEVICE_ID_VIA_8233_0
 0x3074

	)

1357 
	#PCI_DEVICE_ID_VIA_8633_0
 0x3091

	)

1358 
	#PCI_DEVICE_ID_VIA_8367_0
 0x3099

	)

1359 
	#PCI_DEVICE_ID_VIA_8653_0
 0x3101

	)

1360 
	#PCI_DEVICE_ID_VIA_8622
 0x3102

	)

1361 
	#PCI_DEVICE_ID_VIA_8235_USB_2
 0x3104

	)

1362 
	#PCI_DEVICE_ID_VIA_8233C_0
 0x3109

	)

1363 
	#PCI_DEVICE_ID_VIA_8361
 0x3112

	)

1364 
	#PCI_DEVICE_ID_VIA_XM266
 0x3116

	)

1365 
	#PCI_DEVICE_ID_VIA_612X
 0x3119

	)

1366 
	#PCI_DEVICE_ID_VIA_862X_0
 0x3123

	)

1367 
	#PCI_DEVICE_ID_VIA_8753_0
 0x3128

	)

1368 
	#PCI_DEVICE_ID_VIA_8233A
 0x3147

	)

1369 
	#PCI_DEVICE_ID_VIA_8703_51_0
 0x3148

	)

1370 
	#PCI_DEVICE_ID_VIA_8237_SATA
 0x3149

	)

1371 
	#PCI_DEVICE_ID_VIA_XN266
 0x3156

	)

1372 
	#PCI_DEVICE_ID_VIA_6410
 0x3164

	)

1373 
	#PCI_DEVICE_ID_VIA_8754C_0
 0x3168

	)

1374 
	#PCI_DEVICE_ID_VIA_8235
 0x3177

	)

1375 
	#PCI_DEVICE_ID_VIA_8385_0
 0x3188

	)

1376 
	#PCI_DEVICE_ID_VIA_8377_0
 0x3189

	)

1377 
	#PCI_DEVICE_ID_VIA_8378_0
 0x3205

	)

1378 
	#PCI_DEVICE_ID_VIA_8783_0
 0x3208

	)

1379 
	#PCI_DEVICE_ID_VIA_8237
 0x3227

	)

1380 
	#PCI_DEVICE_ID_VIA_8251
 0x3287

	)

1381 
	#PCI_DEVICE_ID_VIA_8237A
 0x3337

	)

1382 
	#PCI_DEVICE_ID_VIA_8237S
 0x3372

	)

1383 
	#PCI_DEVICE_ID_VIA_8231
 0x8231

	)

1384 
	#PCI_DEVICE_ID_VIA_8231_4
 0x8235

	)

1385 
	#PCI_DEVICE_ID_VIA_8365_1
 0x8305

	)

1386 
	#PCI_DEVICE_ID_VIA_5324
 0x5324

	)

1387 
	#PCI_DEVICE_ID_VIA_CX700
 0x8324

	)

1388 
	#PCI_DEVICE_ID_VIA_VX800
 0x8353

	)

1389 
	#PCI_DEVICE_ID_VIA_8371_1
 0x8391

	)

1390 
	#PCI_DEVICE_ID_VIA_82C598_1
 0x8598

	)

1391 
	#PCI_DEVICE_ID_VIA_838X_1
 0xB188

	)

1392 
	#PCI_DEVICE_ID_VIA_83_87XX_1
 0xB198

	)

1394 
	#PCI_VENDOR_ID_SIEMENS
 0x110A

	)

1395 
	#PCI_DEVICE_ID_SIEMENS_DSCC4
 0x2102

	)

1398 
	#PCI_VENDOR_ID_VORTEX
 0x1119

	)

1399 
	#PCI_DEVICE_ID_VORTEX_GDT60x0
 0x0000

	)

1400 
	#PCI_DEVICE_ID_VORTEX_GDT6000B
 0x0001

	)

1401 
	#PCI_DEVICE_ID_VORTEX_GDT6x10
 0x0002

	)

1402 
	#PCI_DEVICE_ID_VORTEX_GDT6x20
 0x0003

	)

1403 
	#PCI_DEVICE_ID_VORTEX_GDT6530
 0x0004

	)

1404 
	#PCI_DEVICE_ID_VORTEX_GDT6550
 0x0005

	)

1405 
	#PCI_DEVICE_ID_VORTEX_GDT6x17
 0x0006

	)

1406 
	#PCI_DEVICE_ID_VORTEX_GDT6x27
 0x0007

	)

1407 
	#PCI_DEVICE_ID_VORTEX_GDT6537
 0x0008

	)

1408 
	#PCI_DEVICE_ID_VORTEX_GDT6557
 0x0009

	)

1409 
	#PCI_DEVICE_ID_VORTEX_GDT6x15
 0x000a

	)

1410 
	#PCI_DEVICE_ID_VORTEX_GDT6x25
 0x000b

	)

1411 
	#PCI_DEVICE_ID_VORTEX_GDT6535
 0x000c

	)

1412 
	#PCI_DEVICE_ID_VORTEX_GDT6555
 0x000d

	)

1413 
	#PCI_DEVICE_ID_VORTEX_GDT6x17RP
 0x0100

	)

1414 
	#PCI_DEVICE_ID_VORTEX_GDT6x27RP
 0x0101

	)

1415 
	#PCI_DEVICE_ID_VORTEX_GDT6537RP
 0x0102

	)

1416 
	#PCI_DEVICE_ID_VORTEX_GDT6557RP
 0x0103

	)

1417 
	#PCI_DEVICE_ID_VORTEX_GDT6x11RP
 0x0104

	)

1418 
	#PCI_DEVICE_ID_VORTEX_GDT6x21RP
 0x0105

	)

1420 
	#PCI_VENDOR_ID_EF
 0x111a

	)

1421 
	#PCI_DEVICE_ID_EF_ATM_FPGA
 0x0000

	)

1422 
	#PCI_DEVICE_ID_EF_ATM_ASIC
 0x0002

	)

1423 
	#PCI_VENDOR_ID_EF_ATM_LANAI2
 0x0003

	)

1424 
	#PCI_VENDOR_ID_EF_ATM_LANAIHB
 0x0005

	)

1426 
	#PCI_VENDOR_ID_IDT
 0x111d

	)

1427 
	#PCI_DEVICE_ID_IDT_IDT77201
 0x0001

	)

1429 
	#PCI_VENDOR_ID_FORE
 0x1127

	)

1430 
	#PCI_DEVICE_ID_FORE_PCA200E
 0x0300

	)

1433 
	#PCI_VENDOR_ID_PHILIPS
 0x1131

	)

1434 
	#PCI_DEVICE_ID_PHILIPS_SAA7146
 0x7146

	)

1435 
	#PCI_DEVICE_ID_PHILIPS_SAA9730
 0x9730

	)

1437 
	#PCI_VENDOR_ID_EICON
 0x1133

	)

1438 
	#PCI_DEVICE_ID_EICON_DIVA20
 0xe002

	)

1439 
	#PCI_DEVICE_ID_EICON_DIVA20_U
 0xe004

	)

1440 
	#PCI_DEVICE_ID_EICON_DIVA201
 0xe005

	)

1441 
	#PCI_DEVICE_ID_EICON_DIVA202
 0xe00b

	)

1442 
	#PCI_DEVICE_ID_EICON_MAESTRA
 0xe010

	)

1443 
	#PCI_DEVICE_ID_EICON_MAESTRAQ
 0xe012

	)

1444 
	#PCI_DEVICE_ID_EICON_MAESTRAQ_U
 0xe013

	)

1445 
	#PCI_DEVICE_ID_EICON_MAESTRAP
 0xe014

	)

1447 
	#PCI_VENDOR_ID_CISCO
 0x1137

	)

1449 
	#PCI_VENDOR_ID_ZIATECH
 0x1138

	)

1450 
	#PCI_DEVICE_ID_ZIATECH_5550_HC
 0x5550

	)

1454 
	#PCI_VENDOR_ID_SYSKONNECT
 0x1148

	)

1455 
	#PCI_DEVICE_ID_SYSKONNECT_TR
 0x4200

	)

1456 
	#PCI_DEVICE_ID_SYSKONNECT_GE
 0x4300

	)

1457 
	#PCI_DEVICE_ID_SYSKONNECT_YU
 0x4320

	)

1458 
	#PCI_DEVICE_ID_SYSKONNECT_9DXX
 0x4400

	)

1459 
	#PCI_DEVICE_ID_SYSKONNECT_9MXX
 0x4500

	)

1462 
	#PCI_VENDOR_ID_DIGI
 0x114f

	)

1463 
	#PCI_DEVICE_ID_DIGI_DF_M_IOM2_E
 0x0070

	)

1464 
	#PCI_DEVICE_ID_DIGI_DF_M_E
 0x0071

	)

1465 
	#PCI_DEVICE_ID_DIGI_DF_M_IOM2_A
 0x0072

	)

1466 
	#PCI_DEVICE_ID_DIGI_DF_M_A
 0x0073

	)

1467 
	#PCI_DEVICE_ID_NEO_2DB9
 0x00C8

	)

1468 
	#PCI_DEVICE_ID_NEO_2DB9PRI
 0x00C9

	)

1469 
	#PCI_DEVICE_ID_NEO_2RJ45
 0x00CA

	)

1470 
	#PCI_DEVICE_ID_NEO_2RJ45PRI
 0x00CB

	)

1471 
	#PCIE_DEVICE_ID_NEO_4_IBM
 0x00F4

	)

1472 
	#PCIE_DEVICE_ID_NEO_2_OX_IBM
 0x00F6

	)

1474 
	#PCI_VENDOR_ID_XIRCOM
 0x115d

	)

1475 
	#PCI_DEVICE_ID_XIRCOM_RBM56G
 0x0101

	)

1476 
	#PCI_DEVICE_ID_XIRCOM_X3201_MDM
 0x0103

	)

1479 
	#PCI_VENDOR_ID_SERVERWORKS
 0x1166

	)

1480 
	#PCI_DEVICE_ID_SERVERWORKS_HE
 0x0008

	)

1481 
	#PCI_DEVICE_ID_SERVERWORKS_LE
 0x0009

	)

1482 
	#PCI_DEVICE_ID_SERVERWORKS_GCNB_LE
 0x0017

	)

1483 
	#PCI_DEVICE_ID_SERVERWORKS_HT1000_PXB
 0x0036

	)

1484 
	#PCI_DEVICE_ID_SERVERWORKS_EPB
 0x0103

	)

1485 
	#PCI_DEVICE_ID_SERVERWORKS_HT2000_PCIE
 0x0132

	)

1486 
	#PCI_DEVICE_ID_SERVERWORKS_OSB4
 0x0200

	)

1487 
	#PCI_DEVICE_ID_SERVERWORKS_CSB5
 0x0201

	)

1488 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6
 0x0203

	)

1489 
	#PCI_DEVICE_ID_SERVERWORKS_HT1000SB
 0x0205

	)

1490 
	#PCI_DEVICE_ID_SERVERWORKS_OSB4IDE
 0x0211

	)

1491 
	#PCI_DEVICE_ID_SERVERWORKS_CSB5IDE
 0x0212

	)

1492 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6IDE
 0x0213

	)

1493 
	#PCI_DEVICE_ID_SERVERWORKS_HT1000IDE
 0x0214

	)

1494 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6IDE2
 0x0217

	)

1495 
	#PCI_DEVICE_ID_SERVERWORKS_CSB6LPC
 0x0227

	)

1496 
	#PCI_DEVICE_ID_SERVERWORKS_HT1100LD
 0x0408

	)

1498 
	#PCI_VENDOR_ID_SBE
 0x1176

	)

1499 
	#PCI_DEVICE_ID_SBE_WANXL100
 0x0301

	)

1500 
	#PCI_DEVICE_ID_SBE_WANXL200
 0x0302

	)

1501 
	#PCI_DEVICE_ID_SBE_WANXL400
 0x0104

	)

1503 
	#PCI_VENDOR_ID_TOSHIBA
 0x1179

	)

1504 
	#PCI_DEVICE_ID_TOSHIBA_PICCOLO
 0x0102

	)

1505 
	#PCI_DEVICE_ID_TOSHIBA_PICCOLO_1
 0x0103

	)

1506 
	#PCI_DEVICE_ID_TOSHIBA_PICCOLO_2
 0x0105

	)

1507 
	#PCI_DEVICE_ID_TOSHIBA_TOPIC95
 0x060a

	)

1508 
	#PCI_DEVICE_ID_TOSHIBA_TOPIC97
 0x060f

	)

1509 
	#PCI_DEVICE_ID_TOSHIBA_TOPIC100
 0x0617

	)

1511 
	#PCI_VENDOR_ID_TOSHIBA_2
 0x102f

	)

1512 
	#PCI_DEVICE_ID_TOSHIBA_TC35815CF
 0x0030

	)

1513 
	#PCI_DEVICE_ID_TOSHIBA_TC86C001_MISC
 0x0108

	)

1514 
	#PCI_DEVICE_ID_TOSHIBA_SPIDER_NET
 0x01b3

	)

1516 
	#PCI_VENDOR_ID_ATTO
 0x117c

	)

1517 
	#PCI_VENDOR_ID_RICOH
 0x1180

	)

1518 
	#PCI_DEVICE_ID_RICOH_RL5C465
 0x0465

	)

1519 
	#PCI_DEVICE_ID_RICOH_RL5C466
 0x0466

	)

1520 
	#PCI_DEVICE_ID_RICOH_RL5C475
 0x0475

	)

1521 
	#PCI_DEVICE_ID_RICOH_RL5C476
 0x0476

	)

1522 
	#PCI_DEVICE_ID_RICOH_RL5C478
 0x0478

	)

1523 
	#PCI_DEVICE_ID_RICOH_R5C822
 0x0822

	)

1525 
	#PCI_VENDOR_ID_DLINK
 0x1186

	)

1526 
	#PCI_DEVICE_ID_DLINK_DGE510T
 0x4c00

	)

1528 
	#PCI_VENDOR_ID_ARTOP
 0x1191

	)

1529 
	#PCI_DEVICE_ID_ARTOP_ATP850UF
 0x0005

	)

1530 
	#PCI_DEVICE_ID_ARTOP_ATP860
 0x0006

	)

1531 
	#PCI_DEVICE_ID_ARTOP_ATP860R
 0x0007

	)

1532 
	#PCI_DEVICE_ID_ARTOP_ATP865
 0x0008

	)

1533 
	#PCI_DEVICE_ID_ARTOP_ATP865R
 0x0009

	)

1534 
	#PCI_DEVICE_ID_ARTOP_AEC7610
 0x8002

	)

1535 
	#PCI_DEVICE_ID_ARTOP_AEC7612UW
 0x8010

	)

1536 
	#PCI_DEVICE_ID_ARTOP_AEC7612U
 0x8020

	)

1537 
	#PCI_DEVICE_ID_ARTOP_AEC7612S
 0x8030

	)

1538 
	#PCI_DEVICE_ID_ARTOP_AEC7612D
 0x8040

	)

1539 
	#PCI_DEVICE_ID_ARTOP_AEC7612SUW
 0x8050

	)

1540 
	#PCI_DEVICE_ID_ARTOP_8060
 0x8060

	)

1542 
	#PCI_VENDOR_ID_ZEITNET
 0x1193

	)

1543 
	#PCI_DEVICE_ID_ZEITNET_1221
 0x0001

	)

1544 
	#PCI_DEVICE_ID_ZEITNET_1225
 0x0002

	)

1547 
	#PCI_VENDOR_ID_FUJITSU_ME
 0x119e

	)

1548 
	#PCI_DEVICE_ID_FUJITSU_FS155
 0x0001

	)

1549 
	#PCI_DEVICE_ID_FUJITSU_FS50
 0x0003

	)

1551 
	#PCI_SUBVENDOR_ID_KEYSPAN
 0x11a9

	)

1552 
	#PCI_SUBDEVICE_ID_KEYSPAN_SX2
 0x5334

	)

1554 
	#PCI_VENDOR_ID_MARVELL
 0x11ab

	)

1555 
	#PCI_DEVICE_ID_MARVELL_GT64111
 0x4146

	)

1556 
	#PCI_DEVICE_ID_MARVELL_GT64260
 0x6430

	)

1557 
	#PCI_DEVICE_ID_MARVELL_MV64360
 0x6460

	)

1558 
	#PCI_DEVICE_ID_MARVELL_MV64460
 0x6480

	)

1559 
	#PCI_DEVICE_ID_MARVELL_GT96100
 0x9652

	)

1560 
	#PCI_DEVICE_ID_MARVELL_GT96100A
 0x9653

	)

1563 
	#PCI_VENDOR_ID_V3
 0x11b0

	)

1564 
	#PCI_DEVICE_ID_V3_V960
 0x0001

	)

1565 
	#PCI_DEVICE_ID_V3_V351
 0x0002

	)

1568 
	#PCI_VENDOR_ID_ATT
 0x11c1

	)

1569 
	#PCI_DEVICE_ID_ATT_VENUS_MODEM
 0x480

	)

1572 
	#PCI_VENDOR_ID_SPECIALIX
 0x11cb

	)

1573 
	#PCI_DEVICE_ID_SPECIALIX_IO8
 0x2000

	)

1574 
	#PCI_DEVICE_ID_SPECIALIX_RIO
 0x8000

	)

1575 
	#PCI_SUBDEVICE_ID_SPECIALIX_SPEED4
 0xa004

	)

1578 
	#PCI_VENDOR_ID_ANALOG_DEVICES
 0x11d4

	)

1579 
	#PCI_DEVICE_ID_AD1889JS
 0x1889

	)

1582 
	#PCI_DEVICE_ID_SEGA_BBA
 0x1234

	)

1584 
	#PCI_VENDOR_ID_ZORAN
 0x11de

	)

1585 
	#PCI_DEVICE_ID_ZORAN_36057
 0x6057

	)

1586 
	#PCI_DEVICE_ID_ZORAN_36120
 0x6120

	)

1589 
	#PCI_VENDOR_ID_COMPEX
 0x11f6

	)

1590 
	#PCI_DEVICE_ID_COMPEX_ENET100VG4
 0x0112

	)

1592 
	#PCI_VENDOR_ID_RP
 0x11ã

	)

1593 
	#PCI_DEVICE_ID_RP32INTF
 0x0001

	)

1594 
	#PCI_DEVICE_ID_RP8INTF
 0x0002

	)

1595 
	#PCI_DEVICE_ID_RP16INTF
 0x0003

	)

1596 
	#PCI_DEVICE_ID_RP4QUAD
 0x0004

	)

1597 
	#PCI_DEVICE_ID_RP8OCTA
 0x0005

	)

1598 
	#PCI_DEVICE_ID_RP8J
 0x0006

	)

1599 
	#PCI_DEVICE_ID_RP4J
 0x0007

	)

1600 
	#PCI_DEVICE_ID_RP8SNI
 0x0008

	)

1601 
	#PCI_DEVICE_ID_RP16SNI
 0x0009

	)

1602 
	#PCI_DEVICE_ID_RPP4
 0x000A

	)

1603 
	#PCI_DEVICE_ID_RPP8
 0x000B

	)

1604 
	#PCI_DEVICE_ID_RP4M
 0x000D

	)

1605 
	#PCI_DEVICE_ID_RP2_232
 0x000E

	)

1606 
	#PCI_DEVICE_ID_RP2_422
 0x000F

	)

1607 
	#PCI_DEVICE_ID_URP32INTF
 0x0801

	)

1608 
	#PCI_DEVICE_ID_URP8INTF
 0x0802

	)

1609 
	#PCI_DEVICE_ID_URP16INTF
 0x0803

	)

1610 
	#PCI_DEVICE_ID_URP8OCTA
 0x0805

	)

1611 
	#PCI_DEVICE_ID_UPCI_RM3_8PORT
 0x080C

	)

1612 
	#PCI_DEVICE_ID_UPCI_RM3_4PORT
 0x080D

	)

1613 
	#PCI_DEVICE_ID_CRP16INTF
 0x0903

	)

1615 
	#PCI_VENDOR_ID_CYCLADES
 0x120e

	)

1616 
	#PCI_DEVICE_ID_CYCLOM_Y_Lo
 0x0100

	)

1617 
	#PCI_DEVICE_ID_CYCLOM_Y_Hi
 0x0101

	)

1618 
	#PCI_DEVICE_ID_CYCLOM_4Y_Lo
 0x0102

	)

1619 
	#PCI_DEVICE_ID_CYCLOM_4Y_Hi
 0x0103

	)

1620 
	#PCI_DEVICE_ID_CYCLOM_8Y_Lo
 0x0104

	)

1621 
	#PCI_DEVICE_ID_CYCLOM_8Y_Hi
 0x0105

	)

1622 
	#PCI_DEVICE_ID_CYCLOM_Z_Lo
 0x0200

	)

1623 
	#PCI_DEVICE_ID_CYCLOM_Z_Hi
 0x0201

	)

1624 
	#PCI_DEVICE_ID_PC300_RX_2
 0x0300

	)

1625 
	#PCI_DEVICE_ID_PC300_RX_1
 0x0301

	)

1626 
	#PCI_DEVICE_ID_PC300_TE_2
 0x0310

	)

1627 
	#PCI_DEVICE_ID_PC300_TE_1
 0x0311

	)

1628 
	#PCI_DEVICE_ID_PC300_TE_M_2
 0x0320

	)

1629 
	#PCI_DEVICE_ID_PC300_TE_M_1
 0x0321

	)

1631 
	#PCI_VENDOR_ID_ESSENTIAL
 0x120f

	)

1632 
	#PCI_DEVICE_ID_ESSENTIAL_ROADRUNNER
 0x0001

	)

1634 
	#PCI_VENDOR_ID_O2
 0x1217

	)

1635 
	#PCI_DEVICE_ID_O2_6729
 0x6729

	)

1636 
	#PCI_DEVICE_ID_O2_6730
 0x673a

	)

1637 
	#PCI_DEVICE_ID_O2_6832
 0x6832

	)

1638 
	#PCI_DEVICE_ID_O2_6836
 0x6836

	)

1639 
	#PCI_DEVICE_ID_O2_8120
 0x8120

	)

1640 
	#PCI_DEVICE_ID_O2_8220
 0x8220

	)

1641 
	#PCI_DEVICE_ID_O2_8221
 0x8221

	)

1642 
	#PCI_DEVICE_ID_O2_8320
 0x8320

	)

1643 
	#PCI_DEVICE_ID_O2_8321
 0x8321

	)

1645 
	#PCI_VENDOR_ID_3DFX
 0x121a

	)

1646 
	#PCI_DEVICE_ID_3DFX_VOODOO
 0x0001

	)

1647 
	#PCI_DEVICE_ID_3DFX_VOODOO2
 0x0002

	)

1648 
	#PCI_DEVICE_ID_3DFX_BANSHEE
 0x0003

	)

1649 
	#PCI_DEVICE_ID_3DFX_VOODOO3
 0x0005

	)

1650 
	#PCI_DEVICE_ID_3DFX_VOODOO5
 0x0009

	)

1654 
	#PCI_VENDOR_ID_AVM
 0x1244

	)

1655 
	#PCI_DEVICE_ID_AVM_B1
 0x0700

	)

1656 
	#PCI_DEVICE_ID_AVM_C4
 0x0800

	)

1657 
	#PCI_DEVICE_ID_AVM_A1
 0x0a00

	)

1658 
	#PCI_DEVICE_ID_AVM_A1_V2
 0x0e00

	)

1659 
	#PCI_DEVICE_ID_AVM_C2
 0x1100

	)

1660 
	#PCI_DEVICE_ID_AVM_T1
 0x1200

	)

1663 
	#PCI_VENDOR_ID_STALLION
 0x124d

	)

1666 
	#PCI_VENDOR_ID_AT
 0x1259

	)

1667 
	#PCI_SUBDEVICE_ID_AT_2700FX
 0x2701

	)

1668 
	#PCI_SUBDEVICE_ID_AT_2701FX
 0x2703

	)

1670 
	#PCI_VENDOR_ID_ESS
 0x125d

	)

1671 
	#PCI_DEVICE_ID_ESS_ESS1968
 0x1968

	)

1672 
	#PCI_DEVICE_ID_ESS_ESS1978
 0x1978

	)

1673 
	#PCI_DEVICE_ID_ESS_ALLEGRO_1
 0x1988

	)

1674 
	#PCI_DEVICE_ID_ESS_ALLEGRO
 0x1989

	)

1675 
	#PCI_DEVICE_ID_ESS_CANYON3D_2LE
 0x1990

	)

1676 
	#PCI_DEVICE_ID_ESS_CANYON3D_2
 0x1992

	)

1677 
	#PCI_DEVICE_ID_ESS_MAESTRO3
 0x1998

	)

1678 
	#PCI_DEVICE_ID_ESS_MAESTRO3_1
 0x1999

	)

1679 
	#PCI_DEVICE_ID_ESS_MAESTRO3_HW
 0x199a

	)

1680 
	#PCI_DEVICE_ID_ESS_MAESTRO3_2
 0x199b

	)

1682 
	#PCI_VENDOR_ID_SATSAGEM
 0x1267

	)

1683 
	#PCI_DEVICE_ID_SATSAGEM_NICCY
 0x1016

	)

1686 
	#PCI_VENDOR_ID_ENSONIQ
 0x1274

	)

1687 
	#PCI_DEVICE_ID_ENSONIQ_CT5880
 0x5880

	)

1688 
	#PCI_DEVICE_ID_ENSONIQ_ES1370
 0x5000

	)

1689 
	#PCI_DEVICE_ID_ENSONIQ_ES1371
 0x1371

	)

1691 
	#PCI_VENDOR_ID_TRANSMETA
 0x1279

	)

1692 
	#PCI_DEVICE_ID_EFFICEON
 0x0060

	)

1694 
	#PCI_VENDOR_ID_ROCKWELL
 0x127A

	)

1696 
	#PCI_VENDOR_ID_ITE
 0x1283

	)

1697 
	#PCI_DEVICE_ID_ITE_IT8172G
 0x8172

	)

1698 
	#PCI_DEVICE_ID_ITE_IT8172G_AUDIO
 0x0801

	)

1699 
	#PCI_DEVICE_ID_ITE_8211
 0x8211

	)

1700 
	#PCI_DEVICE_ID_ITE_8212
 0x8212

	)

1701 
	#PCI_DEVICE_ID_ITE_8213
 0x8213

	)

1702 
	#PCI_DEVICE_ID_ITE_8872
 0x8872

	)

1703 
	#PCI_DEVICE_ID_ITE_IT8330G_0
 0xe886

	)

1706 
	#PCI_DEVICE_ID_ESS_ESS0100
 0x0100

	)

1708 
	#PCI_VENDOR_ID_ALTEON
 0x12«

	)

1711 
	#PCI_SUBVENDOR_ID_CONNECT_TECH
 0x12c4

	)

1712 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_232
 0x0001

	)

1713 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH4_232
 0x0002

	)

1714 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_232
 0x0003

	)

1715 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_485
 0x0004

	)

1716 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_485_4_4
 0x0005

	)

1717 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH4_485
 0x0006

	)

1718 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH4_485_2_2
 0x0007

	)

1719 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_485
 0x0008

	)

1720 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH8_485_2_6
 0x0009

	)

1721 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH081101V1
 0x000A

	)

1722 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH041101V1
 0x000B

	)

1723 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_20MHZ
 0x000C

	)

1724 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_BH2_PTM
 0x000D

	)

1725 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_NT960PCI
 0x0100

	)

1726 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_TITAN_2
 0x0201

	)

1727 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_TITAN_4
 0x0202

	)

1728 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2_232
 0x0300

	)

1729 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4_232
 0x0301

	)

1730 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_8_232
 0x0302

	)

1731 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_1_1
 0x0310

	)

1732 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2_2
 0x0311

	)

1733 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4_4
 0x0312

	)

1734 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2
 0x0320

	)

1735 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4
 0x0321

	)

1736 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_8
 0x0322

	)

1737 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_2_485
 0x0330

	)

1738 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_4_485
 0x0331

	)

1739 
	#PCI_SUBDEVICE_ID_CONNECT_TECH_PCI_UART_8_485
 0x0332

	)

1742 
	#PCI_VENDOR_ID_NVIDIA_SGS
 0x12d2

	)

1743 
	#PCI_DEVICE_ID_NVIDIA_SGS_RIVA128
 0x0018

	)

1745 
	#PCI_SUBVENDOR_ID_CHASE_PCIFAST
 0x12E0

	)

1746 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST4
 0x0031

	)

1747 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST8
 0x0021

	)

1748 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST16
 0x0011

	)

1749 
	#PCI_SUBDEVICE_ID_CHASE_PCIFAST16FMC
 0x0041

	)

1750 
	#PCI_SUBVENDOR_ID_CHASE_PCIRAS
 0x124D

	)

1751 
	#PCI_SUBDEVICE_ID_CHASE_PCIRAS4
 0xF001

	)

1752 
	#PCI_SUBDEVICE_ID_CHASE_PCIRAS8
 0xF010

	)

1754 
	#PCI_VENDOR_ID_AUREAL
 0x12eb

	)

1755 
	#PCI_DEVICE_ID_AUREAL_VORTEX_1
 0x0001

	)

1756 
	#PCI_DEVICE_ID_AUREAL_VORTEX_2
 0x0002

	)

1757 
	#PCI_DEVICE_ID_AUREAL_ADVANTAGE
 0x0003

	)

1759 
	#PCI_VENDOR_ID_ELECTRONICDESIGNGMBH
 0x12f8

	)

1760 
	#PCI_DEVICE_ID_LML_33R10
 0x8a02

	)

1763 
	#PCI_VENDOR_ID_SIIG
 0x131f

	)

1764 
	#PCI_SUBVENDOR_ID_SIIG
 0x131f

	)

1765 
	#PCI_DEVICE_ID_SIIG_1S_10x_550
 0x1000

	)

1766 
	#PCI_DEVICE_ID_SIIG_1S_10x_650
 0x1001

	)

1767 
	#PCI_DEVICE_ID_SIIG_1S_10x_850
 0x1002

	)

1768 
	#PCI_DEVICE_ID_SIIG_1S1P_10x_550
 0x1010

	)

1769 
	#PCI_DEVICE_ID_SIIG_1S1P_10x_650
 0x1011

	)

1770 
	#PCI_DEVICE_ID_SIIG_1S1P_10x_850
 0x1012

	)

1771 
	#PCI_DEVICE_ID_SIIG_1P_10x
 0x1020

	)

1772 
	#PCI_DEVICE_ID_SIIG_2P_10x
 0x1021

	)

1773 
	#PCI_DEVICE_ID_SIIG_2S_10x_550
 0x1030

	)

1774 
	#PCI_DEVICE_ID_SIIG_2S_10x_650
 0x1031

	)

1775 
	#PCI_DEVICE_ID_SIIG_2S_10x_850
 0x1032

	)

1776 
	#PCI_DEVICE_ID_SIIG_2S1P_10x_550
 0x1034

	)

1777 
	#PCI_DEVICE_ID_SIIG_2S1P_10x_650
 0x1035

	)

1778 
	#PCI_DEVICE_ID_SIIG_2S1P_10x_850
 0x1036

	)

1779 
	#PCI_DEVICE_ID_SIIG_4S_10x_550
 0x1050

	)

1780 
	#PCI_DEVICE_ID_SIIG_4S_10x_650
 0x1051

	)

1781 
	#PCI_DEVICE_ID_SIIG_4S_10x_850
 0x1052

	)

1782 
	#PCI_DEVICE_ID_SIIG_1S_20x_550
 0x2000

	)

1783 
	#PCI_DEVICE_ID_SIIG_1S_20x_650
 0x2001

	)

1784 
	#PCI_DEVICE_ID_SIIG_1S_20x_850
 0x2002

	)

1785 
	#PCI_DEVICE_ID_SIIG_1P_20x
 0x2020

	)

1786 
	#PCI_DEVICE_ID_SIIG_2P_20x
 0x2021

	)

1787 
	#PCI_DEVICE_ID_SIIG_2S_20x_550
 0x2030

	)

1788 
	#PCI_DEVICE_ID_SIIG_2S_20x_650
 0x2031

	)

1789 
	#PCI_DEVICE_ID_SIIG_2S_20x_850
 0x2032

	)

1790 
	#PCI_DEVICE_ID_SIIG_2P1S_20x_550
 0x2040

	)

1791 
	#PCI_DEVICE_ID_SIIG_2P1S_20x_650
 0x2041

	)

1792 
	#PCI_DEVICE_ID_SIIG_2P1S_20x_850
 0x2042

	)

1793 
	#PCI_DEVICE_ID_SIIG_1S1P_20x_550
 0x2010

	)

1794 
	#PCI_DEVICE_ID_SIIG_1S1P_20x_650
 0x2011

	)

1795 
	#PCI_DEVICE_ID_SIIG_1S1P_20x_850
 0x2012

	)

1796 
	#PCI_DEVICE_ID_SIIG_4S_20x_550
 0x2050

	)

1797 
	#PCI_DEVICE_ID_SIIG_4S_20x_650
 0x2051

	)

1798 
	#PCI_DEVICE_ID_SIIG_4S_20x_850
 0x2052

	)

1799 
	#PCI_DEVICE_ID_SIIG_2S1P_20x_550
 0x2060

	)

1800 
	#PCI_DEVICE_ID_SIIG_2S1P_20x_650
 0x2061

	)

1801 
	#PCI_DEVICE_ID_SIIG_2S1P_20x_850
 0x2062

	)

1802 
	#PCI_DEVICE_ID_SIIG_8S_20x_550
 0x2080

	)

1803 
	#PCI_DEVICE_ID_SIIG_8S_20x_650
 0x2081

	)

1804 
	#PCI_DEVICE_ID_SIIG_8S_20x_850
 0x2082

	)

1805 
	#PCI_SUBDEVICE_ID_SIIG_QUARTET_SERIAL
 0x2050

	)

1807 
	#PCI_VENDOR_ID_RADISYS
 0x1331

	)

1809 
	#PCI_VENDOR_ID_DOMEX
 0x134a

	)

1810 
	#PCI_DEVICE_ID_DOMEX_DMX3191D
 0x0001

	)

1812 
	#PCI_VENDOR_ID_INTASHIELD
 0x135a

	)

1813 
	#PCI_DEVICE_ID_INTASHIELD_IS200
 0x0d80

	)

1815 
	#PCI_VENDOR_ID_QUATECH
 0x135C

	)

1816 
	#PCI_DEVICE_ID_QUATECH_QSC100
 0x0010

	)

1817 
	#PCI_DEVICE_ID_QUATECH_DSC100
 0x0020

	)

1818 
	#PCI_DEVICE_ID_QUATECH_ESC100D
 0x0050

	)

1819 
	#PCI_DEVICE_ID_QUATECH_ESC100M
 0x0060

	)

1821 
	#PCI_VENDOR_ID_SEALEVEL
 0x135e

	)

1822 
	#PCI_DEVICE_ID_SEALEVEL_U530
 0x7101

	)

1823 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM2
 0x7201

	)

1824 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM422
 0x7402

	)

1825 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM232
 0x7202

	)

1826 
	#PCI_DEVICE_ID_SEALEVEL_COMM4
 0x7401

	)

1827 
	#PCI_DEVICE_ID_SEALEVEL_COMM8
 0x7801

	)

1828 
	#PCI_DEVICE_ID_SEALEVEL_UCOMM8
 0x7804

	)

1830 
	#PCI_VENDOR_ID_HYPERCOPE
 0x1365

	)

1831 
	#PCI_DEVICE_ID_HYPERCOPE_PLX
 0x9050

	)

1832 
	#PCI_SUBDEVICE_ID_HYPERCOPE_OLD_ERGO
 0x0104

	)

1833 
	#PCI_SUBDEVICE_ID_HYPERCOPE_ERGO
 0x0106

	)

1834 
	#PCI_SUBDEVICE_ID_HYPERCOPE_METRO
 0x0107

	)

1835 
	#PCI_SUBDEVICE_ID_HYPERCOPE_CHAMP2
 0x0108

	)

1837 
	#PCI_VENDOR_ID_KAWASAKI
 0x136b

	)

1838 
	#PCI_DEVICE_ID_MCHIP_KL5A72002
 0xff01

	)

1840 
	#PCI_VENDOR_ID_CNET
 0x1371

	)

1841 
	#PCI_DEVICE_ID_CNET_GIGACARD
 0x434e

	)

1843 
	#PCI_VENDOR_ID_LMC
 0x1376

	)

1844 
	#PCI_DEVICE_ID_LMC_HSSI
 0x0003

	)

1845 
	#PCI_DEVICE_ID_LMC_DS3
 0x0004

	)

1846 
	#PCI_DEVICE_ID_LMC_SSI
 0x0005

	)

1847 
	#PCI_DEVICE_ID_LMC_T1
 0x0006

	)

1850 
	#PCI_VENDOR_ID_NETGEAR
 0x1385

	)

1851 
	#PCI_DEVICE_ID_NETGEAR_GA620
 0x620a

	)

1853 
	#PCI_VENDOR_ID_APPLICOM
 0x1389

	)

1854 
	#PCI_DEVICE_ID_APPLICOM_PCIGENERIC
 0x0001

	)

1855 
	#PCI_DEVICE_ID_APPLICOM_PCI2000IBS_CAN
 0x0002

	)

1856 
	#PCI_DEVICE_ID_APPLICOM_PCI2000PFB
 0x0003

	)

1858 
	#PCI_VENDOR_ID_MOXA
 0x1393

	)

1859 
	#PCI_DEVICE_ID_MOXA_RC7000
 0x0001

	)

1860 
	#PCI_DEVICE_ID_MOXA_CP102
 0x1020

	)

1861 
	#PCI_DEVICE_ID_MOXA_CP102UL
 0x1021

	)

1862 
	#PCI_DEVICE_ID_MOXA_CP102U
 0x1022

	)

1863 
	#PCI_DEVICE_ID_MOXA_C104
 0x1040

	)

1864 
	#PCI_DEVICE_ID_MOXA_CP104U
 0x1041

	)

1865 
	#PCI_DEVICE_ID_MOXA_CP104JU
 0x1042

	)

1866 
	#PCI_DEVICE_ID_MOXA_CT114
 0x1140

	)

1867 
	#PCI_DEVICE_ID_MOXA_CP114
 0x1141

	)

1868 
	#PCI_DEVICE_ID_MOXA_CP118U
 0x1180

	)

1869 
	#PCI_DEVICE_ID_MOXA_CP132
 0x1320

	)

1870 
	#PCI_DEVICE_ID_MOXA_CP132U
 0x1321

	)

1871 
	#PCI_DEVICE_ID_MOXA_CP134U
 0x1340

	)

1872 
	#PCI_DEVICE_ID_MOXA_C168
 0x1680

	)

1873 
	#PCI_DEVICE_ID_MOXA_CP168U
 0x1681

	)

1875 
	#PCI_VENDOR_ID_CCD
 0x1397

	)

1876 
	#PCI_DEVICE_ID_CCD_2BD0
 0x2bd0

	)

1877 
	#PCI_DEVICE_ID_CCD_B000
 0xb000

	)

1878 
	#PCI_DEVICE_ID_CCD_B006
 0xb006

	)

1879 
	#PCI_DEVICE_ID_CCD_B007
 0xb007

	)

1880 
	#PCI_DEVICE_ID_CCD_B008
 0xb008

	)

1881 
	#PCI_DEVICE_ID_CCD_B009
 0xb009

	)

1882 
	#PCI_DEVICE_ID_CCD_B00A
 0xb00a

	)

1883 
	#PCI_DEVICE_ID_CCD_B00B
 0xb00b

	)

1884 
	#PCI_DEVICE_ID_CCD_B00C
 0xb00c

	)

1885 
	#PCI_DEVICE_ID_CCD_B100
 0xb100

	)

1886 
	#PCI_DEVICE_ID_CCD_B700
 0xb700

	)

1887 
	#PCI_DEVICE_ID_CCD_B701
 0xb701

	)

1889 
	#PCI_VENDOR_ID_EXAR
 0x13a8

	)

1890 
	#PCI_DEVICE_ID_EXAR_XR17C152
 0x0152

	)

1891 
	#PCI_DEVICE_ID_EXAR_XR17C154
 0x0154

	)

1892 
	#PCI_DEVICE_ID_EXAR_XR17C158
 0x0158

	)

1894 
	#PCI_VENDOR_ID_MICROGATE
 0x13c0

	)

1895 
	#PCI_DEVICE_ID_MICROGATE_USC
 0x0010

	)

1896 
	#PCI_DEVICE_ID_MICROGATE_SCA
 0x0030

	)

1898 
	#PCI_VENDOR_ID_3WARE
 0x13C1

	)

1899 
	#PCI_DEVICE_ID_3WARE_1000
 0x1000

	)

1900 
	#PCI_DEVICE_ID_3WARE_7000
 0x1001

	)

1901 
	#PCI_DEVICE_ID_3WARE_9000
 0x1002

	)

1903 
	#PCI_VENDOR_ID_IOMEGA
 0x13ÿ

	)

1904 
	#PCI_DEVICE_ID_IOMEGA_BUZ
 0x4231

	)

1906 
	#PCI_VENDOR_ID_ABOCOM
 0x13D1

	)

1907 
	#PCI_DEVICE_ID_ABOCOM_2BD1
 0x2BD1

	)

1909 
	#PCI_VENDOR_ID_CMEDIA
 0x13f6

	)

1910 
	#PCI_DEVICE_ID_CMEDIA_CM8338A
 0x0100

	)

1911 
	#PCI_DEVICE_ID_CMEDIA_CM8338B
 0x0101

	)

1912 
	#PCI_DEVICE_ID_CMEDIA_CM8738
 0x0111

	)

1913 
	#PCI_DEVICE_ID_CMEDIA_CM8738B
 0x0112

	)

1915 
	#PCI_VENDOR_ID_LAVA
 0x1407

	)

1916 
	#PCI_DEVICE_ID_LAVA_DSERIAL
 0x0100

	)

1917 
	#PCI_DEVICE_ID_LAVA_QUATRO_A
 0x0101

	)

1918 
	#PCI_DEVICE_ID_LAVA_QUATRO_B
 0x0102

	)

1919 
	#PCI_DEVICE_ID_LAVA_OCTO_A
 0x0180

	)

1920 
	#PCI_DEVICE_ID_LAVA_OCTO_B
 0x0181

	)

1921 
	#PCI_DEVICE_ID_LAVA_PORT_PLUS
 0x0200

	)

1922 
	#PCI_DEVICE_ID_LAVA_QUAD_A
 0x0201

	)

1923 
	#PCI_DEVICE_ID_LAVA_QUAD_B
 0x0202

	)

1924 
	#PCI_DEVICE_ID_LAVA_SSERIAL
 0x0500

	)

1925 
	#PCI_DEVICE_ID_LAVA_PORT_650
 0x0600

	)

1926 
	#PCI_DEVICE_ID_LAVA_PARALLEL
 0x8000

	)

1927 
	#PCI_DEVICE_ID_LAVA_DUAL_PAR_A
 0x8002

	)

1928 
	#PCI_DEVICE_ID_LAVA_DUAL_PAR_B
 0x8003

	)

1929 
	#PCI_DEVICE_ID_LAVA_BOCA_IOPPAR
 0x8800

	)

1931 
	#PCI_VENDOR_ID_TIMEDIA
 0x1409

	)

1932 
	#PCI_DEVICE_ID_TIMEDIA_1889
 0x7168

	)

1934 
	#PCI_VENDOR_ID_ICE
 0x1412

	)

1935 
	#PCI_DEVICE_ID_ICE_1712
 0x1712

	)

1936 
	#PCI_DEVICE_ID_VT1724
 0x1724

	)

1938 
	#PCI_VENDOR_ID_OXSEMI
 0x1415

	)

1939 
	#PCI_DEVICE_ID_OXSEMI_12PCI840
 0x8403

	)

1940 
	#PCI_DEVICE_ID_OXSEMI_PCIe840
 0xC000

	)

1941 
	#PCI_DEVICE_ID_OXSEMI_PCIe840_G
 0xC004

	)

1942 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_0
 0xC100

	)

1943 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_0_G
 0xC104

	)

1944 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1
 0xC110

	)

1945 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1_G
 0xC114

	)

1946 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1_U
 0xC118

	)

1947 
	#PCI_DEVICE_ID_OXSEMI_PCIe952_1_GU
 0xC11C

	)

1948 
	#PCI_DEVICE_ID_OXSEMI_16PCI954
 0x9501

	)

1949 
	#PCI_DEVICE_ID_OXSEMI_16PCI95N
 0x9511

	)

1950 
	#PCI_DEVICE_ID_OXSEMI_16PCI954PP
 0x9513

	)

1951 
	#PCI_DEVICE_ID_OXSEMI_16PCI952
 0x9521

	)

1953 
	#PCI_VENDOR_ID_SAMSUNG
 0x144d

	)

1955 
	#PCI_VENDOR_ID_GIGABYTE
 0x1458

	)

1957 
	#PCI_VENDOR_ID_AMBIT
 0x1468

	)

1959 
	#PCI_VENDOR_ID_MYRICOM
 0x14c1

	)

1961 
	#PCI_VENDOR_ID_TITAN
 0x14D2

	)

1962 
	#PCI_DEVICE_ID_TITAN_010L
 0x8001

	)

1963 
	#PCI_DEVICE_ID_TITAN_100L
 0x8010

	)

1964 
	#PCI_DEVICE_ID_TITAN_110L
 0x8011

	)

1965 
	#PCI_DEVICE_ID_TITAN_200L
 0x8020

	)

1966 
	#PCI_DEVICE_ID_TITAN_210L
 0x8021

	)

1967 
	#PCI_DEVICE_ID_TITAN_400L
 0x8040

	)

1968 
	#PCI_DEVICE_ID_TITAN_800L
 0x8080

	)

1969 
	#PCI_DEVICE_ID_TITAN_100
 0xA001

	)

1970 
	#PCI_DEVICE_ID_TITAN_200
 0xA005

	)

1971 
	#PCI_DEVICE_ID_TITAN_400
 0xA003

	)

1972 
	#PCI_DEVICE_ID_TITAN_800B
 0xA004

	)

1974 
	#PCI_VENDOR_ID_PANACOM
 0x14d4

	)

1975 
	#PCI_DEVICE_ID_PANACOM_QUADMODEM
 0x0400

	)

1976 
	#PCI_DEVICE_ID_PANACOM_DUALMODEM
 0x0402

	)

1979 
	#PCI_VENDOR_ID_AFAVLAB
 0x14db

	)

1980 
	#PCI_DEVICE_ID_AFAVLAB_P028
 0x2180

	)

1981 
	#PCI_DEVICE_ID_AFAVLAB_P030
 0x2182

	)

1982 
	#PCI_SUBDEVICE_ID_AFAVLAB_P061
 0x2150

	)

1984 
	#PCI_VENDOR_ID_BROADCOM
 0x14e4

	)

1985 
	#PCI_DEVICE_ID_TIGON3_5752
 0x1600

	)

1986 
	#PCI_DEVICE_ID_TIGON3_5752M
 0x1601

	)

1987 
	#PCI_DEVICE_ID_NX2_5709
 0x1639

	)

1988 
	#PCI_DEVICE_ID_NX2_5709S
 0x163a

	)

1989 
	#PCI_DEVICE_ID_TIGON3_5700
 0x1644

	)

1990 
	#PCI_DEVICE_ID_TIGON3_5701
 0x1645

	)

1991 
	#PCI_DEVICE_ID_TIGON3_5702
 0x1646

	)

1992 
	#PCI_DEVICE_ID_TIGON3_5703
 0x1647

	)

1993 
	#PCI_DEVICE_ID_TIGON3_5704
 0x1648

	)

1994 
	#PCI_DEVICE_ID_TIGON3_5704S_2
 0x1649

	)

1995 
	#PCI_DEVICE_ID_NX2_5706
 0x164a

	)

1996 
	#PCI_DEVICE_ID_NX2_5708
 0x164c

	)

1997 
	#PCI_DEVICE_ID_TIGON3_5702FE
 0x164d

	)

1998 
	#PCI_DEVICE_ID_NX2_57710
 0x164e

	)

1999 
	#PCI_DEVICE_ID_NX2_57711
 0x164f

	)

2000 
	#PCI_DEVICE_ID_NX2_57711E
 0x1650

	)

2001 
	#PCI_DEVICE_ID_TIGON3_5705
 0x1653

	)

2002 
	#PCI_DEVICE_ID_TIGON3_5705_2
 0x1654

	)

2003 
	#PCI_DEVICE_ID_TIGON3_5719
 0x1657

	)

2004 
	#PCI_DEVICE_ID_TIGON3_5721
 0x1659

	)

2005 
	#PCI_DEVICE_ID_TIGON3_5722
 0x165a

	)

2006 
	#PCI_DEVICE_ID_TIGON3_5723
 0x165b

	)

2007 
	#PCI_DEVICE_ID_TIGON3_5705M
 0x165d

	)

2008 
	#PCI_DEVICE_ID_TIGON3_5705M_2
 0x165e

	)

2009 
	#PCI_DEVICE_ID_NX2_57712
 0x1662

	)

2010 
	#PCI_DEVICE_ID_NX2_57712E
 0x1663

	)

2011 
	#PCI_DEVICE_ID_TIGON3_5714
 0x1668

	)

2012 
	#PCI_DEVICE_ID_TIGON3_5714S
 0x1669

	)

2013 
	#PCI_DEVICE_ID_TIGON3_5780
 0x166a

	)

2014 
	#PCI_DEVICE_ID_TIGON3_5780S
 0x166b

	)

2015 
	#PCI_DEVICE_ID_TIGON3_5705F
 0x166e

	)

2016 
	#PCI_DEVICE_ID_TIGON3_5754M
 0x1672

	)

2017 
	#PCI_DEVICE_ID_TIGON3_5755M
 0x1673

	)

2018 
	#PCI_DEVICE_ID_TIGON3_5756
 0x1674

	)

2019 
	#PCI_DEVICE_ID_TIGON3_5751
 0x1677

	)

2020 
	#PCI_DEVICE_ID_TIGON3_5715
 0x1678

	)

2021 
	#PCI_DEVICE_ID_TIGON3_5715S
 0x1679

	)

2022 
	#PCI_DEVICE_ID_TIGON3_5754
 0x167a

	)

2023 
	#PCI_DEVICE_ID_TIGON3_5755
 0x167b

	)

2024 
	#PCI_DEVICE_ID_TIGON3_5751M
 0x167d

	)

2025 
	#PCI_DEVICE_ID_TIGON3_5751F
 0x167e

	)

2026 
	#PCI_DEVICE_ID_TIGON3_5787F
 0x167f

	)

2027 
	#PCI_DEVICE_ID_TIGON3_5761E
 0x1680

	)

2028 
	#PCI_DEVICE_ID_TIGON3_5761
 0x1681

	)

2029 
	#PCI_DEVICE_ID_TIGON3_5764
 0x1684

	)

2030 
	#PCI_DEVICE_ID_NX2_57800
 0x168a

	)

2031 
	#PCI_DEVICE_ID_NX2_57840
 0x168d

	)

2032 
	#PCI_DEVICE_ID_NX2_57810
 0x168e

	)

2033 
	#PCI_DEVICE_ID_TIGON3_5787M
 0x1693

	)

2034 
	#PCI_DEVICE_ID_TIGON3_5782
 0x1696

	)

2035 
	#PCI_DEVICE_ID_TIGON3_5784
 0x1698

	)

2036 
	#PCI_DEVICE_ID_TIGON3_5786
 0x169a

	)

2037 
	#PCI_DEVICE_ID_TIGON3_5787
 0x169b

	)

2038 
	#PCI_DEVICE_ID_TIGON3_5788
 0x169c

	)

2039 
	#PCI_DEVICE_ID_TIGON3_5789
 0x169d

	)

2040 
	#PCI_DEVICE_ID_NX2_57800_MF
 0x16a5

	)

2041 
	#PCI_DEVICE_ID_TIGON3_5702X
 0x16a6

	)

2042 
	#PCI_DEVICE_ID_TIGON3_5703X
 0x16a7

	)

2043 
	#PCI_DEVICE_ID_TIGON3_5704S
 0x16a8

	)

2044 
	#PCI_DEVICE_ID_NX2_57800_VF
 0x16a9

	)

2045 
	#PCI_DEVICE_ID_NX2_5706S
 0x16¯

	)

2046 
	#PCI_DEVICE_ID_NX2_57840_MF
 0x16a4

	)

2047 
	#PCI_DEVICE_ID_NX2_5708S
 0x16ac

	)

2048 
	#PCI_DEVICE_ID_NX2_57840_VF
 0x16ad

	)

2049 
	#PCI_DEVICE_ID_NX2_57810_MF
 0x16«

	)

2050 
	#PCI_DEVICE_ID_NX2_57810_VF
 0x16af

	)

2051 
	#PCI_DEVICE_ID_TIGON3_5702A3
 0x16c6

	)

2052 
	#PCI_DEVICE_ID_TIGON3_5703A3
 0x16c7

	)

2053 
	#PCI_DEVICE_ID_TIGON3_5781
 0x16dd

	)

2054 
	#PCI_DEVICE_ID_TIGON3_5753
 0x16f7

	)

2055 
	#PCI_DEVICE_ID_TIGON3_5753M
 0x16fd

	)

2056 
	#PCI_DEVICE_ID_TIGON3_5753F
 0x16ã

	)

2057 
	#PCI_DEVICE_ID_TIGON3_5901
 0x170d

	)

2058 
	#PCI_DEVICE_ID_BCM4401B1
 0x170c

	)

2059 
	#PCI_DEVICE_ID_TIGON3_5901_2
 0x170e

	)

2060 
	#PCI_DEVICE_ID_TIGON3_5906
 0x1712

	)

2061 
	#PCI_DEVICE_ID_TIGON3_5906M
 0x1713

	)

2062 
	#PCI_DEVICE_ID_BCM4401
 0x4401

	)

2063 
	#PCI_DEVICE_ID_BCM4401B0
 0x4402

	)

2065 
	#PCI_VENDOR_ID_TOPIC
 0x151f

	)

2066 
	#PCI_DEVICE_ID_TOPIC_TP560
 0x0000

	)

2068 
	#PCI_VENDOR_ID_ENE
 0x1524

	)

2069 
	#PCI_DEVICE_ID_ENE_1211
 0x1211

	)

2070 
	#PCI_DEVICE_ID_ENE_1225
 0x1225

	)

2071 
	#PCI_DEVICE_ID_ENE_1410
 0x1410

	)

2072 
	#PCI_DEVICE_ID_ENE_710
 0x1411

	)

2073 
	#PCI_DEVICE_ID_ENE_712
 0x1412

	)

2074 
	#PCI_DEVICE_ID_ENE_1420
 0x1420

	)

2075 
	#PCI_DEVICE_ID_ENE_720
 0x1421

	)

2076 
	#PCI_DEVICE_ID_ENE_722
 0x1422

	)

2078 
	#PCI_VENDOR_ID_CHELSIO
 0x1425

	)

2081 
	#PCI_VENDOR_ID_SYBA
 0x1592

	)

2082 
	#PCI_DEVICE_ID_SYBA_2P_EPP
 0x0782

	)

2083 
	#PCI_DEVICE_ID_SYBA_1P_ECP
 0x0783

	)

2085 
	#PCI_VENDOR_ID_MORETON
 0x15¯

	)

2086 
	#PCI_DEVICE_ID_RASTEL_2PORT
 0x2000

	)

2088 
	#PCI_VENDOR_ID_ZOLTRIX
 0x15b0

	)

2089 
	#PCI_DEVICE_ID_ZOLTRIX_2BD0
 0x2bd0

	)

2091 
	#PCI_VENDOR_ID_MELLANOX
 0x15b3

	)

2092 
	#PCI_DEVICE_ID_MELLANOX_TAVOR
 0x5a44

	)

2093 
	#PCI_DEVICE_ID_MELLANOX_TAVOR_BRIDGE
 0x5a46

	)

2094 
	#PCI_DEVICE_ID_MELLANOX_ARBEL_COMPAT
 0x6278

	)

2095 
	#PCI_DEVICE_ID_MELLANOX_ARBEL
 0x6282

	)

2096 
	#PCI_DEVICE_ID_MELLANOX_SINAI_OLD
 0x5e8c

	)

2097 
	#PCI_DEVICE_ID_MELLANOX_SINAI
 0x6274

	)

2099 
	#PCI_VENDOR_ID_DFI
 0x15bd

	)

2101 
	#PCI_VENDOR_ID_PDC
 0x15e9

	)

2104 
	#PCI_VENDOR_ID_FARSITE
 0x1619

	)

2105 
	#PCI_DEVICE_ID_FARSITE_T2P
 0x0400

	)

2106 
	#PCI_DEVICE_ID_FARSITE_T4P
 0x0440

	)

2107 
	#PCI_DEVICE_ID_FARSITE_T1U
 0x0610

	)

2108 
	#PCI_DEVICE_ID_FARSITE_T2U
 0x0620

	)

2109 
	#PCI_DEVICE_ID_FARSITE_T4U
 0x0640

	)

2110 
	#PCI_DEVICE_ID_FARSITE_TE1
 0x1610

	)

2111 
	#PCI_DEVICE_ID_FARSITE_TE1C
 0x1612

	)

2113 
	#PCI_VENDOR_ID_ARIMA
 0x161f

	)

2114 
	#PCI_VENDOR_ID_BROCADE
 0x1657

	)

2115 
	#PCI_DEVICE_ID_BROCADE_CT
 0x0014

	)

2116 
	#PCI_DEVICE_ID_BROCADE_FC_8G1P
 0x0017

	)

2117 
	#PCI_DEVICE_ID_BROCADE_CT_FC
 0x0021

	)

2119 
	#PCI_VENDOR_ID_SIBYTE
 0x166d

	)

2120 
	#PCI_DEVICE_ID_BCM1250_HT
 0x0002

	)

2122 
	#PCI_VENDOR_ID_ATHEROS
 0x168c

	)

2124 
	#PCI_VENDOR_ID_NETCELL
 0x169c

	)

2125 
	#PCI_DEVICE_ID_REVOLUTION
 0x0044

	)

2127 
	#PCI_VENDOR_ID_CENATEK
 0x16CA

	)

2128 
	#PCI_DEVICE_ID_CENATEK_IDE
 0x0001

	)

2130 
	#PCI_VENDOR_ID_VITESSE
 0x1725

	)

2131 
	#PCI_DEVICE_ID_VITESSE_VSC7174
 0x7174

	)

2133 
	#PCI_VENDOR_ID_LINKSYS
 0x1737

	)

2134 
	#PCI_DEVICE_ID_LINKSYS_EG1064
 0x1064

	)

2136 
	#PCI_VENDOR_ID_ALTIMA
 0x173b

	)

2137 
	#PCI_DEVICE_ID_ALTIMA_AC1000
 0x03e8

	)

2138 
	#PCI_DEVICE_ID_ALTIMA_AC1001
 0x03e9

	)

2139 
	#PCI_DEVICE_ID_ALTIMA_AC9100
 0x03—

	)

2140 
	#PCI_DEVICE_ID_ALTIMA_AC1003
 0x03eb

	)

2142 
	#PCI_VENDOR_ID_BELKIN
 0x1799

	)

2144 
	#PCI_VENDOR_ID_ARECA
 0x17d3

	)

2145 
	#PCI_DEVICE_ID_ARECA_1110
 0x1110

	)

2146 
	#PCI_DEVICE_ID_ARECA_1120
 0x1120

	)

2147 
	#PCI_DEVICE_ID_ARECA_1130
 0x1130

	)

2148 
	#PCI_DEVICE_ID_ARECA_1160
 0x1160

	)

2149 
	#PCI_DEVICE_ID_ARECA_1170
 0x1170

	)

2150 
	#PCI_DEVICE_ID_ARECA_1200
 0x1200

	)

2151 
	#PCI_DEVICE_ID_ARECA_1201
 0x1201

	)

2152 
	#PCI_DEVICE_ID_ARECA_1202
 0x1202

	)

2153 
	#PCI_DEVICE_ID_ARECA_1210
 0x1210

	)

2154 
	#PCI_DEVICE_ID_ARECA_1220
 0x1220

	)

2155 
	#PCI_DEVICE_ID_ARECA_1230
 0x1230

	)

2156 
	#PCI_DEVICE_ID_ARECA_1260
 0x1260

	)

2157 
	#PCI_DEVICE_ID_ARECA_1270
 0x1270

	)

2158 
	#PCI_DEVICE_ID_ARECA_1280
 0x1280

	)

2159 
	#PCI_DEVICE_ID_ARECA_1380
 0x1380

	)

2160 
	#PCI_DEVICE_ID_ARECA_1381
 0x1381

	)

2161 
	#PCI_DEVICE_ID_ARECA_1680
 0x1680

	)

2162 
	#PCI_DEVICE_ID_ARECA_1681
 0x1681

	)

2164 
	#PCI_VENDOR_ID_S2IO
 0x17d5

	)

2165 
	#PCI_DEVICE_ID_S2IO_WIN
 0x5731

	)

2166 
	#PCI_DEVICE_ID_S2IO_UNI
 0x5831

	)

2167 
	#PCI_DEVICE_ID_HERC_WIN
 0x5732

	)

2168 
	#PCI_DEVICE_ID_HERC_UNI
 0x5832

	)

2171 
	#PCI_VENDOR_ID_SITECOM
 0x182d

	)

2172 
	#PCI_DEVICE_ID_SITECOM_DC105V2
 0x3069

	)

2174 
	#PCI_VENDOR_ID_TOPSPIN
 0x1867

	)

2176 
	#PCI_VENDOR_ID_SOLARFLARE
 0x1924

	)

2177 
	#PCI_DEVICE_ID_SOLARFLARE_SFC4000A_0
 0x0703

	)

2178 
	#PCI_DEVICE_ID_SOLARFLARE_SFC4000A_1
 0x6703

	)

2179 
	#PCI_DEVICE_ID_SOLARFLARE_SFC4000B
 0x0710

	)

2181 
	#PCI_VENDOR_ID_TDI
 0x192E

	)

2182 
	#PCI_DEVICE_ID_TDI_EHCI
 0x0101

	)

2184 
	#PCI_VENDOR_ID_JMICRON
 0x197B

	)

2185 
	#PCI_DEVICE_ID_JMICRON_JMB360
 0x2360

	)

2186 
	#PCI_DEVICE_ID_JMICRON_JMB361
 0x2361

	)

2187 
	#PCI_DEVICE_ID_JMICRON_JMB362
 0x2362

	)

2188 
	#PCI_DEVICE_ID_JMICRON_JMB363
 0x2363

	)

2189 
	#PCI_DEVICE_ID_JMICRON_JMB365
 0x2365

	)

2190 
	#PCI_DEVICE_ID_JMICRON_JMB366
 0x2366

	)

2191 
	#PCI_DEVICE_ID_JMICRON_JMB368
 0x2368

	)

2193 
	#PCI_VENDOR_ID_QMI
 0x1a32

	)

2195 
	#PCI_VENDOR_ID_AZWAVE
 0x1a3b

	)

2197 
	#PCI_VENDOR_ID_TEKRAM
 0x1de1

	)

2198 
	#PCI_DEVICE_ID_TEKRAM_DC290
 0xdc29

	)

2200 
	#PCI_VENDOR_ID_HINT
 0x3388

	)

2201 
	#PCI_DEVICE_ID_HINT_VXPROII_IDE
 0x8013

	)

2203 
	#PCI_VENDOR_ID_3DLABS
 0x3d3d

	)

2204 
	#PCI_DEVICE_ID_3DLABS_PERMEDIA2
 0x0007

	)

2205 
	#PCI_DEVICE_ID_3DLABS_PERMEDIA2V
 0x0009

	)

2208 
	#PCI_VENDOR_ID_AKS
 0x416c

	)

2209 
	#PCI_DEVICE_ID_AKS_ALADDINCARD
 0x0100

	)

2213 
	#PCI_VENDOR_ID_S3
 0x5333

	)

2214 
	#PCI_DEVICE_ID_S3_TRIO
 0x8811

	)

2215 
	#PCI_DEVICE_ID_S3_868
 0x8880

	)

2216 
	#PCI_DEVICE_ID_S3_968
 0x88f0

	)

2217 
	#PCI_DEVICE_ID_S3_SAVAGE4
 0x8a25

	)

2218 
	#PCI_DEVICE_ID_S3_PROSAVAGE8
 0x8d04

	)

2219 
	#PCI_DEVICE_ID_S3_SONICVIBES
 0xÿ00

	)

2221 
	#PCI_VENDOR_ID_DUNORD
 0x5544

	)

2222 
	#PCI_DEVICE_ID_DUNORD_I3000
 0x0001

	)

2225 
	#PCI_VENDOR_ID_DCI
 0x6666

	)

2226 
	#PCI_DEVICE_ID_DCI_PCCOM4
 0x0001

	)

2227 
	#PCI_DEVICE_ID_DCI_PCCOM8
 0x0002

	)

2228 
	#PCI_DEVICE_ID_DCI_PCCOM2
 0x0004

	)

2230 
	#PCI_VENDOR_ID_INTEL
 0x8086

	)

2231 
	#PCI_DEVICE_ID_INTEL_EESSC
 0x0008

	)

2232 
	#PCI_DEVICE_ID_INTEL_PXHD_0
 0x0320

	)

2233 
	#PCI_DEVICE_ID_INTEL_PXHD_1
 0x0321

	)

2234 
	#PCI_DEVICE_ID_INTEL_PXH_0
 0x0329

	)

2235 
	#PCI_DEVICE_ID_INTEL_PXH_1
 0x032A

	)

2236 
	#PCI_DEVICE_ID_INTEL_PXHV
 0x032C

	)

2237 
	#PCI_DEVICE_ID_INTEL_82375
 0x0482

	)

2238 
	#PCI_DEVICE_ID_INTEL_82424
 0x0483

	)

2239 
	#PCI_DEVICE_ID_INTEL_82378
 0x0484

	)

2240 
	#PCI_DEVICE_ID_INTEL_I960
 0x0960

	)

2241 
	#PCI_DEVICE_ID_INTEL_I960RM
 0x0962

	)

2242 
	#PCI_DEVICE_ID_INTEL_8257X_SOL
 0x1062

	)

2243 
	#PCI_DEVICE_ID_INTEL_82573E_SOL
 0x1085

	)

2244 
	#PCI_DEVICE_ID_INTEL_82573L_SOL
 0x108F

	)

2245 
	#PCI_DEVICE_ID_INTEL_82815_MC
 0x1130

	)

2246 
	#PCI_DEVICE_ID_INTEL_82815_CGC
 0x1132

	)

2247 
	#PCI_DEVICE_ID_INTEL_82092AA_0
 0x1221

	)

2248 
	#PCI_DEVICE_ID_INTEL_7505_0
 0x2550

	)

2249 
	#PCI_DEVICE_ID_INTEL_7205_0
 0x255d

	)

2250 
	#PCI_DEVICE_ID_INTEL_82437
 0x122d

	)

2251 
	#PCI_DEVICE_ID_INTEL_82371FB_0
 0x122e

	)

2252 
	#PCI_DEVICE_ID_INTEL_82371FB_1
 0x1230

	)

2253 
	#PCI_DEVICE_ID_INTEL_82371MX
 0x1234

	)

2254 
	#PCI_DEVICE_ID_INTEL_82441
 0x1237

	)

2255 
	#PCI_DEVICE_ID_INTEL_82380FB
 0x124b

	)

2256 
	#PCI_DEVICE_ID_INTEL_82439
 0x1250

	)

2257 
	#PCI_DEVICE_ID_INTEL_80960_RP
 0x1960

	)

2258 
	#PCI_DEVICE_ID_INTEL_82840_HB
 0x1a21

	)

2259 
	#PCI_DEVICE_ID_INTEL_82845_HB
 0x1a30

	)

2260 
	#PCI_DEVICE_ID_INTEL_IOAT
 0x1a38

	)

2261 
	#PCI_DEVICE_ID_INTEL_CPT_SMBUS
 0x1c22

	)

2262 
	#PCI_DEVICE_ID_INTEL_CPT_LPC_MIN
 0x1c41

	)

2263 
	#PCI_DEVICE_ID_INTEL_CPT_LPC_MAX
 0x1c5f

	)

2264 
	#PCI_DEVICE_ID_INTEL_PANTHERPOINT_SMBUS
 0x1e22

	)

2265 
	#PCI_DEVICE_ID_INTEL_PANTHERPOINT_LPC_MIN
 0x1e40

	)

2266 
	#PCI_DEVICE_ID_INTEL_PANTHERPOINT_LPC_MAX
 0x1e5f

	)

2267 
	#PCI_DEVICE_ID_INTEL_PATSBURG_SMBUS
 0x1d22

	)

2268 
	#PCI_DEVICE_ID_INTEL_PATSBURG_LPC_0
 0x1d40

	)

2269 
	#PCI_DEVICE_ID_INTEL_PATSBURG_LPC_1
 0x1d41

	)

2270 
	#PCI_DEVICE_ID_INTEL_82801AA_0
 0x2410

	)

2271 
	#PCI_DEVICE_ID_INTEL_82801AA_1
 0x2411

	)

2272 
	#PCI_DEVICE_ID_INTEL_82801AA_3
 0x2413

	)

2273 
	#PCI_DEVICE_ID_INTEL_82801AA_5
 0x2415

	)

2274 
	#PCI_DEVICE_ID_INTEL_82801AA_6
 0x2416

	)

2275 
	#PCI_DEVICE_ID_INTEL_82801AA_8
 0x2418

	)

2276 
	#PCI_DEVICE_ID_INTEL_82801AB_0
 0x2420

	)

2277 
	#PCI_DEVICE_ID_INTEL_82801AB_1
 0x2421

	)

2278 
	#PCI_DEVICE_ID_INTEL_82801AB_3
 0x2423

	)

2279 
	#PCI_DEVICE_ID_INTEL_82801AB_5
 0x2425

	)

2280 
	#PCI_DEVICE_ID_INTEL_82801AB_6
 0x2426

	)

2281 
	#PCI_DEVICE_ID_INTEL_82801AB_8
 0x2428

	)

2282 
	#PCI_DEVICE_ID_INTEL_82801BA_0
 0x2440

	)

2283 
	#PCI_DEVICE_ID_INTEL_82801BA_2
 0x2443

	)

2284 
	#PCI_DEVICE_ID_INTEL_82801BA_4
 0x2445

	)

2285 
	#PCI_DEVICE_ID_INTEL_82801BA_6
 0x2448

	)

2286 
	#PCI_DEVICE_ID_INTEL_82801BA_8
 0x244a

	)

2287 
	#PCI_DEVICE_ID_INTEL_82801BA_9
 0x244b

	)

2288 
	#PCI_DEVICE_ID_INTEL_82801BA_10
 0x244c

	)

2289 
	#PCI_DEVICE_ID_INTEL_82801BA_11
 0x244e

	)

2290 
	#PCI_DEVICE_ID_INTEL_82801E_0
 0x2450

	)

2291 
	#PCI_DEVICE_ID_INTEL_82801E_11
 0x245b

	)

2292 
	#PCI_DEVICE_ID_INTEL_82801CA_0
 0x2480

	)

2293 
	#PCI_DEVICE_ID_INTEL_82801CA_3
 0x2483

	)

2294 
	#PCI_DEVICE_ID_INTEL_82801CA_5
 0x2485

	)

2295 
	#PCI_DEVICE_ID_INTEL_82801CA_6
 0x2486

	)

2296 
	#PCI_DEVICE_ID_INTEL_82801CA_10
 0x248a

	)

2297 
	#PCI_DEVICE_ID_INTEL_82801CA_11
 0x248b

	)

2298 
	#PCI_DEVICE_ID_INTEL_82801CA_12
 0x248c

	)

2299 
	#PCI_DEVICE_ID_INTEL_82801DB_0
 0x24c0

	)

2300 
	#PCI_DEVICE_ID_INTEL_82801DB_1
 0x24c1

	)

2301 
	#PCI_DEVICE_ID_INTEL_82801DB_3
 0x24c3

	)

2302 
	#PCI_DEVICE_ID_INTEL_82801DB_5
 0x24c5

	)

2303 
	#PCI_DEVICE_ID_INTEL_82801DB_6
 0x24c6

	)

2304 
	#PCI_DEVICE_ID_INTEL_82801DB_9
 0x24c9

	)

2305 
	#PCI_DEVICE_ID_INTEL_82801DB_10
 0x24ÿ

	)

2306 
	#PCI_DEVICE_ID_INTEL_82801DB_11
 0x24cb

	)

2307 
	#PCI_DEVICE_ID_INTEL_82801DB_12
 0x24cc

	)

2308 
	#PCI_DEVICE_ID_INTEL_82801EB_0
 0x24d0

	)

2309 
	#PCI_DEVICE_ID_INTEL_82801EB_1
 0x24d1

	)

2310 
	#PCI_DEVICE_ID_INTEL_82801EB_3
 0x24d3

	)

2311 
	#PCI_DEVICE_ID_INTEL_82801EB_5
 0x24d5

	)

2312 
	#PCI_DEVICE_ID_INTEL_82801EB_6
 0x24d6

	)

2313 
	#PCI_DEVICE_ID_INTEL_82801EB_11
 0x24db

	)

2314 
	#PCI_DEVICE_ID_INTEL_82801EB_13
 0x24dd

	)

2315 
	#PCI_DEVICE_ID_INTEL_ESB_1
 0x25a1

	)

2316 
	#PCI_DEVICE_ID_INTEL_ESB_2
 0x25a2

	)

2317 
	#PCI_DEVICE_ID_INTEL_ESB_4
 0x25a4

	)

2318 
	#PCI_DEVICE_ID_INTEL_ESB_5
 0x25a6

	)

2319 
	#PCI_DEVICE_ID_INTEL_ESB_9
 0x25ab

	)

2320 
	#PCI_DEVICE_ID_INTEL_82820_HB
 0x2500

	)

2321 
	#PCI_DEVICE_ID_INTEL_82820_UP_HB
 0x2501

	)

2322 
	#PCI_DEVICE_ID_INTEL_82850_HB
 0x2530

	)

2323 
	#PCI_DEVICE_ID_INTEL_82860_HB
 0x2531

	)

2324 
	#PCI_DEVICE_ID_INTEL_E7501_MCH
 0x254c

	)

2325 
	#PCI_DEVICE_ID_INTEL_82845G_HB
 0x2560

	)

2326 
	#PCI_DEVICE_ID_INTEL_82845G_IG
 0x2562

	)

2327 
	#PCI_DEVICE_ID_INTEL_82865_HB
 0x2570

	)

2328 
	#PCI_DEVICE_ID_INTEL_82865_IG
 0x2572

	)

2329 
	#PCI_DEVICE_ID_INTEL_82875_HB
 0x2578

	)

2330 
	#PCI_DEVICE_ID_INTEL_82915G_HB
 0x2580

	)

2331 
	#PCI_DEVICE_ID_INTEL_82915G_IG
 0x2582

	)

2332 
	#PCI_DEVICE_ID_INTEL_82915GM_HB
 0x2590

	)

2333 
	#PCI_DEVICE_ID_INTEL_82915GM_IG
 0x2592

	)

2334 
	#PCI_DEVICE_ID_INTEL_5000_ERR
 0x25F0

	)

2335 
	#PCI_DEVICE_ID_INTEL_5000_FBD0
 0x25F5

	)

2336 
	#PCI_DEVICE_ID_INTEL_5000_FBD1
 0x25F6

	)

2337 
	#PCI_DEVICE_ID_INTEL_82945G_HB
 0x2770

	)

2338 
	#PCI_DEVICE_ID_INTEL_82945G_IG
 0x2772

	)

2339 
	#PCI_DEVICE_ID_INTEL_3000_HB
 0x2778

	)

2340 
	#PCI_DEVICE_ID_INTEL_82945GM_HB
 0x27A0

	)

2341 
	#PCI_DEVICE_ID_INTEL_82945GM_IG
 0x27A2

	)

2342 
	#PCI_DEVICE_ID_INTEL_82945GME_IG
 0x27AE

	)

2343 
	#PCI_DEVICE_ID_INTEL_ICH6_0
 0x2640

	)

2344 
	#PCI_DEVICE_ID_INTEL_ICH6_1
 0x2641

	)

2345 
	#PCI_DEVICE_ID_INTEL_ICH6_2
 0x2642

	)

2346 
	#PCI_DEVICE_ID_INTEL_ICH6_16
 0x266a

	)

2347 
	#PCI_DEVICE_ID_INTEL_ICH6_17
 0x266d

	)

2348 
	#PCI_DEVICE_ID_INTEL_ICH6_18
 0x266e

	)

2349 
	#PCI_DEVICE_ID_INTEL_ICH6_19
 0x266f

	)

2350 
	#PCI_DEVICE_ID_INTEL_ESB2_0
 0x2670

	)

2351 
	#PCI_DEVICE_ID_INTEL_ESB2_14
 0x2698

	)

2352 
	#PCI_DEVICE_ID_INTEL_ESB2_17
 0x269b

	)

2353 
	#PCI_DEVICE_ID_INTEL_ESB2_18
 0x269e

	)

2354 
	#PCI_DEVICE_ID_INTEL_ICH7_0
 0x27b8

	)

2355 
	#PCI_DEVICE_ID_INTEL_ICH7_1
 0x27b9

	)

2356 
	#PCI_DEVICE_ID_INTEL_ICH7_30
 0x27b0

	)

2357 
	#PCI_DEVICE_ID_INTEL_ICH7_31
 0x27bd

	)

2358 
	#PCI_DEVICE_ID_INTEL_ICH7_17
 0x27da

	)

2359 
	#PCI_DEVICE_ID_INTEL_ICH7_19
 0x27dd

	)

2360 
	#PCI_DEVICE_ID_INTEL_ICH7_20
 0x27de

	)

2361 
	#PCI_DEVICE_ID_INTEL_ICH7_21
 0x27df

	)

2362 
	#PCI_DEVICE_ID_INTEL_ICH8_0
 0x2810

	)

2363 
	#PCI_DEVICE_ID_INTEL_ICH8_1
 0x2811

	)

2364 
	#PCI_DEVICE_ID_INTEL_ICH8_2
 0x2812

	)

2365 
	#PCI_DEVICE_ID_INTEL_ICH8_3
 0x2814

	)

2366 
	#PCI_DEVICE_ID_INTEL_ICH8_4
 0x2815

	)

2367 
	#PCI_DEVICE_ID_INTEL_ICH8_5
 0x283e

	)

2368 
	#PCI_DEVICE_ID_INTEL_ICH8_6
 0x2850

	)

2369 
	#PCI_DEVICE_ID_INTEL_ICH9_0
 0x2910

	)

2370 
	#PCI_DEVICE_ID_INTEL_ICH9_1
 0x2911

	)

2371 
	#PCI_DEVICE_ID_INTEL_ICH9_2
 0x2912

	)

2372 
	#PCI_DEVICE_ID_INTEL_ICH9_3
 0x2913

	)

2373 
	#PCI_DEVICE_ID_INTEL_ICH9_4
 0x2914

	)

2374 
	#PCI_DEVICE_ID_INTEL_ICH9_5
 0x2915

	)

2375 
	#PCI_DEVICE_ID_INTEL_ICH9_6
 0x2930

	)

2376 
	#PCI_DEVICE_ID_INTEL_I7_MCR
 0x2c18

	)

2377 
	#PCI_DEVICE_ID_INTEL_I7_MC_TAD
 0x2c19

	)

2378 
	#PCI_DEVICE_ID_INTEL_I7_MC_RAS
 0x2c1a

	)

2379 
	#PCI_DEVICE_ID_INTEL_I7_MC_TEST
 0x2c1c

	)

2380 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH0_CTRL
 0x2c20

	)

2381 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH0_ADDR
 0x2c21

	)

2382 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH0_RANK
 0x2c22

	)

2383 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH0_TC
 0x2c23

	)

2384 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH1_CTRL
 0x2c28

	)

2385 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH1_ADDR
 0x2c29

	)

2386 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH1_RANK
 0x2c2a

	)

2387 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH1_TC
 0x2c2b

	)

2388 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH2_CTRL
 0x2c30

	)

2389 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH2_ADDR
 0x2c31

	)

2390 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH2_RANK
 0x2c32

	)

2391 
	#PCI_DEVICE_ID_INTEL_I7_MC_CH2_TC
 0x2c33

	)

2392 
	#PCI_DEVICE_ID_INTEL_I7_NONCORE
 0x2c41

	)

2393 
	#PCI_DEVICE_ID_INTEL_I7_NONCORE_ALT
 0x2c40

	)

2394 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE
 0x2c50

	)

2395 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE_ALT
 0x2c51

	)

2396 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_NONCORE_REV2
 0x2c70

	)

2397 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_SAD
 0x2c81

	)

2398 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_QPI_LINK0
 0x2c90

	)

2399 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_QPI_PHY0
 0x2c91

	)

2400 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MCR
 0x2c98

	)

2401 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TAD
 0x2c99

	)

2402 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TEST
 0x2c9C

	)

2403 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_CTRL
 0x2ÿ0

	)

2404 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_ADDR
 0x2ÿ1

	)

2405 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_RANK
 0x2ÿ2

	)

2406 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_TC
 0x2ÿ3

	)

2407 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_CTRL
 0x2ÿ8

	)

2408 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_ADDR
 0x2ÿ9

	)

2409 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_RANK
 0x2ÿa

	)

2410 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_TC
 0x2ÿb

	)

2411 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MCR_REV2
 0x2d98

	)

2412 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TAD_REV2
 0x2d99

	)

2413 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_RAS_REV2
 0x2d9a

	)

2414 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_TEST_REV2
 0x2d9c

	)

2415 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_CTRL_REV2
 0x2da0

	)

2416 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_ADDR_REV2
 0x2da1

	)

2417 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_RANK_REV2
 0x2da2

	)

2418 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH0_TC_REV2
 0x2da3

	)

2419 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_CTRL_REV2
 0x2da8

	)

2420 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_ADDR_REV2
 0x2da9

	)

2421 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_RANK_REV2
 0x2d¯

	)

2422 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH1_TC_REV2
 0x2dab

	)

2423 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_CTRL_REV2
 0x2db0

	)

2424 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_ADDR_REV2
 0x2db1

	)

2425 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_RANK_REV2
 0x2db2

	)

2426 
	#PCI_DEVICE_ID_INTEL_LYNNFIELD_MC_CH2_TC_REV2
 0x2db3

	)

2427 
	#PCI_DEVICE_ID_INTEL_82855PM_HB
 0x3340

	)

2428 
	#PCI_DEVICE_ID_INTEL_IOAT_SNB
 0x402f

	)

2429 
	#PCI_DEVICE_ID_INTEL_IOAT_CNB
 0x360b

	)

2430 
	#PCI_DEVICE_ID_INTEL_IOAT_SCNB
 0x65ff

	)

2431 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG4
 0x3429

	)

2432 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG5
 0x342a

	)

2433 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG6
 0x342b

	)

2434 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG7
 0x342c

	)

2435 
	#PCI_DEVICE_ID_INTEL_X58_HUB_MGMT
 0x342e

	)

2436 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG0
 0x3430

	)

2437 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG1
 0x3431

	)

2438 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG2
 0x3432

	)

2439 
	#PCI_DEVICE_ID_INTEL_IOAT_TBG3
 0x3433

	)

2440 
	#PCI_DEVICE_ID_INTEL_82830_HB
 0x3575

	)

2441 
	#PCI_DEVICE_ID_INTEL_82830_CGC
 0x3577

	)

2442 
	#PCI_DEVICE_ID_INTEL_82855GM_HB
 0x3580

	)

2443 
	#PCI_DEVICE_ID_INTEL_82855GM_IG
 0x3582

	)

2444 
	#PCI_DEVICE_ID_INTEL_E7520_MCH
 0x3590

	)

2445 
	#PCI_DEVICE_ID_INTEL_E7320_MCH
 0x3592

	)

2446 
	#PCI_DEVICE_ID_INTEL_MCH_PA
 0x3595

	)

2447 
	#PCI_DEVICE_ID_INTEL_MCH_PA1
 0x3596

	)

2448 
	#PCI_DEVICE_ID_INTEL_MCH_PB
 0x3597

	)

2449 
	#PCI_DEVICE_ID_INTEL_MCH_PB1
 0x3598

	)

2450 
	#PCI_DEVICE_ID_INTEL_MCH_PC
 0x3599

	)

2451 
	#PCI_DEVICE_ID_INTEL_MCH_PC1
 0x359a

	)

2452 
	#PCI_DEVICE_ID_INTEL_E7525_MCH
 0x359e

	)

2453 
	#PCI_DEVICE_ID_INTEL_I7300_MCH_ERR
 0x360c

	)

2454 
	#PCI_DEVICE_ID_INTEL_I7300_MCH_FB0
 0x360f

	)

2455 
	#PCI_DEVICE_ID_INTEL_I7300_MCH_FB1
 0x3610

	)

2456 
	#PCI_DEVICE_ID_INTEL_IOAT_CNB
 0x360b

	)

2457 
	#PCI_DEVICE_ID_INTEL_FBD_CNB
 0x360c

	)

2458 
	#PCI_DEVICE_ID_INTEL_IOAT_JSF0
 0x3710

	)

2459 
	#PCI_DEVICE_ID_INTEL_ICH10_0
 0x3a14

	)

2460 
	#PCI_DEVICE_ID_INTEL_ICH10_1
 0x3a16

	)

2461 
	#PCI_DEVICE_ID_INTEL_ICH10_2
 0x3a18

	)

2462 
	#PCI_DEVICE_ID_INTEL_ICH10_3
 0x3a1a

	)

2463 
	#PCI_DEVICE_ID_INTEL_ICH10_4
 0x3a30

	)

2464 
	#PCI_DEVICE_ID_INTEL_ICH10_5
 0x3a60

	)

2465 
	#PCI_DEVICE_ID_INTEL_PCH_LPC_MIN
 0x3b00

	)

2466 
	#PCI_DEVICE_ID_INTEL_PCH_LPC_MAX
 0x3b1f

	)

2467 
	#PCI_DEVICE_ID_INTEL_PCH_SMBUS
 0x3b30

	)

2468 
	#PCI_DEVICE_ID_INTEL_5400_ERR
 0x4030

	)

2469 
	#PCI_DEVICE_ID_INTEL_5400_FBD0
 0x4035

	)

2470 
	#PCI_DEVICE_ID_INTEL_5400_FBD1
 0x4036

	)

2471 
	#PCI_DEVICE_ID_INTEL_TOLAPAI_0
 0x5031

	)

2472 
	#PCI_DEVICE_ID_INTEL_TOLAPAI_1
 0x5032

	)

2473 
	#PCI_DEVICE_ID_INTEL_82371SB_0
 0x7000

	)

2474 
	#PCI_DEVICE_ID_INTEL_82371SB_1
 0x7010

	)

2475 
	#PCI_DEVICE_ID_INTEL_82371SB_2
 0x7020

	)

2476 
	#PCI_DEVICE_ID_INTEL_82437VX
 0x7030

	)

2477 
	#PCI_DEVICE_ID_INTEL_82439TX
 0x7100

	)

2478 
	#PCI_DEVICE_ID_INTEL_82371AB_0
 0x7110

	)

2479 
	#PCI_DEVICE_ID_INTEL_82371AB
 0x7111

	)

2480 
	#PCI_DEVICE_ID_INTEL_82371AB_2
 0x7112

	)

2481 
	#PCI_DEVICE_ID_INTEL_82371AB_3
 0x7113

	)

2482 
	#PCI_DEVICE_ID_INTEL_82810_MC1
 0x7120

	)

2483 
	#PCI_DEVICE_ID_INTEL_82810_IG1
 0x7121

	)

2484 
	#PCI_DEVICE_ID_INTEL_82810_MC3
 0x7122

	)

2485 
	#PCI_DEVICE_ID_INTEL_82810_IG3
 0x7123

	)

2486 
	#PCI_DEVICE_ID_INTEL_82810E_MC
 0x7124

	)

2487 
	#PCI_DEVICE_ID_INTEL_82810E_IG
 0x7125

	)

2488 
	#PCI_DEVICE_ID_INTEL_82443LX_0
 0x7180

	)

2489 
	#PCI_DEVICE_ID_INTEL_82443LX_1
 0x7181

	)

2490 
	#PCI_DEVICE_ID_INTEL_82443BX_0
 0x7190

	)

2491 
	#PCI_DEVICE_ID_INTEL_82443BX_1
 0x7191

	)

2492 
	#PCI_DEVICE_ID_INTEL_82443BX_2
 0x7192

	)

2493 
	#PCI_DEVICE_ID_INTEL_440MX
 0x7195

	)

2494 
	#PCI_DEVICE_ID_INTEL_440MX_6
 0x7196

	)

2495 
	#PCI_DEVICE_ID_INTEL_82443MX_0
 0x7198

	)

2496 
	#PCI_DEVICE_ID_INTEL_82443MX_1
 0x7199

	)

2497 
	#PCI_DEVICE_ID_INTEL_82443MX_3
 0x719b

	)

2498 
	#PCI_DEVICE_ID_INTEL_82443GX_0
 0x71a0

	)

2499 
	#PCI_DEVICE_ID_INTEL_82443GX_2
 0x71a2

	)

2500 
	#PCI_DEVICE_ID_INTEL_82372FB_1
 0x7601

	)

2501 
	#PCI_DEVICE_ID_INTEL_SCH_IDE
 0x811a

	)

2502 
	#PCI_DEVICE_ID_INTEL_82454GX
 0x84c4

	)

2503 
	#PCI_DEVICE_ID_INTEL_82450GX
 0x84c5

	)

2504 
	#PCI_DEVICE_ID_INTEL_82451NX
 0x84ÿ

	)

2505 
	#PCI_DEVICE_ID_INTEL_82454NX
 0x84cb

	)

2506 
	#PCI_DEVICE_ID_INTEL_84460GX
 0x84—

	)

2507 
	#PCI_DEVICE_ID_INTEL_IXP4XX
 0x8500

	)

2508 
	#PCI_DEVICE_ID_INTEL_IXP2800
 0x9004

	)

2509 
	#PCI_DEVICE_ID_INTEL_S21152BB
 0xb152

	)

2511 
	#PCI_VENDOR_ID_SCALEMP
 0x8686

	)

2512 
	#PCI_DEVICE_ID_SCALEMP_VSMP_CTL
 0x1010

	)

2514 
	#PCI_VENDOR_ID_COMPUTONE
 0x8e0e

	)

2515 
	#PCI_DEVICE_ID_COMPUTONE_IP2EX
 0x0291

	)

2516 
	#PCI_DEVICE_ID_COMPUTONE_PG
 0x0302

	)

2517 
	#PCI_SUBVENDOR_ID_COMPUTONE
 0x8e0e

	)

2518 
	#PCI_SUBDEVICE_ID_COMPUTONE_PG4
 0x0001

	)

2519 
	#PCI_SUBDEVICE_ID_COMPUTONE_PG8
 0x0002

	)

2520 
	#PCI_SUBDEVICE_ID_COMPUTONE_PG6
 0x0003

	)

2522 
	#PCI_VENDOR_ID_KTI
 0x8e2e

	)

2524 
	#PCI_VENDOR_ID_ADAPTEC
 0x9004

	)

2525 
	#PCI_DEVICE_ID_ADAPTEC_7810
 0x1078

	)

2526 
	#PCI_DEVICE_ID_ADAPTEC_7821
 0x2178

	)

2527 
	#PCI_DEVICE_ID_ADAPTEC_38602
 0x3860

	)

2528 
	#PCI_DEVICE_ID_ADAPTEC_7850
 0x5078

	)

2529 
	#PCI_DEVICE_ID_ADAPTEC_7855
 0x5578

	)

2530 
	#PCI_DEVICE_ID_ADAPTEC_3860
 0x6038

	)

2531 
	#PCI_DEVICE_ID_ADAPTEC_1480A
 0x6075

	)

2532 
	#PCI_DEVICE_ID_ADAPTEC_7860
 0x6078

	)

2533 
	#PCI_DEVICE_ID_ADAPTEC_7861
 0x6178

	)

2534 
	#PCI_DEVICE_ID_ADAPTEC_7870
 0x7078

	)

2535 
	#PCI_DEVICE_ID_ADAPTEC_7871
 0x7178

	)

2536 
	#PCI_DEVICE_ID_ADAPTEC_7872
 0x7278

	)

2537 
	#PCI_DEVICE_ID_ADAPTEC_7873
 0x7378

	)

2538 
	#PCI_DEVICE_ID_ADAPTEC_7874
 0x7478

	)

2539 
	#PCI_DEVICE_ID_ADAPTEC_7895
 0x7895

	)

2540 
	#PCI_DEVICE_ID_ADAPTEC_7880
 0x8078

	)

2541 
	#PCI_DEVICE_ID_ADAPTEC_7881
 0x8178

	)

2542 
	#PCI_DEVICE_ID_ADAPTEC_7882
 0x8278

	)

2543 
	#PCI_DEVICE_ID_ADAPTEC_7883
 0x8378

	)

2544 
	#PCI_DEVICE_ID_ADAPTEC_7884
 0x8478

	)

2545 
	#PCI_DEVICE_ID_ADAPTEC_7885
 0x8578

	)

2546 
	#PCI_DEVICE_ID_ADAPTEC_7886
 0x8678

	)

2547 
	#PCI_DEVICE_ID_ADAPTEC_7887
 0x8778

	)

2548 
	#PCI_DEVICE_ID_ADAPTEC_7888
 0x8878

	)

2550 
	#PCI_VENDOR_ID_ADAPTEC2
 0x9005

	)

2551 
	#PCI_DEVICE_ID_ADAPTEC2_2940U2
 0x0010

	)

2552 
	#PCI_DEVICE_ID_ADAPTEC2_2930U2
 0x0011

	)

2553 
	#PCI_DEVICE_ID_ADAPTEC2_7890B
 0x0013

	)

2554 
	#PCI_DEVICE_ID_ADAPTEC2_7890
 0x001f

	)

2555 
	#PCI_DEVICE_ID_ADAPTEC2_3940U2
 0x0050

	)

2556 
	#PCI_DEVICE_ID_ADAPTEC2_3950U2D
 0x0051

	)

2557 
	#PCI_DEVICE_ID_ADAPTEC2_7896
 0x005f

	)

2558 
	#PCI_DEVICE_ID_ADAPTEC2_7892A
 0x0080

	)

2559 
	#PCI_DEVICE_ID_ADAPTEC2_7892B
 0x0081

	)

2560 
	#PCI_DEVICE_ID_ADAPTEC2_7892D
 0x0083

	)

2561 
	#PCI_DEVICE_ID_ADAPTEC2_7892P
 0x008f

	)

2562 
	#PCI_DEVICE_ID_ADAPTEC2_7899A
 0x00c0

	)

2563 
	#PCI_DEVICE_ID_ADAPTEC2_7899B
 0x00c1

	)

2564 
	#PCI_DEVICE_ID_ADAPTEC2_7899D
 0x00c3

	)

2565 
	#PCI_DEVICE_ID_ADAPTEC2_7899P
 0x00cf

	)

2566 
	#PCI_DEVICE_ID_ADAPTEC2_OBSIDIAN
 0x0500

	)

2567 
	#PCI_DEVICE_ID_ADAPTEC2_SCAMP
 0x0503

	)

2570 
	#PCI_VENDOR_ID_HOLTEK
 0x9412

	)

2571 
	#PCI_DEVICE_ID_HOLTEK_6565
 0x6565

	)

2573 
	#PCI_VENDOR_ID_NETMOS
 0x9710

	)

2574 
	#PCI_DEVICE_ID_NETMOS_9705
 0x9705

	)

2575 
	#PCI_DEVICE_ID_NETMOS_9715
 0x9715

	)

2576 
	#PCI_DEVICE_ID_NETMOS_9735
 0x9735

	)

2577 
	#PCI_DEVICE_ID_NETMOS_9745
 0x9745

	)

2578 
	#PCI_DEVICE_ID_NETMOS_9755
 0x9755

	)

2579 
	#PCI_DEVICE_ID_NETMOS_9805
 0x9805

	)

2580 
	#PCI_DEVICE_ID_NETMOS_9815
 0x9815

	)

2581 
	#PCI_DEVICE_ID_NETMOS_9835
 0x9835

	)

2582 
	#PCI_DEVICE_ID_NETMOS_9845
 0x9845

	)

2583 
	#PCI_DEVICE_ID_NETMOS_9855
 0x9855

	)

2585 
	#PCI_VENDOR_ID_3COM_2
 0xa727

	)

2587 
	#PCI_SUBVENDOR_ID_EXSYS
 0xd84d

	)

2588 
	#PCI_SUBDEVICE_ID_EXSYS_4014
 0x4014

	)

2589 
	#PCI_SUBDEVICE_ID_EXSYS_4055
 0x4055

	)

2591 
	#PCI_VENDOR_ID_TIGERJET
 0xe159

	)

2592 
	#PCI_DEVICE_ID_TIGERJET_300
 0x0001

	)

2593 
	#PCI_DEVICE_ID_TIGERJET_100
 0x0002

	)

2595 
	#PCI_VENDOR_ID_TTTECH
 0x0357

	)

2596 
	#PCI_DEVICE_ID_TTTECH_MC322
 0x000A

	)

2598 
	#PCI_VENDOR_ID_XILINX_RME
 0x—60

	)

2599 
	#PCI_DEVICE_ID_RME_DIGI32
 0x9896

	)

2600 
	#PCI_DEVICE_ID_RME_DIGI32_PRO
 0x9897

	)

2601 
	#PCI_DEVICE_ID_RME_DIGI32_8
 0x9898

	)

	@/usr/include/linux/pci_regs.h

22 #iâdeà
LINUX_PCI_REGS_H


23 
	#LINUX_PCI_REGS_H


	)

29 
	#PCI_VENDOR_ID
 0x00

	)

30 
	#PCI_DEVICE_ID
 0x02

	)

31 
	#PCI_COMMAND
 0x04

	)

32 
	#PCI_COMMAND_IO
 0x1

	)

33 
	#PCI_COMMAND_MEMORY
 0x2

	)

34 
	#PCI_COMMAND_MASTER
 0x4

	)

35 
	#PCI_COMMAND_SPECIAL
 0x8

	)

36 
	#PCI_COMMAND_INVALIDATE
 0x10

	)

37 
	#PCI_COMMAND_VGA_PALETTE
 0x20

	)

38 
	#PCI_COMMAND_PARITY
 0x40

	)

39 
	#PCI_COMMAND_WAIT
 0x80

	)

40 
	#PCI_COMMAND_SERR
 0x100

	)

41 
	#PCI_COMMAND_FAST_BACK
 0x200

	)

42 
	#PCI_COMMAND_INTX_DISABLE
 0x400

	)

44 
	#PCI_STATUS
 0x06

	)

45 
	#PCI_STATUS_CAP_LIST
 0x10

	)

46 
	#PCI_STATUS_66MHZ
 0x20

	)

47 
	#PCI_STATUS_UDF
 0x40

	)

48 
	#PCI_STATUS_FAST_BACK
 0x80

	)

49 
	#PCI_STATUS_PARITY
 0x100

	)

50 
	#PCI_STATUS_DEVSEL_MASK
 0x600

	)

51 
	#PCI_STATUS_DEVSEL_FAST
 0x000

	)

52 
	#PCI_STATUS_DEVSEL_MEDIUM
 0x200

	)

53 
	#PCI_STATUS_DEVSEL_SLOW
 0x400

	)

54 
	#PCI_STATUS_SIG_TARGET_ABORT
 0x800

	)

55 
	#PCI_STATUS_REC_TARGET_ABORT
 0x1000

	)

56 
	#PCI_STATUS_REC_MASTER_ABORT
 0x2000

	)

57 
	#PCI_STATUS_SIG_SYSTEM_ERROR
 0x4000

	)

58 
	#PCI_STATUS_DETECTED_PARITY
 0x8000

	)

60 
	#PCI_CLASS_REVISION
 0x08

	)

61 
	#PCI_REVISION_ID
 0x08

	)

62 
	#PCI_CLASS_PROG
 0x09

	)

63 
	#PCI_CLASS_DEVICE
 0x0¨

	)

65 
	#PCI_CACHE_LINE_SIZE
 0x0ø

	)

66 
	#PCI_LATENCY_TIMER
 0x0d

	)

67 
	#PCI_HEADER_TYPE
 0x0

	)

68 
	#PCI_HEADER_TYPE_NORMAL
 0

	)

69 
	#PCI_HEADER_TYPE_BRIDGE
 1

	)

70 
	#PCI_HEADER_TYPE_CARDBUS
 2

	)

72 
	#PCI_BIST
 0x0à

	)

73 
	#PCI_BIST_CODE_MASK
 0x0à

	)

74 
	#PCI_BIST_START
 0x40

	)

75 
	#PCI_BIST_CAPABLE
 0x80

	)

83 
	#PCI_BASE_ADDRESS_0
 0x10

	)

84 
	#PCI_BASE_ADDRESS_1
 0x14

	)

85 
	#PCI_BASE_ADDRESS_2
 0x18

	)

86 
	#PCI_BASE_ADDRESS_3
 0x1ø

	)

87 
	#PCI_BASE_ADDRESS_4
 0x20

	)

88 
	#PCI_BASE_ADDRESS_5
 0x24

	)

89 
	#PCI_BASE_ADDRESS_SPACE
 0x01

	)

90 
	#PCI_BASE_ADDRESS_SPACE_IO
 0x01

	)

91 
	#PCI_BASE_ADDRESS_SPACE_MEMORY
 0x00

	)

92 
	#PCI_BASE_ADDRESS_MEM_TYPE_MASK
 0x06

	)

93 
	#PCI_BASE_ADDRESS_MEM_TYPE_32
 0x00

	)

94 
	#PCI_BASE_ADDRESS_MEM_TYPE_1M
 0x02

	)

95 
	#PCI_BASE_ADDRESS_MEM_TYPE_64
 0x04

	)

96 
	#PCI_BASE_ADDRESS_MEM_PREFETCH
 0x08

	)

97 
	#PCI_BASE_ADDRESS_MEM_MASK
 (~0x0fUL)

	)

98 
	#PCI_BASE_ADDRESS_IO_MASK
 (~0x03UL)

	)

102 
	#PCI_CARDBUS_CIS
 0x28

	)

103 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2c

	)

104 
	#PCI_SUBSYSTEM_ID
 0x2e

	)

105 
	#PCI_ROM_ADDRESS
 0x30

	)

106 
	#PCI_ROM_ADDRESS_ENABLE
 0x01

	)

107 
	#PCI_ROM_ADDRESS_MASK
 (~0x7ffUL)

	)

109 
	#PCI_CAPABILITY_LIST
 0x34

	)

112 
	#PCI_INTERRUPT_LINE
 0x3ø

	)

113 
	#PCI_INTERRUPT_PIN
 0x3d

	)

114 
	#PCI_MIN_GNT
 0x3

	)

115 
	#PCI_MAX_LAT
 0x3à

	)

118 
	#PCI_PRIMARY_BUS
 0x18

	)

119 
	#PCI_SECONDARY_BUS
 0x19

	)

120 
	#PCI_SUBORDINATE_BUS
 0x1¨

	)

121 
	#PCI_SEC_LATENCY_TIMER
 0x1b

	)

122 
	#PCI_IO_BASE
 0x1ø

	)

123 
	#PCI_IO_LIMIT
 0x1d

	)

124 
	#PCI_IO_RANGE_TYPE_MASK
 0x0fUL

	)

125 
	#PCI_IO_RANGE_TYPE_16
 0x00

	)

126 
	#PCI_IO_RANGE_TYPE_32
 0x01

	)

127 
	#PCI_IO_RANGE_MASK
 (~0x0fUL)

	)

128 
	#PCI_SEC_STATUS
 0x1

	)

129 
	#PCI_MEMORY_BASE
 0x20

	)

130 
	#PCI_MEMORY_LIMIT
 0x22

	)

131 
	#PCI_MEMORY_RANGE_TYPE_MASK
 0x0fUL

	)

132 
	#PCI_MEMORY_RANGE_MASK
 (~0x0fUL)

	)

133 
	#PCI_PREF_MEMORY_BASE
 0x24

	)

134 
	#PCI_PREF_MEMORY_LIMIT
 0x26

	)

135 
	#PCI_PREF_RANGE_TYPE_MASK
 0x0fUL

	)

136 
	#PCI_PREF_RANGE_TYPE_32
 0x00

	)

137 
	#PCI_PREF_RANGE_TYPE_64
 0x01

	)

138 
	#PCI_PREF_RANGE_MASK
 (~0x0fUL)

	)

139 
	#PCI_PREF_BASE_UPPER32
 0x28

	)

140 
	#PCI_PREF_LIMIT_UPPER32
 0x2c

	)

141 
	#PCI_IO_BASE_UPPER16
 0x30

	)

142 
	#PCI_IO_LIMIT_UPPER16
 0x32

	)

145 
	#PCI_ROM_ADDRESS1
 0x38

	)

147 
	#PCI_BRIDGE_CONTROL
 0x3e

	)

148 
	#PCI_BRIDGE_CTL_PARITY
 0x01

	)

149 
	#PCI_BRIDGE_CTL_SERR
 0x02

	)

150 
	#PCI_BRIDGE_CTL_ISA
 0x04

	)

151 
	#PCI_BRIDGE_CTL_VGA
 0x08

	)

152 
	#PCI_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

153 
	#PCI_BRIDGE_CTL_BUS_RESET
 0x40

	)

154 
	#PCI_BRIDGE_CTL_FAST_BACK
 0x80

	)

157 
	#PCI_CB_CAPABILITY_LIST
 0x14

	)

159 
	#PCI_CB_SEC_STATUS
 0x16

	)

160 
	#PCI_CB_PRIMARY_BUS
 0x18

	)

161 
	#PCI_CB_CARD_BUS
 0x19

	)

162 
	#PCI_CB_SUBORDINATE_BUS
 0x1¨

	)

163 
	#PCI_CB_LATENCY_TIMER
 0x1b

	)

164 
	#PCI_CB_MEMORY_BASE_0
 0x1c

	)

165 
	#PCI_CB_MEMORY_LIMIT_0
 0x20

	)

166 
	#PCI_CB_MEMORY_BASE_1
 0x24

	)

167 
	#PCI_CB_MEMORY_LIMIT_1
 0x28

	)

168 
	#PCI_CB_IO_BASE_0
 0x2c

	)

169 
	#PCI_CB_IO_BASE_0_HI
 0x2e

	)

170 
	#PCI_CB_IO_LIMIT_0
 0x30

	)

171 
	#PCI_CB_IO_LIMIT_0_HI
 0x32

	)

172 
	#PCI_CB_IO_BASE_1
 0x34

	)

173 
	#PCI_CB_IO_BASE_1_HI
 0x36

	)

174 
	#PCI_CB_IO_LIMIT_1
 0x38

	)

175 
	#PCI_CB_IO_LIMIT_1_HI
 0x3a

	)

176 
	#PCI_CB_IO_RANGE_MASK
 (~0x03UL)

	)

178 
	#PCI_CB_BRIDGE_CONTROL
 0x3e

	)

179 
	#PCI_CB_BRIDGE_CTL_PARITY
 0x01

	)

180 
	#PCI_CB_BRIDGE_CTL_SERR
 0x02

	)

181 
	#PCI_CB_BRIDGE_CTL_ISA
 0x04

	)

182 
	#PCI_CB_BRIDGE_CTL_VGA
 0x08

	)

183 
	#PCI_CB_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

184 
	#PCI_CB_BRIDGE_CTL_CB_RESET
 0x40

	)

185 
	#PCI_CB_BRIDGE_CTL_16BIT_INT
 0x80

	)

186 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM0
 0x100

	)

187 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM1
 0x200

	)

188 
	#PCI_CB_BRIDGE_CTL_POST_WRITES
 0x400

	)

189 
	#PCI_CB_SUBSYSTEM_VENDOR_ID
 0x40

	)

190 
	#PCI_CB_SUBSYSTEM_ID
 0x42

	)

191 
	#PCI_CB_LEGACY_MODE_BASE
 0x44

	)

196 
	#PCI_CAP_LIST_ID
 0

	)

197 
	#PCI_CAP_ID_PM
 0x01

	)

198 
	#PCI_CAP_ID_AGP
 0x02

	)

199 
	#PCI_CAP_ID_VPD
 0x03

	)

200 
	#PCI_CAP_ID_SLOTID
 0x04

	)

201 
	#PCI_CAP_ID_MSI
 0x05

	)

202 
	#PCI_CAP_ID_CHSWP
 0x06

	)

203 
	#PCI_CAP_ID_PCIX
 0x07

	)

204 
	#PCI_CAP_ID_HT
 0x08

	)

205 
	#PCI_CAP_ID_VNDR
 0x09

	)

206 
	#PCI_CAP_ID_SHPC
 0x0C

	)

207 
	#PCI_CAP_ID_EXP
 0x10

	)

208 
	#PCI_CAP_ID_MSIX
 0x11

	)

209 
	#PCI_CAP_ID_AF
 0x13

	)

210 
	#PCI_CAP_LIST_NEXT
 1

	)

211 
	#PCI_CAP_FLAGS
 2

	)

212 
	#PCI_CAP_SIZEOF
 4

	)

216 
	#PCI_PM_PMC
 2

	)

217 
	#PCI_PM_CAP_VER_MASK
 0x0007

	)

218 
	#PCI_PM_CAP_PME_CLOCK
 0x0008

	)

219 
	#PCI_PM_CAP_RESERVED
 0x0010

	)

220 
	#PCI_PM_CAP_DSI
 0x0020

	)

221 
	#PCI_PM_CAP_AUX_POWER
 0x01C0

	)

222 
	#PCI_PM_CAP_D1
 0x0200

	)

223 
	#PCI_PM_CAP_D2
 0x0400

	)

224 
	#PCI_PM_CAP_PME
 0x0800

	)

225 
	#PCI_PM_CAP_PME_MASK
 0xF800

	)

226 
	#PCI_PM_CAP_PME_D0
 0x0800

	)

227 
	#PCI_PM_CAP_PME_D1
 0x1000

	)

228 
	#PCI_PM_CAP_PME_D2
 0x2000

	)

229 
	#PCI_PM_CAP_PME_D3
 0x4000

	)

230 
	#PCI_PM_CAP_PME_D3cŞd
 0x8000

	)

231 
	#PCI_PM_CTRL
 4

	)

232 
	#PCI_PM_CTRL_STATE_MASK
 0x0003

	)

233 
	#PCI_PM_CTRL_NO_SOFT_RESET
 0x0004

	)

234 
	#PCI_PM_CTRL_PME_ENABLE
 0x0100

	)

235 
	#PCI_PM_CTRL_DATA_SEL_MASK
 0x1e00

	)

236 
	#PCI_PM_CTRL_DATA_SCALE_MASK
 0x6000

	)

237 
	#PCI_PM_CTRL_PME_STATUS
 0x8000

	)

238 
	#PCI_PM_PPB_EXTENSIONS
 6

	)

239 
	#PCI_PM_PPB_B2_B3
 0x40

	)

240 
	#PCI_PM_BPCC_ENABLE
 0x80

	)

241 
	#PCI_PM_DATA_REGISTER
 7

	)

242 
	#PCI_PM_SIZEOF
 8

	)

246 
	#PCI_AGP_VERSION
 2

	)

247 
	#PCI_AGP_RFU
 3

	)

248 
	#PCI_AGP_STATUS
 4

	)

249 
	#PCI_AGP_STATUS_RQ_MASK
 0xff000000

	)

250 
	#PCI_AGP_STATUS_SBA
 0x0200

	)

251 
	#PCI_AGP_STATUS_64BIT
 0x0020

	)

252 
	#PCI_AGP_STATUS_FW
 0x0010

	)

253 
	#PCI_AGP_STATUS_RATE4
 0x0004

	)

254 
	#PCI_AGP_STATUS_RATE2
 0x0002

	)

255 
	#PCI_AGP_STATUS_RATE1
 0x0001

	)

256 
	#PCI_AGP_COMMAND
 8

	)

257 
	#PCI_AGP_COMMAND_RQ_MASK
 0xff000000

	)

258 
	#PCI_AGP_COMMAND_SBA
 0x0200

	)

259 
	#PCI_AGP_COMMAND_AGP
 0x0100

	)

260 
	#PCI_AGP_COMMAND_64BIT
 0x0020

	)

261 
	#PCI_AGP_COMMAND_FW
 0x0010

	)

262 
	#PCI_AGP_COMMAND_RATE4
 0x0004

	)

263 
	#PCI_AGP_COMMAND_RATE2
 0x0002

	)

264 
	#PCI_AGP_COMMAND_RATE1
 0x0001

	)

265 
	#PCI_AGP_SIZEOF
 12

	)

269 
	#PCI_VPD_ADDR
 2

	)

270 
	#PCI_VPD_ADDR_MASK
 0x7ffà

	)

271 
	#PCI_VPD_ADDR_F
 0x8000

	)

272 
	#PCI_VPD_DATA
 4

	)

276 
	#PCI_SID_ESR
 2

	)

277 
	#PCI_SID_ESR_NSLOTS
 0x1à

	)

278 
	#PCI_SID_ESR_FIC
 0x20

	)

279 
	#PCI_SID_CHASSIS_NR
 3

	)

283 
	#PCI_MSI_FLAGS
 2

	)

284 
	#PCI_MSI_FLAGS_64BIT
 0x80

	)

285 
	#PCI_MSI_FLAGS_QSIZE
 0x70

	)

286 
	#PCI_MSI_FLAGS_QMASK
 0x0

	)

287 
	#PCI_MSI_FLAGS_ENABLE
 0x01

	)

288 
	#PCI_MSI_FLAGS_MASKBIT
 0x100

	)

289 
	#PCI_MSI_RFU
 3

	)

290 
	#PCI_MSI_ADDRESS_LO
 4

	)

291 
	#PCI_MSI_ADDRESS_HI
 8

	)

292 
	#PCI_MSI_DATA_32
 8

	)

293 
	#PCI_MSI_DATA_64
 12

	)

294 
	#PCI_MSI_MASK_BIT
 16

	)

297 
	#PCI_MSIX_FLAGS
 2

	)

298 
	#PCI_MSIX_FLAGS_QSIZE
 0x7FF

	)

299 
	#PCI_MSIX_FLAGS_ENABLE
 (1 << 15)

	)

300 
	#PCI_MSIX_FLAGS_MASKALL
 (1 << 14)

	)

301 
	#PCI_MSIX_FLAGS_BIRMASK
 (7 << 0)

	)

302 
	#PCI_MSIX_FLAGS_BITMASK
 (1 << 0)

	)

306 
	#PCI_CHSWP_CSR
 2

	)

307 
	#PCI_CHSWP_DHA
 0x01

	)

308 
	#PCI_CHSWP_EIM
 0x02

	)

309 
	#PCI_CHSWP_PIE
 0x04

	)

310 
	#PCI_CHSWP_LOO
 0x08

	)

311 
	#PCI_CHSWP_PI
 0x30

	)

312 
	#PCI_CHSWP_EXT
 0x40

	)

313 
	#PCI_CHSWP_INS
 0x80

	)

317 
	#PCI_AF_LENGTH
 2

	)

318 
	#PCI_AF_CAP
 3

	)

319 
	#PCI_AF_CAP_TP
 0x01

	)

320 
	#PCI_AF_CAP_FLR
 0x02

	)

321 
	#PCI_AF_CTRL
 4

	)

322 
	#PCI_AF_CTRL_FLR
 0x01

	)

323 
	#PCI_AF_STATUS
 5

	)

324 
	#PCI_AF_STATUS_TP
 0x01

	)

328 
	#PCI_X_CMD
 2

	)

329 
	#PCI_X_CMD_DPERR_E
 0x0001

	)

330 
	#PCI_X_CMD_ERO
 0x0002

	)

331 
	#PCI_X_CMD_READ_2K
 0x0008

	)

332 
	#PCI_X_CMD_MAX_READ
 0x000ø

	)

333 
	#PCI_X_CMD_MAX_SPLIT
 0x0070

	)

334 
	#PCI_X_CMD_VERSION
(
x
è(((xè>> 12è& 3è

	)

335 
	#PCI_X_STATUS
 4

	)

336 
	#PCI_X_STATUS_DEVFN
 0x000000fà

	)

337 
	#PCI_X_STATUS_BUS
 0x0000ff00

	)

338 
	#PCI_X_STATUS_64BIT
 0x00010000

	)

339 
	#PCI_X_STATUS_133MHZ
 0x00020000

	)

340 
	#PCI_X_STATUS_SPL_DISC
 0x00040000

	)

341 
	#PCI_X_STATUS_UNX_SPL
 0x00080000

	)

342 
	#PCI_X_STATUS_COMPLEX
 0x00100000

	)

343 
	#PCI_X_STATUS_MAX_READ
 0x00600000

	)

344 
	#PCI_X_STATUS_MAX_SPLIT
 0x03800000

	)

345 
	#PCI_X_STATUS_MAX_CUM
 0x1c000000

	)

346 
	#PCI_X_STATUS_SPL_ERR
 0x20000000

	)

347 
	#PCI_X_STATUS_266MHZ
 0x40000000

	)

348 
	#PCI_X_STATUS_533MHZ
 0x80000000

	)

352 
	#PCI_EXP_FLAGS
 2

	)

353 
	#PCI_EXP_FLAGS_VERS
 0x000à

	)

354 
	#PCI_EXP_FLAGS_TYPE
 0x00f0

	)

355 
	#PCI_EXP_TYPE_ENDPOINT
 0x0

	)

356 
	#PCI_EXP_TYPE_LEG_END
 0x1

	)

357 
	#PCI_EXP_TYPE_ROOT_PORT
 0x4

	)

358 
	#PCI_EXP_TYPE_UPSTREAM
 0x5

	)

359 
	#PCI_EXP_TYPE_DOWNSTREAM
 0x6

	)

360 
	#PCI_EXP_TYPE_PCI_BRIDGE
 0x7

	)

361 
	#PCI_EXP_TYPE_RC_END
 0x9

	)

362 
	#PCI_EXP_FLAGS_SLOT
 0x0100

	)

363 
	#PCI_EXP_FLAGS_IRQ
 0x3e00

	)

364 
	#PCI_EXP_DEVCAP
 4

	)

365 
	#PCI_EXP_DEVCAP_PAYLOAD
 0x07

	)

366 
	#PCI_EXP_DEVCAP_PHANTOM
 0x18

	)

367 
	#PCI_EXP_DEVCAP_EXT_TAG
 0x20

	)

368 
	#PCI_EXP_DEVCAP_L0S
 0x1c0

	)

369 
	#PCI_EXP_DEVCAP_L1
 0xe00

	)

370 
	#PCI_EXP_DEVCAP_ATN_BUT
 0x1000

	)

371 
	#PCI_EXP_DEVCAP_ATN_IND
 0x2000

	)

372 
	#PCI_EXP_DEVCAP_PWR_IND
 0x4000

	)

373 
	#PCI_EXP_DEVCAP_PWR_VAL
 0x3fc0000

	)

374 
	#PCI_EXP_DEVCAP_PWR_SCL
 0xc000000

	)

375 
	#PCI_EXP_DEVCAP_FLR
 0x10000000

	)

376 
	#PCI_EXP_DEVCTL
 8

	)

377 
	#PCI_EXP_DEVCTL_CERE
 0x0001

	)

378 
	#PCI_EXP_DEVCTL_NFERE
 0x0002

	)

379 
	#PCI_EXP_DEVCTL_FERE
 0x0004

	)

380 
	#PCI_EXP_DEVCTL_URRE
 0x0008

	)

381 
	#PCI_EXP_DEVCTL_RELAX_EN
 0x0010

	)

382 
	#PCI_EXP_DEVCTL_PAYLOAD
 0x00e0

	)

383 
	#PCI_EXP_DEVCTL_EXT_TAG
 0x0100

	)

384 
	#PCI_EXP_DEVCTL_PHANTOM
 0x0200

	)

385 
	#PCI_EXP_DEVCTL_AUX_PME
 0x0400

	)

386 
	#PCI_EXP_DEVCTL_NOSNOOP_EN
 0x0800

	)

387 
	#PCI_EXP_DEVCTL_READRQ
 0x7000

	)

388 
	#PCI_EXP_DEVCTL_BCR_FLR
 0x8000

	)

389 
	#PCI_EXP_DEVSTA
 10

	)

390 
	#PCI_EXP_DEVSTA_CED
 0x01

	)

391 
	#PCI_EXP_DEVSTA_NFED
 0x02

	)

392 
	#PCI_EXP_DEVSTA_FED
 0x04

	)

393 
	#PCI_EXP_DEVSTA_URD
 0x08

	)

394 
	#PCI_EXP_DEVSTA_AUXPD
 0x10

	)

395 
	#PCI_EXP_DEVSTA_TRPND
 0x20

	)

396 
	#PCI_EXP_LNKCAP
 12

	)

397 
	#PCI_EXP_LNKCTL
 16

	)

398 
	#PCI_EXP_LNKCTL_CLKREQ_EN
 0x100

	)

399 
	#PCI_EXP_LNKSTA
 18

	)

400 
	#PCI_EXP_LNKSTA_CLS
 0x000à

	)

401 
	#PCI_EXP_LNKSTA_CLS_2_5GB
 0x01

	)

402 
	#PCI_EXP_LNKSTA_CLS_5_0GB
 0x02

	)

403 
	#PCI_EXP_LNKSTA_NLW
 0x03f0

	)

404 
	#PCI_EXP_LNKSTA_NLW_SHIFT
 4

	)

405 
	#PCI_EXP_LNKSTA_LT
 0x0800

	)

406 
	#PCI_EXP_LNKSTA_SLC
 0x1000

	)

407 
	#PCI_EXP_LNKSTA_DLLLA
 0x2000

	)

408 
	#PCI_EXP_LNKSTA_LBMS
 0x4000

	)

409 
	#PCI_EXP_LNKSTA_LABS
 0x8000

	)

410 
	#PCI_EXP_SLTCAP
 20

	)

411 
	#PCI_EXP_SLTCTL
 24

	)

412 
	#PCI_EXP_SLTSTA
 26

	)

413 
	#PCI_EXP_RTCTL
 28

	)

414 
	#PCI_EXP_RTCTL_SECEE
 0x01

	)

415 
	#PCI_EXP_RTCTL_SENFEE
 0x02

	)

416 
	#PCI_EXP_RTCTL_SEFEE
 0x04

	)

417 
	#PCI_EXP_RTCTL_PMEIE
 0x08

	)

418 
	#PCI_EXP_RTCTL_CRSSVE
 0x10

	)

419 
	#PCI_EXP_RTCAP
 30

	)

420 
	#PCI_EXP_RTSTA
 32

	)

427 
	#PCI_EXP_DEVCAP2
 36

	)

428 
	#PCI_EXP_DEVCAP2_ARI
 0x20

	)

429 
	#PCI_EXP_DEVCAP2_LTR
 0x800

	)

430 
	#PCI_EXP_OBFF_MASK
 0xc0000

	)

431 
	#PCI_EXP_OBFF_MSG
 0x40000

	)

432 
	#PCI_EXP_OBFF_WAKE
 0x80000

	)

433 
	#PCI_EXP_DEVCTL2
 40

	)

434 
	#PCI_EXP_DEVCTL2_ARI
 0x20

	)

435 
	#PCI_EXP_IDO_REQ_EN
 0x100

	)

436 
	#PCI_EXP_IDO_CMP_EN
 0x200

	)

437 
	#PCI_EXP_LTR_EN
 0x400

	)

438 
	#PCI_EXP_OBFF_MSGA_EN
 0x2000

	)

439 
	#PCI_EXP_OBFF_MSGB_EN
 0x4000

	)

440 
	#PCI_EXP_OBFF_WAKE_EN
 0x6000

	)

441 
	#PCI_EXP_LNKCTL2
 48

	)

442 
	#PCI_EXP_SLTCTL2
 56

	)

445 
	#PCI_EXT_CAP_ID
(
h—d”
è(h—d” & 0x0000ffff)

	)

446 
	#PCI_EXT_CAP_VER
(
h—d”
è((h—d” >> 16è& 0xf)

	)

447 
	#PCI_EXT_CAP_NEXT
(
h—d”
è((h—d” >> 20è& 0xffc)

	)

449 
	#PCI_EXT_CAP_ID_ERR
 1

	)

450 
	#PCI_EXT_CAP_ID_VC
 2

	)

451 
	#PCI_EXT_CAP_ID_DSN
 3

	)

452 
	#PCI_EXT_CAP_ID_PWR
 4

	)

453 
	#PCI_EXT_CAP_ID_ACS
 13

	)

454 
	#PCI_EXT_CAP_ID_ARI
 14

	)

455 
	#PCI_EXT_CAP_ID_ATS
 15

	)

456 
	#PCI_EXT_CAP_ID_SRIOV
 16

	)

457 
	#PCI_EXT_CAP_ID_LTR
 24

	)

460 
	#PCI_ERR_UNCOR_STATUS
 4

	)

461 
	#PCI_ERR_UNC_TRAIN
 0x00000001

	)

462 
	#PCI_ERR_UNC_DLP
 0x00000010

	)

463 
	#PCI_ERR_UNC_POISON_TLP
 0x00001000

	)

464 
	#PCI_ERR_UNC_FCP
 0x00002000

	)

465 
	#PCI_ERR_UNC_COMP_TIME
 0x00004000

	)

466 
	#PCI_ERR_UNC_COMP_ABORT
 0x00008000

	)

467 
	#PCI_ERR_UNC_UNX_COMP
 0x00010000

	)

468 
	#PCI_ERR_UNC_RX_OVER
 0x00020000

	)

469 
	#PCI_ERR_UNC_MALF_TLP
 0x00040000

	)

470 
	#PCI_ERR_UNC_ECRC
 0x00080000

	)

471 
	#PCI_ERR_UNC_UNSUP
 0x00100000

	)

472 
	#PCI_ERR_UNCOR_MASK
 8

	)

474 
	#PCI_ERR_UNCOR_SEVER
 12

	)

476 
	#PCI_ERR_COR_STATUS
 16

	)

477 
	#PCI_ERR_COR_RCVR
 0x00000001

	)

478 
	#PCI_ERR_COR_BAD_TLP
 0x00000040

	)

479 
	#PCI_ERR_COR_BAD_DLLP
 0x00000080

	)

480 
	#PCI_ERR_COR_REP_ROLL
 0x00000100

	)

481 
	#PCI_ERR_COR_REP_TIMER
 0x00001000

	)

482 
	#PCI_ERR_COR_MASK
 20

	)

484 
	#PCI_ERR_CAP
 24

	)

485 
	#PCI_ERR_CAP_FEP
(
x
è((xè& 31è

	)

486 
	#PCI_ERR_CAP_ECRC_GENC
 0x00000020

	)

487 
	#PCI_ERR_CAP_ECRC_GENE
 0x00000040

	)

488 
	#PCI_ERR_CAP_ECRC_CHKC
 0x00000080

	)

489 
	#PCI_ERR_CAP_ECRC_CHKE
 0x00000100

	)

490 
	#PCI_ERR_HEADER_LOG
 28

	)

491 
	#PCI_ERR_ROOT_COMMAND
 44

	)

493 
	#PCI_ERR_ROOT_CMD_COR_EN
 0x00000001

	)

495 
	#PCI_ERR_ROOT_CMD_NONFATAL_EN
 0x00000002

	)

497 
	#PCI_ERR_ROOT_CMD_FATAL_EN
 0x00000004

	)

498 
	#PCI_ERR_ROOT_STATUS
 48

	)

499 
	#PCI_ERR_ROOT_COR_RCV
 0x00000001

	)

501 
	#PCI_ERR_ROOT_MULTI_COR_RCV
 0x00000002

	)

503 
	#PCI_ERR_ROOT_UNCOR_RCV
 0x00000004

	)

505 
	#PCI_ERR_ROOT_MULTI_UNCOR_RCV
 0x00000008

	)

506 
	#PCI_ERR_ROOT_FIRST_FATAL
 0x00000010

	)

507 
	#PCI_ERR_ROOT_NONFATAL_RCV
 0x00000020

	)

508 
	#PCI_ERR_ROOT_FATAL_RCV
 0x00000040

	)

509 
	#PCI_ERR_ROOT_COR_SRC
 52

	)

510 
	#PCI_ERR_ROOT_SRC
 54

	)

513 
	#PCI_VC_PORT_REG1
 4

	)

514 
	#PCI_VC_PORT_REG2
 8

	)

515 
	#PCI_VC_PORT_CTRL
 12

	)

516 
	#PCI_VC_PORT_STATUS
 14

	)

517 
	#PCI_VC_RES_CAP
 16

	)

518 
	#PCI_VC_RES_CTRL
 20

	)

519 
	#PCI_VC_RES_STATUS
 26

	)

522 
	#PCI_PWR_DSR
 4

	)

523 
	#PCI_PWR_DATA
 8

	)

524 
	#PCI_PWR_DATA_BASE
(
x
è((xè& 0xffè

	)

525 
	#PCI_PWR_DATA_SCALE
(
x
è(((xè>> 8è& 3è

	)

526 
	#PCI_PWR_DATA_PM_SUB
(
x
è(((xè>> 10è& 7è

	)

527 
	#PCI_PWR_DATA_PM_STATE
(
x
è(((xè>> 13è& 3è

	)

528 
	#PCI_PWR_DATA_TYPE
(
x
è(((xè>> 15è& 7è

	)

529 
	#PCI_PWR_DATA_RAIL
(
x
è(((xè>> 18è& 7è

	)

530 
	#PCI_PWR_CAP
 12

	)

531 
	#PCI_PWR_CAP_BUDGET
(
x
è((xè& 1è

	)

541 
	#HT_3BIT_CAP_MASK
 0xE0

	)

542 
	#HT_CAPTYPE_SLAVE
 0x00

	)

543 
	#HT_CAPTYPE_HOST
 0x20

	)

545 
	#HT_5BIT_CAP_MASK
 0xF8

	)

546 
	#HT_CAPTYPE_IRQ
 0x80

	)

547 
	#HT_CAPTYPE_REMAPPING_40
 0xA0

	)

548 
	#HT_CAPTYPE_REMAPPING_64
 0xA2

	)

549 
	#HT_CAPTYPE_UNITID_CLUMP
 0x90

	)

550 
	#HT_CAPTYPE_EXTCONF
 0x98

	)

551 
	#HT_CAPTYPE_MSI_MAPPING
 0xA8

	)

552 
	#HT_MSI_FLAGS
 0x02

	)

553 
	#HT_MSI_FLAGS_ENABLE
 0x1

	)

554 
	#HT_MSI_FLAGS_FIXED
 0x2

	)

555 
	#HT_MSI_FIXED_ADDR
 0x00000000FEE00000ULL

	)

556 
	#HT_MSI_ADDR_LO
 0x04

	)

557 
	#HT_MSI_ADDR_LO_MASK
 0xFFF00000

	)

558 
	#HT_MSI_ADDR_HI
 0x08

	)

559 
	#HT_CAPTYPE_DIRECT_ROUTE
 0xB0

	)

560 
	#HT_CAPTYPE_VCSET
 0xB8

	)

561 
	#HT_CAPTYPE_ERROR_RETRY
 0xC0

	)

562 
	#HT_CAPTYPE_GEN3
 0xD0

	)

563 
	#HT_CAPTYPE_PM
 0xE0

	)

566 
	#PCI_ARI_CAP
 0x04

	)

567 
	#PCI_ARI_CAP_MFVC
 0x0001

	)

568 
	#PCI_ARI_CAP_ACS
 0x0002

	)

569 
	#PCI_ARI_CAP_NFN
(
x
è(((xè>> 8è& 0xffè

	)

570 
	#PCI_ARI_CTRL
 0x06

	)

571 
	#PCI_ARI_CTRL_MFVC
 0x0001

	)

572 
	#PCI_ARI_CTRL_ACS
 0x0002

	)

573 
	#PCI_ARI_CTRL_FG
(
x
è(((xè>> 4è& 7è

	)

576 
	#PCI_ATS_CAP
 0x04

	)

577 
	#PCI_ATS_CAP_QDEP
(
x
è((xè& 0x1fè

	)

578 
	#PCI_ATS_MAX_QDEP
 32

	)

579 
	#PCI_ATS_CTRL
 0x06

	)

580 
	#PCI_ATS_CTRL_ENABLE
 0x8000

	)

581 
	#PCI_ATS_CTRL_STU
(
x
è((xè& 0x1fè

	)

582 
	#PCI_ATS_MIN_STU
 12

	)

585 
	#PCI_SRIOV_CAP
 0x04

	)

586 
	#PCI_SRIOV_CAP_VFM
 0x01

	)

587 
	#PCI_SRIOV_CAP_INTR
(
x
è((xè>> 21è

	)

588 
	#PCI_SRIOV_CTRL
 0x08

	)

589 
	#PCI_SRIOV_CTRL_VFE
 0x01

	)

590 
	#PCI_SRIOV_CTRL_VFM
 0x02

	)

591 
	#PCI_SRIOV_CTRL_INTR
 0x04

	)

592 
	#PCI_SRIOV_CTRL_MSE
 0x08

	)

593 
	#PCI_SRIOV_CTRL_ARI
 0x10

	)

594 
	#PCI_SRIOV_STATUS
 0x0¨

	)

595 
	#PCI_SRIOV_STATUS_VFM
 0x01

	)

596 
	#PCI_SRIOV_INITIAL_VF
 0x0ø

	)

597 
	#PCI_SRIOV_TOTAL_VF
 0x0

	)

598 
	#PCI_SRIOV_NUM_VF
 0x10

	)

599 
	#PCI_SRIOV_FUNC_LINK
 0x12

	)

600 
	#PCI_SRIOV_VF_OFFSET
 0x14

	)

601 
	#PCI_SRIOV_VF_STRIDE
 0x16

	)

602 
	#PCI_SRIOV_VF_DID
 0x1¨

	)

603 
	#PCI_SRIOV_SUP_PGSIZE
 0x1ø

	)

604 
	#PCI_SRIOV_SYS_PGSIZE
 0x20

	)

605 
	#PCI_SRIOV_BAR
 0x24

	)

606 
	#PCI_SRIOV_NUM_BARS
 6

	)

607 
	#PCI_SRIOV_VFM
 0x3ø

	)

608 
	#PCI_SRIOV_VFM_BIR
(
x
è((xè& 7è

	)

609 
	#PCI_SRIOV_VFM_OFFSET
(
x
è((xè& ~7è

	)

610 
	#PCI_SRIOV_VFM_UA
 0x0

	)

611 
	#PCI_SRIOV_VFM_MI
 0x1

	)

612 
	#PCI_SRIOV_VFM_MO
 0x2

	)

613 
	#PCI_SRIOV_VFM_AV
 0x3

	)

615 
	#PCI_LTR_MAX_SNOOP_LAT
 0x4

	)

616 
	#PCI_LTR_MAX_NOSNOOP_LAT
 0x6

	)

617 
	#PCI_LTR_VALUE_MASK
 0x000003ff

	)

618 
	#PCI_LTR_SCALE_MASK
 0x00001c00

	)

619 
	#PCI_LTR_SCALE_SHIFT
 10

	)

622 
	#PCI_ACS_CAP
 0x04

	)

623 
	#PCI_ACS_SV
 0x01

	)

624 
	#PCI_ACS_TB
 0x02

	)

625 
	#PCI_ACS_RR
 0x04

	)

626 
	#PCI_ACS_CR
 0x08

	)

627 
	#PCI_ACS_UF
 0x10

	)

628 
	#PCI_ACS_EC
 0x20

	)

629 
	#PCI_ACS_DT
 0x40

	)

630 
	#PCI_ACS_CTRL
 0x06

	)

631 
	#PCI_ACS_EGRESS_CTL_V
 0x08

	)

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__NFDBITS


22 
	#__NFDBITS
 (8 * ())

	)

24 #undeà
__FD_SETSIZE


25 
	#__FD_SETSIZE
 1024

	)

27 #undeà
__FDSET_LONGS


28 
	#__FDSET_LONGS
 (
__FD_SETSIZE
/
__NFDBITS
)

	)

30 #undeà
__FDELT


31 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

33 #undeà
__FDMASK


34 
	#__FDMASK
(
d
è(1UL << ((dè% 
__NFDBITS
))

	)

37 
	mfds_b™s
 [
__FDSET_LONGS
];

38 } 
	t__k”Ãl_fd_£t
;

41 (*
	t__k”Ãl_sighªdËr_t
)();

44 
	t__k”Ãl_key_t
;

45 
	t__k”Ãl_mqd_t
;

47 
	~<asm/posix_ty³s.h
>

	@/usr/include/asm-i386/errno.h

1 #iâdeà
_I386_ERRNO_H


2 
	#_I386_ERRNO_H


	)

4 
	~<asm-g’”ic/”ºo.h
>

	@/usr/include/asm-i386/fcntl.h

1 
	~<asm-g’”ic/fú.h
>

	@/usr/include/asm-i386/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/asm-i386/types.h

1 #iâdeà
_I386_TYPES_H


2 
	#_I386_TYPES_H


	)

4 #iâdeà
__ASSEMBLY__


6 
	tumode_t
;

13 
__sigÃd__
 
	t__s8
;

14 
	t__u8
;

16 
__sigÃd__
 
	t__s16
;

17 
	t__u16
;

19 
__sigÃd__
 
	t__s32
;

20 
	t__u32
;

22 #ià
defšed
(
__GNUC__
è&& !defšed(
__STRICT_ANSI__
)

23 
__sigÃd__
 
	t__s64
;

24 
	t__u64
;

	@/usr/include/asm-x86_64/errno.h

1 #iâdeà
_X8664_ERRNO_H


2 
	#_X8664_ERRNO_H


	)

4 
	~<asm-g’”ic/”ºo.h
>

	@/usr/include/asm-x86_64/fcntl.h

1 
	~<asm-g’”ic/fú.h
>

	@/usr/include/asm-x86_64/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/asm-x86_64/types.h

1 #iâdeà
_X86_64_TYPES_H


2 
	#_X86_64_TYPES_H


	)

4 #iâdeà
__ASSEMBLY__


6 
	tumode_t
;

13 
__sigÃd__
 
	t__s8
;

14 
	t__u8
;

16 
__sigÃd__
 
	t__s16
;

17 
	t__u16
;

19 
__sigÃd__
 
	t__s32
;

20 
	t__u32
;

22 
__sigÃd__
 
	t__s64
;

23 
	t__u64
;

	@/usr/include/asm/auxvec.h

2 #iâdeà
__ASM_STUB_AUXVEC_H


3 
	#__ASM_STUB_AUXVEC_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/auxvec.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/auxvec.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/asm/posix_types.h

2 #iâdeà
__ASM_STUB_POSIX_TYPES_H


3 
	#__ASM_STUB_POSIX_TYPES_H


	)

4 #ià
defšed
 
__x86_64__


5 
	~<asm-x86_64/posix_ty³s.h
>

6 #–ià
defšed
 
__i386__


7 
	~<asm-i386/posix_ty³s.h
>

9 #w¬nšg 
This
 
machše
 
­³¬s
 
to
 
be
 
Ã™h”
 
x86_64
 
nÜ
 
i386
.

	@/usr/include/gnu/stubs.h

4 
	~<b™s/wÜdsize.h
>

6 #ià
__WORDSIZE
 == 32

7 
	~<gnu/¡ubs-32.h
>

8 #–ià
__WORDSIZE
 == 64

9 
	~<gnu/¡ubs-64.h
>

	@/usr/include/linux/stddef.h

1 #iâdeà
_LINUX_STDDEF_H


2 
	#_LINUX_STDDEF_H


	)

5 #undeà
NULL


6 #ià
defšed
(
__ılu¥lus
)

7 
	#NULL
 0

	)

9 
	#NULL
 ((*)0)

	)

	@/usr/include/sys/cdefs.h

20 #iâdef 
_SYS_CDEFS_H


21 
	#_SYS_CDEFS_H
 1

	)

24 #iâdeà
_FEATURES_H


25 
	~<ã©u»s.h
>

31 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


36 #undeà
__P


37 #undeà
__PMT


39 #ifdeà
__GNUC__


46 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

47 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

48 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
)è
	)
fct

50 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

51 
	#__THROW
 
	`throw
 ()

	)

52 
	#__NTH
(
fù
èfù 
	`throw
 ()

	)

54 
	#__THROW


	)

55 
	#__NTH
(
fù
è
	)
fct

61 
	#__šlše


	)

63 
	#__THROW


	)

64 
	#__NTH
(
fù
è
	)
fct

66 
	#__cÚ¡
 cÚ¡

	)

67 
	#__sigÃd
 sigÃd

	)

68 
	#__vŞ©e
 vŞ©e

	)

74 
	#__P
(
¬gs
è
	)
args

75 
	#__PMT
(
¬gs
è
	)
args

80 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

81 
	#__STRING
(
x
è#x

	)

84 
	#__±r_t
 *

	)

85 
	#__lÚg_doubË_t
 

	)

89 #ifdef 
__ılu¥lus


90 
	#__BEGIN_DECLS
 "C" {

	)

91 
	#__END_DECLS
 }

	)

93 
	#__BEGIN_DECLS


	)

94 
	#__END_DECLS


	)

103 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES


104 
	#__BEGIN_NAMESPACE_STD
 
Çme¥aû
 
¡d
 {

	)

105 
	#__END_NAMESPACE_STD
 }

	)

106 
	#__USING_NAMESPACE_STD
(
Çme
è
usšg
 
¡d
::Çme;

	)

107 
	#__BEGIN_NAMESPACE_C99
 
Çme¥aû
 
__c99
 {

	)

108 
	#__END_NAMESPACE_C99
 }

	)

109 
	#__USING_NAMESPACE_C99
(
Çme
è
usšg
 
__c99
::Çme;

	)

114 
	#__BEGIN_NAMESPACE_STD


	)

115 
	#__END_NAMESPACE_STD


	)

116 
	#__USING_NAMESPACE_STD
(
Çme
)

	)

117 
	#__BEGIN_NAMESPACE_C99


	)

118 
	#__END_NAMESPACE_C99


	)

119 
	#__USING_NAMESPACE_C99
(
Çme
)

	)

124 #iâdeà
__BOUNDED_POINTERS__


125 
	#__bounded


	)

126 
	#__unbounded


	)

127 
	#__±rv®ue


	)

132 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

133 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

134 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

138 #ià
__GNUC_PREREQ
 (2,97)

140 
	#__æex¬r
 []

	)

142 #ifdeà
__GNUC__


143 
	#__æex¬r
 [0]

	)

145 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

146 
	#__æex¬r
 []

	)

149 
	#__æex¬r
 [1]

	)

165 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

167 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

168 #ifdeà
__ılu¥lus


169 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

170 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

172 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

173 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

175 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

176 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
cname

189 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

190 
	#__©Œibu‹__
(
xyz
è

	)

196 #ià
__GNUC_PREREQ
 (2,96)

197 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

199 
	#__©Œibu‹_m®loc__


	)

205 #ià
__GNUC_PREREQ
 (2,96)

206 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

208 
	#__©Œibu‹_pu»__


	)

214 #ià
__GNUC_PREREQ
 (3,1)

215 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

216 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

218 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

219 
	#__©Œibu‹_nošlše__


	)

223 #ià
__GNUC_PREREQ
 (3,2)

224 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

226 
	#__©Œibu‹_d•»ÿ‹d__


	)

235 #ià
__GNUC_PREREQ
 (2,8)

236 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

238 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

245 #ià
__GNUC_PREREQ
 (2,97)

246 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

247 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

249 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

254 #ià
__GNUC_PREREQ
 (3,3)

255 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

257 
	#__nÚnuÎ
(
·¿ms
)

	)

262 #ià
__GNUC_PREREQ
 (3,4)

263 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

264 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

265 #ià
__USE_FORTIFY_LEVEL
 > 0

266 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

269 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

271 #iâdeà
__wur


272 
	#__wur


	)

276 #ià
__GNUC_PREREQ
 (3,2)

277 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

279 
	#__®ways_šlše
 
__šlše


	)

286 #ià!
__GNUC_PREREQ
 (2,8)

287 
	#__ex‹nsiÚ__


	)

291 #ià!
__GNUC_PREREQ
 (2,92)

292 
	#__»¡riù


	)

298 #ià
__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


299 
	#__»¡riù_¬r
 
__»¡riù


	)

301 #ifdeà
__GNUC__


302 
	#__»¡riù_¬r


	)

304 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

305 
	#__»¡riù_¬r
 
»¡riù


	)

308 
	#__»¡riù_¬r


	)

313 
	~<b™s/wÜdsize.h
>

315 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


316 
	#__LDBL_COMPAT
 1

	)

317 #ifdeà
__REDIRECT


318 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

319 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

320 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

321 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

322 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

323 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

324 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

325 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

326 
	#__LDBL_REDIR_DECL
(
Çme
) \

327 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

330 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


331 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
proto

332 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
proto

333 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

334 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

335 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

	@/usr/include/asm-generic/errno.h

1 #iâdeà
_ASM_GENERIC_ERRNO_H


2 
	#_ASM_GENERIC_ERRNO_H


	)

4 
	~<asm-g’”ic/”ºo-ba£.h
>

6 
	#EDEADLK
 35

	)

7 
	#ENAMETOOLONG
 36

	)

8 
	#ENOLCK
 37

	)

9 
	#ENOSYS
 38

	)

10 
	#ENOTEMPTY
 39

	)

11 
	#ELOOP
 40

	)

12 
	#EWOULDBLOCK
 
EAGAIN


	)

13 
	#ENOMSG
 42

	)

14 
	#EIDRM
 43

	)

15 
	#ECHRNG
 44

	)

16 
	#EL2NSYNC
 45

	)

17 
	#EL3HLT
 46

	)

18 
	#EL3RST
 47

	)

19 
	#ELNRNG
 48

	)

20 
	#EUNATCH
 49

	)

21 
	#ENOCSI
 50

	)

22 
	#EL2HLT
 51

	)

23 
	#EBADE
 52

	)

24 
	#EBADR
 53

	)

25 
	#EXFULL
 54

	)

26 
	#ENOANO
 55

	)

27 
	#EBADRQC
 56

	)

28 
	#EBADSLT
 57

	)

30 
	#EDEADLOCK
 
EDEADLK


	)

32 
	#EBFONT
 59

	)

33 
	#ENOSTR
 60

	)

34 
	#ENODATA
 61

	)

35 
	#ETIME
 62

	)

36 
	#ENOSR
 63

	)

37 
	#ENONET
 64

	)

38 
	#ENOPKG
 65

	)

39 
	#EREMOTE
 66

	)

40 
	#ENOLINK
 67

	)

41 
	#EADV
 68

	)

42 
	#ESRMNT
 69

	)

43 
	#ECOMM
 70

	)

44 
	#EPROTO
 71

	)

45 
	#EMULTIHOP
 72

	)

46 
	#EDOTDOT
 73

	)

47 
	#EBADMSG
 74

	)

48 
	#EOVERFLOW
 75

	)

49 
	#ENOTUNIQ
 76

	)

50 
	#EBADFD
 77

	)

51 
	#EREMCHG
 78

	)

52 
	#ELIBACC
 79

	)

53 
	#ELIBBAD
 80

	)

54 
	#ELIBSCN
 81

	)

55 
	#ELIBMAX
 82

	)

56 
	#ELIBEXEC
 83

	)

57 
	#EILSEQ
 84

	)

58 
	#ERESTART
 85

	)

59 
	#ESTRPIPE
 86

	)

60 
	#EUSERS
 87

	)

61 
	#ENOTSOCK
 88

	)

62 
	#EDESTADDRREQ
 89

	)

63 
	#EMSGSIZE
 90

	)

64 
	#EPROTOTYPE
 91

	)

65 
	#ENOPROTOOPT
 92

	)

66 
	#EPROTONOSUPPORT
 93

	)

67 
	#ESOCKTNOSUPPORT
 94

	)

68 
	#EOPNOTSUPP
 95

	)

69 
	#EPFNOSUPPORT
 96

	)

70 
	#EAFNOSUPPORT
 97

	)

71 
	#EADDRINUSE
 98

	)

72 
	#EADDRNOTAVAIL
 99

	)

73 
	#ENETDOWN
 100

	)

74 
	#ENETUNREACH
 101

	)

75 
	#ENETRESET
 102

	)

76 
	#ECONNABORTED
 103

	)

77 
	#ECONNRESET
 104

	)

78 
	#ENOBUFS
 105

	)

79 
	#EISCONN
 106

	)

80 
	#ENOTCONN
 107

	)

81 
	#ESHUTDOWN
 108

	)

82 
	#ETOOMANYREFS
 109

	)

83 
	#ETIMEDOUT
 110

	)

84 
	#ECONNREFUSED
 111

	)

85 
	#EHOSTDOWN
 112

	)

86 
	#EHOSTUNREACH
 113

	)

87 
	#EALREADY
 114

	)

88 
	#EINPROGRESS
 115

	)

89 
	#ESTALE
 116

	)

90 
	#EUCLEAN
 117

	)

91 
	#ENOTNAM
 118

	)

92 
	#ENAVAIL
 119

	)

93 
	#EISNAM
 120

	)

94 
	#EREMOTEIO
 121

	)

95 
	#EDQUOT
 122

	)

97 
	#ENOMEDIUM
 123

	)

98 
	#EMEDIUMTYPE
 124

	)

99 
	#ECANCELED
 125

	)

100 
	#ENOKEY
 126

	)

101 
	#EKEYEXPIRED
 127

	)

102 
	#EKEYREVOKED
 128

	)

103 
	#EKEYREJECTED
 129

	)

106 
	#EOWNERDEAD
 130

	)

107 
	#ENOTRECOVERABLE
 131

	)

109 
	#ERFKILL
 132

	)

	@/usr/include/asm-generic/fcntl.h

1 #iâdeà
_ASM_GENERIC_FCNTL_H


2 
	#_ASM_GENERIC_FCNTL_H


	)

4 
	~<lšux/ty³s.h
>

8 
	#O_ACCMODE
 00000003

	)

9 
	#O_RDONLY
 00000000

	)

10 
	#O_WRONLY
 00000001

	)

11 
	#O_RDWR
 00000002

	)

12 #iâdeà
O_CREAT


13 
	#O_CREAT
 00000100

	)

15 #iâdeà
O_EXCL


16 
	#O_EXCL
 00000200

	)

18 #iâdeà
O_NOCTTY


19 
	#O_NOCTTY
 00000400

	)

21 #iâdeà
O_TRUNC


22 
	#O_TRUNC
 00001000

	)

24 #iâdeà
O_APPEND


25 
	#O_APPEND
 00002000

	)

27 #iâdeà
O_NONBLOCK


28 
	#O_NONBLOCK
 00004000

	)

30 #iâdeà
O_SYNC


31 
	#O_SYNC
 00010000

	)

33 #iâdeà
FASYNC


34 
	#FASYNC
 00020000

	)

36 #iâdeà
O_DIRECT


37 
	#O_DIRECT
 00040000

	)

39 #iâdeà
O_LARGEFILE


40 
	#O_LARGEFILE
 00100000

	)

42 #iâdeà
O_DIRECTORY


43 
	#O_DIRECTORY
 00200000

	)

45 #iâdeà
O_NOFOLLOW


46 
	#O_NOFOLLOW
 00400000

	)

48 #iâdeà
O_NOATIME


49 
	#O_NOATIME
 01000000

	)

52 #iâdeà
O_NDELAY


53 
	#O_NDELAY
 
O_NONBLOCK


	)

56 
	#F_DUPFD
 0

	)

57 
	#F_GETFD
 1

	)

58 
	#F_SETFD
 2

	)

59 
	#F_GETFL
 3

	)

60 
	#F_SETFL
 4

	)

61 #iâdeà
F_GETLK


62 
	#F_GETLK
 5

	)

63 
	#F_SETLK
 6

	)

64 
	#F_SETLKW
 7

	)

66 #iâdeà
F_SETOWN


67 
	#F_SETOWN
 8

	)

68 
	#F_GETOWN
 9

	)

70 #iâdeà
F_SETSIG


71 
	#F_SETSIG
 10

	)

72 
	#F_GETSIG
 11

	)

76 
	#FD_CLOEXEC
 1

	)

79 #iâdeà
F_RDLCK


80 
	#F_RDLCK
 0

	)

81 
	#F_WRLCK
 1

	)

82 
	#F_UNLCK
 2

	)

86 #iâdeà
F_EXLCK


87 
	#F_EXLCK
 4

	)

88 
	#F_SHLCK
 8

	)

92 #iâdeà
F_INPROGRESS


93 
	#F_INPROGRESS
 16

	)

97 
	#LOCK_SH
 1

	)

98 
	#LOCK_EX
 2

	)

99 
	#LOCK_NB
 4

	)

101 
	#LOCK_UN
 8

	)

103 
	#LOCK_MAND
 32

	)

104 
	#LOCK_READ
 64

	)

105 
	#LOCK_WRITE
 128

	)

106 
	#LOCK_RW
 192

	)

108 
	#F_LINUX_SPECIFIC_BASE
 1024

	)

110 #iâdeà
HAVE_ARCH_STRUCT_FLOCK


111 #iâdeà
__ARCH_FLOCK_PAD


112 
	#__ARCH_FLOCK_PAD


	)

115 
	sæock
 {

116 
	ml_ty³
;

117 
	ml_wh’û
;

118 
off_t
 
	ml_¡¬t
;

119 
off_t
 
	ml_Ën
;

120 
pid_t
 
	ml_pid
;

121 
	m__ARCH_FLOCK_PAD


125 #iâdeà
CONFIG_64BIT


127 #iâdeà
F_GETLK64


128 
	#F_GETLK64
 12

	)

129 
	#F_SETLK64
 13

	)

130 
	#F_SETLKW64
 14

	)

133 #iâdeà
HAVE_ARCH_STRUCT_FLOCK64


134 #iâdeà
__ARCH_FLOCK64_PAD


135 
	#__ARCH_FLOCK64_PAD


	)

138 
	sæock64
 {

139 
	ml_ty³
;

140 
	ml_wh’û
;

141 
loff_t
 
	ml_¡¬t
;

142 
loff_t
 
	ml_Ën
;

143 
pid_t
 
	ml_pid
;

144 
	m__ARCH_FLOCK64_PAD


	@/usr/include/asm-generic/ioctl.h

1 #iâdeà
_ASM_GENERIC_IOCTL_H


2 
	#_ASM_GENERIC_IOCTL_H


	)

22 
	#_IOC_NRBITS
 8

	)

23 
	#_IOC_TYPEBITS
 8

	)

24 
	#_IOC_SIZEBITS
 14

	)

25 
	#_IOC_DIRBITS
 2

	)

27 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

28 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

29 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

30 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

32 
	#_IOC_NRSHIFT
 0

	)

33 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

34 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

35 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

40 
	#_IOC_NONE
 0U

	)

41 
	#_IOC_WRITE
 1U

	)

42 
	#_IOC_READ
 2U

	)

44 
	#_IOC
(
dœ
,
ty³
,
Ä
,
size
) \

45 (((
dœ
è<< 
_IOC_DIRSHIFT
) | \

46 ((
ty³
è<< 
_IOC_TYPESHIFT
) | \

47 ((
Ä
è<< 
_IOC_NRSHIFT
) | \

48 ((
size
è<< 
_IOC_SIZESHIFT
))

	)

50 #ifdeà
__KERNEL__


52 
__šv®id_size_¬gum’t_fÜ_IOC
;

53 
	#_IOC_TYPECHECK
(
t
) \

54 (((
t
) == (t[1]) && \

55 (
t
è< (1 << 
_IOC_SIZEBITS
)) ? \

56 (
t
è: 
__šv®id_size_¬gum’t_fÜ_IOC
)

	)

58 
	#_IOC_TYPECHECK
(
t
è(Ñ))

	)

62 
	#_IO
(
ty³
,
Ä
è
	`_IOC
(
_IOC_NONE
,Ñy³),Òr),0)

	)

63 
	#_IOR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

64 
	#_IOW
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

65 
	#_IOWR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

66 
	#_IOR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(size))

	)

67 
	#_IOW_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(size))

	)

68 
	#_IOWR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(size))

	)

71 
	#_IOC_DIR
(
Ä
è((Òrè>> 
_IOC_DIRSHIFT
è& 
_IOC_DIRMASK
)

	)

72 
	#_IOC_TYPE
(
Ä
è((Òrè>> 
_IOC_TYPESHIFT
è& 
_IOC_TYPEMASK
)

	)

73 
	#_IOC_NR
(
Ä
è((Òrè>> 
_IOC_NRSHIFT
è& 
_IOC_NRMASK
)

	)

74 
	#_IOC_SIZE
(
Ä
è((Òrè>> 
_IOC_SIZESHIFT
è& 
_IOC_SIZEMASK
)

	)

78 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

79 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

80 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
è<< 
_IOC_DIRSHIFT
)

	)

81 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

82 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm-i386/auxvec.h

1 #iâdeà
__ASMi386_AUXVEC_H


2 
	#__ASMi386_AUXVEC_H


	)

8 
	#AT_SYSINFO
 32

	)

9 
	#AT_SYSINFO_EHDR
 33

	)

	@/usr/include/asm-i386/posix_types.h

1 #iâdeà
__ARCH_I386_POSIX_TYPES_H


2 
	#__ARCH_I386_POSIX_TYPES_H


	)

10 
	t__k”Ãl_šo_t
;

11 
	t__k”Ãl_mode_t
;

12 
	t__k”Ãl_Æšk_t
;

13 
	t__k”Ãl_off_t
;

14 
	t__k”Ãl_pid_t
;

15 
	t__k”Ãl_c_pid_t
;

16 
	t__k”Ãl_uid_t
;

17 
	t__k”Ãl_gid_t
;

18 
	t__k”Ãl_size_t
;

19 
	t__k”Ãl_ssize_t
;

20 
	t__k”Ãl_±rdiff_t
;

21 
	t__k”Ãl_time_t
;

22 
	t__k”Ãl_su£cÚds_t
;

23 
	t__k”Ãl_şock_t
;

24 
	t__k”Ãl_tim”_t
;

25 
	t__k”Ãl_şockid_t
;

26 
	t__k”Ãl_daddr_t
;

27 * 
	t__k”Ãl_ÿddr_t
;

28 
	t__k”Ãl_uid16_t
;

29 
	t__k”Ãl_gid16_t
;

30 
	t__k”Ãl_uid32_t
;

31 
	t__k”Ãl_gid32_t
;

33 
	t__k”Ãl_Şd_uid_t
;

34 
	t__k”Ãl_Şd_gid_t
;

35 
	t__k”Ãl_Şd_dev_t
;

37 #ifdeà
__GNUC__


38 
	t__k”Ãl_loff_t
;

42 #ià
defšed
(
__KERNEL__
è|| defšed(
__USE_ALL
)

43 
	mv®
[2];

45 
	m__v®
[2];

47 } 
	t__k”Ãl_fsid_t
;

49 #ià
defšed
(
__KERNEL__
è|| !defšed(
__GLIBC__
) || (__GLIBC__ < 2)

51 #undeà
__FD_SET


52 
	#__FD_SET
(
fd
,
fd£
) \

53 
__asm__
 
	`__vŞ©e__
("btsl %1,%0": \

54 "+m" (*(
__k”Ãl_fd_£t
 *è(
fd£
)):"r" ((è(
fd
)))

	)

56 #undeà
__FD_CLR


57 
	#__FD_CLR
(
fd
,
fd£
) \

58 
__asm__
 
	`__vŞ©e__
("btrl %1,%0": \

59 "+m" (*(
__k”Ãl_fd_£t
 *è(
fd£
)):"r" ((è(
fd
)))

	)

61 #undeà
__FD_ISSET


62 
	#__FD_ISSET
(
fd
,
fd£
è(
	`__ex‹nsiÚ__
 ({ \

63 
__»suÉ
; \

64 
__asm__
 
	`__vŞ©e__
("btl %1,%2 ; setb %0" \

65 :"=q" (
__»suÉ
è:"r" ((è(
fd
)), \

66 "m" (*(
__k”Ãl_fd_£t
 *è(
fd£
))); \

67 
__»suÉ
; }))

	)

69 #undeà
__FD_ZERO


70 
	#__FD_ZERO
(
fd£
) \

72 
__d0
, 
__d1
; \

73 
__asm__
 
	`__vŞ©e__
("cld ;„ep ; stosl" \

74 :"=m" (*(
__k”Ãl_fd_£t
 *è(
fd£
)), \

75 "=&c" (
__d0
), "=&D" (
__d1
) \

76 :"a" (0), "1" (
__FDSET_LONGS
), \

77 "2" ((
__k”Ãl_fd_£t
 *è(
fd£
)) : "memory"); \

78 } 0)

	)

	@/usr/include/asm-x86_64/auxvec.h

1 #iâdeà
__ASM_X86_64_AUXVEC_H


2 
	#__ASM_X86_64_AUXVEC_H


	)

4 
	#AT_SYSINFO_EHDR
 33

	)

	@/usr/include/asm-x86_64/posix_types.h

1 #iâdeà
_ASM_X86_64_POSIX_TYPES_H


2 
	#_ASM_X86_64_POSIX_TYPES_H


	)

10 
	t__k”Ãl_šo_t
;

11 
	t__k”Ãl_mode_t
;

12 
	t__k”Ãl_Æšk_t
;

13 
	t__k”Ãl_off_t
;

14 
	t__k”Ãl_pid_t
;

15 
	t__k”Ãl_c_pid_t
;

16 
	t__k”Ãl_uid_t
;

17 
	t__k”Ãl_gid_t
;

18 
	t__k”Ãl_size_t
;

19 
	t__k”Ãl_ssize_t
;

20 
	t__k”Ãl_±rdiff_t
;

21 
	t__k”Ãl_time_t
;

22 
	t__k”Ãl_su£cÚds_t
;

23 
	t__k”Ãl_şock_t
;

24 
	t__k”Ãl_tim”_t
;

25 
	t__k”Ãl_şockid_t
;

26 
	t__k”Ãl_daddr_t
;

27 * 
	t__k”Ãl_ÿddr_t
;

28 
	t__k”Ãl_uid16_t
;

29 
	t__k”Ãl_gid16_t
;

31 #ifdeà
__GNUC__


32 
	t__k”Ãl_loff_t
;

36 
	mv®
[2];

37 } 
	t__k”Ãl_fsid_t
;

39 
	t__k”Ãl_Şd_uid_t
;

40 
	t__k”Ãl_Şd_gid_t
;

41 
__k”Ãl_uid_t
 
	t__k”Ãl_uid32_t
;

42 
__k”Ãl_gid_t
 
	t__k”Ãl_gid32_t
;

44 
	t__k”Ãl_Şd_dev_t
;

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__


4 
	#__WORDSIZE
 64

	)

5 
	#__WORDSIZE_COMPAT32
 1

	)

7 
	#__WORDSIZE
 32

	)

	@/usr/include/gnu/stubs-32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___k”Ãl_co¦


	)

11 
	#__¡ub___k”Ãl_sšl


	)

12 
	#__¡ub___k”Ãl_Æ


	)

13 
	#__¡ub_chæags


	)

14 
	#__¡ub_ç‰ach


	)

15 
	#__¡ub_fchæags


	)

16 
	#__¡ub_fd‘ach


	)

17 
	#__¡ub_g‰y


	)

18 
	#__¡ub_lchmod


	)

19 
	#__¡ub_lutimes


	)

20 
	#__¡ub_»voke


	)

21 
	#__¡ub_£ogš


	)

22 
	#__¡ub_sig»tuº


	)

23 
	#__¡ub_s¡k


	)

24 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___k”Ãl_co¦


	)

11 
	#__¡ub___k”Ãl_»m_pio2l


	)

12 
	#__¡ub___k”Ãl_sšl


	)

13 
	#__¡ub___k”Ãl_Æ


	)

14 
	#__¡ub_bdæush


	)

15 
	#__¡ub_chæags


	)

16 
	#__¡ub_ç‰ach


	)

17 
	#__¡ub_fchæags


	)

18 
	#__¡ub_fd‘ach


	)

19 
	#__¡ub_ãupd©“nv


	)

20 
	#__¡ub_g‘msg


	)

21 
	#__¡ub_g‰y


	)

22 
	#__¡ub_lchmod


	)

23 
	#__¡ub_lutimes


	)

24 
	#__¡ub_putmsg


	)

25 
	#__¡ub_»voke


	)

26 
	#__¡ub_£ogš


	)

27 
	#__¡ub_sig»tuº


	)

28 
	#__¡ub_s¡k


	)

29 
	#__¡ub_¡ty


	)

	@/usr/include/asm-generic/errno-base.h

1 #iâdeà
_ASM_GENERIC_ERRNO_BASE_H


2 
	#_ASM_GENERIC_ERRNO_BASE_H


	)

4 
	#EPERM
 1

	)

5 
	#ENOENT
 2

	)

6 
	#ESRCH
 3

	)

7 
	#EINTR
 4

	)

8 
	#EIO
 5

	)

9 
	#ENXIO
 6

	)

10 
	#E2BIG
 7

	)

11 
	#ENOEXEC
 8

	)

12 
	#EBADF
 9

	)

13 
	#ECHILD
 10

	)

14 
	#EAGAIN
 11

	)

15 
	#ENOMEM
 12

	)

16 
	#EACCES
 13

	)

17 
	#EFAULT
 14

	)

18 
	#ENOTBLK
 15

	)

19 
	#EBUSY
 16

	)

20 
	#EEXIST
 17

	)

21 
	#EXDEV
 18

	)

22 
	#ENODEV
 19

	)

23 
	#ENOTDIR
 20

	)

24 
	#EISDIR
 21

	)

25 
	#EINVAL
 22

	)

26 
	#ENFILE
 23

	)

27 
	#EMFILE
 24

	)

28 
	#ENOTTY
 25

	)

29 
	#ETXTBSY
 26

	)

30 
	#EFBIG
 27

	)

31 
	#ENOSPC
 28

	)

32 
	#ESPIPE
 29

	)

33 
	#EROFS
 30

	)

34 
	#EMLINK
 31

	)

35 
	#EPIPE
 32

	)

36 
	#EDOM
 33

	)

37 
	#ERANGE
 34

	)

	@
1
.
1
/usr/include
115
2548
shannon.h
shannon.mod.c
shannon_512.c
shannon_block.c
shannon_block.h
shannon_buffer.c
shannon_cdev.c
shannon_config.h
shannon_debug.c
shannon_device.c
shannon_device.h
shannon_dma.c
shannon_dma.h
shannon_dna.c
shannon_emu.c
shannon_emu.h
shannon_epilog.c
shannon_err_handler.c
shannon_err_injection.c
shannon_file.c
shannon_file.h
shannon_fpga_emu.c
shannon_ftl.c
shannon_g4.c
shannon_g5.c
shannon_ioctl.c
shannon_ioctl.h
shannon_kcore.c
shannon_kcore.h
shannon_list.h
shannon_main.c
shannon_map_table.c
shannon_mbr.h
shannon_memblock.h
shannon_microcode.c
shannon_module_init.c
shannon_nor.c
shannon_ns.c
shannon_ns_rw.c
shannon_pci.c
shannon_pci.h
shannon_port.h
shannon_prefetch.c
shannon_prefetch.h
shannon_reconfig.c
shannon_regs.h
shannon_scatter.c
shannon_scatter.h
shannon_sched.c
shannon_sched.h
shannon_scsi.c
shannon_scsi.h
shannon_scsi_cmd.c
shannon_sysfs.c
shannon_sysfs.h
shannon_sysfs_core.c
shannon_time.c
shannon_time.h
shannon_waitqueue.c
shannon_waitqueue.h
shannon_workqueue.c
shannon_workqueue.h
/usr/include/asm/param.h
/usr/include/linux/errno.h
/usr/include/linux/fcntl.h
/usr/include/linux/fs.h
/usr/include/linux/genhd.h
/usr/include/linux/hdreg.h
/usr/include/linux/ioctl.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/pci.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/scsi/scsi.h
/usr/include/asm-i386/param.h
/usr/include/asm-x86_64/param.h
/usr/include/asm/errno.h
/usr/include/asm/fcntl.h
/usr/include/asm/ioctl.h
/usr/include/asm/types.h
/usr/include/features.h
/usr/include/linux/auxvec.h
/usr/include/linux/limits.h
/usr/include/linux/pci_ids.h
/usr/include/linux/pci_regs.h
/usr/include/linux/posix_types.h
/usr/include/asm-i386/errno.h
/usr/include/asm-i386/fcntl.h
/usr/include/asm-i386/ioctl.h
/usr/include/asm-i386/types.h
/usr/include/asm-x86_64/errno.h
/usr/include/asm-x86_64/fcntl.h
/usr/include/asm-x86_64/ioctl.h
/usr/include/asm-x86_64/types.h
/usr/include/asm/auxvec.h
/usr/include/asm/posix_types.h
/usr/include/gnu/stubs.h
/usr/include/linux/stddef.h
/usr/include/sys/cdefs.h
/usr/include/asm-generic/errno.h
/usr/include/asm-generic/fcntl.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm-i386/auxvec.h
/usr/include/asm-i386/posix_types.h
/usr/include/asm-x86_64/auxvec.h
/usr/include/asm-x86_64/posix_types.h
/usr/include/bits/wordsize.h
/usr/include/gnu/stubs-32.h
/usr/include/gnu/stubs-64.h
/usr/include/asm-generic/errno-base.h
